<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - wingsAIStudio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#EF4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="flex">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="w-64 bg-white dark:bg-gray-800 min-h-screen fixed left-0 top-0 shadow-lg z-40">
            <!-- ë¡œê³  -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <a href="/" class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ¬</span>
                    <span class="text-xl font-bold text-gray-800 dark:text-white">wingsAIStudio</span>
                </a>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">AI ì˜ìƒ ì œì‘ í”Œë«í¼</p>
            </div>

            <!-- í”„ë¡œì íŠ¸ ì„ íƒ -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">í˜„ì¬ í”„ë¡œì íŠ¸</span>
                    <button onclick="openProjectModal()" class="text-xs text-blue-500 hover:text-blue-600">+ ìƒˆ í”„ë¡œì íŠ¸</button>
                </div>
                <select id="projectSelect" onchange="onProjectChange(this.value)"
                    class="w-full text-sm p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white">
                    <option value="">í”„ë¡œì íŠ¸ ì„ íƒ...</option>
                </select>
                <div id="currentProjectInfo" class="mt-2 text-xs text-gray-500 hidden">
                    <span id="projectStatus"></span>
                </div>
            </div>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
            <nav class="p-4">
                <ul class="space-y-1">
                    <li>
                        <a href="/" class="sidebar-item {% if page == 'topic' %}active{% endif %}">
                            <span class="sidebar-icon">ğŸ”</span>
                            <span>ì£¼ì œ ì°¾ê¸°</span>
                        </a>
                    </li>
                    <li>
                        <a href="/script-plan" class="sidebar-item {% if page == 'script-plan' %}active{% endif %}">
                            <span class="sidebar-icon">ğŸ“‹</span>
                            <span>ëŒ€ë³¸ ê¸°íš</span>
                        </a>
                    </li>
                    <li>
                        <a href="/script-gen" class="sidebar-item {% if page == 'script-gen' %}active{% endif %}">
                            <span class="sidebar-icon">âœï¸</span>
                            <span>ëŒ€ë³¸ ìƒì„±</span>
                        </a>
                    </li>
                    <li>
                        <a href="/image-gen" class="sidebar-item {% if page == 'image-gen' %}active{% endif %}">
                            <span class="sidebar-icon">ğŸ–¼ï¸</span>
                            <span>ì´ë¯¸ì§€ ìƒì„±</span>
                        </a>
                    </li>
                    <li>
                        <a href="/tts" class="sidebar-item {% if page == 'tts' %}active{% endif %}">
                            <span class="sidebar-icon">ğŸ”Š</span>
                            <span>TTS ìƒì„±</span>
                        </a>
                    </li>
                    <li>
                        <a href="/render" class="sidebar-item {% if page == 'render' %}active{% endif %}">
                            <span class="sidebar-icon">ğŸ¬</span>
                            <span>ì˜ìƒ ë Œë”ë§</span>
                        </a>
                    </li>
                    <li>
                        <a href="/title-desc" class="sidebar-item {% if page == 'title-desc' %}active{% endif %}">
                            <span class="sidebar-icon">ğŸ“</span>
                            <span>ì œëª©/ì„¤ëª… ìƒì„±</span>
                        </a>
                    </li>
                    <li>
                        <a href="/thumbnail" class="sidebar-item {% if page == 'thumbnail' %}active{% endif %}">
                            <span class="sidebar-icon">ğŸ¨</span>
                            <span>ì¸ë„¤ì¼ ìƒì„±</span>
                        </a>
                    </li>
                    <li>
                        <a href="/shorts" class="sidebar-item {% if page == 'shorts' %}active{% endif %}">
                            <span class="sidebar-icon">ğŸ“±</span>
                            <span>ì‡¼ì¸  ìƒì„±</span>
                        </a>
                    </li>
                    <li class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <a href="/settings" class="sidebar-item {% if page == 'settings' %}active{% endif %}">
                            <span class="sidebar-icon">âš™ï¸</span>
                            <span>ì„¤ì •</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- API ìƒíƒœ -->
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 dark:border-gray-700">
                <div id="apiStatus" class="text-xs text-gray-500 dark:text-gray-400">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></span>
                        <span>API ìƒíƒœ í™•ì¸ ì¤‘...</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="flex-1 ml-64 p-6">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- í”„ë¡œì íŠ¸ ìƒì„± ëª¨ë‹¬ -->
    <div id="projectModal" class="modal-overlay hidden">
        <div class="modal-content max-w-md">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í”„ë¡œì íŠ¸ ì´ë¦„</label>
                    <input type="text" id="newProjectName" class="input-field" placeholder="ì˜ˆ: ì‚¼êµ­ì§€ ì˜ìƒ ì‹œë¦¬ì¦ˆ">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì£¼ì œ (ì„ íƒ)</label>
                    <input type="text" id="newProjectTopic" class="input-field" placeholder="ì˜ˆ: ì‚¼êµ­ì§€ ì¸ë¬¼ ë¶„ì„">
                </div>
                <div class="flex gap-3">
                    <button onclick="createNewProject()" class="flex-1 btn-primary">ìƒì„±</button>
                    <button onclick="closeProjectModal()" class="btn-secondary">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>
    {% block scripts %}{% endblock %}

    <script>
        // í”„ë¡œì íŠ¸ ìƒíƒœ í•œê¸€
        const statusLabels = {
            'draft': 'ì‹œì‘',
            'analyzed': 'ë¶„ì„ ì™„ë£Œ',
            'planned': 'ê¸°íš ì™„ë£Œ',
            'scripted': 'ëŒ€ë³¸ ì™„ë£Œ',
            'tts_done': 'TTS ì™„ë£Œ',
            'rendered': 'ë Œë”ë§ ì™„ë£Œ',
            'completed': 'ì™„ë£Œ'
        };

        // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
        async function loadProjects() {
            try {
                const data = await API.project.list();
                const select = document.getElementById('projectSelect');
                const currentId = getCurrentProject();

                select.innerHTML = '<option value="">í”„ë¡œì íŠ¸ ì„ íƒ...</option>';

                data.projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name} (${statusLabels[p.status] || p.status})`;
                    if (p.id == currentId) option.selected = true;
                    select.appendChild(option);
                });

                // í˜„ì¬ í”„ë¡œì íŠ¸ ì •ë³´ í‘œì‹œ
                if (currentId) {
                    const project = data.projects.find(p => p.id == currentId);
                    if (project) {
                        updateProjectInfo(project);
                    }
                }
            } catch (e) {
                console.error('í”„ë¡œì íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', e);
            }
        }

        // í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateProjectInfo(project) {
            const infoDiv = document.getElementById('currentProjectInfo');
            const statusSpan = document.getElementById('projectStatus');

            if (project) {
                infoDiv.classList.remove('hidden');
                statusSpan.textContent = `ìƒíƒœ: ${statusLabels[project.status] || project.status}`;
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        // í”„ë¡œì íŠ¸ ë³€ê²½
        async function onProjectChange(projectId) {
            if (projectId) {
                setCurrentProject(projectId);
                const project = await API.project.get(projectId);
                updateProjectInfo(project);
                Utils.showToast(`í”„ë¡œì íŠ¸ "${project.name}" ì„ íƒë¨`, 'success');
            } else {
                setCurrentProject(null);
                document.getElementById('currentProjectInfo').classList.add('hidden');
            }
        }

        // í”„ë¡œì íŠ¸ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openProjectModal() {
            document.getElementById('projectModal').classList.remove('hidden');
            document.getElementById('projectModal').classList.add('flex');
            document.getElementById('newProjectName').focus();
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.add('hidden');
            document.getElementById('projectModal').classList.remove('flex');
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectTopic').value = '';
        }

        // ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
        async function createNewProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const topic = document.getElementById('newProjectTopic').value.trim();

            if (!name) {
                Utils.showToast('í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
                return;
            }

            try {
                const result = await API.project.create(name, topic || null);
                if (result.project_id) {
                    setCurrentProject(result.project_id);
                    closeProjectModal();
                    await loadProjects();
                    Utils.showToast('í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                }
            } catch (e) {
                Utils.showToast('í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨', 'error');
            }
        }

        // API ìƒíƒœ í™•ì¸
        async function checkApiStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                const statusDot = document.getElementById('statusDot');
                const apiStatus = document.getElementById('apiStatus');

                if (data.status === 'ok') {
                    const activeApis = Object.entries(data.apis)
                        .filter(([k, v]) => v)
                        .map(([k]) => k);

                    statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    apiStatus.innerHTML = `
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span class="text-green-600 dark:text-green-400">ì—°ê²°ë¨</span>
                        </div>
                        <div class="text-gray-400">${activeApis.join(', ')}</div>
                    `;
                }
            } catch (e) {
                document.getElementById('statusDot').className = 'w-2 h-2 rounded-full bg-red-500';
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeProjectModal();
        });

        // ì´ˆê¸°í™”
        loadProjects();
        checkApiStatus();
    </script>
</body>
</html>
