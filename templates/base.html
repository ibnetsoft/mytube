<!DOCTYPE html>
<html lang="ko" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - {{ t('app_name') }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#EF4444',
                    }
                }
            }
        }

        // Ï¥àÍ∏∞ ÌÖåÎßà ÏÑ§Ï†ï (Í∏∞Î≥∏Í∞í: Dark)
        if (localStorage.theme === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="flex">
        <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
        <aside class="w-64 bg-white dark:bg-gray-800 min-h-screen fixed left-0 top-0 shadow-lg z-40">
            <!-- Î°úÍ≥† -->
            <div class="p-3 border-b border-gray-200 dark:border-gray-800">
                <a href="/" class="flex flex-col gap-0.5">
                    <span class="text-xs font-black tracking-widest text-blue-500 uppercase">{{ membership }}</span>
                    <span class="text-lg font-bold text-gray-800 dark:text-white">{{ t('app_name') }}</span>
                </a>
            </div>

            <!-- Project Progress Header (Moved to Main Area) -->


            <!-- ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù -->
            <div class="px-3 py-1.5 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-medium text-gray-500 dark:text-gray-400">{{ t('cur_project_label')
                        }}</span>
                    <button onclick="openProjectModal()"
                        class="text-[10px] text-blue-500 hover:text-blue-600 font-bold">{{ t('new_project_btn')
                        }}</button>
                </div>
                <select id="projectSelect" onchange="onProjectChange(this.value)"
                    class="w-full text-sm p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white">
                    <option value="">{{ t('select_project_placeholder') }}</option>
                </select>
                <div id="currentProjectInfo" class="mt-2 text-xs text-gray-500 hidden">
                    <span id="projectStatus"></span>
                </div>
            </div>

            <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
            <nav class="px-2 py-1">
                <ul class="space-y-0">
                    <li>
                        <a href="/projects" id="nav-projects"
                            class="sidebar-item {% if page == 'projects' %}active{% endif %}">
                            <span class="sidebar-icon">üìÇ</span>
                            <span>{{ t('nav_my_projects') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/" id="nav-topic" class="sidebar-item {% if page == 'topic' %}active{% endif %}">
                            <span class="sidebar-icon">üîç</span>
                            <span>{{ t('nav_topic') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/repository" id="nav-repository"
                            class="sidebar-item {% if page == 'repository' %}active{% endif %}">
                            <span class="sidebar-icon">üíæ</span>
                            <span>{{ t('nav_repository') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/script-plan" id="nav-plan"
                            class="sidebar-item {% if page == 'script-plan' %}active{% endif %}">
                            <span class="sidebar-icon">üìã</span>
                            <span>{{ t('nav_plan') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/script-gen" id="nav-script"
                            class="sidebar-item {% if page == 'script-gen' %}active{% endif %}">
                            <span class="sidebar-icon">‚úçÔ∏è</span>
                            <span>{{ t('nav_script') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/video-gen" id="nav-intro"
                            class="sidebar-item {% if page == 'video-gen' %}active{% endif %}">
                            <span class="sidebar-icon">üé•</span>
                            <span>{{ t('nav_intro') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/image-gen" id="nav-image"
                            class="sidebar-item {% if page == 'image-gen' %}active{% endif %}">
                            <span class="sidebar-icon">üñºÔ∏è</span>
                            <span>{{ t('nav_image') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/thumbnail" id="nav-thumbnail"
                            class="sidebar-item {% if page == 'thumbnail' %}active{% endif %}">
                            <span class="sidebar-icon">üé®</span>
                            <span>{{ t('nav_thumbnail') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/tts" id="nav-tts" class="sidebar-item {% if page == 'tts' %}active{% endif %}">
                            <span class="sidebar-icon">üîä</span>
                            <span>{{ t('nav_tts') }}</span>
                        </a>
                    </li>

                    <li>
                        <a href="/subtitle-gen" id="nav-subtitle"
                            class="sidebar-item {% if page == 'subtitle-gen' %}active{% endif %}">
                            <span class="sidebar-icon">üìù</span>
                            <span>{{ t('nav_subtitle') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/webtoon" id="nav-webtoon"
                            class="sidebar-item {% if page == 'webtoon-studio' %}active{% endif %}">
                            <span class="sidebar-icon">üé®</span>
                            <span>{{ t('nav_webtoon') }}</span>
                            <span
                                class="ml-auto text-[8px] bg-red-500 text-white px-1.5 py-0.5 rounded-full font-black animate-pulse">NEW</span>
                        </a>
                    </li>
                    <li>
                        <a href="/render" id="nav-render"
                            class="sidebar-item {% if page == 'render' %}active{% endif %}">
                            <span class="sidebar-icon">üé¨</span>
                            <span>{{ t('nav_render') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/title-desc" id="nav-title"
                            class="sidebar-item {% if page == 'title-desc' %}active{% endif %}">
                            <span class="sidebar-icon">üìù</span>
                            <span>{{ t('nav_title_desc') }}</span>
                        </a>
                    </li>
                    <li>
                        <a href="/video-upload" id="nav-upload"
                            class="sidebar-item {% if page == 'video-upload' %}active{% endif %}">
                            <span class="sidebar-icon">üì§</span>
                            <span>{% if is_independent %}{{ t('nav_upload') }}{% else %}{{ t('nav_reserve') }}{% endif
                                %}</span>
                        </a>
                    </li>

                    <li>
                        <a href="/shorts" id="nav-shorts"
                            class="sidebar-item {% if page == 'shorts' %}active{% endif %}">
                            <span class="sidebar-icon">üì±</span>
                            <span>{{ t('nav_shorts') }}</span>
                        </a>
                    </li>
                    <li class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                        <a href="/commerce-shorts" id="nav-commerce-shorts"
                            class="sidebar-item bg-gradient-to-r from-orange-500/10 to-yellow-500/10 border border-orange-500/30 {% if page == 'commerce-shorts' %}active{% endif %}">
                            <span class="sidebar-icon">üõçÔ∏è</span>
                            <span
                                class="bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-yellow-400 font-bold">Ïª§Î®∏Ïä§
                                ÏáºÏ∏†</span>
                            <span
                                class="ml-auto text-[10px] bg-orange-500/20 text-orange-400 px-1.5 py-0.5 rounded">New</span>
                        </a>
                    </li>
                    <li class="mt-1 pt-1">
                        <a href="/autopilot" id="nav-autopilot"
                            class="sidebar-item bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/30 {% if page == 'autopilot' %}active{% endif %}">
                            <span class="sidebar-icon">ü§ñ</span>
                            <span
                                class="bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400 font-bold">{{
                                t('nav_autopilot') }}</span>
                            <span
                                class="ml-auto text-[10px] bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded">Beta</span>
                        </a>
                    </li>
                    <li class="mt-1 pt-1">
                        <a href="/settings" id="nav-settings"
                            class="sidebar-item {% if page == 'settings' %}active{% endif %}">
                            <span class="sidebar-icon">‚öôÔ∏è</span>
                            <span>{{ t('nav_settings') }}</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="px-3 pb-1">
                <button onclick="toggleTheme()"
                    class="w-full flex items-center justify-center gap-2 p-1 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-[10px] font-medium">
                    <span class="dark:hidden">{{ t('theme_light') }}</span>
                    <span class="hidden dark:inline">{{ t('theme_dark') }}</span>
                </button>
            </div>

            <!-- API ÏÉÅÌÉú -->
            <div
                class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white dark:from-gray-800 to-transparent pt-8">
                <div id="apiStatus" class="text-xs text-gray-500 dark:text-gray-400">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></span>
                        <span>{{ t('api_status_checking') }}</span>
                    </div>
                </div>
                {% if not is_independent %}
                <div
                    class="mt-2 p-2 bg-blue-500/10 rounded-lg border border-blue-500/20 text-[10px] text-blue-600 dark:text-blue-400 font-bold">
                    {{ t('msg_independent_promo') | safe }}
                </div>
                {% endif %}
            </div>
        </aside>


        <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† ÏòÅÏó≠ (Ìó§Îçî Ìè¨Ìï®) -->
        <div class="flex-1 ml-64 flex flex-col h-screen overflow-hidden">

            <!-- Top Fixed Header (Project Progress) -->
            <header id="projectProgressHeader"
                class="hidden shrink-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 z-30 transition-all duration-300">
                <div class="px-6 py-3">
                    <!-- Top Row: Title & Actions -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-gray-500 dark:text-gray-400">Project:</span>
                            <h2 id="currentProjectNameDisplay" class="text-sm font-bold text-gray-800 dark:text-white">
                                ÌîÑÎ°úÏ†ùÌä∏Î™Ö
                            </h2>
                        </div>
                        <button onclick="closeProjectContext()"
                            class="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full text-gray-400 transition-colors"
                            title="ÌîÑÎ°úÏ†ùÌä∏ Îã´Í∏∞">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Bottom Row: 11-Step Progress Stepper -->
                    <div class="relative">
                        <!-- Scrollable Container -->
                        <div class="overflow-x-auto no-scrollbar pb-1 -mx-6 px-6">
                            <div class="flex items-center min-w-max gap-4 relative">
                                <!-- Connecting Line (Background) -->
                                <div
                                    class="absolute top-[9px] left-0 right-0 h-[2px] bg-gray-200 dark:bg-gray-700 -z-0">
                                </div>

                                <!-- Step 1: Topic -->
                                <a href="/"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="topic">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_topic') }}</span>
                                </a>



                                <!-- Step 3: Plan -->
                                <a href="/script-plan"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="plan">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_plan') }}</span>
                                </a>

                                <!-- Step 4: Script -->
                                <a href="/script-gen"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="script">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_script') }}</span>
                                </a>

                                <!-- Step 5: Intro -->
                                <a href="/video-gen"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="intro">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_intro') }}</span>
                                </a>

                                <!-- Step 6: Image -->
                                <a href="/image-gen"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="image">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_image') }}</span>
                                </a>

                                <!-- Step 7: Thumbnail -->
                                <a href="/thumbnail"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="thumbnail">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_thumbnail') }}</span>
                                </a>

                                <!-- Step 8: TTS -->
                                <a href="/tts"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="tts">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_tts') }}</span>
                                </a>



                                <!-- Step 10: Subtitles -->
                                <a href="/subtitle-gen"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="subtitle">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_subtitle') }}</span>
                                </a>

                                <!-- Step 11: Render -->
                                <a href="/render"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="render">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_render') }}</span>
                                </a>

                                <!-- Step 12: Upload -->
                                <a href="/video-upload"
                                    class="step-item relative z-10 flex flex-col items-center group cursor-pointer min-w-[50px]"
                                    data-step="upload">
                                    <div
                                        class="step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300">
                                        <div class="w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors"></div>
                                    </div>
                                    <span class="text-[10px] mt-1 text-gray-400 font-medium transition-colors">{{
                                        t('step_upload') }}</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content (Scrollable) -->
            <main class="flex-1 overflow-y-auto p-6 scroll-smooth">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î™®Îã¨ -->
    <div id="projectModal" class="modal-overlay hidden">
        <div class="modal-content max-w-md">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÎßåÎì§Í∏∞</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ</label>
                    <input type="text" id="newProjectName" class="input-field" placeholder="Ïòà: ÏÇºÍµ≠ÏßÄ ÏòÅÏÉÅ ÏãúÎ¶¨Ï¶à">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ï£ºÏ†ú (ÏÑ†ÌÉù)</label>
                    <input type="text" id="newProjectTopic" class="input-field" placeholder="Ïòà: ÏÇºÍµ≠ÏßÄ Ïù∏Î¨º Î∂ÑÏÑù">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ÏΩòÌÖêÏ∏† Ïñ∏Ïñ¥</label>
                    <select id="newProjectLanguage" class="input-field">
                        <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥ (Korean)</option>
                        <option value="en">üá∫üá∏ English</option>
                        <option value="ja">üáØüáµ Êó•Êú¨Ë™û (Japanese)</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button onclick="createNewProject()" class="flex-1 btn-primary">ÏÉùÏÑ±</button>
                    <button onclick="closeProjectModal()" class="btn-secondary">Ï∑®ÏÜå</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Í≥µÌÜµ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script src="/static/js/utils.js?v={{ range(1, 100000) | random }}"></script>
    <script src="/static/js/api_v2.js?v={{ range(1, 100000) | random }}"></script>
    {% block scripts %}{% endblock %}

    <div
        class="fixed top-3 right-6 z-50 flex gap-2 bg-white/80 dark:bg-gray-800/80 backdrop-blur p-1 rounded-full shadow-lg border border-gray-200 dark:border-gray-700 transition-all hover:scale-105">
        <button onclick="changeGlobalLanguage('ko')"
            class="w-6 h-6 rounded-full overflow-hidden border-2 border-transparent hover:border-indigo-500 transition-all transform hover:-translate-y-1 relative group"
            title="ÌïúÍµ≠Ïñ¥">
            <img src="https://flagcdn.com/w40/kr.png" alt="Korean" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
        </button>
        <button onclick="changeGlobalLanguage('en')"
            class="w-6 h-6 rounded-full overflow-hidden border-2 border-transparent hover:border-indigo-500 transition-all transform hover:-translate-y-1 relative group"
            title="English">
            <img src="https://flagcdn.com/w40/gb.png" alt="English" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
        </button>
        <button onclick="changeGlobalLanguage('vi')"
            class="w-6 h-6 rounded-full overflow-hidden border-2 border-transparent hover:border-indigo-500 transition-all transform hover:-translate-y-1 relative group"
            title="Ti·∫øng Vi·ªát">
            <img src="https://flagcdn.com/w40/vn.png" alt="Vietnamese" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
        </button>
    </div>

    <script>
        // Global Language Switcher
        async function changeGlobalLanguage(lang) {
            try {
                const res = await fetch('/api/settings/language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang: lang })
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    // Show animation or toast
                    Utils.showToast('Language changing...', 'success');
                    setTimeout(() => window.location.reload(), 500);
                }
            } catch (e) {
                console.error("Language switch failed:", e);
                Utils.showToast('Failed to switch language', 'error');
            }
        }

        // Highlight current lang
        document.addEventListener('DOMContentLoaded', () => {
            // current_lang is injected by Jinja2, but we can't access it easily in JS variable unless we distinct it.
            // But we can check the html lang attribute if set, or just use server logic.
            // Ideally visual feedback is good.
            // Let's assume re-render handles it, but for active state:
            // We can check cookies? Or just reliance on reload.
        });
    </script>

    <script>
        // ÌîÑÎ°úÏ†ùÌä∏ ÏÉÅÌÉú ÌïúÍ∏Ä
        const statusLabels = {
            'draft': 'ÏãúÏûë',
            'analyzed': 'Î∂ÑÏÑù ÏôÑÎ£å',
            'planned': 'Í∏∞Ìöç ÏôÑÎ£å',
            'scripted': 'ÎåÄÎ≥∏ ÏôÑÎ£å',
            'tts_done': 'TTS ÏôÑÎ£å',
            'rendered': 'Î†åÎçîÎßÅ ÏôÑÎ£å',
            'completed': 'ÏôÑÎ£å'
        };

        // ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù Î°úÎìú
        async function loadProjects() {
            try {
                const data = await API.project.list();
                const select = document.getElementById('projectSelect');
                const currentId = getCurrentProject();

                select.innerHTML = '<option value="">ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù...</option>';

                data.projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name} (${statusLabels[p.status] || p.status})`;
                    if (p.id == currentId) option.selected = true;
                    select.appendChild(option);
                });

                // ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÌëúÏãú Î∞è Ï†ÑÏ≤¥ ÏÉÅÌÉú Î≥µÍµ¨
                if (currentId) {
                    // onProjectChangeÎ•º Ìò∏Ï∂úÌïòÏó¨ Ìó§Îçî, ÏßÑÌñâÏÉÅÌÉú, Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Îç∞Ïù¥ÌÑ∞ Îì±ÏùÑ Î™®Îëê Î≥µÍµ¨
                    onProjectChange(currentId);
                }
            } catch (e) {
                console.error('ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú Ïò§Î•ò:', e);
            }
        }

        // ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateProjectInfo(project) {
            const infoDiv = document.getElementById('currentProjectInfo');
            const statusSpan = document.getElementById('projectStatus');

            if (project) {
                infoDiv.classList.remove('hidden');
                statusSpan.textContent = `ÏÉÅÌÉú: ${statusLabels[project.status] || project.status}`;
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        // ÌîÑÎ°úÏ†ùÌä∏ Î≥ÄÍ≤Ω
        async function onProjectChange(projectId) {
            if (projectId) {
                // 1. UI Î∞è Î°úÏª¨ ÏÉÅÌÉú Í∏∞Î≥∏ ÏóÖÎç∞Ïù¥Ìä∏
                setCurrentProject(projectId);

                // Select Box ÏóÖÎç∞Ïù¥Ìä∏ (ÌîÑÎ°úÍ∑∏Îû®Ï†Å Ìò∏Ï∂ú Ïãú ÌïÑÏöî)
                const selectElement = document.getElementById('projectSelect');
                if (selectElement && selectElement.value != projectId) {
                    selectElement.value = projectId;
                }

                // 2. ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï°∞Ìöå Î∞è ÌëúÏãú
                try {
                    const res = await API.project.get(projectId);
                    // [ROBUST] Handle both wrapped {project: ...} and direct object response
                    const project = (res && res.project) ? res.project : res;

                    if (!project || (!project.id && !project.name)) throw new Error("Invalid project data");

                    updateProjectInfo(project);

                    // Header Display Update
                    const headerDisplay = document.getElementById('currentProjectNameDisplay');
                    if (headerDisplay) {
                        const statusText = statusLabels[project.status] || project.status;
                        headerDisplay.textContent = `${project.name} (${statusText})`;
                        document.getElementById('projectProgressHeader').classList.remove('hidden');
                    }

                    Utils.showToast(`ÌîÑÎ°úÏ†ùÌä∏ "${project.name}" Î∂àÎü¨Ïò§Îäî Ï§ë...`, 'info');

                    // 3. ‚ú® Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî (Context Switching ÌïµÏã¨) ‚ú®
                    const fullData = await API.project.getFull(projectId);

                    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Í∞Å Îã®Í≥Ñ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                    if (fullData) {
                        // ÎåÄÎ≥∏ Í∏∞Ìöç
                        if (fullData.script_structure) Utils.storage.set('scriptStructure', fullData.script_structure);
                        // ÎåÄÎ≥∏ 
                        if (fullData.script) Utils.storage.set('fullScript', fullData.script);
                        // Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ (image_gen.htmlÏö©)
                        if (fullData.image_prompts) Utils.storage.set('imagePrompts', fullData.image_prompts);

                        // Ïù¥Î≤§Ìä∏ Î∞úÏÉù (ÌòÑÏû¨ ÌéòÏù¥ÏßÄÍ∞Ä Î¶¨Ïä§Îãù Ï§ëÏù¥ÎùºÎ©¥ Ï¶âÏãú Î∞òÏòÅ)
                        window.dispatchEvent(new CustomEvent('projectStateRestored', { detail: fullData }));

                        // ‚ú® UI ÏßÑÌñâ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (Green Light)
                        // ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠: Í∞Å Îã®Í≥ÑÎ≥Ñ Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Ï°¥Ïû¨ Ïó¨Î∂ÄÎßå ÌôïÏù∏ (Strict Mode)
                        const settings = fullData.settings || {};
                        const steps = {
                            'topic': !!(fullData.project && fullData.project.topic),
                            'thumbnail': !!(settings.thumbnail_url || settings.thumbnail_path || (fullData.project && (fullData.project.thumbnail_url || fullData.project.thumbnail_path))),
                            'plan': !!fullData.script_structure,
                            'script': !!fullData.script || (fullData.shorts && Object.keys(fullData.shorts).length > 0),
                            'intro': !!settings.intro_video_path || !!settings.background_video_url,
                            'image': fullData.image_prompts && fullData.image_prompts.length > 0,
                            'tts': !!fullData.tts,
                            'subtitle': !!settings.subtitle_path || (fullData.tts && !!settings.subtitle_style_enum),
                            'render': project.status === 'rendered' || project.status === 'completed' || !!settings.video_path,
                            'upload': !!settings.is_uploaded
                        };

                        document.querySelectorAll('.step-item').forEach(el => {
                            const stepName = el.dataset.step;
                            const circle = el.querySelector('.step-circle');
                            const indicator = el.querySelector('.step-circle div');
                            const label = el.querySelector('span');

                            // Check if element exists (safety)
                            if (!circle || !indicator || !label) return;

                            // Reset
                            circle.className = 'step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300';
                            indicator.className = 'w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors';
                            indicator.innerHTML = ''; // Clear SVG
                            label.classList.remove('text-green-500', 'font-bold', 'text-green-600', 'dark:text-green-400');
                            label.classList.add('text-gray-400');

                            if (steps[stepName]) {
                                // Completed Style
                                circle.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                                circle.classList.add('bg-green-500', 'border-green-500', 'dark:bg-green-500', 'dark:border-green-500');

                                indicator.className = 'w-2 h-1.5 text-white'; // Checkmark logic optional or just white dot
                                indicator.innerHTML = `<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                                indicator.classList.remove('rounded-full', 'bg-gray-400', 'w-1.5', 'h-1.5'); // Remove dot styles

                                label.classList.remove('text-gray-400');
                                label.classList.add('text-green-600', 'dark:text-green-400', 'font-bold');
                            }
                        });


                        Utils.showToast(`"${project.name}" Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å`, 'success');
                    }

                } catch (e) {
                    console.error("ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú Ïã§Ìå®", e);
                    Utils.showToast('ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }

            } else {
                setCurrentProject(null);
                document.getElementById('currentProjectInfo').classList.add('hidden');
                document.getElementById('projectProgressHeader').classList.add('hidden');

                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Îç∞Ïù¥ÌÑ∞ÎèÑ ÎπÑÏö∞Îäî Í≤ÉÏù¥ Ï¢ãÏùå (ÏÑ†ÌÉù Ìï¥Ï†ú Ïãú)
                Utils.storage.remove('scriptStructure');
                Utils.storage.remove('fullScript');
                Utils.storage.remove('imagePrompts');
            }
        }


        // ÌîÑÎ°úÏ†ùÌä∏ Î™®Îã¨ Ïó¥Í∏∞/Îã´Í∏∞
        function openProjectModal() {
            document.getElementById('projectModal').classList.remove('hidden');
            document.getElementById('projectModal').classList.add('flex');
            document.getElementById('newProjectName').focus();
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.add('hidden');
            document.getElementById('projectModal').classList.remove('flex');
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectTopic').value = '';
            document.getElementById('newProjectLanguage').value = 'ko'; // Reset to default
        }

        // ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
        async function createNewProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const topic = document.getElementById('newProjectTopic').value.trim();
            const language = document.getElementById('newProjectLanguage').value; // [NEW] Read language

            if (!name) {
                Utils.showToast('ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'warning');
                return;
            }

            try {
                // [CLEANUP] Clear existing project data from local storage to ensure clean state
                Utils.storage.remove('scriptStructure');
                Utils.storage.remove('fullScript');
                Utils.storage.remove('imagePrompts');
                Utils.storage.remove('characterPrompts'); // [NEW]
                localStorage.removeItem('trendKeywords'); // [NEW]
                localStorage.removeItem('topicPageState'); // [NEW]
                localStorage.removeItem('latestScriptStyle'); // Optional: reset style preference

                // [NEW] Get Current Mode from Settings
                let currentMode = 'longform';
                try {
                    // Cache busting to ensure fresh settings
                    const res = await fetch('/api/settings?t=' + new Date().getTime());
                    const settings = await res.json();
                    currentMode = settings.app_mode || 'longform';
                } catch (e) { console.error("Failed to load settings:", e); }

                const result = await API.project.create(name, topic || null, language, currentMode); // [FIX] Pass app_mode
                if (result.project_id) {
                    setCurrentProject(result.project_id);
                    closeProjectModal();
                    Utils.showToast('ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§', 'success');

                    // [FIX] Redirect to projects page to see the newly created project
                    setTimeout(() => {
                        window.location.href = '/projects';
                    }, 500);
                }
            } catch (e) {
                Utils.showToast('ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Ïã§Ìå®', 'error');
            }
        }

        // API ÏÉÅÌÉú ÌôïÏù∏
        async function checkApiStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                const statusDot = document.getElementById('statusDot');
                const apiStatus = document.getElementById('apiStatus');

                if (data.status === 'ok') {
                    const activeApis = Object.entries(data.apis)
                        .filter(([k, v]) => v)
                        .map(([k]) => k);

                    statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    apiStatus.innerHTML = `
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span class="text-green-600 dark:text-green-400">{{ t('api_connected') }}</span>
                        </div>
                        <div class="text-gray-400">${activeApis.join(', ')}</div>
                    `;
                }
            } catch (e) {
                document.getElementById('statusDot').className = 'w-2 h-2 rounded-full bg-red-500';
            }
        }

        // [NEW] App Mode Navigation Logic
        async function applyAppModeToNav() {
            try {
                const res = await fetch('/api/settings');
                const settings = await res.json();
                const mode = settings.app_mode || 'longform';
                window.APP_MODE = mode; // [NEW] Expose globally
                console.log("Global Mode:", mode);

                // Elements to toggle
                const navPlan = document.getElementById('nav-plan');
                const navIntro = document.getElementById('nav-intro');

                const navTitle = document.getElementById('nav-title');
                const navShorts = document.getElementById('nav-shorts');
                const navScript = document.getElementById('nav-script');
                const navTopic = document.getElementById('nav-topic');

                if (mode === 'shorts') {
                    // Shorts Mode: Show Planner (USER REQUEST), but Hide Intro, BGM, Title, Shorts-Extraction
                    // if (navPlan) navPlan.parentElement.classList.add('hidden'); // [MODIFIED] Show planner for shorts
                    if (navIntro) navIntro.parentElement.classList.add('hidden');

                    if (navTitle) navTitle.parentElement.classList.add('hidden');

                    // Hide the 'Shorts Extraction' tool because we are building shorts directly
                    if (navShorts) navShorts.parentElement.classList.add('hidden');

                    // Rename Script Gen
                    if (navScript) {
                        navScript.querySelector('span:last-child').textContent = "{{ t('nav_script_shorts') }}";
                    }
                } else {
                    // Longform Mode: Show everything (default)
                    if (navPlan) navPlan.parentElement.classList.remove('hidden');
                    if (navIntro) navIntro.parentElement.classList.remove('hidden');

                    if (navTitle) navTitle.parentElement.classList.remove('hidden');
                    if (navShorts) navShorts.parentElement.classList.remove('hidden');

                    if (navScript) {
                        navScript.querySelector('span:last-child').textContent = "{{ t('nav_script') }}";
                    }
                }

            } catch (e) {
                console.error("Failed to apply mode to nav:", e);
            }
        }

        // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeProjectModal();
        });

        // [NEW] Global function to update step status dynamically
        window.updateStepStatus = function (stepName, isComplete) {
            const el = document.querySelector(`.step-item[data-step="${stepName}"]`);
            if (!el) return;

            const circle = el.querySelector('.step-circle');
            const indicator = el.querySelector('.step-circle div');
            const label = el.querySelector('span');

            if (!circle || !indicator || !label) return;

            if (isComplete) {
                // Completed Style
                circle.className = 'step-circle w-5 h-5 rounded-full bg-green-500 border-2 border-green-500 dark:bg-green-500 dark:border-green-500 flex items-center justify-center transition-all duration-300';

                indicator.className = 'w-2 h-1.5 text-white';
                indicator.innerHTML = `<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                indicator.classList.remove('rounded-full', 'bg-gray-400', 'w-1.5', 'h-1.5');

                label.classList.remove('text-gray-400');
                label.classList.add('text-green-600', 'dark:text-green-400', 'font-bold');
            } else {
                // Reset (if needed)
                circle.className = 'step-circle w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-900 flex items-center justify-center transition-all duration-300';
                indicator.className = 'w-1.5 h-1.5 rounded-full bg-gray-400 transition-colors';
                indicator.innerHTML = '';
                label.classList.remove('text-green-600', 'dark:text-green-400', 'font-bold');
                label.classList.add('text-gray-400');
            }
        };

        // Ï¥àÍ∏∞Ìôî
        loadProjects();
        checkApiStatus();
        applyAppModeToNav();
    </script>
</body>

</html>