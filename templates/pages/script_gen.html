{% extends "base.html" %}

{% block content %}

<!-- Main 1:2 Split Layout -->
<div class="flex gap-4 h-[calc(100vh-140px)]">

    <!-- LEFT: File Explorer (1/3) -->
    <div class="w-1/3 flex flex-col bg-gray-900 rounded-xl border border-gray-700 overflow-hidden">
        <!-- Explorer Header -->
        <div class="flex items-center justify-between px-3 py-2 bg-gray-800 border-b border-gray-700">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
                {{ t('script_explorer_title') }}
            </h3>
            <div class="flex gap-1">
                <button onclick="createNewFolder()"
                    class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded transition-colors"
                    title="{{ t('btn_new_folder') }}">
                    ğŸ“+
                </button>
                <button onclick="refreshExplorer()"
                    class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded transition-colors"
                    title="{{ t('btn_refresh') }}">
                    ğŸ”„
                </button>
            </div>
        </div>

        <!-- Explorer Tree -->
        <div id="explorerTree" class="flex-1 overflow-y-auto p-2 custom-scrollbar">
            <div class="text-center py-10 text-gray-500 text-sm">
                {{ t('status_loading_explorer') }}
            </div>
        </div>
    </div>

    <!-- RIGHT: Content Area (2/3) -->
    <div class="w-2/3 flex flex-col overflow-hidden">

        <!-- Tab Bar -->
        <div class="flex gap-1 bg-gray-800 rounded-t-xl p-1.5 border-b border-gray-700">
            <button onclick="setScriptMode('ai')" id="tabAI"
                class="px-4 py-2 rounded-lg text-xs font-bold transition-all bg-gray-700 text-white">
                {{ t('tab_ai_gen') }}
            </button>
            <button onclick="setScriptMode('manual')" id="tabManual"
                class="px-4 py-2 rounded-lg text-xs font-medium text-gray-400 hover:text-gray-200">
                {{ t('tab_manual_input') }}
            </button>
            <div class="flex-1"></div>
            <span id="currentFileIndicator" class="text-xs text-gray-500 self-center px-2">{{ t('indicator_new_script')
                }}</span>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto bg-gray-900/50 rounded-b-xl p-4 custom-scrollbar">

            <!-- AI Generation Mode -->
            <div id="aiGenSection">
                <!-- Topic & Structure Info -->
                <div id="analysisInfo" class="card mb-4 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-white">{{ t('gen_based_structure') }}</h3>
                        <button onclick="window.location.href='/script-plan'"
                            class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-gray-300 transition-colors">
                            {{ t('btn_replan_structure') }}
                        </button>
                    </div>
                    <input type="text" id="structureTopic" class="input-field text-sm"
                        placeholder="{{ t('plan_topic_label') }}">
                </div>


                <!-- Options Panel removed as per user request -->

                <!-- Generate Button -->
                <div class="flex justify-end gap-2 mb-4">
                    <button onclick="stopAndSave()" id="stopBtn"
                        class="hidden btn-secondary bg-red-900/50 text-red-400 py-2 px-4 rounded-lg text-sm">
                        {{ t('btn_stop_save') }}
                    </button>
                    <button onclick="generateScript()" id="generateBtn"
                        class="btn-primary py-2.5 px-6 rounded-lg text-sm font-bold">
                        {{ t('btn_start_gen') }}
                    </button>
                </div>

                <!-- AI Data Preview (Collapsed) -->
                <details class="bg-gray-900 rounded-lg p-2 border border-gray-700 mb-4">
                    <summary class="text-xs text-blue-400 cursor-pointer">{{ t('preview_ai_data') }}</summary>
                    <pre id="previewContent"
                        class="mt-2 text-[10px] text-gray-400 font-mono whitespace-pre-wrap max-h-40 overflow-auto">{{ t('preview_loading') }}</pre>
                </details>
            </div>

            <!-- Manual Input Mode (Hidden by default) -->
            <div id="manualInputSection" class="hidden">
                <div class="bg-yellow-900/20 border border-yellow-800 rounded-lg p-4 mb-4">
                    <h3 class="text-sm font-bold text-white mb-2">{{ t('manual_paste_title') }}</h3>
                    <p class="text-xs text-gray-400 mb-3">{{ t('manual_paste_desc') }}</p>
                    <textarea id="manualScriptInput" class="input-field font-mono text-sm" rows="10"
                        placeholder="{{ t('manual_placeholder') }}"></textarea>
                </div>
                <div class="flex justify-end">
                    <button onclick="registerManualScript()" class="btn-primary py-2 px-6 rounded-lg text-sm font-bold">
                        {{ t('btn_finish_editing') }}
                    </button>
                </div>
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="hidden">
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-white">{{ t('result_script_title') }}</h3>
                        <div class="flex gap-2">
                            <button onclick="translateScript()" id="translateBtn"
                                class="btn-secondary text-xs hidden">{{ t('btn_translate') }}</button>
                            <!-- [NEW] Clean Script Button -->
                            <button onclick="cleanCurrentScript()"
                                class="btn-secondary text-xs flex items-center gap-1 border-yellow-600/50 text-yellow-500 hover:bg-yellow-500/10 px-3">
                                âœ¨ ì •ì œ
                            </button>
                            <button onclick="copyScript()"
                                class="btn-primary text-xs flex items-center gap-1 bg-blue-600 hover:bg-blue-500 text-white px-3">
                                ğŸ“‹ <span class="font-bold">{{ t('btn_copy_all') }}</span>
                            </button>
                            <button onclick="saveCurrentScript()" class="btn-primary text-xs">{{ t('btn_save')
                                }}</button>
                        </div>
                    </div>

                    <div class="flex gap-3 text-xs text-gray-400 mb-3">
                        <span id="charCount" class="bg-gray-700 px-2 py-0.5 rounded">0 {{ t('stats_chars') }}</span>
                        <span id="readTime" class="bg-gray-700 px-2 py-0.5 rounded">{{ t('stats_read_time') }}: 0 {{
                            t('stats_unit_min') }}</span>
                    </div>

                    <textarea id="scriptContent" class="input-field font-mono text-sm" rows="15"></textarea>

                    <div class="flex justify-center gap-3 mt-4 pt-4 border-t border-gray-700">
                        <!-- [NEW] Autopilot Continue Button -->
                        <button onclick="continueWithAutopilot()" id="autopilotBtn"
                            class="py-2 px-6 font-bold shadow-md hover:shadow-xl transition-all rounded-lg flex items-center gap-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white border-0">
                            <span>ğŸš€</span>
                            <span>{{ t('btn_continue_autopilot') }}</span>
                        </button>

                        <button onclick="addToQueue()" id="queueBtn"
                            class="py-2 px-6 font-bold shadow-md hover:shadow-xl transition-all rounded-lg flex items-center gap-2 bg-gradient-to-r from-green-600 to-teal-600 text-white border-0">
                            <span>ğŸ“¥</span>
                            <span>ì œì‘ ëŒ€ê¸°ì—´ì— ë‹´ê¸°</span>
                        </button>

                        <button onclick="goToImageGen()" class="btn-primary py-2 px-4 rounded-lg text-sm">
                            {{ t('btn_go_image') }}
                        </button>
                        <button onclick="goToTTS()" class="btn-secondary py-2 px-4 rounded-lg text-sm">
                            {{ t('btn_go_tts') }}
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Folder Creation Modal -->
<div id="folderModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-80 border border-gray-600">
        <h3 class="text-lg font-bold text-white mb-4">{{ t('modal_new_folder') }}</h3>
        <input type="text" id="newFolderName" class="input-field w-full mb-4"
            placeholder="{{ t('placeholder_folder_name') }}">
        <div class="flex gap-2 justify-end">
            <button onclick="closeFolderModal()" class="btn-secondary py-2 px-4 text-sm">{{ t('btn_cancel') }}</button>
            <button onclick="confirmCreateFolder()" class="btn-primary py-2 px-4 text-sm">{{ t('btn_create') }}</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentScript = '';
    let currentFileId = null;
    let explorerData = { folders: [], files: [] };

    // i18n for JS
    const i18n = {
        loading: "{{ t('status_loading_explorer') }}",
        empty_title: "{{ t('empty_explorer_title') }}",
        empty_desc: "{{ t('empty_explorer_desc') }}",
        status_has_script: "{{ t('status_has_script') }}",
        status_planned: "{{ t('status_planned') }}",
        status_planning: "{{ t('status_planning') }}",
        status_no_topic: "{{ t('status_no_topic') }}",
        indicator_new_script: "{{ t('indicator_new_script') }}",
        renamed: "{{ t('toast_renamed') }}",
        folder_deleted: "{{ t('toast_folder_deleted') }}",
        file_moved: "{{ t('toast_file_moved') }}",
        stats_chars: "{{ t('stats_chars') }}",
        stats_read_time: "{{ t('stats_read_time') }}",
        stats_unit_min: "{{ t('stats_unit_min') }}"
    };

    // ========== EXPLORER FUNCTIONS ==========

    async function refreshExplorer() {
        const container = document.getElementById('explorerTree');
        container.innerHTML = `<div class="text-center py-8 text-gray-500 text-sm">${i18n.loading}</div>`;

        try {
            // Load folders from localStorage (simple approach)
            const savedFolders = JSON.parse(localStorage.getItem('scriptFolders') || '[]');

            // Load ALL projects (not just those with scripts)
            const data = await API.project.list();
            const projects = data.projects || [];

            // Filter to only show projects with script planning done (status !== 'created')
            // Status progression: created -> structured -> scripted -> image_prompted -> completed
            const plannedProjects = projects.filter(p =>
                p.status && p.status !== 'created' && p.status !== ''
            );

            // Show planned projects in the explorer
            const allProjectFiles = plannedProjects.map(p => ({
                id: p.id,
                name: p.name,
                topic: p.topic,
                status: p.status,
                hasScript: p.status === 'scripted' || p.status === 'image_prompted' || p.status === 'completed',
                hasStructure: p.status === 'structured' || p.status === 'scripted' || p.status === 'image_prompted' || p.status === 'completed',
                folderId: localStorage.getItem(`script_folder_${p.id}`) || null
            }));

            explorerData.folders = savedFolders;
            explorerData.files = allProjectFiles;

            renderExplorer();
        } catch (e) {
            console.error('Explorer load failed:', e);
            container.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
        }
    }

    function renderExplorer() {
        const container = document.getElementById('explorerTree');

        if (explorerData.folders.length === 0 && explorerData.files.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 text-gray-500">
                    <div class="text-3xl mb-2">ğŸ“­</div>
                    <p class="text-sm">${i18n.empty_title}</p>
                    <p class="text-xs mt-1 text-gray-600">${i18n.empty_desc}</p>
                </div>
            `;
            return;
        }

        let html = '';

        // Render folders
        explorerData.folders.forEach(folder => {
            const filesInFolder = explorerData.files.filter(f => f.folderId === folder.id);
            html += `
                <div class="folder-item mb-1"
                     ondragover="event.preventDefault(); event.currentTarget.classList.add('bg-yellow-900/30');"
                     ondragleave="event.currentTarget.classList.remove('bg-yellow-900/30');"
                     ondrop="dropFileToFolder(event, '${folder.id}')">
                    <div class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-800 cursor-pointer group" 
                         onclick="toggleFolder('${folder.id}')">
                        <span class="text-yellow-500" id="folderIcon_${folder.id}">ğŸ“</span>
                        <span class="text-sm text-gray-300 flex-1" ondblclick="event.stopPropagation(); renameFolder('${folder.id}')">${folder.name}</span>
                        <span class="text-xs text-gray-600">${filesInFolder.length}</span>
                        <button onclick="event.stopPropagation(); deleteFolder('${folder.id}')" 
                                class="opacity-0 group-hover:opacity-100 text-xs text-red-400 hover:text-red-300">âœ•</button>
                    </div>
                    <div id="folderContent_${folder.id}" class="hidden pl-4">
                        ${filesInFolder.map(f => renderFileItem(f)).join('')}
                    </div>
                </div>
            `;
        });

        // Render files without folder (root level)
        const rootFiles = explorerData.files.filter(f => !f.folderId);
        rootFiles.forEach(f => {
            html += renderFileItem(f);
        });

        container.innerHTML = html;
    }

    function renderFileItem(file) {
        const isActive = currentFileId === file.id;

        // Determine status display
        let statusIcon, statusColor, statusText;
        if (file.hasScript) {
            statusIcon = 'ğŸ“„';
            statusColor = 'text-green-400';
            statusText = i18n.status_has_script;
        } else if (file.hasStructure) {
            statusIcon = 'ğŸ“‹';
            statusColor = 'text-yellow-400';
            statusText = i18n.status_planned;
        } else {
            statusIcon = 'ğŸ“';
            statusColor = 'text-gray-500';
            statusText = i18n.status_planning;
        }

        return `
        <div id="fileItem_${file.id}" class="file-item flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer group transition-colors
                        ${isActive ? 'bg-blue-900/50 border border-blue-700' : 'hover:bg-gray-800'}"
            onclick="selectFile('${file.id}')"
            ondblclick="openFile('${file.id}')"
            draggable="true"
            ondragstart="dragFile(event, '${file.id}')">
            <span class="${statusColor}">${statusIcon}</span>
            <div class="flex-1 min-w-0">
                <p class="text-sm text-gray-200 truncate select-none">${file.name}</p>
                <p class="text-[10px] text-gray-500 truncate select-none">${file.topic || i18n.status_no_topic}</p>
            </div>
            <span class="text-[10px] ${statusColor} select-none">${statusText}</span>
            <button onclick="event.stopPropagation(); deleteProject(${file.id}, '${file.name.replace(/'/g, "\\'")}')"
                        class="opacity-0 group-hover:opacity-100 text-xs text-red-400 hover:text-red-300 ml-1" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            </div >
            `;
    }

    function selectFile(fileId) {
        currentFileId = fileId;

        // Remove active class from all items
        document.querySelectorAll('.file-item').forEach(el => {
            el.classList.remove('bg-blue-900/50', 'border', 'border-blue-700');
            el.classList.add('hover:bg-gray-800');
        });

        // Add active class to selected item
        const selected = document.getElementById(`fileItem_${fileId}`);
        if (selected) {
            selected.classList.remove('hover:bg-gray-800');
            selected.classList.add('bg-blue-900/50', 'border', 'border-blue-700');
        }
    }

    function toggleFolder(folderId) {
        const content = document.getElementById(`folderContent_${folderId}`);
        const icon = document.getElementById(`folderIcon_${folderId}`);
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = 'ğŸ“‚';
        } else {
            content.classList.add('hidden');
            icon.textContent = 'ğŸ“';
        }
    }

    async function openFile(projectId) {
        console.log("openFile called with:", projectId);
        try {
            currentFileId = projectId;
            setCurrentProject(projectId);

            const full = await API.project.getFull(projectId);

            // Always prepare to show the editor
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('currentFileIndicator').textContent = full?.project?.name || i18n.indicator_new_script;

            console.log("Full Data loaded:", full);

            let scriptContent = '';
            if (full && full.script) {
                console.log("Script Data Structure:", full.script); // For debugging
                if (typeof full.script === 'string') {
                    scriptContent = full.script;
                } else {
                    // Try all possible keys including camelCase and common names
                    scriptContent = full.script.full_script ||
                        full.script.script ||
                        full.script.content ||
                        full.script.fullScript ||
                        full.script.text ||
                        full.script.body ||
                        '';
                }
            }

            currentScript = scriptContent;
            document.getElementById('scriptContent').value = currentScript;

            if (scriptContent) {
                Utils.showToast(`"${full.project?.name}" ëŒ€ë³¸ ì—´ë¦¼`, 'success');
            } else {
                // REVERTED TO FULL DUMP TO CHECK DEBUG KEY
                console.warn("Script loading failed, dumping FULL object");

                // Check if our debug key exists
                const hasDebugKey = full && full.debug_script_chk;
                let debugMsg = "=== DEBUG MODE: FULL DATA DUMP ===\n";
                if (hasDebugKey) {
                    debugMsg += `[FOUND TRACKING TAG] status: ${full.debug_script_chk.status}, has_script: ${full.debug_script_chk.has_script}\n`;
                } else {
                    debugMsg += "[WARNING] TRACKING TAG NOT FOUND (Server code might be outdated)\n";
                }

                scriptContent = debugMsg + JSON.stringify(full, null, 2);
                document.getElementById('scriptContent').value = scriptContent;

                Utils.showToast('ë””ë²„ê·¸ ëª¨ë“œ: ì „ì²´ êµ¬ì¡° í™•ì¸ (ìº¡ì²˜í•´ì£¼ì„¸ìš”)', 'warning');
            }

            updateStats();

            // Update structure data if exists
            if (full && full.script_structure) {
                Utils.storage.set('scriptStructure', full.script_structure);
                document.getElementById('analysisInfo').classList.remove('hidden');
                document.getElementById('structureTopic').value = full.project?.topic || '';
            } else {
                document.getElementById('analysisInfo').classList.add('hidden');
            }

            renderExplorer(); // Refresh to show active state

        } catch (e) {
            console.error(e);
            Utils.showToast('íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨', 'error');
        }
    }

    // ========== FOLDER MANAGEMENT ==========

    function createNewFolder() {
        document.getElementById('folderModal').classList.remove('hidden');
        document.getElementById('folderModal').classList.add('flex');
        document.getElementById('newFolderName').focus();
    }

    function closeFolderModal() {
        document.getElementById('folderModal').classList.add('hidden');
        document.getElementById('folderModal').classList.remove('flex');
        document.getElementById('newFolderName').value = '';
    }

    function confirmCreateFolder() {
        const name = document.getElementById('newFolderName').value.trim();
        if (!name) {
            Utils.showToast('í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const folders = JSON.parse(localStorage.getItem('scriptFolders') || '[]');
        folders.push({
            id: 'folder_' + Date.now(),
            name: name,
            created: new Date().toISOString()
        });
        localStorage.setItem('scriptFolders', JSON.stringify(folders));

        closeFolderModal();
        refreshExplorer();
        Utils.showToast(`í´ë” "${name}" ìƒì„±ë¨`, 'success');
    }

    function renameFolder(folderId) {
        const newName = prompt('ìƒˆ í´ë” ì´ë¦„:');
        if (!newName) return;

        const folders = JSON.parse(localStorage.getItem('scriptFolders') || '[]');
        const folder = folders.find(f => f.id === folderId);
        if (folder) {
            folder.name = newName;
            localStorage.setItem('scriptFolders', JSON.stringify(folders));
            refreshExplorer();
            Utils.showToast(i18n.renamed, 'success');
        }
    }

    function deleteFolder(folderId) {
        if (!confirm('ì´ í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒŒì¼ì€ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

        let folders = JSON.parse(localStorage.getItem('scriptFolders') || '[]');
        folders = folders.filter(f => f.id !== folderId);
        localStorage.setItem('scriptFolders', JSON.stringify(folders));

        // Move files to root
        explorerData.files.forEach(f => {
            if (f.folderId === folderId) {
                localStorage.removeItem(`script_folder_${f.id} `);
            }
        });

        refreshExplorer();
        Utils.showToast(i18n.folder_deleted, 'success');
    }

    // Drag & Drop
    function dragFile(event, fileId) {
        event.dataTransfer.setData('fileId', fileId);
    }

    function dropFileToFolder(event, folderId) {
        event.preventDefault();
        event.currentTarget.classList.remove('bg-yellow-900/30');

        const fileId = event.dataTransfer.getData('fileId');
        if (!fileId) return;

        // Save folder assignment to localStorage
        localStorage.setItem(`script_folder_${fileId} `, folderId);

        // Update local data
        const file = explorerData.files.find(f => f.id == fileId);
        if (file) {
            file.folderId = folderId;
        }

        renderExplorer();
        Utils.showToast(i18n.file_moved, 'success');
    }

    // Remove file from folder (move to root)
    function removeFromFolder(fileId) {
        localStorage.removeItem(`script_folder_${fileId} `);
        const file = explorerData.files.find(f => f.id == fileId);
        if (file) {
            file.folderId = null;
        }
        renderExplorer();
        Utils.showToast('í´ë”ì—ì„œ ì œê±°ë¨', 'info');
    }

    // Delete project
    async function deleteProject(projectId, projectName) {
        if (!confirm(`"${projectName}" í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
            return;
        }

        try {
            const response = await fetch(`/ api / projects / ${projectId} `, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Remove from local storage
                localStorage.removeItem(`script_folder_${projectId} `);

                // Update explorer
                explorerData.files = explorerData.files.filter(f => f.id !== projectId);
                renderExplorer();

                // Clear editor if this was the active file
                if (currentFileId === projectId) {
                    currentFileId = null;
                    document.getElementById('scriptContent').value = '';
                    document.getElementById('resultSection').classList.add('hidden');
                    document.getElementById('currentFileIndicator').textContent = i18n.indicator_new_script;
                }

                Utils.showToast(`"${projectName}" ì‚­ì œë¨`, 'success');
            } else {
                throw new Error('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (e) {
            console.error('Delete error:', e);
            Utils.showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    // ========== SCRIPT FUNCTIONS ==========

    function setScriptMode(mode) {
        const tabAI = document.getElementById('tabAI');
        const tabManual = document.getElementById('tabManual');
        const sectionAI = document.getElementById('aiGenSection');
        const sectionManual = document.getElementById('manualInputSection');

        if (mode === 'ai') {
            tabAI.classList.add('bg-gray-700', 'text-white', 'font-bold');
            tabAI.classList.remove('text-gray-400');
            tabManual.classList.remove('bg-gray-700', 'text-white', 'font-bold');
            tabManual.classList.add('text-gray-400');
            sectionAI.classList.remove('hidden');
            sectionManual.classList.add('hidden');
        } else {
            tabManual.classList.add('bg-gray-700', 'text-white', 'font-bold');
            tabManual.classList.remove('text-gray-400');
            tabAI.classList.remove('bg-gray-700', 'text-white', 'font-bold');
            tabAI.classList.add('text-gray-400');
            sectionAI.classList.add('hidden');
            sectionManual.classList.remove('hidden');
        }
    }

    async function saveCurrentScript() {
        const projectId = getCurrentProject();
        const script = document.getElementById('scriptContent').value;

        if (!script.trim()) {
            Utils.showToast('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        try {
            const charCount = script.length;
            const readTime = Math.ceil(charCount / 415);
            await API.project.saveScript(projectId, script, charCount, readTime);
            Utils.showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            refreshExplorer();
        } catch (e) {
            console.error(e);
            Utils.showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
        }
    }

    function updateStats() {
        const text = document.getElementById('scriptContent').value;
        const charCount = text.length;
        const readTime = Math.ceil(charCount / 415);

        document.getElementById('charCount').textContent = `${charCount.toLocaleString()} ${i18n.stats_chars}`;
        document.getElementById('readTime').textContent = `${i18n.stats_read_time}: ${readTime} ${i18n.stats_unit_min}`;
    }

    document.getElementById('scriptContent')?.addEventListener('input', updateStats);

    function copyScript() {
        const text = document.getElementById('scriptContent').value;
        if (!text) {
            Utils.showToast('ë³µì‚¬í•  ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }
        Utils.copyToClipboard(text);
        Utils.showToast('ëŒ€ë³¸ ì „ì²´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹', 'success');
    }

    function cleanCurrentScript() {
        let text = document.getElementById('scriptContent').value;
        if (!text) return;

        if (!confirm('ëŒ€ë³¸ì—ì„œ ê´„í˜¸, ë³„í‘œ(**), ì´ëª¨ì§€, í™”ì í‘œì‹œ ë“±ì„ ëª¨ë‘ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const cleaned = text
            .replace(/\([^)]*\)/g, '')
            .replace(/\[[^\]]*\]/g, '')
            .replace(/\*/g, '')
            .replace(/[^\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318Fa-zA-Z0-9\s,.\?\!\"\'\.]/g, '')
            .replace(/^[ê°€-í£\w\s]+[\s]*:[\s]*/gm, '')
            .replace(/\n\s*\n/g, '\n\n')
            .trim();

        document.getElementById('scriptContent').value = cleaned;
        updateStats();
        Utils.showToast('ëŒ€ë³¸ì´ ê¹¨ë—í•˜ê²Œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨', 'success');
    }

    function goToImageGen() { window.location.href = '/image-gen'; }
    function goToTTS() { window.location.href = '/tts'; }

    // ========== INITIALIZATION ==========

    document.addEventListener('DOMContentLoaded', async () => {
        // [NEW] Check URL for project_id override
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get('project_id');

        if (urlProjectId) {
            setCurrentProject(parseInt(urlProjectId));
        }

        // Load explorer
        await refreshExplorer();

        // Load structure data
        const projectId = getCurrentProject();
        if (projectId) {
            try {
                const projectFull = await API.project.getFull(projectId);
                if (projectFull && projectFull.script_structure) {
                    Utils.storage.set('scriptStructure', projectFull.script_structure);
                    document.getElementById('analysisInfo').classList.remove('hidden');
                    document.getElementById('structureTopic').value = projectFull.project?.topic || '';

                    // Safe check for style
                    if (projectFull.script_structure.script_style) {
                        // UI update if style input exists (currently hidden/not present in HTML but good for data)
                    }
                }

                if (projectFull && projectFull.script && projectFull.script.full_script) {
                    currentScript = projectFull.script.full_script;
                    currentFileId = projectId;
                    document.getElementById('scriptContent').value = currentScript;
                    document.getElementById('resultSection').classList.remove('hidden');
                    document.getElementById('currentFileIndicator').textContent = projectFull.project?.name || i18n.indicator_new_script;
                    updateStats();
                }
            } catch (e) {
                console.error(e);
            }
        }

        // [NEW] Auto Start Check
        if (urlParams.get('auto_start') === 'true') {
            console.log("Auto-start generation triggered");
            Utils.showToast('ëŒ€ë³¸ ìƒì„±ì„ ìë™ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            setTimeout(() => {
                if (document.getElementById('generateBtn')) {
                    generateScript();
                }
            }, 1000);
        }
    });

    // ========== GENERATION ==========

    async function generateScript() {
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        // Try to get structure data from storage or fetch from server
        let structureData = Utils.storage.get('scriptStructure');

        if (!structureData || !structureData.sections || structureData.sections.length === 0) {
            console.log("No local structure, fetching from server...");
            try {
                const projectFull = await API.project.getFull(projectId);
                if (projectFull && projectFull.script_structure) {
                    structureData = projectFull.script_structure;
                    Utils.storage.set('scriptStructure', structureData);
                }
            } catch (e) {
                console.error("Failed to fetch structure:", e);
            }
        }

        if (!structureData || !structureData.sections || structureData.sections.length === 0) {
            Utils.showToast('ëŒ€ë³¸ êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. "ëŒ€ë³¸ ê¸°íš" ë‹¨ê³„ë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const btn = document.getElementById('generateBtn');
        const stopBtn = document.getElementById('stopBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤€ë¹„ ì¤‘...');
        stopBtn.classList.remove('hidden');
        window.stopGeneration = false;

        const sections = structureData.sections;
        const topic = document.getElementById('structureTopic')?.value || structureData.topic || 'ì˜ìƒ';
        let finalScript = '';

        const projectFull = await API.project.getFull(projectId);
        const settings = projectFull.settings || {};
        const durationSeconds = settings.duration_seconds || 60;
        const isShorts = (window.APP_MODE === 'shorts') || (durationSeconds <= 60);

        // ê¸€ì ìˆ˜ ê³„ì‚° (í•œêµ­ì–´ ê¸°ì¤€)
        // ë¡±í¼: ë¶„ë‹¹ 450ì (ë¹ ë¦„)
        // ìˆí¼: ì´ˆë‹¹ 7ì (ë§¤ìš° ë¹ ë¦„) ~ 6ì (ë³´í†µ) -> 20ì´ˆë©´ 120~140ì
        let totalTargetChars = 0;
        let lengthInstruction = "";

        if (isShorts) {
            totalTargetChars = durationSeconds * 7.5; // ìˆí¼ì€ ë§ì„ ì¢€ ë” ë¹¨ë¦¬ í•¨
            lengthInstruction = `[ë§¤ìš° ì¤‘ìš”] ì´ ëŒ€ë³¸ì€ **${durationSeconds}ì´ˆ ìˆí¼(Shorts)** ì˜ìƒìš©ì…ë‹ˆë‹¤. ì „ì²´ ëŒ€ë³¸ì´ ë§¤ìš° ì§§ì•„ì•¼ í•©ë‹ˆë‹¤. êµ°ë”ë”ê¸° ì—†ì´ í•µì‹¬ë§Œ ë¹ ë¥´ê²Œ ì „ë‹¬í•˜ì„¸ìš”.`;
        } else {
            totalTargetChars = (durationSeconds / 60) * 450;
            lengthInstruction = `ì´ ì˜ìƒì€ ì•½ ${Math.floor(durationSeconds / 60)}ë¶„ ${durationSeconds % 60}ì´ˆ ê¸¸ì´ì…ë‹ˆë‹¤.`;
        }

        const charsPerSection = Math.round(totalTargetChars / sections.length);
        // ìˆí¼ì¼ ê²½ìš° ìµœì†Œ ê¸€ì ìˆ˜ ì œí•œì„ ë‚®ì¶¤
        const minChars = isShorts ? Math.max(20, Math.round(charsPerSection * 0.7)) : Math.max(50, Math.round(charsPerSection * 0.8));
        const maxChars = Math.round(charsPerSection * 1.2);

        console.log(`Target: ${durationSeconds}s (${isShorts ? 'Shorts' : 'Longform'}), Total Chars: ${totalTargetChars}, Per Section: ${charsPerSection}`);

        try {
            for (let i = 0; i < sections.length; i++) {
                if (window.stopGeneration) {
                    console.log("Stopped by user");
                    Utils.showToast('ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë¨', 'warning');
                    break;
                }

                const section = sections[i];
                const keyPoints = section.key_points || [];
                Utils.setLoading(btn, true, `ìƒì„± ì¤‘... (${i + 1}/${sections.length}: ${section.title})`);
                console.log(`Generating section ${i + 1}: ${section.title} `);

                const prompt = `ë‹¹ì‹ ì€ ${isShorts ? 'ìœ íŠœë¸Œ ì‡¼ì¸ (Shorts)' : 'ìœ íŠœë¸Œ'} ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ì£¼ì œì— ëŒ€í•œ "${section.title}" íŒŒíŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì˜ìƒ ì£¼ì œ]
${topic}

[í˜„ì¬ ì„¹ì…˜]
- ì œëª©: ${section.title}
- ì£¼ìš” ë‚´ìš©: ${keyPoints.length > 0 ? keyPoints.join(', ') : 'ììœ ë¡­ê²Œ ì‘ì„±'}

[ì‘ì„± ì§€ì¹¨]
0. ${lengthInstruction}
1. ë°˜ë“œì‹œ **ë…ë°±(Monologue) ë˜ëŠ” ë‚˜ë ˆì´ì…˜(Narration) í˜•ì‹**ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. (ëŒ€í™”ì²´ ì ˆëŒ€ ê¸ˆì§€)
2. í™”ìëŠ” **ë¬´ì¡°ê±´ ë”± 1ëª…(ì„±ìš° 1ì¸)**ìœ¼ë¡œ ì œí•œí•©ë‹ˆë‹¤. ëŒ€í™” í˜•ì‹ìœ¼ë¡œ ì—­í• ì„ ë‚˜ëˆ„ì§€ ë§ˆì„¸ìš”.
3. ìì—°ìŠ¤ëŸ½ê³  ëª°ì…ê° ìˆëŠ” í•œêµ­ì–´ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”.
4. ì„¹ì…˜ ì œëª©ì€ ì¶œë ¥í•˜ì§€ ë§ê³ , ë³¸ë¬¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.
5. ì´ íŒŒíŠ¸ì˜ ë¶„ëŸ‰ì€ **ì•½ ${minChars}ì ~ ${maxChars}ì** ë‚´ì™¸ë¡œ ì‘ì„±í•˜ì„¸ìš”. (ì ˆëŒ€ì ìœ¼ë¡œ ì§€í‚¬ ê²ƒ)
6. ${isShorts ? 'ë¬¸ì¥ì„ ì§§ê³  ê°„ê²°í•˜ê²Œ ëŠì–´ì£¼ì„¸ìš”. í˜¸í¡ì„ ì§§ê²Œ ê°€ì ¸ê°€ì„¸ìš”.' : 'ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì£¼ì„¸ìš”.'}

**[ì ˆëŒ€ ê¸ˆì§€ ì‚¬í•­ - TTS ì½ê¸° ì˜¤ë¥˜ ë°©ì§€]**
1. ëŒ€í™” í˜•ì‹ ê¸ˆì§€ (A: ì•„ë‹ˆìš”, B: ë§ì•„ìš” ê°™ì€ ê°€ìƒ ëŒ€í™” ì ˆëŒ€ ë„£ì§€ ë§ ê²ƒ)
2. ê´„í˜¸ì™€ ìƒí™© ì„¤ëª… ê¸ˆì§€ (ì˜ˆ: (ìŒì•…), (ìƒí™©), (ì›ƒìŒ) ë“± ì ˆëŒ€ ë„£ì§€ ë§ ê²ƒ)
3. ì‹œê°„ í‘œì‹œ ê¸ˆì§€ (ì˜ˆ: [0-5ì´ˆ], ** ë“± íƒ€ì„ìŠ¤íƒ¬í”„ ê¸ˆì§€)
4. ì´ëª¨í‹°ì½˜ ë° ê¸°í˜¸ ê¸ˆì§€ (ì˜ˆ: ğŸ¤£, âœ¨, ğŸ”¥ ë“± íŠ¹ìˆ˜ë¬¸ì ê¸ˆì§€)
5. í™”ì(ì´ë¦„) í‘œì‹œ ê¸ˆì§€ (ì˜ˆ: ë‚˜:, ìƒì‚¬: ì²˜ëŸ¼ ëˆ„ê°€ ë§í•˜ëŠ”ì§€ ì ì§€ ë§ ê²ƒ)

ë³¸ë¬¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”: `;

                try {
                    const result = await API.gemini.generate(prompt, { temperature: 0.7, maxTokens: 2048 });
                    console.log(`Section ${i + 1} result: `, result.status);

                    if (result.status === 'ok' && result.text) {
                        let sectionText = result.text.trim();

                        // [CRITICAL] 5ê°€ì§€ ê¸ˆì§€ í•­ëª© ì •ì œ (ê´„í˜¸, íƒ€ì„ìŠ¤íƒ¬í”„, ì´ëª¨í‹°ì½˜, í™”ì í‘œì‹œ, ë³„í‘œ)
                        sectionText = sectionText
                            .replace(/\([^)]*\)/g, '')   // 1. ê´„í˜¸ ì œê±° (ì›ƒìŒ)
                            .replace(/\[[^\]]*\]/g, '')  // 2. ëŒ€ê´„í˜¸ ì œê±° [0-5ì´ˆ]
                            .replace(/\*/g, '')          // 3. ë³„í‘œ ì œê±° **
                            .replace(/[^\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318Fa-zA-Z0-9\s,.\?\!\"\'\.]/g, '') // 4. ì´ëª¨ì§€ ë“± íŠ¹ìˆ˜ë¬¸ì ì œê±°
                            .replace(/^[ê°€-í£\w\s]+[\s]*:[\s]*/gm, '') // 5. í™”ì í‘œì‹œ ì œê±°
                            .trim();

                        finalScript += (finalScript ? '\n\n' : '') + sectionText;
                    } else {
                        finalScript += (finalScript ? '\n\n' : '') + `(ì´ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'})`;
                    }
                } catch (sectionErr) {
                    console.error(`Section ${i + 1} error: `, sectionErr);
                    finalScript += (finalScript ? '\n\n' : '') + `(ìƒì„± ì˜¤ë¥˜: ${sectionErr.message})`;
                }

                // Show progress
                document.getElementById('scriptContent').value = finalScript.trim();
                document.getElementById('resultSection').classList.remove('hidden');
                updateStats();

                // Small delay between sections to avoid rate limiting
                if (i < sections.length - 1 && !window.stopGeneration) {
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            currentScript = finalScript.trim();

            // Save to DB
            if (currentScript) {
                const charCount = currentScript.length;
                const readTime = Math.ceil(charCount / 415);
                await API.project.saveScript(projectId, currentScript, charCount, readTime);
                console.log("Script saved to DB");
            }

            Utils.showToast('ëŒ€ë³¸ ìƒì„± ì™„ë£Œ!', 'success');
            refreshExplorer();

        } catch (e) {
            console.error('Generation error:', e);
            Utils.showToast('ìƒì„± ì˜¤ë¥˜: ' + e.message, 'error');
        } finally {
            Utils.setLoading(btn, false);
            stopBtn.classList.add('hidden');
            window.stopGeneration = false;
        }
    }

    function stopAndSave() {
        window.stopGeneration = true;
        Utils.showToast('ìƒì„± ì¤‘ë‹¨ë¨', 'warning');
    }

    async function registerManualScript() {
        const text = document.getElementById('manualScriptInput').value.trim();
        if (!text) {
            Utils.showToast('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const projectId = getCurrentProject();
        currentScript = text;
        document.getElementById('scriptContent').value = text;
        document.getElementById('resultSection').classList.remove('hidden');
        updateStats();

        if (projectId) {
            try {
                await API.project.saveScript(projectId, text, text.length, Math.ceil(text.length / 415));
                Utils.showToast('ëŒ€ë³¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                refreshExplorer();
            } catch (e) {
                console.error(e);
            }
        }
    }

    async function continueWithAutopilot() {
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast("í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
            return;
        }

        if (!confirm("í˜„ì¬ ëŒ€ë³¸ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ê³¼ì •(ì´ë¯¸ì§€ ìƒì„±, ì˜¤ë””ì˜¤, ë Œë”ë§)ì„ ì˜¤í† íŒŒì¼ëŸ¿ìœ¼ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const btn = document.getElementById('autopilotBtn');
        const originalText = btn.innerHTML;
        Utils.setLoading(btn, true, "ğŸš€ ì‹œë™ ì¤‘...");

        try {
            const res = await fetch(`/api/autopilot/continue/${projectId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auto_plan: false })
            });
            const data = await res.json();

            if (data.status === 'ok') {
                Utils.showToast("ì˜¤í† íŒŒì¼ëŸ¿ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€", "success");
                window.location.href = `/autopilot?project_id=${projectId}&monitor=true`;
            } else {
                throw new Error(data.error || "ì˜¤í† íŒŒì¼ëŸ¿ ì‹œì‘ ì‹¤íŒ¨");
            }
        } catch (e) {
            console.error(e);
            Utils.showToast(e.message, "error");
        } finally {
            Utils.setLoading(btn, false);
            btn.innerHTML = originalText;
        }
    }

    async function addToQueue() {
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast("í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error");
            return;
        }

        const btn = document.getElementById('queueBtn');
        const originalText = btn.innerHTML;
        Utils.setLoading(btn, true, "ë‹´ëŠ” ì¤‘...");

        try {
            // 1. Ensure current script is saved
            const script = document.getElementById('scriptContent').value;
            if (script.trim()) {
                await API.project.saveScript(projectId, script, script.length, Math.ceil(script.length / 415));
            }

            // 2. Fetch current settings to preserve them
            const fullData = await API.project.getFull(projectId);
            const settings = fullData.settings || {};
            const project = fullData.project || {};

            // 3. Add to Queue
            const res = await fetch(`/api/projects/${projectId}/queue`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic: project.topic || "Untitled",
                    script_style: settings.script_style || "default",
                    duration_seconds: settings.duration_seconds || 60,
                    auto_plan: false, // Don't re-generate script
                    visual_style: settings.visual_style || "realistic",
                    thumbnail_style: settings.thumbnail_style || "face",
                    all_video: settings.all_video || false,
                    motion_method: settings.motion_method || "standard",
                    video_scene_count: settings.video_scene_count || 0
                })
            });

            const data = await res.json();
            if (data.status === 'ok') {
                Utils.showToast("ëŒ€ê¸°ì—´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¥", "success");
                setTimeout(() => {
                    if (confirm("ëŒ€ê¸°ì—´ì— ë‹´ì•˜ìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        window.location.href = '/script-plan';
                    }
                }, 500);
            } else {
                throw new Error(data.error || "ëŒ€ê¸°ì—´ ì¶”ê°€ ì‹¤íŒ¨");
            }
        } catch (e) {
            console.error(e);
            Utils.showToast(e.message, "error");
        } finally {
            Utils.setLoading(btn, false);
            btn.innerHTML = originalText;
        }
    }
</script>
{% endblock %}