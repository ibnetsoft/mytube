{% extends "base.html" %}

{% block content %}

<!-- Main 1:2 Split Layout -->
<div class="flex gap-4 h-[calc(100vh-140px)]">

    <!-- LEFT: File Explorer (1/3) -->
    <div class="w-1/3 flex flex-col bg-gray-900 rounded-xl border border-gray-700 overflow-hidden">
        <!-- Explorer Header -->
        <div class="flex items-center justify-between px-3 py-2 bg-gray-800 border-b border-gray-700">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
                ğŸ“ ëŒ€ë³¸ íƒìƒ‰ê¸°
            </h3>
            <div class="flex gap-1">
                <button onclick="createNewFolder()"
                    class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded transition-colors"
                    title="ìƒˆ í´ë”">
                    ğŸ“+
                </button>
                <button onclick="refreshExplorer()"
                    class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded transition-colors"
                    title="ìƒˆë¡œê³ ì¹¨">
                    ğŸ”„
                </button>
            </div>
        </div>

        <!-- Explorer Tree -->
        <div id="explorerTree" class="flex-1 overflow-y-auto p-2 custom-scrollbar">
            <div class="text-center py-10 text-gray-500 text-sm">
                ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>
    </div>

    <!-- RIGHT: Content Area (2/3) -->
    <div class="w-2/3 flex flex-col overflow-hidden">

        <!-- Tab Bar -->
        <div class="flex gap-1 bg-gray-800 rounded-t-xl p-1.5 border-b border-gray-700">
            <button onclick="setScriptMode('ai')" id="tabAI"
                class="px-4 py-2 rounded-lg text-xs font-bold transition-all bg-gray-700 text-white">
                ğŸ¤– AI ìë™ ìƒì„±
            </button>
            <button onclick="setScriptMode('manual')" id="tabManual"
                class="px-4 py-2 rounded-lg text-xs font-medium text-gray-400 hover:text-gray-200">
                ğŸ“ ì§ì ‘ ì…ë ¥
            </button>
            <div class="flex-1"></div>
            <span id="currentFileIndicator" class="text-xs text-gray-500 self-center px-2">ìƒˆ ëŒ€ë³¸</span>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto bg-gray-900/50 rounded-b-xl p-4 custom-scrollbar">

            <!-- AI Generation Mode -->
            <div id="aiGenSection">
                <!-- Topic & Structure Info -->
                <div id="analysisInfo" class="card mb-4 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-white">ğŸ“‹ ëŒ€ë³¸ êµ¬ì¡° ê¸°ë°˜</h3>
                        <button onclick="window.location.href='/script-plan'"
                            class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-gray-300 transition-colors">
                            ğŸ”„ êµ¬ì¡° ë‹¤ì‹œ ì§œê¸°
                        </button>
                    </div>
                    <input type="text" id="structureTopic" class="input-field text-sm" placeholder="ì˜ìƒ ì£¼ì œ">
                </div>


                <!-- Options Panel removed as per user request -->

                <!-- Generate Button -->
                <div class="flex justify-end gap-2 mb-4">
                    <button onclick="stopAndSave()" id="stopBtn"
                        class="hidden btn-secondary bg-red-900/50 text-red-400 py-2 px-4 rounded-lg text-sm">
                        â¹ï¸ ë©ˆì¶¤ & ì €ì¥
                    </button>
                    <button onclick="generateScript()" id="generateBtn"
                        class="btn-primary py-2.5 px-6 rounded-lg text-sm font-bold">
                        âœï¸ ëŒ€ë³¸ ìƒì„± ì‹œì‘
                    </button>
                </div>

                <!-- AI Data Preview (Collapsed) -->
                <details class="bg-gray-900 rounded-lg p-2 border border-gray-700 mb-4">
                    <summary class="text-xs text-blue-400 cursor-pointer">ğŸ” AI ì „ë‹¬ ë°ì´í„° í™•ì¸</summary>
                    <pre id="previewContent"
                        class="mt-2 text-[10px] text-gray-400 font-mono whitespace-pre-wrap max-h-40 overflow-auto">(ë°ì´í„° ë¡œë”© ì¤‘...)</pre>
                </details>
            </div>

            <!-- Manual Input Mode (Hidden by default) -->
            <div id="manualInputSection" class="hidden">
                <div class="bg-yellow-900/20 border border-yellow-800 rounded-lg p-4 mb-4">
                    <h3 class="text-sm font-bold text-white mb-2">ğŸ“ ì™¸ë¶€ ëŒ€ë³¸ ë¶™ì—¬ë„£ê¸°</h3>
                    <p class="text-xs text-gray-400 mb-3">AI ìƒì„±ì„ ê±´ë„ˆë›°ê³  ì¤€ë¹„ëœ ëŒ€ë³¸ì„ ë°”ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
                    <textarea id="manualScriptInput" class="input-field font-mono text-sm" rows="10"
                        placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                </div>
                <div class="flex justify-end">
                    <button onclick="registerManualScript()" class="btn-primary py-2 px-6 rounded-lg text-sm font-bold">
                        ğŸ’¾ ì‘ì„± ì™„ë£Œ
                    </button>
                </div>
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="hidden">
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-white">ğŸ“ ìƒì„±ëœ ëŒ€ë³¸</h3>
                        <div class="flex gap-2">
                            <button onclick="translateScript()" id="translateBtn"
                                class="btn-secondary text-xs hidden">ğŸŒ ë²ˆì—­</button>
                            <button onclick="copyScript()"
                                class="btn-primary text-xs flex items-center gap-1 bg-blue-600 hover:bg-blue-500 text-white px-3">
                                ğŸ“‹ <span class="font-bold">ì „ì²´ ë³µì‚¬</span>
                            </button>
                            <button onclick="saveCurrentScript()" class="btn-primary text-xs">ğŸ’¾ ì €ì¥</button>
                        </div>
                    </div>

                    <div class="flex gap-3 text-xs text-gray-400 mb-3">
                        <span id="charCount" class="bg-gray-700 px-2 py-0.5 rounded">0ì</span>
                        <span id="readTime" class="bg-gray-700 px-2 py-0.5 rounded">ì½ê¸° ì‹œê°„: 0ë¶„</span>
                    </div>

                    <textarea id="scriptContent" class="input-field font-mono text-sm" rows="15"></textarea>

                    <div class="flex justify-center gap-3 mt-4 pt-4 border-t border-gray-700">
                        <button onclick="goToImageGen()" class="btn-primary py-2 px-4 rounded-lg text-sm">
                            ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± â†’
                        </button>
                        <button onclick="goToTTS()" class="btn-secondary py-2 px-4 rounded-lg text-sm">
                            ğŸ”Š TTS ìƒì„± â†’
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Folder Creation Modal -->
<div id="folderModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-80 border border-gray-600">
        <h3 class="text-lg font-bold text-white mb-4">ğŸ“ ìƒˆ í´ë” ë§Œë“¤ê¸°</h3>
        <input type="text" id="newFolderName" class="input-field w-full mb-4" placeholder="í´ë” ì´ë¦„">
        <div class="flex gap-2 justify-end">
            <button onclick="closeFolderModal()" class="btn-secondary py-2 px-4 text-sm">ì·¨ì†Œ</button>
            <button onclick="confirmCreateFolder()" class="btn-primary py-2 px-4 text-sm">ìƒì„±</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentScript = '';
    let currentFileId = null;
    let explorerData = { folders: [], files: [] };

    // ========== EXPLORER FUNCTIONS ==========

    async function refreshExplorer() {
        const container = document.getElementById('explorerTree');
        container.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        try {
            // Load folders from localStorage (simple approach)
            const savedFolders = JSON.parse(localStorage.getItem('scriptFolders') || '[]');

            // Load ALL projects (not just those with scripts)
            const data = await API.project.list();
            const projects = data.projects || [];

            // Filter to only show projects with script planning done (status !== 'created')
            // Status progression: created -> structured -> scripted -> image_prompted -> completed
            const plannedProjects = projects.filter(p =>
                p.status && p.status !== 'created' && p.status !== ''
            );

            // Show planned projects in the explorer
            const allProjectFiles = plannedProjects.map(p => ({
                id: p.id,
                name: p.name,
                topic: p.topic,
                status: p.status,
                hasScript: p.status === 'scripted' || p.status === 'image_prompted' || p.status === 'completed',
                hasStructure: p.status === 'structured' || p.status === 'scripted' || p.status === 'image_prompted' || p.status === 'completed',
                folderId: localStorage.getItem(`script_folder_${p.id}`) || null
            }));

            explorerData.folders = savedFolders;
            explorerData.files = allProjectFiles;

            renderExplorer();
        } catch (e) {
            console.error('Explorer load failed:', e);
            container.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
        }
    }

    function renderExplorer() {
        const container = document.getElementById('explorerTree');

        if (explorerData.folders.length === 0 && explorerData.files.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 text-gray-500">
                    <div class="text-3xl mb-2">ğŸ“­</div>
                    <p class="text-sm">ì €ì¥ëœ ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    <p class="text-xs mt-1 text-gray-600">AIë¡œ ëŒ€ë³¸ì„ ìƒì„±í•´ë³´ì„¸ìš”</p>
                </div>
            `;
            return;
        }

        let html = '';

        // Render folders
        explorerData.folders.forEach(folder => {
            const filesInFolder = explorerData.files.filter(f => f.folderId === folder.id);
            html += `
                <div class="folder-item mb-1"
                     ondragover="event.preventDefault(); event.currentTarget.classList.add('bg-yellow-900/30');"
                     ondragleave="event.currentTarget.classList.remove('bg-yellow-900/30');"
                     ondrop="dropFileToFolder(event, '${folder.id}')">
                    <div class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-gray-800 cursor-pointer group" 
                         onclick="toggleFolder('${folder.id}')">
                        <span class="text-yellow-500" id="folderIcon_${folder.id}">ğŸ“</span>
                        <span class="text-sm text-gray-300 flex-1" ondblclick="event.stopPropagation(); renameFolder('${folder.id}')">${folder.name}</span>
                        <span class="text-xs text-gray-600">${filesInFolder.length}</span>
                        <button onclick="event.stopPropagation(); deleteFolder('${folder.id}')" 
                                class="opacity-0 group-hover:opacity-100 text-xs text-red-400 hover:text-red-300">âœ•</button>
                    </div>
                    <div id="folderContent_${folder.id}" class="hidden pl-4">
                        ${filesInFolder.map(f => renderFileItem(f)).join('')}
                    </div>
                </div>
            `;
        });

        // Render files without folder (root level)
        const rootFiles = explorerData.files.filter(f => !f.folderId);
        rootFiles.forEach(f => {
            html += renderFileItem(f);
        });

        container.innerHTML = html;
    }

    function renderFileItem(file) {
        const isActive = currentFileId === file.id;

        // Determine status display
        let statusIcon, statusColor, statusText;
        if (file.hasScript) {
            statusIcon = 'ğŸ“„';
            statusColor = 'text-green-400';
            statusText = 'ëŒ€ë³¸ìˆìŒ';
        } else if (file.hasStructure) {
            statusIcon = 'ğŸ“‹';
            statusColor = 'text-yellow-400';
            statusText = 'ê¸°íšì™„ë£Œ';
        } else {
            statusIcon = 'ğŸ“';
            statusColor = 'text-gray-500';
            statusText = 'ê¸°íšì¤‘';
        }

        return `
        <div id="fileItem_${file.id}" class="file-item flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer group transition-colors
                        ${isActive ? 'bg-blue-900/50 border border-blue-700' : 'hover:bg-gray-800'}"
            onclick="selectFile('${file.id}')"
            ondblclick="openFile('${file.id}')"
            draggable="true"
            ondragstart="dragFile(event, '${file.id}')">
            <span class="${statusColor}">${statusIcon}</span>
            <div class="flex-1 min-w-0">
                <p class="text-sm text-gray-200 truncate select-none">${file.name}</p>
                <p class="text-[10px] text-gray-500 truncate select-none">${file.topic || 'ì£¼ì œ ì—†ìŒ'}</p>
            </div>
            <span class="text-[10px] ${statusColor} select-none">${statusText}</span>
            <button onclick="event.stopPropagation(); deleteProject(${file.id}, '${file.name.replace(/'/g, "\\'")}')"
                        class="opacity-0 group-hover:opacity-100 text-xs text-red-400 hover:text-red-300 ml-1" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            </div >
            `;
    }

    function selectFile(fileId) {
        currentFileId = fileId;

        // Remove active class from all items
        document.querySelectorAll('.file-item').forEach(el => {
            el.classList.remove('bg-blue-900/50', 'border', 'border-blue-700');
            el.classList.add('hover:bg-gray-800');
        });

        // Add active class to selected item
        const selected = document.getElementById(`fileItem_${fileId}`);
        if (selected) {
            selected.classList.remove('hover:bg-gray-800');
            selected.classList.add('bg-blue-900/50', 'border', 'border-blue-700');
        }
    }

    function toggleFolder(folderId) {
        const content = document.getElementById(`folderContent_${folderId}`);
        const icon = document.getElementById(`folderIcon_${folderId}`);
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = 'ğŸ“‚';
        } else {
            content.classList.add('hidden');
            icon.textContent = 'ğŸ“';
        }
    }

    async function openFile(projectId) {
        console.log("openFile called with:", projectId);
        try {
            currentFileId = projectId;
            setCurrentProject(projectId);

            const full = await API.project.getFull(projectId);

            // Always prepare to show the editor
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('currentFileIndicator').textContent = full?.project?.name || 'ëŒ€ë³¸';

            console.log("Full Data loaded:", full);

            let scriptContent = '';
            if (full && full.script) {
                console.log("Script Data Structure:", full.script); // For debugging
                if (typeof full.script === 'string') {
                    scriptContent = full.script;
                } else {
                    // Try all possible keys including camelCase and common names
                    scriptContent = full.script.full_script ||
                        full.script.script ||
                        full.script.content ||
                        full.script.fullScript ||
                        full.script.text ||
                        full.script.body ||
                        '';
                }
            }

            currentScript = scriptContent;
            document.getElementById('scriptContent').value = currentScript;

            if (scriptContent) {
                Utils.showToast(`"${full.project?.name}" ëŒ€ë³¸ ì—´ë¦¼`, 'success');
            } else {
                // REVERTED TO FULL DUMP TO CHECK DEBUG KEY
                console.warn("Script loading failed, dumping FULL object");

                // Check if our debug key exists
                const hasDebugKey = full && full.debug_script_chk;
                let debugMsg = "=== DEBUG MODE: FULL DATA DUMP ===\n";
                if (hasDebugKey) {
                    debugMsg += `[FOUND TRACKING TAG] status: ${full.debug_script_chk.status}, has_script: ${full.debug_script_chk.has_script}\n`;
                } else {
                    debugMsg += "[WARNING] TRACKING TAG NOT FOUND (Server code might be outdated)\n";
                }

                scriptContent = debugMsg + JSON.stringify(full, null, 2);
                document.getElementById('scriptContent').value = scriptContent;

                Utils.showToast('ë””ë²„ê·¸ ëª¨ë“œ: ì „ì²´ êµ¬ì¡° í™•ì¸ (ìº¡ì²˜í•´ì£¼ì„¸ìš”)', 'warning');
            }

            updateStats();

            // Update structure data if exists
            if (full && full.script_structure) {
                Utils.storage.set('scriptStructure', full.script_structure);
                document.getElementById('analysisInfo').classList.remove('hidden');
                document.getElementById('structureTopic').value = full.project?.topic || '';
            } else {
                document.getElementById('analysisInfo').classList.add('hidden');
            }

            renderExplorer(); // Refresh to show active state

        } catch (e) {
            console.error(e);
            Utils.showToast('íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨', 'error');
        }
    }

    // ========== FOLDER MANAGEMENT ==========

    function createNewFolder() {
        document.getElementById('folderModal').classList.remove('hidden');
        document.getElementById('folderModal').classList.add('flex');
        document.getElementById('newFolderName').focus();
    }

    function closeFolderModal() {
        document.getElementById('folderModal').classList.add('hidden');
        document.getElementById('folderModal').classList.remove('flex');
        document.getElementById('newFolderName').value = '';
    }

    function confirmCreateFolder() {
        const name = document.getElementById('newFolderName').value.trim();
        if (!name) {
            Utils.showToast('í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const folders = JSON.parse(localStorage.getItem('scriptFolders') || '[]');
        folders.push({
            id: 'folder_' + Date.now(),
            name: name,
            created: new Date().toISOString()
        });
        localStorage.setItem('scriptFolders', JSON.stringify(folders));

        closeFolderModal();
        refreshExplorer();
        Utils.showToast(`í´ë” "${name}" ìƒì„±ë¨`, 'success');
    }

    function renameFolder(folderId) {
        const newName = prompt('ìƒˆ í´ë” ì´ë¦„:');
        if (!newName) return;

        const folders = JSON.parse(localStorage.getItem('scriptFolders') || '[]');
        const folder = folders.find(f => f.id === folderId);
        if (folder) {
            folder.name = newName;
            localStorage.setItem('scriptFolders', JSON.stringify(folders));
            refreshExplorer();
            Utils.showToast('ì´ë¦„ ë³€ê²½ë¨', 'success');
        }
    }

    function deleteFolder(folderId) {
        if (!confirm('ì´ í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒŒì¼ì€ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

        let folders = JSON.parse(localStorage.getItem('scriptFolders') || '[]');
        folders = folders.filter(f => f.id !== folderId);
        localStorage.setItem('scriptFolders', JSON.stringify(folders));

        // Move files to root
        explorerData.files.forEach(f => {
            if (f.folderId === folderId) {
                localStorage.removeItem(`script_folder_${f.id} `);
            }
        });

        refreshExplorer();
        Utils.showToast('í´ë” ì‚­ì œë¨', 'success');
    }

    // Drag & Drop
    function dragFile(event, fileId) {
        event.dataTransfer.setData('fileId', fileId);
    }

    function dropFileToFolder(event, folderId) {
        event.preventDefault();
        event.currentTarget.classList.remove('bg-yellow-900/30');

        const fileId = event.dataTransfer.getData('fileId');
        if (!fileId) return;

        // Save folder assignment to localStorage
        localStorage.setItem(`script_folder_${fileId} `, folderId);

        // Update local data
        const file = explorerData.files.find(f => f.id == fileId);
        if (file) {
            file.folderId = folderId;
        }

        renderExplorer();
        Utils.showToast('íŒŒì¼ì´ í´ë”ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // Remove file from folder (move to root)
    function removeFromFolder(fileId) {
        localStorage.removeItem(`script_folder_${fileId} `);
        const file = explorerData.files.find(f => f.id == fileId);
        if (file) {
            file.folderId = null;
        }
        renderExplorer();
        Utils.showToast('í´ë”ì—ì„œ ì œê±°ë¨', 'info');
    }

    // Delete project
    async function deleteProject(projectId, projectName) {
        if (!confirm(`"${projectName}" í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
            return;
        }

        try {
            const response = await fetch(`/ api / projects / ${projectId} `, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Remove from local storage
                localStorage.removeItem(`script_folder_${projectId} `);

                // Update explorer
                explorerData.files = explorerData.files.filter(f => f.id !== projectId);
                renderExplorer();

                // Clear editor if this was the active file
                if (currentFileId === projectId) {
                    currentFileId = null;
                    document.getElementById('scriptContent').value = '';
                    document.getElementById('resultSection').classList.add('hidden');
                    document.getElementById('currentFileIndicator').textContent = 'ìƒˆ ëŒ€ë³¸';
                }

                Utils.showToast(`"${projectName}" ì‚­ì œë¨`, 'success');
            } else {
                throw new Error('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (e) {
            console.error('Delete error:', e);
            Utils.showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    // ========== SCRIPT FUNCTIONS ==========

    function setScriptMode(mode) {
        const tabAI = document.getElementById('tabAI');
        const tabManual = document.getElementById('tabManual');
        const sectionAI = document.getElementById('aiGenSection');
        const sectionManual = document.getElementById('manualInputSection');

        if (mode === 'ai') {
            tabAI.classList.add('bg-gray-700', 'text-white', 'font-bold');
            tabAI.classList.remove('text-gray-400');
            tabManual.classList.remove('bg-gray-700', 'text-white', 'font-bold');
            tabManual.classList.add('text-gray-400');
            sectionAI.classList.remove('hidden');
            sectionManual.classList.add('hidden');
        } else {
            tabManual.classList.add('bg-gray-700', 'text-white', 'font-bold');
            tabManual.classList.remove('text-gray-400');
            tabAI.classList.remove('bg-gray-700', 'text-white', 'font-bold');
            tabAI.classList.add('text-gray-400');
            sectionAI.classList.add('hidden');
            sectionManual.classList.remove('hidden');
        }
    }

    async function saveCurrentScript() {
        const projectId = getCurrentProject();
        const script = document.getElementById('scriptContent').value;

        if (!script.trim()) {
            Utils.showToast('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        try {
            const charCount = script.length;
            const readTime = Math.ceil(charCount / 415);
            await API.project.saveScript(projectId, script, charCount, readTime);
            Utils.showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            refreshExplorer();
        } catch (e) {
            console.error(e);
            Utils.showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
        }
    }

    function updateStats() {
        const text = document.getElementById('scriptContent').value;
        const charCount = text.length;
        const readTime = Math.ceil(charCount / 415);

        document.getElementById('charCount').textContent = `${charCount.toLocaleString()} ì`;
        document.getElementById('readTime').textContent = `ì½ê¸° ì‹œê°„: ${readTime} ë¶„`;
    }

    document.getElementById('scriptContent')?.addEventListener('input', updateStats);

    function copyScript() {
        const text = document.getElementById('scriptContent').value;
        if (!text) {
            Utils.showToast('ë³µì‚¬í•  ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }
        Utils.copyToClipboard(text);
        Utils.showToast('ëŒ€ë³¸ ì „ì²´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹', 'success');
    }

    function goToImageGen() { window.location.href = '/image-gen'; }
    function goToTTS() { window.location.href = '/tts'; }

    // ========== INITIALIZATION ==========

    document.addEventListener('DOMContentLoaded', async () => {
        // Load explorer
        await refreshExplorer();

        // Load structure data
        const projectId = getCurrentProject();
        if (projectId) {
            try {
                const projectFull = await API.project.getFull(projectId);
                if (projectFull && projectFull.script_structure) {
                    Utils.storage.set('scriptStructure', projectFull.script_structure);
                    document.getElementById('analysisInfo').classList.remove('hidden');
                    document.getElementById('structureTopic').value = projectFull.project?.topic || '';

                    const styleCode = projectFull.script_structure.script_style || 'news';
                    document.getElementById('scriptStyle').value = styleCode;
                    document.getElementById('scriptStyleDisplay').value = styleCode;
                }

                if (projectFull && projectFull.script && projectFull.script.full_script) {
                    currentScript = projectFull.script.full_script;
                    currentFileId = projectId;
                    document.getElementById('scriptContent').value = currentScript;
                    document.getElementById('resultSection').classList.remove('hidden');
                    document.getElementById('currentFileIndicator').textContent = projectFull.project?.name || 'ëŒ€ë³¸';
                    updateStats();
                }
            } catch (e) {
                console.error(e);
            }
        }
    });

    // ========== GENERATION ==========

    async function generateScript() {
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        // Try to get structure data from storage or fetch from server
        let structureData = Utils.storage.get('scriptStructure');

        if (!structureData || !structureData.sections || structureData.sections.length === 0) {
            console.log("No local structure, fetching from server...");
            try {
                const projectFull = await API.project.getFull(projectId);
                if (projectFull && projectFull.script_structure) {
                    structureData = projectFull.script_structure;
                    Utils.storage.set('scriptStructure', structureData);
                }
            } catch (e) {
                console.error("Failed to fetch structure:", e);
            }
        }

        if (!structureData || !structureData.sections || structureData.sections.length === 0) {
            Utils.showToast('ëŒ€ë³¸ êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. "ëŒ€ë³¸ ê¸°íš" ë‹¨ê³„ë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const btn = document.getElementById('generateBtn');
        const stopBtn = document.getElementById('stopBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤€ë¹„ ì¤‘...');
        stopBtn.classList.remove('hidden');
        window.stopGeneration = false;

        const sections = structureData.sections;
        const topic = document.getElementById('structureTopic')?.value || structureData.topic || 'ì˜ìƒ';
        let finalScript = '';

        console.log(`Starting generation: ${sections.length} sections`);

        try {
            for (let i = 0; i < sections.length; i++) {
                if (window.stopGeneration) {
                    console.log("Stopped by user");
                    Utils.showToast('ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë¨', 'warning');
                    break;
                }

                const section = sections[i];
                const keyPoints = section.key_points || [];
                Utils.setLoading(btn, true, `ìƒì„± ì¤‘... (${i + 1}/${sections.length}: ${section.title})`);
                console.log(`Generating section ${i + 1}: ${section.title} `);

                const prompt = `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤.ì•„ë˜ ì£¼ì œì— ëŒ€í•œ "${section.title}" íŒŒíŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì˜ìƒ ì£¼ì œ]
${topic}

        [í˜„ì¬ ì„¹ì…˜]
            - ì œëª©: ${section.title}
        - ì£¼ìš” ë‚´ìš©: ${keyPoints.length > 0 ? keyPoints.join(', ') : 'ììœ ë¡­ê²Œ ì‘ì„±'}

        [ì‘ì„± ì§€ì¹¨]
        1. ìì—°ìŠ¤ëŸ½ê³  ëª°ì…ê° ìˆëŠ” í•œêµ­ì–´ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”.
2. ì„¹ì…˜ ì œëª©ì€ ì¶œë ¥í•˜ì§€ ë§ê³ , ë³¸ë¬¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.
3. ì•½ 500~800ì ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.

ë³¸ë¬¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”: `;

                try {
                    const result = await API.gemini.generate(prompt, { temperature: 0.7, maxTokens: 2048 });
                    console.log(`Section ${i + 1} result: `, result.status);

                    if (result.status === 'ok' && result.text) {
                        finalScript += `\n\n ** [${section.title}] **\n${result.text.trim()} `;
                    } else {
                        finalScript += `\n\n ** [${section.title}] **\n(ì´ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}) \n`;
                    }
                } catch (sectionErr) {
                    console.error(`Section ${i + 1} error: `, sectionErr);
                    finalScript += `\n\n ** [${section.title}] **\n(ìƒì„± ì˜¤ë¥˜: ${sectionErr.message}) \n`;
                }

                // Show progress
                document.getElementById('scriptContent').value = finalScript.trim();
                document.getElementById('resultSection').classList.remove('hidden');
                updateStats();

                // Small delay between sections to avoid rate limiting
                if (i < sections.length - 1 && !window.stopGeneration) {
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            currentScript = finalScript.trim();

            // Save to DB
            if (currentScript) {
                const charCount = currentScript.length;
                const readTime = Math.ceil(charCount / 415);
                await API.project.saveScript(projectId, currentScript, charCount, readTime);
                console.log("Script saved to DB");
            }

            Utils.showToast('ëŒ€ë³¸ ìƒì„± ì™„ë£Œ!', 'success');
            refreshExplorer();

        } catch (e) {
            console.error('Generation error:', e);
            Utils.showToast('ìƒì„± ì˜¤ë¥˜: ' + e.message, 'error');
        } finally {
            Utils.setLoading(btn, false);
            stopBtn.classList.add('hidden');
            window.stopGeneration = false;
        }
    }

    function stopAndSave() {
        window.stopGeneration = true;
        Utils.showToast('ìƒì„± ì¤‘ë‹¨ë¨', 'warning');
    }

    async function registerManualScript() {
        const text = document.getElementById('manualScriptInput').value.trim();
        if (!text) {
            Utils.showToast('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const projectId = getCurrentProject();
        currentScript = text;
        document.getElementById('scriptContent').value = text;
        document.getElementById('resultSection').classList.remove('hidden');
        updateStats();

        if (projectId) {
            try {
                await API.project.saveScript(projectId, text, text.length, Math.ceil(text.length / 415));
                Utils.showToast('ëŒ€ë³¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                refreshExplorer();
            } catch (e) {
                console.error(e);
            }
        }
    }
</script>
{% endblock %}