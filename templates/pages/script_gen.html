{% extends "base.html" %}

{% block content %}


<!-- Flex Container -->
<div class="flex flex-col lg:flex-row gap-6 section-spacing">

    <!-- Left Column: Context (Topic & Data) -->
    <div class="w-full lg:w-1/3 space-y-4">
        <!-- ë¶„ì„ ë°ì´í„° í‘œì‹œ -->
        <div id="analysisInfo" class="card hidden">
            <div class="flex justify-between items-center mb-2">
                <h3 class="card-title mb-0">ğŸ“‹ ëŒ€ë³¸ êµ¬ì¡° ê¸°ë°˜</h3>
                <button onclick="window.location.href='/script-plan'"
                    class="text-xs bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-2 py-1 rounded text-gray-700 dark:text-gray-300 transition-colors">
                    ğŸ”„ êµ¬ì¡° ë‹¤ì‹œ ì§œê¸°
                </button>
            </div>
            <input type="text" id="structureTopic" class="input-field mt-1 text-sm" placeholder="ì˜ìƒ ì£¼ì œ">
            <p class="text-xs text-gray-500 mt-2 leading-relaxed">
                ğŸ’¡ ì£¼ì œê°€ ë‹¤ë¥´ë‹¤ë©´ ì§ì ‘ ìˆ˜ì •í•´ì£¼ì„¸ìš”. AIëŠ” ì´ ì£¼ì œë¥¼ ë°”íƒ•ìœ¼ë¡œ ëŒ€ë³¸ì„ ì‘ì„±í•©ë‹ˆë‹¤.
            </p>
        </div>

        <!-- Structure Data Preview (Collapsed) -->
        <details class="bg-gray-900 rounded-lg p-2 border border-gray-700">
            <summary
                class="text-xs font-medium text-blue-400 cursor-pointer select-none hover:text-blue-300 transition-colors">
                ğŸ” AI ì „ë‹¬ ë°ì´í„° í™•ì¸í•˜ê¸°
            </summary>
            <pre id="previewContent"
                class="mt-2 text-[10px] text-gray-400 font-mono whitespace-pre-wrap overflow-x-auto max-h-60 p-2 bg-black/50 rounded border border-gray-800">(ë°ì´í„° ë¡œë”© ì¤‘...)</pre>
        </details>
    </div>

    <!-- Right Column: Actions (Tabs & Generation) -->
    <div class="w-full lg:w-2/3 flex-1">

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="flex mb-4 border-b border-gray-200 dark:border-gray-700">
            <button onclick="setScriptMode('ai')" id="tabAI"
                class="px-6 py-3 font-bold border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 transition-all text-sm">
                ğŸ¤– AI ìë™ ìƒì„±
            </button>
            <button onclick="setScriptMode('manual')" id="tabManual"
                class="px-6 py-3 font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-all text-sm">
                ğŸ“ ì§ì ‘ ì…ë ¥
            </button>
        </div>

        <!-- AI ìƒì„± ëª¨ë“œ -->
        <div id="aiGenSection">
            <!-- ì˜µì…˜ íŒ¨ë„ -->
            <div
                class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
                <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                    âš™ï¸ ëŒ€ë³¸ ì˜µì…˜ ì„¤ì •
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label
                            class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">ìŠ¤íƒ€ì¼</label>
                        <input type="text" id="scriptStyleDisplay"
                            class="input-field bg-gray-50 text-gray-700 cursor-not-allowed dark:bg-gray-900 dark:text-gray-300 text-sm py-2 font-medium"
                            readonly value="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...">
                        <input type="hidden" id="scriptStyle" value="news">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">í¬í•¨
                            ìš”ì†Œ</label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <div class="relative flex items-center">
                                    <input type="checkbox" id="includeHooks" checked
                                        class="peer h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 transition-all">
                                </div>
                                <span
                                    class="text-sm text-gray-700 dark:text-gray-300 group-hover:text-blue-500 transition-colors">í›„í‚¹
                                    ë©˜íŠ¸</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <div class="relative flex items-center">
                                    <input type="checkbox" id="includeCTA" checked
                                        class="peer h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 transition-all">
                                </div>
                                <span
                                    class="text-sm text-gray-700 dark:text-gray-300 group-hover:text-blue-500 transition-colors">CTA</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìƒì„± ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="flex justify-end gap-3">
                <button onclick="stopAndSave()" id="stopBtn"
                    class="hidden btn-secondary bg-red-50 text-red-600 hover:bg-red-100 py-2.5 px-4 rounded-lg flex items-center gap-2 text-sm font-medium transition-colors">
                    <span>â¹ï¸</span>
                    <span>ë©ˆì¶¤ & ì €ì¥</span>
                </button>
                <button onclick="generateScript()" id="generateBtn"
                    class="btn-primary py-2.5 px-6 rounded-lg flex items-center gap-2 text-sm font-semibold shadow-sm hover:shadow-md transition-all">
                    <span>âœï¸</span>
                    <span>ëŒ€ë³¸ ìƒì„± ì‹œì‘</span>
                </button>
            </div>
        </div>

        <!-- ì§ì ‘ ì…ë ¥ ëª¨ë“œ -->
        <div id="manualInputSection" class="hidden">
            <div
                class="bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/30 rounded-xl p-5 mb-4">
                <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2">ğŸ“ ì™¸ë¶€ ëŒ€ë³¸ ë¶™ì—¬ë„£ê¸°</h3>
                <p class="text-xs text-gray-600 dark:text-gray-400 mb-4 leading-relaxed">
                    AI ìƒì„±ì„ ê±´ë„ˆë›°ê³  ì¤€ë¹„ëœ ëŒ€ë³¸ì„ ë°”ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                </p>
                <textarea id="manualScriptInput" class="input-field font-mono text-sm leading-relaxed" rows="12"
                    placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            </div>

            <div class="flex justify-end">
                <button onclick="registerManualScript()"
                    class="btn-primary py-2.5 px-6 rounded-lg flex items-center gap-2 text-sm font-semibold shadow-sm hover:shadow-md transition-all">
                    <span>ğŸ’¾</span>
                    <span>ì‘ì„± ì™„ë£Œ</span>
                </button>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>

<!-- ê²°ê³¼ ì˜ì—­ -->
<div id="resultSection" class="hidden">
    <div class="card container-lg section-spacing">
        <div class="flex items-center justify-between mb-4">
            <h3 class="card-title mb-0">ğŸ“ ìƒì„±ëœ ëŒ€ë³¸</h3>
            <div class="btn-group">
                <button onclick="translateScript()" id="translateBtn" class="btn-secondary hidden">ğŸŒ ë²ˆì—­í•˜ê¸°</button>
                <button onclick="copyScript()" class="btn-secondary">ğŸ“‹ ë³µì‚¬</button>
                <button onclick="downloadScript()" class="btn-secondary">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <div class="mb-4 flex gap-4 text-sm text-gray-500">
            <span id="charCount" class="badge badge-primary">0ì</span>
            <span id="readTime" class="badge badge-primary">ì˜ˆìƒ ì½ê¸° ì‹œê°„: 0ë¶„</span>
        </div>

        <textarea id="scriptContent" class="input-field font-mono" rows="20"></textarea>

        <div class="btn-group btn-group-center mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <button onclick="goToImageGen()" class="btn-primary" style="min-width: 200px;">
                <span>ğŸ–¼ï¸</span>
                <span>ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„±</span>
                <span>â†’</span>
            </button>
            <button onclick="goToTTS()" class="btn-secondary" style="min-width: 200px;">
                <span>ğŸ”Š</span>
                <span>TTS ìƒì„±</span>
                <span>â†’</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentScript = '';

    // [NEW] Global App Mode
    window.APP_MODE = 'longform';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë”©
    document.addEventListener('DOMContentLoaded', async () => {
        // 0. App Mode Check
        try {
            const res = await fetch('/api/settings');
            const settings = await res.json();
            window.APP_MODE = settings.app_mode || 'longform';
            console.log("App Mode:", window.APP_MODE);

            // UI Indication
            if (window.APP_MODE === 'shorts') {
                const tabContainer = document.querySelector('.flex.mb-4.border-b');
                if (tabContainer) {
                    const badge = document.createElement('span');
                    badge.className = "ml-auto text-xs px-3 py-1 bg-purple-100 text-purple-700 font-bold rounded-full flex items-center";
                    badge.innerText = "ğŸ“± ì‡¼ì¸  ëª¨ë“œ";
                    tabContainer.appendChild(badge);
                }
            }
        } catch (e) { console.error(e); }

        const projectId = getCurrentProject();
        console.log("Current Project ID:", projectId);

        // 1. í”„ë¦¬ë·° ì´ˆê¸°í™”
        const previewEl = document.getElementById('previewContent');
        if (previewEl) previewEl.textContent = "ë°ì´í„° ë¡œë”© ì¤‘...";

        // 2. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¡œì»¬ -> ì„œë²„)
        let structureData = Utils.storage.get('scriptStructure');

        // [ì¤‘ìš”] í”„ë¡œì íŠ¸ ID ë¶ˆì¼ì¹˜ ì‹œ ë°ì´í„°ë¥¼ íê¸°í•˜ê³  ì„œë²„ì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜´
        if (structureData && structureData.project_id && structureData.project_id != projectId) {
            console.log("Mismatching validation: Storage ID", structureData.project_id, "Current ID", projectId);
            structureData = null; // Force reload
            Utils.storage.remove('scriptStructure');
        }

        if (!structureData && projectId) {
            try {
                // ì„œë²„ì—ì„œ ì¡°íšŒ
                const projectFull = await API.project.getFull(projectId);
                console.log("Projects Full Data:", projectFull);

                if (projectFull && projectFull.script_structure) {
                    structureData = projectFull.script_structure;
                    // topicì´ í•„ìš”í•˜ë©´ projectFull.project.topic ë˜ëŠ” script_structure ë‚´ë¶€ í™•ì¸
                    if (!structureData.topic && projectFull.project) {
                        structureData.topic = projectFull.project.topic || projectFull.project.name;
                    }

                    // project_idê°€ ì—†ìœ¼ë©´ ì£¼ì… (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²€ì¦ìš©)
                    if (!structureData.project_id) {
                        structureData.project_id = projectId;
                    }

                    // [NEW] DB Settingsì—ì„œ ìŠ¤íƒ€ì¼ ê°€ì ¸ì˜¤ê¸° (Fallback)
                    if (projectFull.settings && projectFull.settings.script_style) {
                        structureData.script_style = projectFull.settings.script_style;
                    }

                    Utils.storage.set('scriptStructure', structureData);
                    Utils.showToast('ê¸°íš ë°ì´í„°ë¥¼ serverì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
                }
            } catch (e) {
                console.error("Failed to fetch project data:", e);
                if (previewEl) previewEl.textContent = "âŒ ì„œë²„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨";
            }
        }

        // 3. UI ì—…ë°ì´íŠ¸
        if (structureData) {
            const infoEl = document.getElementById('analysisInfo'); // Corrected ID from 'structureInfo' to 'analysisInfo'
            if (infoEl) infoEl.classList.remove('hidden');

            const topicEl = document.getElementById('structureTopic');
            const topic = structureData.topic || structureData.hook || 'ì£¼ì œ ë¯¸ìƒ';
            if (topicEl) topicEl.value = topic;

            if (previewEl) {
                previewEl.textContent = JSON.stringify(structureData, null, 2);
                previewEl.classList.remove('text-red-600');
            }

            // [NEW] Set Style Code and Display Name from Structure Data
            const styleCode = structureData.script_style || 'news';
            const styleEl = document.getElementById('scriptStyle');
            const displayEl = document.getElementById('scriptStyleDisplay');

            if (styleEl) styleEl.value = styleCode;

            const styleNames = {
                'story': 'ì˜›ë‚  ì´ì•¼ê¸° (Old Story)',
                'news': 'ë‰´ìŠ¤ ë³´ë„ (News Delivery)',
                'senior_story': 'ì‹œë‹ˆì–´ ì‚¬ì—° (Senior Story)',
                'narration': 'ë‚˜ë ˆì´ì…˜í˜• (ì„¤ëª… ìœ„ì£¼)',
                'conversational': 'ëŒ€í™”í˜• (ì¹œê·¼í•œ ë§íˆ¬)',
                'storytelling': 'ìŠ¤í† ë¦¬í…”ë§í˜• (ì´ì•¼ê¸° ì „ê°œ)'
            };
            if (displayEl) displayEl.value = styleNames[styleCode] || styleCode;

        } else {
            if (previewEl) {
                if (window.APP_MODE === 'shorts') {
                    // [NEW] Shorts Quick Start Button
                    previewEl.innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-yellow-500 font-bold mb-2">âš  êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <button onclick="window.location.href='/script-plan?mode=shorts&auto=true'" 
                                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-xs transition-colors shadow-lg animate-pulse">
                                âš¡ ì‡¼ì¸  ê¸°íš ë°”ë¡œ ì‹œì‘í•˜ê¸° (Auto)
                            </button>
                        </div>
                    `;
                    previewEl.classList.remove('text-red-600');
                } else {
                    previewEl.textContent = "âŒ êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤! ëŒ€ë³¸ ê¸°íš ë‹¨ê³„ ì™„ë£Œ ì—¬ë¶€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                    previewEl.classList.add('text-red-600', 'font-bold');
                }
            }
        }
    });

    async function generateScript() {
        const projectId = getCurrentProject();
        // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¡œì»¬ -> ì„œë²„)
        let structureData = Utils.storage.get('scriptStructure');

        // ë°ì´í„°ê°€ ì—†ê±°ë‚˜, í”„ë¡œì íŠ¸ IDê°€ ë‹¤ë¥´ë©´ ìƒˆë¡œê³ ì¹¨ ì‹œë„
        if (!structureData || (structureData.project_id && structureData.project_id != projectId)) {
            console.log("Refreshing data in generateScript due to mismatch or missing");
            try {
                const projectFull = await API.project.getFull(projectId);
                if (projectFull && projectFull.script_structure) {
                    structureData = projectFull.script_structure;
                    if (!structureData.topic && projectFull.project) {
                        structureData.topic = projectFull.project.topic || projectFull.project.name;
                    }
                    if (!structureData.project_id) structureData.project_id = projectId;

                    // [NEW] DB Settingsì—ì„œ ìŠ¤íƒ€ì¼ ê°€ì ¸ì˜¤ê¸° (Fallback)
                    if (projectFull.settings && projectFull.settings.script_style) {
                        structureData.script_style = projectFull.settings.script_style;
                    }
                    Utils.storage.set('scriptStructure', structureData);
                }
            } catch (e) { console.error(e); }
        }

        if (!structureData) {
            // [NEW] Shorts Auto Redirect Prompt
            if (window.APP_MODE === 'shorts') {
                if (confirm('ì‡¼ì¸  ëŒ€ë³¸ì„ ë§Œë“¤ê¸° ìœ„í•´ ê¸°íš ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.\nìë™ìœ¼ë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°íš í˜ì´ì§€ë¡œ ì´ë™)')) {
                    window.location.href = '/script-plan?mode=shorts&auto=true';
                    return;
                }
            }
            Utils.showToast('ëŒ€ë³¸ êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°íš ë‹¨ê³„ë¶€í„° ì§„í–‰í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // UI í”„ë¦¬ë·° ê°•ì œ ì—…ë°ì´íŠ¸ (ì‹±í¬ ë§ì¶”ê¸°)
        const previewEl = document.getElementById('previewContent');
        if (previewEl) previewEl.textContent = JSON.stringify(structureData, null, 2);

        // 2. êµ¬ì¡° ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ (ë²„ê·¸ ìˆ˜ì •)
        let structureText = '';
        if (typeof structureData === 'string') {
            structureText = structureData;
        } else if (typeof structureData === 'object') {
            // "structure" í‚¤ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì „ì²´ ê°ì²´ ë³€í™˜
            structureText = structureData.structure || JSON.stringify(structureData, null, 2);
        }

        // ì£¼ì œì •ë³´ ë³´ê°•
        const topic = document.getElementById('structureTopic').value || structureData.topic || structureData.hook || 'ìœ íŠœë¸Œ ì˜ìƒ';

        // ê¸¸ì´ ì •ë³´ ë³´ê°• (ê¸°ë³¸ê°’ 60ì´ˆ / ì‡¼ì¸ ëŠ” 30ì´ˆ)
        let duration = structureData.duration || 60;

        // [NEW] Shorts Mode Constraint
        if (window.APP_MODE === 'shorts') {
            duration = 30; // Default to 30s for shorts
            // ë§Œì•½ êµ¬ì¡° ë°ì´í„°ì— ëª…ì‹œëœ ê¸¸ì´ê°€ ìˆì–´ë„ ì‡¼ì¸ ë¼ë©´ 60ì´ˆ ë¯¸ë§Œìœ¼ë¡œ ê°•ì œ
            if (structureData.duration && structureData.duration > 60) {
                console.warn("Override duration for shorts mode to 59s");
                duration = 59;
            }
        }

        // í•œêµ­ì–´ ë§í•˜ê¸° ì†ë„: ì´ˆë‹¹ ì•½ 2.5~3ìŒì ˆ (ì—¬ìœ ìˆê²Œ ê³„ì‚°)
        // 30ì´ˆ -> 90~120ì, 60ì´ˆ -> 200~250ì
        // ë„ˆë¬´ ì§§ìœ¼ë©´ AIê°€ ë‚´ìš©ì„ ëª» ì±„ìš°ë¯€ë¡œ ì´ˆë‹¹ 4.5ì ì •ë„ë¡œ ë„‰ë„‰íˆ ì¡ê³  ì œí•œ
        // [NEW] ì‡¼ì¸ ëŠ” ì¢€ ë” ë¹ ë¥¸ í˜¸í¡ì„ ìœ„í•´ ê¸°ì¤€ ì¡°ì •
        const charRate = (window.APP_MODE === 'shorts') ? 5 : 5;
        const maxChars = duration * charRate;
        const targetLenMsg = `${duration}ì´ˆ ì˜ìƒ (ì•½ ${Math.round(duration * 2.5)} ~ ${maxChars}ì ë‚´ì™¸)`;

        const style = document.getElementById('scriptStyle').value;
        const includeHooks = document.getElementById('includeHooks').checked;
        const includeCTA = document.getElementById('includeCTA').checked;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ëŒ€ë³¸ ìƒì„± ì¤‘...');

        // ì–¸ì–´ ì„¤ì • ì¡°íšŒ
        let targetLanguage = 'ko'; // ê¸°ë³¸ê°’
        try {
            const projectFull = await API.project.getFull(projectId);
            if (projectFull && projectFull.settings && projectFull.settings.target_language) {
                targetLanguage = projectFull.settings.target_language;
            }
        } catch (e) {
            console.error("Failed to fetch project settings for language:", e);
        }

        // ì–¸ì–´ ì´ë¦„ ë§¤í•‘
        const langMap = {
            'ko': 'í•œêµ­ì–´',
            'en': 'English',
            'ja': 'Japanese',
            'es': 'Spanish'
        };
        const langName = langMap[targetLanguage] || targetLanguage;

        // ì„¹ì…˜ë³„ ìˆœì°¨ ìƒì„± (ê¸´ ì˜ìƒ ëŒ€ì‘)
        let finalScript = "";
        const sections = structureData.sections || [];

        // [NEW] Shorts Mode Structure Validation
        if (window.APP_MODE === 'shorts' && sections.length > 8) {
            const confirmFix = confirm(
                `í˜„ì¬ ëŒ€ë³¸ êµ¬ì¡°ê°€ ë¡±í¼ìš©ìœ¼ë¡œ ìƒì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (${sections.length}ê°œ ì„¹ì…˜).\n` +
                "ì´ëŒ€ë¡œ ì§„í–‰í•˜ë©´ ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ì§‘ë‹ˆë‹¤.\n\n" +
                "'í™•ì¸'ì„ ëˆ„ë¥´ë©´ [ê¸°íš ë‹¨ê³„]ë¡œ ì´ë™í•˜ì—¬ ì‡¼ì¸ ìš©ìœ¼ë¡œ ë‹¤ì‹œ êµ¬ì„±í•©ë‹ˆë‹¤.\n" +
                "'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥´ë©´ ê°•ì œë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
            );
            if (confirmFix) {
                window.location.href = '/script-plan?auto=true&mode=shorts';
                return;
            }
        }

        // ì „ì²´ êµ¬ì¡° í…ìŠ¤íŠ¸ (ë¬¸ë§¥ ìœ ì§€ìš©)
        const fullStructureSummary = sections.map((s, i) => `${i + 1}. ${s.title}: ${s.key_points.join(', ')}`).join('\n');

        // ìŠ¤íƒ€ì¼ë³„ ìƒì„¸ ì§€ì¹¨ ë§¤í•‘
        const styleInstructionMap = {
            'narration': `
                - **ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ” í†¤**ì„ ìœ ì§€í•˜ë˜, ì§€ë£¨í•˜ì§€ ì•Šê²Œ ì‘ì„±í•˜ì„¸ìš”.
                - ë³µì¡í•œ ê°œë…ì€ ì‰½ê³  ëª…í™•í•œ ë¹„ìœ ë¥¼ ë“¤ì–´ ì„¤ëª…í•˜ì„¸ìš”.
                - "ì, ì—¬ê¸°ë¥¼ ë³´ì‹œì£ ", "ì´ê²ƒì´ ì™œ ì¤‘ìš”í• ê¹Œìš”?" ê°™ì€ ë¬¸êµ¬ë¡œ ì‹œì²­ìì˜ ì£¼ì˜ë¥¼ í™˜ê¸°í•˜ì„¸ìš”.
                - ë…¼ë¦¬ì ì¸ íë¦„(Aì´ë¯€ë¡œ Bì´ë‹¤)ì„ ëª…í™•íˆ í•˜ì„¸ìš”.`,
            'conversational': `
                - **ì˜†ì§‘ ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ í¸ì•ˆí•˜ê³  ì¹œê·¼í•œ ë°˜ë§**(~í•´, ~í–ˆì–´)ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                - ë¬´ê±°ìš´ ì£¼ì œë„ ê°€ë³ê³  ìœ„íŠ¸ ìˆê²Œ í’€ì–´ë‚´ì„¸ìš”.
                - "ìˆì–ì•„, ê·¸ê±° ì•Œì•„?", "ì§„ì§œ ëŒ€ë°•ì´ì§€ ì•Šì•„?" ê°™ì€ êµ¬ì–´ì²´ ì¶”ì„ìƒˆë¥¼ ì ì ˆíˆ ì„ìœ¼ì„¸ìš”.
                - ì‹œì²­ìì˜ ê³µê°ì„ ì´ëŒì–´ë‚´ëŠ” ë¬¸ì¥ì„ ìì£¼ ì‚¬ìš©í•˜ì„¸ìš”.`,
            'storytelling': `
                - **í›Œë¥­í•œ ì´ì•¼ê¸°ê¾¼(Storyteller)**ì´ ë˜ì–´, ë“£ëŠ” ì´ê°€ ë‹¤ìŒ ë‚´ìš©ì´ ê¶ê¸ˆí•´ ë¯¸ì¹˜ë„ë¡ ë§Œë“œì„¸ìš”.
                - **"ë„ëŒ€ì²´ ì™œ ê·¸ë¬ì„ê¹Œìš”?", "í•˜ì§€ë§Œ ì—¬ê¸°ì„œ ë°˜ì „ì´ ì¼ì–´ë‚©ë‹ˆë‹¤."**ì™€ ê°™ì€ **í˜¸ê¸°ì‹¬ ìœ ë°œ ì§ˆë¬¸(Curiosity Gap)**ì„ ì§€ì†ì ìœ¼ë¡œ ë˜ì§€ì„¸ìš”.
                - ë‹¨ìˆœí•œ ì‚¬ì‹¤ ë‚˜ì—´ì„ ë©ˆì¶”ê³ , ëˆˆì•ì— ê·¸ë ¤ì§€ëŠ” ë“¯í•œ **ìƒìƒí•˜ê³  ê°ê°ì ì¸ ë¬˜ì‚¬**ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                - ë¬¸ì¥ê³¼ ë¬¸ì¥ ì‚¬ì´ë¥¼ ë§¤ë„ëŸ½ê²Œ ì‡ëŠ” **ì—°ê²° ê³ ë¦¬(Bridge)**ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª°ì…ê°ì„ ê¹¨ëœ¨ë¦¬ì§€ ë§ˆì„¸ìš”.
                - ê¸´ì¥ê°ì„ ì¡°ì„±í–ˆë‹¤ê°€ í•´ì†Œí•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë“œë¼ë§ˆí‹±í•œ ì „ê°œë¥¼ ë§Œë“œì„¸ìš”.`,
            'senior_story': `
                - **ì¸ìƒì˜ ì§€í˜œì™€ ê¹Šì´ê°€ ëŠê»´ì§€ëŠ” ë”°ëœ»í•˜ê³  ì°¨ë¶„í•œ ì–´ì¡°**ë¡œ ì‘ì„±í•˜ì„¸ìš”.
                - ë§ˆì¹˜ **ì˜¤ëœ ì¹œêµ¬ë‚˜ ì¸ìƒ ì„ ë°°ê°€ ì˜†ì—ì„œ ì¡°ê³¤ì¡°ê³¤ ì´ì•¼ê¸°í•´ì£¼ëŠ” ë“¯í•œ ëŠë‚Œ**ì„ ì£¼ì„¸ìš”.
                - ë„ˆë¬´ ë¹ ë¥´ê±°ë‚˜ ê°€ë²¼ìš´ ìœ í–‰ì–´ëŠ” í”¼í•˜ê³ , **ì´í•´í•˜ê¸° ì‰¬ìš´ ìˆœìš°ë¦¬ë§ì´ë‚˜ ìµìˆ™í•œ í‘œí˜„**ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                - **"ì°¸ ê¸°ê°€ ë§‰íŒ ì¼ì´ì£ .", "ê·¸ë•Œ ë§ˆìŒì´ ì–´ë• ê² ìŠµë‹ˆê¹Œ."** ê°™ì€ **ê³µê°ê³¼ ê°íƒ„**ì„ ìì•„ë‚´ëŠ” í‘œí˜„ì„ ì ì ˆíˆ ì„ìœ¼ì„¸ìš”.
                - ë“£ëŠ” ì´ì˜ ë§ˆìŒì„ ì–´ë£¨ë§Œì§€ëŠ” **ìœ„ë¡œì™€ ê³µê°, ê·¸ë¦¬ê³  ê°ë™**ì„ ì£¼ëŠ” ì´ì•¼ê¸°ë¥¼ ë§Œë“œì„¸ìš”.`,
            'bgm': `
                - **ë°°ê²½ìŒì•…(BGM)ì´ ì£¼ì¸ê³µì¸ ì˜ìƒ**ì…ë‹ˆë‹¤. ë‚´ë ˆì´ì…˜ì€ ìµœì†Œí™”í•˜ê³  ìŒì•…ì˜ ê°ë™ì„ ê·¹ëŒ€í™”í•˜ì„¸ìš”.
                - êµ¬êµ¬ì ˆì ˆí•œ ì„¤ëª…ë³´ë‹¤ëŠ” **ì§§ê³  ê°•ë ¬í•œ ê°ì„±ì ì¸ ë¬¸êµ¬**ë‚˜ **ëª…ì–¸**, **ì‹œì ì¸ í‘œí˜„**ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                - ìŒì•…ì˜ ë¹„íŠ¸ë‚˜ ë¶„ìœ„ê¸°ì— ë§ì¶° **í˜¸í¡ì´ ê¸´ ì—¬ìš´ ìˆëŠ” ë¬¸ì¥**ì„ ë°°ì¹˜í•˜ì„¸ìš”.
                - ì²­ê°ì  ìš”ì†Œ(ë¹—ì†Œë¦¬, íŒŒë„ ì†Œë¦¬ ë“±)ë‚˜ ì‹œê°ì  ë¬˜ì‚¬ë¥¼ ê¸€ì— ë‹´ì•„ ë“£ëŠ” ì´ê°€ ìƒìƒí•˜ê²Œ ë§Œë“œì„¸ìš”.
                - "ë§ˆìŒì„ í¸ì•ˆí•˜ê²Œ í•˜ì„¸ìš”", "ì ì‹œ ëˆˆì„ ê°ì•„ë³´ì„¸ìš”" ê°™ì€ **ì²­ìœ í˜• ë¬¸ì¥**ìœ¼ë¡œ íë§ì„ ìœ ë„í•˜ì„¸ìš”.`
        };

        // [NEW] ê¸€ë¡œë²Œ ì„¤ì •ì—ì„œ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
        let selectedStyleInstruction = styleInstructionMap[style] || styleInstructionMap['narration'];

        if (style === 'news' || style === 'story' || style === 'senior_story') {
            try {
                const settingsRes = await fetch('/api/settings');
                const settingsData = await settingsRes.json();
                if (settingsData.script_styles && settingsData.script_styles[style]) {
                    selectedStyleInstruction = `- **${style === 'news' ? 'ë‰´ìŠ¤ ë³´ë„' : 'ì˜›ë‚  ì´ì•¼ê¸°'} ìŠ¤íƒ€ì¼ ì§€ì¹¨:**\n${settingsData.script_styles[style]}`;
                }
            } catch (e) {
                console.error("Failed to fetch custom style prompts:", e);
            }
        }

        // ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹(í†µìƒì„±)ìœ¼ë¡œ ì²˜ë¦¬
        if (sections.length === 0) {
            // Fallback: ì„¹ì…˜ì´ ì—†ì„ ê²½ìš° ì²˜ë¦¬ ë¡œì§ì´ í•„ìš”í•˜ì§€ë§Œ, í˜„ì¬ëŠ” êµ¬ì¡°í™”ëœ ë°ì´í„°ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ê°€ì •í•©ë‹ˆë‹¤.
            console.warn("No sections found in structure data.");
        }

        Utils.setLoading(btn, true, `ëŒ€ë³¸ ìƒì„± ì¤‘... (0 / ${sections.length})`);
        document.getElementById('resultSection').classList.remove('hidden'); // ë¯¸ë¦¬ ë³´ì—¬ì¤Œ

        // [NEW] Stop Button Logic
        document.getElementById('stopBtn').classList.remove('hidden');

        try {
            console.log(`Starting generation for ${sections.length} sections.`);
            for (let i = 0; i < sections.length; i++) {
                if (window.stopGeneration) {
                    console.log("Generation stopped by user.");
                    Utils.showToast('ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ê¹Œì§€ì˜ ë‚´ìš©ì„ ì €ì¥í•©ë‹ˆë‹¤.', 'warning');
                    break;
                }

                const section = sections[i];
                console.log(`Processing section ${i + 1}/${sections.length}: ${section.title}`);
                Utils.setLoading(btn, true, `ëŒ€ë³¸ ìƒì„± ì¤‘... (${i + 1}/${sections.length} - ${section.title})`);

                // ì„¹ì…˜ë³„ ì˜ˆìƒ ê¸¸ì´ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
                const sectionDuration = Math.floor(duration / sections.length);
                // í•œêµ­ì–´ ë§í•˜ê¸° ì†ë„: ì´ˆë‹¹ ì•½ 2.5~3ìŒì ˆ. ë„‰ë„‰í•˜ê²Œ 2.5~5ì ë²”ìœ„ë¡œ ê°€ì´ë“œ.
                const minChars = Math.floor(sectionDuration * 2.5);
                const maxChars = Math.floor(sectionDuration * 5);
                const sectionTargetMsg = `${sectionDuration}ì´ˆ ë¶„ëŸ‰ (ìµœì†Œ ${minChars}ì ~ ìµœëŒ€ ${maxChars}ì ë‚´ì™¸)`;

                const sectionPrompt = `ë‹¹ì‹ ì€ ${duration}ì´ˆ ë¶„ëŸ‰ì˜ ${window.APP_MODE === 'shorts' ? 'ìœ íŠœë¸Œ ì‡¼ì¸ (Shorts)' : 'ìœ íŠœë¸Œ ì¥í¸ ì˜ìƒ'} ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤.
ì „ì²´ ê¸°íšëœ ëŒ€ë³¸ êµ¬ì¡° ì¤‘ ** "${section.title}" ** íŒŒíŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì „ì²´ ëŒ€ë³¸ êµ¬ì¡°]
${fullStructureSummary}

        [í˜„ì¬ ì‘ì„±í•  íŒŒíŠ¸]
            - ì„¹ì…˜: ${section.title}
        - ì£¼ìš” ë‚´ìš©: ${section.key_points.join(', ')}
        - ëª©í‘œ ê¸¸ì´: ${sectionTargetMsg} (ì´ ì„¹ì…˜ë§Œ ì¶©ì‹¤í•˜ê²Œ ì‘ì„±)

        [ì‘ì„± ì§€ì¹¨]
        1. ì•ë’¤ ë¬¸ë§¥('ì´ì „ ì„¹ì…˜ ìš”ì•½' ì°¸ê³ )ì„ ê³ ë ¤í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ì“°ì„¸ìš”.
        2. ** ìŠ¤íƒ€ì¼ ì§€ì¹¨(ë§¤ìš° ì¤‘ìš”):**
            ${selectedStyleInstruction}

         3. ** ë¶„ëŸ‰ì„ ì¶©ë¶„íˆ ë½‘ì•„ì£¼ì„¸ìš”. (ë‹¨, ëª©í‘œ ê¸¸ì´ ì¤€ìˆ˜)**
            - í˜„ì¬ ì„¹ì…˜ì˜ ëª©í‘œ ë¶„ëŸ‰ì€ **${minChars}ì ì´ìƒ**ì…ë‹ˆë‹¤. 
            ${window.APP_MODE === 'shorts' ?
                        `- **[ì‡¼ì¸  í•„ë…]**: êµ°ë”ë”ê¸° ì—†ì´ **í•µì‹¬ë§Œ íƒ€ê²©ê° ìˆê²Œ** ì „ë‹¬í•˜ì„¸ìš”. ì„œë¡ ì„ ê¸¸ê²Œ ë¹¼ì§€ ë§ê³  ë°”ë¡œ ë³¸ë¡ ìœ¼ë¡œ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ë¥¼ ì œê±°í•˜ê³  í˜¸í¡ì„ ì§§ê²Œ ê°€ì ¸ê°€ì„¸ìš”. ì „ì²´ 60ì´ˆë¥¼ ì ˆëŒ€ ë„˜ê¸°ë©´ ì•ˆ ë©ë‹ˆë‹¤.`
                        :
                        `- ë‚´ìš©ì´ ë¶€ì¡±í•˜ë‹¤ë©´ êµ¬ì²´ì ì¸ ì‚¬ë¡€, í†µê³„, ì „ë¬¸ê°€ì˜ ê²¬í•´, ê´€ë ¨ ë¹„í•˜ì¸ë“œ ìŠ¤í† ë¦¬ ë“±ì„ ì¶”ê°€í•˜ì—¬ ë‚´ìš©ì„ ëŒ€í­ ë³´ê°•í•˜ì„¸ìš”.
            - í•µì‹¬ í‚¤í¬ì¸íŠ¸ë¥¼ í•˜ë‚˜í•˜ë‚˜ ì‹¬ë„ ìˆê²Œ ë‹¤ë£¨ì‹­ì‹œì˜¤.`}
            
        4. ì„¹ì…˜ ì œëª©(ì˜ˆ: [ì„œë¡ ])ì€ ì¶œë ¥í•˜ì§€ ë§ê³ , ì˜¤ì§ ëŒ€ë³¸ ë³¸ë¬¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.
        5. ** ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.** (1ì°¨ ìƒì„±ì€ ë¬´ì¡°ê±´ í•œêµ­ì–´)
        6. **í˜„ì¬ ì„¹ì…˜ì˜ ë‚´ìš©ë§Œ ì‘ì„±í•˜ê³ , ì ˆëŒ€ ë‹¤ìŒ ì„¹ì…˜(ê²°ë¡  ë“±)ì´ë‚˜ ë§ˆë¬´ë¦¬ ë©˜íŠ¸ë¥¼ ë¯¸ë¦¬ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”.**

        [ì´ì „ê¹Œì§€ ë‚´ìš© ìš”ì•½(ë¬¸ë§¥ ì°¸ê³ ìš©)]
${finalScript.length > 500 ? finalScript.substring(finalScript.length - 500) : finalScript} ... (ì§ì „ ë‚´ìš©)

ì˜¤ì§ ëŒ€ë³¸ ë³¸ë¬¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.`;

                try {
                    // 60ì´ˆ íƒ€ì„ì•„ì›ƒ ë ˆì´ìŠ¤
                    const fetchPromise = API.gemini.generate(sectionPrompt, { temperature: 0.7, maxTokens: 4096 });
                    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 90000));

                    const result = await Promise.race([fetchPromise, timeoutPromise]);

                    if (result.status === 'ok') {
                        const sectionText = result.text.trim();
                        // ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ë‚´ìš©ì´ í¬í•¨ëœ ê²½ìš° ê±´ë„ˆë›°ê¸°
                        if (!finalScript.includes(sectionText.substring(0, 20))) {
                            finalScript += `\n\n ** [${section.title}] **\n${sectionText} `;
                        }

                        // [NEW] ì¤‘ê°„ ê²°ê³¼ ì €ì¥ (ë§¤ ì„¹ì…˜ë§ˆë‹¤)
                        Utils.storage.set('fullScript', {
                            topic: structureData?.topic || 'ì˜ìƒ',
                            script: finalScript,
                            timestamp: Date.now()
                        });
                        if (projectId) {
                            API.project.saveScript(projectId, finalScript, finalScript.length, Math.ceil(finalScript.length / 415)).catch(e => console.error("Auto-save failed:", e));
                        }

                        // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
                        const textArea = document.getElementById('scriptContent');
                        if (textArea) textArea.value = finalScript;
                        updateStats();
                        console.log(`Section ${i + 1} complete.`);
                    } else {
                        console.error(`Section ${i + 1} failed`, result);
                        finalScript += `\n\n[${section.title} íŒŒíŠ¸ ìƒì„± ì‹¤íŒ¨]\n`;
                    }
                } catch (innerErr) {
                    console.error(`Error generating section ${i + 1}:`, innerErr);
                    finalScript += `\n\n[${section.title} íŒŒíŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ]\n`;
                }

                // API Rate Limit ë°©ì§€ìš© ëŒ€ê¸° (ë§ˆì§€ë§‰ ì„¹ì…˜ ì œì™¸)
                if (i < sections.length - 1) {
                    console.log(`Waiting before next section...`);
                    await new Promise(r => setTimeout(r, 1000));
                }
            }

            console.log("All sections completed.");

            // ìµœì¢… ì™„ë£Œ
            currentScript = finalScript;
            Utils.storage.set('fullScript', {
                topic: structureData?.topic || 'ì˜ìƒ',
                script: currentScript,
                timestamp: Date.now()
            });

            // [FIX] DBì— ëŒ€ë³¸ ì €ì¥ (ì¤‘ìš”: ê·¸ë˜ì•¼ ì§„í–‰ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë¨)
            if (projectId) {
                try {
                    const charCount = currentScript.length;
                    const readTime = Math.ceil(charCount / 415);
                    await API.project.saveScript(projectId, currentScript, charCount, readTime);
                    console.log("Script saved to DB successfully.");
                    // [NEW] Update Stepper
                    if (window.updateStepStatus) window.updateStepStatus('script', true);
                } catch (dbErr) {
                    console.error("Failed to save script to DB:", dbErr);
                }
            }

            Utils.showToast('ì „ì²´ ëŒ€ë³¸ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

            // ë²ˆì—­ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì²´í¬
            checkTranslationAvailability(targetLanguage);

            // [NEW] ëŒ€ë³¸ ê¸°ë°˜ ì œëª© ìë™ ìƒì„± ë° ì €ì¥
            if (!window.stopGeneration) {
                await autoGenerateTitle(projectId, currentScript);
            }

        } catch (error) {
            console.error('ìƒì„± ì˜¤ë¥˜:', error);
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        } finally {
            console.log("Process finished, resetting button.");
            Utils.setLoading(btn, false);
            document.getElementById('stopBtn').classList.add('hidden');
            window.stopGeneration = false;
        }
    }

    // ì œëª© ìë™ ìƒì„± ë° ì €ì¥ í•¨ìˆ˜
    async function autoGenerateTitle(projectId, script) {
        try {
            Utils.showToast('AIê°€ ìµœì ì˜ ì œëª©ì„ ì„ ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

            const prompt = `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ì¸ë„¤ì¼/ì œëª© ì–´ê·¸ë¡œ ì¥ì¸ì…ë‹ˆë‹¤.
ë‹¤ìŒ ëŒ€ë³¸ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í´ë¦­ë¥ (CTR)ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆëŠ” **ê°€ì¥ ê°•ë ¥í•œ í›„í‚¹ì„± ì œëª© 1ê°œ**ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ëŒ€ë³¸ ìš”ì•½]
${script.substring(0, 2000)}...

[ì¡°ê±´]
1. ë”°ì˜´í‘œ ì—†ì´ ì œëª© í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
2. 30ì ì´ë‚´ë¡œ ì§§ê³  ê°•ë ¬í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
3. í˜¸ê¸°ì‹¬ì„ ìê·¹í•˜ê±°ë‚˜ ì´ë“ì„ ê°•ì¡°í•˜ëŠ” ìŠ¤íƒ€ì¼ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
4. ì˜ˆì‹œ: "ì´ê²ƒë§Œ ì•Œë©´ ì¸ìƒì´ ë°”ë€ë‹ˆë‹¤", "99%ê°€ ëª¨ë¥´ëŠ” ì¶©ê²©ì ì¸ ì‚¬ì‹¤"
5. **ì˜¤ì§ ì œëª© 1ì¤„ë§Œ ë°˜í™˜í•˜ì„¸ìš”.**`;

            const result = await API.gemini.generate(prompt, { temperature: 0.8 });

            if (result.status === 'ok') {
                let newTitle = result.text.trim().replace(/^["']|["']$/g, ''); // ë”°ì˜´í‘œ ì œê±°
                console.log("Auto-generated Title:", newTitle);

                // í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
                await API.project.update(projectId, { video_title: newTitle });

                Utils.showToast(`ì œëª©ì´ ìë™ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${newTitle}`, 'success');

                // (ì„ íƒ) ìƒë‹¨ í—¤ë” ì—…ë°ì´íŠ¸ê°€ ê°€ëŠ¥í•˜ë‹¤ë©´ ìˆ˜í–‰ (í—¤ë”ì— ì œëª© í‘œì‹œ ê¸°ëŠ¥ì´ ìˆë‹¤ë©´)
                // const titleEl = document.getElementById('projectTitleDisplay');
                // if(titleEl) titleEl.textContent = newTitle;
            }
        } catch (e) {
            console.error("Auto title generation failed:", e);
            // ì œëª© ìƒì„± ì‹¤íŒ¨ëŠ” í¬ë¦¬í‹°ì»¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì¡°ìš©íˆ ë„˜ì–´ê° (ë¡œê·¸ë§Œ ë‚¨ê¹€)
        }
    }

    function stopAndSave() {
        if (window.confirm('ëŒ€ë³¸ ìƒì„±ì„ ê°•ì œë¡œ ì¤‘ë‹¨í•˜ê³  í˜„ì¬ê¹Œì§€ì˜ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë§ˆì§€ë§‰ ì„¹ì…˜ ìƒì„± ì‘ì—…ì€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)')) {
            window.stopGeneration = true;
            const btn = document.getElementById('stopBtn');
            btn.innerHTML = 'ğŸ›‘ ì¤‘ë‹¨ ì¤‘...';
            btn.disabled = true;
        }
    }

    function updateStats() {
        const text = document.getElementById('scriptContent').value;
        const charCount = text.length;
        const readTime = Math.ceil(charCount / 415); // ë¶„ë‹¹ 415ì ê¸°ì¤€ (Edge TTS 1.0 ì†ë„ ìµœì í™”)

        document.getElementById('charCount').textContent = `${charCount.toLocaleString()} ì`;
        document.getElementById('readTime').textContent = `ì˜ˆìƒ ì½ê¸° ì‹œê°„: ${readTime} ë¶„`;
    }

    document.getElementById('scriptContent')?.addEventListener('input', updateStats);

    function copyScript() {
        const text = document.getElementById('scriptContent').value;
        Utils.copyToClipboard(text);
        Utils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function downloadScript() {
        const text = document.getElementById('scriptContent').value;
        const topic = Utils.storage.get('scriptStructure')?.topic || 'ëŒ€ë³¸';
        Utils.downloadFile(text, `${topic} _ëŒ€ë³¸.txt`);
    }

    function goToImageGen() {
        window.location.href = '/image-gen';
    }

    function goToTTS() {
        window.location.href = '/tts';
    }

    // í”„ë¡œì íŠ¸ ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;

        // 1. ëŒ€ë³¸ ë°ì´í„° ë³µêµ¬
        if (data.script && data.script.full_script) {
            currentScript = data.script.full_script;
            const textarea = document.getElementById('scriptContent');
            if (textarea) textarea.value = currentScript;

            document.getElementById('resultSection').classList.remove('hidden');
            if (window.updateStats) updateStats();

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”
            Utils.storage.set('fullScript', {
                topic: data.project?.topic || 'ì˜ìƒ',
                script: currentScript,
                timestamp: Date.now()
            });
        }

        // 2. êµ¬ì¡° ë°ì´í„° ë³µêµ¬ (í•„ìš”ì‹œ)
        if (data.script_structure) {
            Utils.storage.set('scriptStructure', data.script_structure);
        }
    });

    // ì´ˆê¸° ë¡œë“œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸
    document.addEventListener('DOMContentLoaded', () => {
        const savedScript = Utils.storage.get('fullScript');
        if (savedScript && savedScript.script) {
            currentScript = savedScript.script;
            const textarea = document.getElementById('scriptContent');
            if (textarea) textarea.value = currentScript;
            document.getElementById('resultSection').classList.remove('hidden');
            if (window.updateStats) updateStats();
        }
    });
    function checkTranslationAvailability(targetLang) {
        if (targetLang && targetLang !== 'ko') {
            const btn = document.getElementById('translateBtn');
            btn.classList.remove('hidden');
            btn.textContent = `ğŸŒ ${targetLang === 'en' ? 'ì˜ì–´' : targetLang === 'ja' ? 'ì¼ë³¸ì–´' : 'ì™¸êµ­ì–´'}ë¡œ ë²ˆì—­í•˜ê¸°`;
            btn.dataset.lang = targetLang;
        }
    }

    async function translateScript() {
        const btn = document.getElementById('translateBtn');
        const targetLang = btn.dataset.lang;
        const script = document.getElementById('scriptContent').value;

        if (!script) return;

        if (!confirm('í˜„ì¬ ëŒ€ë³¸ì„ ë²ˆì—­í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°ì¡´ ë‚´ìš©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)')) return;

        const originalText = btn.innerHTML;
        Utils.setLoading(btn, true, 'ë²ˆì—­ ì¤‘...');

        try {
            const response = await fetch('/api/gemini/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: script,
                    target_language: targetLang
                })
            });

            const result = await response.json();

            if (result.status === 'ok') {
                const translated = result.translated_text;
                document.getElementById('scriptContent').value = translated;
                currentScript = translated;
                updateStats(); // ê¸€ììˆ˜ ì—…ë°ì´íŠ¸

                // ì €ì¥
                const topic = document.getElementById('structureTopic').value || 'ì˜ìƒ';
                Utils.storage.set('fullScript', {
                    topic: topic,
                    script: translated,
                    timestamp: Date.now()
                });

                // DB ì €ì¥ (ì„ íƒ ì‚¬í•­, ìœ ì €ê°€ ì›í•  ë•Œ ì €ì¥í•˜ê²Œ ë†”ë‘˜ ìˆ˜ë„ ìˆì§€ë§Œ ì¼ë‹¨ ìë™ ì €ì¥ì´ ì—†ìœ¼ë¯€ë¡œ)

                Utils.showToast('ë²ˆì—­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                throw new Error(result.error);
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ë²ˆì—­ ì‹¤íŒ¨: ' + e.message, 'error');
        } finally {
            Utils.setLoading(btn, false);
            btn.innerHTML = originalText;
        }
    }

    // í”„ë¡œì íŠ¸ ë¡œë“œ ì‹œì—ë„ ì–¸ì–´ ì²´í¬
    window.addEventListener('projectChanged', async (e) => {
        const projectId = e.detail.projectId;
        try {
            const projectFull = await API.project.getFull(projectId);
            if (projectFull && projectFull.settings && projectFull.settings.target_language) {
                checkTranslationAvailability(projectFull.settings.target_language);
            }
        } catch (e) { }
    });

    // [NEW] íƒ­ ì „í™˜ ë° ìˆ˜ë™ ë“±ë¡ ë¡œì§
    function setScriptMode(mode) {
        const tabAI = document.getElementById('tabAI');
        const tabManual = document.getElementById('tabManual');
        const sectionAI = document.getElementById('aiGenSection');
        const sectionManual = document.getElementById('manualInputSection');

        if (mode === 'ai') {
            // Activate AI Tab
            tabAI.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            tabAI.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');

            // Deactivate Manual Tab
            tabManual.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            tabManual.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');

            sectionAI.classList.remove('hidden');
            sectionManual.classList.add('hidden');
        } else {
            // Activate Manual Tab
            tabManual.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            tabManual.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');

            // Deactivate AI Tab
            tabAI.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            tabAI.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');

            sectionAI.classList.add('hidden');
            sectionManual.classList.remove('hidden');
        }
    }

    async function registerManualScript() {
        const scriptInput = document.getElementById('manualScriptInput');
        const scriptText = scriptInput.value.trim();

        if (!scriptText) {
            Utils.showToast('ëŒ€ë³¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const projectId = getCurrentProject();
        // ê¸°íš ë°ì´í„°ì—ì„œ ì£¼ì œ ê°€ì ¸ì˜¤ê¸°
        const structureData = Utils.storage.get('scriptStructure') || {};
        const topic = structureData.topic || 'ì™¸ë¶€ ëŒ€ë³¸';

        // 1. UI ë° ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        currentScript = scriptText;
        const textArea = document.getElementById('scriptContent');
        if (textArea) textArea.value = currentScript;

        document.getElementById('resultSection').classList.remove('hidden');
        updateStats();

        // 2. ì €ì¥ (ë¡œì»¬ + DB)
        Utils.storage.set('fullScript', {
            topic: topic,
            script: currentScript,
            timestamp: Date.now()
        });

        if (projectId) {
            try {
                const charCount = currentScript.length;
                const readTime = Math.ceil(charCount / 415);
                await API.project.saveScript(projectId, currentScript, charCount, readTime);
                Utils.showToast('ëŒ€ë³¸ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                // [NEW] Update Stepper
                if (window.updateStepStatus) window.updateStepStatus('script', true);

                // ì œëª© ìë™ ìƒì„± (ì„ íƒ ì‚¬í•­)
                // await autoGenerateTitle(projectId, currentScript); 

                // ìŠ¤í¬ë¡¤ ì´ë™
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

                // íƒ­ì„ AI ëª¨ë“œë¡œ ë³µê·€? ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ? -> ê·¸ëŒ€ë¡œ ë‘ .

            } catch (e) {
                console.error("Manual save failed:", e);
                Utils.showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        } else {
            Utils.showToast('ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (í”„ë¡œì íŠ¸ ë¯¸ì„ íƒ)', 'info');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
    }

    function copyStructurePreview() {
        const text = document.getElementById('previewContent').textContent;
        Utils.copyToClipboard(text);
        Utils.showToast('êµ¬ì¡° ë°ì´í„°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }
</script>
{% endblock %}