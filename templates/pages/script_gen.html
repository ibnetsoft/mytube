{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">âœï¸</span>
        <div>
            <h1>ëŒ€ë³¸ ìƒì„±</h1>
            <p>AIê°€ ì™„ì„±ëœ ëŒ€ë³¸ì„ ì‘ì„±í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- ë¶„ì„ ë°ì´í„° í‘œì‹œ -->
<div id="analysisInfo" class="card mb-6 hidden">
    <h3 class="font-bold text-gray-800 dark:text-white mb-2">ğŸ“‹ ëŒ€ë³¸ êµ¬ì¡° ê¸°ë°˜</h3>
    <input type="text" id="structureTopic" class="input-field mt-1" placeholder="ì˜ìƒ ì£¼ì œ (ìˆ˜ì • ê°€ëŠ¥)">
    <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ì£¼ì œê°€ ë‹¤ë¥´ë‹¤ë©´ ì§ì ‘ ìˆ˜ì •í•´ì£¼ì„¸ìš”. AIëŠ” ì´ ì£¼ì œì™€ ì•„ë˜ êµ¬ì¡°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëŒ€ë³¸ì„ ì”ë‹ˆë‹¤.</p>
</div>

<!-- ë””ë²„ê·¸/í”„ë¦¬ë·°: ì‹¤ì œë¡œ ë¡œë“œëœ êµ¬ì¡° í™•ì¸ìš© -->
<div id="structurePreview" class="card mb-6 border-l-4 border-indigo-500 bg-indigo-50 dark:bg-indigo-900/10">
    <h3 class="font-bold text-indigo-800 dark:text-indigo-300 mb-2">ğŸ” AIì—ê²Œ ì „ë‹¬ë  êµ¬ì¡° ë°ì´í„° (í™•ì¸ìš©)</h3>
    <div id="previewContent"
        class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap font-mono max-h-40 overflow-y-auto p-2 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
        (ë°ì´í„° ë¡œë”© ì¤‘...)
    </div>
</div>

<!-- ëŒ€ë³¸ ì˜µì…˜ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ ëŒ€ë³¸ ì˜µì…˜</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ëŒ€ë³¸ ìŠ¤íƒ€ì¼</label>
            <select id="scriptStyle" class="input-field">
                <option value="narration">ë‚˜ë ˆì´ì…˜í˜• (ì„¤ëª… ìœ„ì£¼)</option>
                <option value="conversational">ëŒ€í™”í˜• (ì¹œê·¼í•œ ë§íˆ¬)</option>
                <option value="storytelling">ìŠ¤í† ë¦¬í…”ë§í˜• (ì´ì•¼ê¸° ì „ê°œ)</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í¬í•¨ ìš”ì†Œ</label>
            <div class="flex gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="includeHooks" checked class="rounded">
                    <span class="text-sm text-gray-700 dark:text-gray-300">í›„í‚¹ ë©˜íŠ¸</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="includeCTA" checked class="rounded">
                    <span class="text-sm text-gray-700 dark:text-gray-300">CTA</span>
                </label>
            </div>
        </div>
    </div>
</div>

<!-- ìƒì„± ë²„íŠ¼ ê·¸ë£¹ -->
<div class="flex gap-2 mb-6">
    <button onclick="generateScript()" id="generateBtn"
        class="flex-1 btn-primary py-4 flex items-center justify-center gap-3 text-lg">
        <span>âœï¸</span>
        <span>ëŒ€ë³¸ ìƒì„± ì‹œì‘í•˜ê¸°</span>
    </button>
    <button onclick="stopAndSave()" id="stopBtn"
        class="hidden btn-secondary bg-red-100 text-red-600 hover:bg-red-200 py-4 px-6 flex items-center justify-center gap-2">
        <span>â¹ï¸</span>
        <span>ë©ˆì¶¤ & ì €ì¥ (ì¦‰ì‹œ ì™„ë£Œ)</span>
    </button>
</div>

<!-- ê²°ê³¼ ì˜ì—­ -->
<div id="resultSection" class="hidden">
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800 dark:text-white">ğŸ“ ìƒì„±ëœ ëŒ€ë³¸</h3>
            <div class="flex gap-2">
                <button onclick="translateScript()" id="translateBtn" class="btn-secondary text-sm hidden">ğŸŒ
                    ë²ˆì—­í•˜ê¸°</button>
                <button onclick="copyScript()" class="btn-secondary text-sm">ğŸ“‹ ë³µì‚¬</button>
                <button onclick="downloadScript()" class="btn-secondary text-sm">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <div class="mb-4 flex gap-4 text-sm text-gray-500">
            <span id="charCount">0ì</span>
            <span id="readTime">ì˜ˆìƒ ì½ê¸° ì‹œê°„: 0ë¶„</span>
        </div>

        <textarea id="scriptContent" class="input-field font-mono" rows="20"></textarea>

        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700 flex gap-4">
            <button onclick="goToImageGen()" class="flex-1 btn-primary py-4 flex items-center justify-center gap-3">
                <span>ğŸ–¼ï¸</span>
                <span>ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„±</span>
                <span>â†’</span>
            </button>
            <button onclick="goToTTS()" class="flex-1 btn-secondary py-4 flex items-center justify-center gap-3">
                <span>ğŸ”Š</span>
                <span>TTS ìƒì„±</span>
                <span>â†’</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentScript = '';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë”©
    document.addEventListener('DOMContentLoaded', async () => {
        const projectId = getCurrentProject();
        console.log("Current Project ID:", projectId);

        // 1. í”„ë¦¬ë·° ì´ˆê¸°í™”
        const previewEl = document.getElementById('previewContent');
        if (previewEl) previewEl.textContent = "ë°ì´í„° ë¡œë”© ì¤‘...";

        // 2. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¡œì»¬ -> ì„œë²„)
        let structureData = Utils.storage.get('scriptStructure');

        // [ì¤‘ìš”] í”„ë¡œì íŠ¸ ID ë¶ˆì¼ì¹˜ ì‹œ ë°ì´í„°ë¥¼ íê¸°í•˜ê³  ì„œë²„ì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜´
        if (structureData && structureData.project_id && structureData.project_id != projectId) {
            console.log("Mismatching validation: Storage ID", structureData.project_id, "Current ID", projectId);
            structureData = null; // Force reload
            Utils.storage.remove('scriptStructure');
        }

        if (!structureData && projectId) {
            try {
                // ì„œë²„ì—ì„œ ì¡°íšŒ
                const projectFull = await API.project.getFull(projectId);
                console.log("Projects Full Data:", projectFull);

                if (projectFull && projectFull.script_structure) {
                    structureData = projectFull.script_structure;
                    // topicì´ í•„ìš”í•˜ë©´ projectFull.project.topic ë˜ëŠ” script_structure ë‚´ë¶€ í™•ì¸
                    if (!structureData.topic && projectFull.project) {
                        structureData.topic = projectFull.project.topic || projectFull.project.name;
                    }

                    // project_idê°€ ì—†ìœ¼ë©´ ì£¼ì… (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²€ì¦ìš©)
                    if (!structureData.project_id) {
                        structureData.project_id = projectId;
                    }

                    Utils.storage.set('scriptStructure', structureData);
                    Utils.showToast('ê¸°íš ë°ì´í„°ë¥¼ serverì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
                }
            } catch (e) {
                console.error("Failed to fetch project data:", e);
                if (previewEl) previewEl.textContent = "âŒ ì„œë²„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨";
            }
        }

        // 3. UI ì—…ë°ì´íŠ¸
        if (structureData) {
            const infoEl = document.getElementById('analysisInfo'); // Corrected ID from 'structureInfo' to 'analysisInfo'
            if (infoEl) infoEl.classList.remove('hidden');

            const topicEl = document.getElementById('structureTopic');
            const topic = structureData.topic || structureData.hook || 'ì£¼ì œ ë¯¸ìƒ';
            if (topicEl) topicEl.value = topic;

            // í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
            if (previewEl) {
                previewEl.textContent = JSON.stringify(structureData, null, 2);
                previewEl.classList.remove('text-red-600');
            }
        } else {
            if (previewEl) {
                previewEl.textContent = "âŒ êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤! ëŒ€ë³¸ ê¸°íš ë‹¨ê³„ ì™„ë£Œ ì—¬ë¶€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                previewEl.classList.add('text-red-600', 'font-bold');
            }
        }
    });

    async function generateScript() {
        const projectId = getCurrentProject();
        // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¡œì»¬ -> ì„œë²„)
        let structureData = Utils.storage.get('scriptStructure');

        // ë°ì´í„°ê°€ ì—†ê±°ë‚˜, í”„ë¡œì íŠ¸ IDê°€ ë‹¤ë¥´ë©´ ìƒˆë¡œê³ ì¹¨ ì‹œë„
        if (!structureData || (structureData.project_id && structureData.project_id != projectId)) {
            console.log("Refreshing data in generateScript due to mismatch or missing");
            try {
                const projectFull = await API.project.getFull(projectId);
                if (projectFull && projectFull.script_structure) {
                    structureData = projectFull.script_structure;
                    if (!structureData.topic && projectFull.project) {
                        structureData.topic = projectFull.project.topic || projectFull.project.name;
                    }
                    if (!structureData.project_id) structureData.project_id = projectId;
                    Utils.storage.set('scriptStructure', structureData);
                }
            } catch (e) { console.error(e); }
        }

        if (!structureData) {
            Utils.showToast('ëŒ€ë³¸ êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°íš ë‹¨ê³„ë¶€í„° ì§„í–‰í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // UI í”„ë¦¬ë·° ê°•ì œ ì—…ë°ì´íŠ¸ (ì‹±í¬ ë§ì¶”ê¸°)
        const previewEl = document.getElementById('previewContent');
        if (previewEl) previewEl.textContent = JSON.stringify(structureData, null, 2);

        // 2. êµ¬ì¡° ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ (ë²„ê·¸ ìˆ˜ì •)
        let structureText = '';
        if (typeof structureData === 'string') {
            structureText = structureData;
        } else if (typeof structureData === 'object') {
            // "structure" í‚¤ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì „ì²´ ê°ì²´ ë³€í™˜
            structureText = structureData.structure || JSON.stringify(structureData, null, 2);
        }

        // ì£¼ì œì •ë³´ ë³´ê°•
        const topic = document.getElementById('structureTopic').value || structureData.topic || structureData.hook || 'ìœ íŠœë¸Œ ì˜ìƒ';

        // ê¸¸ì´ ì •ë³´ ë³´ê°• (ê¸°ë³¸ê°’ 60ì´ˆ)
        const duration = structureData.duration || 60;
        // í•œêµ­ì–´ ë§í•˜ê¸° ì†ë„: ì´ˆë‹¹ ì•½ 2.5~3ìŒì ˆ (ì—¬ìœ ìˆê²Œ ê³„ì‚°)
        // 30ì´ˆ -> 90~120ì, 60ì´ˆ -> 200~250ì
        // ë„ˆë¬´ ì§§ìœ¼ë©´ AIê°€ ë‚´ìš©ì„ ëª» ì±„ìš°ë¯€ë¡œ ì´ˆë‹¹ 4.5ì ì •ë„ë¡œ ë„‰ë„‰íˆ ì¡ê³  ì œí•œ
        const maxChars = duration * 5;
        const targetLenMsg = `${duration}ì´ˆ ì˜ìƒ (ì•½ ${Math.round(duration * 2.5)} ~ ${maxChars}ì ë‚´ì™¸)`;

        const style = document.getElementById('scriptStyle').value;
        const includeHooks = document.getElementById('includeHooks').checked;
        const includeCTA = document.getElementById('includeCTA').checked;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ëŒ€ë³¸ ìƒì„± ì¤‘...');

        // ì–¸ì–´ ì„¤ì • ì¡°íšŒ
        let targetLanguage = 'ko'; // ê¸°ë³¸ê°’
        try {
            const projectFull = await API.project.getFull(projectId);
            if (projectFull && projectFull.settings && projectFull.settings.target_language) {
                targetLanguage = projectFull.settings.target_language;
            }
        } catch (e) {
            console.error("Failed to fetch project settings for language:", e);
        }

        // ì–¸ì–´ ì´ë¦„ ë§¤í•‘
        const langMap = {
            'ko': 'í•œêµ­ì–´',
            'en': 'English',
            'ja': 'Japanese',
            'es': 'Spanish'
        };
        const langName = langMap[targetLanguage] || targetLanguage;

        // ì„¹ì…˜ë³„ ìˆœì°¨ ìƒì„± (ê¸´ ì˜ìƒ ëŒ€ì‘)
        let finalScript = "";
        const sections = structureData.sections || [];

        // ì „ì²´ êµ¬ì¡° í…ìŠ¤íŠ¸ (ë¬¸ë§¥ ìœ ì§€ìš©)
        const fullStructureSummary = sections.map((s, i) => `${i + 1}. ${s.title}: ${s.key_points.join(', ')}`).join('\n');

        // ìŠ¤íƒ€ì¼ë³„ ìƒì„¸ ì§€ì¹¨ ë§¤í•‘
        const styleInstructionMap = {
            'narration': `
                - **ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ” í†¤**ì„ ìœ ì§€í•˜ë˜, ì§€ë£¨í•˜ì§€ ì•Šê²Œ ì‘ì„±í•˜ì„¸ìš”.
                - ë³µì¡í•œ ê°œë…ì€ ì‰½ê³  ëª…í™•í•œ ë¹„ìœ ë¥¼ ë“¤ì–´ ì„¤ëª…í•˜ì„¸ìš”.
                - "ì, ì—¬ê¸°ë¥¼ ë³´ì‹œì£ ", "ì´ê²ƒì´ ì™œ ì¤‘ìš”í• ê¹Œìš”?" ê°™ì€ ë¬¸êµ¬ë¡œ ì‹œì²­ìì˜ ì£¼ì˜ë¥¼ í™˜ê¸°í•˜ì„¸ìš”.
                - ë…¼ë¦¬ì ì¸ íë¦„(Aì´ë¯€ë¡œ Bì´ë‹¤)ì„ ëª…í™•íˆ í•˜ì„¸ìš”.`,
            'conversational': `
                - **ì˜†ì§‘ ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ í¸ì•ˆí•˜ê³  ì¹œê·¼í•œ ë°˜ë§**(~í•´, ~í–ˆì–´)ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                - ë¬´ê±°ìš´ ì£¼ì œë„ ê°€ë³ê³  ìœ„íŠ¸ ìˆê²Œ í’€ì–´ë‚´ì„¸ìš”.
                - "ìˆì–ì•„, ê·¸ê±° ì•Œì•„?", "ì§„ì§œ ëŒ€ë°•ì´ì§€ ì•Šì•„?" ê°™ì€ êµ¬ì–´ì²´ ì¶”ì„ìƒˆë¥¼ ì ì ˆíˆ ì„ìœ¼ì„¸ìš”.
                - ì‹œì²­ìì˜ ê³µê°ì„ ì´ëŒì–´ë‚´ëŠ” ë¬¸ì¥ì„ ìì£¼ ì‚¬ìš©í•˜ì„¸ìš”.`,
            'storytelling': `
                - **í›Œë¥­í•œ ì´ì•¼ê¸°ê¾¼(Storyteller)**ì´ ë˜ì–´, ë“£ëŠ” ì´ê°€ ë‹¤ìŒ ë‚´ìš©ì´ ê¶ê¸ˆí•´ ë¯¸ì¹˜ë„ë¡ ë§Œë“œì„¸ìš”.
                - **"ë„ëŒ€ì²´ ì™œ ê·¸ë¬ì„ê¹Œìš”?", "í•˜ì§€ë§Œ ì—¬ê¸°ì„œ ë°˜ì „ì´ ì¼ì–´ë‚©ë‹ˆë‹¤."**ì™€ ê°™ì€ **í˜¸ê¸°ì‹¬ ìœ ë°œ ì§ˆë¬¸(Curiosity Gap)**ì„ ì§€ì†ì ìœ¼ë¡œ ë˜ì§€ì„¸ìš”.
                - ë‹¨ìˆœí•œ ì‚¬ì‹¤ ë‚˜ì—´ì„ ë©ˆì¶”ê³ , ëˆˆì•ì— ê·¸ë ¤ì§€ëŠ” ë“¯í•œ **ìƒìƒí•˜ê³  ê°ê°ì ì¸ ë¬˜ì‚¬**ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                - ë¬¸ì¥ê³¼ ë¬¸ì¥ ì‚¬ì´ë¥¼ ë§¤ë„ëŸ½ê²Œ ì‡ëŠ” **ì—°ê²° ê³ ë¦¬(Bridge)**ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª°ì…ê°ì„ ê¹¨ëœ¨ë¦¬ì§€ ë§ˆì„¸ìš”.
                - ê¸´ì¥ê°ì„ ì¡°ì„±í–ˆë‹¤ê°€ í•´ì†Œí•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë“œë¼ë§ˆí‹±í•œ ì „ê°œë¥¼ ë§Œë“œì„¸ìš”.`
        };

        const selectedStyleInstruction = styleInstructionMap[style] || styleInstructionMap['narration'];

        // ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹(í†µìƒì„±)ìœ¼ë¡œ ì²˜ë¦¬
        if (sections.length === 0) {
            // Fallback: ì„¹ì…˜ì´ ì—†ì„ ê²½ìš° ì²˜ë¦¬ ë¡œì§ì´ í•„ìš”í•˜ì§€ë§Œ, í˜„ì¬ëŠ” êµ¬ì¡°í™”ëœ ë°ì´í„°ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ê°€ì •í•©ë‹ˆë‹¤.
            console.warn("No sections found in structure data.");
        }

        Utils.setLoading(btn, true, `ëŒ€ë³¸ ìƒì„± ì¤‘... (0 / ${sections.length})`);
        document.getElementById('resultSection').classList.remove('hidden'); // ë¯¸ë¦¬ ë³´ì—¬ì¤Œ

        // [NEW] Stop Button Logic
        document.getElementById('stopBtn').classList.remove('hidden');

        try {
            console.log(`Starting generation for ${sections.length} sections.`);
            for (let i = 0; i < sections.length; i++) {
                if (window.stopGeneration) {
                    console.log("Generation stopped by user.");
                    Utils.showToast('ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ê¹Œì§€ì˜ ë‚´ìš©ì„ ì €ì¥í•©ë‹ˆë‹¤.', 'warning');
                    break;
                }

                const section = sections[i];
                console.log(`Processing section ${i + 1}/${sections.length}: ${section.title}`);
                Utils.setLoading(btn, true, `ëŒ€ë³¸ ìƒì„± ì¤‘... (${i + 1}/${sections.length} - ${section.title})`);

                // ì„¹ì…˜ë³„ ì˜ˆìƒ ê¸¸ì´ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
                const sectionDuration = Math.floor(duration / sections.length);
                const sectionTargetMsg = `${sectionDuration}ì´ˆ ë¶„ëŸ‰(ì „ì²´ ${duration}ì´ˆ ì¤‘ ${i + 1}ë²ˆì§¸ ì„¹ì…˜)`;

                const sectionPrompt = `ë‹¹ì‹ ì€ ${duration}ì´ˆ ë¶„ëŸ‰ì˜ ìœ íŠœë¸Œ ì¥í¸ ì˜ìƒ ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤.
ì „ì²´ ê¸°íšëœ ëŒ€ë³¸ êµ¬ì¡° ì¤‘ ** "${section.title}" ** íŒŒíŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì „ì²´ ëŒ€ë³¸ êµ¬ì¡°]
${fullStructureSummary}

        [í˜„ì¬ ì‘ì„±í•  íŒŒíŠ¸]
            - ì„¹ì…˜: ${section.title}
        - ì£¼ìš” ë‚´ìš©: ${section.key_points.join(', ')}
        - ëª©í‘œ ê¸¸ì´: ${sectionTargetMsg} (ì´ ì„¹ì…˜ë§Œ ì¶©ì‹¤í•˜ê²Œ ì‘ì„±)

        [ì‘ì„± ì§€ì¹¨]
        1. ì•ë’¤ ë¬¸ë§¥('ì´ì „ ì„¹ì…˜ ìš”ì•½' ì°¸ê³ )ì„ ê³ ë ¤í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ì“°ì„¸ìš”.
        2. ** ìŠ¤íƒ€ì¼ ì§€ì¹¨(ë§¤ìš° ì¤‘ìš”):**
            ${selectedStyleInstruction}

        3. ** ë¶„ëŸ‰ì„ ì¶©ë¶„íˆ ë½‘ì•„ì£¼ì„¸ìš”.** (ë„ˆë¬´ ì§§ìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤)
        4. ì„¹ì…˜ ì œëª©(ì˜ˆ: [ì„œë¡ ])ì€ ì¶œë ¥í•˜ì§€ ë§ê³ , ì˜¤ì§ ëŒ€ë³¸ ë³¸ë¬¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.
        5. ** ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.** (1ì°¨ ìƒì„±ì€ ë¬´ì¡°ê±´ í•œêµ­ì–´)
        6. **í˜„ì¬ ì„¹ì…˜ì˜ ë‚´ìš©ë§Œ ì‘ì„±í•˜ê³ , ì ˆëŒ€ ë‹¤ìŒ ì„¹ì…˜(ê²°ë¡  ë“±)ì´ë‚˜ ë§ˆë¬´ë¦¬ ë©˜íŠ¸ë¥¼ ë¯¸ë¦¬ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”.**

        [ì´ì „ê¹Œì§€ ë‚´ìš© ìš”ì•½(ë¬¸ë§¥ ì°¸ê³ ìš©)]
${finalScript.length > 500 ? finalScript.substring(finalScript.length - 500) : finalScript} ... (ì§ì „ ë‚´ìš©)

ì˜¤ì§ ëŒ€ë³¸ ë³¸ë¬¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.`;

                try {
                    // 60ì´ˆ íƒ€ì„ì•„ì›ƒ ë ˆì´ìŠ¤
                    const fetchPromise = API.gemini.generate(sectionPrompt, { temperature: 0.7, maxTokens: 4096 });
                    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 90000));

                    const result = await Promise.race([fetchPromise, timeoutPromise]);

                    if (result.status === 'ok') {
                        const sectionText = result.text.trim();
                        // ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ë‚´ìš©ì´ í¬í•¨ëœ ê²½ìš° ê±´ë„ˆë›°ê¸°
                        if (!finalScript.includes(sectionText.substring(0, 20))) {
                            finalScript += `\n\n ** [${section.title}] **\n${sectionText} `;
                        }

                        // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
                        const textArea = document.getElementById('scriptContent');
                        if (textArea) textArea.value = finalScript;
                        updateStats();
                        console.log(`Section ${i + 1} complete.`);
                    } else {
                        console.error(`Section ${i + 1} failed`, result);
                        finalScript += `\n\n[${section.title} íŒŒíŠ¸ ìƒì„± ì‹¤íŒ¨]\n`;
                    }
                } catch (innerErr) {
                    console.error(`Error generating section ${i + 1}:`, innerErr);
                    finalScript += `\n\n[${section.title} íŒŒíŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ]\n`;
                }

                // API Rate Limit ë°©ì§€ìš© ëŒ€ê¸° (ë§ˆì§€ë§‰ ì„¹ì…˜ ì œì™¸)
                if (i < sections.length - 1) {
                    console.log(`Waiting before next section...`);
                    await new Promise(r => setTimeout(r, 1000));
                }
            }

            console.log("All sections completed.");

            // ìµœì¢… ì™„ë£Œ
            currentScript = finalScript;
            Utils.storage.set('fullScript', {
                topic: structureData?.topic || 'ì˜ìƒ',
                script: currentScript,
                timestamp: Date.now()
            });

            // [FIX] DBì— ëŒ€ë³¸ ì €ì¥ (ì¤‘ìš”: ê·¸ë˜ì•¼ ì§„í–‰ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë¨)
            if (projectId) {
                try {
                    const charCount = currentScript.length;
                    const readTime = Math.ceil(charCount / 300);
                    await API.project.saveScript(projectId, currentScript, charCount, readTime);
                    console.log("Script saved to DB successfully.");
                } catch (dbErr) {
                    console.error("Failed to save script to DB:", dbErr);
                }
            }

            Utils.showToast('ì „ì²´ ëŒ€ë³¸ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

            // ë²ˆì—­ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì²´í¬
            checkTranslationAvailability(targetLanguage);

            // [NEW] ëŒ€ë³¸ ê¸°ë°˜ ì œëª© ìë™ ìƒì„± ë° ì €ì¥
            if (!window.stopGeneration) {
                await autoGenerateTitle(projectId, currentScript);
            }

        } catch (error) {
            console.error('ìƒì„± ì˜¤ë¥˜:', error);
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        } finally {
            console.log("Process finished, resetting button.");
            Utils.setLoading(btn, false);
            document.getElementById('stopBtn').classList.add('hidden');
            window.stopGeneration = false;
        }
    }

    // ì œëª© ìë™ ìƒì„± ë° ì €ì¥ í•¨ìˆ˜
    async function autoGenerateTitle(projectId, script) {
        try {
            Utils.showToast('AIê°€ ìµœì ì˜ ì œëª©ì„ ì„ ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

            const prompt = `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ì¸ë„¤ì¼/ì œëª© ì–´ê·¸ë¡œ ì¥ì¸ì…ë‹ˆë‹¤.
ë‹¤ìŒ ëŒ€ë³¸ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í´ë¦­ë¥ (CTR)ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆëŠ” **ê°€ì¥ ê°•ë ¥í•œ í›„í‚¹ì„± ì œëª© 1ê°œ**ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ëŒ€ë³¸ ìš”ì•½]
${script.substring(0, 2000)}...

[ì¡°ê±´]
1. ë”°ì˜´í‘œ ì—†ì´ ì œëª© í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
2. 30ì ì´ë‚´ë¡œ ì§§ê³  ê°•ë ¬í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
3. í˜¸ê¸°ì‹¬ì„ ìê·¹í•˜ê±°ë‚˜ ì´ë“ì„ ê°•ì¡°í•˜ëŠ” ìŠ¤íƒ€ì¼ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
4. ì˜ˆì‹œ: "ì´ê²ƒë§Œ ì•Œë©´ ì¸ìƒì´ ë°”ë€ë‹ˆë‹¤", "99%ê°€ ëª¨ë¥´ëŠ” ì¶©ê²©ì ì¸ ì‚¬ì‹¤"
5. **ì˜¤ì§ ì œëª© 1ì¤„ë§Œ ë°˜í™˜í•˜ì„¸ìš”.**`;

            const result = await API.gemini.generate(prompt, { temperature: 0.8 });

            if (result.status === 'ok') {
                let newTitle = result.text.trim().replace(/^["']|["']$/g, ''); // ë”°ì˜´í‘œ ì œê±°
                console.log("Auto-generated Title:", newTitle);

                // í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
                await API.project.update(projectId, { video_title: newTitle });

                Utils.showToast(`ì œëª©ì´ ìë™ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${newTitle}`, 'success');

                // (ì„ íƒ) ìƒë‹¨ í—¤ë” ì—…ë°ì´íŠ¸ê°€ ê°€ëŠ¥í•˜ë‹¤ë©´ ìˆ˜í–‰ (í—¤ë”ì— ì œëª© í‘œì‹œ ê¸°ëŠ¥ì´ ìˆë‹¤ë©´)
                // const titleEl = document.getElementById('projectTitleDisplay');
                // if(titleEl) titleEl.textContent = newTitle;
            }
        } catch (e) {
            console.error("Auto title generation failed:", e);
            // ì œëª© ìƒì„± ì‹¤íŒ¨ëŠ” í¬ë¦¬í‹°ì»¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì¡°ìš©íˆ ë„˜ì–´ê° (ë¡œê·¸ë§Œ ë‚¨ê¹€)
        }
    }

    function stopAndSave() {
        if (window.confirm('ëŒ€ë³¸ ìƒì„±ì„ ê°•ì œë¡œ ì¤‘ë‹¨í•˜ê³  í˜„ì¬ê¹Œì§€ì˜ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë§ˆì§€ë§‰ ì„¹ì…˜ ìƒì„± ì‘ì—…ì€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)')) {
            window.stopGeneration = true;
            const btn = document.getElementById('stopBtn');
            btn.innerHTML = 'ğŸ›‘ ì¤‘ë‹¨ ì¤‘...';
            btn.disabled = true;
        }
    }

    function updateStats() {
        const text = document.getElementById('scriptContent').value;
        const charCount = text.length;
        const readTime = Math.ceil(charCount / 300); // ë¶„ë‹¹ 300ì ê¸°ì¤€

        document.getElementById('charCount').textContent = `${charCount.toLocaleString()} ì`;
        document.getElementById('readTime').textContent = `ì˜ˆìƒ ì½ê¸° ì‹œê°„: ${readTime} ë¶„`;
    }

    document.getElementById('scriptContent')?.addEventListener('input', updateStats);

    function copyScript() {
        const text = document.getElementById('scriptContent').value;
        Utils.copyToClipboard(text);
        Utils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function downloadScript() {
        const text = document.getElementById('scriptContent').value;
        const topic = Utils.storage.get('scriptStructure')?.topic || 'ëŒ€ë³¸';
        Utils.downloadFile(text, `${topic} _ëŒ€ë³¸.txt`);
    }

    function goToImageGen() {
        window.location.href = '/image-gen';
    }

    function goToTTS() {
        window.location.href = '/tts';
    }

    // í”„ë¡œì íŠ¸ ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;

        // 1. ëŒ€ë³¸ ë°ì´í„° ë³µêµ¬
        if (data.script && data.script.full_script) {
            currentScript = data.script.full_script;
            const textarea = document.getElementById('scriptContent');
            if (textarea) textarea.value = currentScript;

            document.getElementById('resultSection').classList.remove('hidden');
            if (window.updateStats) updateStats();

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”
            Utils.storage.set('fullScript', {
                topic: data.project?.topic || 'ì˜ìƒ',
                script: currentScript,
                timestamp: Date.now()
            });
        }

        // 2. êµ¬ì¡° ë°ì´í„° ë³µêµ¬ (í•„ìš”ì‹œ)
        if (data.script_structure) {
            Utils.storage.set('scriptStructure', data.script_structure);
        }
    });

    // ì´ˆê¸° ë¡œë“œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸
    document.addEventListener('DOMContentLoaded', () => {
        const savedScript = Utils.storage.get('fullScript');
        if (savedScript && savedScript.script) {
            currentScript = savedScript.script;
            const textarea = document.getElementById('scriptContent');
            if (textarea) textarea.value = currentScript;
            document.getElementById('resultSection').classList.remove('hidden');
            if (window.updateStats) updateStats();
        }
    });
    function checkTranslationAvailability(targetLang) {
        if (targetLang && targetLang !== 'ko') {
            const btn = document.getElementById('translateBtn');
            btn.classList.remove('hidden');
            btn.textContent = `ğŸŒ ${targetLang === 'en' ? 'ì˜ì–´' : targetLang === 'ja' ? 'ì¼ë³¸ì–´' : 'ì™¸êµ­ì–´'}ë¡œ ë²ˆì—­í•˜ê¸°`;
            btn.dataset.lang = targetLang;
        }
    }

    async function translateScript() {
        const btn = document.getElementById('translateBtn');
        const targetLang = btn.dataset.lang;
        const script = document.getElementById('scriptContent').value;

        if (!script) return;

        if (!confirm('í˜„ì¬ ëŒ€ë³¸ì„ ë²ˆì—­í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°ì¡´ ë‚´ìš©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)')) return;

        const originalText = btn.innerHTML;
        Utils.setLoading(btn, true, 'ë²ˆì—­ ì¤‘...');

        try {
            const response = await fetch('/api/gemini/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: script,
                    target_language: targetLang
                })
            });

            const result = await response.json();

            if (result.status === 'ok') {
                const translated = result.translated_text;
                document.getElementById('scriptContent').value = translated;
                currentScript = translated;
                updateStats(); // ê¸€ììˆ˜ ì—…ë°ì´íŠ¸

                // ì €ì¥
                const topic = document.getElementById('structureTopic').value || 'ì˜ìƒ';
                Utils.storage.set('fullScript', {
                    topic: topic,
                    script: translated,
                    timestamp: Date.now()
                });

                // DB ì €ì¥ (ì„ íƒ ì‚¬í•­, ìœ ì €ê°€ ì›í•  ë•Œ ì €ì¥í•˜ê²Œ ë†”ë‘˜ ìˆ˜ë„ ìˆì§€ë§Œ ì¼ë‹¨ ìë™ ì €ì¥ì´ ì—†ìœ¼ë¯€ë¡œ)

                Utils.showToast('ë²ˆì—­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                throw new Error(result.error);
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ë²ˆì—­ ì‹¤íŒ¨: ' + e.message, 'error');
        } finally {
            Utils.setLoading(btn, false);
            btn.innerHTML = originalText;
        }
    }

    // í”„ë¡œì íŠ¸ ë¡œë“œ ì‹œì—ë„ ì–¸ì–´ ì²´í¬
    window.addEventListener('projectChanged', async (e) => {
        const projectId = e.detail.projectId;
        try {
            const projectFull = await API.project.getFull(projectId);
            if (projectFull && projectFull.settings && projectFull.settings.target_language) {
                checkTranslationAvailability(projectFull.settings.target_language);
            }
        } catch (e) { }
    });
</script>
{% endblock %}