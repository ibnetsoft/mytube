{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">âœï¸</span>
        <div>
            <h1>ëŒ€ë³¸ ìƒì„±</h1>
            <p>AIê°€ ì™„ì„±ëœ ëŒ€ë³¸ì„ ì‘ì„±í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- êµ¬ì¡° ì •ë³´ -->
<div id="structureInfo" class="card mb-6 hidden">
    <h3 class="font-bold text-gray-800 dark:text-white mb-2">ğŸ“‹ ëŒ€ë³¸ êµ¬ì¡° ê¸°ë°˜</h3>
    <p id="structureTopic" class="text-gray-600 dark:text-gray-400"></p>
</div>

<!-- ëŒ€ë³¸ ì˜µì…˜ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ ëŒ€ë³¸ ì˜µì…˜</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ëŒ€ë³¸ ìŠ¤íƒ€ì¼</label>
            <select id="scriptStyle" class="input-field">
                <option value="narration">ë‚˜ë ˆì´ì…˜í˜• (ì„¤ëª… ìœ„ì£¼)</option>
                <option value="conversational">ëŒ€í™”í˜• (ì¹œê·¼í•œ ë§íˆ¬)</option>
                <option value="storytelling">ìŠ¤í† ë¦¬í…”ë§í˜• (ì´ì•¼ê¸° ì „ê°œ)</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í¬í•¨ ìš”ì†Œ</label>
            <div class="flex gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="includeHooks" checked class="rounded">
                    <span class="text-sm text-gray-700 dark:text-gray-300">í›„í‚¹ ë©˜íŠ¸</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="includeCTA" checked class="rounded">
                    <span class="text-sm text-gray-700 dark:text-gray-300">CTA</span>
                </label>
            </div>
        </div>
    </div>
</div>

<!-- ìƒì„± ë²„íŠ¼ -->
<button onclick="generateScript()" id="generateBtn"
    class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg mb-6">
    <span>âœï¸</span>
    <span>ì „ì²´ ëŒ€ë³¸ ìƒì„±í•˜ê¸°</span>
</button>

<!-- ê²°ê³¼ ì˜ì—­ -->
<div id="resultSection" class="hidden">
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800 dark:text-white">ğŸ“ ìƒì„±ëœ ëŒ€ë³¸</h3>
            <div class="flex gap-2">
                <button onclick="copyScript()" class="btn-secondary text-sm">ğŸ“‹ ë³µì‚¬</button>
                <button onclick="downloadScript()" class="btn-secondary text-sm">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <div class="mb-4 flex gap-4 text-sm text-gray-500">
            <span id="charCount">0ì</span>
            <span id="readTime">ì˜ˆìƒ ì½ê¸° ì‹œê°„: 0ë¶„</span>
        </div>

        <textarea id="scriptContent" class="input-field font-mono" rows="20"></textarea>

        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700 flex gap-4">
            <button onclick="goToImageGen()" class="flex-1 btn-primary py-4 flex items-center justify-center gap-3">
                <span>ğŸ–¼ï¸</span>
                <span>ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„±</span>
                <span>â†’</span>
            </button>
            <button onclick="goToTTS()" class="flex-1 btn-secondary py-4 flex items-center justify-center gap-3">
                <span>ğŸ”Š</span>
                <span>TTS ìƒì„±</span>
                <span>â†’</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentScript = '';

    document.addEventListener('DOMContentLoaded', () => {
        const structureData = Utils.storage.get('scriptStructure');
        if (structureData) {
            document.getElementById('structureInfo').classList.remove('hidden');
            document.getElementById('structureTopic').textContent = structureData.topic;
        }
    });

    async function generateScript() {
        const structureData = Utils.storage.get('scriptStructure');
        const style = document.getElementById('scriptStyle').value;
        const includeHooks = document.getElementById('includeHooks').checked;
        const includeCTA = document.getElementById('includeCTA').checked;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ëŒ€ë³¸ ìƒì„± ì¤‘...');

        const prompt = `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ êµ¬ì¡°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì„±ëœ ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ëŒ€ë³¸ êµ¬ì¡°]
${structureData?.structure || 'ì¼ë°˜ì ì¸ ìœ íŠœë¸Œ ì˜ìƒ ëŒ€ë³¸'}

[ìŠ¤íƒ€ì¼]
${style === 'narration' ? 'ë‚˜ë ˆì´ì…˜í˜• - ì„¤ëª… ìœ„ì£¼ë¡œ ì‘ì„±' : style === 'conversational' ? 'ëŒ€í™”í˜• - ì‹œì²­ìì—ê²Œ ë§í•˜ë“¯ì´ ì¹œê·¼í•˜ê²Œ' : 'ìŠ¤í† ë¦¬í…”ë§í˜• - ì´ì•¼ê¸°ë¥¼ ì „ê°œí•˜ë“¯ì´'}

[ìš”êµ¬ì‚¬í•­]
- ${includeHooks ? 'ê° ì„¹ì…˜ ì‹œì‘ì— í›„í‚¹ ë©˜íŠ¸ í¬í•¨' : 'í›„í‚¹ ë©˜íŠ¸ ìµœì†Œí™”'}
- ${includeCTA ? 'ì ì ˆí•œ ìœ„ì¹˜ì— êµ¬ë…/ì¢‹ì•„ìš” CTA í¬í•¨' : 'CTA ìµœì†Œí™”'}
- ìì—°ìŠ¤ëŸ¬ìš´ ë§íˆ¬ë¡œ ì‘ì„±
- [ì¥ë©´ ì„¤ëª…]ì´ë‚˜ (íš¨ê³¼ìŒ) ê°™ì€ ì—°ì¶œ ì§€ì‹œ í¬í•¨
- ì‹¤ì œë¡œ ì½ì„ ìˆ˜ ìˆëŠ” ëŒ€ë³¸ í˜•íƒœë¡œ ì‘ì„±

ëŒ€ë³¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.`;

        try {
            const result = await API.gemini.generate(prompt, { temperature: 0.8, maxTokens: 8192 });

            if (result.status === 'ok') {
                currentScript = result.text;
                document.getElementById('scriptContent').value = result.text;
                document.getElementById('resultSection').classList.remove('hidden');
                updateStats();

                Utils.storage.set('fullScript', {
                    topic: structureData?.topic || 'ì˜ìƒ',
                    script: result.text,
                    timestamp: Date.now()
                });
            } else {
                Utils.showToast('ìƒì„± ì‹¤íŒ¨', 'error');
            }
        } catch (error) {
            console.error('ìƒì„± ì˜¤ë¥˜:', error);
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function updateStats() {
        const text = document.getElementById('scriptContent').value;
        const charCount = text.length;
        const readTime = Math.ceil(charCount / 300); // ë¶„ë‹¹ 300ì ê¸°ì¤€

        document.getElementById('charCount').textContent = `${charCount.toLocaleString()}ì`;
        document.getElementById('readTime').textContent = `ì˜ˆìƒ ì½ê¸° ì‹œê°„: ${readTime}ë¶„`;
    }

    document.getElementById('scriptContent')?.addEventListener('input', updateStats);

    function copyScript() {
        const text = document.getElementById('scriptContent').value;
        Utils.copyToClipboard(text);
        Utils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function downloadScript() {
        const text = document.getElementById('scriptContent').value;
        const topic = Utils.storage.get('scriptStructure')?.topic || 'ëŒ€ë³¸';
        Utils.downloadFile(text, `${topic}_ëŒ€ë³¸.txt`);
    }

    function goToImageGen() {
        window.location.href = '/image-gen';
    }

    function goToTTS() {
        window.location.href = '/tts';
    }

    // í”„ë¡œì íŠ¸ ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;

        // 1. ëŒ€ë³¸ ë°ì´í„° ë³µêµ¬
        if (data.script && data.script.full_script) {
            currentScript = data.script.full_script;
            const textarea = document.getElementById('scriptContent');
            if (textarea) textarea.value = currentScript;

            document.getElementById('resultSection').classList.remove('hidden');
            if (window.updateStats) updateStats();

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”
            Utils.storage.set('fullScript', {
                topic: data.project?.topic || 'ì˜ìƒ',
                script: currentScript,
                timestamp: Date.now()
            });
        }

        // 2. êµ¬ì¡° ë°ì´í„° ë³µêµ¬ (í•„ìš”ì‹œ)
        if (data.script_structure) {
            Utils.storage.set('scriptStructure', data.script_structure);
        }
    });

    // ì´ˆê¸° ë¡œë“œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸
    document.addEventListener('DOMContentLoaded', () => {
        const savedScript = Utils.storage.get('fullScript');
        if (savedScript && savedScript.script) {
            currentScript = savedScript.script;
            const textarea = document.getElementById('scriptContent');
            if (textarea) textarea.value = currentScript;
            document.getElementById('resultSection').classList.remove('hidden');
            if (window.updateStats) updateStats();
        }
    });
</script>
{% endblock %}