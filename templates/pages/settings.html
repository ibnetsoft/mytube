{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">âš™ï¸</span>
        <div>
            <h1>ì„¤ì •</h1>
            <p>API í‚¤ ë° ì•± ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- API í‚¤ ì…ë ¥ í¼ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ”‘ API í‚¤ ì„¤ì •</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•˜ë©´ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤. ì„œë²„ ì¬ì‹œì‘ ì—†ì´ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <div class="space-y-4">
        <!-- YouTube API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ“º</span>
                    <label class="font-medium text-gray-800 dark:text-white">YouTube Data API</label>
                </div>
                <span id="youtubeStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="youtubeApiKey"
                    class="flex-1 input-field text-sm"
                    placeholder="YouTube API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('youtubeApiKey')" class="btn-secondary px-3">
                    <span id="youtubeApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="youtubeKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>

        <!-- Gemini API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ¤–</span>
                    <label class="font-medium text-gray-800 dark:text-white">Gemini API</label>
                </div>
                <span id="geminiStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="geminiApiKey"
                    class="flex-1 input-field text-sm"
                    placeholder="Gemini API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('geminiApiKey')" class="btn-secondary px-3">
                    <span id="geminiApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="geminiKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>

        <!-- ElevenLabs API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ”Š</span>
                    <label class="font-medium text-gray-800 dark:text-white">ElevenLabs TTS (ì„ íƒ)</label>
                </div>
                <span id="elevenlabsStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="elevenlabsApiKey"
                    class="flex-1 input-field text-sm"
                    placeholder="ElevenLabs API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('elevenlabsApiKey')" class="btn-secondary px-3">
                    <span id="elevenlabsApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="elevenlabsKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>
    </div>

    <!-- ì €ì¥ ë²„íŠ¼ -->
    <div class="mt-6 flex gap-3">
        <button onclick="saveApiKeys()" class="btn-primary px-6">
            ğŸ’¾ API í‚¤ ì €ì¥
        </button>
        <button onclick="loadApiKeys()" class="btn-secondary">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
    </div>
</div>

<!-- API ì—°ê²° ìƒíƒœ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“¡ API ì—°ê²° ìƒíƒœ</h3>
    <div id="apiStatusList" class="space-y-3">
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ“º</span>
                <span>YouTube Data API</span>
            </div>
            <span id="youtubeConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ¤–</span>
                <span>Gemini API</span>
            </div>
            <span id="geminiConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ”Š</span>
                <span>ElevenLabs TTS</span>
            </div>
            <span id="elevenlabsConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
    </div>
</div>

<!-- API í‚¤ ë°œê¸‰ ë§í¬ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ”— API í‚¤ ë°œê¸‰</h3>
    <div class="space-y-3">
        <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ“º</span>
                <span>YouTube Data API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
        <a href="https://aistudio.google.com/apikey" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ¤–</span>
                <span>Gemini API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
        <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ”Š</span>
                <span>ElevenLabs API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
    </div>
</div>

<!-- ë°ì´í„° ê´€ë¦¬ -->
<div class="card">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ—‚ï¸ ë¡œì»¬ ë°ì´í„° ê´€ë¦¬</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
    </p>
    <div class="flex gap-3">
        <button onclick="exportData()" class="btn-secondary">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button onclick="clearData()" class="btn-secondary text-red-600">ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // í‚¤ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
    function toggleKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(inputId + '-eye');

        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.textContent = 'ğŸ™ˆ';
        } else {
            input.type = 'password';
            eyeIcon.textContent = 'ğŸ‘ï¸';
        }
    }

    // API í‚¤ ìƒíƒœ ë¡œë“œ
    async function loadApiKeys() {
        try {
            const keys = await API.apiKeys.get();

            // YouTube
            if (keys.youtube) {
                document.getElementById('youtubeStatus').innerHTML = keys.youtube.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('youtubeKeyMasked').textContent = keys.youtube.masked
                    ? `í˜„ì¬ í‚¤: ${keys.youtube.masked}`
                    : '';
            }

            // Gemini
            if (keys.gemini) {
                document.getElementById('geminiStatus').innerHTML = keys.gemini.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('geminiKeyMasked').textContent = keys.gemini.masked
                    ? `í˜„ì¬ í‚¤: ${keys.gemini.masked}`
                    : '';
            }

            // ElevenLabs
            if (keys.elevenlabs) {
                document.getElementById('elevenlabsStatus').innerHTML = keys.elevenlabs.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì •</span>';
                document.getElementById('elevenlabsKeyMasked').textContent = keys.elevenlabs.masked
                    ? `í˜„ì¬ í‚¤: ${keys.elevenlabs.masked}`
                    : '';
            }

        } catch (e) {
            console.error('API í‚¤ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
    }

    // API í‚¤ ì €ì¥
    async function saveApiKeys() {
        const keys = {};

        const youtube = document.getElementById('youtubeApiKey').value.trim();
        const gemini = document.getElementById('geminiApiKey').value.trim();
        const elevenlabs = document.getElementById('elevenlabsApiKey').value.trim();

        if (youtube) keys.youtube = youtube;
        if (gemini) keys.gemini = gemini;
        if (elevenlabs) keys.elevenlabs = elevenlabs;

        if (Object.keys(keys).length === 0) {
            Utils.showToast('ì €ì¥í•  API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        try {
            const result = await API.apiKeys.save(keys);

            if (result.status === 'ok') {
                Utils.showToast(result.message, 'success');

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('youtubeApiKey').value = '';
                document.getElementById('geminiApiKey').value = '';
                document.getElementById('elevenlabsApiKey').value = '';

                // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                await loadApiKeys();
                await checkApiConnection();
            } else {
                Utils.showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error('API í‚¤ ì €ì¥ ì˜¤ë¥˜:', e);
            Utils.showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // API ì—°ê²° ìƒíƒœ í™•ì¸
    async function checkApiConnection() {
        try {
            const health = await API.health();

            document.getElementById('youtubeConnectionStatus').innerHTML = health.apis?.youtube
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('geminiConnectionStatus').innerHTML = health.apis?.gemini
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('elevenlabsConnectionStatus').innerHTML = health.apis?.elevenlabs
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì • (ì„ íƒ)</span>';

        } catch (e) {
            console.error('ì—°ê²° ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', e);
        }
    }

    function exportData() {
        const data = {
            analysisData: Utils.storage.get('analysisData'),
            scriptStructure: Utils.storage.get('scriptStructure'),
            fullScript: Utils.storage.get('fullScript'),
            imagePrompts: Utils.storage.get('imagePrompts'),
            exportedAt: new Date().toISOString()
        };

        Utils.downloadFile(JSON.stringify(data, null, 2), 'wingsaistudio_backup.json', 'application/json');
        Utils.showToast('ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
    }

    function clearData() {
        if (!confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(API í‚¤ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

        Utils.storage.remove('analysisData');
        Utils.storage.remove('scriptStructure');
        Utils.storage.remove('fullScript');
        Utils.storage.remove('imagePrompts');
        Utils.storage.remove('ttsAudio');

        Utils.showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        loadApiKeys();
        checkApiConnection();
    });
</script>
{% endblock %}
