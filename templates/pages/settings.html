{% extends "base.html" %}

{% block content %}


<div class="h-[calc(100vh-80px)] overflow-y-auto p-4 custom-scrollbar">
    <!-- Header with Actions -->
    <div
        class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 dark:bg-gray-900 z-10 py-2 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-bold flex items-center gap-2">
            <span>âš™ï¸ í™˜ê²½ ì„¤ì •</span>
        </h2>
        <div class="flex gap-2">
            <button onclick="loadAllSettings()" class="btn-secondary py-1.5 px-3 text-xs flex items-center gap-1">
                <span>ğŸ”„</span> ìƒˆë¡œê³ ì¹¨
            </button>
            <button onclick="saveAllSettings()"
                class="btn-primary py-1.5 px-4 text-xs font-bold shadow-sm flex items-center gap-1">
                <span>ğŸ’¾</span> ë³€ê²½ì‚¬í•­ ì €ì¥
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex space-x-1 overflow-x-auto custom-scrollbar">
            {% if is_independent %}
            <button onclick="switchTab('api')" id="tab-api" class="tab-button active">
                ğŸ”‘ API ì„¤ì •
            </button>
            {% endif %}
            <button onclick="switchTab('content')" id="tab-content"
                class="tab-button {% if not is_independent %}active{% endif %}">
                ğŸ¨ ì½˜í…ì¸  ì„¤ì •
            </button>
            <button onclick="switchTab('image-styles')" id="tab-image-styles" class="tab-button">
                ğŸ–¼ï¸ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼
            </button>
            <button onclick="switchTab('script-styles')" id="tab-script-styles" class="tab-button">
                ğŸ“ ëŒ€ë³¸ ìŠ¤íƒ€ì¼
            </button>
            <button onclick="switchTab('thumbnail-styles')" id="tab-thumbnail-styles" class="tab-button">
                ğŸ–¼ï¸ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼
            </button>
            <button onclick="switchTab('data')" id="tab-data" class="tab-button">
                ğŸ—‚ï¸ ë°ì´í„° ê´€ë¦¬
            </button>
        </div>
    </div>

    <!-- Tab Content Container -->
    <div id="settings-content">
        <!-- API Settings Tab -->
        {% if is_independent %}
        <div id="tab-content-api" class="tab-content active">
            {% else %}
            <div id="tab-content-api" class="tab-content">
                {% endif %}
                <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
                    <!-- Left Column: API Keys & Connections (5/12) -->
                    <div class="xl:col-span-5 space-y-4">

                        <!-- API Keys & Connectivity -->
                        <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                            <h3
                                class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-3 flex items-center justify-between">
                                <span>ğŸ”‘ API ì¸ì¦ ë° ì—°ê²° ìƒíƒœ</span>
                                <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
                                    class="text-[10px] text-blue-500 hover:underline">Console ë°”ë¡œê°€ê¸° â†—</a>
                            </h3>

                            <div class="space-y-3">
                                <!-- YouTube -->
                                <div
                                    class="bg-gray-50 dark:bg-gray-800/50 rounded-md p-2 border border-gray-100 dark:border-gray-700">
                                    <div class="flex items-center justify-between mb-1">
                                        <label
                                            class="text-xs font-bold text-gray-700 dark:text-white flex items-center gap-1">
                                            <span>ğŸ“º YouTube Data API</span>
                                            <span id="youtubeStatus"
                                                class="text-[10px] font-normal text-gray-400"></span>
                                        </label>
                                        <span id="youtubeConnectionStatus"
                                            class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1.5 rounded text-gray-500">ëŒ€ê¸°</span>
                                    </div>
                                    <div class="flex gap-1">
                                        <input type="password" id="youtubeApiKey"
                                            class="flex-1 input-field text-xs py-1 px-2 h-8" placeholder="API Key ì…ë ¥">
                                        <button onclick="toggleKeyVisibility('youtubeApiKey')"
                                            class="btn-secondary px-2 h-8 text-xs">ğŸ‘ï¸</button>
                                    </div>
                                    <p id="youtubeKeyMasked" class="text-[10px] text-gray-400 mt-0.5 truncate h-3"></p>
                                </div>

                                <!-- Gemini -->
                                <div
                                    class="bg-gray-50 dark:bg-gray-800/50 rounded-md p-2 border border-gray-100 dark:border-gray-700">
                                    <div class="flex items-center justify-between mb-1">
                                        <label
                                            class="text-xs font-bold text-gray-700 dark:text-white flex items-center gap-1">
                                            <span>ğŸ¤– Gemini API</span>
                                            <span id="geminiStatus"
                                                class="text-[10px] font-normal text-gray-400"></span>
                                        </label>
                                        <span id="geminiConnectionStatus"
                                            class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1.5 rounded text-gray-500">ëŒ€ê¸°</span>
                                    </div>
                                    <div class="flex gap-1">
                                        <input type="password" id="geminiApiKey"
                                            class="flex-1 input-field text-xs py-1 px-2 h-8" placeholder="API Key ì…ë ¥">
                                        <button onclick="toggleKeyVisibility('geminiApiKey')"
                                            class="btn-secondary px-2 h-8 text-xs">ğŸ‘ï¸</button>
                                    </div>
                                    <p id="geminiKeyMasked" class="text-[10px] text-gray-400 mt-0.5 truncate h-3"></p>
                                </div>

                                <!-- ElevenLabs -->
                                <div
                                    class="bg-gray-50 dark:bg-gray-800/50 rounded-md p-2 border border-gray-100 dark:border-gray-700">
                                    <div class="flex items-center justify-between mb-1">
                                        <label
                                            class="text-xs font-bold text-gray-700 dark:text-white flex items-center gap-1">
                                            <span>ğŸ”Š ElevenLabs API</span>
                                            <span class="text-[10px] text-gray-400 font-normal">(ì„ íƒ)</span>
                                            <span id="elevenlabsStatus"
                                                class="text-[10px] font-normal text-gray-400"></span>
                                        </label>
                                        <span id="elevenlabsConnectionStatus"
                                            class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1.5 rounded text-gray-500">ë¯¸ì„¤ì •</span>
                                    </div>
                                    <div class="flex gap-1">
                                        <input type="password" id="elevenlabsApiKey"
                                            class="flex-1 input-field text-xs py-1 px-2 h-8" placeholder="API Key ì…ë ¥">
                                        <button onclick="toggleKeyVisibility('elevenlabsApiKey')"
                                            class="btn-secondary px-2 h-8 text-xs">ğŸ‘ï¸</button>
                                    </div>
                                    <p id="elevenlabsKeyMasked" class="text-[10px] text-gray-400 mt-0.5 truncate h-3">
                                    </p>
                                </div>

                                <!-- Replicate -->
                                <div
                                    class="bg-gray-50 dark:bg-gray-800/50 rounded-md p-2 border border-gray-100 dark:border-gray-700">
                                    <div class="flex items-center justify-between mb-1">
                                        <label
                                            class="text-xs font-bold text-gray-700 dark:text-white flex items-center gap-1">
                                            <span>ğŸš€ Replicate API</span>
                                            <span class="text-[10px] text-gray-400 font-normal">(AIì˜ìƒ)</span>
                                            <span id="replicateStatus"
                                                class="text-[10px] font-normal text-gray-400"></span>
                                        </label>
                                        <span id="replicateConnectionStatus"
                                            class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1.5 rounded text-gray-500">ë¯¸ì„¤ì •</span>
                                    </div>
                                    <div class="flex gap-1">
                                        <input type="password" id="replicateApiKey"
                                            class="flex-1 input-field text-xs py-1 px-2 h-8" placeholder="API Token ì…ë ¥">
                                        <button onclick="toggleKeyVisibility('replicateApiKey')"
                                            class="btn-secondary px-2 h-8 text-xs">ğŸ‘ï¸</button>
                                    </div>
                                    <p id="replicateKeyMasked" class="text-[10px] text-gray-400 mt-0.5 truncate h-3">
                                    </p>
                                </div>
                            </div>

                            <div
                                class="mt-3 pt-3 border-t border-gray-100 dark:border-gray-700 flex justify-between text-[10px]">
                                <a href="https://aistudio.google.com/apikey" target="_blank"
                                    class="text-blue-500 hover:underline flex items-center gap-1">
                                    ğŸ”‘ Gemini í‚¤ ë°œê¸‰
                                </a>
                                <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank"
                                    class="text-gray-500 hover:underline flex items-center gap-1">
                                    ğŸ”‘ ElevenLabs í‚¤ ë°œê¸‰
                                </a>
                                <a href="https://replicate.com/account/api-tokens" target="_blank"
                                    class="text-gray-500 hover:underline flex items-center gap-1">
                                    ğŸ”‘ Replicate í‚¤ ë°œê¸‰
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End API Tab -->

            <!-- Content Settings Tab -->
            <div id="tab-content-content" class="tab-content {% if not is_independent %}active{% endif %}">
                <div class="grid grid-cols-1 gap-4">

                    <!-- Channel Management -->
                    {% if is_independent %}
                    <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-sm text-gray-800 dark:text-gray-100">ğŸ“º ìœ íŠœë¸Œ ì±„ë„ ê´€ë¦¬</h3>
                            <span class="text-[10px] text-gray-400">ì—…ë¡œë“œ ëŒ€ìƒ ì±„ë„</span>
                        </div>

                        <div id="channelList"
                            class="space-y-2 mb-3 max-h-40 overflow-y-auto custom-scrollbar bg-gray-50 dark:bg-gray-800/30 rounded p-1">
                            <!-- Loaded via JS -->
                            <p class="text-gray-400 text-xs text-center py-4">ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>

                        <div
                            class="flex gap-2 p-2 bg-gray-50 dark:bg-gray-800 rounded border border-gray-100 dark:border-gray-700">
                            <input type="text" id="newChannelName" class="input-field text-xs flex-1 h-8"
                                placeholder="ì±„ë„ëª… (ë‚´ ë¸Œì´ë¡œê·¸)">
                            <input type="text" id="newChannelHandle" class="input-field text-xs w-24 h-8"
                                placeholder="@handle">
                            <button onclick="addChannel()"
                                class="btn-primary py-0 px-3 text-xs h-8 whitespace-nowrap">ì¶”ê°€</button>
                        </div>
                        <input type="text" id="newChannelDesc" class="input-field text-xs w-full mt-2 h-7"
                            placeholder="ì±„ë„ ì„¤ëª… (ì„ íƒ)">
                    </div>
                    {% else %}
                    <div
                        class="card p-6 shadow-sm border border-blue-200 bg-blue-50 dark:bg-blue-900/10 dark:border-blue-800 text-center">
                        <h3 class="font-bold text-blue-700 dark:text-blue-300 mb-2">ğŸš€ ë…ë¦½ íšŒì› ì „ìš© ê¸°ëŠ¥</h3>
                        <p class="text-xs text-blue-600/70 dark:text-blue-400/70 mb-4">ì§ì ‘ ì±„ë„ ê´€ë¦¬ ë° ë¬´ì œí•œ ì—…ë¡œë“œë¥¼ ì›í•˜ì‹œë‚˜ìš”?</p>
                        <a href="https://mytube-ashy-seven.vercel.app/dashboard" target="_blank"
                            class="btn-primary py-2 px-6 inline-block text-xs">ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ í•˜ëŸ¬ê°€ê¸°</a>
                    </div>
                    {% endif %}

                    <!-- Content Settings (Voice & Scripts) -->
                    <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-3">ğŸ¨ ì½˜í…ì¸  ìƒì„± ì„¤ì •</h3>

                        <!-- Platform Mode -->
                        <div class="mb-5 border-b border-gray-100 dark:border-gray-700 pb-4">
                            <label class="text-xs font-bold text-gray-700 dark:text-white mb-2 block">ğŸ–¥ï¸ í”Œë«í¼ ëª¨ë“œ</label>
                            <input type="hidden" id="appMode" value="longform">
                            <div class="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1 w-fit">
                                <button id="btnModeLong" onclick="setAppMode('longform')"
                                    class="px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white dark:bg-gray-600 shadow text-gray-800 dark:text-white">
                                    ğŸï¸ ë¡±í¼ (ê¸°ë³¸)
                                </button>
                                <button id="btnModeShort" onclick="setAppMode('shorts')"
                                    class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                                    ğŸ“± ì‡¼ì¸ 
                                </button>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-2">
                                * ëª¨ë“œë¥¼ ë³€ê²½í•˜ë©´ ë©”ë‰´ êµ¬ì„±ê³¼ ì˜ìƒ ìƒì„± ì„¤ì •ì´ í•´ë‹¹ í¬ë§·ì— ìµœì í™”ë©ë‹ˆë‹¤.
                            </p>
                        </div>

                        <!-- [NEW] Template Image (Overlay) -->
                        <div class="mb-5 border-b border-gray-100 dark:border-gray-700 pb-4">
                            <label
                                class="text-xs font-bold text-gray-700 dark:text-white mb-2 flex justify-between items-center">
                                <span>ğŸ–¼ï¸ í…œí”Œë¦¿ ì´ë¯¸ì§€ (9:16 ì˜¤ë²„ë ˆì´)</span>
                                <span class="text-[10px] text-gray-400 font-normal">.png íˆ¬ëª… ë°°ê²½ ê¶Œì¥</span>
                            </label>

                            <div class="flex items-start gap-4">
                                <!-- Preview -->
                                <div
                                    class="w-16 h-28 bg-gray-100 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 overflow-hidden flex items-center justify-center relative group">
                                    <img id="templatePreview" src="" class="w-full h-full object-cover hidden">
                                    <div id="templatePlaceholder" class="text-gray-300 text-[10px] text-center p-1">No
                                        Image
                                    </div>
                                    <button onclick="deleteTemplate()" id="btnDeleteTemplate"
                                        class="hidden absolute inset-0 bg-black/50 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>

                                <!-- Upload Control -->
                                <div class="flex-1">
                                    <input type="file" id="templateImageInput" accept="image/png, image/jpeg"
                                        class="hidden" onchange="uploadTemplate(this)">
                                    <button onclick="document.getElementById('templateImageInput').click()"
                                        class="btn-secondary w-full py-2 text-xs mb-2 border-dashed border-2">
                                        ğŸ“ ì´ë¯¸ì§€ ì—…ë¡œë“œ (Upload)
                                    </button>
                                    <p class="text-[10px] text-gray-400 leading-tight">
                                        * ì‡¼ì¸  ì˜ìƒ ìƒì„± ì‹œ, ì „ì²´ í”„ë ˆì„ ìœ„ì— ì˜¤ë²„ë ˆì´ë¡œ ì ìš©ë©ë‹ˆë‹¤.<br>
                                        * í”„ë ˆì„, ë¡œê³ , í…Œë‘ë¦¬ ì¥ì‹ ë“±ì— í™œìš©í•˜ì„¸ìš”.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Voice -->
                            <div>
                                <label class="text-xs font-bold text-gray-700 dark:text-white mb-2 block">ğŸ—£ï¸ ê¸°ë³¸ ëª©ì†Œë¦¬
                                    (Gemini)</label>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <select id="geminiVoice" class="input-field text-xs h-8"></select>
                                    <select id="geminiLanguage" class="input-field text-xs h-8"></select>
                                </div>
                                <textarea id="geminiStylePrompt" rows="2" class="input-field w-full text-xs"
                                    placeholder="ìŒì„± ìŠ¤íƒ€ì¼ (ì˜ˆ: ì°¨ë¶„í•˜ê³  ì‹ ë¢°ê° ìˆëŠ” í†¤)"></textarea>
                            </div>

                            <!-- Script Prompts -->
                            <div class="space-y-4">
                                <!-- [NEW] Main Script Writing Prompt -->
                                <div
                                    class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 border border-purple-200 dark:border-purple-800">
                                    <label
                                        class="text-xs font-bold text-purple-700 dark:text-purple-300 mb-2 flex items-center gap-2">
                                        <span>âœï¸ ëŒ€ë³¸ ì‘ì„± ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸</span>
                                        <span class="text-[10px] text-purple-500 dark:text-purple-400 font-normal">ëŒ€ë³¸ ìƒì„±
                                            ì‹œ AIì—ê²Œ
                                            ì „ë‹¬ë˜ëŠ” í•µì‹¬ ì§€ì¹¨</span>
                                    </label>
                                    <textarea id="promptScriptMaster" class="input-field w-full text-xs font-mono"
                                        rows="8" placeholder="ëŒ€ë³¸ ì‘ì„± ì‹œ AIì—ê²Œ ì „ë‹¬í•  ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                                    <div class="flex justify-between items-center mt-2">
                                        <p class="text-[10px] text-purple-500">* ì´ í”„ë¡¬í”„íŠ¸ëŠ” ëª¨ë“  ëŒ€ë³¸ ìƒì„±ì— ì ìš©ë©ë‹ˆë‹¤.</p>
                                        <button onclick="resetMasterPrompt()"
                                            class="text-[10px] text-purple-600 hover:underline">ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs font-bold text-gray-700 dark:text-white mb-1 block">ğŸ“œ ì‹œë‹ˆì–´ ì‚¬ì—°
                                        ìŠ¤íƒ€ì¼
                                        í”„ë¡¬í”„íŠ¸ (New)</label>
                                    <textarea id="promptSeniorStory" class="input-field w-full text-xs" rows="3"
                                        placeholder="ì¤‘ì¥ë…„ì¸µ ê³µê° ì‚¬ì—° í†¤ì•¤ë§¤ë„ˆ ì§€ì¹¨..."></textarea>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-700 dark:text-white mb-1 block">ğŸ“œ ì˜›ë‚  ì´ì•¼ê¸°
                                        ìŠ¤íƒ€ì¼
                                        í”„ë¡¬í”„íŠ¸</label>
                                    <textarea id="promptStory" class="input-field w-full text-xs" rows="2"
                                        placeholder="êµ¬ì—°ë™í™” í†¤ì•¤ë§¤ë„ˆ ì§€ì¹¨..."></textarea>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-700 dark:text-white mb-1 block">ğŸ“œ ë‰´ìŠ¤ ìŠ¤íƒ€ì¼
                                        í”„ë¡¬í”„íŠ¸</label>
                                    <textarea id="promptNews" class="input-field w-full text-xs" rows="2"
                                        placeholder="ë‰´ìŠ¤ í†¤ì•¤ë§¤ë„ˆ ì§€ì¹¨..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Content Tab -->

            <!-- Image Styles Tab -->
            <div id="tab-content-image-styles" class="tab-content">
                <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3
                        class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-3 flex items-center justify-between">
                        <span>ğŸ¨ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ ì„¤ì •</span>
                        <button onclick="loadStylePresets()" class="text-[10px] text-blue-500 hover:underline">ğŸ”„ ì„œë²„
                            ë™ê¸°í™”</button>
                    </h3>

                    <!-- [NEW] Add Custom Style Form -->
                    <div
                        class="bg-blue-50 dark:bg-blue-900/10 p-3 rounded-lg border border-blue-100 dark:border-blue-800 mb-4">
                        <h4 class="text-xs font-bold text-blue-700 dark:text-blue-300 mb-2">â• ìƒˆ ìŠ¤íƒ€ì¼ ì¶”ê°€ (ì‚¬ìš©ì ì •ì˜)</h4>
                        <div class="space-y-2">
                            <div class="flex gap-2">
                                <input type="text" id="customStyleName" class="input-field flex-1 text-xs"
                                    placeholder="ìŠ¤íƒ€ì¼ ì´ë¦„ (ì˜ˆ: my_sketch, dark_fantasy)">
                                <button onclick="document.getElementById('customStyleImage').click()"
                                    class="btn-secondary px-3 py-1.5 text-xs whitespace-nowrap">
                                    ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ
                                </button>
                                <input type="file" id="customStyleImage" accept="image/*" class="hidden"
                                    onchange="document.getElementById('customStyleImgName').textContent = this.files[0]?.name || ''">
                            </div>
                            <p id="customStyleImgName" class="text-[10px] text-gray-500 pl-1 h-3 truncate"></p>

                            <textarea id="customStylePrompt" class="input-field w-full text-xs h-16"
                                placeholder="ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ (ì˜ˆ: highly detailed, cinematic lighting, 8k resolution)"></textarea>

                            <div class="flex justify-end">
                                <button onclick="addCustomStylePreset()"
                                    class="btn-primary px-4 py-1.5 text-xs font-bold bg-blue-600 hover:bg-blue-700">
                                    ì¶”ê°€í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="stylePresetList" class="space-y-3">
                        <!-- Loaded via JS -->
                        <div class="text-center py-4 text-gray-400 text-xs">ìŠ¤íƒ€ì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-3 leading-tight">
                        * ê° ìŠ¤íƒ€ì¼ ì„ íƒ ì‹œ AIì—ê²Œ ì „ë‹¬ë  ê¸°ë³¸ ë¬˜ì‚¬ í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤.<br>
                        * ìˆ˜ì • í›„ 'ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
            <!-- End Image Styles Tab -->

            <!-- Script Styles Tab -->
            <div id="tab-content-script-styles" class="tab-content">
                <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3
                        class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-3 flex items-center justify-between">
                        <span>ğŸ“ ëŒ€ë³¸ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ ì„¤ì •</span>
                        <button onclick="loadScriptStylePresets()" class="text-[10px] text-blue-500 hover:underline">ğŸ”„
                            ì„œë²„
                            ë™ê¸°í™”</button>
                    </h3>
                    <div id="scriptStylePresetList" class="space-y-3">
                        <!-- Loaded via JS -->
                        <div class="text-center py-4 text-gray-400 text-xs">ëŒ€ë³¸ ìŠ¤íƒ€ì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-3 leading-tight">
                        * ëŒ€ë³¸ ìƒì„± ì‹œ ê° ìŠ¤íƒ€ì¼ë³„ë¡œ AIì—ê²Œ ì „ë‹¬ë  ì‘ì„± ì§€ì¹¨ì…ë‹ˆë‹¤.<br>
                        * ìˆ˜ì • í›„ 'ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.<br>
                        * 'script_master'ëŠ” ëŒ€ë³¸ ì‘ì„±ì˜ ì „ì²´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì •ì˜í•˜ëŠ” ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
            <!-- End Script Styles Tab -->

            <!-- Thumbnail Styles Tab -->
            <div id="tab-content-thumbnail-styles" class="tab-content">
                <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3
                        class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-3 flex items-center justify-between">
                        <span>ğŸ–¼ï¸ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ ì„¤ì •</span>
                        <button onclick="loadThumbnailStylePresets()"
                            class="text-[10px] text-blue-500 hover:underline">ğŸ”„
                            ì„œë²„
                            ë™ê¸°í™”</button>
                    </h3>

                    <!-- [NEW] Add Custom Thumbnail Style -->
                    <div
                        class="mb-4 p-3 bg-blue-50/50 dark:bg-blue-900/10 rounded-lg border border-blue-100 dark:border-blue-800">
                        <h4 class="text-xs font-bold text-blue-800 dark:text-blue-300 mb-2">â• ì»¤ìŠ¤í…€ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ ì¶”ê°€</h4>
                        <div class="space-y-2">
                            <div class="flex gap-2">
                                <input type="text" id="customThumbStyleName"
                                    placeholder="ìŠ¤íƒ€ì¼ ì˜ë¬¸ ì½”ë“œëª… (ì˜ˆ: cinematic_thumb)" class="input-field flex-1 text-xs">
                                <div class="relative w-8 h-8 flex-shrink-0">
                                    <label for="customThumbStyleImage"
                                        class="w-full h-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded flex items-center justify-center cursor-pointer hover:border-blue-500 transition-colors"
                                        title="ì°¸ì¡° ì´ë¯¸ì§€ ì—…ë¡œë“œ">
                                        <span class="text-gray-400 text-[10px]">ğŸ“·</span>
                                    </label>
                                    <input type="file" id="customThumbStyleImage" class="hidden" accept="image/*"
                                        onchange="document.getElementById('customThumbStyleImgName').textContent = this.files[0]?.name || ''">
                                </div>
                            </div>
                            <p id="customThumbStyleImgName" class="text-[10px] text-gray-500 pl-1 h-3 truncate"></p>

                            <textarea id="customThumbStylePrompt" class="input-field w-full text-xs h-16"
                                placeholder="ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ (ì˜ˆ: highly detailed thumbnail, vibrant colors, text overlay)"></textarea>

                            <div class="flex justify-end">
                                <button onclick="addCustomThumbnailStylePreset()"
                                    class="btn-primary px-4 py-1.5 text-xs font-bold bg-blue-600 hover:bg-blue-700">
                                    ì¶”ê°€í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="thumbnailStylePresetList" class="space-y-3">
                        <!-- Loaded via JS -->
                        <div class="text-center py-4 text-gray-400 text-xs">ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-3 leading-tight">
                        * ì¸ë„¤ì¼ ìƒì„± ì‹œ ê° ìŠ¤íƒ€ì¼ë³„ë¡œ AIì—ê²Œ ì „ë‹¬ë  ë””ìì¸ ì§€ì¹¨ì…ë‹ˆë‹¤.<br>
                        * ìˆ˜ì • í›„ 'ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
            <!-- End Thumbnail Styles Tab -->

            <!-- Data Management Tab -->
            <div id="tab-content-data" class="tab-content">
                <!-- Data Management -->
                <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3 class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-2">ğŸ—‚ï¸ ë°ì´í„° ê´€ë¦¬</h3>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="flex-1 btn-secondary py-1.5 text-xs">ğŸ“¤ ë°±ì—…
                            (JSON)</button>
                        <button onclick="clearData()"
                            class="flex-1 btn-secondary text-red-600 bg-red-50 hover:bg-red-100 border-red-200 py-1.5 text-xs">ğŸ—‘ï¸
                            ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>
            <!-- End Data Tab -->

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .tab-button {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .tab-button:hover {
        color: #1f2937;
        border-bottom-color: #d1d5db;
    }

    .tab-button.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
        font-weight: 600;
    }

    .dark .tab-button {
        color: #9ca3af;
    }

    .dark .tab-button:hover {
        color: #d1d5db;
        border-bottom-color: #4b5563;
    }

    .dark .tab-button.active {
        color: #60a5fa;
        border-bottom-color: #60a5fa;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }
</style>
<script>
    // Tab switching
    function switchTab(tabName) {
        console.log('Switching to tab:', tabName);

        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
            console.log('Hiding tab:', tab.id);
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab
        const targetTab = document.getElementById(`tab-content-${tabName}`);
        const targetBtn = document.getElementById(`tab-${tabName}`);

        if (targetTab && targetBtn) {
            targetTab.classList.add('active');
            targetBtn.classList.add('active');
            console.log('Showing tab:', targetTab.id);
        } else {
            console.error('Tab not found:', tabName, 'targetTab:', targetTab, 'targetBtn:', targetBtn);
        }

        // Load data if needed
        if (tabName === 'image-styles') {
            loadStylePresets();
        } else if (tabName === 'script-styles') {
            loadScriptStylePresets();
        } else if (tabName === 'thumbnail-styles') {
            loadThumbnailStylePresets();
        }
    }

    // Gemini Constants
    const GEMINI_VOICES = [
        "Puck", "Charon", "Kore", "Fenrir", "Aoede", "Zephyr", "Orpheus", "Cupid",
        "Autonoe", "Callirrhoe", "Laomedeia", "Leda", "Despina", "Sulafat",
        "Algenib", "Alnilam", "Achernar", "Achird", "Enceladus", "Vega",
        "Ursa", "Pegasus", "Nova", "Eclipse", "Lyra", "Orbit", "Dipper",
        "Capella", "Orion"
    ];

    const GEMINI_LANGUAGES = [
        "ko-KR", "en-US", "ja-JP", "es-US", "fr-FR", "de-DE", "hi-IN", "id-ID",
        "it-IT", "pt-BR", "ru-RU", "nl-NL", "pl-PL", "th-TH", "tr-TR", "vi-VN",
        "ro-RO", "uk-UA", "bn-BD", "en-IN", "mr-IN", "ta-IN", "te-IN", "ar-EG"
    ];

    // [NEW] Default Master Prompt for Script Writing
    const DEFAULT_SCRIPT_MASTER_PROMPT = `ìµœì¢… í™•ì •: 'ë”¥-ë‹¤ì´ë¸Œ' ëŒ€ë³¸ ë¹Œë“œì—… 4ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤ (Ver. 4.0)

[1ë‹¨ê³„] ëŒ€ë³¸ ì •ë°€ í•´ë¶€ ë° í¥í–‰ ì ì¬ë ¥ ì§„ë‹¨
ì„ë¬´: ëŒ€ë³¸ì„ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ì •ë°€ ë¶„ì„í•˜ê³ , 'í¥í–‰ ì‹¬ë¦¬ ì§€ë„(5070 íƒ€ê²Ÿ ì œëª© ë¦¬ìŠ¤íŠ¸)'ì™€ 'ì „ë¬¸ ë“œë¼ë§ˆ ê¸°ë²•'ì„ ì‚¬ìš©í•˜ì—¬ ì ì¬ë ¥ê³¼ ê°œì„ ì ì— ëŒ€í•œ 'ëŒ€ë³¸ ì •ë°€ í•´ë¶€ ë¦¬í¬íŠ¸'ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.

ì‹¤í–‰ ì›ì¹™:
- [ì¢…í•© ì§„ë‹¨] ì‘í’ˆì˜ ê°€ì¥ ë§¤ë ¥ì ì¸ ì„¤ì •ê³¼ ê°œì„  í•„ìš” ì§€ì  ëª…í™•í•˜ê²Œ ìš”ì•½
- [í†¤ì•¤ë§¤ë„ˆ ë¶„ì„] ë‚˜ë ˆì´ì…˜ì€ ì‹œì²­ìì—ê²Œ ì •ì¤‘í•œ 'ì¡´ëŒ“ë§' ì›ì¹™ (5070 ì‹œì²­ì ì •ì„œì  ìœ ëŒ€ê°)
- [ëŒ€ì‚¬ í˜„ë¯¸ê²½ ë¶„ì„] ê°ì • ì„¤ëª… ëŒ€ì‚¬ë¥¼ 'ê·¹ì  ì•„ì´ëŸ¬ë‹ˆ(Dramatic Irony)'ê°€ ë‹´ê¸´ ìƒí™©ìœ¼ë¡œ ê°œì„ 
- [ì¥ë©´ êµ¬ì¡° ë¶„ì„] ë„ì…ë¶€ëŠ” 'ì¸ ë¯¸ë””ì–´ìŠ¤ ë ˆìŠ¤(In medias res)' + 'ì²´í˜¸í”„ì˜ ì´(Chekhov's Gun)' ê¸°ë²• ì ìš©
- [ì¸ë¬¼ ë§¤ë ¥ë„ ë¶„ì„] ì£¼ì¸ê³µì—ê²Œ 'ë³µì„ (Foreshadowing)'ì„ í†µí•œ ìˆ¨ê²¨ì§„ ëŠ¥ë ¥ ì•”ì‹œ

[2ë‹¨ê³„] 'ê°ë…íŒ ìƒ˜í”Œ' ì œì‘ ë° ê³µë™ ì°½ì‘ ë°©í–¥ í™•ì •
ì„ë¬´: ì§€ì •ëœ ì¥ë©´ì„ ë“œë¼ë§ˆ ê¸°ë²• + í¥í–‰ ì½”ë“œ + ì¡´ëŒ“ë§ ë‚˜ë ˆì´ì…˜ì— ë”°ë¼ 'ì›ë³¸ vs ê°ë… ìˆ˜ì •ë³¸' í˜•íƒœë¡œ ì œê³µ

[3ë‹¨ê³„] ê°ë…íŒ ëŒ€ë³¸ ì „ì²´ ì§‘í•„
ì„ë¬´: í•©ì˜ëœ ê°œì„  ë°©í–¥ê³¼ ìŠ¤íƒ€ì¼ì„ ëŒ€ë³¸ ì „ì²´ì— ì¼ê´€ë˜ê²Œ ì ìš©í•˜ì—¬ ìµœì¢… [ê°ë…íŒ ëŒ€ë³¸] ì™„ì„±

[4ë‹¨ê³„] ìµœì¢… ë§ˆì¼€íŒ… ì—ì…‹ ì‹œí™”
ì„ë¬´: ì™„ì„±ëœ ëŒ€ë³¸ì˜ í•µì‹¬ ì»¨ì…‰ì„ ë³´ì—¬ì¤„ ì¸ë„¤ì¼ ë¹„ì£¼ì–¼ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬`;

    // Reset Master Prompt to Default
    function resetMasterPrompt() {
        document.getElementById('promptScriptMaster').value = DEFAULT_SCRIPT_MASTER_PROMPT;
        Utils.showToast('ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // App Mode Toggle
    function setAppMode(mode) {
        document.getElementById('appMode').value = mode;

        const btnLong = document.getElementById('btnModeLong');
        const btnShort = document.getElementById('btnModeShort');

        const activeClass = "bg-white dark:bg-gray-600 shadow text-gray-800 dark:text-white font-bold";
        const inactiveClass = "text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 font-medium";

        if (mode === 'longform') {
            btnLong.className = `px-4 py-1.5 rounded-md text-xs transition-all ${activeClass}`;
            btnShort.className = `px-4 py-1.5 rounded-md text-xs transition-all ${inactiveClass}`;
        } else {
            btnShort.className = `px-4 py-1.5 rounded-md text-xs transition-all ${activeClass}`;
            btnLong.className = `px-4 py-1.5 rounded-md text-xs transition-all ${inactiveClass}`;
        }
    }

    // Populate Select Options
    function populateOptions() {
        const voiceSelect = document.getElementById('geminiVoice');
        const langSelect = document.getElementById('geminiLanguage');

        voiceSelect.innerHTML = GEMINI_VOICES.map(v => `<option value="${v}">${v}</option>`).join('');
        langSelect.innerHTML = GEMINI_LANGUAGES.map(l => `<option value="${l}">${l}</option>`).join('');
    }

    // Load All Settings
    async function loadAllSettings() {
        await loadApiKeys();

        try {
            const res = await fetch('/api/settings');
            const data = await res.json();

            if (data.gemini_tts) {
                document.getElementById('geminiVoice').value = data.gemini_tts.voice_name || 'Puck';
                document.getElementById('geminiLanguage').value = data.gemini_tts.language_code || 'ko-KR';
                document.getElementById('geminiStylePrompt').value = data.gemini_tts.style_prompt || '';
            }

            if (data.script_styles) {
                document.getElementById('promptNews').value = data.script_styles.news || '';
                document.getElementById('promptStory').value = data.script_styles.story || '';
                document.getElementById('promptScriptMaster').value = data.script_styles.script_master || DEFAULT_SCRIPT_MASTER_PROMPT;
                // [NEW]
                document.getElementById('promptSeniorStory').value = data.script_styles.senior_story || '';
            }

            // [NEW] App Mode
            setAppMode(data.app_mode || 'longform');

            // [NEW] Template Image
            updateTemplatePreview(data.template_image_url);
        } catch (e) {
            console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // Save All
    async function saveAllSettings() {
        // Save Keys first
        await saveApiKeys(); // This saves API keys to .env (via existing logic)

        // Save Global Settings
        const settings = {
            app_mode: document.getElementById('appMode').value,
            gemini_tts: {
                voice_name: document.getElementById('geminiVoice').value,
                language_code: document.getElementById('geminiLanguage').value,
                style_prompt: document.getElementById('geminiStylePrompt').value
            },
            script_styles: {
                news: document.getElementById('promptNews').value,
                story: document.getElementById('promptStory').value,
                script_master: document.getElementById('promptScriptMaster').value,
                senior_story: document.getElementById('promptSeniorStory').value // [NEW]
            }
        };

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res.ok) {
                Utils.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                Utils.showToast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
        }
    }

    // í‚¤ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
    function toggleKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(inputId + '-eye');

        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.textContent = 'ğŸ™ˆ';
        } else {
            input.type = 'password';
            eyeIcon.textContent = 'ğŸ‘ï¸';
        }
    }

    // API í‚¤ ìƒíƒœ ë¡œë“œ
    async function loadApiKeys() {
        try {
            const keys = await API.apiKeys.get();

            // YouTube
            if (keys.youtube) {
                document.getElementById('youtubeStatus').innerHTML = keys.youtube.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('youtubeKeyMasked').textContent = keys.youtube.masked
                    ? `í˜„ì¬ í‚¤: ${keys.youtube.masked}`
                    : '';
            }

            // Gemini
            if (keys.gemini) {
                document.getElementById('geminiStatus').innerHTML = keys.gemini.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('geminiKeyMasked').textContent = keys.gemini.masked
                    ? `í˜„ì¬ í‚¤: ${keys.gemini.masked}`
                    : '';
            }

            // ElevenLabs
            if (keys.elevenlabs) {
                document.getElementById('elevenlabsStatus').innerHTML = keys.elevenlabs.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì •</span>';
                document.getElementById('elevenlabsKeyMasked').textContent = keys.elevenlabs.masked
                    ? `í˜„ì¬ í‚¤: ${keys.elevenlabs.masked}`
                    : '';
            }

            // Replicate
            if (keys.replicate) {
                document.getElementById('replicateStatus').innerHTML = keys.replicate.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì • (ì„ íƒ)</span>';
                document.getElementById('replicateKeyMasked').textContent = keys.replicate.masked
                    ? `í˜„ì¬ í‚¤: ${keys.replicate.masked}`
                    : '';
            }

        } catch (e) {
            console.error('API í‚¤ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
    }

    // API í‚¤ ì €ì¥ (Existing, modified to communicate saving)
    async function saveApiKeys() {
        const keys = {};

        const youtube = document.getElementById('youtubeApiKey').value.trim();
        const gemini = document.getElementById('geminiApiKey').value.trim();
        const elevenlabs = document.getElementById('elevenlabsApiKey').value.trim();
        const replicate = document.getElementById('replicateApiKey').value.trim();

        if (youtube) keys.youtube = youtube;
        if (gemini) keys.gemini = gemini;
        if (elevenlabs) keys.elevenlabs = elevenlabs;
        if (replicate) keys.replicate = replicate; // REPLICATE_API_TOKEN

        if (Object.keys(keys).length > 0) {
            try {
                await API.apiKeys.save(keys);
                document.getElementById('youtubeApiKey').value = '';
                document.getElementById('geminiApiKey').value = '';
                document.getElementById('elevenlabsApiKey').value = '';
                document.getElementById('replicateApiKey').value = '';
                await loadApiKeys();
                await checkApiConnection();
            } catch (e) {
                console.error(e);
                Utils.showToast('í‚¤ ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        }
    }

    // [NEW] Template Image Functions
    async function uploadTemplate(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];

        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'template'); // flag

        Utils.showToast('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...', 'info');

        try {
            const res = await fetch('/api/upload/template', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (res.ok) {
                Utils.showToast('í…œí”Œë¦¿ ì—…ë¡œë“œ ì™„ë£Œ', 'success');
                // Update UI
                updateTemplatePreview(data.url);
            } else {
                Utils.showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
        } finally {
            input.value = ''; // Reset input
        }
    }

    async function deleteTemplate() {
        if (!confirm('í…œí”Œë¦¿ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const res = await fetch('/api/settings/template', { method: 'DELETE' });
            if (res.ok) {
                Utils.showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                updateTemplatePreview(null);
            } else {
                Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
        }
    }

    function updateTemplatePreview(url) {
        const img = document.getElementById('templatePreview');
        const ph = document.getElementById('templatePlaceholder');
        const delBtn = document.getElementById('btnDeleteTemplate');

        if (url) {
            img.src = url;
            img.classList.remove('hidden');
            ph.classList.add('hidden');
            delBtn.classList.remove('hidden');
        } else {
            img.src = '';
            img.classList.add('hidden');
            ph.classList.remove('hidden');
            delBtn.classList.add('hidden');
        }
    }

    // API ì—°ê²° ìƒíƒœ í™•ì¸
    async function checkApiConnection() {
        try {
            const health = await API.health();

            document.getElementById('youtubeConnectionStatus').innerHTML = health.apis?.youtube
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('geminiConnectionStatus').innerHTML = health.apis?.gemini
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('elevenlabsConnectionStatus').innerHTML = health.apis?.elevenlabs
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì • (ì„ íƒ)</span>';

            document.getElementById('replicateConnectionStatus').innerHTML = health.apis?.replicate
                ? '<span class="text-green-600">âœ… ê°€ëŠ¥</span>'
                : '<span class="text-yellow-600">âš ï¸ ë¯¸ì—°ê²°</span>';

        } catch (e) {
            console.error('ì—°ê²° ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', e);
        }
    }

    function exportData() {
        const data = {
            analysisData: Utils.storage.get('analysisData'),
            scriptStructure: Utils.storage.get('scriptStructure'),
            fullScript: Utils.storage.get('fullScript'),
            imagePrompts: Utils.storage.get('imagePrompts'),
            exportedAt: new Date().toISOString()
        };

        Utils.downloadFile(JSON.stringify(data, null, 2), 'picadillystudio_backup.json', 'application/json');
        Utils.showToast('ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
    }

    function clearData() {
        if (!confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(API í‚¤ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

        Utils.storage.remove('analysisData');
        Utils.storage.remove('scriptStructure');
        Utils.storage.remove('fullScript');
        Utils.storage.remove('imagePrompts');
        Utils.storage.remove('ttsAudio');

        Utils.showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // ì±„ë„ ë¡œë“œ
    async function loadChannels() {
        const list = document.getElementById('channelList');
        try {
            const res = await fetch('/api/channels');
            if (!res.ok) throw new Error('ì±„ë„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            const channels = await res.json();

            if (channels.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // credentials_pathê°€ ìˆìœ¼ë©´ ì¸ì¦ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
            list.innerHTML = channels.map(ch => {
                const isAuthenticated = !!ch.credentials_path;
                const statusBadge = isAuthenticated
                    ? '<span class="text-green-600 border border-green-200 bg-green-50 px-2 py-0.5 rounded text-xs">âœ… ì—°ê²°ë¨</span>'
                    : '<span class="text-gray-500 border border-gray-200 bg-gray-50 px-2 py-0.5 rounded text-xs">âŒ ë¯¸ì—°ê²°</span>';

                const authBtn = isAuthenticated
                    ? `<button onclick="authenticateChannel(${ch.id}, '${ch.name}')" class="text-blue-500 hover:text-blue-700 text-xs border border-blue-200 px-2 py-1 rounded">ğŸ”„ ì¬ì—°ê²°</button>`
                    : `<button onclick="authenticateChannel(${ch.id}, '${ch.name}')" class="text-white bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-xs shadow-sm">ğŸ”‘ ë¡œê·¸ì¸</button>`;

                return `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-lg shadow-sm">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-gray-800 dark:text-white">${ch.name}</span>
                            <span class="text-xs text-gray-500 font-normal">${ch.handle}</span>
                            ${statusBadge}
                        </div>
                        ${ch.description ? `<p class="text-xs text-gray-500">${ch.description}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${authBtn}
                        <button onclick="deleteChannel(${ch.id})" class="text-red-500 hover:text-red-700 p-2" title="ì‚­ì œ">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `}).join('');

        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-red-500 text-sm">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // ì±„ë„ ì¸ì¦ (OAuth)
    async function authenticateChannel(id, name) {
        if (!confirm(`'${name}' ì±„ë„ì˜ ìœ íŠœë¸Œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì°¸ê³ : ìƒˆ ì°½ì´ ëœ¨ë©´ í•´ë‹¹ ì±„ë„ì˜ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.)`)) return;

        try {
            // ì´ ìš”ì²­ì€ ì„œë²„ì—ì„œ Python ë¡œì»¬ ì„œë²„ë¥¼ í†µí•´ ë¸Œë¼ìš°ì €ë¥¼ ë„ìš°ë¯€ë¡œ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ
            Utils.showToast('ì¸ì¦ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”...', 'info');

            const res = await fetch(`/api/auth/youtube/${id}`);
            const data = await res.json();

            if (res.ok) {
                Utils.showToast(data.message || 'ì¸ì¦ ì™„ë£Œ!', 'success');
                loadChannels();
            } else {
                Utils.showToast(data.detail || 'ì¸ì¦ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì¸ì¦ ê³¼ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì±„ë„ ì¶”ê°€
    async function addChannel() {

        const nameInput = document.getElementById('newChannelName');
        const handleInput = document.getElementById('newChannelHandle');
        const descInput = document.getElementById('newChannelDesc');

        const name = nameInput.value.trim();
        let handle = handleInput.value.trim();
        const description = descInput.value.trim();

        if (!name || !handle) {
            Utils.showToast('ì±„ë„ëª…ê³¼ í•¸ë“¤ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        if (!handle.startsWith('@')) {
            handle = '@' + handle;
        }

        try {
            const res = await fetch('/api/channels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, handle, description })
            });

            if (res.ok) {
                Utils.showToast('ì±„ë„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                nameInput.value = '';
                handleInput.value = '';
                descInput.value = '';
                loadChannels(); // ëª©ë¡ ê°±ì‹ 
            } else {
                const err = await res.json();
                Utils.showToast(err.detail || 'ì±„ë„ ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì±„ë„ ì‚­ì œ
    async function deleteChannel(id) {
        if (!confirm('ì •ë§ ì´ ì±„ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const res = await fetch(`/api/channels/${id}`, { method: 'DELETE' });
            if (res.ok) {
                Utils.showToast('ì±„ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadChannels();
            } else {
                Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜', 'error');
        }
    }

    // [NEW] ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹ ê´€ë¦¬
    async function loadStylePresets() {
        const list = document.getElementById('stylePresetList');
        try {
            const res = await fetch('/api/settings/style-presets');
            const presets = await res.json();

            list.innerHTML = Object.entries(presets).map(([key, val]) => `
                <div class="bg-gray-50 dark:bg-gray-800/50 p-2 rounded-md border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[11px] font-bold text-gray-700 dark:text-gray-200 capitalize">${key}</label>
                        <button onclick="saveOneStylePreset('${key}')" class="text-[10px] bg-blue-500 text-white px-2 py-0.5 rounded hover:bg-blue-600">ğŸ’¾ ì €ì¥</button>
                    </div>
                    <textarea id="preset_${key}" class="input-field w-full text-[11px] font-mono leading-tight" rows="2">${val}</textarea>
                </div>
            `).join('');
        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-red-500 text-xs">ìŠ¤íƒ€ì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    async function saveOneStylePreset(key) {
        const val = document.getElementById(`preset_${key}`).value;
        try {
            const res = await fetch('/api/settings/style-presets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ style_key: key, prompt_value: val })
            });

            if (res.ok) {
                Utils.showToast(`[${key}] ìŠ¤íƒ€ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            } else {
                Utils.showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    // [NEW] ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹ ê´€ë¦¬ (Updated)
    const DEFAULT_STYLE_KEYS = ['realistic', 'anime', 'cinematic', 'cartoon', 'oil_painting', 'watercolor', 'sketch', 'pixel_art', '3d'];

    async function loadStylePresets() {
        const list = document.getElementById('stylePresetList');
        try {
            const res = await fetch('/api/settings/style-presets');
            const presets = await res.json();

            list.innerHTML = Object.entries(presets).map(([key, data]) => {
                // Compatibility check: data might be string (old) or object (new)
                const prompt = typeof data === 'string' ? data : (data.prompt || '');
                const imageUrl = typeof data === 'object' ? data.image_url : null;

                const displayName = {
                    'realistic': 'ë¦¬ì–¼ë¦¬ìŠ¤í‹±',
                    'anime': 'ì• ë‹ˆë©”ì´ì…˜',
                    'cinematic': 'ì‹œë„¤ë§ˆí‹±',
                    'cartoon': 'ì¹´íˆ°',
                    'oil_painting': 'ìœ í™”',
                    'watercolor': 'ìˆ˜ì±„í™”',
                    'sketch': 'ìŠ¤ì¼€ì¹˜',
                    'pixel_art': 'í”½ì…€ì•„íŠ¸'
                }[key] || key;

                const isDefault = DEFAULT_STYLE_KEYS.includes(key);

                return `
                    <div class="bg-gray-50 dark:bg-gray-800/50 p-3 rounded-md border border-gray-100 dark:border-gray-700 relative group">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <div class="relative group/img cursor-pointer" onclick="document.getElementById('file_${key}').click()">
                                    ${imageUrl ?
                        `<img id="img_preview_${key}" src="${imageUrl}" class="w-10 h-10 rounded border border-gray-300 object-cover bg-white" title="ì´ë¯¸ì§€ ë³€ê²½ (í´ë¦­)">`
                        : `<span id="img_preview_${key}" class="w-10 h-10 rounded bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-[10px] text-gray-500 hover:bg-gray-300 transition-colors" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ (í´ë¦­)">No Img</span>`
                    }
                                    <div class="absolute inset-0 bg-black/30 rounded flex items-center justify-center opacity-0 group-hover/img:opacity-100 transition-opacity">
                                        <span class="text-white text-[10px]">ğŸ“·</span>
                                    </div>
                                    <input type="file" id="file_${key}" class="hidden" accept="image/*" onchange="previewStyleImage(this, '${key}')">
                                </div>
                                <div>
                                    <label class="text-sm font-bold text-gray-700 dark:text-gray-200 block leading-none mb-1">${displayName}</label>
                                    <span class="text-[10px] text-gray-400 font-mono">${key}</span>
                                </div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="saveOneStylePreset('${key}')" class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition-colors">ğŸ’¾ ì €ì¥</button>
                                ${!isDefault ?
                        `<button onclick="deleteStylePreset('${key}')" class="text-[10px] bg-red-50 text-red-500 border border-red-200 px-2 py-1 rounded hover:bg-red-100 transition-colors" title="ì‚­ì œ">ğŸ—‘ï¸</button>`
                        : ''
                    }
                            </div>
                        </div>
                        <textarea id="preset_${key}" class="input-field w-full text-[11px] font-mono" rows="2">${prompt}</textarea>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-red-500 text-xs">ìŠ¤íƒ€ì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    function previewStyleImage(input, key) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById(`img_preview_${key}`);
                const parent = preview.parentElement;

                // Remove old preview (img or span)
                preview.remove();

                // Create new preview img
                const img = document.createElement('img');
                img.id = `img_preview_${key}`;
                img.src = e.target.result;
                img.className = "w-10 h-10 rounded border border-gray-300 object-cover bg-white";
                img.title = "ì´ë¯¸ì§€ ë³€ê²½ (í´ë¦­)";

                // Insert as first child of parent (.relative.group/img)
                parent.prepend(img);
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveOneStylePreset(key) {
        const val = document.getElementById(`preset_${key}`).value;
        const fileInput = document.getElementById(`file_${key}`);
        const file = fileInput && fileInput.files[0];

        try {
            let res;
            if (file) {
                // If file exists, use multipart upload endpoint (upsert)
                const formData = new FormData();
                formData.append('style_key', key);
                formData.append('prompt_value', val);
                formData.append('file', file);

                Utils.showToast('ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì €ì¥ ì¤‘...', 'info');
                res = await fetch('/api/settings/style-presets/custom', {
                    method: 'POST',
                    body: formData
                });
            } else {
                // Normal JSON update
                res = await fetch('/api/settings/style-presets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        style_key: key,
                        prompt_value: val,
                        image_url: null // Backend will preserve if null
                    })
                });
            }

            if (res.ok) {
                if (file) {
                    // Clear file input so next save doesn't re-upload unless changed
                    fileInput.value = '';
                }
                Utils.showToast(`[${key}] ìŠ¤íƒ€ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            } else {
                const err = await res.json();
                Utils.showToast(err.detail || 'ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    // [NEW] Add Custom Style
    async function addCustomStylePreset() {
        const nameInput = document.getElementById('customStyleName');
        const promptInput = document.getElementById('customStylePrompt');
        const fileInput = document.getElementById('customStyleImage');
        const name = nameInput.value.trim();
        const prompt = promptInput.value.trim();
        const file = fileInput.files[0];

        if (!name || !prompt) {
            Utils.showToast('ì´ë¦„ê³¼ í”„ë¡¬í”„íŠ¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('style_key', name);
        formData.append('prompt_value', prompt);
        if (file) {
            formData.append('file', file);
        }

        Utils.showToast('ìŠ¤íƒ€ì¼ ì¶”ê°€ ì¤‘...', 'info');

        try {
            const res = await fetch('/api/settings/style-presets/custom', {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                Utils.showToast('ìƒˆ ìŠ¤íƒ€ì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                // Clear inputs
                nameInput.value = '';
                promptInput.value = '';
                fileInput.value = '';
                document.getElementById('customStyleImgName').textContent = '';
                // Reload list
                loadStylePresets();
            } else {
                const err = await res.json();
                Utils.showToast(err.detail || 'ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    // [NEW] Delete Style
    async function deleteStylePreset(key) {
        if (!confirm(`'${key}' ìŠ¤íƒ€ì¼ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const res = await fetch(`/api/settings/style-presets/${key}`, { method: 'DELETE' });
            if (res.ok) {
                Utils.showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadStylePresets();
            } else {
                Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜', 'error');
        }
    }

    // [NEW] ëŒ€ë³¸ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹ ê´€ë¦¬
    async function loadScriptStylePresets() {
        const list = document.getElementById('scriptStylePresetList');
        try {
            const res = await fetch('/api/settings/script-style-presets');
            const presets = await res.json();

            list.innerHTML = Object.entries(presets).map(([key, val]) => {
                const displayName = {
                    'default': 'ê¸°ë³¸ ì„¤ì •',
                    'news': 'ë‰´ìŠ¤ ë³´ë„',
                    'story': 'ì˜›ë‚  ì´ì•¼ê¸°',
                    'senior_story': 'ì‹œë‹ˆì–´ ì‚¬ì—°',
                    'bgm': 'ë°°ê²½ìŒì•… ì¤‘ì‹¬',
                    'classic_50s': '50ë…„ëŒ€ í´ë˜ì‹ì˜í™”',
                    'joseon_sageuk': 'ì¡°ì„ ì‹œëŒ€ ì‚¬ê·¹',
                    'north_korean_drama': 'ë¶í•œ ë“œë¼ë§ˆ',
                    'silent_20s': '20ë…„ëŒ€ ë¬´ì„±ì˜í™”',
                    'camcorder_90s': '90ë…„ëŒ€ ìº ì½”ë”',
                    'modern_drama': 'í˜„ëŒ€ ë“œë¼ë§ˆ',
                    'mystery_thriller': 'ë¯¸ìŠ¤í„°ë¦¬ ìŠ¤ë¦´ëŸ¬',
                    'horror_suspense': 'ê³µí¬-ì„œìŠ¤íœìŠ¤',
                    'melodrama': 'ë©œë¡œë“œë¼ë§ˆ',
                    'crime_drama': 'ë²”ì£„ ë“œë¼ë§ˆ',
                    'cyberpunk_neon': 'ì‚¬ì´ë²„í‘í¬ ë„¤ì˜¨',
                    'watercolor_analog': 'ìˆ˜ì±„í™”í’ ì•„ë‚ ë¡œê·¸',
                    'digital_webtoon': 'ë””ì§€í„¸ ì›¹íˆ°',
                    'graphite_sketch': 'í‘ì—° ë“œë¡œì‰ ìŠ¤ì¼€ì¹˜',
                    'joseon_2d_anime': 'ì¡°ì„ ì‹œëŒ€ í’ì†í™” 2D',
                    'oriental_ink': 'ë™ì–‘ ìˆ˜ë¬µí™”',
                    'neonsign_citypop': 'ë„¤ì˜¨ì‚¬ì¸ ì‹œí‹°íŒ',
                    'buddhist_minimal': 'ë¶ˆêµ ë¯¸ë‹ˆë©€ë¦¬ì¦˜',
                    'renaissance_sacred': 'ë¥´ë„¤ìƒìŠ¤ ì„±í™”',
                    'cute_animal_char': 'ê·€ì—¬ìš´ ë™ë¬¼ ìºë¦­í„°',
                    'wimpy_kid': 'ìœ”í”¼í‚¤ë“œ ìŠ¤íƒ€ì¼',
                    'script_master': 'ğŸ“‹ ëŒ€ë³¸ ì‘ì„± ë§ˆìŠ¤í„°'
                }[key] || key;

                const rows = val.length > 200 ? 8 : val.length > 100 ? 5 : 3;

                return `
                            <div class="bg-gray-50 dark:bg-gray-800/50 p-3 rounded-md border border-gray-100 dark:border-gray-700">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-bold text-gray-700 dark:text-gray-200">${displayName}</label>
                                    <button onclick="saveOneScriptStylePreset('${key}')" class="text-[10px] bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">ğŸ’¾ ì €ì¥</button>
                                </div>
                                <textarea id="script_preset_${key}" class="input-field w-full text-[11px] font-mono leading-tight" rows="${rows}">${val}</textarea>
                            </div>
                        `;
            }).join('');
        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-red-500 text-xs">ëŒ€ë³¸ ìŠ¤íƒ€ì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    async function saveOneScriptStylePreset(key) {
        const val = document.getElementById(`script_preset_${key}`).value;
        try {
            const res = await fetch('/api/settings/script-style-presets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ style_key: key, prompt_value: val })
            });

            if (res.ok) {
                Utils.showToast(`[${key}] ëŒ€ë³¸ ìŠ¤íƒ€ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            } else {
                Utils.showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    // [NEW] ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹ ê´€ë¦¬
    const DEFAULT_THUMB_KEYS = ['face', 'text', 'contrast', 'mystery', 'minimal', 'dramatic', 'japanese_viral', 'ghibli', 'wimpy'];

    async function loadThumbnailStylePresets() {
        const list = document.getElementById('thumbnailStylePresetList');
        try {
            const res = await fetch('/api/settings/thumbnail-style-presets');
            const presets = await res.json();

            list.innerHTML = Object.entries(presets).map(([key, data]) => {
                // Compatibility
                const prompt = typeof data === 'string' ? data : (data.prompt || '');
                const imageUrl = typeof data === 'object' ? data.image_url : null;

                const displayName = {
                    'face': 'ì–¼êµ´ ê°•ì¡°í˜•',
                    'text': 'í…ìŠ¤íŠ¸ ì¤‘ì‹¬í˜•',
                    'contrast': 'ë¹„í¬/ì• í”„í„°í˜•',
                    'mystery': 'ë¯¸ìŠ¤í„°ë¦¬í˜•',
                    'minimal': 'ë¯¸ë‹ˆë©€í˜•',
                    'dramatic': 'ë“œë¼ë§ˆí‹±í˜•',
                    'japanese_viral': 'ì‹œë‹ˆì–´ ë¡±í¼(ì¼ë³¸í’)',
                    'ghibli': 'ì§€ë¸Œë¦¬ ê°ì„±',
                    'wimpy': 'ìœ”í”¼í‚¤ë“œ ìŠ¤íƒ€ì¼'
                }[key] || key;

                const isDefault = DEFAULT_THUMB_KEYS.includes(key);
                // Fallback image url if none provided, old way (optional, but new way handles null)
                // If imageUrl is null, we show placeholder. 
                // Previously we had `/static/thumbnail_samples/${key}.png`. We can keep checking that if we want legacy support, 
                // but for now let's rely on data.image_url. If user wants legacy images they need to migrate or we rely on 'No Img'

                return `
                    <div class="bg-gray-50 dark:bg-gray-800/50 p-3 rounded-md border border-gray-100 dark:border-gray-700 relative group">
                        <div class="flex justify-between items-start mb-2">
                             <div class="flex items-center gap-2">
                                <div class="relative group/img cursor-pointer" onclick="document.getElementById('thumb_file_${key}').click()">
                                    ${imageUrl ?
                        `<img id="thumb_img_preview_${key}" src="${imageUrl}" class="w-10 h-10 rounded border border-gray-300 object-cover bg-white" title="ì´ë¯¸ì§€ ë³€ê²½ (í´ë¦­)">`
                        : `<span id="thumb_img_preview_${key}" class="w-10 h-10 rounded bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-[10px] text-gray-500 hover:bg-gray-300 transition-colors" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ (í´ë¦­)">No Img</span>`
                    }
                                    <div class="absolute inset-0 bg-black/30 rounded flex items-center justify-center opacity-0 group-hover/img:opacity-100 transition-opacity">
                                        <span class="text-white text-[10px]">ğŸ“·</span>
                                    </div>
                                    <input type="file" id="thumb_file_${key}" class="hidden" accept="image/*" onchange="previewThumbnailStyleImage(this, '${key}')">
                                </div>
                                <div>
                                    <label class="text-sm font-bold text-gray-700 dark:text-gray-200 block leading-none mb-1">${displayName}</label>
                                    <span class="text-[10px] text-gray-400 font-mono">${key}</span>
                                </div>
                            </div>

                            <div class="flex gap-1">
                                <button onclick="saveOneThumbnailStylePreset('${key}')" class="text-[10px] bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition-colors">ğŸ’¾ ì €ì¥</button>
                                ${!isDefault ?
                        `<button onclick="deleteThumbnailStylePreset('${key}')" class="text-[10px] bg-red-50 text-red-500 border border-red-200 px-2 py-1 rounded hover:bg-red-100 transition-colors" title="ì‚­ì œ">ğŸ—‘ï¸</button>`
                        : ''
                    }
                            </div>
                        </div>
                        <textarea id="thumbnail_preset_${key}" class="input-field w-full text-[11px] font-mono leading-tight mt-1" rows="3">${prompt}</textarea>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-red-500 text-xs">ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    function previewThumbnailStyleImage(input, key) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById(`thumb_img_preview_${key}`);
                const parent = preview.parentElement;
                preview.remove();

                const img = document.createElement('img');
                img.id = `thumb_img_preview_${key}`;
                img.src = e.target.result;
                img.className = "w-10 h-10 rounded border border-gray-300 object-cover bg-white";
                img.title = "ì´ë¯¸ì§€ ë³€ê²½ (í´ë¦­)";

                parent.prepend(img);
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveOneThumbnailStylePreset(key) {
        const val = document.getElementById(`thumbnail_preset_${key}`).value;
        const fileInput = document.getElementById(`thumb_file_${key}`);
        const file = fileInput && fileInput.files[0];

        try {
            let res;
            if (file) {
                const formData = new FormData();
                formData.append('style_key', key);
                formData.append('prompt_value', val);
                formData.append('file', file);

                Utils.showToast('ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...', 'info');
                res = await fetch('/api/settings/thumbnail-style-presets/custom', {
                    method: 'POST',
                    body: formData
                });
            } else {
                res = await fetch('/api/settings/thumbnail-style-presets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        style_key: key,
                        prompt_value: val,
                        image_url: null
                    })
                });
            }

            if (res.ok) {
                if (file) fileInput.value = '';
                Utils.showToast(`[${key}] ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            } else {
                Utils.showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    async function addCustomThumbnailStylePreset() {
        const nameInput = document.getElementById('customThumbStyleName');
        const promptInput = document.getElementById('customThumbStylePrompt');
        const fileInput = document.getElementById('customThumbStyleImage');
        const name = nameInput.value.trim();
        const prompt = promptInput.value.trim();
        const file = fileInput.files[0];

        if (!name || !prompt) {
            Utils.showToast('ì´ë¦„ê³¼ í”„ë¡¬í”„íŠ¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('style_key', name);
        formData.append('prompt_value', prompt);
        if (file) {
            formData.append('file', file);
        } else {
            // Even if no file, the API expects 'file' field for UploadFile. 
            // We might need to split API or make file optional in `add_custom...`.
            // The python endpoint: `file: UploadFile = File(...)` implies required.
            // But we allow string-only create? 
            // Wait, previous implementation of `custom` endpoint requires file.
            // If user doesn't upload file, we should warn or support it. "Thumbnail must have image" is not strict rule but good for UI.
            // Let's require file for now for Custom, or fallback to regular POST if no file.
        }

        try {
            let res;
            if (file) {
                res = await fetch('/api/settings/thumbnail-style-presets/custom', {
                    method: 'POST',
                    body: formData
                });
            } else {
                // Use normal endpoint creates entry with null image
                res = await fetch('/api/settings/thumbnail-style-presets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ style_key: name, prompt_value: prompt })
                });
            }

            if (res.ok) {
                Utils.showToast('ìƒˆ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                nameInput.value = '';
                promptInput.value = '';
                fileInput.value = '';
                document.getElementById('customThumbStyleImgName').textContent = '';
                loadThumbnailStylePresets();
            } else {
                const err = await res.json();
                Utils.showToast(err.detail || 'ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ', 'error');
        }
    }

    async function deleteThumbnailStylePreset(key) {
        if (!confirm(`'${key}' ìŠ¤íƒ€ì¼ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const res = await fetch(`/api/settings/thumbnail-style-presets/${key}`, { method: 'DELETE' });
            if (res.ok) {
                Utils.showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadThumbnailStylePresets();
            } else {
                Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜', 'error');
        }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        populateOptions();
        loadAllSettings();
        checkApiConnection();
        loadChannels();
        loadStylePresets(); // [NEW] ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹ ë¡œë“œ
        loadThumbnailStylePresets();
    });
</script>
{% endblock %}