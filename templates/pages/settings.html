{% extends "base.html" %}

{% block content %}


<div class="h-[calc(100vh-80px)] overflow-y-auto p-4 custom-scrollbar">
    <!-- Header with Actions -->
    <div
        class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 dark:bg-gray-900 z-10 py-2 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-bold flex items-center gap-2">
            <span>âš™ï¸ í™˜ê²½ ì„¤ì •</span>
        </h2>
        <div class="flex gap-2">
            <button onclick="loadAllSettings()" class="btn-secondary py-1.5 px-3 text-xs flex items-center gap-1">
                <span>ğŸ”„</span> ìƒˆë¡œê³ ì¹¨
            </button>
            <button onclick="saveAllSettings()"
                class="btn-primary py-1.5 px-4 text-xs font-bold shadow-sm flex items-center gap-1">
                <span>ğŸ’¾</span> ë³€ê²½ì‚¬í•­ ì €ì¥
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">

        <!-- Left Column: System & Connections (5/12) -->
        <div class="xl:col-span-5 space-y-4">

            <!-- API Keys & Connectivity -->
            <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-3 flex items-center justify-between">
                    <span>ğŸ”‘ API ì¸ì¦ ë° ì—°ê²° ìƒíƒœ</span>
                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
                        class="text-[10px] text-blue-500 hover:underline">Console ë°”ë¡œê°€ê¸° â†—</a>
                </h3>

                <div class="space-y-3">
                    <!-- YouTube -->
                    <div
                        class="bg-gray-50 dark:bg-gray-800/50 rounded-md p-2 border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 flex items-center gap-1">
                                <span>ğŸ“º YouTube Data API</span>
                                <span id="youtubeStatus" class="text-[10px] font-normal text-gray-400"></span>
                            </label>
                            <span id="youtubeConnectionStatus"
                                class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1.5 rounded text-gray-500">ëŒ€ê¸°</span>
                        </div>
                        <div class="flex gap-1">
                            <input type="password" id="youtubeApiKey" class="flex-1 input-field text-xs py-1 px-2 h-8"
                                placeholder="API Key ì…ë ¥">
                            <button onclick="toggleKeyVisibility('youtubeApiKey')"
                                class="btn-secondary px-2 h-8 text-xs">ğŸ‘ï¸</button>
                        </div>
                        <p id="youtubeKeyMasked" class="text-[10px] text-gray-400 mt-0.5 truncate h-3"></p>
                    </div>

                    <!-- Gemini -->
                    <div
                        class="bg-gray-50 dark:bg-gray-800/50 rounded-md p-2 border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 flex items-center gap-1">
                                <span>ğŸ¤– Gemini API</span>
                                <span id="geminiStatus" class="text-[10px] font-normal text-gray-400"></span>
                            </label>
                            <span id="geminiConnectionStatus"
                                class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1.5 rounded text-gray-500">ëŒ€ê¸°</span>
                        </div>
                        <div class="flex gap-1">
                            <input type="password" id="geminiApiKey" class="flex-1 input-field text-xs py-1 px-2 h-8"
                                placeholder="API Key ì…ë ¥">
                            <button onclick="toggleKeyVisibility('geminiApiKey')"
                                class="btn-secondary px-2 h-8 text-xs">ğŸ‘ï¸</button>
                        </div>
                        <p id="geminiKeyMasked" class="text-[10px] text-gray-400 mt-0.5 truncate h-3"></p>
                    </div>

                    <!-- ElevenLabs -->
                    <div
                        class="bg-gray-50 dark:bg-gray-800/50 rounded-md p-2 border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 flex items-center gap-1">
                                <span>ğŸ”Š ElevenLabs API</span>
                                <span class="text-[10px] text-gray-400 font-normal">(ì„ íƒ)</span>
                                <span id="elevenlabsStatus" class="text-[10px] font-normal text-gray-400"></span>
                            </label>
                            <span id="elevenlabsConnectionStatus"
                                class="text-[10px] bg-gray-200 dark:bg-gray-700 px-1.5 rounded text-gray-500">ë¯¸ì„¤ì •</span>
                        </div>
                        <div class="flex gap-1">
                            <input type="password" id="elevenlabsApiKey"
                                class="flex-1 input-field text-xs py-1 px-2 h-8" placeholder="API Key ì…ë ¥">
                            <button onclick="toggleKeyVisibility('elevenlabsApiKey')"
                                class="btn-secondary px-2 h-8 text-xs">ğŸ‘ï¸</button>
                        </div>
                        <p id="elevenlabsKeyMasked" class="text-[10px] text-gray-400 mt-0.5 truncate h-3"></p>
                    </div>
                </div>

                <div class="mt-3 pt-3 border-t border-gray-100 dark:border-gray-700 flex justify-between text-[10px]">
                    <a href="https://aistudio.google.com/apikey" target="_blank"
                        class="text-blue-500 hover:underline flex items-center gap-1">
                        ğŸ”‘ Gemini í‚¤ ë°œê¸‰
                    </a>
                    <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank"
                        class="text-gray-500 hover:underline flex items-center gap-1">
                        ğŸ”‘ ElevenLabs í‚¤ ë°œê¸‰
                    </a>
                </div>
            </div>

            <!-- Data Management -->
            <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-2">ğŸ—‚ï¸ ë°ì´í„° ê´€ë¦¬</h3>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="flex-1 btn-secondary py-1.5 text-xs">ğŸ“¤ ë°±ì—… (JSON)</button>
                    <button onclick="clearData()"
                        class="flex-1 btn-secondary text-red-600 bg-red-50 hover:bg-red-100 border-red-200 py-1.5 text-xs">ğŸ—‘ï¸
                        ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

        <!-- Right Column: Configurations (7/12) -->
        <div class="xl:col-span-7 space-y-4">

            <!-- Channel Management -->
            <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-sm text-gray-800 dark:text-gray-100">ğŸ“º ìœ íŠœë¸Œ ì±„ë„ ê´€ë¦¬</h3>
                    <span class="text-[10px] text-gray-400">ì—…ë¡œë“œ ëŒ€ìƒ ì±„ë„</span>
                </div>

                <div id="channelList"
                    class="space-y-2 mb-3 max-h-40 overflow-y-auto custom-scrollbar bg-gray-50 dark:bg-gray-800/30 rounded p-1">
                    <!-- Loaded via JS -->
                    <p class="text-gray-400 text-xs text-center py-4">ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>

                <div
                    class="flex gap-2 p-2 bg-gray-50 dark:bg-gray-800 rounded border border-gray-100 dark:border-gray-700">
                    <input type="text" id="newChannelName" class="input-field text-xs flex-1 h-8"
                        placeholder="ì±„ë„ëª… (ë‚´ ë¸Œì´ë¡œê·¸)">
                    <input type="text" id="newChannelHandle" class="input-field text-xs w-24 h-8" placeholder="@handle">
                    <button onclick="addChannel()"
                        class="btn-primary py-0 px-3 text-xs h-8 whitespace-nowrap">ì¶”ê°€</button>
                </div>
                <input type="text" id="newChannelDesc" class="input-field text-xs w-full mt-2 h-7"
                    placeholder="ì±„ë„ ì„¤ëª… (ì„ íƒ)">
            </div>

            <!-- Content Settings (Voice & Scripts) -->
            <div class="card p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="font-bold text-sm text-gray-800 dark:text-gray-100 mb-3">ğŸ¨ ì½˜í…ì¸  ìƒì„± ì„¤ì •</h3>

                <!-- Platform Mode -->
                <div class="mb-5 border-b border-gray-100 dark:border-gray-700 pb-4">
                    <label class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-2 block">ğŸ–¥ï¸ í”Œë«í¼ ëª¨ë“œ</label>
                    <input type="hidden" id="appMode" value="longform">
                    <div class="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1 w-fit">
                        <button id="btnModeLong" onclick="setAppMode('longform')"
                            class="px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white dark:bg-gray-600 shadow text-gray-800 dark:text-white">
                            ğŸï¸ ë¡±í¼ (ê¸°ë³¸)
                        </button>
                        <button id="btnModeShort" onclick="setAppMode('shorts')"
                            class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                            ğŸ“± ì‡¼ì¸ 
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2">
                        * ëª¨ë“œë¥¼ ë³€ê²½í•˜ë©´ ë©”ë‰´ êµ¬ì„±ê³¼ ì˜ìƒ ìƒì„± ì„¤ì •ì´ í•´ë‹¹ í¬ë§·ì— ìµœì í™”ë©ë‹ˆë‹¤.
                    </p>
                </div>

                <!-- [NEW] Template Image (Overlay) -->
                <div class="mb-5 border-b border-gray-100 dark:border-gray-700 pb-4">
                    <label
                        class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-2 flex justify-between items-center">
                        <span>ğŸ–¼ï¸ í…œí”Œë¦¿ ì´ë¯¸ì§€ (9:16 ì˜¤ë²„ë ˆì´)</span>
                        <span class="text-[10px] text-gray-400 font-normal">.png íˆ¬ëª… ë°°ê²½ ê¶Œì¥</span>
                    </label>

                    <div class="flex items-start gap-4">
                        <!-- Preview -->
                        <div
                            class="w-16 h-28 bg-gray-100 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 overflow-hidden flex items-center justify-center relative group">
                            <img id="templatePreview" src="" class="w-full h-full object-cover hidden">
                            <div id="templatePlaceholder" class="text-gray-300 text-[10px] text-center p-1">No Image
                            </div>
                            <button onclick="deleteTemplate()" id="btnDeleteTemplate"
                                class="hidden absolute inset-0 bg-black/50 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                ğŸ—‘ï¸
                            </button>
                        </div>

                        <!-- Upload Control -->
                        <div class="flex-1">
                            <input type="file" id="templateImageInput" accept="image/png, image/jpeg" class="hidden"
                                onchange="uploadTemplate(this)">
                            <button onclick="document.getElementById('templateImageInput').click()"
                                class="btn-secondary w-full py-2 text-xs mb-2 border-dashed border-2">
                                ğŸ“ ì´ë¯¸ì§€ ì—…ë¡œë“œ (Upload)
                            </button>
                            <p class="text-[10px] text-gray-400 leading-tight">
                                * ì‡¼ì¸  ì˜ìƒ ìƒì„± ì‹œ, ì „ì²´ í”„ë ˆì„ ìœ„ì— ì˜¤ë²„ë ˆì´ë¡œ ì ìš©ë©ë‹ˆë‹¤.<br>
                                * í”„ë ˆì„, ë¡œê³ , í…Œë‘ë¦¬ ì¥ì‹ ë“±ì— í™œìš©í•˜ì„¸ìš”.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Voice -->
                    <div>
                        <label class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-2 block">ğŸ—£ï¸ ê¸°ë³¸ ëª©ì†Œë¦¬
                            (Gemini)</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <select id="geminiVoice" class="input-field text-xs h-8"></select>
                            <select id="geminiLanguage" class="input-field text-xs h-8"></select>
                        </div>
                        <textarea id="geminiStylePrompt" rows="2" class="input-field w-full text-xs"
                            placeholder="ìŒì„± ìŠ¤íƒ€ì¼ (ì˜ˆ: ì°¨ë¶„í•˜ê³  ì‹ ë¢°ê° ìˆëŠ” í†¤)"></textarea>
                    </div>

                    <!-- Script Prompts -->
                    <div class="space-y-4">
                        <!-- [NEW] Main Script Writing Prompt -->
                        <div
                            class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 border border-purple-200 dark:border-purple-800">
                            <label
                                class="text-xs font-bold text-purple-700 dark:text-purple-300 mb-2 flex items-center gap-2">
                                <span>âœï¸ ëŒ€ë³¸ ì‘ì„± ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸</span>
                                <span class="text-[10px] text-purple-500 dark:text-purple-400 font-normal">ëŒ€ë³¸ ìƒì„± ì‹œ AIì—ê²Œ
                                    ì „ë‹¬ë˜ëŠ” í•µì‹¬ ì§€ì¹¨</span>
                            </label>
                            <textarea id="promptScriptMaster" class="input-field w-full text-xs font-mono" rows="8"
                                placeholder="ëŒ€ë³¸ ì‘ì„± ì‹œ AIì—ê²Œ ì „ë‹¬í•  ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <p class="text-[10px] text-purple-500">* ì´ í”„ë¡¬í”„íŠ¸ëŠ” ëª¨ë“  ëŒ€ë³¸ ìƒì„±ì— ì ìš©ë©ë‹ˆë‹¤.</p>
                                <button onclick="resetMasterPrompt()"
                                    class="text-[10px] text-purple-600 hover:underline">ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-1 block">ğŸ“œ ì‹œë‹ˆì–´ ì‚¬ì—° ìŠ¤íƒ€ì¼
                                í”„ë¡¬í”„íŠ¸ (New)</label>
                            <textarea id="promptSeniorStory" class="input-field w-full text-xs" rows="3"
                                placeholder="ì¤‘ì¥ë…„ì¸µ ê³µê° ì‚¬ì—° í†¤ì•¤ë§¤ë„ˆ ì§€ì¹¨..."></textarea>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-1 block">ğŸ“œ ì˜›ë‚  ì´ì•¼ê¸° ìŠ¤íƒ€ì¼
                                í”„ë¡¬í”„íŠ¸</label>
                            <textarea id="promptStory" class="input-field w-full text-xs" rows="2"
                                placeholder="êµ¬ì—°ë™í™” í†¤ì•¤ë§¤ë„ˆ ì§€ì¹¨..."></textarea>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-1 block">ğŸ“œ ë‰´ìŠ¤ ìŠ¤íƒ€ì¼
                                í”„ë¡¬í”„íŠ¸</label>
                            <textarea id="promptNews" class="input-field w-full text-xs" rows="2"
                                placeholder="ë‰´ìŠ¤ í†¤ì•¤ë§¤ë„ˆ ì§€ì¹¨..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Gemini Constants
    const GEMINI_VOICES = [
        "Puck", "Charon", "Kore", "Fenrir", "Aoede", "Zephyr", "Orpheus", "Cupid",
        "Autonoe", "Callirrhoe", "Laomedeia", "Leda", "Despina", "Sulafat",
        "Algenib", "Alnilam", "Achernar", "Achird", "Enceladus", "Vega",
        "Ursa", "Pegasus", "Nova", "Eclipse", "Lyra", "Orbit", "Dipper",
        "Capella", "Orion"
    ];

    const GEMINI_LANGUAGES = [
        "ko-KR", "en-US", "ja-JP", "es-US", "fr-FR", "de-DE", "hi-IN", "id-ID",
        "it-IT", "pt-BR", "ru-RU", "nl-NL", "pl-PL", "th-TH", "tr-TR", "vi-VN",
        "ro-RO", "uk-UA", "bn-BD", "en-IN", "mr-IN", "ta-IN", "te-IN", "ar-EG"
    ];

    // [NEW] Default Master Prompt for Script Writing
    const DEFAULT_SCRIPT_MASTER_PROMPT = `ìµœì¢… í™•ì •: 'ë”¥-ë‹¤ì´ë¸Œ' ëŒ€ë³¸ ë¹Œë“œì—… 4ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤ (Ver. 4.0)

[1ë‹¨ê³„] ëŒ€ë³¸ ì •ë°€ í•´ë¶€ ë° í¥í–‰ ì ì¬ë ¥ ì§„ë‹¨
ì„ë¬´: ëŒ€ë³¸ì„ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ì •ë°€ ë¶„ì„í•˜ê³ , 'í¥í–‰ ì‹¬ë¦¬ ì§€ë„(5070 íƒ€ê²Ÿ ì œëª© ë¦¬ìŠ¤íŠ¸)'ì™€ 'ì „ë¬¸ ë“œë¼ë§ˆ ê¸°ë²•'ì„ ì‚¬ìš©í•˜ì—¬ ì ì¬ë ¥ê³¼ ê°œì„ ì ì— ëŒ€í•œ 'ëŒ€ë³¸ ì •ë°€ í•´ë¶€ ë¦¬í¬íŠ¸'ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.

ì‹¤í–‰ ì›ì¹™:
- [ì¢…í•© ì§„ë‹¨] ì‘í’ˆì˜ ê°€ì¥ ë§¤ë ¥ì ì¸ ì„¤ì •ê³¼ ê°œì„  í•„ìš” ì§€ì  ëª…í™•í•˜ê²Œ ìš”ì•½
- [í†¤ì•¤ë§¤ë„ˆ ë¶„ì„] ë‚˜ë ˆì´ì…˜ì€ ì‹œì²­ìì—ê²Œ ì •ì¤‘í•œ 'ì¡´ëŒ“ë§' ì›ì¹™ (5070 ì‹œì²­ì ì •ì„œì  ìœ ëŒ€ê°)
- [ëŒ€ì‚¬ í˜„ë¯¸ê²½ ë¶„ì„] ê°ì • ì„¤ëª… ëŒ€ì‚¬ë¥¼ 'ê·¹ì  ì•„ì´ëŸ¬ë‹ˆ(Dramatic Irony)'ê°€ ë‹´ê¸´ ìƒí™©ìœ¼ë¡œ ê°œì„ 
- [ì¥ë©´ êµ¬ì¡° ë¶„ì„] ë„ì…ë¶€ëŠ” 'ì¸ ë¯¸ë””ì–´ìŠ¤ ë ˆìŠ¤(In medias res)' + 'ì²´í˜¸í”„ì˜ ì´(Chekhov's Gun)' ê¸°ë²• ì ìš©
- [ì¸ë¬¼ ë§¤ë ¥ë„ ë¶„ì„] ì£¼ì¸ê³µì—ê²Œ 'ë³µì„ (Foreshadowing)'ì„ í†µí•œ ìˆ¨ê²¨ì§„ ëŠ¥ë ¥ ì•”ì‹œ

[2ë‹¨ê³„] 'ê°ë…íŒ ìƒ˜í”Œ' ì œì‘ ë° ê³µë™ ì°½ì‘ ë°©í–¥ í™•ì •
ì„ë¬´: ì§€ì •ëœ ì¥ë©´ì„ ë“œë¼ë§ˆ ê¸°ë²• + í¥í–‰ ì½”ë“œ + ì¡´ëŒ“ë§ ë‚˜ë ˆì´ì…˜ì— ë”°ë¼ 'ì›ë³¸ vs ê°ë… ìˆ˜ì •ë³¸' í˜•íƒœë¡œ ì œê³µ

[3ë‹¨ê³„] ê°ë…íŒ ëŒ€ë³¸ ì „ì²´ ì§‘í•„
ì„ë¬´: í•©ì˜ëœ ê°œì„  ë°©í–¥ê³¼ ìŠ¤íƒ€ì¼ì„ ëŒ€ë³¸ ì „ì²´ì— ì¼ê´€ë˜ê²Œ ì ìš©í•˜ì—¬ ìµœì¢… [ê°ë…íŒ ëŒ€ë³¸] ì™„ì„±

[4ë‹¨ê³„] ìµœì¢… ë§ˆì¼€íŒ… ì—ì…‹ ì‹œí™”
ì„ë¬´: ì™„ì„±ëœ ëŒ€ë³¸ì˜ í•µì‹¬ ì»¨ì…‰ì„ ë³´ì—¬ì¤„ ì¸ë„¤ì¼ ë¹„ì£¼ì–¼ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬`;

    // Reset Master Prompt to Default
    function resetMasterPrompt() {
        document.getElementById('promptScriptMaster').value = DEFAULT_SCRIPT_MASTER_PROMPT;
        Utils.showToast('ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // App Mode Toggle
    function setAppMode(mode) {
        document.getElementById('appMode').value = mode;

        const btnLong = document.getElementById('btnModeLong');
        const btnShort = document.getElementById('btnModeShort');

        const activeClass = "bg-white dark:bg-gray-600 shadow text-gray-800 dark:text-white font-bold";
        const inactiveClass = "text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 font-medium";

        if (mode === 'longform') {
            btnLong.className = `px-4 py-1.5 rounded-md text-xs transition-all ${activeClass}`;
            btnShort.className = `px-4 py-1.5 rounded-md text-xs transition-all ${inactiveClass}`;
        } else {
            btnShort.className = `px-4 py-1.5 rounded-md text-xs transition-all ${activeClass}`;
            btnLong.className = `px-4 py-1.5 rounded-md text-xs transition-all ${inactiveClass}`;
        }
    }

    // Populate Select Options
    function populateOptions() {
        const voiceSelect = document.getElementById('geminiVoice');
        const langSelect = document.getElementById('geminiLanguage');

        voiceSelect.innerHTML = GEMINI_VOICES.map(v => `<option value="${v}">${v}</option>`).join('');
        langSelect.innerHTML = GEMINI_LANGUAGES.map(l => `<option value="${l}">${l}</option>`).join('');
    }

    // Load All Settings
    async function loadAllSettings() {
        await loadApiKeys();

        try {
            const res = await fetch('/api/settings');
            const data = await res.json();

            if (data.gemini_tts) {
                document.getElementById('geminiVoice').value = data.gemini_tts.voice_name || 'Puck';
                document.getElementById('geminiLanguage').value = data.gemini_tts.language_code || 'ko-KR';
                document.getElementById('geminiStylePrompt').value = data.gemini_tts.style_prompt || '';
            }

            if (data.script_styles) {
                document.getElementById('promptNews').value = data.script_styles.news || '';
                document.getElementById('promptStory').value = data.script_styles.story || '';
                document.getElementById('promptScriptMaster').value = data.script_styles.script_master || DEFAULT_SCRIPT_MASTER_PROMPT;
                // [NEW]
                document.getElementById('promptSeniorStory').value = data.script_styles.senior_story || '';
            }

            // [NEW] App Mode
            setAppMode(data.app_mode || 'longform');

            // [NEW] Template Image
            updateTemplatePreview(data.template_image_url);
        } catch (e) {
            console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // Save All
    async function saveAllSettings() {
        // Save Keys first
        await saveApiKeys(); // This saves API keys to .env (via existing logic)

        // Save Global Settings
        const settings = {
            app_mode: document.getElementById('appMode').value,
            gemini_tts: {
                voice_name: document.getElementById('geminiVoice').value,
                language_code: document.getElementById('geminiLanguage').value,
                style_prompt: document.getElementById('geminiStylePrompt').value
            },
            script_styles: {
                news: document.getElementById('promptNews').value,
                story: document.getElementById('promptStory').value,
                script_master: document.getElementById('promptScriptMaster').value,
                senior_story: document.getElementById('promptSeniorStory').value // [NEW]
            }
        };

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res.ok) {
                Utils.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                Utils.showToast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
        }
    }

    // í‚¤ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
    function toggleKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(inputId + '-eye');

        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.textContent = 'ğŸ™ˆ';
        } else {
            input.type = 'password';
            eyeIcon.textContent = 'ğŸ‘ï¸';
        }
    }

    // API í‚¤ ìƒíƒœ ë¡œë“œ
    async function loadApiKeys() {
        try {
            const keys = await API.apiKeys.get();

            // YouTube
            if (keys.youtube) {
                document.getElementById('youtubeStatus').innerHTML = keys.youtube.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('youtubeKeyMasked').textContent = keys.youtube.masked
                    ? `í˜„ì¬ í‚¤: ${keys.youtube.masked}`
                    : '';
            }

            // Gemini
            if (keys.gemini) {
                document.getElementById('geminiStatus').innerHTML = keys.gemini.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('geminiKeyMasked').textContent = keys.gemini.masked
                    ? `í˜„ì¬ í‚¤: ${keys.gemini.masked}`
                    : '';
            }

            // ElevenLabs
            if (keys.elevenlabs) {
                document.getElementById('elevenlabsStatus').innerHTML = keys.elevenlabs.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì •</span>';
                document.getElementById('elevenlabsKeyMasked').textContent = keys.elevenlabs.masked
                    ? `í˜„ì¬ í‚¤: ${keys.elevenlabs.masked}`
                    : '';
            }

        } catch (e) {
            console.error('API í‚¤ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
    }

    // API í‚¤ ì €ì¥ (Existing, modified to communicate saving)
    async function saveApiKeys() {
        const keys = {};

        const youtube = document.getElementById('youtubeApiKey').value.trim();
        const gemini = document.getElementById('geminiApiKey').value.trim();
        const elevenlabs = document.getElementById('elevenlabsApiKey').value.trim();

        if (youtube) keys.youtube = youtube;
        if (gemini) keys.gemini = gemini;
        if (elevenlabs) keys.elevenlabs = elevenlabs;

        if (Object.keys(keys).length > 0) {
            try {
                await API.apiKeys.save(keys);
                document.getElementById('youtubeApiKey').value = '';
                document.getElementById('geminiApiKey').value = '';
                document.getElementById('elevenlabsApiKey').value = '';
                await loadApiKeys();
                await checkApiConnection();
            } catch (e) {
                console.error(e);
                Utils.showToast('í‚¤ ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        }
    }

    // [NEW] Template Image Functions
    async function uploadTemplate(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];

        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'template'); // flag

        Utils.showToast('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...', 'info');

        try {
            const res = await fetch('/api/upload/template', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (res.ok) {
                Utils.showToast('í…œí”Œë¦¿ ì—…ë¡œë“œ ì™„ë£Œ', 'success');
                // Update UI
                updateTemplatePreview(data.url);
            } else {
                Utils.showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
        } finally {
            input.value = ''; // Reset input
        }
    }

    async function deleteTemplate() {
        if (!confirm('í…œí”Œë¦¿ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const res = await fetch('/api/settings/template', { method: 'DELETE' });
            if (res.ok) {
                Utils.showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                updateTemplatePreview(null);
            } else {
                Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
        }
    }

    function updateTemplatePreview(url) {
        const img = document.getElementById('templatePreview');
        const ph = document.getElementById('templatePlaceholder');
        const delBtn = document.getElementById('btnDeleteTemplate');

        if (url) {
            img.src = url;
            img.classList.remove('hidden');
            ph.classList.add('hidden');
            delBtn.classList.remove('hidden');
        } else {
            img.src = '';
            img.classList.add('hidden');
            ph.classList.remove('hidden');
            delBtn.classList.add('hidden');
        }
    }

    // API ì—°ê²° ìƒíƒœ í™•ì¸
    async function checkApiConnection() {
        try {
            const health = await API.health();

            document.getElementById('youtubeConnectionStatus').innerHTML = health.apis?.youtube
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('geminiConnectionStatus').innerHTML = health.apis?.gemini
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('elevenlabsConnectionStatus').innerHTML = health.apis?.elevenlabs
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì • (ì„ íƒ)</span>';

        } catch (e) {
            console.error('ì—°ê²° ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', e);
        }
    }

    function exportData() {
        const data = {
            analysisData: Utils.storage.get('analysisData'),
            scriptStructure: Utils.storage.get('scriptStructure'),
            fullScript: Utils.storage.get('fullScript'),
            imagePrompts: Utils.storage.get('imagePrompts'),
            exportedAt: new Date().toISOString()
        };

        Utils.downloadFile(JSON.stringify(data, null, 2), 'picadillystudio_backup.json', 'application/json');
        Utils.showToast('ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
    }

    function clearData() {
        if (!confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(API í‚¤ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

        Utils.storage.remove('analysisData');
        Utils.storage.remove('scriptStructure');
        Utils.storage.remove('fullScript');
        Utils.storage.remove('imagePrompts');
        Utils.storage.remove('ttsAudio');

        Utils.showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // ì±„ë„ ë¡œë“œ
    async function loadChannels() {
        const list = document.getElementById('channelList');
        try {
            const res = await fetch('/api/channels');
            if (!res.ok) throw new Error('ì±„ë„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            const channels = await res.json();

            if (channels.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // credentials_pathê°€ ìˆìœ¼ë©´ ì¸ì¦ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
            list.innerHTML = channels.map(ch => {
                const isAuthenticated = !!ch.credentials_path;
                const statusBadge = isAuthenticated
                    ? '<span class="text-green-600 border border-green-200 bg-green-50 px-2 py-0.5 rounded text-xs">âœ… ì—°ê²°ë¨</span>'
                    : '<span class="text-gray-500 border border-gray-200 bg-gray-50 px-2 py-0.5 rounded text-xs">âŒ ë¯¸ì—°ê²°</span>';

                const authBtn = isAuthenticated
                    ? `<button onclick="authenticateChannel(${ch.id}, '${ch.name}')" class="text-blue-500 hover:text-blue-700 text-xs border border-blue-200 px-2 py-1 rounded">ğŸ”„ ì¬ì—°ê²°</button>`
                    : `<button onclick="authenticateChannel(${ch.id}, '${ch.name}')" class="text-white bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-xs shadow-sm">ğŸ”‘ ë¡œê·¸ì¸</button>`;

                return `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-lg shadow-sm">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-gray-800 dark:text-white">${ch.name}</span>
                            <span class="text-xs text-gray-500 font-normal">${ch.handle}</span>
                            ${statusBadge}
                        </div>
                        ${ch.description ? `<p class="text-xs text-gray-500">${ch.description}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${authBtn}
                        <button onclick="deleteChannel(${ch.id})" class="text-red-500 hover:text-red-700 p-2" title="ì‚­ì œ">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `}).join('');

        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-red-500 text-sm">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // ì±„ë„ ì¸ì¦ (OAuth)
    async function authenticateChannel(id, name) {
        if (!confirm(`'${name}' ì±„ë„ì˜ ìœ íŠœë¸Œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì°¸ê³ : ìƒˆ ì°½ì´ ëœ¨ë©´ í•´ë‹¹ ì±„ë„ì˜ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.)`)) return;

        try {
            // ì´ ìš”ì²­ì€ ì„œë²„ì—ì„œ Python ë¡œì»¬ ì„œë²„ë¥¼ í†µí•´ ë¸Œë¼ìš°ì €ë¥¼ ë„ìš°ë¯€ë¡œ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ
            Utils.showToast('ì¸ì¦ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”...', 'info');

            const res = await fetch(`/api/auth/youtube/${id}`);
            const data = await res.json();

            if (res.ok) {
                Utils.showToast(data.message || 'ì¸ì¦ ì™„ë£Œ!', 'success');
                loadChannels();
            } else {
                Utils.showToast(data.detail || 'ì¸ì¦ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì¸ì¦ ê³¼ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì±„ë„ ì¶”ê°€
    async function addChannel() {

        const nameInput = document.getElementById('newChannelName');
        const handleInput = document.getElementById('newChannelHandle');
        const descInput = document.getElementById('newChannelDesc');

        const name = nameInput.value.trim();
        let handle = handleInput.value.trim();
        const description = descInput.value.trim();

        if (!name || !handle) {
            Utils.showToast('ì±„ë„ëª…ê³¼ í•¸ë“¤ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        if (!handle.startsWith('@')) {
            handle = '@' + handle;
        }

        try {
            const res = await fetch('/api/channels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, handle, description })
            });

            if (res.ok) {
                Utils.showToast('ì±„ë„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                nameInput.value = '';
                handleInput.value = '';
                descInput.value = '';
                loadChannels(); // ëª©ë¡ ê°±ì‹ 
            } else {
                const err = await res.json();
                Utils.showToast(err.detail || 'ì±„ë„ ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì±„ë„ ì‚­ì œ
    async function deleteChannel(id) {
        if (!confirm('ì •ë§ ì´ ì±„ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const res = await fetch(`/api/channels/${id}`, { method: 'DELETE' });
            if (res.ok) {
                Utils.showToast('ì±„ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadChannels();
            } else {
                Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜', 'error');
        }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        populateOptions();
        loadAllSettings();
        checkApiConnection();
        loadChannels(); // ì±„ë„ ëª©ë¡ ë¡œë“œ
    });
</script>
{% endblock %}