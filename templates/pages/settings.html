{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">âš™ï¸</span>
        <div>
            <h1>ì„¤ì •</h1>
            <p>API í‚¤ ë° ì•± ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- API í‚¤ ì…ë ¥ í¼ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ”‘ API í‚¤ ì„¤ì •</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•˜ë©´ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤. ì„œë²„ ì¬ì‹œì‘ ì—†ì´ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <div class="space-y-4">
        <!-- YouTube API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ“º</span>
                    <label class="font-medium text-gray-800 dark:text-white">YouTube Data API</label>
                </div>
                <span id="youtubeStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="youtubeApiKey" class="flex-1 input-field text-sm"
                    placeholder="YouTube API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('youtubeApiKey')" class="btn-secondary px-3">
                    <span id="youtubeApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="youtubeKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>

        <!-- Gemini API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ¤–</span>
                    <label class="font-medium text-gray-800 dark:text-white">Gemini API</label>
                </div>
                <span id="geminiStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="geminiApiKey" class="flex-1 input-field text-sm"
                    placeholder="Gemini API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('geminiApiKey')" class="btn-secondary px-3">
                    <span id="geminiApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="geminiKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>

        <!-- ElevenLabs API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ”Š</span>
                    <label class="font-medium text-gray-800 dark:text-white">ElevenLabs TTS (ì„ íƒ)</label>
                </div>
                <span id="elevenlabsStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="elevenlabsApiKey" class="flex-1 input-field text-sm"
                    placeholder="ElevenLabs API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('elevenlabsApiKey')" class="btn-secondary px-3">
                    <span id="elevenlabsApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="elevenlabsKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>
    </div>

</div>

<!-- Gemini Voice Settings -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ—£ï¸ Gemini ìŒì„± ì„¤ì • (ê¸°ë³¸ê°’)</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        ìƒˆ í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ì ìš©ë  ê¸°ë³¸ ìŒì„± ì„¤ì •ì…ë‹ˆë‹¤.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <!-- ìŒì„± ì„ íƒ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ìŒì„± (Voice)</label>
            <select id="geminiVoice" class="input-field w-full">
                <!-- Loaded via JS -->
            </select>
        </div>

        <!-- ì–¸ì–´ ì„ íƒ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì–¸ì–´ (Language)</label>
            <select id="geminiLanguage" class="input-field w-full">
                <!-- Loaded via JS -->
            </select>
        </div>
    </div>

    <!-- ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ -->
    <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            ìŒì„± ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ (Style Prompt)
            <span class="text-xs text-gray-500 font-normal ml-2">ì˜ˆ: "ì°¨ë¶„í•˜ê³  ì „ë¬¸ì ì¸ í†¤ìœ¼ë¡œ", "í™œê¸°ì°¨ê³  ë¹ ë¥´ê²Œ"</span>
        </label>
        <textarea id="geminiStylePrompt" rows="3" class="input-field w-full"
            placeholder="Geminiì—ê²Œ ìŒì„± ìŠ¤íƒ€ì¼ì— ëŒ€í•´ ì§€ì‹œí•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    </div>
</div>

<!-- ì €ì¥ ë²„íŠ¼ -->
<div class="mt-6 flex gap-3">
    <button onclick="saveAllSettings()" class="btn-primary px-6">
        ğŸ’¾ ì „ì²´ ì„¤ì • ì €ì¥
    </button>
    <button onclick="loadAllSettings()" class="btn-secondary">
        ğŸ”„ ìƒˆë¡œê³ ì¹¨
    </button>
</div>
</div>

<!-- API ì—°ê²° ìƒíƒœ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“¡ API ì—°ê²° ìƒíƒœ</h3>
    <div id="apiStatusList" class="space-y-3">
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ“º</span>
                <span>YouTube Data API</span>
            </div>
            <span id="youtubeConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ¤–</span>
                <span>Gemini API</span>
            </div>
            <span id="geminiConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ”Š</span>
                <span>ElevenLabs TTS</span>
            </div>
            <span id="elevenlabsConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
    </div>
</div>

<!-- API í‚¤ ë°œê¸‰ ë§í¬ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ”— API í‚¤ ë°œê¸‰</h3>
    <div class="space-y-3">
        <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ“º</span>
                <span>YouTube Data API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
        <a href="https://aistudio.google.com/apikey" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ¤–</span>
                <span>Gemini API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
        <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ”Š</span>
                <span>ElevenLabs API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
    </div>
</div>

<!-- ë°ì´í„° ê´€ë¦¬ -->
<div class="card">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ—‚ï¸ ë¡œì»¬ ë°ì´í„° ê´€ë¦¬</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
    </p>
    <div class="flex gap-3">
        <button onclick="exportData()" class="btn-secondary">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button onclick="clearData()" class="btn-secondary text-red-600">ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Gemini Constants
    const GEMINI_VOICES = [
        "Puck", "Charon", "Kore", "Fenrir", "Aoede", "Zephyr", "Orpheus", "Cupid",
        "Autonoe", "Callirrhoe", "Laomedeia", "Leda", "Despina", "Sulafat",
        "Algenib", "Alnilam", "Achernar", "Achird", "Enceladus", "Vega",
        "Ursa", "Pegasus", "Nova", "Eclipse", "Lyra", "Orbit", "Dipper",
        "Capella", "Orion"
    ];

    const GEMINI_LANGUAGES = [
        "ko-KR", "en-US", "ja-JP", "es-US", "fr-FR", "de-DE", "hi-IN", "id-ID",
        "it-IT", "pt-BR", "ru-RU", "nl-NL", "pl-PL", "th-TH", "tr-TR", "vi-VN",
        "ro-RO", "uk-UA", "bn-BD", "en-IN", "mr-IN", "ta-IN", "te-IN", "ar-EG"
    ];

    // Populate Select Options
    function populateOptions() {
        const voiceSelect = document.getElementById('geminiVoice');
        const langSelect = document.getElementById('geminiLanguage');

        voiceSelect.innerHTML = GEMINI_VOICES.map(v => `<option value="${v}">${v}</option>`).join('');
        langSelect.innerHTML = GEMINI_LANGUAGES.map(l => `<option value="${l}">${l}</option>`).join('');
    }

    // Load All Settings
    async function loadAllSettings() {
        await loadApiKeys();

        try {
            const res = await fetch('/api/settings');
            const data = await res.json();

            if (data.gemini_tts) {
                document.getElementById('geminiVoice').value = data.gemini_tts.voice_name || 'Puck';
                document.getElementById('geminiLanguage').value = data.gemini_tts.language_code || 'ko-KR';
                document.getElementById('geminiStylePrompt').value = data.gemini_tts.style_prompt || '';
            }
        } catch (e) {
            console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // Save All
    async function saveAllSettings() {
        // Save Keys first
        await saveApiKeys(); // This saves API keys to .env (via existing logic)

        // Save Global Settings
        const settings = {
            gemini_tts: {
                voice_name: document.getElementById('geminiVoice').value,
                language_code: document.getElementById('geminiLanguage').value,
                style_prompt: document.getElementById('geminiStylePrompt').value
            }
        };

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res.ok) {
                Utils.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                Utils.showToast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
        }
    }

    // í‚¤ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
    function toggleKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(inputId + '-eye');

        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.textContent = 'ğŸ™ˆ';
        } else {
            input.type = 'password';
            eyeIcon.textContent = 'ğŸ‘ï¸';
        }
    }

    // API í‚¤ ìƒíƒœ ë¡œë“œ
    async function loadApiKeys() {
        try {
            const keys = await API.apiKeys.get();

            // YouTube
            if (keys.youtube) {
                document.getElementById('youtubeStatus').innerHTML = keys.youtube.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('youtubeKeyMasked').textContent = keys.youtube.masked
                    ? `í˜„ì¬ í‚¤: ${keys.youtube.masked}`
                    : '';
            }

            // Gemini
            if (keys.gemini) {
                document.getElementById('geminiStatus').innerHTML = keys.gemini.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('geminiKeyMasked').textContent = keys.gemini.masked
                    ? `í˜„ì¬ í‚¤: ${keys.gemini.masked}`
                    : '';
            }

            // ElevenLabs
            if (keys.elevenlabs) {
                document.getElementById('elevenlabsStatus').innerHTML = keys.elevenlabs.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì •</span>';
                document.getElementById('elevenlabsKeyMasked').textContent = keys.elevenlabs.masked
                    ? `í˜„ì¬ í‚¤: ${keys.elevenlabs.masked}`
                    : '';
            }

        } catch (e) {
            console.error('API í‚¤ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
    }

    // API í‚¤ ì €ì¥ (Existing, modified to communicate saving)
    async function saveApiKeys() {
        const keys = {};

        const youtube = document.getElementById('youtubeApiKey').value.trim();
        const gemini = document.getElementById('geminiApiKey').value.trim();
        const elevenlabs = document.getElementById('elevenlabsApiKey').value.trim();

        if (youtube) keys.youtube = youtube;
        if (gemini) keys.gemini = gemini;
        if (elevenlabs) keys.elevenlabs = elevenlabs;

        if (Object.keys(keys).length > 0) {
            try {
                await API.apiKeys.save(keys);
                document.getElementById('youtubeApiKey').value = '';
                document.getElementById('geminiApiKey').value = '';
                document.getElementById('elevenlabsApiKey').value = '';
                await loadApiKeys();
                await checkApiConnection();
            } catch (e) {
                console.error('API í‚¤ ì €ì¥ ì˜¤ë¥˜:', e);
            }
        }
    }

    // API ì—°ê²° ìƒíƒœ í™•ì¸
    async function checkApiConnection() {
        try {
            const health = await API.health();

            document.getElementById('youtubeConnectionStatus').innerHTML = health.apis?.youtube
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('geminiConnectionStatus').innerHTML = health.apis?.gemini
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('elevenlabsConnectionStatus').innerHTML = health.apis?.elevenlabs
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì • (ì„ íƒ)</span>';

        } catch (e) {
            console.error('ì—°ê²° ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', e);
        }
    }

    function exportData() {
        const data = {
            analysisData: Utils.storage.get('analysisData'),
            scriptStructure: Utils.storage.get('scriptStructure'),
            fullScript: Utils.storage.get('fullScript'),
            imagePrompts: Utils.storage.get('imagePrompts'),
            exportedAt: new Date().toISOString()
        };

        Utils.downloadFile(JSON.stringify(data, null, 2), 'picadillystudio_backup.json', 'application/json');
        Utils.showToast('ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
    }

    function clearData() {
        if (!confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(API í‚¤ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

        Utils.storage.remove('analysisData');
        Utils.storage.remove('scriptStructure');
        Utils.storage.remove('fullScript');
        Utils.storage.remove('imagePrompts');
        Utils.storage.remove('ttsAudio');

        Utils.showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        populateOptions();
        loadAllSettings();
        checkApiConnection();
    });
</script>
{% endblock %}