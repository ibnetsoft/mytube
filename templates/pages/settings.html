{% extends "base.html" %}

{% block content %}


<!-- API í‚¤ ì…ë ¥ í¼ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ”‘ API í‚¤ ì„¤ì •</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•˜ë©´ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤. ì„œë²„ ì¬ì‹œì‘ ì—†ì´ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <div class="space-y-4">
        <!-- YouTube API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ“º</span>
                    <label class="font-medium text-gray-800 dark:text-white">YouTube Data API</label>
                </div>
                <span id="youtubeStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="youtubeApiKey" class="flex-1 input-field text-sm"
                    placeholder="YouTube API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('youtubeApiKey')" class="btn-secondary px-3">
                    <span id="youtubeApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="youtubeKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>

        <!-- Gemini API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ¤–</span>
                    <label class="font-medium text-gray-800 dark:text-white">Gemini API</label>
                </div>
                <span id="geminiStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="geminiApiKey" class="flex-1 input-field text-sm"
                    placeholder="Gemini API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('geminiApiKey')" class="btn-secondary px-3">
                    <span id="geminiApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="geminiKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>

        <!-- ElevenLabs API Key -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span>ğŸ”Š</span>
                    <label class="font-medium text-gray-800 dark:text-white">ElevenLabs TTS (ì„ íƒ)</label>
                </div>
                <span id="elevenlabsStatus" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="flex gap-2">
                <input type="password" id="elevenlabsApiKey" class="flex-1 input-field text-sm"
                    placeholder="ElevenLabs API í‚¤ ì…ë ¥...">
                <button onclick="toggleKeyVisibility('elevenlabsApiKey')" class="btn-secondary px-3">
                    <span id="elevenlabsApiKey-eye">ğŸ‘ï¸</span>
                </button>
            </div>
            <p id="elevenlabsKeyMasked" class="text-xs text-gray-500 mt-1"></p>
        </div>
    </div>

</div>

<!-- Gemini Voice Settings -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ—£ï¸ Gemini ìŒì„± ì„¤ì • (ê¸°ë³¸ê°’)</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        ìƒˆ í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ì ìš©ë  ê¸°ë³¸ ìŒì„± ì„¤ì •ì…ë‹ˆë‹¤.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <!-- ìŒì„± ì„ íƒ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ìŒì„± (Voice)</label>
            <select id="geminiVoice" class="input-field w-full">
                <!-- Loaded via JS -->
            </select>
        </div>

        <!-- ì–¸ì–´ ì„ íƒ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì–¸ì–´ (Language)</label>
            <select id="geminiLanguage" class="input-field w-full">
                <!-- Loaded via JS -->
            </select>
        </div>
    </div>

    <!-- ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ -->
    <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            ìŒì„± ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ (Style Prompt)
            <span class="text-xs text-gray-500 font-normal ml-2">ì˜ˆ: "ì°¨ë¶„í•˜ê³  ì „ë¬¸ì ì¸ í†¤ìœ¼ë¡œ", "í™œê¸°ì°¨ê³  ë¹ ë¥´ê²Œ"</span>
        </label>
        <textarea id="geminiStylePrompt" rows="3" class="input-field w-full"
            placeholder="Geminiì—ê²Œ ìŒì„± ìŠ¤íƒ€ì¼ì— ëŒ€í•´ ì§€ì‹œí•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    </div>
</div>
</div>

<!-- Script Style Prompts -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“œ ëŒ€ë³¸ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ (ì»¤ìŠ¤í…€)</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        ëŒ€ë³¸ ê¸°íš ë° ìƒì„± ì‹œ AIê°€ ì‚¬ìš©í•  ìƒì„¸ ì§€ì¹¨ì…ë‹ˆë‹¤. ê° ìŠ¤íƒ€ì¼ë³„ë¡œ ì›í•˜ëŠ” ê²°ê³¼ë¬¼ì˜ í†¤ì•¤ë§¤ë„ˆë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”.
    </p>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ë‰´ìŠ¤ ë³´ë„ (News Delivery)</label>
            <textarea id="promptNews" class="input-field w-full" rows="6"
                placeholder="ë‰´ìŠ¤ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <p class="text-xs text-gray-500 mt-1">ê°ê´€ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ” ë‰´ìŠ¤ ì „ë‹¬ í†¤ì„ ìœ„í•œ ì§€ì¹¨ì…ë‹ˆë‹¤.</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì˜›ë‚  ì´ì•¼ê¸° (Old Story)</label>
            <textarea id="promptStory" class="input-field w-full" rows="6"
                placeholder="ì˜›ë‚  ì´ì•¼ê¸° ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <p class="text-xs text-gray-500 mt-1">í¥ë¯¸ì§„ì§„í•œ êµ¬ì—°ë™í™”/ìŠ¤í† ë¦¬í…”ë§ì„ ìœ„í•œ ì§€ì¹¨ì…ë‹ˆë‹¤. (ê¸°ë³¸ê°’)</p>
        </div>
    </div>
</div>

<!-- ì €ì¥ ë²„íŠ¼ -->
<div class="mt-6 flex gap-3">
    <button onclick="saveAllSettings()" class="btn-primary px-6">
        ğŸ’¾ ì „ì²´ ì„¤ì • ì €ì¥
    </button>
    <button onclick="loadAllSettings()" class="btn-secondary">
        ğŸ”„ ìƒˆë¡œê³ ì¹¨
    </button>
</div>
</div>

<!-- API ì—°ê²° ìƒíƒœ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“¡ API ì—°ê²° ìƒíƒœ</h3>
    <div id="apiStatusList" class="space-y-3">
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ“º</span>
                <span>YouTube Data API</span>
            </div>
            <span id="youtubeConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ¤–</span>
                <span>Gemini API</span>
            </div>
            <span id="geminiConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
                <span>ğŸ”Š</span>
                <span>ElevenLabs TTS</span>
            </div>
            <span id="elevenlabsConnectionStatus" class="text-gray-500">í™•ì¸ ì¤‘...</span>
        </div>
    </div>
</div>

<!-- ì±„ë„ ê´€ë¦¬ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“º ì±„ë„ ê´€ë¦¬</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        ì˜ìƒ ì—…ë¡œë“œ ì‹œ ì„ íƒí•  ìœ íŠœë¸Œ ì±„ë„ ëª©ë¡ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
    </p>

    <!-- ì±„ë„ ëª©ë¡ -->
    <div id="channelList" class="space-y-3 mb-4">
        <!-- JSë¡œ ë¡œë“œë¨ -->
        <p class="text-gray-500 text-sm">ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- ì±„ë„ ì¶”ê°€ í¼ -->
    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <h4 class="font-medium text-gray-800 dark:text-white mb-2 text-sm">ìƒˆ ì±„ë„ ì¶”ê°€</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input type="text" id="newChannelName" class="input-field text-sm" placeholder="ì±„ë„ëª… (ì˜ˆ: ë‚´ ì¼ìƒ ì±„ë„)">
            <input type="text" id="newChannelHandle" class="input-field text-sm" placeholder="í•¸ë“¤ (ì˜ˆ: @myvlog)">
            <button onclick="addChannel()" class="btn-primary text-sm whitespace-nowrap">
                â• ì¶”ê°€í•˜ê¸°
            </button>
        </div>
        <input type="text" id="newChannelDesc" class="input-field text-sm mt-3 w-full" placeholder="ì„¤ëª… (ì„ íƒì‚¬í•­)">
    </div>
</div>

<!-- API í‚¤ ë°œê¸‰ ë§í¬ -->
<div class="card mb-6">

    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ”— API í‚¤ ë°œê¸‰</h3>
    <div class="space-y-3">
        <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ“º</span>
                <span>YouTube Data API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
        <a href="https://aistudio.google.com/apikey" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ¤–</span>
                <span>Gemini API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
        <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank"
            class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
            <div class="flex items-center gap-3">
                <span>ğŸ”Š</span>
                <span>ElevenLabs API í‚¤ ë°œê¸‰</span>
            </div>
            <span class="text-blue-500">â†’</span>
        </a>
    </div>
</div>

<!-- ë°ì´í„° ê´€ë¦¬ -->
<div class="card">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ—‚ï¸ ë¡œì»¬ ë°ì´í„° ê´€ë¦¬</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
    </p>
    <div class="flex gap-3">
        <button onclick="exportData()" class="btn-secondary">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button onclick="clearData()" class="btn-secondary text-red-600">ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Gemini Constants
    const GEMINI_VOICES = [
        "Puck", "Charon", "Kore", "Fenrir", "Aoede", "Zephyr", "Orpheus", "Cupid",
        "Autonoe", "Callirrhoe", "Laomedeia", "Leda", "Despina", "Sulafat",
        "Algenib", "Alnilam", "Achernar", "Achird", "Enceladus", "Vega",
        "Ursa", "Pegasus", "Nova", "Eclipse", "Lyra", "Orbit", "Dipper",
        "Capella", "Orion"
    ];

    const GEMINI_LANGUAGES = [
        "ko-KR", "en-US", "ja-JP", "es-US", "fr-FR", "de-DE", "hi-IN", "id-ID",
        "it-IT", "pt-BR", "ru-RU", "nl-NL", "pl-PL", "th-TH", "tr-TR", "vi-VN",
        "ro-RO", "uk-UA", "bn-BD", "en-IN", "mr-IN", "ta-IN", "te-IN", "ar-EG"
    ];

    // Populate Select Options
    function populateOptions() {
        const voiceSelect = document.getElementById('geminiVoice');
        const langSelect = document.getElementById('geminiLanguage');

        voiceSelect.innerHTML = GEMINI_VOICES.map(v => `<option value="${v}">${v}</option>`).join('');
        langSelect.innerHTML = GEMINI_LANGUAGES.map(l => `<option value="${l}">${l}</option>`).join('');
    }

    // Load All Settings
    async function loadAllSettings() {
        await loadApiKeys();

        try {
            const res = await fetch('/api/settings');
            const data = await res.json();

            if (data.gemini_tts) {
                document.getElementById('geminiVoice').value = data.gemini_tts.voice_name || 'Puck';
                document.getElementById('geminiLanguage').value = data.gemini_tts.language_code || 'ko-KR';
                document.getElementById('geminiStylePrompt').value = data.gemini_tts.style_prompt || '';
            }

            if (data.script_styles) {
                document.getElementById('promptNews').value = data.script_styles.news || '';
                document.getElementById('promptStory').value = data.script_styles.story || '';
            }
        } catch (e) {
            console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // Save All
    async function saveAllSettings() {
        // Save Keys first
        await saveApiKeys(); // This saves API keys to .env (via existing logic)

        // Save Global Settings
        const settings = {
            gemini_tts: {
                voice_name: document.getElementById('geminiVoice').value,
                language_code: document.getElementById('geminiLanguage').value,
                style_prompt: document.getElementById('geminiStylePrompt').value
            },
            script_styles: {
                news: document.getElementById('promptNews').value,
                story: document.getElementById('promptStory').value
            }
        };

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res.ok) {
                Utils.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                Utils.showToast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', e);
        }
    }

    // í‚¤ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
    function toggleKeyVisibility(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById(inputId + '-eye');

        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.textContent = 'ğŸ™ˆ';
        } else {
            input.type = 'password';
            eyeIcon.textContent = 'ğŸ‘ï¸';
        }
    }

    // API í‚¤ ìƒíƒœ ë¡œë“œ
    async function loadApiKeys() {
        try {
            const keys = await API.apiKeys.get();

            // YouTube
            if (keys.youtube) {
                document.getElementById('youtubeStatus').innerHTML = keys.youtube.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('youtubeKeyMasked').textContent = keys.youtube.masked
                    ? `í˜„ì¬ í‚¤: ${keys.youtube.masked}`
                    : '';
            }

            // Gemini
            if (keys.gemini) {
                document.getElementById('geminiStatus').innerHTML = keys.gemini.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-red-600">âŒ ë¯¸ì„¤ì •</span>';
                document.getElementById('geminiKeyMasked').textContent = keys.gemini.masked
                    ? `í˜„ì¬ í‚¤: ${keys.gemini.masked}`
                    : '';
            }

            // ElevenLabs
            if (keys.elevenlabs) {
                document.getElementById('elevenlabsStatus').innerHTML = keys.elevenlabs.set
                    ? '<span class="text-green-600">âœ… ì„¤ì •ë¨</span>'
                    : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì •</span>';
                document.getElementById('elevenlabsKeyMasked').textContent = keys.elevenlabs.masked
                    ? `í˜„ì¬ í‚¤: ${keys.elevenlabs.masked}`
                    : '';
            }

        } catch (e) {
            console.error('API í‚¤ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
    }

    // API í‚¤ ì €ì¥ (Existing, modified to communicate saving)
    async function saveApiKeys() {
        const keys = {};

        const youtube = document.getElementById('youtubeApiKey').value.trim();
        const gemini = document.getElementById('geminiApiKey').value.trim();
        const elevenlabs = document.getElementById('elevenlabsApiKey').value.trim();

        if (youtube) keys.youtube = youtube;
        if (gemini) keys.gemini = gemini;
        if (elevenlabs) keys.elevenlabs = elevenlabs;

        if (Object.keys(keys).length > 0) {
            try {
                await API.apiKeys.save(keys);
                document.getElementById('youtubeApiKey').value = '';
                document.getElementById('geminiApiKey').value = '';
                document.getElementById('elevenlabsApiKey').value = '';
                await loadApiKeys();
                await checkApiConnection();
            } catch (e) {
                console.error('API í‚¤ ì €ì¥ ì˜¤ë¥˜:', e);
            }
        }
    }

    // API ì—°ê²° ìƒíƒœ í™•ì¸
    async function checkApiConnection() {
        try {
            const health = await API.health();

            document.getElementById('youtubeConnectionStatus').innerHTML = health.apis?.youtube
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('geminiConnectionStatus').innerHTML = health.apis?.gemini
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-red-600">âŒ ë¯¸ì—°ê²°</span>';

            document.getElementById('elevenlabsConnectionStatus').innerHTML = health.apis?.elevenlabs
                ? '<span class="text-green-600">âœ… ì—°ê²°ë¨</span>'
                : '<span class="text-yellow-600">âš ï¸ ë¯¸ì„¤ì • (ì„ íƒ)</span>';

        } catch (e) {
            console.error('ì—°ê²° ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', e);
        }
    }

    function exportData() {
        const data = {
            analysisData: Utils.storage.get('analysisData'),
            scriptStructure: Utils.storage.get('scriptStructure'),
            fullScript: Utils.storage.get('fullScript'),
            imagePrompts: Utils.storage.get('imagePrompts'),
            exportedAt: new Date().toISOString()
        };

        Utils.downloadFile(JSON.stringify(data, null, 2), 'picadillystudio_backup.json', 'application/json');
        Utils.showToast('ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤', 'success');
    }

    function clearData() {
        if (!confirm('ëª¨ë“  ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(API í‚¤ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

        Utils.storage.remove('analysisData');
        Utils.storage.remove('scriptStructure');
        Utils.storage.remove('fullScript');
        Utils.storage.remove('imagePrompts');
        Utils.storage.remove('ttsAudio');

        Utils.showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // ì±„ë„ ë¡œë“œ
    async function loadChannels() {
        const list = document.getElementById('channelList');
        try {
            const res = await fetch('/api/channels');
            if (!res.ok) throw new Error('ì±„ë„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            const channels = await res.json();

            if (channels.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // credentials_pathê°€ ìˆìœ¼ë©´ ì¸ì¦ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
            list.innerHTML = channels.map(ch => {
                const isAuthenticated = !!ch.credentials_path;
                const statusBadge = isAuthenticated
                    ? '<span class="text-green-600 border border-green-200 bg-green-50 px-2 py-0.5 rounded text-xs">âœ… ì—°ê²°ë¨</span>'
                    : '<span class="text-gray-500 border border-gray-200 bg-gray-50 px-2 py-0.5 rounded text-xs">âŒ ë¯¸ì—°ê²°</span>';

                const authBtn = isAuthenticated
                    ? `<button onclick="authenticateChannel(${ch.id}, '${ch.name}')" class="text-blue-500 hover:text-blue-700 text-xs border border-blue-200 px-2 py-1 rounded">ğŸ”„ ì¬ì—°ê²°</button>`
                    : `<button onclick="authenticateChannel(${ch.id}, '${ch.name}')" class="text-white bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-xs shadow-sm">ğŸ”‘ ë¡œê·¸ì¸</button>`;

                return `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-lg shadow-sm">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-gray-800 dark:text-white">${ch.name}</span>
                            <span class="text-xs text-gray-500 font-normal">${ch.handle}</span>
                            ${statusBadge}
                        </div>
                        ${ch.description ? `<p class="text-xs text-gray-500">${ch.description}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${authBtn}
                        <button onclick="deleteChannel(${ch.id})" class="text-red-500 hover:text-red-700 p-2" title="ì‚­ì œ">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `}).join('');

        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-red-500 text-sm">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // ì±„ë„ ì¸ì¦ (OAuth)
    async function authenticateChannel(id, name) {
        if (!confirm(`'${name}' ì±„ë„ì˜ ìœ íŠœë¸Œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì°¸ê³ : ìƒˆ ì°½ì´ ëœ¨ë©´ í•´ë‹¹ ì±„ë„ì˜ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.)`)) return;

        try {
            // ì´ ìš”ì²­ì€ ì„œë²„ì—ì„œ Python ë¡œì»¬ ì„œë²„ë¥¼ í†µí•´ ë¸Œë¼ìš°ì €ë¥¼ ë„ìš°ë¯€ë¡œ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ
            Utils.showToast('ì¸ì¦ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”...', 'info');

            const res = await fetch(`/api/auth/youtube/${id}`);
            const data = await res.json();

            if (res.ok) {
                Utils.showToast(data.message || 'ì¸ì¦ ì™„ë£Œ!', 'success');
                loadChannels();
            } else {
                Utils.showToast(data.detail || 'ì¸ì¦ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì¸ì¦ ê³¼ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì±„ë„ ì¶”ê°€
    async function addChannel() {

        const nameInput = document.getElementById('newChannelName');
        const handleInput = document.getElementById('newChannelHandle');
        const descInput = document.getElementById('newChannelDesc');

        const name = nameInput.value.trim();
        let handle = handleInput.value.trim();
        const description = descInput.value.trim();

        if (!name || !handle) {
            Utils.showToast('ì±„ë„ëª…ê³¼ í•¸ë“¤ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        if (!handle.startsWith('@')) {
            handle = '@' + handle;
        }

        try {
            const res = await fetch('/api/channels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, handle, description })
            });

            if (res.ok) {
                Utils.showToast('ì±„ë„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                nameInput.value = '';
                handleInput.value = '';
                descInput.value = '';
                loadChannels(); // ëª©ë¡ ê°±ì‹ 
            } else {
                const err = await res.json();
                Utils.showToast(err.detail || 'ì±„ë„ ì¶”ê°€ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì±„ë„ ì‚­ì œ
    async function deleteChannel(id) {
        if (!confirm('ì •ë§ ì´ ì±„ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const res = await fetch(`/api/channels/${id}`, { method: 'DELETE' });
            if (res.ok) {
                Utils.showToast('ì±„ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                loadChannels();
            } else {
                Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„œë²„ ì˜¤ë¥˜', 'error');
        }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        populateOptions();
        loadAllSettings();
        checkApiConnection();
        loadChannels(); // ì±„ë„ ëª©ë¡ ë¡œë“œ
    });
</script>
{% endblock %}