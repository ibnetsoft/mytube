{% extends "base.html" %}

{% block content %}
<div class="card mb-6">
    <div class="flex flex-wrap items-center gap-6 mb-6">
        <h3 class="font-bold text-gray-800 dark:text-white shrink-0">ğŸ¥ ì¸íŠ¸ë¡œ ì„¤ì • (Loop Mode)</h3>

        <div class="flex flex-wrap items-center gap-4">
            <!-- Video Options -->
            <div id="videoOptions" class="flex flex-wrap items-center gap-4">
                <!-- Search Controls -->
                <div id="vidSearchControls" class="flex flex-wrap items-center gap-2">
                    <div class="relative">
                        <input type="text" id="videoSearchQuery" placeholder="ê²€ìƒ‰ì–´ (ì˜ˆ: winter night)"
                            class="pl-3 pr-10 py-1.5 text-xs rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 w-40">
                        <button onclick="searchVideos()"
                            class="absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-500 hover:text-blue-600">
                            ğŸ”
                        </button>
                    </div>

                    <button onclick="searchVideos(true)" id="autoVideoBtn"
                        class="btn-primary py-1.5 px-3 flex items-center justify-center gap-2 text-xs font-bold shadow-md bg-gradient-to-r from-teal-500 to-emerald-600">
                        <span>ğŸ¤– ìë™</span>
                    </button>
                </div>

                <!-- Separator -->
                <div class="h-6 w-px bg-gray-300 dark:bg-gray-600 mx-2"></div>

                <!-- Upload Controls -->
                <div class="flex items-center gap-2">
                    <input type="file" id="introVideoInput" accept="video/*" class="hidden"
                        onchange="uploadIntroVideo(this)">
                    <button onclick="document.getElementById('introVideoInput').click()"
                        class="btn-secondary py-1.5 px-3 flex items-center justify-center gap-2 text-xs font-bold shadow-sm">
                        <span>ğŸ“¤ ì˜ìƒ ì—…ë¡œë“œ</span>
                    </button>
                    <span id="uploadStatus" class="text-xs text-gray-500 hidden">ì—…ë¡œë“œ ì¤‘...</span>
                </div>
            </div>
        </div>

        <!-- Whisk Tool Link -->
        <a href="https://labs.google/fx/ko/tools/flow" target="_blank"
            class="ml-auto flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400 hover:underline bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-full border border-blue-100 dark:border-blue-800 transition">
            <span>ğŸ¥ VideoFX (Flow)</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
        </a>
    </div>
</div>

<div id="resultSection">
    <div class="card">
        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100 dark:border-gray-700">
            <h3 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <span>ğŸ¬</span> ë™ì˜ìƒ ê²°ê³¼
            </h3>
        </div>

        <!-- Video Results Container -->
        <div id="videoResultsList" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>

        <!-- ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
        <div id="nextStepSection" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-center">
            <h4 class="font-bold text-lg mb-2 text-blue-800 dark:text-blue-300">ğŸ‰ ë™ì˜ìƒ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
            <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">ë°°ê²½ ë™ì˜ìƒì€ ìë™ìœ¼ë¡œ ë°˜ë³µ ì¬ìƒë©ë‹ˆë‹¤.</p>
            <a href="/tts" class="btn-primary inline-flex items-center gap-2">
                <span>ğŸ”Š</span> ìŒì„±(TTS) ìƒì„±í•˜ëŸ¬ ê°€ê¸°
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function searchVideos(isAuto = false) {
        const projectId = getCurrentProject();
        let query = document.getElementById('videoSearchQuery').value;
        let script = "";

        if (isAuto) {
            const scriptData = Utils.storage.get('fullScript');
            if (scriptData && scriptData.script) {
                script = scriptData.script;
            } else {
                // [FIX] Fallback to DB if local storage is empty
                if (projectId) {
                    try {
                        const result = await API.project.getScript(projectId);
                        if (result && result.full_script) {
                            script = result.full_script;
                            // Optionally save back to storage for next time
                            Utils.storage.set('fullScript', { script: result.full_script });
                        }
                    } catch (e) {
                        console.error("DB Script fetch failed:", e);
                    }
                }

                if (!script) {
                    Utils.showToast('ëŒ€ë³¸ì´ ì—†ì–´ ìë™ ê²€ìƒ‰ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }
            }
        } else {
            if (!query) {
                Utils.showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
        }

        const btn = isAuto ? document.getElementById('autoVideoBtn') : null;
        if (btn) Utils.setLoading(btn, true, 'ê²€ìƒ‰ ì¤‘...');

        try {
            // Style Default: realistic or cinematic
            const style = 'cinematic';
            const result = await API.video.search(script, style, isAuto ? null : query);

            if (result.status === 'ok') {
                if (result.search_query) {
                    document.getElementById('videoSearchQuery').value = result.search_query;
                }
                renderVideoResults(result.videos);
                Utils.showToast(`${result.videos.length}ê°œì˜ ì˜ìƒì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success');
            } else {
                Utils.showToast('ê²€ìƒ‰ ì‹¤íŒ¨: ' + result.error, 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
        } finally {
            if (btn) Utils.setLoading(btn, false);
        }
    }

    function renderVideoResults(videos) {
        const container = document.getElementById('videoResultsList');
        if (!videos || videos.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        container.innerHTML = videos.map(v => `
            <div class="group relative rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-all bg-black cursor-pointer" onclick="selectVideo('${v.url}', '${v.image}', ${v.id})">
                <div class="aspect-video relative">
                    <img src="${v.image}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-white text-3xl opacity-0 group-hover:opacity-100 transition-opacity">â–¶ï¸</span>
                    </div>
                    <div class="absolute bottom-1 right-1 bg-black/70 text-white text-[10px] px-1 rounded">
                        ${v.duration}s
                    </div>
                </div>
                <!-- Selection Overlay -->
                <div id="vid-selected-${v.id}" class="hidden absolute inset-0 bg-blue-500/30 border-4 border-blue-500 flex items-start justify-end p-2">
                    <div class="bg-blue-500 text-white rounded-full p-1 shadow-lg">âœ“</div>
                </div>
            </div>
        `).join('');
    }

    async function selectVideo(url, image, id) {
        // UI Selection Highlight
        document.querySelectorAll('[id^="vid-selected-"]').forEach(el => el.classList.add('hidden'));

        // Escape special chars handling
        const el = document.getElementById(`vid-selected-${id}`);
        if (el) el.classList.remove('hidden');

        // Save to Project Settings
        const projectId = getCurrentProject();
        if (projectId) {
            try {
                await API.project.updateSetting(projectId, 'background_video_url', url);
                await API.project.updateSetting(projectId, 'video_path', null); // Reset video path to force re-render perception
                Utils.showToast('ë°°ê²½ ë™ì˜ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. (Loop Mode)', 'success');

                // [NEW] Update Stepper
                if (window.updateStepStatus) window.updateStepStatus('intro', true);

                document.getElementById('nextStepSection').classList.remove('hidden');
            } catch (e) {
                console.error(e);
                Utils.showToast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        }
    }



    async function uploadIntroVideo(input) {
        if (!input.files || input.files.length === 0) return;

        const file = input.files[0];
        const projectId = getCurrentProject();

        if (!projectId) {
            Utils.showToast("í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
            input.value = ''; // Reset
            return;
        }

        const status = document.getElementById('uploadStatus');
        status.textContent = "ì—…ë¡œë“œ ì¤‘...";
        status.classList.remove('hidden');

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(`/api/projects/${projectId}/intro/save`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.status === 'ok') {
                Utils.showToast('ì¸íŠ¸ë¡œ ì˜ìƒì´ ì—…ë¡œë“œ ë° ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                status.textContent = "ì™„ë£Œ!";
                setTimeout(() => status.classList.add('hidden'), 2000);

                // [NEW] Update Stepper
                if (window.updateStepStatus) window.updateStepStatus('intro', true);

                // Show as a result card (Mock ID) - using a video tag for thumbnail could be complex, 
                // so we just show a generic placeholder or the video itself.
                const mockVideo = {
                    id: 'uploaded_' + Date.now(),
                    url: result.url,
                    image: '/static/img/video_placeholder.png', // You might not have this, so use a data URI or just a colored box
                    duration: 'Uploaded'
                };

                // If we don't have a placeholder image, let's use a colored div in render
                // But renderVideoResults expects an image URL.
                // Let's create a temporary card manually or just force selection state.

                // Show Next Step
                document.getElementById('nextStepSection').classList.remove('hidden');

                // Optional: Render it to the list
                const container = document.getElementById('videoResultsList');
                container.innerHTML = `
                    <div class="group relative rounded-lg overflow-hidden border border-blue-500 shadow-md bg-black cursor-pointer">
                        <div class="aspect-video relative flex items-center justify-center bg-gray-800">
                             <video src="${result.url}" class="w-full h-full object-contain" muted onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>
                            <div class="absolute bottom-1 right-1 bg-blue-600 text-white text-[10px] px-1 rounded">
                                Uploaded
                            </div>
                        </div>
                        <div class="absolute inset-0 bg-blue-500/30 border-4 border-blue-500 flex items-start justify-end p-2 pointer-events-none">
                            <div class="bg-blue-500 text-white rounded-full p-1 shadow-lg">âœ“</div>
                        </div>
                    </div>
                `;

            } else {
                Utils.showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (result.error || 'Unknown'), 'error');
                status.classList.add('hidden');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            status.classList.add('hidden');
        } finally {
            input.value = ''; // Reset input
        }
    }

    function updateHeaderStatus(stepName, isComplete) {
        const step = document.querySelector(`.step-item[data-step="${stepName}"]`);
        if (step && isComplete) {
            const circle = step.querySelector('.step-circle');
            const text = step.querySelector('span');

            if (circle) {
                circle.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'border-white', 'dark:border-gray-900');
                circle.classList.add('bg-green-500', 'border-green-500', 'text-white');
                circle.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>';
            }

            if (text) {
                text.classList.remove('text-gray-400');
                text.classList.add('text-green-600', 'dark:text-green-400', 'font-bold');
            }
        }
    }

    // Auto-Search on Load if coming from "Old Story"
    document.addEventListener('DOMContentLoaded', async () => {
        const projectId = getCurrentProject();
        if (projectId) {
            try {
                const fullData = await API.project.getFull(projectId);

                // [NEW] Check Intro Video Persistence or Generic Background Persistence
                let videoPath = fullData.settings && fullData.settings.intro_video_path;
                let isIntroUpload = true;

                if (!videoPath) {
                    videoPath = fullData.settings && fullData.settings.background_video_url;
                    isIntroUpload = false;
                }

                if (videoPath) {
                    // Normalize Path
                    let webPath = videoPath;
                    if (videoPath.includes('\\') || (videoPath.startsWith('uploads') && !videoPath.startsWith('/'))) {
                        webPath = videoPath.replace(/\\/g, '/');
                        if (!webPath.startsWith('/')) {
                            webPath = '/' + webPath;
                        }
                    }

                    // Render Card
                    const container = document.getElementById('videoResultsList');
                    if (container) {
                        const label = isIntroUpload ? "Uploaded" : "Selected";
                        container.innerHTML = `
                            <div class="group relative rounded-lg overflow-hidden border border-blue-500 shadow-md bg-black cursor-pointer">
                                <div class="aspect-video relative flex items-center justify-center bg-gray-800">
                                    <video src="${webPath}" class="w-full h-full object-contain" muted onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>
                                    <div class="absolute bottom-1 right-1 bg-blue-600 text-white text-[10px] px-1 rounded">
                                        ${label}
                                    </div>
                                </div>
                                <div class="absolute inset-0 bg-blue-500/30 border-4 border-blue-500 flex items-start justify-end p-2 pointer-events-none">
                                    <div class="bg-blue-500 text-white rounded-full p-1 shadow-lg">âœ“</div>
                                </div>
                            </div>
                        `;
                    }

                    const nextSection = document.getElementById('nextStepSection');
                    if (nextSection) nextSection.classList.remove('hidden');

                    // Update Header Status (Green Light)
                    updateHeaderStatus('intro', true);

                    // Status Badge Update
                    const status = document.getElementById('uploadStatus');
                    if (status) {
                        status.textContent = "ì €ì¥ëœ ì˜ìƒ ë¶ˆëŸ¬ì˜´";
                        status.classList.remove('hidden');
                    }
                }
            } catch (e) {
                console.error("Load failed", e);
            }
        }
    });
</script>
{% endblock %}