{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <style>
        /* External Fonts for Preview */
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@700;800&display=swap');

        @font-face {
            font-family: 'CookieRun-Regular';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/CookieRun-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'GmarketSansBold';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansBold.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        .font-radio-label {
            cursor: pointer;
        }

        .font-radio-box {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s;
            background: white;
            color: #374151;
            font-weight: 500;
        }

        .dark .font-radio-box {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        .color-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .color-circle.active {
            border-color: #3b82f6;
            transform: scale(1.2);
        }

        .color-circle:hover {
            transform: scale(1.1);
        }
    </style>
    <!-- í—¤ë” -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ìë§‰ í¸ì§‘ (Subtitle Editor)</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-2">AIê°€ ìƒì„±í•œ ìë§‰ì˜ ì‹±í¬ì™€ ì˜¤íƒ€ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.</p>
        </div>
        <div class="flex gap-2">
            <button onclick="saveSubtitles()" class="btn-primary">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            <a href="/render" class="btn-secondary">ë‹¤ìŒ ë‹¨ê³„ ></a>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (ê³ ì •) -->
    <div
        class="sticky top-4 z-30 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg mb-6 border border-gray-200 dark:border-gray-700">
        <h3 class="font-bold text-sm mb-2 text-gray-700 dark:text-gray-300">ğŸ”Š ì˜¤ë””ì˜¤ ë¯¸ë¦¬ë“£ê¸°</h3>
        <audio id="audioPlayer" controls class="w-full"></audio>
    </div>

    <!-- ìë§‰ ìŠ¤íƒ€ì¼ ë° í¬ê¸° ì„ íƒ -->
    <div class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-sm text-gray-700 dark:text-gray-300">ğŸ¨ ìë§‰ ìŠ¤íƒ€ì¼ ì„¤ì •</h3>

            <!-- í°íŠ¸ í¬ê¸° ìŠ¬ë¼ì´ë” -->
            <div
                class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700 px-3 py-1 rounded-full border border-gray-200 dark:border-gray-600">
                <span class="text-xs font-bold text-gray-500">í¬ê¸°</span>
                <input type="range" id="fontSizeSlider" min="5" max="100" value="40" step="1"
                    class="w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                <span id="fontSizeValue"
                    class="text-xs font-mono w-8 text-right text-blue-600 dark:text-blue-400 font-bold">40</span>
            </div>
        </div>

        <!-- [NEW] ìë§‰ ì„œì²´ ë° ìƒ‰ìƒ ì„¤ì • -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
            <!-- í°íŠ¸ ì„ íƒ (ë¼ë””ì˜¤ ë²„íŠ¼) -->
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-3">ğŸ”¤ ìë§‰ ì„œì²´ (Font)</label>
                <div class="flex flex-wrap gap-3">
                    <label class="font-radio-label">
                        <input type="radio" name="subtitle_font" value="Malgun-Gothic-Bold" class="hidden peer">
                        <div
                            class="font-radio-box peer-checked:border-blue-600 peer-checked:bg-blue-600 peer-checked:text-white">
                            ë§‘ì€ ê³ ë”•</div>
                    </label>
                    <label class="font-radio-label">
                        <input type="radio" name="subtitle_font" value="CookieRun Regular" class="hidden peer">
                        <div
                            class="font-radio-box peer-checked:border-blue-600 peer-checked:bg-blue-600 peer-checked:text-white">
                            ì¿ í‚¤ëŸ°</div>
                    </label>
                    <label class="font-radio-label">
                        <input type="radio" name="subtitle_font" value="GmarketSansBold" class="hidden peer" checked>
                        <div
                            class="font-radio-box peer-checked:border-blue-600 peer-checked:bg-blue-600 peer-checked:text-white">
                            Gë§ˆì¼“ ì‚°ìŠ¤</div>
                    </label>
                    <label class="font-radio-label">
                        <input type="radio" name="subtitle_font" value="NanumMyeongjo" class="hidden peer">
                        <div
                            class="font-radio-box peer-checked:border-blue-600 peer-checked:bg-blue-600 peer-checked:text-white">
                            ë‚˜ëˆ”ëª…ì¡°</div>
                    </label>
                </div>
            </div>

            <!-- ìƒ‰ìƒ ì„ íƒ -->
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-3">ğŸ¨ ìë§‰ ê¸°ë³¸ ìƒ‰ìƒ (Color)</label>
                <div class="flex flex-wrap gap-2" id="colorPalette">
                    <!-- ìƒ‰ìƒ ì„œí´ë“¤ -->
                    <div onclick="selectColor('white')" data-color="white"
                        class="color-circle bg-white border border-gray-300 active" title="í°ìƒ‰"></div>
                    <div onclick="selectColor('yellow')" data-color="yellow" class="color-circle bg-yellow-400"
                        title="ë…¸ë‘"></div>
                    <div onclick="selectColor('#FFD700')" data-color="#FFD700" class="color-circle bg-[#FFD700]"
                        title="ê³¨ë“œ"></div>
                    <div onclick="selectColor('#00FF00')" data-color="#00FF00" class="color-circle bg-[#00FF00]"
                        title="ë¼ì„"></div>
                    <div onclick="selectColor('#FF00FF')" data-color="#FF00FF" class="color-circle bg-[#FF00FF]"
                        title="í•‘í¬"></div>
                    <div onclick="selectColor('black')" data-color="black" class="color-circle bg-black" title="ê²€ì •">
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="styleSelector">
            <!-- Basic White -->
            <div onclick="selectStyle('Basic_White')"
                class="style-card cursor-pointer p-3 rounded border-2 border-transparent hover:border-blue-300 transition-all text-center bg-gray-600 relative overflow-hidden group"
                data-style="Basic_White">
                <div class="absolute inset-0 bg-gray-500 opacity-20 group-hover:opacity-10 transition-opacity"></div>
                <!-- [Updated] Bold font + Thicker stroke (simulated with more shadows) -->
                <div class="text-xl font-bold text-white relative z-10" style="text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 
                           2px 0px 0 #000, -2px 0px 0 #000, 0px 2px 0 #000, 0px -2px 0 #000;">
                    ê¸°ë³¸ í™”ì´íŠ¸
                </div>
            </div>
            <!-- Vlog Yellow -->
            <div onclick="selectStyle('Vlog_Yellow')"
                class="style-card cursor-pointer p-3 rounded border-2 border-transparent hover:border-blue-300 transition-all text-center bg-gray-100 relative overflow-hidden group"
                data-style="Vlog_Yellow">
                <div class="text-xl font-bold relative z-10"
                    style="color: #FFD700; text-shadow: 2px 2px 0 #4B0082, -1px -1px 0 #4B0082, 1px -1px 0 #4B0082, -1px 1px 0 #4B0082, 1px 1px 0 #4B0082;">
                    ì˜ˆëŠ¥ ì˜ë¡œìš°
                </div>
            </div>
            <!-- Cinematic Box -->
            <div onclick="selectStyle('Cinematic_Box')"
                class="style-card cursor-pointer p-3 rounded border-2 border-transparent hover:border-blue-300 transition-all text-center relative overflow-hidden group bg-cover bg-center"
                style="background-image: url('https://picsum.photos/200/50?blur=2')" data-style="Cinematic_Box">
                <!-- [Updated] Tight vertical padding (py-0) + Bold text -->
                <div
                    class="inline-block px-4 py-0 bg-black/60 text-white text-lg font-bold backdrop-blur-sm leading-snug pb-1">
                    ì‹œë„¤ë§ˆí‹± ë°•ìŠ¤
                </div>
            </div>
            <!-- Cute Pink -->
            <div onclick="selectStyle('Cute_Pink')"
                class="style-card cursor-pointer p-3 rounded border-2 border-transparent hover:border-blue-300 transition-all text-center bg-pink-50 relative overflow-hidden group"
                data-style="Cute_Pink">
                <div class="text-xl font-bold relative z-10"
                    style="color: #FF69B4; text-shadow: 2px 2px 0 #FFF, -1px -1px 0 #FFF, 1px -1px 0 #FFF, -1px 1px 0 #FFF, 1px 1px 0 #FFF; filter: drop-shadow(0 0 1px rgba(0,0,0,0.1));">
                    íí‹° í•‘í¬
                </div>
            </div>
            <!-- Neon Green -->
            <div onclick="selectStyle('Neon_Green')"
                class="style-card cursor-pointer p-3 rounded border-2 border-transparent hover:border-blue-300 transition-all text-center bg-gray-900 relative overflow-hidden group"
                data-style="Neon_Green">
                <div class="text-xl font-bold relative z-10" style="color: #00FF00; text-shadow: 2px 2px 0 #000;">
                    ë„¤ì˜¨ ê·¸ë¦°
                </div>
            </div>
        </div>
    </div>

    <!-- ìë§‰ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card p-0 overflow-hidden">
        <div
            class="bg-gray-50 dark:bg-gray-700 p-3 grid grid-cols-12 gap-2 text-sm font-bold border-b border-gray-200 dark:border-gray-600">
            <div class="col-span-2 text-center">ì´ë¯¸ì§€</div>
            <div class="col-span-2 text-center">ì‹œì‘ ì‹œê°„</div>
            <div class="col-span-2 text-center">ì¢…ë£Œ ì‹œê°„</div>
            <div class="col-span-5 text-center">ë‚´ìš©</div>
            <div class="col-span-1 text-center">ì‚­ì œ</div>
        </div>
        <div id="subtitleList" class="divide-y divide-gray-100 dark:divide-gray-700">
            <!-- ìë§‰ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì  ìƒì„±ë¨ -->
            <div class="p-8 text-center text-gray-500">
                ìë§‰ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
            </div>
        </div>

        <!-- í•˜ë‹¨ ì¶”ê°€ ë²„íŠ¼ -->
        <div class="p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 text-center">
            <button onclick="addSubtitleRow()" class="text-blue-500 hover:text-blue-700 font-bold text-sm">
                + ìë§‰ ë¼ì¸ ì¶”ê°€
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let projectId = Utils.storage.get('currentProjectId');
    // Ensure numeric
    if (projectId && typeof projectId === 'string') projectId = parseInt(projectId);

    let subtitles = [];
    let images = [];
    let audioDuration = 0;


    async function loadSubtitles() {
        try {
            // Load project settings first
            const projectData = await API.project.getFull(projectId);
            if (projectData.settings) {
                const s = projectData.settings;

                // í°íŠ¸ í¬ê¸°
                if (s.subtitle_font_size) {
                    document.getElementById('fontSizeSlider').value = s.subtitle_font_size;
                    document.getElementById('fontSizeValue').textContent = s.subtitle_font_size;
                }

                // í°íŠ¸ ì„œì²´ (Radio)
                if (s.subtitle_font) {
                    const radio = document.querySelector(`input[name="subtitle_font"][value="${s.subtitle_font}"]`);
                    if (radio) {
                        radio.checked = true;
                        updateFontPreview(s.subtitle_font);
                    }
                } else {
                    // ê¸°ë³¸ê°’ GmarketSansBold ì„¤ì •
                    const radio = document.querySelector(`input[name="subtitle_font"][value="GmarketSansBold"]`);
                    if (radio) {
                        radio.checked = true;
                        updateFontPreview("GmarketSansBold");
                    }
                }

                // ìƒ‰ìƒ
                if (s.subtitle_color) {
                    selectColor(s.subtitle_color, false); // false = don't save again
                }

                // ìŠ¤íƒ€ì¼
                if (s.subtitle_style_enum) {
                    selectStyle(s.subtitle_style_enum, false);
                }
            }

            const res = await fetch(`/api/subtitle/${projectId}`);
            const data = await res.json();

            if (data.status === 'error') {
                Utils.showToast(data.error, 'error');
                return;
            }

            // ì˜¤ë””ì˜¤ ì„¤ì •
            const audio = document.getElementById('audioPlayer');
            audio.src = data.audio_url;
            audio.onloadedmetadata = () => {
                audioDuration = audio.duration;
            };

            // ì´ë¯¸ì§€ ë° ìë§‰ ë¡œë“œ
            images = data.images || [];
            subtitles = data.subtitles || [];

            // ìë§‰ì´ ì—†ìœ¼ë©´ ìë™ ìƒì„± ì‹œë„
            if (subtitles.length === 0) {
                Utils.showToast('ìë§‰ ìë™ ë¶„ì„ ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)', 'info');
                await generateSubtitles();
            } else {
                renderSubtitles();
            }

        } catch (e) {
            console.error(e);
            Utils.showToast('ìë§‰ ë¡œë“œ ì‹¤íŒ¨', 'error');
        }
    }

    // ìŠ¤íƒ€ì¼ ì„ íƒ ë° ì €ì¥
    window.selectStyle = async function (styleName, shouldSave = true) {
        // UI ì—…ë°ì´íŠ¸
        document.querySelectorAll('.style-card').forEach(el => {
            if (el.dataset.style === styleName) {
                el.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
                el.classList.remove('border-transparent');
            } else {
                el.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
                el.classList.add('border-transparent');
            }
        });

        if (shouldSave) {
            // ì„œë²„ ì €ì¥ (PATCH Settings)
            try {
                await API.project.updateSetting(projectId, 'subtitle_style_enum', styleName);
                Utils.showToast('ìŠ¤íƒ€ì¼ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (e) {
                console.error("ìŠ¤íƒ€ì¼ ì €ì¥ ì‹¤íŒ¨", e);
                // ì¡°ìš©íˆ ì‹¤íŒ¨ (Too many toasts)
            }
        }
    };

    // DOM load ì‹œ ë¡œë“œ ì§€ì  í†µí•© (loadSubtitles ë‚´ë¶€ì—ì„œ settingsë„ í•¨ê»˜ ì²˜ë¦¬í•¨)
    document.addEventListener('DOMContentLoaded', async () => {
        if (!projectId) {
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('project_id');
            if (pid) {
                projectId = parseInt(pid);
                Utils.storage.set('currentProjectId', projectId);
            }
        }

        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }

        // í°íŠ¸ í¬ê¸° ìŠ¬ë¼ì´ë” ì‹¤ì‹œê°„ ìˆ«ì í‘œì‹œ (ChangeëŠ” API ì €ì¥)
        const slider = document.getElementById('fontSizeSlider');
        const label = document.getElementById('fontSizeValue');
        if (slider && label) {
            slider.addEventListener('input', (e) => {
                label.textContent = e.target.value;
            });
        }

        await loadSubtitles();
    });

    // AI ì‹±í¬ ì¬ì„¤ì • (ê°•ì œ ì¬ë¶„ì„)
    async function regenerateSubtitles() {
        if (!confirm("í˜„ì¬ ìë§‰ì„ ëª¨ë‘ ì§€ìš°ê³ , ì˜¤ë””ì˜¤ë¥¼ ì •ë°€ ë¶„ì„í•˜ì—¬ ìë§‰ì„ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìˆ˜ë™ í¸ì§‘ëœ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤)")) {
            return;
        }

        try {
            Utils.showToast('AIê°€ ì˜¤ë””ì˜¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)', 'info');

            const res = await fetch(`/api/project/${projectId}/subtitle/regenerate`, {
                method: 'POST'
            });
            const data = await res.json();

            if (data.status === 'ok') {
                subtitles = data.subtitles || [];
                renderSubtitles();
                Utils.showToast('AI ë¶„ì„ ì™„ë£Œ: ìë§‰ì´ ì˜¤ë””ì˜¤ ì‹±í¬ì— ë§ì¶° ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                throw new Error(data.error);
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('AI ë¶„ì„ ì‹¤íŒ¨: ' + e.message, 'error');
        }
    }

    async function generateSubtitles(manualText = null) {
        try {
            const list = document.getElementById('subtitleList');
            // ë¡œë”© í‘œì‹œ (ê¸°ì¡´ ì»¨í…ì¸  ìœ ì§€í•˜ë©° ì˜¤ë²„ë ˆì´í•˜ê±°ë‚˜, ê·¸ëƒ¥ êµì²´)
            // list.innerHTML = ... (ìƒëµ - UX ìœ ì§€)

            const body = { project_id: projectId };
            if (manualText) body.text = manualText;

            const res = await fetch('/api/subtitle/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();

            if (data.status === 'ok') {
                subtitles = data.subtitles || [];
                renderSubtitles();
                Utils.showToast('ìë§‰ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // ìë™ ì €ì¥
                saveSubtitles();
            } else {
                Utils.showToast('ìë§‰ ìƒì„± ì‹¤íŒ¨: ' + data.error, 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ìë§‰ ìƒì„± ìš”ì²­ ì˜¤ë¥˜', 'error');
        }
    }

    window.saveSubtitles = async function () {
        try {
            const btn = document.querySelector('button[onclick="saveSubtitles()"]');
            const originalText = btn.textContent;
            btn.textContent = "ì €ì¥ ì¤‘... (ë¯¸ë¦¬ë³´ê¸° ìƒì„±)";
            btn.disabled = true;

            const res = await fetch('/api/subtitle/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    project_id: projectId,
                    subtitles: subtitles
                })
            });

            const data = await res.json();
            if (data.status === 'ok') {
                Utils.showToast('ìë§‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // ì„œë²„ì—ì„œ ì—…ë°ì´íŠ¸ëœ ìë§‰ ë¦¬ìŠ¤íŠ¸(preview_url í¬í•¨)ë¥¼ ë°˜í™˜ë°›ìŒ
                if (data.subtitles) {
                    subtitles = data.subtitles;
                    renderSubtitles();

                    // [NEW] ìë§‰ ì €ì¥ ì„±ê³µ ì‹œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¯¸ë¦¬ ì œëª©/ì„¤ëª… ìƒì„± ì‹œë„
                    // (í˜ì´ì§€ ì´ë™ ì‹œ ëŒ€ê¸° ì‹œê°„ì„ ì¤„ì´ê¸° ìœ„í•¨)
                    triggerBackgroundMetaGen();
                }
            } else {
                throw new Error(data.error);
            }

            btn.textContent = originalText;
            btn.disabled = false;
        } catch (e) {
            Utils.showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            const btn = document.querySelector('button[onclick="saveSubtitles()"]');
            if (btn) {
                btn.textContent = "ğŸ’¾ ì €ì¥í•˜ê¸°";
                btn.disabled = false;
            }
        }
    };

    // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œ í˜„ì¬ ìë§‰ í•˜ì´ë¼ì´íŒ… (ì˜µì…˜)
    const audio = document.getElementById('audioPlayer');
    audio.addEventListener('timeupdate', () => {
        const currentTime = audio.currentTime;
        // ì„±ëŠ¥ìƒ ë¦¬ìŠ¤íŠ¸ ì „ì²´ ìˆœíšŒëŠ” ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìœ¼ë‚˜ ìë§‰ ê°œìˆ˜ê°€ ì ìœ¼ë¯€ë¡œ ì¼ë‹¨ ë‹¨ìˆœ êµ¬í˜„
        document.querySelectorAll('.subtitle-row').forEach((row, idx) => {
            const sub = subtitles[idx];
            if (sub && currentTime >= sub.start && currentTime <= sub.end) {
                row.classList.add('bg-blue-50', 'dark:bg-blue-900/30');
            } else {
                row.classList.remove('bg-blue-50', 'dark:bg-blue-900/30');
            }
        });
    });

    // ==========================================
    // Subtitle CRUD & Playback
    // ==========================================
    window.currentPlayInterval = null;

    window.playSegment = function (index, btn) {
        const audio = document.getElementById('audioPlayer');
        if (!audio) return;

        const sub = subtitles[index];
        if (!sub) return;

        // ê¸°ì¡´ ì¬ìƒ ì¤‘ë‹¨
        if (window.currentPlayInterval) {
            clearInterval(window.currentPlayInterval);
            window.currentPlayInterval = null;
        }
        audio.pause();

        // ì¬ìƒ ì‹œì‘
        const start = sub.start;
        const end = sub.end;

        audio.currentTime = start;
        audio.play();

        // [Smart Buffer] ë‹¤ìŒ ìë§‰ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ Buffer ì¡°ì ˆ
        const buffer = 0.8;
        let targetEnd = end + buffer;

        // ë‹¤ìŒ ìë§‰ì´ ìˆìœ¼ë©´ ê·¸ ì‹œì‘ì  ì§ì „ê¹Œì§€ë§Œ ì¬ìƒ
        const nextSub = subtitles[index + 1];
        if (nextSub) {
            // 0.05ì´ˆ ì •ë„ ì—¬ìœ ë¥¼ ë‘ê³  ëŠìŒ (ë‹¤ìŒ ë©˜íŠ¸ ì¹¨ë²” ë°©ì§€)
            targetEnd = Math.min(targetEnd, nextSub.start - 0.05);
        }

        // ë³¸ë˜ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ëŠ” ê¸¸ì–´ì•¼ í•¨ (ìµœì†Œí•œ ìë§‰ êµ¬ê°„ì€ ë‹¤ ë“£ê¸°)
        targetEnd = Math.max(targetEnd, end);

        // ì „ì²´ ê¸¸ì´ ì´ˆê³¼ ë°©ì§€
        targetEnd = Math.min(targetEnd, audio.duration);

        // ì¢…ë£Œ ì§€ì  ì²´í¬
        window.currentPlayInterval = setInterval(() => {
            if (audio.currentTime >= targetEnd) {
                audio.pause();
                clearInterval(window.currentPlayInterval);
                window.currentPlayInterval = null;
            }
        }, 50);
    };

    window.updateSubtitle = function (index, field, value) {
        if (!subtitles[index]) return;

        if (field === 'text') {
            subtitles[index].text = value;
        } else if (field === 'start' || field === 'end') {
            subtitles[index][field] = parseFloat(value) || 0;
        }
    };

    window.addSubtitleRow = function () {
        // ë§ˆì§€ë§‰ ìë§‰ì˜ ë ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ 2ì´ˆ ì¶”ê°€, ì—†ìœ¼ë©´ 0~2ì´ˆ
        const lastSub = subtitles[subtitles.length - 1];
        const newStart = lastSub ? lastSub.end : 0;
        const newEnd = newStart + 2.0;

        subtitles.push({
            start: parseFloat(newStart.toFixed(2)),
            end: parseFloat(newEnd.toFixed(2)),
            text: "ìƒˆ ìë§‰"
        });
        renderSubtitles();

        // ìŠ¤í¬ë¡¤ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™
        setTimeout(() => {
            const list = document.getElementById('subtitleList');
            const newRow = list.lastElementChild;
            if (newRow) newRow.scrollIntoView({ behavior: 'smooth' });
        }, 100);
    };

    // ==========================================
    // Render Helper
    // ==========================================
    function renderSubtitles() {
        const list = document.getElementById('subtitleList');

        // ìƒë‹¨ì— 'ìë§‰ ìƒì„±' ë²„íŠ¼ê³¼ ìƒíƒœ í‘œì‹œ ì¶”ê°€
        const headerHtml = `
            <div class="flex justify-between items-center mb-4 p-2 bg-gray-100 dark:bg-gray-800 rounded">
                <span class="text-xs text-gray-500">
                    ğŸ’¡ ëŒ€ë³¸ ìë™ ì—°ë™: ${subtitles.length > 0 ? 'ì™„ë£Œ' : 'ëŒ€ê¸° ì¤‘'} 
                    (${subtitles.length} ë¼ì¸)
                </span>
                <div class="flex gap-2">
                    <button onclick="regenerateSubtitles()" class="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-colors flex items-center gap-1 shadow-sm" title="ì˜¤ë””ì˜¤ë¥¼ ì •ë°€ ë¶„ì„í•˜ì—¬ ì‹±í¬ë¥¼ ë‹¤ì‹œ ë§ì¶¥ë‹ˆë‹¤">
                        ğŸ™ï¸ AI ì‹±í¬ ë§ì¶”ê¸°
                    </button>
                    <button onclick="generateSubtitles()" class="px-3 py-1 text-xs bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors" title="ëŒ€ë³¸ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤">
                        ğŸ“ ëŒ€ë³¸ ê¸°ë°˜ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        `;

        // ë¹ˆ ìƒíƒœ ë˜ëŠ” ì‹¤íŒ¨ ìƒíƒœ(í”Œë ˆì´ìŠ¤í™€ë”) ê°ì§€
        const isEffectivelyEmpty = subtitles.length === 0 || (subtitles.length === 1 && (subtitles[0].text.includes("ì—†ìŠµë‹ˆë‹¤") || subtitles[0].text.includes("âš ï¸")));

        if (isEffectivelyEmpty) {
            const hasScript = loadedScript && loadedScript.length > 0;

            list.innerHTML = headerHtml + `
                <div class="text-center py-8 text-gray-500 dark:text-gray-400 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-6">
                    <p class="mb-4 text-xl">âš ï¸ ìë§‰ ë°ì´í„° ì—†ìŒ</p>
                    <p class="text-sm mb-4">
                        ${hasScript ? '<b>í”„ë¡œì íŠ¸ì—ì„œ ëŒ€ë³¸ ë°ì´í„°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!</b><br>ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.' : 'ì„œë²„ì— ì €ì¥ëœ ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì— ëŒ€ë³¸ì„ ì§ì ‘ ë¶™ì—¬ë„£ê³  [ìƒì„±]ì„ ëˆ„ë¥´ë©´ í•´ê²°ë©ë‹ˆë‹¤!'}
                    </p>
                    <div class="max-w-xl mx-auto mb-4">
                        <textarea id="manualScriptInput" placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." 
                            class="w-full h-32 p-3 border rounded dark:bg-gray-800 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 text-sm">${hasScript ? escapeHtml(loadedScript) : ''}</textarea>
                    </div>
                    <div class="flex justify-center gap-3">
                        <button onclick="generateSubtitles(document.getElementById('manualScriptInput').value)" 
                            class="btn-primary px-6 py-2 rounded-full shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                             ğŸª„ ${hasScript ? 'ëŒ€ë³¸ ì ìš©í•˜ì—¬ ìë§‰ ìƒì„±í•˜ê¸°' : 'ëŒ€ë³¸ ì…ë ¥í•˜ê³  ìë§‰ ìƒì„±í•˜ê¸°'}
                        </button>
                    </div>
                     <div class="mt-6 border-t pt-4 dark:border-gray-700">
                        <p class="text-xs text-gray-400 mb-2">ë˜ëŠ” ì§ì ‘ í•œ ì¤„ì”© ì¶”ê°€í•˜ê¸°</p>
                        <button onclick="addSubtitleRow()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-full text-sm">
                             âœï¸ ë¹ˆ ìë§‰ ì¶”ê°€
                        </button>
                    </div>
                </div>
            `;
            return;
        }

        const itemsHtml = subtitles.map((sub, index) => {
            // ì´ë¯¸ì§€ ë§¤ì¹­ (ì‹œê°„ ê¸°ë°˜) ë˜ëŠ” ì €ì¥ëœ ë¯¸ë¦¬ë³´ê¸° ì‚¬ìš©
            let imgUrl = "";
            let isPreview = false;

            if (sub.preview_url) {
                imgUrl = sub.preview_url;
                isPreview = true;
            } else if (images.length > 0 && audioDuration > 0) {
                // ì´ë¯¸ì§€ë‹¹ ì§€ì† ì‹œê°„ ì¶”ì • (ë‹¨ìˆœ ê· ë“± ë¶„í•  ê°€ì •)
                const durationPerImage = audioDuration / images.length;
                const midPoint = (sub.start + sub.end) / 2;
                const imgIndex = Math.min(Math.floor(midPoint / durationPerImage), images.length - 1);
                imgUrl = images[imgIndex] || "";
            }

            // ì¸ë„¤ì¼ í´ë¦­ ì‹œ í™•ëŒ€ ë³´ê¸° (ê°„ë‹¨í•œ window.open)
            const thumbnailHtml = imgUrl
                ? `<div class="cursor-pointer group relative h-full w-full" onclick="window.open('${imgUrl}', '_blank')">
                     <img src="${imgUrl}" class="h-full w-full object-cover transition-opacity ${isPreview ? 'opacity-100 border-2 border-blue-400' : 'opacity-80 hover:opacity-100'}">
                     ${isPreview ? '<div class="absolute bottom-0 right-0 bg-blue-600 text-white text-[10px] px-1">ë¯¸ë¦¬ë³´ê¸°</div>' : ''}
                   </div>`
                : '<span class="text-xs text-gray-500">No Image</span>';

            return `
            <div class="subtitle-row grid grid-cols-12 gap-2 mb-2 p-2 bg-gray-50 dark:bg-gray-800 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors shadow-sm items-center" data-start="${sub.start}" data-end="${sub.end}">
                <!-- ì¸ë„¤ì¼ -->
                <div class="col-span-2 flex justify-center items-center h-16 bg-black rounded overflow-hidden">
                    ${thumbnailHtml}
                </div>
                
                <div class="col-span-2">
                    <input type="number" step="0.1" value="${sub.start.toFixed(2)}" 
                        onchange="updateSubtitle(${index}, 'start', this.value)"
                        class="w-full text-center text-sm p-1 border rounded dark:bg-gray-600 dark:border-gray-500 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="col-span-2">
                    <input type="number" step="0.1" value="${sub.end.toFixed(2)}"
                        onchange="updateSubtitle(${index}, 'end', this.value)"
                        class="w-full text-center text-sm p-1 border rounded dark:bg-gray-600 dark:border-gray-500 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <!-- Play Button (VREW Style) -->
                <div class="col-span-1 flex justify-center">
                    <button onclick="playSegment(${index}, this)" class="play-btn p-2 rounded-full hover:bg-green-100 dark:hover:bg-green-900/30 text-green-600 transition-colors" title="ì´ êµ¬ê°„ ë“£ê¸°">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                </div>
                
                <div class="col-span-4">
                    <textarea 
                        onchange="updateSubtitle(${index}, 'text', this.value)"
                        class="w-full text-sm p-1 border rounded dark:bg-gray-600 dark:border-gray-500 focus:ring-2 focus:ring-blue-500 outline-none h-16 resize-none leading-normal pt-2">${escapeHtml(sub.text)}</textarea>
                </div>
                <div class="col-span-1 text-center flex items-center justify-center">
                    <button onclick="removeSubtitle(${index})" class="text-gray-400 hover:text-red-500 transition-colors p-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            `;
        }).join('');

        list.innerHTML = headerHtml + itemsHtml;
    }

    // ìë§‰ ì‚­ì œ í•¨ìˆ˜
    // ìë§‰ ì‚­ì œ í•¨ìˆ˜
    window.removeSubtitle = async function (index) {
        if (!confirm("ì •ë§ ì´ ìë§‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì£¼ì˜: í•´ë‹¹ êµ¬ê°„ì˜ ì˜¤ë””ì˜¤ë„ í•¨ê»˜ ì‚­ì œë˜ë©°, ì´í›„ ìë§‰ë“¤ì˜ ì‹±í¬ê°€ ìë™ìœ¼ë¡œ ì¡°ì •ë©ë‹ˆë‹¤.")) {
            return;
        }

        const sub = subtitles[index];
        if (!sub) return;

        // UI Loading
        const btn = document.querySelector(`button[onclick="removeSubtitle(${index})"]`);
        if (btn) btn.innerHTML = '<div class="loader-sm w-4 h-4 border-2"></div>';

        try {
            const res = await fetch(`/api/project/${projectId}/subtitle/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    index: index,
                    start: sub.start,
                    end: sub.end
                })
            });

            const data = await res.json();
            if (data.status === 'ok') {
                Utils.showToast(data.message || 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // ì—…ë°ì´íŠ¸ëœ ìë§‰ ë¦¬ìŠ¤íŠ¸ ë°˜ì˜
                subtitles = data.subtitles;
                renderSubtitles();

                // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ë¦¬ë¡œë“œ (íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ)
                const audioPlayer = document.getElementById('audioPlayer');
                const currentTime = audioPlayer.currentTime;
                // ìºì‹œ ë°©ì§€ìš© íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                const srcWithTs = audioPlayer.src.split('?')[0] + '?t=' + new Date().getTime();
                audioPlayer.src = srcWithTs;
                // í”Œë ˆì´ì–´ ìƒíƒœ ë³µì› ì‹œë„ (ì‚­ì œëœ ë§Œí¼ ì‹œê°„ ì¡°ì • í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, ì¼ë‹¨ ì²˜ìŒë¶€í„° í˜¹ì€ ì ì ˆíˆ)
                // ì‚­ì œëœ ì•ë¶€ë¶„ì´ë©´ ì‹œê°„ ê·¸ëŒ€ë¡œ, ì‚­ì œëœ ë¶€ë¶„ì´ í¬í•¨ë˜ë©´? 
                // ë³µì¡í•˜ë¯€ë¡œ ì¼ë‹¨ ë¦¬ë¡œë“œë§Œ.
            } else {
                throw new Error(data.error);
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
            // UI Restore
            renderSubtitles();
        }
    };

    // HTML Escape Helper
    // í°íŠ¸/ìƒ‰ìƒ ìë™ ì €ì¥
    document.querySelectorAll('input[name="subtitle_font"]').forEach(radio => {
        radio.addEventListener('change', async (e) => {
            const fontName = e.target.value;
            updateFontPreview(fontName);
            try {
                await API.project.updateSetting(projectId, 'subtitle_font', fontName);
                Utils.showToast('í°íŠ¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            } catch (err) {
                console.error('í°íŠ¸ ì €ì¥ ì‹¤íŒ¨:', err);
            }
        });
    });

    // í°íŠ¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ê¸°ëŠ¥
    function updateFontPreview(fontName) {
        // í”„ë¦¬ë·° í…ìŠ¤íŠ¸ ìš”ì†Œë“¤ ì„ íƒ
        const previewTexts = document.querySelectorAll('#styleSelector .text-xl, #styleSelector .text-lg');

        // UI ì„ íƒê°’ -> CSS font-family ë§¤í•‘
        const familyMap = {
            'Malgun-Gothic-Bold': '"Malgun Gothic", "ë§‘ì€ ê³ ë”•", sans-serif',
            'CookieRun Regular': '"CookieRun-Regular", sans-serif',
            'GmarketSansBold': '"GmarketSansBold", sans-serif',
            'NanumMyeongjo': '"Nanum Myeongjo", serif'
        };

        const fontStack = familyMap[fontName] || fontName;

        previewTexts.forEach(el => {
            el.style.fontFamily = fontStack;
        });
        console.log("Preview font updated to:", fontName, "Stack:", fontStack);
    }

    window.selectColor = async function (color, shouldSave = true) {
        // UI ë°˜ì˜
        document.querySelectorAll('.color-circle').forEach(el => {
            el.classList.toggle('active', el.dataset.color === color);
        });

        if (shouldSave) {
            try {
                await API.project.updateSetting(projectId, 'subtitle_color', color);
                Utils.showToast('ìƒ‰ìƒì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            } catch (err) {
                console.error('ìƒ‰ìƒ ì €ì¥ ì‹¤íŒ¨:', err);
            }
        }
    }

    // í°íŠ¸ í¬ê¸° í•¸ë“¤ëŸ¬ (ê¸°ì¡´ slider í•¸ë“¤ëŸ¬ê°€ ìˆìœ¼ë©´ ë®ì–´ì“°ê±°ë‚˜ í™•ì¸ í•„ìš”)
    // ê¸°ì¡´ fontSizeSlider í•¸ë“¤ëŸ¬ë¥¼ ì°¾ì•„ì„œ ìˆ˜ì •í•˜ê±°ë‚˜ ìƒˆë¡œ ë“±ë¡
    const fontSizeSlider = document.getElementById('fontSizeSlider');
    if (fontSizeSlider) {
        fontSizeSlider.addEventListener('change', async (e) => {
            const newVal = e.target.value;
            document.getElementById('fontSizeValue').textContent = newVal;
            try {
                await API.project.updateSetting(projectId, 'subtitle_font_size', newVal);
            } catch (err) {
                console.error('í¬ê¸° ì €ì¥ ì‹¤íŒ¨:', err);
            }
        });
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

</script>
{% endblock %}