{% extends "base.html" %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@700;800&display=swap');

    @font-face {
        font-family: 'CookieRun-Regular';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/CookieRun-Regular.woff') format('woff');
    }

    @font-face {
        font-family: 'GmarketSansBold';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansBold.woff') format('woff');
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }

    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #4b5563;
    }

    /* Compact inputs */
    .input-compact {
        @apply text-xs border-gray-300 dark:border-gray-600 rounded py-1 px-2 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-1 focus:ring-primary focus:border-primary;
    }

    .subtitle-row.active {
        @apply bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-700;
    }
</style>

<div class="h-[calc(100vh-140px)] flex flex-col gap-3 p-2">
    <!-- 1. Top Control Bar (Style & Actions) -->
    <div
        class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 shrink-0 flex-wrap">

        <!-- Font Settings -->
        <div class="flex items-center gap-2 border-r border-gray-200 dark:border-gray-600 pr-2">
            <span class="text-xs font-bold text-gray-700 dark:text-gray-300">ì„œì²´</span>
            <select id="fontFamilySelect" class="input-compact w-24">
                <option value="GmarketSansBold">Gë§ˆì¼“ì‚°ìŠ¤</option>
                <option value="Malgun Gothic">ë§‘ì€ê³ ë”•</option>
                <option value="CookieRun">ì¿ í‚¤ëŸ°</option>
                <option value="NanumMyeongjo">ë‚˜ëˆ”ëª…ì¡°</option>
                <option value="Black Han Sans">ê²€ì€ê³ ë”•</option>
            </select>
            <input type="number" id="fontSizeInput" value="60" min="10" max="200" class="input-compact w-12 text-center"
                title="í¬ê¸°">
        </div>

        <!-- Color Settings -->
        <div class="flex items-center gap-2 border-r border-gray-200 dark:border-gray-600 pr-2">
            <span class="text-xs font-bold text-gray-700 dark:text-gray-300">ìƒ‰ìƒ</span>
            <div class="flex flex-col items-center">
                <input type="color" id="textColorInput" value="#ffffff"
                    class="w-6 h-4 p-0 border-0 rounded cursor-pointer" title="ê¸€ììƒ‰">
                <span class="text-[10px] text-gray-400">Main</span>
            </div>
            <div class="flex flex-col items-center">
                <input type="color" id="strokeColorInput" value="#000000"
                    class="w-6 h-4 p-0 border-0 rounded cursor-pointer" title="í…Œë‘ë¦¬ìƒ‰">
                <span class="text-[10px] text-gray-400">Line</span>
            </div>
            <div class="flex flex-col w-16">
                <input type="range" id="strokeWidthSlider" min="0" max="20" value="4"
                    class="h-1.5 w-full bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                    title="í…Œë‘ë¦¬ ë‘ê»˜">
                <span class="text-[10px] text-center text-gray-500"><span id="strokeWidthValue">4</span>px</span>
            </div>
        </div>

        <!-- Presets -->
        <div class="flex items-center gap-1 border-r border-gray-200 dark:border-gray-600 pr-2">
            <button onclick="applyPreset('basic_white')"
                class="w-5 h-5 bg-white border border-gray-300 rounded text-[10px] flex items-center justify-center shadow-sm"
                title="í™”ì´íŠ¸">A</button>
            <button onclick="applyPreset('basic_black')"
                class="w-5 h-5 bg-black border border-gray-600 rounded text-[10px] text-white flex items-center justify-center shadow-sm"
                title="ë¸”ë™">A</button>
            <button onclick="applyPreset('yellow_shadow')"
                class="w-5 h-5 bg-yellow-400 border border-yellow-600 rounded text-[10px] font-bold text-black flex items-center justify-center shadow-sm"
                title="ì˜ë¡œìš°">A</button>
        </div>

        <div class="flex-1"></div>

        <!-- Actions -->
        <div class="flex items-center gap-2">
            <button onclick="saveSubtitles()" id="saveBtn"
                class="btn-secondary py-1.5 px-3 text-xs flex items-center gap-1">
                ğŸ’¾ ì €ì¥
            </button>
            <a href="/render"
                class="btn-primary py-1.5 px-4 text-xs font-bold bg-blue-600 hover:bg-blue-700 flex items-center gap-1">
                ğŸ¬ ë Œë”ë§
            </a>
        </div>
    </div>

    <!-- 2. Main Workspace (Grid) -->
    <div class="grid grid-cols-12 gap-3 flex-1 min-h-0">

        <!-- Left Panel: Subtitle List (Col-4) -->
        <div
            class="col-span-12 md:col-span-4 flex flex-col bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden min-h-0">
            <!-- List Header -->
            <div
                class="p-2 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center shrink-0">
                <h3 class="text-xs font-bold text-gray-700 dark:text-gray-300">ğŸ“œ ìë§‰ ë¦¬ìŠ¤íŠ¸</h3>
                <div class="flex gap-1">
                    <button onclick="regenerateSubtitles()"
                        class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 border border-indigo-200">ğŸ™ï¸
                        AI ì¬ì‹±í¬</button>
                    <button onclick="addSubtitleRow()"
                        class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200 border border-gray-300">+
                        ì¶”ê°€</button>
                </div>
            </div>

            <!-- Scrollable List -->
            <div id="subtitleList" class="flex-1 overflow-y-auto custom-scrollbar p-1 space-y-1">
                <!-- Rows injected by JS -->
                <div class="text-center py-10 text-gray-400 text-xs">ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <!-- Right Panel: Preview & Edit (Col-8) -->
        <div class="col-span-12 md:col-span-8 flex flex-col gap-3 min-h-0">

            <!-- Preview Area (Top) -->
            <div class="relative bg-black rounded-lg border border-gray-800 shadow-sm overflow-hidden group shrink-0"
                style="aspect-ratio: 16/9;">
                <!-- Preview Canvas/Image -->
                <div id="previewContainer" class="absolute inset-0 flex items-center justify-center bg-gray-900">
                    <p class="text-gray-600 text-xs">Select a subtitle to preview</p>
                </div>

                <!-- Overlay Text -->
                <div id="subtitlePreviewBox" class="absolute inset-0 overflow-hidden pointer-events-none">
                    <div id="previewTextMain"
                        class="absolute transform -translate-x-1/2 -translate-y-1/2 pointer-events-auto cursor-move select-none whitespace-pre-wrap text-center leading-tight hover:border hover:border-blue-400/50 hover:bg-white/10 rounded transition-colors px-2 py-1"
                        style="left: 50%; top: 85%; width: auto; max-width: 90%;">
                        ìë§‰ ë¯¸ë¦¬ë³´ê¸°
                    </div>
                </div>

                <!-- Audio Controls Overlay -->
                <div
                    class="absolute bottom-0 left-0 right-0 bg-black/50 backdrop-blur-sm p-2 flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <audio id="audioPlayer" controls class="w-full h-8 opacity-90"></audio>
                </div>
            </div>

            <!-- Edit Area (Bottom) -->
            <div
                class="flex-1 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 shadow-sm flex flex-col min-h-0">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-700 dark:text-gray-300">âœï¸ ì„ íƒëœ ìë§‰ í¸ì§‘</h3>
                    <div class="text-xs text-gray-500">
                        <span id="currentStartTime">0.00</span>s ~ <span id="currentEndTime">0.00</span>s
                    </div>
                </div>

                <textarea id="currentSubtitleText"
                    class="flex-1 w-full p-2 text-sm border border-gray-200 dark:border-gray-600 rounded resize-none bg-gray-50 dark:bg-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 text-center leading-relaxed"
                    placeholder="ë¦¬ìŠ¤íŠ¸ì—ì„œ ìë§‰ì„ ì„ íƒí•˜ì„¸ìš”"></textarea>

                <div class="flex justify-center gap-2 mt-2">
                    <button onclick="adjustTime(-0.1)"
                        class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 text-xs">-0.1s</button>
                    <button onclick="adjustTime(0.1)"
                        class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 text-xs">+0.1s</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let projectId = Utils.storage.get('currentProjectId');
    if (projectId && typeof projectId === 'string') projectId = parseInt(projectId);

    let subtitles = [];
    let images = [];
    let loadedScript = "";
    let styleSettings = {};
    let audioDuration = 0;
    let selectedIndex = -1;

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (!projectId) {
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('project_id');
            if (pid) {
                projectId = parseInt(pid);
                Utils.storage.set('currentProjectId', projectId);
            } else {
                return Utils.showToast('í”„ë¡œì íŠ¸ ì„ íƒ í•„ìš”', 'warning');
            }
        }

        setupStyleListeners();
        await loadProjectAndSubtitles();

        // Draggable Preview
        makeDraggable(document.getElementById('previewTextMain'));
    });

    async function loadProjectAndSubtitles() {
        try {
            // 1. Load Settings
            const projectData = await API.project.getFull(projectId);
            if (projectData.settings) applySettings(projectData.settings);
            loadedScript = projectData.script?.full_script || "";

            // 2. Load Subtitles
            const res = await fetch(`/api/subtitle/${projectId}`);
            const data = await res.json();

            if (data.status === 'error') throw new Error(data.error);

            // 3. Setup Audio
            const audio = document.getElementById('audioPlayer');
            audio.src = data.audio_url;
            audio.onloadedmetadata = () => { audioDuration = audio.duration; };

            images = data.images || [];
            subtitles = data.subtitles || [];

            if (subtitles.length === 0) {
                await generateSubtitles();
            } else {
                renderSubtitles();
                if (subtitles.length > 0) selectSubtitle(0);
            }

        } catch (e) {
            console.error(e);
            document.getElementById('subtitleList').innerHTML = `<div class='p-4 text-center text-red-500 text-xs'>ë¡œë“œ ì‹¤íŒ¨: ${e.message}<br><button onclick='loadProjectAndSubtitles()' class='mt-2 underline'>ì¬ì‹œë„</button></div>`;
        }
    }

    function applySettings(s) {
        if (s.subtitle_font) document.getElementById('fontFamilySelect').value = s.subtitle_font;
        if (s.subtitle_font_size) document.getElementById('fontSizeInput').value = s.subtitle_font_size;
        if (s.subtitle_base_color) document.getElementById('textColorInput').value = s.subtitle_base_color;
        if (s.subtitle_stroke_color) document.getElementById('strokeColorInput').value = s.subtitle_stroke_color;
        if (s.subtitle_stroke_width !== undefined) {
            document.getElementById('strokeWidthSlider').value = s.subtitle_stroke_width;
            document.getElementById('strokeWidthValue').textContent = s.subtitle_stroke_width;
        }

        const preview = document.getElementById('previewTextMain');
        if (s.subtitle_pos_x) preview.style.left = s.subtitle_pos_x;
        if (s.subtitle_pos_y) preview.style.top = s.subtitle_pos_y;

        updateSubtitlePreview();
    }

    function setupStyleListeners() {
        // Debounced or direct auto-save logic
        const update = async (key, val) => {
            styleSettings[key] = val;
            updateSubtitlePreview();
            await API.project.updateSetting(projectId, key, val);
        };

        document.getElementById('fontFamilySelect').addEventListener('change', e => update('subtitle_font', e.target.value));
        document.getElementById('fontSizeInput').addEventListener('change', e => update('subtitle_font_size', parseInt(e.target.value)));
        document.getElementById('textColorInput').addEventListener('change', e => update('subtitle_base_color', e.target.value));
        document.getElementById('strokeColorInput').addEventListener('change', e => update('subtitle_stroke_color', e.target.value));
        document.getElementById('strokeWidthSlider').addEventListener('input', e => {
            document.getElementById('strokeWidthValue').textContent = e.target.value;
            update('subtitle_stroke_width', parseInt(e.target.value));
        });

        // Text Input Listener
        document.getElementById('currentSubtitleText').addEventListener('input', (e) => {
            if (selectedIndex >= 0 && subtitles[selectedIndex]) {
                subtitles[selectedIndex].text = e.target.value;
                document.getElementById('previewTextMain').textContent = e.target.value;
                // Update List Item text too
                const row = document.getElementById(`sub-row-${selectedIndex}`);
                if (row) row.querySelector('.sub-text').textContent = e.target.value;
            }
        });
    }

    // --- Core Logic ---
    function renderSubtitles() {
        const list = document.getElementById('subtitleList');
        if (subtitles.length === 0) {
            list.innerHTML = "<div class='text-center p-4 text-xs text-gray-400'>ìë§‰ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            return;
        }

        list.innerHTML = subtitles.map((sub, idx) => {
            return `
            <div id="sub-row-${idx}" onclick="selectSubtitle(${idx})" class="subtitle-row group flex items-start gap-2 p-2 rounded cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 border border-transparent transition-colors">
                <div class="text-[10px] text-gray-400 font-mono w-12 shrink-0 pt-1 text-right">
                    ${sub.start.toFixed(1)}s<br>~${sub.end.toFixed(1)}s
                </div>
                <div class="flex-1 min-w-0">
                    <p class="sub-text text-xs text-gray-800 dark:text-gray-200 font-medium break-keep leading-tight">${sub.text}</p>
                </div>
                <button onclick="event.stopPropagation(); playSegment(${idx})" class="opacity-0 group-hover:opacity-100 p-1 text-blue-500 hover:bg-blue-50 rounded">
                    â–¶
                </button>
            </div>`;
        }).join('');
    }

    function selectSubtitle(index) {
        if (selectedIndex >= 0) {
            const prev = document.getElementById(`sub-row-${selectedIndex}`);
            if (prev) prev.classList.remove('active');
        }

        selectedIndex = index;
        const row = document.getElementById(`sub-row-${index}`);
        if (row) {
            row.classList.add('active');
            row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        const sub = subtitles[index];
        if (!sub) return;

        // Update Editor
        document.getElementById('currentSubtitleText').value = sub.text;
        document.getElementById('currentStartTime').textContent = sub.start.toFixed(2);
        document.getElementById('currentEndTime').textContent = sub.end.toFixed(2);

        // Update Preview
        document.getElementById('previewTextMain').textContent = sub.text;

        // Update Background Image
        const container = document.getElementById('previewContainer');
        // Find rough image match
        // Assuming images cover duration evenly for now, or match preview_url
        if (sub.preview_url) {
            container.innerHTML = `<img src="${sub.preview_url}" class="w-full h-full object-cover opacity-50">`;
        } else if (images.length > 0) {
            // Basic estimation
            const durationPerImg = audioDuration / images.length;
            const mid = (sub.start + sub.end) / 2;
            const imgIdx = Math.min(Math.floor(mid / durationPerImg), images.length - 1);
            if (images[imgIdx]) {
                container.innerHTML = `<img src="${images[imgIdx]}" class="w-full h-full object-cover opacity-50">`;
            }
        }
    }

    function updateSubtitlePreview() {
        const text = document.getElementById('previewTextMain');
        const font = document.getElementById('fontFamilySelect').value;
        const size = document.getElementById('fontSizeInput').value;
        const color = document.getElementById('textColorInput').value;
        const strokeColor = document.getElementById('strokeColorInput').value;
        const strokeWidth = document.getElementById('strokeWidthSlider').value;

        text.style.fontFamily = font;
        text.style.fontSize = size + 'px';
        text.style.color = color;
        // SVG stroke simulation needed for perfect text-stroke, but webkit-text-stroke is ok for now
        text.style.webkitTextStroke = `${strokeWidth / 2}px ${strokeColor}`;
    }

    // --- Action Functions ---
    async function saveSubtitles() {
        const btn = document.getElementById('saveBtn');
        Utils.setLoading(btn, true, 'ì €ì¥...');
        try {
            // Update Position before save
            const preview = document.getElementById('previewTextMain');
            await API.project.updateSetting(projectId, 'subtitle_pos_x', preview.style.left);
            await API.project.updateSetting(projectId, 'subtitle_pos_y', preview.style.top);

            const res = await fetch('/api/subtitle/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_id: projectId, subtitles: subtitles })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                Utils.showToast('ìë§‰ ì €ì¥ë¨', 'success');
                if (data.subtitles) {
                    subtitles = data.subtitles;
                    renderSubtitles();
                    if (selectedIndex >= 0) selectSubtitle(selectedIndex);
                }
            } else throw new Error(data.error);
        } catch (e) {
            Utils.showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    async function generateSubtitles() {
        Utils.showToast('ìë§‰ ìƒì„± ìš”ì²­...', 'info');
        try {
            const res = await fetch('/api/subtitle/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_id: projectId })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                subtitles = data.subtitles;
                renderSubtitles();
                selectSubtitle(0);
                Utils.showToast('ìƒì„± ì™„ë£Œ', 'success');
            } else throw new Error(data.error);
        } catch (e) {
            Utils.showToast('ì˜¤ë¥˜: ' + e.message, 'error');
        }
    }

    async function regenerateSubtitles() {
        if (!confirm('ëª¨ë“  ìë§‰ì„ ë‹¤ì‹œ ë¶„ì„í•©ë‹ˆë‹¤. ìˆ˜ë™ í¸ì§‘ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) return;
        Utils.showToast('ì¬ë¶„ì„ ì¤‘...', 'info');
        try {
            const res = await fetch(`/api/project/${projectId}/subtitle/regenerate`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'ok') {
                subtitles = data.subtitles;
                renderSubtitles();
                selectSubtitle(0);
                Utils.showToast('ì¬ë¶„ì„ ì™„ë£Œ', 'success');
            } else throw new Error(data.error);
        } catch (e) { Utils.showToast('ì‹¤íŒ¨: ' + e.message, 'error'); }
    }

    function applyPreset(name) {
        if (name === 'basic_white') {
            document.getElementById('textColorInput').value = '#ffffff';
            document.getElementById('strokeColorInput').value = '#000000';
            updateSubtitlePreview();
        } else if (name === 'basic_black') {
            document.getElementById('textColorInput').value = '#ffffff'; // Black preset usually implies white text on black bg or similar, adjusting...
            document.getElementById('strokeColorInput').value = '#000000'; // Logic same? Let's check original. 
            // Original: bg-gray-800 text-white for button. 
            // Actually 'basic_black' might mean yellow on black or something. 
            // Let's just toggle standard values.
            document.getElementById('textColorInput').value = '#000000';
            document.getElementById('strokeColorInput').value = '#ffffff';
            updateSubtitlePreview();
        } else if (name === 'yellow_shadow') {
            document.getElementById('textColorInput').value = '#fbbf24'; // Yellow
            document.getElementById('strokeColorInput').value = '#000000';
            updateSubtitlePreview();
        }
        // Save these settings implicitly via listener trigger? No, inputs changed programmatically don't always trigger 'change'.
        // Manually trigger updates
        document.getElementById('textColorInput').dispatchEvent(new Event('change'));
        document.getElementById('strokeColorInput').dispatchEvent(new Event('change'));
    }

    function addSubtitleRow() {
        const last = subtitles[subtitles.length - 1];
        const start = last ? last.end : 0;
        subtitles.push({ start: start, end: start + 2, text: "ìƒˆ ìë§‰" });
        renderSubtitles();
        selectSubtitle(subtitles.length - 1);
    }

    function adjustTime(delta) {
        if (selectedIndex < 0) return;
        // Adjust both if needed or specific logic? 
        // Simple logic: Shift entire subtitle
        subtitles[selectedIndex].start = parseFloat((subtitles[selectedIndex].start + delta).toFixed(2));
        subtitles[selectedIndex].end = parseFloat((subtitles[selectedIndex].end + delta).toFixed(2));
        if (subtitles[selectedIndex].start < 0) subtitles[selectedIndex].start = 0;

        selectSubtitle(selectedIndex); // Refresh UI
    }

    function playSegment(idx) {
        const sub = subtitles[idx];
        const audio = document.getElementById('audioPlayer');
        audio.currentTime = sub.start;
        audio.play();
        // Stop at end logic... omitted for brevity but can add timeout
        setTimeout(() => audio.pause(), (sub.end - sub.start) * 1000);
    }

    // Draggable Functionality
    function makeDraggable(elmnt) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
            // Save position
            API.project.updateSetting(projectId, 'subtitle_pos_x', elmnt.style.left);
            API.project.updateSetting(projectId, 'subtitle_pos_y', elmnt.style.top);
        }
    }
</script>
{% endblock %}