{% extends "base.html" %}

{% block content %}

<div class="h-[calc(100vh-80px)] overflow-y-auto p-6 custom-scrollbar">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2">
            <span>ğŸ›ï¸</span>
            <span>ì»¤ë¨¸ìŠ¤ ì‡¼ì¸  ì œì‘</span>
        </h2>
        <div class="text-sm text-gray-500 dark:text-gray-400">
            ì œí’ˆ URLë§Œìœ¼ë¡œ í”„ë¡œëª¨ì…˜ ì˜ìƒ ìƒì„±
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="mb-8">
        <div class="flex items-center justify-center gap-4">
            <div class="flex items-center gap-2">
                <div id="step-indicator-1"
                    class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">1
                </div>
                <span class="text-sm font-medium">URL ì…ë ¥</span>
            </div>
            <div class="w-16 h-1 bg-gray-300 dark:bg-gray-700"></div>
            <div class="flex items-center gap-2">
                <div id="step-indicator-2"
                    class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-500 flex items-center justify-center font-bold">
                    2</div>
                <span class="text-sm text-gray-500">ì œí’ˆ ì •ë³´</span>
            </div>
            <div class="w-16 h-1 bg-gray-300 dark:bg-gray-700"></div>
            <div class="flex items-center gap-2">
                <div id="step-indicator-3"
                    class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-500 flex items-center justify-center font-bold">
                    3</div>
                <span class="text-sm text-gray-500">ìŠ¤íƒ€ì¼ ì„ íƒ</span>
            </div>
            <div class="w-16 h-1 bg-gray-300 dark:bg-gray-700"></div>
            <div class="flex items-center gap-2">
                <div id="step-indicator-4"
                    class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-500 flex items-center justify-center font-bold">
                    4</div>
                <span class="text-sm text-gray-500">ìƒì„±</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto">

        <!-- Step 1: URL Input -->
        <div id="step-1" class="card p-6 mb-4">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span>ğŸ”—</span>
                <span>1ë‹¨ê³„: ì œí’ˆ URL ì…ë ¥</span>
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">ì œí’ˆ í˜ì´ì§€ URL</label>
                    <input type="text" id="product-url" class="input w-full"
                        placeholder="https://smartstore.naver.com/..." />
                    <p class="text-xs text-gray-500 mt-1">
                        ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´, ì¿ íŒ¡, 11ë²ˆê°€ ë“±ì˜ ì œí’ˆ í˜ì´ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”
                    </p>
                </div>
                <button onclick="analyzeProduct()" class="btn-primary w-full py-3">
                    <span>ğŸ”</span>
                    <span>ì œí’ˆ ë¶„ì„í•˜ê¸°</span>
                </button>
            </div>
        </div>

        <!-- Step 2: Product Info (Hidden initially) -->
        <div id="step-2" class="card p-6 mb-4 hidden">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span>ğŸ“¦</span>
                <span>2ë‹¨ê³„: ì œí’ˆ ì •ë³´ í™•ì¸</span>
            </h3>
            <div id="product-info" class="space-y-4">
                <!-- Will be populated by JS -->
            </div>
            <button onclick="goToStep3()" class="btn-primary w-full py-3 mt-4">
                ë‹¤ìŒ ë‹¨ê³„ â†’
            </button>
        </div>

        <!-- Step 3: Style Selection (Hidden initially) -->
        <div id="step-3" class="card p-6 mb-4 hidden">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span>ğŸ¨</span>
                <span>3ë‹¨ê³„: ì˜ìƒ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•</span>
            </h3>
            <div class="space-y-6">
                <!-- í”„ë¦¬ì…‹ ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium mb-2">ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹</label>
                    <div id="style-presets" class="grid grid-cols-2 gap-3">
                        <!-- Will be populated by JS -->
                    </div>
                </div>

                <!-- ê³ ê¸‰ ì˜µì…˜ í† ê¸€ -->
                <div>
                    <button onclick="toggleAdvancedOptions()"
                        class="text-sm text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-1">
                        <span id="advanced-toggle-icon">â–¶</span>
                        <span>ê³ ê¸‰ ì˜µì…˜</span>
                    </button>
                </div>

                <!-- ê³ ê¸‰ ì˜µì…˜ (ì ‘íŒ ìƒíƒœ) -->
                <div id="advanced-options" class="hidden space-y-4 pl-4 border-l-2 border-blue-500">

                    <!-- ëª¨ë¸ ì„ íƒ -->
                    <div>
                        <label class="block text-sm font-medium mb-2">ëª¨ë¸ íƒ€ì…</label>
                        <select id="model-type" class="input w-full">
                            <option value="">ìë™ ì„ íƒ</option>
                            <option value="female_20s">ì—¬ì„± (20ëŒ€)</option>
                            <option value="female_30s">ì—¬ì„± (30ëŒ€)</option>
                            <option value="male_20s">ë‚¨ì„± (20ëŒ€)</option>
                            <option value="male_30s">ë‚¨ì„± (30ëŒ€)</option>
                            <option value="neutral">ì¤‘ì„±ì </option>
                        </select>
                    </div>

                    <!-- ë°°ê²½ ì„ íƒ -->
                    <div>
                        <label class="block text-sm font-medium mb-2">ë°°ê²½ íƒ€ì…</label>
                        <select id="background-type" class="input w-full">
                            <option value="">ìë™ ì„ íƒ</option>
                            <option value="studio_clean">ìŠ¤íŠœë””ì˜¤ (ê¹”ë”)</option>
                            <option value="studio_tech">ìŠ¤íŠœë””ì˜¤ (ê¸°ìˆ )</option>
                            <option value="home">ì‹¤ë‚´ (ê°€ì •)</option>
                            <option value="kitchen">ì£¼ë°©</option>
                            <option value="outdoor">ì•¼ì™¸</option>
                            <option value="gradient">ê·¸ë¼ë°ì´ì…˜</option>
                        </select>
                    </div>

                    <!-- ìŒì•… ì„ íƒ -->
                    <div>
                        <label class="block text-sm font-medium mb-2">ë°°ê²½ ìŒì•…</label>
                        <select id="music-type" class="input w-full">
                            <option value="">ìŒì•… ì—†ìŒ</option>
                            <option value="upbeat">ê²½ì¾Œí•œ</option>
                            <option value="calm">ì°¨ë¶„í•œ</option>
                            <option value="energetic">í™œê¸°ì°¬</option>
                            <option value="corporate">ê¸°ì—…ìš©</option>
                        </select>
                    </div>

                    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                    <div>
                        <label class="block text-sm font-medium mb-2">ì¶”ê°€ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>

                        <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
                        <div id="upload-dropzone"
                            class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-blue-500 transition-all cursor-pointer"
                            ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                            ondrop="handleDrop(event)" onclick="document.getElementById('custom-images').click()">
                            <div class="text-4xl mb-2">ğŸ“¸</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                                í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”
                            </p>
                            <p class="text-xs text-gray-500">
                                ìµœëŒ€ 5ì¥, JPG/PNG/WEBP (ê° 10MB ì´í•˜)
                            </p>
                        </div>

                        <input type="file" id="custom-images" class="hidden"
                            accept="image/jpeg,image/jpg,image/png,image/webp" multiple
                            onchange="handleFileSelect(event)" />

                        <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                        <div id="uploaded-images-preview" class="mt-3 grid grid-cols-5 gap-2">
                            <!-- Preview thumbnails will be inserted here -->
                        </div>

                        <!-- ì—…ë¡œë“œ ì§„í–‰ ìƒíƒœ -->
                        <div id="upload-progress" class="hidden mt-2">
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div id="upload-progress-bar" class="bg-blue-500 h-2 rounded-full transition-all"
                                    style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 text-center">ì—…ë¡œë“œ ì¤‘...</p>
                        </div>
                    </div>

                    <!-- CTA ì„ íƒ -->
                    <div>
                        <label class="block text-sm font-medium mb-2">í–‰ë™ ìœ ë„ (CTA)</label>
                        <select id="cta-type" class="input w-full">
                            <option value="buy_now">ì§€ê¸ˆ êµ¬ë§¤</option>
                            <option value="learn_more">ìì„¸íˆ ë³´ê¸°</option>
                            <option value="limited_offer">í•œì • íŠ¹ê°€</option>
                            <option value="new_arrival">ì‹ ì œí’ˆ</option>
                            <option value="discount">í• ì¸ ì¤‘</option>
                        </select>
                    </div>
                </div>

                <!-- í•µì‹¬ ë©”ì‹œì§€ -->
                <div>
                    <label class="block text-sm font-medium mb-2">í•µì‹¬ ë©”ì‹œì§€</label>
                    <input type="text" id="message" class="input w-full" placeholder="ì˜ˆ: ì‹ ì œí’ˆ ì¶œì‹œ! íŠ¹ë³„ í• ì¸ ì¤‘" />
                    <p class="text-xs text-gray-500 mt-1">
                        ì˜ìƒì— í‘œì‹œë  ì£¼ìš” ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”
                    </p>
                </div>
            </div>
            <button onclick="generateVideo()" class="btn-primary w-full py-3 mt-6">
                <span>ğŸ¬</span>
                <span>ì˜ìƒ ìƒì„±í•˜ê¸°</span>
            </button>
        </div>

        <!-- Step 4: Generation Status (Hidden initially) -->
        <div id="step-4" class="card p-6 mb-4 hidden">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span>â³</span>
                <span>4ë‹¨ê³„: ì˜ìƒ ìƒì„± ì¤‘...</span>
            </h3>
            <div class="text-center py-8">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600 dark:text-gray-400">
                    ì˜ìƒì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì•½ 2ë¶„ ì†Œìš”ë©ë‹ˆë‹¤...
                </p>
                <div id="generation-status" class="mt-4 text-sm text-gray-500">
                    <!-- Status updates -->
                </div>
            </div>
        </div>

        <!-- My Videos Section -->
        <div class="card p-6">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span>ğŸ“¹</span>
                <span>ë‚´ ì»¤ë¨¸ìŠ¤ ì˜ìƒ</span>
            </h3>
            <div id="my-videos" class="space-y-3">
                <p class="text-sm text-gray-500 text-center py-8">
                    ì•„ì§ ìƒì„±ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤
                </p>
            </div>
        </div>

    </div>
</div>

<script>
    let currentData = {
        productUrl: '',
        productInfo: null,
        stylePreset: 'electronics',
        message: '',
        uploadedImages: []  // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URL ì €ì¥
    };

    // ============ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜ ============

    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900');
    }

    function handleDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900');
    }

    function handleDrop(event) {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900');

        const files = event.dataTransfer.files;
        if (files.length > 0) {
            uploadImages(files);
        }
    }

    function handleFileSelect(event) {
        const files = event.target.files;
        if (files.length > 0) {
            uploadImages(files);
        }
    }

    async function uploadImages(files) {
        // íŒŒì¼ ê°œìˆ˜ í™•ì¸
        if (files.length > 5) {
            Utils.showToast('ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
            return;
        }

        // íŒŒì¼ í¬ê¸° í™•ì¸ (ê° 10MB)
        for (let file of files) {
            if (file.size > 10 * 1024 * 1024) {
                Utils.showToast(`íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤: ${file.name} (ìµœëŒ€ 10MB)`, 'error');
                return;
            }
        }

        try {
            // ì§„í–‰ ìƒíƒœ í‘œì‹œ
            document.getElementById('upload-progress').classList.remove('hidden');
            document.getElementById('upload-progress-bar').style.width = '0%';

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            // ì—…ë¡œë“œ ì‹œì‘
            const response = await fetch('/api/commerce/upload-images', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
            }

            const data = await response.json();

            // ì§„í–‰ ìƒíƒœ ì™„ë£Œ
            document.getElementById('upload-progress-bar').style.width = '100%';

            // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì €ì¥
            currentData.uploadedImages = data.images;

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            displayUploadedImages(data.images);

            Utils.showToast(`${data.count}ì¥ì˜ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');

            // ì§„í–‰ ìƒíƒœ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                document.getElementById('upload-progress').classList.add('hidden');
            }, 1000);

        } catch (error) {
            console.error('Upload failed:', error);
            Utils.showToast('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            document.getElementById('upload-progress').classList.add('hidden');
        }
    }

    function displayUploadedImages(imageUrls) {
        const container = document.getElementById('uploaded-images-preview');

        container.innerHTML = imageUrls.map((url, index) => `
            <div class="relative group">
                <img 
                    src="${url}" 
                    class="w-full h-20 object-cover rounded border-2 border-gray-300 dark:border-gray-600"
                    alt="ì—…ë¡œë“œ ì´ë¯¸ì§€ ${index + 1}"
                />
                <button 
                    onclick="removeUploadedImage(${index})"
                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                >
                    Ã—
                </button>
            </div>
        `).join('');
    }

    function removeUploadedImage(index) {
        currentData.uploadedImages.splice(index, 1);
        displayUploadedImages(currentData.uploadedImages);
        Utils.showToast('ì´ë¯¸ì§€ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    }

    // ============ ê¸°ì¡´ í•¨ìˆ˜ë“¤ ============


    // Load style presets
    async function loadStylePresets() {
        try {
            const response = await fetch('/api/commerce/style-presets');
            const data = await response.json();

            const container = document.getElementById('style-presets');
            container.innerHTML = data.presets.map(preset => `
            <button 
                onclick="selectPreset('${preset.key}')" 
                id="preset-${preset.key}"
                class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-500 transition-all text-left"
            >
                <div class="font-bold mb-1">${preset.name}</div>
                <div class="text-xs text-gray-500">${preset.description}</div>
            </button>
        `).join('');

            // Select default
            selectPreset('electronics');
        } catch (error) {
            console.error('Failed to load presets:', error);
        }
    }

    function selectPreset(key) {
        currentData.stylePreset = key;

        // Update UI
        document.querySelectorAll('[id^="preset-"]').forEach(btn => {
            btn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900');
            btn.classList.add('border-gray-300', 'dark:border-gray-600');
        });

        const selected = document.getElementById(`preset-${key}`);
        if (selected) {
            selected.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900');
            selected.classList.remove('border-gray-300', 'dark:border-gray-600');
        }
    }

    async function analyzeProduct() {
        const url = document.getElementById('product-url').value.trim();

        if (!url) {
            alert('ì œí’ˆ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        currentData.productUrl = url;

        try {
            Utils.showToast('ì œí’ˆ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

            const response = await fetch('/api/commerce/analyze-product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_url: url })
            });

            const data = await response.json();
            currentData.productInfo = data;

            // Display product info
            document.getElementById('product-info').innerHTML = `
            <div class="flex gap-4">
                <div class="flex-shrink-0">
                    <img src="${data.product_images[0] || '/static/img/placeholder.png'}" 
                         class="w-32 h-32 object-cover rounded-lg" 
                         alt="ì œí’ˆ ì´ë¯¸ì§€">
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-lg mb-2">${data.product_name}</h4>
                    <p class="text-blue-600 font-bold mb-2">${data.product_price}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${data.product_description}</p>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-sm font-medium mb-2">ì¶”ì¶œëœ ì´ë¯¸ì§€ (${data.product_images.length}ì¥)</p>
                <div class="flex gap-2">
                    ${data.product_images.map((img, i) => `
                        <img src="${img}" class="w-20 h-20 object-cover rounded border-2 border-gray-300" alt="ì´ë¯¸ì§€ ${i + 1}">
                    `).join('')}
                </div>
            </div>
        `;

            // Show step 2
            document.getElementById('step-2').classList.remove('hidden');
            updateStepIndicator(2);

            Utils.showToast('ì œí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');

            // Scroll to step 2
            document.getElementById('step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });

        } catch (error) {
            console.error('Analysis failed:', error);
            Utils.showToast('ì œí’ˆ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function goToStep3() {
        document.getElementById('step-3').classList.remove('hidden');
        updateStepIndicator(3);
        loadStylePresets();

        // Scroll to step 3
        document.getElementById('step-3').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function toggleAdvancedOptions() {
        const options = document.getElementById('advanced-options');
        const icon = document.getElementById('advanced-toggle-icon');

        if (options.classList.contains('hidden')) {
            options.classList.remove('hidden');
            icon.textContent = 'â–¼';
        } else {
            options.classList.add('hidden');
            icon.textContent = 'â–¶';
        }
    }

    async function generateVideo() {
        currentData.message = document.getElementById('message').value;

        // ê³ ê¸‰ ì˜µì…˜ ìˆ˜ì§‘
        const modelType = document.getElementById('model-type')?.value || null;
        const backgroundType = document.getElementById('background-type')?.value || null;
        const musicType = document.getElementById('music-type')?.value || null;
        const ctaType = document.getElementById('cta-type')?.value || 'buy_now';

        // ì œí’ˆ ì´ë¯¸ì§€ì™€ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë³‘í•©
        let finalImages = [];
        if (currentData.uploadedImages.length > 0) {
            // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
            finalImages = currentData.uploadedImages;
        } else if (currentData.productInfo && currentData.productInfo.product_images) {
            // ì—†ìœ¼ë©´ ì œí’ˆ ë¶„ì„ì—ì„œ ì¶”ì¶œí•œ ì´ë¯¸ì§€ ì‚¬ìš©
            finalImages = currentData.productInfo.product_images;
        }

        try {
            // Show step 4
            document.getElementById('step-4').classList.remove('hidden');
            updateStepIndicator(4);

            // Scroll to step 4
            document.getElementById('step-4').scrollIntoView({ behavior: 'smooth', block: 'start' });

            const response = await fetch('/api/commerce/create-video', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_url: currentData.productUrl,
                    product_name: currentData.productInfo?.product_name || 'ì œí’ˆ',
                    product_price: currentData.productInfo?.product_price || '',
                    product_description: currentData.productInfo?.product_description || '',
                    product_images: finalImages,
                    style_preset: currentData.stylePreset,
                    model_type: modelType,
                    background_type: backgroundType,
                    music_type: musicType,
                    cta: ctaType,
                    message: currentData.message
                })
            });

            const data = await response.json();

            document.getElementById('generation-status').innerHTML = `
            <p class="text-green-600 font-medium">âœ… ${data.message}</p>
            <p class="mt-2">ì˜ìƒ ID: ${data.video_id}</p>
        `;

            Utils.showToast('ì˜ìƒ ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

            // Reload video list after a delay
            setTimeout(loadMyVideos, 3000);

        } catch (error) {
            console.error('Generation failed:', error);
            Utils.showToast('ì˜ìƒ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    async function loadMyVideos() {
        try {
            const response = await fetch('/api/commerce/videos');
            const data = await response.json();

            const container = document.getElementById('my-videos');

            if (data.videos.length === 0) {
                container.innerHTML = `
                <p class="text-sm text-gray-500 text-center py-8">
                    ì•„ì§ ìƒì„±ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤
                </p>
            `;
                return;
            }

            container.innerHTML = data.videos.map(video => `
            <div class="flex gap-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:border-blue-500 transition-all">
                <!-- ì¸ë„¤ì¼/ë¯¸ë¦¬ë³´ê¸° -->
                <div class="flex-shrink-0">
                    ${video.video_url ? `
                        <video 
                            src="${video.video_url}" 
                            class="w-32 h-48 object-cover rounded-lg cursor-pointer"
                            onclick="playVideo('${video.video_url}')"
                            onmouseover="this.play()" 
                            onmouseout="this.pause(); this.currentTime=0;"
                            muted
                            loop
                        ></video>
                    ` : video.thumbnail_url ? `
                        <img 
                            src="${video.thumbnail_url}" 
                            class="w-32 h-48 object-cover rounded-lg" 
                            alt="ì¸ë„¤ì¼"
                        />
                    ` : `
                        <div class="w-32 h-48 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                            <span class="text-4xl">ğŸ¬</span>
                        </div>
                    `}
                </div>
                
                <!-- ì •ë³´ -->
                <div class="flex-1">
                    <h4 class="font-bold text-lg mb-1">${video.product_name || 'ì œí’ˆëª… ì—†ìŒ'}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${video.product_price || ''}</p>
                    <p class="text-xs text-gray-500 mb-2">ìƒì„±ì¼: ${new Date(video.created_at).toLocaleDateString()}</p>
                    
                    <!-- ìƒíƒœ ë°°ì§€ -->
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-1 rounded text-xs ${video.status === 'completed' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                    video.status === 'processing' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                        video.status === 'failed' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                            'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                }">
                            ${video.status === 'completed' ? 'âœ… ì™„ë£Œ' :
                    video.status === 'processing' ? 'â³ ìƒì„± ì¤‘' :
                        video.status === 'failed' ? 'âŒ ì‹¤íŒ¨' :
                            'â¸ï¸ ëŒ€ê¸° ì¤‘'
                }
                        </span>
                        
                        ${video.style_preset ? `
                            <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                ${video.style_preset}
                            </span>
                        ` : ''}
                    </div>
                    
                    ${video.message ? `
                        <p class="text-sm text-gray-600 dark:text-gray-400 italic">"${video.message}"</p>
                    ` : ''}
                    
                    ${video.error_message ? `
                        <p class="text-xs text-red-600 dark:text-red-400 mt-2">âš ï¸ ${video.error_message}</p>
                    ` : ''}
                </div>
                
                <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                <div class="flex flex-col gap-2">
                    ${video.video_url ? `
                        <button onclick="playVideo('${video.video_url}')" class="btn-primary px-3 py-2 text-sm whitespace-nowrap">
                            â–¶ï¸ ì¬ìƒ
                        </button>
                        <a href="${video.video_url}" download class="btn-secondary px-3 py-2 text-sm text-center whitespace-nowrap">
                            â¬‡ï¸ ë‹¤ìš´ë¡œë“œ
                        </a>
                    ` : video.status === 'processing' ? `
                        <button onclick="refreshVideo(${video.id})" class="btn-secondary px-3 py-2 text-sm whitespace-nowrap">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    ` : ''}
                    <button onclick="deleteVideo(${video.id})" class="btn-danger px-3 py-2 text-sm whitespace-nowrap">
                        ğŸ—‘ï¸ ì‚­ì œ
                    </button>
                </div>
            </div>
        `).join('');

        } catch (error) {
            console.error('Failed to load videos:', error);
        }
    }

    function playVideo(videoUrl) {
        // ëª¨ë‹¬ë¡œ ì˜ìƒ ì¬ìƒ
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        modal.onclick = () => modal.remove();

        modal.innerHTML = `
            <div class="relative max-w-2xl w-full p-4" onclick="event.stopPropagation()">
                <button 
                    onclick="this.closest('.fixed').remove()" 
                    class="absolute top-2 right-2 bg-white dark:bg-gray-800 rounded-full w-10 h-10 flex items-center justify-center text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 z-10"
                >
                    Ã—
                </button>
                <video 
                    src="${videoUrl}" 
                    class="w-full rounded-lg shadow-2xl" 
                    controls 
                    autoplay
                ></video>
            </div>
        `;

        document.body.appendChild(modal);
    }

    async function refreshVideo(videoId) {
        Utils.showToast('ì˜ìƒ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
        await loadMyVideos();
    }

    async function deleteVideo(videoId) {
        if (!confirm('ì´ ì˜ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            await fetch(`/api/commerce/videos/${videoId}`, { method: 'DELETE' });
            Utils.showToast('ì˜ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            loadMyVideos();
        } catch (error) {
            console.error('Delete failed:', error);
            Utils.showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function updateStepIndicator(step) {
        for (let i = 1; i <= 4; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            if (i <= step) {
                indicator.classList.remove('bg-gray-300', 'dark:bg-gray-700', 'text-gray-500');
                indicator.classList.add('bg-blue-500', 'text-white');
            }
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadMyVideos();
    });
</script>

{% endblock %}