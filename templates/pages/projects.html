{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ“‚</span>
        <div>
            <h1>ë‚´ í”„ë¡œì íŠ¸</h1>
            <p>ì§„í–‰ ì¤‘ì¸ ëª¨ë“  ì˜ìƒ í”„ë¡œì íŠ¸ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
    </div>
    <button onclick="openProjectModal()" class="btn-primary flex items-center gap-2">
        <span>+</span>
        <span>ìƒˆ í”„ë¡œì íŠ¸</span>
    </button>
</div>

<!-- í”„ë¡œì íŠ¸ ëª©ë¡ -->
<div id="loadingSection" class="hidden">
    <div class="card text-center py-12">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-500">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

<div id="projectGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- í”„ë¡œì íŠ¸ ì¹´ë“œê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
</div>

<!-- ë¹ˆ ìƒíƒœ -->
<div id="emptySection" class="card text-center py-12 hidden">
    <div class="text-5xl mb-4">ğŸ“</div>
    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
    <p class="text-gray-500 mb-6">ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
    <button onclick="openProjectModal()" class="btn-primary">
        + ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadProjectList() {
        document.getElementById('loadingSection').classList.remove('hidden');
        document.getElementById('projectGrid').innerHTML = '';
        document.getElementById('emptySection').classList.add('hidden');

        try {
            const data = await API.project.list();

            if (!data.projects || data.projects.length === 0) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('emptySection').classList.remove('hidden');
                return;
            }

            renderProjects(data.projects);
            document.getElementById('loadingSection').classList.add('hidden');
        } catch (e) {
            console.error('í”„ë¡œì íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', e);
            document.getElementById('loadingSection').classList.add('hidden');
            Utils.showToast('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function renderProjects(projects) {
        const grid = document.getElementById('projectGrid');

        grid.innerHTML = projects.map(p => `
            <div class="card hover:shadow-lg transition cursor-pointer group" onclick="selectAndGo('${p.id}')">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2">
                         <span class="text-2xl">${p.status === 'completed' ? 'âœ…' : 'ğŸ“'}</span>
                         <div>
                            <h3 class="font-bold text-lg text-gray-800 dark:text-white group-hover:text-blue-500 transition">${p.name}</h3>
                            <p class="text-xs text-gray-400">${new Date(p.updated_at).toLocaleString()}</p>
                         </div>
                    </div>
                </div>
                
                <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
                    <div class="flex justify-between">
                        <span>ì£¼ì œ</span>
                        <span>${p.topic || '-'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ìƒíƒœ</span>
                        <span class="px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700 text-xs">
                            ${statusLabels[p.status] || p.status}
                        </span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-2">
                    <button onclick="event.stopPropagation(); deleteProject('${p.id}')" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded-lg transition">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function selectAndGo(projectId) {
        // í”„ë¡œì íŠ¸ ì„ íƒ í›„ ëŒ€ë³¸ ê¸°íš í˜ì´ì§€ë¡œ ì´ë™ (ê°€ì¥ ì¼ë°˜ì ì¸ ë‹¤ìŒ ë‹¨ê³„)
        setCurrentProject(projectId);
        window.location.href = '/script-plan'; // Or topic, but usually script-plan is central
    }

    async function deleteProject(projectId) {
        if (!confirm('ì •ë§ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

        try {
            await API.project.delete(projectId);
            Utils.showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            loadProjectList();
            // ì‚¬ì´ë“œë°” ëª©ë¡ë„ ê°±ì‹ 
            if (window.loadProjects) window.loadProjects();
        } catch (e) {
            Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', loadProjectList);
</script>
{% endblock %}