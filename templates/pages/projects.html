{% extends "base.html" %}

{% block content %}
<div class="flex justify-end mb-6">
    <button onclick="openProjectModal()" class="btn-primary flex items-center gap-2">
        <span>+</span>
        <span>New Project</span>
    </button>
</div>

<!-- í”„ë¡œì íŠ¸ ëª©ë¡ -->
<div id="loadingSection" class="hidden">
    <div class="card text-center py-12">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-500">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

<div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap sticky left-0 bg-gray-50 dark:bg-gray-700 z-10">
                    í”„ë¡œì íŠ¸ëª…</th>
                <th scope="col"
                    class="px-1 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap w-20">
                    ì‹œì‘ì¼</th>
                <th scope="col"
                    class="px-1 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap w-20">
                    ìˆ˜ì •ì¼</th>
                <th scope="col"
                    class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">
                    ì£¼ì œ</th>
                <th scope="col"
                    class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap max-w-[150px]">
                    ì˜ìƒ ì œëª©</th>
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="ëŒ€ë³¸ ê¸°íš">ê¸°íš</th>
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="ëŒ€ë³¸ ìƒì„±">ëŒ€ë³¸</th>
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="ì´ë¯¸ì§€ ìƒì„±">ì´ë¯¸ì§€</th>
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="TTS ìƒì„±">TTS</th>
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="ì˜ìƒ ë Œë”ë§">ì˜ìƒ</th>
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="ì¸ë„¤ì¼ ìƒì„±">ì¸ë„¤ì¼</th>
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="ì„¤ëª…/íƒœê·¸">ì„¤ëª…</th>
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="ì—…ë¡œë“œ/ì˜ˆì•½ ì™„ë£Œ">{% if is_independent %}ì—…ë¡œë“œ{% else %}ì˜ˆì•½{% endif %}</th>
                {% if is_independent %}
                <th scope="col"
                    class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap"
                    title="ë°œí–‰ ì™„ë£Œ">ë°œí–‰</th>
                {% endif %}
                <th scope="col"
                    class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">
                    ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="projectTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <!-- Rows rendered here -->
        </tbody>
    </table>
</div>

<div id="emptySection" class="card text-center py-12 hidden">
    <div class="text-5xl mb-4">ğŸ“</div>
    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
    <p class="text-gray-500 mb-6">ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
    <button onclick="openProjectModal()" class="btn-primary">
        + ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    const isIndependent = JSON.parse('{{ is_independent | tojson | safe }}');
    const licenseKey = '{{ get_license_key() }}';

    async function loadProjectList() {
        document.getElementById('loadingSection').classList.remove('hidden');
        document.getElementById('projectTableBody').innerHTML = '';
        document.getElementById('emptySection').classList.add('hidden');

        try {
            // [NEW] Get Current Mode from Settings
            let targetMode = 'longform';
            try {
                const res = await fetch('/api/settings');
                const settings = await res.json();
                targetMode = settings.app_mode || 'longform';
            } catch (e) { console.error("Failed to load settings:", e); }

            console.log("Filtering projects for mode:", targetMode);

            const data = await API.project.list();

            if (!data.projects || data.projects.length === 0) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('emptySection').classList.remove('hidden');
                document.querySelector('.overflow-x-auto').classList.add('hidden');
                return;
            }

            // [FIX] Filter by App Mode
            // Legacy projects (app_mode is null/undefined) => treat as 'longform'
            const filteredProjects = data.projects.filter(p => {
                const pMode = p.app_mode || 'longform';
                return pMode === targetMode;
            });

            if (filteredProjects.length === 0) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('emptySection').classList.remove('hidden');
                document.querySelector('.overflow-x-auto').classList.add('hidden');
                // Optional: Change Title
                document.querySelector('#emptySection h3').textContent =
                    targetMode === 'shorts' ? 'ì‡¼ì¸  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ë¡±í¼ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤';
                return;
            } else {
                document.querySelector('.overflow-x-auto').classList.remove('hidden');
            }

            renderProjects(filteredProjects);
            document.getElementById('loadingSection').classList.add('hidden');
        } catch (e) {
            console.error('í”„ë¡œì íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', e);
            document.getElementById('loadingSection').classList.add('hidden');
            Utils.showToast('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function renderProjects(projects) {
        const tbody = document.getElementById('projectTableBody');

        tbody.innerHTML = projects.map(p => {
            const s = p.progress || {};
            // ë‚ ì§œ í¬ë§· (YY.MM.DD)
            const created = new Date(p.created_at).toLocaleDateString(undefined, { year: '2-digit', month: '2-digit', day: '2-digit' });
            const updated = new Date(p.updated_at).toLocaleDateString(undefined, { year: '2-digit', month: '2-digit', day: '2-digit' });

            // ìƒíƒœ ì•„ì´ì½˜ í—¬í¼
            const checkLink = (isDone, type, pid) => {
                const color = isDone ? 'text-green-500 hover:text-green-600 scale-110' : 'text-gray-300 dark:text-gray-600 hover:text-gray-400';
                const symbol = isDone ? 'â—' : 'â—‹';
                const cursor = isDone ? 'cursor-pointer' : 'cursor-default';
                const clickHandler = isDone ? `onclick="event.stopPropagation(); navigateToStep('${pid}', '${type}')"` : '';

                return `<div class="flex items-center justify-center w-8 h-8 mx-auto rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition ${cursor}" ${clickHandler} title="${type} í˜ì´ì§€ë¡œ ì´ë™">
                    <span class="${color} text-lg font-bold">${symbol}</span>
                </div>`;
            };

            return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-750 transition cursor-pointer group" onclick="selectAndGo('${p.id}')">
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white sticky left-0 bg-white dark:bg-gray-800 group-hover:bg-gray-50 dark:group-hover:bg-gray-750 z-10 border-r dark:border-gray-700"
                    ondblclick="event.stopPropagation(); startInlineEdit(this, '${p.id}', 'name')">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">ğŸ“</span>
                        <span>${p.name}</span>
                    </div>
                </td>
                <td class="px-1 py-3 whitespace-nowrap text-center text-sm text-gray-500 dark:text-gray-400 w-20">${created}</td>
                <td class="px-1 py-3 whitespace-nowrap text-center text-sm text-gray-500 dark:text-gray-400 w-20">${updated}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 max-w-[120px] truncate" 
                    title="${p.topic || ''}" ondblclick="event.stopPropagation(); startInlineEdit(this, '${p.id}', 'topic')">
                    ${p.topic || '-'}
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 max-w-[150px] truncate" 
                    title="${p.video_title || ''}" ondblclick="event.stopPropagation(); startInlineEdit(this, '${p.id}', 'video_title')">
                    ${p.video_title || '-'}
                </td>
                
                <!-- Steps -->
                <td class="px-1 py-3 text-center whitespace-nowrap">${checkLink(s.plan, 'script-plan', p.id)}</td>
                <td class="px-1 py-3 text-center whitespace-nowrap">${checkLink(s.script, 'script-gen', p.id)}</td>
                <td class="px-1 py-3 text-center whitespace-nowrap">${checkLink(s.image, 'image-gen', p.id)}</td>
                <td class="px-1 py-3 text-center whitespace-nowrap">${checkLink(s.tts, 'tts', p.id)}</td>
                <td class="px-1 py-3 text-center whitespace-nowrap">${checkLink(s.video, 'render', p.id)}</td>
                <td class="px-1 py-3 text-center whitespace-nowrap">${checkLink(s.thumbnail, 'thumbnail', p.id)}</td>
                <td class="px-1 py-3 text-center whitespace-nowrap">${checkLink(s.desc, 'title-desc', p.id)}</td>
                <td class="px-1 py-3 text-center whitespace-nowrap relative">
                    ${checkLink(s.upload, 'upload', p.id)}
                    <!-- Auto Upload Rocket Icon (Only if Metadata exists) -->
                    ${s.desc && (s.video || s.upload) ? `
                    <button onclick="event.stopPropagation(); autoUploadYouTube('${p.id}')" 
                        class="absolute -right-3 top-1/2 -translate-y-1/2 text-lg hover:scale-125 transition-transform z-20" 
                        title="${isIndependent ? 'ìœ íŠœë¸Œ ì›í´ë¦­ ìë™ ì—…ë¡œë“œ (ì˜ìƒ+ë©”íƒ€+ì¸ë„¤ì¼)' : 'í´ë¼ìš°ë“œ ì „ì†¡ ë° ì—…ë¡œë“œ ì˜ˆì•½ ì‹ ì²­'}">
                        ğŸš€
                    </button>` : ''}
                </td>
                ${isIndependent ? `
                <td class="px-1 py-3 text-center whitespace-nowrap relative">
                    ${checkLink(s.publish, 'publish', p.id)}
                    ${s.upload && !s.publish ? `
                    <button onclick="event.stopPropagation(); publicizeVideo('${p.id}')" 
                        class="absolute -right-3 top-1/2 -translate-y-1/2 text-lg hover:scale-125 transition-transform" 
                        title="ìœ íŠœë¸Œ ì˜ìƒì„ 'ê³µê°œ'ë¡œ ì „í™˜">
                        ğŸ“¢
                    </button>` : ''}
                </td>` : ''}

                <td class="px-3 py-3 whitespace-nowrap text-center text-sm font-medium">
                    <button onclick="event.stopPropagation(); deleteProject('${p.id}')" class="text-red-400 hover:text-red-900 transition p-1 rounded hover:bg-red-50 dark:hover:bg-red-900/40">
                        ğŸ—‘ï¸
                    </button>
                </td>
            </tr>
            `;
        }).join('');
    }

    function navigateToStep(projectId, step) {
        console.log(`Navigating to step ${step} for project ${projectId}`);
        setCurrentProject(projectId);
        window.location.href = '/' + step;
    }

    async function selectAndGo(projectId) {
        // [FIX] Single Click: Just Highlight or do nothing? 
        // User requested Double Click -> Select in Sidebar.
        // We will keep single click as "noop" or simple highlight for now, 
        // and let Double Click handle the selection.
        console.log('Single click on project:', projectId);
        // Optional: Add visual highlight logic here if needed
    }

    async function handleProjectDoubleClick(projectId) {
        // [DEPRECATED] Now using inline editing on specific cells.
        // If users still want to select project via double click, we can keep it for OTHER cells or handle it differently.
        console.log('Project double clicked:', projectId);
    }

    // --- Inline Inline Editing ---
    let isEditing = false;

    window.startInlineEdit = function (cell, projectId, field) {
        if (isEditing) return;
        isEditing = true;

        const originalContent = cell.innerHTML;
        const originalValue = cell.innerText.trim();
        const valueToEdit = originalValue === '-' ? '' : originalValue;

        // Create Input
        const input = document.createElement('input');
        input.type = 'text';
        input.value = valueToEdit;
        input.className = 'input-field text-sm py-1 w-full';

        // Match padding/style
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();

        const finishEdit = async (save) => {
            const newValue = input.value.trim();
            if (save && newValue !== valueToEdit) {
                try {
                    const data = {};
                    data[field] = newValue;
                    const res = await API.project.update(projectId, data);
                    if (res.status === 'ok') {
                        Utils.showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        // Update UI
                        if (field === 'name') {
                            cell.innerHTML = `
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">ğŸ“</span>
                                    <span>${newValue}</span>
                                </div>
                            `;
                            // Update sidebar if needed
                            if (window.loadProjects) window.loadProjects();
                        } else {
                            cell.innerText = newValue || '-';
                            cell.title = newValue;
                        }
                    } else {
                        throw new Error(res.error || 'ì €ì¥ ì‹¤íŒ¨');
                    }
                } catch (e) {
                    Utils.showToast(e.message, 'error');
                    cell.innerHTML = originalContent;
                }
            } else {
                cell.innerHTML = originalContent;
            }
            isEditing = false;
        };

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') finishEdit(true);
            if (e.key === 'Escape') finishEdit(false);
        });

        input.addEventListener('blur', () => {
            finishEdit(true);
        });
    };

    async function deleteProject(projectId) {
        if (!confirm('ì •ë§ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

        try {
            await API.project.delete(projectId);
            Utils.showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            loadProjectList();
            // ì‚¬ì´ë“œë°” ëª©ë¡ë„ ê°±ì‹ 
            if (window.loadProjects) window.loadProjects();
        } catch (e) {
            Utils.showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
        }
    }

    async function autoUploadYouTube(projectId) {
        const rocketBtn = event.currentTarget;
        const originalText = rocketBtn.innerText;

        if (isIndependent) {
            if (!confirm('ìœ íŠœë¸Œì— ì˜ìƒì„ ìë™ìœ¼ë¡œ ì—…ë¡œë“œí•˜ê³  ì¸ë„¤ì¼/ë©”íƒ€ë°ì´í„°ë¥¼ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                rocketBtn.innerText = 'â³';
                rocketBtn.disabled = true;
                Utils.showToast('ìœ íŠœë¸Œ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');

                const res = await fetch(`/api/youtube/upload-external/${projectId}`, { method: 'POST' });
                const data = await res.json();

                if (res.ok && data.status === 'ok') {
                    Utils.showToast('ìœ íŠœë¸Œ ì—…ë¡œë“œ ë° ì„¤ì • ì™„ë£Œ!', 'success');
                    loadProjectList();
                } else throw new Error(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
            } catch (e) {
                Utils.showToast(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
            } finally {
                rocketBtn.innerText = originalText;
                rocketBtn.disabled = false;
            }
        } else {
            // [STANDARD USER] Direct YouTube Private Upload + Admin Record
            if (!confirm('ìœ íŠœë¸Œ ì±„ë„ (@Honjada)ì— "ë¹„ê³µê°œ"ë¡œ ì˜ˆì•½ ì—…ë¡œë“œí•˜ê³  ê²€í† ë¥¼ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                rocketBtn.innerText = 'â³';
                rocketBtn.disabled = true;
                Utils.showToast('ìœ íŠœë¸Œ ì˜ˆì•½ ì—…ë¡œë“œ ì¤‘...', 'info');

                // 1. YouTube Upload
                const ytRes = await fetch(`/api/youtube/upload-external/${projectId}`, { method: 'POST' });
                const ytData = await ytRes.json();
                if (ytRes.status !== 200 || ytData.status !== 'ok') throw new Error(ytData.error || "ìœ íŠœë¸Œ ì—…ë¡œë“œ ì‹¤íŒ¨");

                // 2. Submit record to Central Server
                const fullData = await API.project.get(projectId);
                const settings = await API.project.getSettings(projectId);

                const payload = {
                    userId: licenseKey,
                    videoUrl: ytData.url,
                    videoId: ytData.video_id,
                    metadata: {
                        title: settings.title || fullData.name,
                        projectId: projectId,
                        isYouTubePrivate: true
                    }
                };

                const pubRes = await fetch('{{ AUTH_SERVER_URL }}/api/publishing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const pubData = await pubRes.json();
                if (pubData.success) {
                    Utils.showToast("ì„±ê³µ! ìœ íŠœë¸Œ ì±„ë„ì— ë¹„ê³µê°œë¡œ ì—…ë¡œë“œë˜ì—ˆìœ¼ë©° ê²€í†  ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
                    loadProjectList();
                } else throw new Error(pubData.error || "ì¤‘ì•™ ì„œë²„ ê¸°ë¡ ì‹¤íŒ¨");
            } catch (e) {
                console.error('ë°œí–‰ ìš”ì²­ ì‹¤íŒ¨:', e);
                Utils.showToast(`ì˜¤ë¥˜: ${e.message}`, 'error');
            } finally {
                rocketBtn.innerText = originalText;
                rocketBtn.disabled = false;
            }
        }
    }

    async function publicizeVideo(projectId) {
        if (!confirm('ìœ íŠœë¸Œ ì˜ìƒì„ "ê³µê°œ" ìƒíƒœë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì‚¬ëŒì´ ì˜ìƒì„ ë³¼ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.')) return;

        try {
            Utils.showToast('ê³µê°œ ìƒíƒœë¡œ ì „í™˜ ì¤‘...', 'info');
            const res = await fetch(`/api/projects/${projectId}/youtube/public`, {
                method: 'POST'
            });
            const data = await res.json();

            if (res.ok && data.status === 'ok') {
                Utils.showToast('ì„±ê³µì ìœ¼ë¡œ ê³µê°œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                loadProjectList();
            } else {
                throw new Error(data.detail || 'ì „í™˜ ì‹¤íŒ¨');
            }
        } catch (e) {
            console.error('ê³µê°œ ì „í™˜ ì‹¤íŒ¨:', e);
            Utils.showToast(`ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', loadProjectList);
</script>
{% endblock %}