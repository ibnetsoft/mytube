{% extends "base.html" %}

{% block content %}


<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">{{ t('shorts_settings_title') }}</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ t('label_shorts_count')
                }}</label>
            <select id="shortsCount" class="input-field">
                <option value="1">1{{ t('unit_count') }}</option>
                <option value="3" selected>3{{ t('unit_count') }}</option>
                <option value="5">5{{ t('unit_count') }}</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ t('label_shorts_length')
                }}</label>
            <select id="shortsLength" class="input-field">
                <option value="30">30{{ t('unit_sec') }}</option>
                <option value="45">45{{ t('unit_sec') }}</option>
                <option value="60" selected>60{{ t('unit_sec') }} {{ t('btn_gen_hook_helper') }}</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ t('label_shorts_style')
                }}</label>
            <select id="shortsStyle" class="input-field">
                <option value="hook">{{ t('opt_style_hook') }}</option>
                <option value="tip">{{ t('opt_style_tip') }}</option>
                <option value="story">{{ t('opt_style_story') }}</option>
                <option value="question">{{ t('opt_style_question') }}</option>
            </select>
        </div>
    </div>
</div>

<button onclick="generateShorts()" id="generateBtn"
    class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg mb-6">
    <span>ðŸ“±</span>
    <span>{{ t('btn_gen_shorts') }}</span>
</button>

<div id="resultSection" class="hidden">
    <div id="shortsList" class="space-y-6"></div>
</div>

<!-- ì‡¼ì¸  íŒ -->
<div class="card bg-blue-50 dark:bg-blue-900/30 mt-6">
    <h4 class="font-bold text-blue-800 dark:text-blue-300 mb-3">{{ t('viral_shorts_title') }}</h4>
    <ul class="text-blue-700 dark:text-blue-400 text-sm space-y-2">
        <li>{{ t('viral_tip_1') }}</li>
        <li>{{ t('viral_tip_2') }}</li>
        <li>{{ t('viral_tip_3') }}</li>
        <li>{{ t('viral_tip_4') }}</li>
        <li>{{ t('viral_tip_5') }}</li>
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
    let shortsData = [];

    async function generateShorts() {
        const scriptData = Utils.storage.get('fullScript');
        if (!scriptData?.script) {
            Utils.showToast("{{ t('err_no_script') }}", 'warning');
            return;
        }

        const count = document.getElementById('shortsCount').value;
        const length = document.getElementById('shortsLength').value;
        const style = document.getElementById('shortsStyle').value;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, "{{ t('status_generating') }}");

        const prompt = `ìœ íŠœë¸Œ ì‡¼ì¸  ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ë¡±í¼ ëŒ€ë³¸ì—ì„œ ì‡¼ì¸ ìš© í•˜ì´ë¼ì´íŠ¸ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

[ì›ë³¸ ëŒ€ë³¸]
${scriptData.script.substring(0, 3000)}

[ì„¤ì •]
- ì‡¼ì¸  ê°œìˆ˜: ${count}ê°œ
- ê¸¸ì´: ${length}ì´ˆ
- ìŠ¤íƒ€ì¼: ${style}

JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:
{
    "shorts": [
        {
            "title": "ì‡¼ì¸  ì œëª©",
            "hook": "ì²« 1ì´ˆì— ë§í•  í›„í‚¹ ë©˜íŠ¸",
            "script": "ì „ì²´ ì‡¼ì¸  ëŒ€ë³¸ (${length}ì´ˆ ë¶„ëŸ‰)",
            "hashtags": "#í•´ì‹œíƒœê·¸1 #í•´ì‹œíƒœê·¸2 #í•´ì‹œíƒœê·¸3"
        }
    ]
}

ê° ì‡¼ì¸ ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì´í•´ ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤. JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”.`;

        try {
            const result = await API.gemini.generate(prompt, { temperature: 0.8 });

            if (result.status === 'ok') {
                const jsonMatch = result.text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const data = JSON.parse(jsonMatch[0]);
                    shortsData = data.shorts;
                    renderShorts();
                    document.getElementById('resultSection').classList.remove('hidden');
                }
            }
        } catch (error) {
            Utils.showToast("{{ t('status_error') }}", 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderShorts() {
        document.getElementById('shortsList').innerHTML = shortsData.map((short, i) => `
            <div class="card overflow-hidden">
                <div class="bg-gradient-to-r from-red-500 to-orange-500 p-4 text-white -m-6 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center font-bold">${i + 1}</span>
                            <span class="font-bold">{{ t('short_num_prefix') }}${i + 1}</span>
                        </div>
                        <button onclick="copyShorts(${i})" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition">
                            {{ t('btn_copy_all_v2') }}
                        </button>
                    </div>
                    <p class="mt-2 text-white/90">${short.title}</p>
                </div>

                <div class="space-y-4 mt-6">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded text-xs font-bold">{{ t('label_hook_ko') }}</span>
                            <span class="text-sm text-gray-500">{{ t('label_first_sec') }}</span>
                        </div>
                        <p class="font-medium bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg">"${short.hook}"</p>
                    </div>

                    <div>
                        <p class="text-sm text-gray-500 mb-2">{{ t('label_full_script_ko') }}</p>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-sm whitespace-pre-wrap">${short.script}</div>
                    </div>

                    <div class="text-blue-500">${short.hashtags}</div>
                </div>
            </div>
        `).join('');
    }

    function copyShorts(index) {
        const short = shortsData[index];
        const text = `Title: ${short.title}\n\n${short.script}\n\n${short.hashtags}`;
        Utils.copyToClipboard(text);
        Utils.showToast("{{ t('toast_shorts_copied') }}", 'success');
    }
</script>
{% endblock %}