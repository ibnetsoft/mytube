{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ“</span>
        <div>
            <h1>ì œëª©/ì„¤ëª… ìƒì„±</h1>
            <p>SEO ìµœì í™”ëœ ì œëª©ê³¼ ì„¤ëª…ì„ ìƒì„±í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ ìƒì„± ì˜µì…˜</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì œëª© ìŠ¤íƒ€ì¼</label>
            <select id="titleStyle" class="input-field">
                <option value="curiosity">í˜¸ê¸°ì‹¬ ìœ ë°œí˜•</option>
                <option value="benefit">í˜œíƒ ê°•ì¡°í˜•</option>
                <option value="number">ìˆ«ì í¬í•¨í˜•</option>
                <option value="question">ì§ˆë¬¸í˜•</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">íƒ€ê²Ÿ í‚¤ì›Œë“œ</label>
            <input type="text" id="targetKeyword" class="input-field" placeholder="ì„ íƒì‚¬í•­">
        </div>
    </div>
</div>

<button onclick="generateMeta()" id="generateBtn"
    class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg mb-6">
    <span>ğŸ“</span>
    <span>ì œëª©/ì„¤ëª… ìƒì„±</span>
</button>

<div id="resultSection" class="hidden space-y-6">
    <!-- ì œëª© -->
    <div class="card">
        <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ·ï¸ ì¶”ì²œ ì œëª©</h3>
        <div id="titlesList" class="space-y-2"></div>
    </div>

    <!-- ì„¤ëª… -->
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800 dark:text-white">ğŸ“„ ì˜ìƒ ì„¤ëª…</h3>
            <button onclick="copyDescription()" class="btn-secondary text-sm">ğŸ“‹ ë³µì‚¬</button>
        </div>
        <textarea id="descriptionText" class="input-field" rows="8"></textarea>
    </div>

    <!-- íƒœê·¸ -->
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800 dark:text-white">#ï¸âƒ£ íƒœê·¸</h3>
            <button onclick="copyTags()" class="btn-secondary text-sm">ğŸ“‹ ë³µì‚¬</button>
        </div>
        <div id="tagsList" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- í•´ì‹œíƒœê·¸ -->
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800 dark:text-white"># í•´ì‹œíƒœê·¸</h3>
            <button onclick="copyHashtags()" class="btn-secondary text-sm">ğŸ“‹ ë³µì‚¬</button>
        </div>
        <p id="hashtagsText" class="text-blue-500"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let projectId = Utils.storage.get('currentProjectId');
    // Ensure numeric
    if (projectId && typeof projectId === 'string') projectId = parseInt(projectId);

    let metaData = null;

    document.addEventListener('DOMContentLoaded', () => {
        if (projectId) {
            loadMetadata();
        } else {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        }
    });

    async function loadMetadata() {
        try {
            const res = await fetch(`/api/projects/${projectId}/metadata`);
            const data = await res.json();
            if (data && data.titles) {
                metaData = data;
                renderResults();
                document.getElementById('resultSection').classList.remove('hidden');
            }
        } catch (e) {
            console.error('ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
        }
    }

    async function saveMetadata() {
        if (!projectId || !metaData) return;
        try {
            await fetch(`/api/projects/${projectId}/metadata`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(metaData)
            });
        } catch (e) {
            console.error('ë©”íƒ€ë°ì´í„° ì €ì¥ ì‹¤íŒ¨', e);
        }
    }

    async function generateMeta() {
        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        // ëŒ€ë³¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (DBì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ì•ˆì „í•  ìˆ˜ ìˆìœ¼ë‚˜, ì¼ë‹¨ ê¸°ì¡´ flow ìœ ì§€)
        // ë§Œì•½ Utils.storageì— ì—†ë‹¤ë©´ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨
        let scriptData = Utils.storage.get('fullScript');

        // storageì— ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
        if (!scriptData) {
            try {
                const res = await fetch(`/api/projects/${projectId}/full`);
                if (res.ok) {
                    const fullData = await res.json();
                    scriptData = { script: fullData.script?.full_script };
                }
            } catch (e) {
                console.error("ëŒ€ë³¸ ë¡œë“œ ì‹¤íŒ¨", e);
            }
        }

        const style = document.getElementById('titleStyle').value;
        const keyword = document.getElementById('targetKeyword').value;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        const prompt = `ìœ íŠœë¸Œ SEO ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ëŒ€ë³¸ì— ë§ëŠ” ë©”íƒ€ë°ì´í„°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

[ëŒ€ë³¸ ìš”ì•½]
${scriptData?.script?.substring(0, 1000) || 'ì¼ë°˜ ìœ íŠœë¸Œ ì˜ìƒ'}

[ì œëª© ìŠ¤íƒ€ì¼]
${style}

[íƒ€ê²Ÿ í‚¤ì›Œë“œ]
${keyword || 'ì—†ìŒ'}

JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:
{
    "titles": ["ì œëª©1 (50ì ì´ë‚´)", "ì œëª©2", "ì œëª©3", "ì œëª©4", "ì œëª©5"],
    "description": "ì˜ìƒ ì„¤ëª… (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨, 500ì ë‚´ì™¸)",
    "tags": ["íƒœê·¸1", "íƒœê·¸2", ...],
    "hashtags": ["#í•´ì‹œíƒœê·¸1", "#í•´ì‹œíƒœê·¸2", ...]
}

JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”.`;

        try {
            const result = await API.gemini.generate(prompt, { temperature: 0.7 });

            if (result.status === 'ok') {
                const jsonMatch = result.text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    metaData = JSON.parse(jsonMatch[0]);
                    renderResults();
                    document.getElementById('resultSection').classList.remove('hidden');
                    // ìƒì„± í›„ ìë™ ì €ì¥
                    await saveMetadata();
                    Utils.showToast('ë©”íƒ€ë°ì´í„°ê°€ ìƒì„± ë° ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                }
            }
        } catch (error) {
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderResults() {
        if (!metaData) return;

        // ì œëª©
        document.getElementById('titlesList').innerHTML = (metaData.titles || []).map((title, i) => `
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <span class="text-gray-800 dark:text-white">${title}</span>
                <button onclick="copyTitle(${i})" class="btn-secondary text-xs">ë³µì‚¬</button>
            </div>
        `).join('');

        // ì„¤ëª…
        document.getElementById('descriptionText').value = metaData.description || '';

        // íƒœê·¸
        document.getElementById('tagsList').innerHTML = (metaData.tags || []).map(tag => `
            <span class="px-3 py-1 bg-gray-200 dark:bg-gray-600 rounded-full text-sm">${tag}</span>
        `).join('');

        // í•´ì‹œíƒœê·¸
        document.getElementById('hashtagsText').textContent = (metaData.hashtags || []).join(' ');
    }

    // ì„¤ëª…ë¬¸êµ¬ ìˆ˜ì • ì‹œ ìë™ ì €ì¥ íŠ¸ë¦¬ê±°
    document.getElementById('descriptionText').addEventListener('change', (e) => {
        if (metaData) {
            metaData.description = e.target.value;
            saveMetadata();
        }
    });

    function copyTitle(index) {
        Utils.copyToClipboard(metaData.titles[index]);
        Utils.showToast('ì œëª©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function copyDescription() {
        Utils.copyToClipboard(document.getElementById('descriptionText').value);
        Utils.showToast('ì„¤ëª…ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function copyTags() {
        Utils.copyToClipboard(metaData.tags.join(', '));
        Utils.showToast('íƒœê·¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function copyHashtags() {
        Utils.copyToClipboard(metaData.hashtags.join(' '));
        Utils.showToast('í•´ì‹œíƒœê·¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }
</script>
{% endblock %}