{% extends "base.html" %}

{% block content %}
<div class="h-[calc(100vh-140px)] flex flex-col gap-3 p-2">
    <!-- 1. ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” (ë†’ì´ ìµœì†Œí™”) -->
    <div
        class="flex items-center gap-3 p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 shrink-0">


        <div class="flex-1 flex items-center gap-2">
            <span class="text-sm font-bold text-gray-700 dark:text-gray-300 whitespace-nowrap">ğŸ¯ {{
                t('label_target_keyword') }}</span>
            <input type="text" id="targetKeyword"
                class="text-xs flex-1 border-gray-300 dark:border-gray-600 rounded-md py-1.5 px-3 focus:ring-primary focus:border-primary bg-gray-50 dark:bg-gray-700 dark:text-white"
                placeholder="{{ t('placeholder_target_keyword') }}">

            <!-- [NEW] Project Title Display -->
            <div
                class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/30 rounded border border-indigo-100 dark:border-indigo-800 ml-2 max-w-[200px] shrink-0">
                <span class="text-xs font-bold text-indigo-700 dark:text-indigo-300 whitespace-nowrap">{{
                    t('label_title_prefix') }}</span>
                <span id="projectTitleDisplay" class="text-xs text-gray-600 dark:text-gray-300 truncate cursor-help"
                    title="{{ t('status_no_title') }}">{{ t('status_no_title') }}</span>
            </div>
        </div>

        <button onclick="generateMeta()" id="generateBtn"
            class="btn-primary py-1.5 px-4 text-sm font-medium rounded-md shadow-sm hover:shadow active:scale-95 transition-all flex items-center gap-2 whitespace-nowrap">
            <span>ğŸš€ {{ t('btn_gen_meta') }}</span>
        </button>

        <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>

        <button onclick="saveAllMetadata()" id="saveAllBtn"
            class="btn-secondary py-1.5 px-3 text-xs font-medium rounded-md flex items-center gap-1 whitespace-nowrap">
            <span>ğŸ’¾ {{ t('btn_save') }}</span>
        </button>
    </div>

    <!-- 2. ê²°ê³¼ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ (Grid Layout) -->
    <div id="resultSection" class="hidden grid grid-cols-12 gap-3 flex-1 min-h-0">
        <!-- ì™¼ìª½ íŒ¨ë„: ì¶”ì²œ ì œëª© (Col-5) -->
        <div
            class="col-span-12 md:col-span-5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 flex flex-col overflow-hidden shadow-sm">
            <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2 flex items-center gap-2">
                ğŸ·ï¸ {{ t('recommend_titles') }} <span class="text-xs font-normal text-gray-500">{{ t('copy_hint')
                    }}</span>
            </h3>
            <div id="titlesList" class="overflow-y-auto flex-1 space-y-1 pr-1 custom-scrollbar">
                <!-- ì œëª© ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ì„¤ëª… & íƒœê·¸ (Col-7) -->
        <div class="col-span-12 md:col-span-7 flex flex-col gap-3 min-h-0">
            <!-- ì„¤ëª… ì˜ì—­ -->
            <div
                class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 flex-1 flex flex-col shadow-sm min-h-0">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-bold text-gray-800 dark:text-white">ğŸ“„ {{ t('video_desc_title') }}</h3>
                    <button onclick="copyDescription()"
                        class="text-xs text-gray-500 hover:text-primary transition-colors flex items-center gap-1">
                        ğŸ“‹ {{ t('btn_copy') }}
                    </button>
                </div>
                <textarea id="descriptionText"
                    class="flex-1 w-full text-xs p-3 border border-gray-200 dark:border-gray-700 rounded-md resize-none focus:ring-primary focus:border-primary bg-gray-50 dark:bg-gray-900 dark:text-gray-300 leading-relaxed custom-scrollbar"></textarea>
            </div>

            <!-- íƒœê·¸ & í•´ì‹œíƒœê·¸ ì˜ì—­ (Grid) -->
            <div class="grid grid-cols-2 gap-3 shrink-0 h-32">
                <!-- íƒœê·¸ -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 flex flex-col shadow-sm">
                    <div class="flex items-center justify-between mb-1">
                        <h3 class="text-xs font-bold text-gray-800 dark:text-white">#ï¸âƒ£ {{ t('status_image') }}</h3>
                        <button onclick="copyTags()" class="text-[10px] text-gray-500 hover:text-primary">ğŸ“‹</button>
                    </div>
                    <textarea id="tagsText"
                        class="flex-1 w-full text-xs p-2 border border-gray-200 dark:border-gray-700 rounded resize-none focus:ring-primary focus:border-primary bg-gray-50 dark:bg-gray-900 dark:text-gray-300 custom-scrollbar"
                        placeholder="{{ t('placeholder_tags') }}"></textarea>
                </div>
                <!-- í•´ì‹œíƒœê·¸ -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 flex flex-col shadow-sm">
                    <div class="flex items-center justify-between mb-1">
                        <h3 class="text-xs font-bold text-gray-800 dark:text-white"># {{ t('nav_shorts') }}</h3>
                        <button onclick="copyHashtags()"
                            class="text-[10px] text-gray-500 hover:text-primary">ğŸ“‹</button>
                    </div>
                    <textarea id="hashtagsText"
                        class="flex-1 w-full text-xs p-2 border border-gray-200 dark:border-gray-700 rounded resize-none focus:ring-primary focus:border-primary bg-gray-50 dark:bg-gray-900 text-blue-500 font-medium custom-scrollbar"
                        placeholder="{{ t('placeholder_hashtags') }}"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ˆê¸° ì•ˆë‚´ í™”ë©´ -->
    <div id="initialState"
        class="flex-1 flex flex-col items-center justify-center text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-2 border-dashed border-gray-200 dark:border-gray-700">
        <div class="text-4xl mb-3">ğŸ“</div>
        <p class="text-sm">{{ t('initial_meta_desc') | safe }}</p>
    </div>
</div>

<style>
    /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #e5e7eb;
        border-radius: 20px;
    }

    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #4b5563;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let projectId = Utils.storage.get('currentProjectId');
    if (projectId && typeof projectId === 'string') projectId = parseInt(projectId);

    let metaData = null;

    document.addEventListener('DOMContentLoaded', () => {
        if (projectId) {
            loadMetadata();
        } else {
            Utils.showToast("{{ t('toast_select_project_first') }}", 'warning');
        }
    });

    async function loadMetadata() {
        try {
            const projectRes = await API.project.get(projectId);
            if (projectRes && (projectRes.topic || projectRes.name)) {
                const keywordInput = document.getElementById('targetKeyword');
                if (keywordInput && !keywordInput.value) {
                    keywordInput.value = projectRes.topic || projectRes.name;
                }
            }

            // [NEW] Load Title from Settings
            try {
                const fullRes = await fetch(`/api/projects/${projectId}/full`);
                if (fullRes.ok) {
                    const fullData = await fullRes.json();
                    const title = fullData.settings?.title;
                    if (title) {
                        const disp = document.getElementById('projectTitleDisplay');
                        if (disp) {
                            disp.innerText = title;
                            disp.title = title;
                            // ë¶€ëª¨ divì˜ hidden í´ë˜ìŠ¤ ì œê±° (í˜¹ì‹œ ëª¨ë°”ì¼ì´ ì•„ë‹ˆê³  ë‚´ìš©ì´ ìˆì„ ë•Œ ë³´ì¥)
                            disp.parentElement.classList.remove('hidden');
                            disp.parentElement.classList.add('flex');
                        }
                    }
                }
            } catch (e) { console.error("Title load failed", e); }

            const res = await fetch(`/api/projects/${projectId}/metadata`);
            const data = await res.json();
            if (data && data.titles && data.titles.length > 0) {
                metaData = data;
                renderResults();
                showResultSection();
            }
        } catch (e) {
            console.error('ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
        }
    }

    function showResultSection() {
        document.getElementById('resultSection').classList.remove('hidden');
        document.getElementById('initialState').classList.add('hidden');
    }

    async function saveAllMetadata() {
        if (!projectId || !metaData) {
            Utils.showToast("{{ t('toast_no_data_to_save') }}", 'warning');
            return;
        }

        const btn = document.getElementById('saveAllBtn');
        const originalText = btn.innerHTML;
        Utils.setLoading(btn, true, "{{ t('status_saving') }}");

        try {
            metaData.description = document.getElementById('descriptionText').value;
            const tagsRaw = document.getElementById('tagsText').value;
            metaData.tags = tagsRaw.split(',').map(t => t.trim()).filter(t => t !== "");
            const hashtagsRaw = document.getElementById('hashtagsText').value;
            metaData.hashtags = hashtagsRaw.split(/\s+/).map(h => h.trim()).filter(h => h !== "");

            await fetch(`/api/projects/${projectId}/metadata`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(metaData)
            });
            Utils.showToast("{{ t('toast_save_success') }}", 'success');
        } catch (e) {
            console.error('ì €ì¥ ì‹¤íŒ¨', e);
            Utils.showToast("{{ t('toast_save_fail') }}", 'error');
        } finally {
            Utils.setLoading(btn, false);
            btn.innerHTML = originalText;
        }
    }

    async function saveMetadata() {
        if (!projectId || !metaData) return;
        try {
            await fetch(`/api/projects/${projectId}/metadata`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(metaData)
            });
        } catch (e) { console.error('ìë™ ì €ì¥ ì‹¤íŒ¨', e); }
    }

    async function generateMeta() {
        if (!projectId) {
            Utils.showToast("{{ t('toast_select_project_first') }}", 'warning');
            return;
        }

        let scriptData = null;
        try {
            const res = await fetch(`/api/projects/${projectId}/full`);
            if (res.ok) {
                const fullData = await res.json();
                if (fullData.script && fullData.script.full_script) {
                    scriptData = { script: fullData.script.full_script };
                }
            }
        } catch (e) { console.error("ëŒ€ë³¸ ë¡œë“œ ì‹¤íŒ¨", e); }

        if (!scriptData) scriptData = Utils.storage.get('fullScript');

        const styleInput = document.getElementById('titleStyle');
        const style = styleInput ? styleInput.value : 'basic';
        const keyword = document.getElementById('targetKeyword').value;
        const btn = document.getElementById('generateBtn');

        Utils.setLoading(btn, true, "{{ t('status_generating') }}");

        let sysPrompt = `ìœ íŠœë¸Œ SEO ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ëŒ€ë³¸ì— ë§ëŠ” ë©”íƒ€ë°ì´í„°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.`;
        if (style === 'sleep') {
            sysPrompt += `\níŠ¹íˆ 'ìˆ˜ë©´ ìœ ë„', 'ASMR', 'íë§', 'ì ì˜ ë•Œ ë“£ëŠ”' ì»¨ì…‰ì„ ê°•ì¡°í•˜ì—¬, í¸ì•ˆí•¨ì„ ëŠë¼ê³  í´ë¦­í•˜ê²Œ ë§Œë“œëŠ” ì œëª©ì„ ë§Œë“œì„¸ìš”. ì•ˆì •ê°ì„ ì£¼ëŠ” ë‹¨ì–´ ì‚¬ìš©.`;
        }

        const prompt = `${sysPrompt}
        
[ëŒ€ë³¸ ìš”ì•½]
${scriptData?.script?.substring(0, 1000) || 'ì¼ë°˜ ìœ íŠœë¸Œ ì˜ìƒ'}

[ì œëª© ìŠ¤íƒ€ì¼]
${style}

[íƒ€ê²Ÿ í‚¤ì›Œë“œ]
${keyword || 'ì—†ìŒ'}

JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:
{
    "titles": ["ì œëª©1 (50ì ì´ë‚´)", "ì œëª©2", "...", "ì œëª©5"],
    "description": "ì˜ìƒ ì„¤ëª… (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨, 500ì ë‚´ì™¸)",
    "tags": ["íƒœê·¸1", "íƒœê·¸2", ...],
    "hashtags": ["#í•´ì‹œíƒœê·¸1", "#í•´ì‹œíƒœê·¸2", ...]
}
JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”.`;

        try {
            const result = await API.gemini.generate(prompt, { temperature: 0.7 });

            if (result.status === 'ok') {
                const jsonMatch = result.text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    metaData = JSON.parse(jsonMatch[0]);
                    renderResults();
                    showResultSection();
                    await saveMetadata();
                    Utils.showToast("{{ t('status_done') }}", 'success');
                }
            }
        } catch (error) {
            Utils.showToast("{{ t('status_error') }}", 'error');
            console.error(error);
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderResults() {
        if (!metaData) return;

        document.getElementById('titlesList').innerHTML = (metaData.titles || []).map((title, i) => `
            <div class="group flex items-center justify-between p-2.5 bg-gray-50 dark:bg-gray-700/50 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded border border-transparent hover:border-blue-200 dark:hover:border-blue-800 transition-all cursor-pointer" onclick="copyTitle(${i})">
                <span class="text-xs text-gray-700 dark:text-gray-200 group-hover:text-blue-700 dark:group-hover:text-blue-300 font-medium">${title}</span>
                <span class="opacity-0 group-hover:opacity-100 text-[10px] text-blue-500 bg-white dark:bg-gray-800 px-1.5 py-0.5 rounded border border-blue-100 dark:border-blue-900">{{ t('btn_copy') }}</span>
            </div>
        `).join('');

        document.getElementById('descriptionText').value = metaData.description || '';
        document.getElementById('tagsText').value = (metaData.tags || []).join(', ');
        document.getElementById('hashtagsText').value = (metaData.hashtags || []).join(' ');
    }

    // Input Listeners
    document.getElementById('descriptionText').addEventListener('input', (e) => {
        if (metaData) metaData.description = e.target.value;
    });
    document.getElementById('tagsText').addEventListener('input', (e) => {
        if (metaData) metaData.tags = e.target.value.split(',').map(t => t.trim()).filter(t => t !== "");
    });
    document.getElementById('hashtagsText').addEventListener('input', (e) => {
        if (metaData) metaData.hashtags = e.target.value.split(/\s+/).map(h => h.trim()).filter(h => h !== "");
    });

    // Copy Functions
    function copyTitle(index) {
        Utils.copyToClipboard(metaData.titles[index]);
        Utils.showToast("{{ t('toast_title_copied') }}", 'success');
    }
    function copyDescription() {
        Utils.copyToClipboard(document.getElementById('descriptionText').value);
        Utils.showToast("{{ t('toast_desc_copied') }}", 'success');
    }
    function copyTags() {
        Utils.copyToClipboard(document.getElementById('tagsText').value);
        Utils.showToast("{{ t('toast_tags_copied') }}", 'success');
    }
    function copyHashtags() {
        Utils.copyToClipboard(document.getElementById('hashtagsText').value);
        Utils.showToast("{{ t('toast_hashtags_copied') }}", 'success');
    }
</script>
{% endblock %}