{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ–¼ï¸</span>
        <div>
            <h1>ì´ë¯¸ì§€ ìƒì„±</h1>
            <p>ëŒ€ë³¸ ê¸°ë°˜ AI ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ ì´ë¯¸ì§€ ì„¤ì •</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ìŠ¤íƒ€ì¼</label>
            <select id="imageStyle" class="input-field">
                <option value="realistic">ì‚¬ì‹¤ì ì¸ (Realistic)</option>
                <option value="anime">ì• ë‹ˆë©”ì´ì…˜</option>
                <option value="cinematic">ì‹œë„¤ë§ˆí‹±</option>
                <option value="minimal">ë¯¸ë‹ˆë©€</option>
                <option value="3d">3D ë Œë”</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì´ë¯¸ì§€ ê°œìˆ˜</label>
            <select id="imageCount" class="input-field">
                <option value="3">3ê°œ</option>
                <option value="5" selected>5ê°œ</option>
                <option value="10">10ê°œ</option>
            </select>
        </div>
    </div>
</div>

<button onclick="generatePrompts()" id="generateBtn"
    class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg mb-6">
    <span>ğŸ–¼ï¸</span>
    <span>ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìƒì„±</span>
</button>

<div id="resultSection" class="hidden">
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800 dark:text-white">ğŸ¨ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸</h3>
            <button onclick="copyAllPrompts()" class="btn-secondary text-sm">ğŸ“‹ ì „ì²´ ë³µì‚¬</button>
        </div>

        <!-- ìë™ ìƒì„± ë²„íŠ¼ ì¶”ê°€ -->
        <button onclick="generateAllImages()" id="autoGenBtn"
            class="w-full btn-primary py-3 mb-6 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold rounded-lg shadow-md transition-all flex items-center justify-center gap-2">
            <span>ğŸš€</span>
            <span>ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ë¡œ ì´ë¯¸ì§€ ë§Œë“¤ê¸° (ìë™)</span>
        </button>

        <div id="promptsList" class="space-y-4"></div>

        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <h4 class="font-medium text-gray-800 dark:text-white mb-3">ğŸ”— ì™¸ë¶€ ìƒì„± ì„œë¹„ìŠ¤ (ì˜µì…˜)</h4>
            <div class="flex flex-wrap gap-2">
                <a href="https://midjourney.com" target="_blank" class="btn-secondary text-sm">Midjourney</a>
                <a href="https://labs.openai.com" target="_blank" class="btn-secondary text-sm">DALL-E</a>
                <a href="https://leonardo.ai" target="_blank" class="btn-secondary text-sm">Leonardo AI</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let prompts = [];

    async function generatePrompts() {
        const scriptData = Utils.storage.get('fullScript');
        if (!scriptData?.script) {
            Utils.showToast('ë¨¼ì € ëŒ€ë³¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const style = document.getElementById('imageStyle').value;
        const count = document.getElementById('imageCount').value;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        try {
            const result = await API.image.generatePrompts(scriptData.script, style, parseInt(count));

            if (result.prompts) {
                prompts = result.prompts;
                renderPrompts();
                document.getElementById('resultSection').classList.remove('hidden');

                Utils.storage.set('imagePrompts', prompts);
            }
        } catch (error) {
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderPrompts() {
        const container = document.getElementById('promptsList');
        container.innerHTML = prompts.map((p, i) => `
            <div id="prompt-card-${i}" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-gray-800 dark:text-white">ì¥ë©´ ${i + 1}: ${p.scene}</span>
                    <button onclick="copyPrompt(${i})" class="btn-secondary text-xs">ë³µì‚¬</button>
                </div>
                <code class="block bg-gray-900 text-green-400 p-3 rounded text-sm overflow-x-auto">
                    ${p.prompt} ${p.style_tags || ''}
                </code>
            </div>
        `).join('');
    }

    function copyPrompt(index) {
        const p = prompts[index];
        Utils.copyToClipboard(`${p.prompt} ${p.style_tags || ''}`);
        Utils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function copyAllPrompts() {
        const text = prompts.map((p, i) => `[ì¥ë©´ ${i + 1}] ${p.scene}\n${p.prompt} ${p.style_tags || ''}`).join('\n\n');
        Utils.copyToClipboard(text);
        Utils.showToast('ì „ì²´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    async function generateAllImages() {
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
        }

        if (prompts.length === 0) {
            Utils.showToast('ë¨¼ì € í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const btn = document.getElementById('autoGenBtn');
        Utils.setLoading(btn, true, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...');

        try {
            for (let i = 0; i < prompts.length; i++) {
                const p = prompts[i];
                const card = document.getElementById(`prompt-card-${i}`);
                if (!card) continue;

                // ìƒíƒœ í‘œì‹œ
                const statusDiv = document.createElement('div');
                statusDiv.className = 'mt-2 text-sm text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded';
                statusDiv.id = `status-${i}`;
                statusDiv.textContent = 'â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘... (10~20ì´ˆ ì†Œìš”)';
                card.appendChild(statusDiv);

                // API í˜¸ì¶œ
                const fullPrompt = `${p.prompt} ${p.style_tags || ''}`;
                const result = await API.image.generate(fullPrompt, projectId, i + 1, document.getElementById('imageStyle').value);

                if (result.status === 'ok') {
                    // ì´ë¯¸ì§€ í‘œì‹œ
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mt-4 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600';
                    imgDiv.innerHTML = `<img src="${result.image_url}" class="w-full h-auto" alt="Scene ${i + 1}">`;
                    card.appendChild(imgDiv);

                    statusDiv.textContent = 'âœ… ìƒì„± ì™„ë£Œ';
                    statusDiv.className = 'mt-2 text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 p-2 rounded';
                } else {
                    statusDiv.textContent = 'âŒ ìƒì„± ì‹¤íŒ¨: ' + result.error;
                    statusDiv.className = 'mt-2 text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-2 rounded';
                }
            }
            Utils.showToast('ëª¨ë“  ì´ë¯¸ì§€ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } catch (e) {
            console.error(e);
            Utils.showToast('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    // í”„ë¡œì íŠ¸ ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data && data.image_prompts && data.image_prompts.length > 0) {
            prompts = data.image_prompts;
            renderPrompts();
            document.getElementById('resultSection').classList.remove('hidden');
        }
    });

    // ì´ˆê¸° ë¡œë“œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸ (ë¹ ë¥¸ ë Œë”ë§)
    document.addEventListener('DOMContentLoaded', () => {
        const savedPrompts = Utils.storage.get('imagePrompts');
        if (savedPrompts && savedPrompts.length > 0) {
            prompts = savedPrompts;
            renderPrompts();
            document.getElementById('resultSection').classList.remove('hidden');
        }
    });
</script>
{% endblock %}