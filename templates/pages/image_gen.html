{% extends "base.html" %}

{% block content %}


<div class="card mb-6">
    <div class="flex flex-wrap items-center gap-6 mb-6">
        <h3 class="font-bold text-gray-800 dark:text-white shrink-0 flex items-center gap-2">
            <span>âš™ï¸ ì´ë¯¸ì§€ ì„¤ì •</span>
            <span id="scriptStatusBadge"
                class="text-[10px] items-center gap-1 px-2 py-0.5 rounded-full bg-gray-100 text-gray-400 font-normal hidden md:flex">
                <span>ğŸ”„</span> ëŒ€ë³¸ í™•ì¸ ì¤‘...
            </span>
        </h3>

        <div class="flex flex-wrap items-center gap-4">
            <!-- Image Options -->
            <div id="imageOptions" class="flex flex-wrap items-center gap-4">
                <!-- Aspect Ratio -->
                <div class="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg shadow-inner">
                    <label class="cursor-pointer" id="ratio-16-9">
                        <input type="radio" name="aspectRatio" value="16:9" checked class="peer sr-only">
                        <div
                            class="px-4 py-1.5 rounded-md text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-gray-600 dark:text-gray-300 transition-all">
                            16:9</div>
                    </label>
                    <label class="cursor-pointer" id="ratio-1-1">
                        <input type="radio" name="aspectRatio" value="1:1" class="peer sr-only">
                        <div
                            class="px-4 py-1.5 rounded-md text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-gray-600 dark:text-gray-300 transition-all">
                            1:1</div>
                    </label>
                    <label class="cursor-pointer" id="ratio-9-16">
                        <input type="radio" name="aspectRatio" value="9:16" class="peer sr-only">
                        <div
                            class="px-4 py-1.5 rounded-md text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-gray-600 dark:text-gray-300 transition-all">
                            9:16</div>
                    </label>
                    <label class="cursor-pointer" id="ratio-3-4">
                        <input type="radio" name="aspectRatio" value="3:4" class="peer sr-only">
                        <div
                            class="px-4 py-1.5 rounded-md text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-gray-600 dark:text-gray-300 transition-all">
                            3:4</div>
                    </label>
                </div>

                <!-- Generate Prompt Button -->
                <button onclick="generatePrompts()" id="generateBtn"
                    class="btn-primary py-2 px-4 flex items-center justify-center gap-2 text-xs font-bold shadow-md hover:scale-105 transition-transform bg-gradient-to-r from-blue-600 to-indigo-600">
                    <span>ğŸª„</span>
                    <span>í”„ë¡¬í”„íŠ¸ ìƒì„±</span>
                </button>

                <!-- Auto Image Generate Button -->
                <button onclick="generateAllImages()" id="autoGenBtn"
                    class="btn-primary py-2 px-4 flex items-center justify-center gap-2 text-xs font-bold shadow-md hover:scale-105 transition-transform bg-gradient-to-r from-purple-600 to-indigo-600 opacity-50 cursor-not-allowed"
                    disabled>
                    <span>ğŸš€</span>
                    <span>ì´ë¯¸ì§€ ìë™ ìƒì„±</span>
                </button>
            </div>
        </div>

        <!-- Character Consistency Input -->
        <div class="w-full mt-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Left: Controls -->
                <div class="flex-1">
                    <label class="block text-sm font-bold text-gray-800 dark:text-gray-200 mb-3">ğŸ‘¤ ì£¼ì¸ê³µ/ìºë¦­í„° ì¼ê´€ì„± ìœ ì§€
                        (Reference)</label>

                    <div class="flex flex-col gap-3">
                        <div class="flex items-center flex-wrap gap-4">
                            <!-- Upload Button -->
                            <div class="flex items-center gap-2">
                                <button onclick="document.getElementById('charUploadInput').click()"
                                    class="btn-secondary text-xs py-2 px-3 flex items-center gap-1">
                                    <span>ğŸ“‚</span> ì´ë¯¸ì§€ ì—…ë¡œë“œ
                                </button>
                                <input type="file" id="charUploadInput" class="hidden" accept="image/*"
                                    onchange="previewCharImage(this)">
                            </div>

                            <span class="text-xs text-gray-400">OR</span>

                            <!-- Use Thumbnail Checkbox -->
                            <label
                                class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <input type="checkbox" id="useThumbnailCheck"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <span class="text-xs font-medium text-gray-700 dark:text-gray-300">í˜„ì¬ ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì£¼ì¸ê³µìœ¼ë¡œ
                                    ì‚¬ìš©</span>
                            </label>
                        </div>

                        <!-- Preview (Upload) -->
                        <div id="charPreviewArea"
                            class="hidden items-center gap-3 bg-white dark:bg-gray-900 p-2 rounded border border-gray-200 dark:border-gray-700 w-fit">
                            <img id="charPreviewImg" src=""
                                class="w-10 h-10 rounded object-cover border border-gray-300">
                            <span class="text-xs text-gray-500" id="charPreviewName">ì´ë¯¸ì§€ ì„ íƒë¨</span>
                            <button onclick="clearCharImage()"
                                class="text-red-500 hover:text-red-700 text-xs ml-2">âŒ</button>
                        </div>

                        <!-- Analyze Button -->
                        <div class="flex items-center gap-2 mt-1">
                            <button onclick="analyzeAndSetConsistency()" id="analyzeBtn"
                                class="btn-primary flex-1 md:flex-none text-xs py-2 px-4 bg-indigo-600 hover:bg-indigo-700">
                                ğŸ¤– ì´ë¯¸ì§€ ë¶„ì„í•˜ì—¬ ì„¤ì •ì— ì ìš©í•˜ê¸° (AI Vision)
                            </button>
                            <p class="text-[10px] text-gray-400">
                                * ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ë¡œ ë³€í™˜ í›„ ì•„ë˜ ì„¤ì •ì— ì¶”ê°€í•©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Right: Thumbnail Reference Display -->
                <div
                    class="w-full md:w-1/3 flex flex-col items-center justify-center border-l border-gray-200 dark:border-gray-600 pl-0 md:pl-6 pt-4 md:pt-0 border-dashed">
                    <label class="block text-xs font-medium text-gray-500 mb-2 w-full text-center">í˜„ì¬ í”„ë¡œì íŠ¸ ì¸ë„¤ì¼
                        (Reference)</label>
                    <div id="thumbnailReferenceContainer"
                        class="relative w-[30%] aspect-video bg-black rounded-lg overflow-hidden shadow-sm group border border-gray-200 dark:border-gray-700">
                        <img id="currentProjectThumbnail" src=""
                            class="w-full h-full object-contain opacity-50 transition-opacity duration-300"
                            alt="Thumbnail" onerror="this.style.opacity=0">
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-xs text-gray-400" id="thumbPlaceholder">ì¸ë„¤ì¼ ì—†ìŒ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full mt-3">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸŒ ìºë¦­í„°/ë°°ê²½ ì¼ê´€ì„± í”„ë¡¬í”„íŠ¸ (Global
                Generated)</label>
            <textarea id="globalPrompt"
                class="input-field w-full text-sm p-3 h-24 bg-yellow-50 dark:bg-yellow-900/10 border-yellow-200 dark:border-yellow-800 focus:border-yellow-400 focus:ring-yellow-400"
                placeholder="ìœ„ 'ì´ë¯¸ì§€ ë¶„ì„' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìºë¦­í„° ì™¸í˜• ë¬˜ì‚¬ê°€ ì—¬ê¸°ì— ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤. ì§ì ‘ ìˆ˜ì •í•˜ì…”ë„ ë©ë‹ˆë‹¤."></textarea>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ìŠ¤íƒ€ì¼ ì„ íƒ</label>
            <input type="hidden" id="imageStyle" value="realistic">

            <!-- [Modified] Grid density increased to reduce thumbnail size (cols-3/6 -> cols-6/12) -->
            <div class="grid grid-cols-6 md:grid-cols-12 gap-3">
                <!-- Realistic -->
                <div class="style-card relative cursor-pointer border-2 border-blue-600 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('realistic', this)" data-value="realistic">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_realistic.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Realistic'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ì‚¬ì‹¤ì ì¸</span>
                        <span class="text-[10px] text-gray-500">Realistic</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm">
                        âœ“</div>
                </div>

                <!-- Webtoon (New) -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('webtoon', this)" data-value="webtoon">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_webtoon.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Webtoon'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ì›¹íˆ°/ë‹¤í¬</span>
                        <span class="text-[10px] text-gray-500">Webtoon</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>

                <!-- Anime -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('anime', this)" data-value="anime">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_anime.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Anime'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ì• ë‹ˆë©”ì´ì…˜</span>
                        <span class="text-[10px] text-gray-500">Anime</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>

                <!-- Cinematic -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('cinematic', this)" data-value="cinematic">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_cinematic.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Cinematic'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ì‹œë„¤ë§ˆí‹±</span>
                        <span class="text-[10px] text-gray-500">Cinematic</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>

                <!-- Minimal -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('minimal', this)" data-value="minimal">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_minimal.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Minimal'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ë¯¸ë‹ˆë©€</span>
                        <span class="text-[10px] text-gray-500">Minimal</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>

                <!-- 3D Render -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('3d', this)" data-value="3d">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_3d.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=3D'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">3D ë Œë”</span>
                        <span class="text-[10px] text-gray-500">3D/Pixar</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="resultSection" class="hidden">
    <div class="card">
        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100 dark:border-gray-700">
            <h3 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <span>ğŸ¨</span> ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
            </h3>
            <button onclick="copyAllPrompts()" class="btn-secondary text-sm px-4">ğŸ“‹ ì „ì²´ ë³µì‚¬</button>
        </div>

        <div id="promptsList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>

        <!-- ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
        <div id="nextStepSection" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-center">
            <h4 class="font-bold text-lg mb-2 text-blue-800 dark:text-blue-300">ğŸ‰ ì´ë¯¸ì§€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
            <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜ìƒ í•©ì„±ì„ ìœ„í•œ ìŒì„±ì„ ìƒì„±í•˜ì„¸ìš”.</p>
            <a href="/video-gen" class="btn-primary inline-flex items-center gap-2">
                <span>ğŸ¥</span> ë™ì˜ìƒ(ì„ íƒì‚¬í•­) í™•ì¸í•˜ëŸ¬ ê°€ê¸°
            </a>
            <div class="mt-2 text-xs text-gray-500">ë˜ëŠ” ë°”ë¡œ <a href="/tts" class="underline hover:text-blue-600">TTS
                    ìƒì„±</a>ìœ¼ë¡œ ì´ë™</div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <h4 class="font-medium text-gray-800 dark:text-white mb-3">ğŸ”— ì™¸ë¶€ ìƒì„± ì„œë¹„ìŠ¤ (ì˜µì…˜)</h4>
            <div class="flex flex-wrap gap-2">
                <a href="https://midjourney.com" target="_blank" class="btn-secondary text-sm">Midjourney</a>
                <a href="https://labs.openai.com" target="_blank" class="btn-secondary text-sm">DALL-E</a>
                <a href="https://leonardo.ai" target="_blank" class="btn-secondary text-sm">Leonardo AI</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
</script>
<script>
    let prompts = [];

    async function generatePrompts() {
        const scriptData = Utils.storage.get('fullScript');
        let script = "";

        if (scriptData && scriptData.script) {
            script = scriptData.script;
        } else {
            // [NEW] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì—†ìœ¼ë©´ DBì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
            const projectId = getCurrentProject();
            if (projectId) {
                try {
                    const result = await API.project.getScript(projectId);
                    if (result && result.full_script) {
                        script = result.full_script;
                        console.log("Script fetched from DB for image prompt generation.");
                    }
                } catch (e) {
                    console.error("Failed to fetch script from DB:", e);
                }
            }
        }

        if (!script) {
            Utils.showToast('ë¨¼ì € ëŒ€ë³¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const styleVal = document.getElementById('imageStyle').value;
        const globalPrompt = document.getElementById('globalPrompt').value;
        const count = 0; // AI ìë™ íŒë‹¨ ê³ ì •

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        try {
            // [Modified] Pass global prompt separately for intelligent application
            const result = await API.image.generatePrompts(script, styleVal, parseInt(count), globalPrompt.trim(), getCurrentProject());

            if (result.prompts) {
                prompts = result.prompts;
                drawPromptsUI(prompts);
                document.getElementById('resultSection').classList.remove('hidden');

                // í™œì„±í™”
                const autoBtn = document.getElementById('autoGenBtn');
                autoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                autoBtn.disabled = false;

                Utils.storage.set('imagePrompts', prompts);
            }
        } catch (error) {
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function drawPromptsUI(data) {
        if (!data) data = prompts;
        console.log("Drawing UI with items:", data.length);

        const container = document.getElementById('promptsList');
        container.innerHTML = data.map((p, i) => `
            <div id="prompt-card-${i}" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 flex flex-col h-full border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold text-sm text-gray-800 dark:text-white truncate" title="${p.scene_title || ''}">#${i + 1} ${p.scene_title ? (p.scene_title.length > 20 ? p.scene_title.substring(0, 20) + '...' : p.scene_title) : ('Scene ' + (i + 1))}</span>
                    <button onclick="copyPrompt(${i})" class="btn-secondary text-[10px] px-2 py-1 shrink-0">ë³µì‚¬</button>
                </div>
                <div class="relative group mt-auto">
                    ${p.image_url ? `
                    <div class="mb-2 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600 aspect-video bg-black relative">
                         <img src="${p.image_url}" class="w-full h-full object-contain" alt="Scene ${i + 1}">
                         <div class="absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1 rounded">Generated</div>
                    </div>` : ''}
                    <div class="h-20 bg-gray-900 rounded overflow-hidden relative">
                         <div class="absolute inset-0 p-2 text-xs text-green-400 font-mono overflow-y-auto" style="scrollbar-width: thin;">
                            ${p.prompt_en || p.prompt_content || ''}
                         </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function copyPrompt(index) {
        const p = prompts[index];
        const content = p.prompt_en || p.prompt_content || '';
        Utils.copyToClipboard(content);
        Utils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function copyAllPrompts() {
        const text = prompts.map((p, i) => `[ì¥ë©´ ${i + 1}] ${p.scene_text || ''}\n${p.prompt_en || p.prompt_content || ''}`).join('\n\n');
        Utils.copyToClipboard(text);
        Utils.showToast('ì „ì²´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    async function generateAllImages() {
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
        }

        if (prompts.length === 0) {
            Utils.showToast('ë¨¼ì € í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const btn = document.getElementById('autoGenBtn');
        Utils.setLoading(btn, true, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...');

        try {
            for (let i = 0; i < prompts.length; i++) {
                const p = prompts[i];
                // Reuse existing checks
                if (p.image_url) continue; // Skip already generated (optional, or force regen?) -> Let's regen if user clicked "Generate All"

                const card = document.getElementById(`prompt-card-${i}`);
                if (!card) continue;

                // ìƒíƒœ í‘œì‹œ
                let statusDiv = card.querySelector('.status-indicator');
                if (!statusDiv) {
                    statusDiv = document.createElement('div');
                    statusDiv.className = 'status-indicator mt-2 text-sm text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded';
                    card.appendChild(statusDiv);
                }
                statusDiv.textContent = 'â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘... (10~20ì´ˆ ì†Œìš”)';

                // API í˜¸ì¶œ
                const fullPrompt = p.prompt_en || p.prompt_content || '';

                // ë¹„ìœ¨ ì„ íƒê°’ ê°€ì ¸ì˜¤ê¸°
                const aspectRatio = document.querySelector('input[name="aspectRatio"]:checked').value || '16:9';

                const result = await API.image.generate(fullPrompt, projectId, i + 1, document.getElementById('imageStyle').value, aspectRatio);

                if (result.status === 'ok') {
                    // ì´ë¯¸ì§€ í‘œì‹œ (Clear previous if exists)
                    const existingImg = card.querySelector('div.aspect-video');
                    if (existingImg) existingImg.remove();

                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mb-2 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600 aspect-video bg-black relative';
                    imgDiv.innerHTML = `<img src="${result.image_url}" class="w-full h-full object-contain" alt="Scene ${i + 1}"><div class="absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1 rounded">Generated</div>`;

                    // Insert before text box (which is inside relative group mt-auto)
                    // Actually promptsUI structure puts image inside "relative group".
                    // Let's just re-render UI for simplicity or append correctly.
                    // For now, reload data to be safe? 
                    // Let's just update data object and re-render this card content or simpler logic.
                    // Simple append for now as in original code.

                    const containerGroup = card.querySelector('.group');
                    if (containerGroup) {
                        containerGroup.insertAdjacentElement('afterbegin', imgDiv); // Insert at top of group
                    }

                    statusDiv.textContent = 'âœ… ìƒì„± ì™„ë£Œ';
                    statusDiv.className = 'status-indicator mt-2 text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 p-2 rounded';

                    // ìŠ¤í† ë¦¬ì§€ì— ê²°ê³¼ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ì‹œ ìœ ì§€)
                    prompts[i].image_url = result.image_url;
                    Utils.storage.set('imagePrompts', prompts);

                    // [NEW] Update Progress Stepper (If at least one image generated)
                    if (window.updateStepStatus) window.updateStepStatus('image', true);
                } else {
                    statusDiv.textContent = 'âŒ ìƒì„± ì‹¤íŒ¨: ' + result.error;
                    statusDiv.className = 'status-indicator mt-2 text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-2 rounded';
                }
            }
            Utils.showToast('ëª¨ë“  ì´ë¯¸ì§€ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

            // ë‹¤ìŒ ë‹¨ê³„ (ìˆ˜ë™ ì´ë™)
            const nextSection = document.getElementById('nextStepSection');
            if (nextSection) {
                nextSection.classList.remove('hidden');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    // ìŠ¤íƒ€ì¼ ì„ íƒ í•¨ìˆ˜
    function selectStyle(style, element) {
        // 1. Update Hidden Input
        document.getElementById('imageStyle').value = style;

        // 2. Visual Update
        // Reset all cards
        document.querySelectorAll('.style-card').forEach(card => {
            card.classList.remove('border-blue-600', 'ring-2', 'ring-blue-100');
            card.classList.add('border-transparent');

            const checkIcon = card.querySelector('.check-icon');
            if (checkIcon) checkIcon.classList.add('opacity-0');
        });

        // Highlight selected
        if (element) {
            element.classList.remove('border-transparent');
            element.classList.add('border-blue-600', 'ring-2', 'ring-blue-100');

            const checkIcon = element.querySelector('.check-icon');
            if (checkIcon) checkIcon.classList.remove('opacity-0');
        }
    }

    // í”„ë¡œì íŠ¸ ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data && data.image_prompts && data.image_prompts.length > 0) {
            prompts = data.image_prompts;
            // Map legacy format if needed
            if (prompts[0] && !prompts[0].scene_title) {
                prompts = prompts.map(p => ({
                    scene_title: p.scene_text || p.prompt_ko || `Scene ${p.scene_number || ''}`,
                    prompt_content: p.prompt_en || '',
                    image_url: p.image_url,
                    style_tags: ''
                }));
            }
            drawPromptsUI(prompts);
            document.getElementById('resultSection').classList.remove('hidden');
        }
    });

    // Script Status Check
    async function checkScriptStatus() {
        const badge = document.getElementById('scriptStatusBadge');
        if (!badge) return;

        let hasScript = false;

        // 1. Check Local Storage
        const localData = Utils.storage.get('fullScript');
        if (localData && localData.script) {
            hasScript = true;
        } else {
            // 2. Check DB
            const projectId = getCurrentProject();
            if (projectId) {
                try {
                    const result = await API.project.getScript(projectId);
                    if (result && result.full_script) {
                        hasScript = true;
                        // Sync to local
                        Utils.storage.set('fullScript', { script: result.full_script });
                    }
                } catch (e) {
                    console.error("Script check failed:", e);
                }
            }
        }

        if (hasScript) {
            badge.className = "text-[10px] items-center gap-1 px-2 py-0.5 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 font-normal hidden md:flex";
            badge.innerHTML = "<span>âœ…</span> ëŒ€ë³¸ ì¤€ë¹„ë¨";
        } else {
            badge.className = "text-[10px] items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-normal hidden md:flex";
            badge.innerHTML = "<span>ğŸš«</span> ëŒ€ë³¸ ì—†ìŒ";
        }
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ DB ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸
    document.addEventListener('DOMContentLoaded', async () => {
        checkScriptStatus();
        loadProjectThumbnail();

        const projectId = getCurrentProject();
        const autoBtn = document.getElementById('autoGenBtn');
        let loadedFromDB = false;

        // 1. DBì—ì„œ í”„ë¡¬í”„íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (ê¶Œì¥)
        if (projectId) {
            try {
                const fullData = await API.project.getFull(projectId);

                // [NEW] Load Persistent Settings
                if (fullData.settings) {
                    if (fullData.settings.character_ref_text) {
                        const gp = document.getElementById('globalPrompt');
                        if (gp) gp.value = fullData.settings.character_ref_text;
                    }
                    if (fullData.settings.character_ref_image_path) {
                        const preview = document.getElementById('charPreviewImg');
                        const placeholder = document.getElementById('charPlaceholder');
                        if (preview && placeholder) {
                            preview.src = fullData.settings.character_ref_image_path;
                            preview.classList.remove('hidden');
                            placeholder.classList.add('hidden');
                        }
                    }
                }

                if (fullData && fullData.image_prompts && fullData.image_prompts.length > 0) {
                    // DB í¬ë§· -> í”„ë¡ íŠ¸ì—”ë“œ í¬ë§· ë§¤í•‘
                    prompts = fullData.image_prompts.map(p => ({
                        scene_title: p.scene_text || p.prompt_ko || `Scene ${p.scene_number || ''}`,
                        prompt_content: p.prompt_en || '',
                        image_url: p.image_url,
                        style_tags: ''
                    }));

                    drawPromptsUI(prompts);
                    document.getElementById('resultSection').classList.remove('hidden');

                    if (autoBtn) {
                        autoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        autoBtn.disabled = false;
                    }
                    loadedFromDB = true;

                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”
                    Utils.storage.set('imagePrompts', prompts);
                    console.log('Loaded prompts from DB:', prompts.length);

                    // [DEBUG REMOVED] Dump first prompt to textarea for diagnosis
                    // const gp = document.getElementById('globalPrompt');
                    // if (gp && prompts.length > 0) {
                    //     gp.value = "[DEBUG DATA]: " + JSON.stringify(prompts[0], null, 2) + "\n\n" + gp.value;
                    // }

                    Utils.showToast(`${prompts.length}ê°œì˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì„œë²„ì—ì„œ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    console.log("No image prompts in DB");
                }
            } catch (e) {
                console.warn("Failed to load prompts from DB:", e);
            }
        }

        // 2. DBì— ì—†ìœ¼ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸ (Fallback)
        if (!loadedFromDB) {
            const savedPrompts = Utils.storage.get('imagePrompts');
            if (savedPrompts && savedPrompts.length > 0) {
                prompts = savedPrompts;
                renderPrompts();
                document.getElementById('resultSection').classList.remove('hidden');

                if (autoBtn) {
                    autoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    autoBtn.disabled = false;
                }
            }
        }
    });

    // ==========================================
    // Character Consistency Logic
    // ==========================================

    function previewCharImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('charPreviewImg').src = e.target.result;
                document.getElementById('charPreviewName').textContent = input.files[0].name;

                const area = document.getElementById('charPreviewArea');
                area.classList.remove('hidden');
                area.classList.add('flex');

                // Clear checkbox if explicit upload
                document.getElementById('useThumbnailCheck').checked = false;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearCharImage() {
        document.getElementById('charUploadInput').value = '';

        const area = document.getElementById('charPreviewArea');
        area.classList.add('hidden');
        area.classList.remove('flex');

        document.getElementById('useThumbnailCheck').checked = true;
    }

    async function analyzeAndSetConsistency() {
        const btn = document.getElementById('analyzeBtn');
        const uploadInput = document.getElementById('charUploadInput');
        const useThumb = document.getElementById('useThumbnailCheck').checked;

        let formData = new FormData();
        let hasSource = false;
        let pid = getCurrentProject(); // Define pid here for broader scope

        if (!pid) return Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'warning');
        formData.append('project_id', pid); // Append project_id here

        if (uploadInput.files && uploadInput.files[0]) {
            formData.append('file', uploadInput.files[0]);
            hasSource = true;
        } else if (useThumb) {
            try {
                // Fetch settings for thumbnail path
                const fullData = await API.project.getFull(pid);
                // Try to find thumbnail path in settings or project root
                const settings = fullData.settings || {};
                const thumb = settings.thumbnail_path || fullData.project?.thumbnail_path;

                if (thumb) {
                    formData.append('image_path', thumb);
                    hasSource = true;
                } else {
                    return Utils.showToast('ì¸ë„¤ì¼ ì´ë¯¸ì§€ê°€ í™•ì¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ì¸ë„¤ì¼ì„ ìƒì„±í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'warning');
                }
            } catch (e) {
                console.error(e);
                return Utils.showToast('í”„ë¡œì íŠ¸ ì •ë³´ ë¡œë“œ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }

        if (!hasSource) {
            return Utils.showToast('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ "ì¸ë„¤ì¼ ì‚¬ìš©"ì„ ì²´í¬í•´ì£¼ì„¸ìš”.', 'warning');
        }

        Utils.setLoading(btn, true, 'ì´ë¯¸ì§€ ë¶„ì„ ì¤‘... (Vision AI)');
        try {
            const result = await API.image.analyzeCharacter(formData);

            if (result.description) {
                const textArea = document.getElementById('globalPrompt');
                const currentVal = textArea.value;

                // Formatted prompt
                const newText = `[Character Visual Reference]: ${result.description}`;

                if (currentVal.includes('[Character Visual Reference]:')) {
                    // Alert user it's appended
                    textArea.value = currentVal + "\n\n" + newText;
                } else {
                    textArea.value = (currentVal ? currentVal + "\n\n" : "") + newText;
                }

                // [NEW] Save to DB
                if (pid) {
                    API.project.updateSetting(pid, 'character_ref_text', textArea.value).then(() => {
                        console.log("Character ref text saved");
                    });

                    if (result.image_url) {
                        API.project.updateSetting(pid, 'character_ref_image_path', result.image_url).then(() => {
                            console.log("Character ref image saved:", result.image_url);
                            // Also update preview if needed (though user just uploaded it)
                            // But maybe cleaner to use server URL? 
                            // We already showed preview via FileReader. No need to reload.
                            const preview = document.getElementById('charPreviewImg');
                            const placeholder = document.getElementById('charPlaceholder');
                            const area = document.getElementById('charPreviewArea');
                            if (preview && placeholder && area) {
                                preview.src = result.image_url;
                                preview.classList.remove('hidden');
                                placeholder.classList.add('hidden');
                                area.classList.remove('hidden');
                                area.classList.add('flex');
                            }
                        });
                    }
                }

                Utils.showToast('âœ… ìºë¦­í„° ì™¸í˜• ë¶„ì„ì´ ì™„ë£Œë˜ì–´ ì„¤ì •ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. (ìë™ ì €ì¥ë¨)', 'success');
            } else {
                const errMsg = result.error || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ';
                Utils.showToast('ë¶„ì„ ì‹¤íŒ¨: ' + errMsg, 'error');
            }
        } catch (e) {
            Utils.showToast('ë¶„ì„ ì¤‘ í†µì‹  ì˜¤ë¥˜: ' + e.message, 'error');
            console.error(e);
        } finally {
            Utils.setLoading(btn, false);
        }
    }
    async function loadProjectThumbnail() {
        const pid = getCurrentProject();
        if (!pid) return;

        try {
            const fullData = await API.project.getFull(pid);
            const thumb = fullData.settings?.thumbnail_url || fullData.project?.thumbnail_url || fullData.project?.thumbnail_path;

            const imgEl = document.getElementById('currentProjectThumbnail');
            const placeholder = document.getElementById('thumbPlaceholder');

            if (imgEl && thumb) {
                // Cache busting
                if (thumb.startsWith('http') || thumb.startsWith('/')) {
                    imgEl.src = `${thumb}?t=${new Date().getTime()}`;
                } else {
                    imgEl.src = thumb;
                }
                imgEl.classList.remove('opacity-50');
                imgEl.style.opacity = 1;
                if (placeholder) placeholder.classList.add('hidden');
            } else {
                console.warn("Thumbnail URL not found in project data:", fullData);
            }
        } catch (e) {
            console.error("Failed to load thumbnail for reference UI", e);
        }
    }

    // [NEW] App Mode Logic
    async function applyAppMode() {
        try {
            const res = await fetch('/api/settings');
            const settings = await res.json();
            const mode = settings.app_mode || 'longform';

            const r169 = document.getElementById('ratio-16-9');
            const r11 = document.getElementById('ratio-1-1');
            const r916 = document.getElementById('ratio-9-16');
            const r34 = document.getElementById('ratio-3-4');

            // Reset all to visible first (or hidden then toggle)
            // But Tailwind 'hidden' class is what we toggle

            if (mode === 'shorts') {
                // Show 9:16, 3:4. Hide 16:9, 1:1
                if (r169) r169.classList.add('hidden');
                if (r11) r11.classList.add('hidden');
                if (r916) r916.classList.remove('hidden');
                if (r34) r34.classList.remove('hidden');

                // Default to 3:4
                const radio34 = document.querySelector('input[value="3:4"]');
                if (radio34) radio34.checked = true;

                // [NEW] Adjust Thumbnail Reference for Vertical
                const thumbRef = document.getElementById('thumbnailReferenceContainer');
                if (thumbRef) {
                    thumbRef.classList.remove('aspect-video');
                    thumbRef.classList.add('aspect-[9/16]');
                }

            } else {
                // Longform
                // Hide 9:16. Show 16:9, 1:1, 3:4(optional? User said 'remove 9:16').
                // Let's hide 9:16 only as requested.
                if (r916) r916.classList.add('hidden');

                if (r169) r169.classList.remove('hidden');
                if (r11) r11.classList.remove('hidden');
                if (r34) r34.classList.remove('hidden');

                // Default to 16:9 if 9:16 was somehow checked or just ensure 16:9 is default
                const radio169 = document.querySelector('input[value="16:9"]');
                if (radio169 && !document.querySelector('input[name="aspectRatio"]:checked')) {
                    radio169.checked = true;
                }
                if (radio169) radio169.checked = true;

                // [NEW] Restor Thumbnail Reference to 16:9
                const thumbRef = document.getElementById('thumbnailReferenceContainer');
                if (thumbRef) {
                    thumbRef.classList.remove('aspect-[9/16]');
                    thumbRef.classList.add('aspect-video');
                }
            }

            console.log("App Mode Applied:", mode);

        } catch (e) {
            console.error("Failed to apply app mode:", e);
        }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        applyAppMode();
    });
</script>
{% endblock %}