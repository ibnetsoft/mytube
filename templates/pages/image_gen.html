{% extends "base.html" %}

{% block content %}


<div class="card mb-6">
    <div class="flex flex-wrap items-center gap-6 mb-6">
        <h3 class="font-bold text-gray-800 dark:text-white shrink-0 flex items-center gap-2">
            <span>âš™ï¸ ì´ë¯¸ì§€ ì„¤ì •</span>
            <span id="scriptStatusBadge"
                class="text-[10px] items-center gap-1 px-2 py-0.5 rounded-full bg-gray-100 text-gray-400 font-normal hidden md:flex">
                <span>ğŸ”„</span> ëŒ€ë³¸ í™•ì¸ ì¤‘...
            </span>
        </h3>

        <div class="flex flex-wrap items-center gap-4">
            <!-- Image Options -->
            <div id="imageOptions" class="flex flex-wrap items-center gap-4">
                <!-- Aspect Ratio -->
                <div class="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg shadow-inner">
                    <label class="cursor-pointer">
                        <input type="radio" name="aspectRatio" value="16:9" checked class="peer sr-only">
                        <div
                            class="px-4 py-1.5 rounded-md text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-gray-600 dark:text-gray-300 transition-all">
                            16:9</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="aspectRatio" value="1:1" class="peer sr-only">
                        <div
                            class="px-4 py-1.5 rounded-md text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-gray-600 dark:text-gray-300 transition-all">
                            1:1</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="aspectRatio" value="9:16" class="peer sr-only">
                        <div
                            class="px-4 py-1.5 rounded-md text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-gray-600 dark:text-gray-300 transition-all">
                            9:16</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="aspectRatio" value="3:4" class="peer sr-only">
                        <div
                            class="px-4 py-1.5 rounded-md text-xs font-bold peer-checked:bg-blue-600 peer-checked:text-white text-gray-600 dark:text-gray-300 transition-all">
                            3:4</div>
                    </label>
                </div>

                <!-- Generate Prompt Button -->
                <button onclick="generatePrompts()" id="generateBtn"
                    class="btn-primary py-2 px-4 flex items-center justify-center gap-2 text-xs font-bold shadow-md hover:scale-105 transition-transform bg-gradient-to-r from-blue-600 to-indigo-600">
                    <span>ğŸª„</span>
                    <span>í”„ë¡¬í”„íŠ¸ ìƒì„±</span>
                </button>

                <!-- Auto Image Generate Button -->
                <button onclick="generateAllImages()" id="autoGenBtn"
                    class="btn-primary py-2 px-4 flex items-center justify-center gap-2 text-xs font-bold shadow-md hover:scale-105 transition-transform bg-gradient-to-r from-purple-600 to-indigo-600 opacity-50 cursor-not-allowed"
                    disabled>
                    <span>ğŸš€</span>
                    <span>ì´ë¯¸ì§€ ìë™ ìƒì„±</span>
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ìŠ¤íƒ€ì¼ ì„ íƒ</label>
            <input type="hidden" id="imageStyle" value="realistic">

            <!-- [Modified] Grid density increased to reduce thumbnail size (cols-3/6 -> cols-6/12) -->
            <div class="grid grid-cols-6 md:grid-cols-12 gap-3">
                <!-- Realistic -->
                <div class="style-card relative cursor-pointer border-2 border-blue-600 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('realistic', this)" data-value="realistic">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_realistic.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Realistic'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ì‚¬ì‹¤ì ì¸</span>
                        <span class="text-[10px] text-gray-500">Realistic</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm">
                        âœ“</div>
                </div>

                <!-- Webtoon (New) -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('webtoon', this)" data-value="webtoon">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_webtoon.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Webtoon'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ì›¹íˆ°/ë‹¤í¬</span>
                        <span class="text-[10px] text-gray-500">Webtoon</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>

                <!-- Anime -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('anime', this)" data-value="anime">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_anime.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Anime'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ì• ë‹ˆë©”ì´ì…˜</span>
                        <span class="text-[10px] text-gray-500">Anime</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>

                <!-- Cinematic -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('cinematic', this)" data-value="cinematic">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_cinematic.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Cinematic'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ì‹œë„¤ë§ˆí‹±</span>
                        <span class="text-[10px] text-gray-500">Cinematic</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>

                <!-- Minimal -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('minimal', this)" data-value="minimal">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_minimal.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=Minimal'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">ë¯¸ë‹ˆë©€</span>
                        <span class="text-[10px] text-gray-500">Minimal</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>

                <!-- 3D Render -->
                <div class="style-card relative cursor-pointer border-2 border-transparent hover:border-blue-300 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all"
                    onclick="selectStyle('3d', this)" data-value="3d">
                    <div class="aspect-square bg-gray-200 overflow-hidden">
                        <img src="/static/img/styles/style_3d.png"
                            class="w-full h-full object-cover transition-transform duration-500 hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/150?text=3D'">
                    </div>
                    <div class="p-2 text-center bg-white dark:bg-gray-800">
                        <span class="text-xs font-bold block">3D ë Œë”</span>
                        <span class="text-[10px] text-gray-500">3D/Pixar</span>
                    </div>
                    <div
                        class="check-icon absolute top-2 right-2 w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs shadow-sm opacity-0">
                        âœ“</div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="resultSection" class="hidden">
    <div class="card">
        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100 dark:border-gray-700">
            <h3 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <span>ğŸ¨</span> ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
            </h3>
            <button onclick="copyAllPrompts()" class="btn-secondary text-sm px-4">ğŸ“‹ ì „ì²´ ë³µì‚¬</button>
        </div>

        <div id="promptsList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>

        <!-- ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
        <div id="nextStepSection" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-center">
            <h4 class="font-bold text-lg mb-2 text-blue-800 dark:text-blue-300">ğŸ‰ ì´ë¯¸ì§€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
            <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜ìƒ í•©ì„±ì„ ìœ„í•œ ìŒì„±ì„ ìƒì„±í•˜ì„¸ìš”.</p>
            <a href="/video-gen" class="btn-primary inline-flex items-center gap-2">
                <span>ğŸ¥</span> ë™ì˜ìƒ(ì„ íƒì‚¬í•­) í™•ì¸í•˜ëŸ¬ ê°€ê¸°
            </a>
            <div class="mt-2 text-xs text-gray-500">ë˜ëŠ” ë°”ë¡œ <a href="/tts" class="underline hover:text-blue-600">TTS
                    ìƒì„±</a>ìœ¼ë¡œ ì´ë™</div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <h4 class="font-medium text-gray-800 dark:text-white mb-3">ğŸ”— ì™¸ë¶€ ìƒì„± ì„œë¹„ìŠ¤ (ì˜µì…˜)</h4>
            <div class="flex flex-wrap gap-2">
                <a href="https://midjourney.com" target="_blank" class="btn-secondary text-sm">Midjourney</a>
                <a href="https://labs.openai.com" target="_blank" class="btn-secondary text-sm">DALL-E</a>
                <a href="https://leonardo.ai" target="_blank" class="btn-secondary text-sm">Leonardo AI</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
</script>
<script>
    let prompts = [];

    async function generatePrompts() {
        const scriptData = Utils.storage.get('fullScript');
        let script = "";

        if (scriptData && scriptData.script) {
            script = scriptData.script;
        } else {
            // [NEW] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì—†ìœ¼ë©´ DBì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
            const projectId = getCurrentProject();
            if (projectId) {
                try {
                    const result = await API.project.getScript(projectId);
                    if (result && result.full_script) {
                        script = result.full_script;
                        console.log("Script fetched from DB for image prompt generation.");
                    }
                } catch (e) {
                    console.error("Failed to fetch script from DB:", e);
                }
            }
        }

        if (!script) {
            Utils.showToast('ë¨¼ì € ëŒ€ë³¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const style = document.getElementById('imageStyle').value;
        const count = 0; // AI ìë™ íŒë‹¨ ê³ ì •

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        try {
            const result = await API.image.generatePrompts(script, style, parseInt(count));

            if (result.prompts) {
                prompts = result.prompts;
                renderPrompts();
                document.getElementById('resultSection').classList.remove('hidden');

                // í™œì„±í™”
                const autoBtn = document.getElementById('autoGenBtn');
                autoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                autoBtn.disabled = false;

                Utils.storage.set('imagePrompts', prompts);
            }
        } catch (error) {
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderPrompts() {
        const container = document.getElementById('promptsList');
        container.innerHTML = prompts.map((p, i) => `
            <div id="prompt-card-${i}" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 flex flex-col h-full border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-bold text-sm text-gray-800 dark:text-white truncate">#${i + 1} ${p.scene}</span>
                    <button onclick="copyPrompt(${i})" class="btn-secondary text-[10px] px-2 py-1 shrink-0">ë³µì‚¬</button>
                </div>
                <div class="relative group mt-auto">
                    ${p.image_url ? `
                    <div class="mb-2 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600 aspect-video bg-black relative">
                         <img src="${p.image_url}" class="w-full h-full object-contain" alt="Scene ${i + 1}">
                         <div class="absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1 rounded">Generated</div>
                    </div>` : ''}
                    <div class="h-20 bg-gray-900 rounded overflow-hidden relative">
                         <div class="absolute inset-0 p-2 text-xs text-green-400 font-mono overflow-y-auto" style="scrollbar-width: thin;">
                            ${p.prompt} ${p.style_tags || ''}
                         </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function copyPrompt(index) {
        const p = prompts[index];
        Utils.copyToClipboard(`${p.prompt} ${p.style_tags || ''}`);
        Utils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function copyAllPrompts() {
        const text = prompts.map((p, i) => `[ì¥ë©´ ${i + 1}] ${p.scene}\n${p.prompt} ${p.style_tags || ''}`).join('\n\n');
        Utils.copyToClipboard(text);
        Utils.showToast('ì „ì²´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    async function generateAllImages() {
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
        }

        if (prompts.length === 0) {
            Utils.showToast('ë¨¼ì € í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        const btn = document.getElementById('autoGenBtn');
        Utils.setLoading(btn, true, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...');

        try {
            for (let i = 0; i < prompts.length; i++) {
                const p = prompts[i];
                const card = document.getElementById(`prompt-card-${i}`);
                if (!card) continue;

                // ìƒíƒœ í‘œì‹œ
                const statusDiv = document.createElement('div');
                statusDiv.className = 'mt-2 text-sm text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded';
                statusDiv.id = `status-${i}`;
                statusDiv.textContent = 'â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘... (10~20ì´ˆ ì†Œìš”)';
                card.appendChild(statusDiv);

                // API í˜¸ì¶œ
                const fullPrompt = `${p.prompt} ${p.style_tags || ''}`;

                // ë¹„ìœ¨ ì„ íƒê°’ ê°€ì ¸ì˜¤ê¸°
                const aspectRatio = document.querySelector('input[name="aspectRatio"]:checked').value || '16:9';

                const result = await API.image.generate(fullPrompt, projectId, i + 1, document.getElementById('imageStyle').value, aspectRatio);

                if (result.status === 'ok') {
                    // ì´ë¯¸ì§€ í‘œì‹œ
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mt-3 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600 aspect-video bg-black';
                    imgDiv.innerHTML = `<img src="${result.image_url}" class="w-full h-full object-contain" alt="Scene ${i + 1}">`;
                    card.appendChild(imgDiv);

                    statusDiv.textContent = 'âœ… ìƒì„± ì™„ë£Œ';
                    statusDiv.className = 'mt-2 text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 p-2 rounded';

                    // ìŠ¤í† ë¦¬ì§€ì— ê²°ê³¼ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ì‹œ ìœ ì§€)
                    prompts[i].image_url = result.image_url;
                    Utils.storage.set('imagePrompts', prompts);
                } else {
                    statusDiv.textContent = 'âŒ ìƒì„± ì‹¤íŒ¨: ' + result.error;
                    statusDiv.className = 'mt-2 text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-2 rounded';
                }
            }
            Utils.showToast('ëª¨ë“  ì´ë¯¸ì§€ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

            // ë‹¤ìŒ ë‹¨ê³„ (ìˆ˜ë™ ì´ë™)
            const nextSection = document.getElementById('nextStepSection');
            if (nextSection) {
                nextSection.classList.remove('hidden');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    // ìŠ¤íƒ€ì¼ ì„ íƒ í•¨ìˆ˜
    function selectStyle(style, element) {
        // 1. Update Hidden Input
        document.getElementById('imageStyle').value = style;

        // 2. Visual Update
        // Reset all cards
        document.querySelectorAll('.style-card').forEach(card => {
            card.classList.remove('border-blue-600', 'ring-2', 'ring-blue-100');
            card.classList.add('border-transparent');

            const checkIcon = card.querySelector('.check-icon');
            if (checkIcon) checkIcon.classList.add('opacity-0');
        });

        // Highlight selected
        if (element) {
            element.classList.remove('border-transparent');
            element.classList.add('border-blue-600', 'ring-2', 'ring-blue-100');

            const checkIcon = element.querySelector('.check-icon');
            if (checkIcon) checkIcon.classList.remove('opacity-0');
        }
    }

    // í”„ë¡œì íŠ¸ ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data && data.image_prompts && data.image_prompts.length > 0) {
            prompts = data.image_prompts;
            renderPrompts();
            document.getElementById('resultSection').classList.remove('hidden');
        }
    });

    // Script Status Check
    async function checkScriptStatus() {
        const badge = document.getElementById('scriptStatusBadge');
        if (!badge) return;

        let hasScript = false;

        // 1. Check Local Storage
        const localData = Utils.storage.get('fullScript');
        if (localData && localData.script) {
            hasScript = true;
        } else {
            // 2. Check DB
            const projectId = getCurrentProject();
            if (projectId) {
                try {
                    const result = await API.project.getScript(projectId);
                    if (result && result.full_script) {
                        hasScript = true;
                        // Sync to local
                        Utils.storage.set('fullScript', { script: result.full_script });
                    }
                } catch (e) {
                    console.error("Script check failed:", e);
                }
            }
        }

        if (hasScript) {
            badge.className = "text-[10px] items-center gap-1 px-2 py-0.5 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 font-normal hidden md:flex";
            badge.innerHTML = "<span>âœ…</span> ëŒ€ë³¸ ì¤€ë¹„ë¨";
        } else {
            badge.className = "text-[10px] items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-normal hidden md:flex";
            badge.innerHTML = "<span>ğŸš«</span> ëŒ€ë³¸ ì—†ìŒ";
        }
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸ (ë¹ ë¥¸ ë Œë”ë§)
    document.addEventListener('DOMContentLoaded', () => {
        checkScriptStatus(); // [NEW] Check status

        const savedPrompts = Utils.storage.get('imagePrompts');
        const autoBtn = document.getElementById('autoGenBtn');
        if (savedPrompts && savedPrompts.length > 0) {
            prompts = savedPrompts;
            renderPrompts();
            document.getElementById('resultSection').classList.remove('hidden');

            if (autoBtn) {
                autoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                autoBtn.disabled = false;
            }
        }
    });
</script>
{% endblock %}