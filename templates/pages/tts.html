{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ”Š</span>
        <div>
            <h1>TTS ìƒì„±</h1>
            <p>ëŒ€ë³¸ì„ ìŒì„±ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- API ìƒíƒœ -->
<div id="apiStatus" class="card mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <span class="text-xl">ğŸ”‘</span>
            <div>
                <span class="font-medium text-gray-800 dark:text-white">TTS API ìƒíƒœ</span>
                <p id="apiStatusText" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</p>
            </div>
        </div>
        <a href="/settings" class="btn-secondary text-sm">âš™ï¸ ì„¤ì •</a>
    </div>
</div>

<!-- TTS ì„¤ì • -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ ìŒì„± ì„¤ì •</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ìŒì„± ì„ íƒ</label>
            <select id="voiceSelect" class="input-field">
                <option value="">ë¡œë”© ì¤‘...</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì„œë¹„ìŠ¤</label>
            <select id="providerSelect" class="input-field">
                <option value="gemini">Gemini TTS (ë¬´ë£Œ/ê³ í’ˆì§ˆ)</option>
                <option value="openai">OpenAI TTS (ìì—°ìŠ¤ëŸ¬ì›€/ìœ ë£Œ)</option>
                <option value="elevenlabs" selected>ElevenLabs</option>
                <option value="google_cloud">Google Cloud TTS</option>
            </select>
        </div>
    </div>

    <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            ë§í•˜ê¸° ì†ë„ (<span id="speedValue">1.0</span>x)
        </label>
        <div class="flex items-center gap-4">
            <span class="text-xs text-gray-500">ëŠë¦¼</span>
            <input type="range" id="audioSpeed" min="0.5" max="2.0" step="0.1" value="1.0"
                class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
            <span class="text-xs text-gray-500">ë¹ ë¦„</span>
        </div>
    </div>

    <!-- ë©€í‹° ë³´ì´ìŠ¤ ëª¨ë“œ í† ê¸€ -->
    <div class="mt-6 border-t pt-4 dark:border-gray-700">
        <div class="flex items-center justify-between mb-2">
            <div>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="multiVoiceToggle" class="sr-only peer">
                    <div
                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600">
                    </div>
                    <span class="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300">ğŸ™ï¸ ë©€í‹° ë³´ì´ìŠ¤ ëª¨ë“œ (ì¸ë¬¼ë³„ ì„±ìš°
                        ì§€ì •)</span>
                </label>
                <p class="text-xs text-gray-500 mt-1 ml-14">
                    ëŒ€ë³¸ì— <strong>"ì² ìˆ˜: ì•ˆë…•"</strong> ì²˜ëŸ¼ ì´ë¦„ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤. (Gemini TTS ì „ìš©)
                </p>
            </div>
        </div>

        <!-- ì¸ë¬¼ë³„ ì„±ìš° ë§¤í•‘ UI (ë™ì  ìƒì„±) -->
        <div id="voiceMappingSection" class="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
            <h4 class="text-sm font-bold mb-3 text-gray-700 dark:text-gray-300">ğŸ­ ì¸ë¬¼ë³„ ëª©ì†Œë¦¬ ì„¤ì •</h4>
            <div id="characterList" class="space-y-3">
                <!-- ìºë¦­í„°ë³„ ì…€ë ‰íŠ¸ë°•ìŠ¤ê°€ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
                <p class="text-sm text-gray-500">ëŒ€ë³¸ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>
    </div>
</div>

<!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
<div class="card mb-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-gray-800 dark:text-white">ğŸ“ í…ìŠ¤íŠ¸</h3>
        <button onclick="loadScript()" class="btn-secondary text-sm">ğŸ”„ ëŒ€ë³¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    <textarea id="ttsText" class="input-field font-mono" rows="10" placeholder="ìŒì„±ìœ¼ë¡œ ë³€í™˜í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <div class="mt-2 text-sm text-gray-500">
        <span id="charCount">0</span>ì | ì˜ˆìƒ ì‹œê°„: <span id="estTime">0:00</span>
    </div>
</div>

<!-- ìƒì„± ë²„íŠ¼ -->
<button onclick="generateTTS()" id="generateBtn"
    class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg mb-6">
    <span>ğŸ”Š</span>
    <span>ìŒì„± ìƒì„±í•˜ê¸°</span>
</button>

<!-- ê²°ê³¼ -->
<div id="resultSection" class="hidden">
    <div class="card">
        <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸµ ìƒì„±ëœ ìŒì„±</h3>
        <audio id="audioPlayer" controls class="w-full mb-4"></audio>
        <a id="downloadLink" href="#" download class="btn-secondary inline-flex items-center gap-2">
            ğŸ’¾ ë‹¤ìš´ë¡œë“œ
        </a>

        <!-- ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™ -->
        <div
            class="mt-6 p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg text-center border border-purple-100 dark:border-purple-800">
            <h4 class="font-bold text-lg mb-2 text-purple-800 dark:text-purple-300">ğŸ‰ ìŒì„± ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
            <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">ìë§‰ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="flex justify-center gap-4">
                <a href="/subtitle_gen"
                    class="btn-primary inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700">
                    <span>ğŸ“</span> ìë§‰ í¸ì§‘í•˜ëŸ¬ ê°€ê¸°
                </a>
                <a href="/render" class="btn-secondary inline-flex items-center gap-2">
                    <span>â©</span> ë°”ë¡œ ë Œë”ë§ (ê±´ë„ˆë›°ê¸°)
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ë¸Œë¼ìš°ì € TTS (ë¬´ë£Œ) -->

{% endblock %}

{% block scripts %}
<script>
    let speechSynth = window.speechSynthesis;
    let utterance = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await checkAPIStatus();
        await loadVoices();
        loadScript();

        document.getElementById('providerSelect').addEventListener('change', handleProviderChange);

        // ì†ë„ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        const speedSlider = document.getElementById('audioSpeed');
        const speedValue = document.getElementById('speedValue');
        if (speedSlider && speedValue) {
            speedSlider.addEventListener('input', (e) => {
                speedValue.textContent = e.target.value;
            });
        }
    });

    // ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data.script && data.script.full_script) {
            Utils.storage.set('fullScript', { script: data.script.full_script }); // ê°„ë‹¨íˆ ì €ì¥ (í¬ë§· ì£¼ì˜)
            loadScript();
        }
        // 2. TTS ë°ì´í„° ë³µêµ¬
        if (data.tts) {
            // [FIX] DBì—ëŠ” ì ˆëŒ€ ê²½ë¡œ(audio_path)ê°€ ì €ì¥ë˜ì–´ ìˆì–´ URL ì¬êµ¬ì„± í•„ìš”
            if (!data.tts.url && data.tts.audio_path) {
                const path = data.tts.audio_path.replace(/\\/g, '/'); // Normalize slashes
                const outputIndex = path.indexOf('/output/');
                if (outputIndex !== -1) {
                    data.tts.url = path.substring(outputIndex);
                }
            }

            if (data.tts.url) {
                Utils.storage.set('ttsAudio', data.tts);
                document.getElementById('audioPlayer').src = data.tts.url;
                document.getElementById('downloadLink').href = data.tts.url;
                document.getElementById('resultSection').classList.remove('hidden');
            }
        }
    });

    async function checkAPIStatus() {
        const health = await API.health();
        const statusText = document.getElementById('apiStatusText');

        if (health.apis?.elevenlabs) {
            statusText.innerHTML = '<span class="text-green-600">âœ… ElevenLabs ì—°ê²°ë¨</span>';
        } else {
            // APIê°€ ì—†ì–´ë„ GeminiëŠ” ë¬´ë£Œë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë¯€ë¡œ ê¸ì •ì  ë©”ì‹œì§€
            statusText.innerHTML = '<span class="text-blue-600">âœ¨ Gemini TTS ì‚¬ìš© ê°€ëŠ¥</span>';
        }

        if (health.apis?.openai) {
            const currentHtml = statusText.innerHTML;
            statusText.innerHTML = currentHtml + ' | <span class="text-green-600">âœ… OpenAI ì—°ê²°ë¨</span>';

            // [MODIFIED] ElevenLabsë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ë¯€ë¡œ ìë™ ì „í™˜ ë¡œì§ ì œê±°
            // const providerSelect = document.getElementById('providerSelect');
            // if (providerSelect.value !== 'openai') {
            //     providerSelect.value = 'openai';
            // }
        }

        handleProviderChange();
    }

    // ì „ì—­ ë³€ìˆ˜
    let detectedCharacters = new Set();
    let characterVoiceMap = {}; // { "ì² ìˆ˜": "voiceId" }
    let availableVoices = []; // ë¡œë“œëœ ìŒì„± ëª©ë¡ ìºì‹±
    let currentLanguage = 'ko'; // í˜„ì¬ í”„ë¡œì íŠ¸ ì–¸ì–´

    document.getElementById('multiVoiceToggle').addEventListener('change', (e) => {
        const section = document.getElementById('voiceMappingSection');
        if (e.target.checked) {
            section.classList.remove('hidden');
            analyzeScriptForCharacters(); // ì¼œì§ˆ ë•Œ ë¶„ì„

            // ë©€í‹°ë³´ì´ìŠ¤ ì¼œì§€ë©´ Gemini ê°•ì œ ì„ íƒ (ë‹¤ë¥¸ê±´ ë³µì¡í•˜ë¯€ë¡œ)
            const provider = document.getElementById('providerSelect');
            if (provider.value !== 'gemini') {
                provider.value = 'gemini';
                handleProviderChange();
                Utils.showToast('ë©€í‹° ë³´ì´ìŠ¤ëŠ” Gemini TTSì—ì„œ ê°€ì¥ ì˜ ì‘ë™í•©ë‹ˆë‹¤.', 'info');
            }
        } else {
            section.classList.add('hidden');
        }
    });

    document.getElementById('ttsText').addEventListener('input', () => {
        // ë©€í‹° ë³´ì´ìŠ¤ ì¼œì ¸ìˆì„ ë•Œë§Œ ì‹¤ì‹œê°„ ë¶„ì„ (ë„ˆë¬´ ì¦ì€ ì—°ì‚° ë°©ì§€ ìœ„í•´ ë””ë°”ìš´ìŠ¤ í•„ìš”í•˜ì§€ë§Œ ì¼ë‹¨ ê·¸ëƒ¥ í•¨)
        if (document.getElementById('multiVoiceToggle').checked) {
            analyzeScriptForCharacters();
        }
    });

    function analyzeScriptForCharacters() {
        const text = document.getElementById('ttsText').value;
        const lines = text.split('\n');
        const newCharacters = new Set();

        // ì •ê·œì‹: "ì´ë¦„: ëŒ€ì‚¬" í˜•íƒœ (ê³µë°± í¬í•¨ ê°€ëŠ¥, íŠ¹ìˆ˜ë¬¸ì ì¼ë¶€ í—ˆìš©)
        // ì˜ˆ: "ì² ìˆ˜:", "Storyteller:", "[ë‚˜ë ˆì´ì…˜]:" ë“±
        const regex = /^([^\s:\[\]\(\)]+)(?:\(.*\))?[:]/;

        detectDefaultNarrator(newCharacters); // ê¸°ë³¸ ë‚˜ë ˆì´í„° ì¶”ê°€? (ì„ íƒì‚¬í•­)

        lines.forEach(line => {
            const match = line.trim().match(regex);
            if (match && match[1]) {
                newCharacters.add(match[1].trim());
            }
        });

        // ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ UI ê°±ì‹ 
        if (!isSetsEqual(detectedCharacters, newCharacters)) {
            detectedCharacters = newCharacters;
            renderCharacterMapping();
        }
    }

    function isSetsEqual(a, b) {
        if (a.size !== b.size) return false;
        for (let item of a) if (!b.has(item)) return false;
        return true;
    }

    function detectDefaultNarrator(setObj) {
        // ëª…ì‹œì ìœ¼ë¡œ ë‚˜ë ˆì´ì…˜ì´ ì—†ëŠ” ë¼ì¸ì„ ìœ„í•´ 'ê¸°ë³¸(ë‚˜ë ˆì´ì…˜)'ì„ í•­ìƒ ì¶”ê°€í• ì§€ ê²°ì •
        // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ê°ì§€ëœ ê²ƒë§Œ ë³´ì—¬ì£¼ê³ , ê°ì§€ ì•ˆëœê±´ ë©”ì¸ Voice ì„¤ì •ì„ ë”°ë¥´ê²Œ í•¨.
        // í•˜ì§€ë§Œ ì‚¬ìš©ì í¸ì˜ë¥¼ ìœ„í•´ 'ê¸°ë³¸ ëª©ì†Œë¦¬' ì„¤ì •ë„ ì´ ì„¹ì…˜ ë°–(ìœ„ìª½)ì— ì¡´ì¬í•¨.
    }

    function renderCharacterMapping() {
        const container = document.getElementById('characterList');
        container.innerHTML = '';

        if (detectedCharacters.size === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500">ì¸ë¬¼ í˜•ì‹ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì˜ˆ: "ì² ìˆ˜: ì•ˆë…•")</p>';
            return;
        }

        const sortedChars = Array.from(detectedCharacters).sort();

        sortedChars.forEach(char => {
            const savedVoice = characterVoiceMap[char] || '';
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between bg-white dark:bg-gray-700 p-2 rounded border dark:border-gray-600';

            // ìŒì„± ì˜µì…˜ HTML ìƒì„±
            const options = availableVoices.map(v =>
                `<option value="${v.id}" ${v.id === savedVoice ? 'selected' : ''}>${v.name}</option>`
            ).join('');

            row.innerHTML = `
                <span class="font-bold text-gray-800 dark:text-gray-200 min-w-[80px]">${char}</span>
                <select class="input-field text-sm py-1" onchange="updateCharVoice('${char}', this.value)">
                    <option value="">-- ê¸°ë³¸ ì„¤ì • ë”°ë¦„ --</option>
                    ${options}
                </select>
            `;
            container.appendChild(row);
        });
    }

    // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ
    window.updateCharVoice = function (char, voiceId) {
        if (voiceId) {
            characterVoiceMap[char] = voiceId;
        } else {
            delete characterVoiceMap[char];
        }
    };



    async function loadVoices() {
        const select = document.getElementById('voiceSelect');
        const provider = document.getElementById('providerSelect').value;
        select.innerHTML = ''; // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
        availableVoices = []; // ìºì‹œ ì´ˆê¸°í™”

        // ë¸Œë¼ìš°ì € TTS ìŒì„±
        if (provider === 'browser') {
            const browserVoices = speechSynthesis.getVoices()
                .filter(v => v.lang.startsWith('ko'))
                .map(v => ({ id: v.name, name: v.name }));
            select.innerHTML = browserVoices.map(v =>
                `<option value="${v.id}">${v.name}</option>`
            ).join('');
            availableVoices = browserVoices;
            if (document.getElementById('multiVoiceToggle').checked) {
                renderCharacterMapping();
            }
            return;
        }

        let detectedVoices = [];

        if (provider === 'google_cloud') {
            // Google Cloud ìŒì„± (í•˜ë“œì½”ë”©ëœ í”„ë¦¬ì…‹)
            const googleVoices = [
                { id: 'ko-KR-Neural2-A', name: 'Google Neural2 A (ì—¬ì„±)' },
                { id: 'ko-KR-Neural2-B', name: 'Google Neural2 B (ì—¬ì„±)' },
                { id: 'ko-KR-Neural2-C', name: 'Google Neural2 C (ë‚¨ì„±)' },
                { id: 'ko-KR-Standard-A', name: 'Google Standard A (ì—¬ì„±)' },
                { id: 'ko-KR-Standard-B', name: 'Google Standard B (ì—¬ì„±)' },
                { id: 'ko-KR-Standard-C', name: 'Google Standard C (ë‚¨ì„±)' },
                { id: 'ko-KR-Standard-D', name: 'Google Standard D (ë‚¨ì„±)' }
            ];

            select.innerHTML = googleVoices.map(v =>
                `<option value="${v.id}">${v.name}</option>`
            ).join('');
            detectedVoices = googleVoices;
        } else if (provider === 'gemini') {
            // Gemini ìŒì„±
            const geminiVoices = [
                { id: 'Puck', name: 'Puck (ë‚¨ì„±/ì¤‘ì €ìŒ)' },
                { id: 'Charon', name: 'Charon (ë‚¨ì„±/ì €ìŒ)' },
                { id: 'Kore', name: 'Kore (ì—¬ì„±/ë¶€ë“œëŸ¬ì›€)' },
                { id: 'Fenrir', name: 'Fenrir (ë‚¨ì„±/ê±°ì¹¨)' },
                { id: 'Aoede', name: 'Aoede (ì—¬ì„±/ë†’ìŒ)' }
            ];
            select.innerHTML = geminiVoices.map(v =>
                `<option value="${v.id}">${v.name}</option>`
            ).join('');
            detectedVoices = geminiVoices;
        }

        if (detectedVoices.length > 0) {
            availableVoices = detectedVoices;
            // ìŒì„± ëª©ë¡ ê°±ì‹ ë˜ë©´ ë§¤í•‘ UIë„ ìƒˆë¡œ ê·¸ë ¤ì•¼ í•¨ (ì˜µì…˜ ì±„ìš°ê¸° ìœ„í•´)
            if (document.getElementById('multiVoiceToggle').checked) {
                renderCharacterMapping();
            }
            return;
        }

        if (provider === 'openai') {
            const openaiVoices = [
                { id: 'alloy', name: 'Alloy (ì¤‘ë¦½)' },
                { id: 'echo', name: 'Echo (ë‚¨ì„±)' },
                { id: 'fable', name: 'Fable (ë‚¨ì„±/ì•¡ì„¼íŠ¸)' },
                { id: 'onyx', name: 'Onyx (ë‚¨ì„±/ì €ìŒ)' },
                { id: 'nova', name: 'Nova (ì—¬ì„±)' },
                { id: 'shimmer', name: 'Shimmer (ì—¬ì„±/ë°ìŒ)' }
            ];
            select.innerHTML = openaiVoices.map(v =>
                `<option value="${v.id}">${v.name}</option>`
            ).join('');
            availableVoices = openaiVoices;
            if (document.getElementById('multiVoiceToggle').checked) {
                renderCharacterMapping();
            }
            return;
        }

        // ElevenLabs ìŒì„± (API í˜¸ì¶œ)
        try {
            const result = await API.tts.getVoices();
            if (result.voices?.length > 0) {
                const defaultVoiceId = "4JJwo477JUAx3HV0T7n7";
                const manualVoices = [
                    { id: "ETPP7D0aZVdEj12Aa7ho", name: "Marcus (ì¶”ì²œ)" },
                    { id: "DOL4zlUH4vnnX1hByxsw", name: "ì¶”ì²œ ëª©ì†Œë¦¬ 2" }
                ];

                let voices = [...result.voices];
                manualVoices.forEach(mv => {
                    if (!voices.find(v => v.voice_id === mv.id)) {
                        voices.push({ voice_id: mv.id, name: mv.name });
                    }
                });

                select.innerHTML = voices.map(v =>
                    `<option value="${v.voice_id}" ${v.voice_id === defaultVoiceId ? 'selected' : ''}>${v.name}</option>`
                ).join('');

                // ElevenLabs ìºì‹±
                availableVoices = voices.map(v => ({ id: v.voice_id, name: v.name }));
                if (document.getElementById('multiVoiceToggle').checked) {
                    renderCharacterMapping();
                }

            } else {
                select.innerHTML = '<option value="">ElevenLabs ìŒì„± ì—†ìŒ (API í‚¤ í™•ì¸)</option>';
                availableVoices = [];
            }
        } catch {
            select.innerHTML = '<option value="">API ì—°ê²° ì‹¤íŒ¨</option>';
            availableVoices = [];
        }
    }

    async function loadScript() {
        // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸
        const scriptData = Utils.storage.get('fullScript');
        if (scriptData?.script) {
            applyScriptToTextarea(scriptData.script);
            return;
        }

        // 2. ìŠ¤í† ë¦¬ì§€ì— ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ì¡°íšŒ
        const projectId = getCurrentProject();
        if (projectId) {
            try {
                Utils.showToast('ì„œë²„ì—ì„œ ëŒ€ë³¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
                const project = await API.project.getFull(projectId);

                // ì–¸ì–´ ì„¤ì • ì €ì¥
                if (project.target_language) {
                    currentLanguage = project.target_language;
                    console.log('Project Language:', currentLanguage);
                }

                // project.scriptëŠ” { full_script: "..." } í˜•íƒœì¼ ìˆ˜ ìˆìŒ
                const fullScript = project.script?.full_script || project.script || "";

                if (fullScript) {
                    applyScriptToTextarea(fullScript);
                    Utils.showToast('ëŒ€ë³¸ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');

                    // ë¡œì»¬ì—ë„ ì €ì¥
                    Utils.storage.set('fullScript', { script: fullScript });
                } else {
                    Utils.showToast('ì €ì¥ëœ ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
                }
            } catch (e) {
                console.error(e);
                Utils.showToast('ëŒ€ë³¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'error');
            }
        } else {
            Utils.showToast('ì„ íƒëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
        }
    }

    function applyScriptToTextarea(text) {
        if (!text) return;
        // ëŒ€ë³¸ ì •ë¦¬ (ì—°ì¶œ ì§€ì‹œ ì œê±°)
        // text = text.replace(/\[.*?\]/g, ''); // ì—°ì¶œì§€ì‹œë§Œ ì œê±°í•˜ê³  ê´„í˜¸ëŠ” ë‚¨ê¸¸ê¹Œ? ì¼ë‹¨ ìœ ì§€
        // text = text.replace(/\(.*?\)/g, '');
        // text = text.replace(/#{1,6}\s*/g, '');

        // ë„ˆë¬´ ë§ì´ ì§€ìš°ë©´ ì‚¬ìš©ìê°€ ë‹¹í™©í•˜ë¯€ë¡œ, ë§ˆí¬ë‹¤ìš´ í—¤ë” ì •ë„ë§Œ ì •ë¦¬
        text = text.replace(/#{1,6}\s/g, '');

        document.getElementById('ttsText').value = text.trim();
        updateStats();

        // ëŒ€ë³¸ ë¶ˆëŸ¬ì˜¤ë©´ ì¦‰ì‹œ ë¶„ì„
        setTimeout(() => {
            if (document.getElementById('multiVoiceToggle').checked) {
                analyzeScriptForCharacters();
            }
        }, 100);
    }

    function updateStats() {
        const text = document.getElementById('ttsText').value;
        const charCount = text.length;
        const seconds = Math.ceil(charCount / 5); // ì´ˆë‹¹ 5ì ê¸°ì¤€

        document.getElementById('charCount').textContent = charCount.toLocaleString();
        document.getElementById('estTime').textContent = Utils.formatDuration(seconds);
    }

    function handleProviderChange() {
        // ìŒì„± ëª©ë¡ ê°±ì‹ 
        loadVoices();
    }

    async function generateTTS() {
        const text = document.getElementById('ttsText').value.trim();
        if (!text) {
            Utils.showToast('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const provider = document.getElementById('providerSelect').value;
        const speed = parseFloat(document.getElementById('audioSpeed').value) || 1.0;

        if (provider === 'browser') {
            playBrowserTTS();
            return;
        }

        const voiceId = document.getElementById('voiceSelect').value;
        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìŒì„± ìƒì„± ì¤‘...');

        try {
            const isMultiVoice = document.getElementById('multiVoiceToggle').checked;

            const projectId = getCurrentProject();
            const result = await API.tts.generate(text, {
                voiceId,
                provider,
                language: currentLanguage, // ì–¸ì–´ ì „ë‹¬
                speed, // ì†ë„ ì „ë‹¬
                projectId: projectId ? parseInt(projectId) : null,
                // ë©€í‹°ë³´ì´ìŠ¤ ë°ì´í„° ì „ë‹¬
                multiVoice: isMultiVoice,
                voiceMap: isMultiVoice ? characterVoiceMap : {}
            });

            if (result.status === 'ok') {
                const player = document.getElementById('audioPlayer');
                player.src = result.url;
                player.play().catch(e => console.log('Auto-play blocked:', e)); // ìë™ ì¬ìƒ ì‹œë„

                document.getElementById('downloadLink').href = result.url;
                document.getElementById('resultSection').classList.remove('hidden');
                Utils.showToast('ìŒì„±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

                Utils.storage.set('ttsAudio', { url: result.url, timestamp: Date.now() });
            } else {
                Utils.showToast(result.error || 'ìƒì„± ì‹¤íŒ¨', 'error');
            }
        } catch (error) {
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    // ë¸Œë¼ìš°ì € TTS
    function playBrowserTTS() {
        const text = document.getElementById('ttsText').value;
        if (!text) return;

        if (utterance) speechSynth.cancel();

        utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = parseFloat(document.getElementById('audioSpeed').value) || 1.0;
        utterance.pitch = 1.0;

        const voices = speechSynth.getVoices();
        const selectedVoiceName = document.getElementById('voiceSelect').value;

        let voice = voices.find(v => v.name === selectedVoiceName);
        if (!voice) {
            // ì„ íƒëœê²Œ ì—†ìœ¼ë©´ í•œêµ­ì–´ ì•„ë¬´ê±°ë‚˜
            voice = voices.find(v => v.lang.includes('ko'));
        }

        if (voice) utterance.voice = voice;

        speechSynth.speak(utterance);
    }

    function pauseBrowserTTS() {
        speechSynth.pause();
    }

    function stopBrowserTTS() {
        speechSynth.cancel();
    }
</script>
{% endblock %}