{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ”Š</span>
        <div>
            <h1>TTS ìƒì„±</h1>
            <p>ëŒ€ë³¸ì„ ìŒì„±ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- API ìƒíƒœ -->
<div id="apiStatus" class="card mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <span class="text-xl">ğŸ”‘</span>
            <div>
                <span class="font-medium text-gray-800 dark:text-white">TTS API ìƒíƒœ</span>
                <p id="apiStatusText" class="text-sm text-gray-500">í™•ì¸ ì¤‘...</p>
            </div>
        </div>
        <a href="/settings" class="btn-secondary text-sm">âš™ï¸ ì„¤ì •</a>
    </div>
</div>

<!-- TTS ì„¤ì • -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ ìŒì„± ì„¤ì •</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ìŒì„± ì„ íƒ</label>
            <select id="voiceSelect" class="input-field">
                <option value="">ë¡œë”© ì¤‘...</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì„œë¹„ìŠ¤</label>
            <select id="providerSelect" class="input-field">
                <option value="elevenlabs">ElevenLabs</option>
                <option value="browser">ë¸Œë¼ìš°ì € TTS (ë¬´ë£Œ)</option>
            </select>
        </div>
    </div>
</div>

<!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
<div class="card mb-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-gray-800 dark:text-white">ğŸ“ í…ìŠ¤íŠ¸</h3>
        <button onclick="loadScript()" class="btn-secondary text-sm">ğŸ”„ ëŒ€ë³¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    <textarea id="ttsText" class="input-field font-mono" rows="10" placeholder="ìŒì„±ìœ¼ë¡œ ë³€í™˜í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <div class="mt-2 text-sm text-gray-500">
        <span id="charCount">0</span>ì | ì˜ˆìƒ ì‹œê°„: <span id="estTime">0:00</span>
    </div>
</div>

<!-- ìƒì„± ë²„íŠ¼ -->
<button onclick="generateTTS()" id="generateBtn"
    class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg mb-6">
    <span>ğŸ”Š</span>
    <span>ìŒì„± ìƒì„±í•˜ê¸°</span>
</button>

<!-- ê²°ê³¼ -->
<div id="resultSection" class="hidden">
    <div class="card">
        <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸµ ìƒì„±ëœ ìŒì„±</h3>
        <audio id="audioPlayer" controls class="w-full mb-4"></audio>
        <a id="downloadLink" href="#" download class="btn-secondary inline-flex items-center gap-2">
            ğŸ’¾ ë‹¤ìš´ë¡œë“œ
        </a>
    </div>
</div>

<!-- ë¸Œë¼ìš°ì € TTS (ë¬´ë£Œ) -->
<div id="browserTTS" class="card hidden">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ”Š ë¸Œë¼ìš°ì € TTS</h3>
    <div class="flex gap-2 mb-4">
        <button onclick="playBrowserTTS()" class="btn-primary">â–¶ï¸ ì¬ìƒ</button>
        <button onclick="pauseBrowserTTS()" class="btn-secondary">â¸ï¸ ì¼ì‹œì •ì§€</button>
        <button onclick="stopBrowserTTS()" class="btn-secondary">â¹ï¸ ì •ì§€</button>
    </div>
    <p class="text-sm text-gray-500">ë¸Œë¼ìš°ì € TTSëŠ” íŒŒì¼ ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ê³ í’ˆì§ˆ ìŒì„±ì€ ElevenLabs APIë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
    let speechSynth = window.speechSynthesis;
    let utterance = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await checkAPIStatus();
        await loadVoices();
        loadScript();

        document.getElementById('providerSelect').addEventListener('change', handleProviderChange);
    });

    // ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data.script && data.script.full_script) {
            Utils.storage.set('fullScript', { script: data.script.full_script }); // ê°„ë‹¨íˆ ì €ì¥ (í¬ë§· ì£¼ì˜)
            loadScript();
        }
        if (data.tts && data.tts.url) {
            Utils.storage.set('ttsAudio', data.tts);
            document.getElementById('audioPlayer').src = data.tts.url;
            document.getElementById('downloadLink').href = data.tts.url;
            document.getElementById('resultSection').classList.remove('hidden');
        }
    });

    async function checkAPIStatus() {
        const health = await API.health();
        const statusText = document.getElementById('apiStatusText');

        if (health.apis?.elevenlabs) {
            statusText.innerHTML = '<span class="text-green-600">âœ… ElevenLabs ì—°ê²°ë¨</span>';
        } else {
            statusText.innerHTML = '<span class="text-yellow-600">âš ï¸ API ë¯¸ì„¤ì • - ë¸Œë¼ìš°ì € TTS ì‚¬ìš©</span>';
            document.getElementById('providerSelect').value = 'browser';
            handleProviderChange();
        }
    }

    async function loadVoices() {
        const select = document.getElementById('voiceSelect');

        // ElevenLabs ìŒì„±
        try {
            const result = await API.tts.getVoices();
            if (result.voices?.length > 0) {
                select.innerHTML = result.voices.map(v =>
                    `<option value="${v.voice_id}">${v.name}</option>`
                ).join('');
            } else {
                select.innerHTML = '<option value="">ìŒì„± ì—†ìŒ</option>';
            }
        } catch {
            select.innerHTML = '<option value="">ìŒì„± ë¡œë”© ì‹¤íŒ¨</option>';
        }
    }

    function loadScript() {
        const scriptData = Utils.storage.get('fullScript');
        if (scriptData?.script) {
            // ëŒ€ë³¸ ì •ë¦¬ (ì—°ì¶œ ì§€ì‹œ ì œê±°)
            let text = scriptData.script;
            text = text.replace(/\[.*?\]/g, '');
            text = text.replace(/\(.*?\)/g, '');
            text = text.replace(/#{1,6}\s*/g, '');
            text = text.trim();

            document.getElementById('ttsText').value = text;
            updateStats();
        }
    }

    function updateStats() {
        const text = document.getElementById('ttsText').value;
        const charCount = text.length;
        const seconds = Math.ceil(charCount / 5); // ì´ˆë‹¹ 5ì ê¸°ì¤€

        document.getElementById('charCount').textContent = charCount.toLocaleString();
        document.getElementById('estTime').textContent = Utils.formatDuration(seconds);
    }

    function handleProviderChange() {
        const provider = document.getElementById('providerSelect').value;
        if (provider === 'browser') {
            document.getElementById('browserTTS').classList.remove('hidden');
        } else {
            document.getElementById('browserTTS').classList.add('hidden');
        }
    }

    async function generateTTS() {
        const text = document.getElementById('ttsText').value.trim();
        if (!text) {
            Utils.showToast('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const provider = document.getElementById('providerSelect').value;

        if (provider === 'browser') {
            playBrowserTTS();
            return;
        }

        const voiceId = document.getElementById('voiceSelect').value;
        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìŒì„± ìƒì„± ì¤‘...');

        try {
            const projectId = getCurrentProject();
            const result = await API.tts.generate(text, {
                voiceId,
                provider,
                projectId: projectId ? parseInt(projectId) : null
            });

            if (result.status === 'ok') {
                document.getElementById('audioPlayer').src = result.url;
                document.getElementById('downloadLink').href = result.url;
                document.getElementById('resultSection').classList.remove('hidden');
                Utils.showToast('ìŒì„±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

                Utils.storage.set('ttsAudio', { url: result.url, timestamp: Date.now() });
            } else {
                Utils.showToast(result.error || 'ìƒì„± ì‹¤íŒ¨', 'error');
            }
        } catch (error) {
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    // ë¸Œë¼ìš°ì € TTS
    function playBrowserTTS() {
        const text = document.getElementById('ttsText').value;
        if (!text) return;

        if (utterance) speechSynth.cancel();

        utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        const voices = speechSynth.getVoices();
        const koreanVoice = voices.find(v => v.lang.includes('ko'));
        if (koreanVoice) utterance.voice = koreanVoice;

        speechSynth.speak(utterance);
    }

    function pauseBrowserTTS() {
        speechSynth.pause();
    }

    function stopBrowserTTS() {
        speechSynth.cancel();
    }
</script>
{% endblock %}