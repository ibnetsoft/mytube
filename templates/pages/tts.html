{% extends "base.html" %}

{% block content %}
<div class="h-[calc(100vh-140px)] flex flex-col gap-3 p-2">
    <!-- 1. Top Control Toolbar -->
    <div
        class="flex items-center gap-3 p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 shrink-0 flex-wrap">

        <!-- Script Status Badge -->
        <span id="scriptStatusBadge"
            class="text-[10px] flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-gray-400 font-normal">
            <span>ğŸ”„</span> ëŒ€ë³¸ í™•ì¸ ì¤‘...
        </span>

        <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>

        <!-- Provider -->
        <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-gray-700 dark:text-gray-300">ì„œë¹„ìŠ¤</span>
            <select id="providerSelect"
                class="text-xs border-gray-300 dark:border-gray-600 rounded-md py-1 px-2 focus:ring-primary focus:border-primary bg-gray-50 dark:bg-gray-700 dark:text-white">
                <option value="gemini">Gemini (ë¬´ë£Œ)</option>
                <option value="openai">OpenAI (ìœ ë£Œ)</option>
                <option value="elevenlabs" selected>ElevenLabs</option>
                <option value="google_cloud">Google Cloud</option>
            </select>
        </div>

        <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>

        <!-- Voice (Single Mode) -->
        <div class="flex items-center gap-2" id="singleVoiceControls">
            <span class="text-xs font-bold text-gray-700 dark:text-gray-300">ì„±ìš°</span>
            <select id="voiceSelect"
                class="text-xs border-gray-300 dark:border-gray-600 rounded-md py-1 px-2 focus:ring-primary focus:border-primary bg-gray-50 dark:bg-gray-700 dark:text-white w-40">
                <option value="">ë¡œë”© ì¤‘...</option>
            </select>
        </div>

        <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>

        <!-- Speed -->
        <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-gray-700 dark:text-gray-300">ì†ë„ <span id="speedValue"
                    class="text-primary">1.0</span></span>
            <input type="range" id="audioSpeed" min="0.5" max="2.0" step="0.1" value="1.0"
                class="w-20 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-primary"
                title="">
        </div>

        <div class="flex-1"></div>

        <!-- Multi-Voice Toggle -->
        <label class="inline-flex items-center cursor-pointer mr-2">
            <input type="checkbox" id="multiVoiceToggle" class="sr-only peer">
            <div
                class="relative w-8 h-4 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600">
            </div>
            <span class="ms-2 text-xs font-medium text-gray-900 dark:text-gray-300">ğŸ™ï¸ ë©€í‹°ë³´ì´ìŠ¤</span>
        </label>

        <!-- Generate Button -->
        <button onclick="generateTTS()" id="generateBtn"
            class="btn-primary py-1.5 px-4 text-sm font-medium rounded-md shadow-sm hover:shadow active:scale-95 transition-all flex items-center gap-2 whitespace-nowrap">
            <span>ğŸ”Š ìƒì„±í•˜ê¸°</span>
        </button>

        <!-- Divider -->
        <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>

        <!-- Upload Audio Button -->
        <div class="flex items-center">
            <input type="file" id="audioUploadInput" accept="audio/*" class="hidden"
                onchange="uploadExternalAudio(this)">
            <button onclick="document.getElementById('audioUploadInput').click()"
                class="btn-secondary py-1.5 px-3 flex items-center justify-center gap-2 text-xs font-bold shadow-sm whitespace-nowrap">
                <span>ğŸ“ ì™¸ë¶€ ìŒì„± ì—…ë¡œë“œ</span>
            </button>
        </div>
    </div>

    <!-- 2. Main Workspace (Grid) -->
    <div class="grid grid-cols-12 gap-3 flex-1 min-h-0">
        <!-- Left Panel: Character Mapping / Info (Col-4) -->
        <div class="col-span-12 md:col-span-4 flex flex-col gap-3 min-h-0">
            <!-- Information / Status -->
            <div id="apiStatus"
                class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 shrink-0 shadow-sm">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-sm">ğŸ”‘</span>
                        <span id="apiStatusText" class="text-xs text-gray-500">API ìƒíƒœ í™•ì¸ ì¤‘...</span>
                    </div>
                </div>
            </div>

            <!-- Multi-Voice Mapping List (Visible when Toggle ON) -->
            <div id="voiceMappingSection"
                class="hidden flex-1 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 flex flex-col overflow-hidden shadow-sm">
                <div class="flex items-center justify-between mb-2 shrink-0">
                    <h4 class="text-xs font-bold text-gray-700 dark:text-gray-300">ğŸ­ ì¸ë¬¼ë³„ ì„±ìš° ì„¤ì •</h4>
                    <button onclick="analyzeScriptForCharacters()"
                        class="text-[10px] text-blue-500 hover:text-blue-700">ğŸ”„ ê°±ì‹ </button>
                </div>

                <div class="text-[10px] text-gray-500 mb-2 bg-blue-50 dark:bg-blue-900/20 p-2 rounded">
                    ëŒ€ë³¸ì— <strong>"ì² ìˆ˜: ì•ˆë…•"</strong> í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.
                </div>

                <div id="characterList" class="overflow-y-auto flex-1 space-y-2 pr-1 custom-scrollbar">
                    <p class="text-xs text-gray-400 text-center py-4">ëŒ€ë³¸ì„ ì…ë ¥í•˜ë©´<br>ë“±ì¥ì¸ë¬¼ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- Audio Result (Visible after generation) -->
            <div id="resultSection"
                class="hidden shrink-0 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 shadow-sm border-l-4 border-l-purple-500">
                <h4 class="text-xs font-bold text-gray-800 dark:text-white mb-2">ğŸµ ìƒì„± ê²°ê³¼</h4>
                <audio id="audioPlayer" controls class="w-full h-8 mb-2"></audio>
                <div class="flex gap-2">
                    <a id="downloadLink" href="#" download class="flex-1 btn-secondary py-1 text-xs text-center">ğŸ’¾
                        ë‹¤ìš´ë¡œë“œ</a>
                    <a href="/subtitle_gen"
                        class="flex-1 btn-primary py-1 text-xs text-center bg-blue-600 hover:bg-blue-700">ğŸ“ ìë§‰ì‘ì—…</a>
                </div>
            </div>
        </div>

        <!-- Right Panel: Script Editor (Col-8) -->
        <div
            class="col-span-12 md:col-span-8 flex flex-col min-h-0 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
            <div
                class="flex items-center justify-between p-2 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                <h3 class="text-xs font-bold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                    ğŸ“„ ëŒ€ë³¸ ì…ë ¥
                    <span class="font-normal text-gray-400">|</span>
                    <span class="font-normal text-gray-500"><span id="charCount">0</span>ì</span>
                </h3>
                <button onclick="loadScript()"
                    class="text-xs text-gray-500 hover:text-primary flex items-center gap-1 transition-colors">
                    ğŸ”„ ëŒ€ë³¸ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
            </div>

            <textarea id="ttsText"
                class="flex-1 p-3 text-sm font-mono border-0 focus:ring-0 resize-none bg-transparent dark:text-gray-200 custom-scrollbar leading-relaxed"
                placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>

            <div
                class="p-1 px-3 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700 text-[10px] text-gray-400 flex justify-between">
                <span>ì˜ˆìƒ ì‹œê°„: <span id="estTime">0:00</span></span>
                <span>Shift+Enter ì¤„ë°”ê¿ˆ</span>
            </div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }

    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #4b5563;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let speechSynth = window.speechSynthesis;
    let utterance = null;

    document.addEventListener('DOMContentLoaded', async () => {
        checkScriptStatus(); // [NEW] Check Status
        await checkAPIStatus();
        await loadVoices();
        loadScript();

        document.getElementById('providerSelect').addEventListener('change', handleProviderChange);

        const speedSlider = document.getElementById('audioSpeed');
        const speedValue = document.getElementById('speedValue');
        if (speedSlider && speedValue) {
            speedSlider.addEventListener('input', (e) => speedValue.textContent = e.target.value);
        }
    });

    // Script Status Check (Same logic as image_gen)
    async function checkScriptStatus() {
        const badge = document.getElementById('scriptStatusBadge');
        if (!badge) return;

        let hasScript = false;

        // 1. Check Local Storage
        const localData = Utils.storage.get('fullScript');
        if (localData && localData.script) {
            hasScript = true;
        } else {
            // 2. Check DB
            const projectId = getCurrentProject();
            if (projectId) {
                try {
                    const result = await API.project.getScript(projectId);
                    if (result && result.full_script) {
                        hasScript = true;
                        // Sync to local
                        Utils.storage.set('fullScript', { script: result.full_script });
                    }
                } catch (e) {
                    console.error("Script check failed:", e);
                }
            }
        }

        if (hasScript) {
            badge.className = "text-[10px] flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 font-normal";
            badge.innerHTML = "<span>âœ…</span> ëŒ€ë³¸ ì¤€ë¹„ë¨";
        } else {
            badge.className = "text-[10px] flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-normal";
            badge.innerHTML = "<span>ğŸš«</span> ëŒ€ë³¸ ì—†ìŒ";
        }
    }

    // ... (ê¸°ì¡´ JS ë¡œì§ ìœ ì§€, ID ë§¤ì¹­ í™•ì¸) ...
    // window.addEventListener('projectStateRestored', ...) ë¡œì§ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥
    // ë‹¨, HTML êµ¬ì¡°ê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ classList ì œì–´ ë¶€ë¶„ í™•ì¸ í•„ìš”

    // ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data.script && data.script.full_script) {
            Utils.storage.set('fullScript', { script: data.script.full_script });
            loadScript();
        }
        if (data.tts) {
            if (!data.tts.url && data.tts.audio_path) {
                const path = data.tts.audio_path.replace(/\\/g, '/');
                const outputIndex = path.indexOf('/output/');
                if (outputIndex !== -1) data.tts.url = path.substring(outputIndex);
            }
            if (data.tts.url) {
                Utils.storage.set('ttsAudio', data.tts);
                const player = document.getElementById('audioPlayer');
                if (player) player.src = data.tts.url;
                const dnLink = document.getElementById('downloadLink');
                if (dnLink) dnLink.href = data.tts.url;

                const resultSec = document.getElementById('resultSection');
                if (resultSec) resultSec.classList.remove('hidden');
            }
        }
    });

    async function checkAPIStatus() {
        const health = await API.health();
        const statusText = document.getElementById('apiStatusText');

        let msg = '';
        if (health.apis?.elevenlabs) msg += '<span class="text-green-600">âœ… EL </span>';
        if (health.apis?.openai) msg += '<span class="text-green-600">âœ… OA </span>';
        if (!msg) msg = '<span class="text-blue-600">âœ¨ Gemini</span>';

        statusText.innerHTML = msg;
        handleProviderChange();
    }

    // ì „ì—­ ë³€ìˆ˜
    let detectedCharacters = new Set();
    let characterVoiceMap = {};
    let availableVoices = [];
    let currentLanguage = 'ko';

    document.getElementById('multiVoiceToggle').addEventListener('change', (e) => {
        const section = document.getElementById('voiceMappingSection');
        const singleControls = document.getElementById('singleVoiceControls');

        if (e.target.checked) {
            section.classList.remove('hidden');
            singleControls.classList.add('opacity-50', 'pointer-events-none'); // Disable single controls visually
            analyzeScriptForCharacters();

            const provider = document.getElementById('providerSelect');
            if (provider.value !== 'gemini') {
                provider.value = 'gemini';
                handleProviderChange();
                Utils.showToast('ë©€í‹° ë³´ì´ìŠ¤ = Gemini ê¶Œì¥', 'info');
            }
        } else {
            section.classList.add('hidden');
            singleControls.classList.remove('opacity-50', 'pointer-events-none');
        }
    });

    document.getElementById('ttsText').addEventListener('input', () => {
        updateStats();
        if (document.getElementById('multiVoiceToggle').checked) {
            analyzeScriptForCharacters();
        }
    });

    function analyzeScriptForCharacters() {
        const text = document.getElementById('ttsText').value;
        const lines = text.split('\n');
        const newCharacters = new Set();
        const regex = /^([^\s:\[\]\(\)]+)(?:\(.*\))?[:]/;

        lines.forEach(line => {
            const match = line.trim().match(regex);
            if (match && match[1]) {
                let cleanName = match[1].trim()
                    .replace(/[\*\_\#]/g, '')
                    .replace(/[\[\]\(\)\{\}]/g, '')
                    .trim();
                if (cleanName && cleanName.length > 0) newCharacters.add(cleanName);
            }
        });

        if (!isSetsEqual(detectedCharacters, newCharacters)) {
            detectedCharacters = newCharacters;
            renderCharacterMapping();
        }
    }

    function isSetsEqual(a, b) {
        if (a.size !== b.size) return false;
        for (let item of a) if (!b.has(item)) return false;
        return true;
    }

    function renderCharacterMapping() {
        const container = document.getElementById('characterList');
        container.innerHTML = '';

        if (detectedCharacters.size === 0) {
            container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">ì¸ë¬¼ ëŒ€ì‚¬ê°€ ê°ì§€ë˜ì§€ ì•ŠìŒ<br>(ì˜ˆ: "ì² ìˆ˜: ì•ˆë…•")</p>';
            return;
        }

        const sortedChars = Array.from(detectedCharacters).sort();
        sortedChars.forEach(char => {
            const savedVoice = characterVoiceMap[char] || '';
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-700/50 p-1.5 rounded border border-gray-100 dark:border-gray-600 gap-2';

            let options = availableVoices.length > 0 ? availableVoices.map(v =>
                `<option value="${v.id}" ${v.id === savedVoice ? 'selected' : ''}>${v.name}</option>`
            ).join('') : `<option value="">ë¡œë”©ì¤‘...</option>`;

            const safeChar = char.replace(/'/g, "\\'");

            row.innerHTML = `
                <span class="text-xs font-bold text-gray-700 dark:text-gray-300 w-16 truncate" title="${char}">${char}</span>
                <select class="text-[10px] border-gray-200 dark:border-gray-600 rounded py-1 pl-1 pr-6 flex-1 bg-white dark:bg-gray-800 dark:text-white" onchange="updateCharVoice('${safeChar}', this.value)">
                    <option value="">-- ê¸°ë³¸ --</option>
                    ${options}
                </select>
            `;
            container.appendChild(row);
        });
    }

    window.updateCharVoice = function (char, voiceId) {
        if (voiceId) characterVoiceMap[char] = voiceId;
        else delete characterVoiceMap[char];
    };

    async function loadVoices() {
        const select = document.getElementById('voiceSelect');
        const provider = document.getElementById('providerSelect').value;
        select.innerHTML = '<option>ë¡œë”©...</option>';
        availableVoices = [];

        // ... Data Loading Logic same as before ... 
        // (Briefing logic for brevity, assuming standard API calls)

        let voices = [];
        try {
            if (provider === 'browser') {
                const browserVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('ko'));
                voices = browserVoices.map(v => ({ id: v.name, name: v.name }));
            } else if (provider === 'google_cloud') {
                voices = [
                    { id: 'ko-KR-Neural2-A', name: 'G-Neural2 A(ì—¬)' },
                    { id: 'ko-KR-Neural2-C', name: 'G-Neural2 C(ë‚¨)' },
                    { id: 'ko-KR-Standard-A', name: 'G-Std A(ì—¬)' }
                ]; // Simplified for now, or full list
            } else if (provider === 'gemini') {
                voices = [
                    { id: 'Puck', name: 'Puck (ë‚¨/ì¤‘)' },
                    { id: 'Charon', name: 'Charon (ë‚¨/ì €)' },
                    { id: 'Kore', name: 'Kore (ì—¬/ë¶€ë“œ)' },
                    { id: 'Fenrir', name: 'Fenrir (ë‚¨/ê±°ì¹¨)' },
                    { id: 'Aoede', name: 'Aoede (ì—¬/ë†’)' }
                ];
            } else if (provider === 'openai') {
                voices = [
                    { id: 'alloy', name: 'Alloy' }, { id: 'echo', name: 'Echo' }, { id: 'shimmer', name: 'Shimmer' }
                ];
            } else {
                // ElevenLabs
                const result = await API.tts.getVoices();
                if (result.voices) voices = result.voices.map(v => ({ id: v.voice_id, name: v.name }));
            }
        } catch (e) {
            console.error(e);
        }

        availableVoices = voices;
        if (voices.length > 0) {
            select.innerHTML = voices.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
        } else {
            select.innerHTML = '<option value="">ìŒì„± ì—†ìŒ</option>';
        }

        if (document.getElementById('multiVoiceToggle').checked) renderCharacterMapping();
    }

    async function loadScript() {
        let scriptData = Utils.storage.get('fullScript');
        if (!scriptData) {
            const projectId = getCurrentProject();
            if (projectId) {
                try {
                    const project = await API.project.getFull(projectId);
                    if (project.target_language) currentLanguage = project.target_language;
                    const fullScript = project.script?.full_script || project.script || "";
                    if (fullScript) {
                        scriptData = { script: fullScript };
                        Utils.storage.set('fullScript', scriptData);
                        Utils.showToast('ëŒ€ë³¸ ë¡œë“œë¨', 'success');
                    }
                } catch (e) { }
            }
        }
        if (scriptData?.script) applyScriptToTextarea(scriptData.script);
    }

    function applyScriptToTextarea(text) {
        if (!text) return;
        text = text.replace(/#{1,6}\s/g, '');
        document.getElementById('ttsText').value = text.trim();
        updateStats();
        setTimeout(() => {
            if (document.getElementById('multiVoiceToggle').checked) analyzeScriptForCharacters();
        }, 100);
    }

    function updateStats() {
        const text = document.getElementById('ttsText').value;
        const charCount = text.length;
        const seconds = Math.ceil(charCount / 5);
        document.getElementById('charCount').textContent = charCount.toLocaleString();
        document.getElementById('estTime').textContent = Utils.formatDuration(seconds);
    }

    function handleProviderChange() { loadVoices(); }

    async function generateTTS() {
        const text = document.getElementById('ttsText').value.trim();
        if (!text) return Utils.showToast('í…ìŠ¤íŠ¸ ì…ë ¥ í•„ìš”', 'warning');

        const provider = document.getElementById('providerSelect').value;
        const speed = parseFloat(document.getElementById('audioSpeed').value) || 1.0;
        const voiceId = document.getElementById('voiceSelect').value;
        const btn = document.getElementById('generateBtn');
        const isMultiVoice = document.getElementById('multiVoiceToggle').checked;

        if (provider === 'browser') { playBrowserTTS(); return; }

        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');
        try {
            const projectId = getCurrentProject();
            const result = await API.tts.generate(text, {
                voiceId, provider, language: currentLanguage, speed,
                projectId: projectId ? parseInt(projectId) : null,
                multiVoice: isMultiVoice,
                voiceMap: isMultiVoice ? characterVoiceMap : {}
            });

            if (result.status === 'ok') {
                const player = document.getElementById('audioPlayer');
                player.src = result.url;
                player.play().catch(e => { });
                document.getElementById('downloadLink').href = result.url;
                document.getElementById('resultSection').classList.remove('hidden');
                Utils.showToast('ìƒì„± ì™„ë£Œ', 'success');
                Utils.storage.set('ttsAudio', { url: result.url, timestamp: Date.now() });
            } else {
                Utils.showToast(result.error || 'ìƒì„± ì‹¤íŒ¨', 'error');
            }
        } catch (error) {
            Utils.showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    // External Audio Upload
    async function uploadExternalAudio(input) {
        if (!input.files || input.files.length === 0) return;

        const file = input.files[0];
        const projectId = getCurrentProject();

        if (!projectId) {
            Utils.showToast("í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.", "warning");
            input.value = ''; // Reset
            return;
        }

        Utils.showToast("ìŒì„± íŒŒì¼ ì—…ë¡œë“œ ì¤‘...", "info");

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(`/api/projects/${projectId}/tts/upload`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.status === 'ok') {
                Utils.showToast('ì™¸ë¶€ ìŒì„± íŒŒì¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // Set audio player
                const player = document.getElementById('audioPlayer');
                player.src = result.url;
                player.play().catch(e => { }); // Autoplay if possible

                document.getElementById('downloadLink').href = result.url;
                document.getElementById('resultSection').classList.remove('hidden');

                // Save to storage
                Utils.storage.set('ttsAudio', { url: result.url, timestamp: Date.now() });

            } else {
                Utils.showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (result.error || 'Unknown'), 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
        } finally {
            input.value = ''; // Reset
        }
    }

    // Browser TTS functions remain similar...
    function playBrowserTTS() { /* ... */ }
</script>
{% endblock %}