{% extends "base.html" %}

{% block content %}
<style>
    .style-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 10px;
    }

    .style-card-thumb {
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.2s;
        background: #f3f4f6;
        position: relative;
    }

    .dark .style-card-thumb {
        background: #374151;
    }

    .style-card-thumb:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .style-card-thumb.active {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px #3b82f6;
    }

    .style-card-thumb img {
        width: 100%;
        aspect-ratio: 16/9;
        object-fit: cover;
    }

    .style-label {
        padding: 6px;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #4b5563;
    }

    .dark .style-label {
        color: #d1d5db;
    }

    .style-card-thumb.active .style-label {
        background: #3b82f6;
        color: white;
    }
</style>


<!-- 1ë‹¨ê³„: ì•„ì´ë””ì–´ ìƒì„± -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">1ï¸âƒ£ ì¸ë„¤ì¼ ì•„ì´ë””ì–´ ìƒì„±</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒ ì£¼ì œ</label>
            <input type="text" id="videoTitle" class="input-field" placeholder="ì˜ˆ: ì‚¼êµ­ì§€ ìµœê°•ì˜ ë¬´ì¥ TOP 5">
        </div>
        <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">ìŠ¤íƒ€ì¼ ì„ íƒ</label>
            <input type="hidden" id="thumbnailStyle" value="face">
            <div class="style-grid">
                <div class="style-card-thumb active" onclick="selectThumbnailStyle('face')" data-style="face">
                    <img src="/static/img/thumbs/face.png" alt="Face" loading="lazy">
                    <div class="style-label">ì–¼êµ´ ê°•ì¡°í˜•</div>
                </div>
                <div class="style-card-thumb" onclick="selectThumbnailStyle('text')" data-style="text">
                    <img src="/static/img/thumbs/text.png" alt="Text" loading="lazy">
                    <div class="style-label">í…ìŠ¤íŠ¸ ì¤‘ì‹¬í˜•</div>
                </div>
                <div class="style-card-thumb" onclick="selectThumbnailStyle('contrast')" data-style="contrast">
                    <img src="/static/img/thumbs/contrast.png" alt="Contrast" loading="lazy">
                    <div class="style-label">ë¹„í¬/ì• í”„í„°í˜•</div>
                </div>
                <div class="style-card-thumb" onclick="selectThumbnailStyle('mystery')" data-style="mystery">
                    <img src="/static/img/thumbs/mystery.png" alt="Mystery" loading="lazy">
                    <div class="style-label">ë¯¸ìŠ¤í„°ë¦¬í˜•</div>
                </div>
                <div class="style-card-thumb" onclick="selectThumbnailStyle('minimal')" data-style="minimal">
                    <img src="/static/img/thumbs/minimal.png" alt="Minimal" loading="lazy">
                    <div class="style-label">ë¯¸ë‹ˆë©€í˜•</div>
                </div>
                <div class="style-card-thumb" onclick="selectThumbnailStyle('dramatic')" data-style="dramatic">
                    <img src="/static/img/thumbs/dramatic.png" alt="Dramatic" loading="lazy">
                    <div class="style-label">ë“œë¼ë§ˆí‹±í˜•</div>
                </div>
                <div class="style-card-thumb" onclick="selectThumbnailStyle('japanese_viral')"
                    data-style="japanese_viral">
                    <img src="/static/img/thumbs/japanese_viral.png" alt="Japanese" loading="lazy">
                    <div class="style-label">ğŸ‡¯ğŸ‡µ ì¼ë³¸ ë°”ì´ëŸ´</div>
                </div>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ìƒ‰ìƒ í†¤</label>
            <select id="colorTone" class="input-field">
                <option value="vibrant">ë¹„ë¹„ë“œ (ì±„ë„ ë†’ìŒ)</option>
                <option value="warm">ë”°ëœ»í•œ í†¤</option>
                <option value="cool">ì°¨ê°€ìš´ í†¤</option>
                <option value="dark">ë‹¤í¬ ëª¨ë“œ</option>
                <option value="neon">ë„¤ì˜¨</option>
            </select>
        </div>
    </div>
    <button onclick="generateIdeas()" id="ideaBtn" class="btn-primary">
        ğŸ’¡ ì•„ì´ë””ì–´ ìƒì„±
    </button>
</div>

<!-- 2ë‹¨ê³„: ì•„ì´ë””ì–´ ì„ íƒ ë° ì´ë¯¸ì§€ ìƒì„± -->
<div id="ideasSection" class="card mb-6 hidden">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">2ï¸âƒ£ ì•„ì´ë””ì–´ ì„ íƒ & ì´ë¯¸ì§€ ìƒì„±</h3>
    <div id="ideasList" class="space-y-4 mb-4"></div>
</div>

<!-- 3ë‹¨ê³„: í…ìŠ¤íŠ¸ ì¶”ê°€ -->
<div id="textSection" class="card mb-6 hidden">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">3ï¸âƒ£ ì¸ë„¤ì¼ í…ìŠ¤íŠ¸ ì„¤ì •</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í…ìŠ¤íŠ¸ í›„ë³´ (í´ë¦­í•´ì„œ ì„ íƒ)</label>
                <div id="textCandidates" class="flex flex-wrap gap-2 mb-3"></div>
                <input type="text" id="thumbnailText" class="input-field" placeholder="ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìœ„ì—ì„œ ì„ íƒ">
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í…ìŠ¤íŠ¸ ìœ„ì¹˜</label>
                    <select id="textPosition" class="input-field">
                        <option value="top">ìƒë‹¨</option>
                        <option value="center" selected>ì¤‘ì•™</option>
                        <option value="bottom">í•˜ë‹¨</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í°íŠ¸ í¬ê¸°</label>
                    <select id="fontSize" class="input-field">
                        <option value="48">ì‘ê²Œ (48px)</option>
                        <option value="72" selected>ë³´í†µ (72px)</option>
                        <option value="96">í¬ê²Œ (96px)</option>
                        <option value="120">ì•„ì£¼ í¬ê²Œ (120px)</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
                <div class="flex gap-2">
                    <button onclick="setTextColor('#FFFFFF')"
                        class="w-10 h-10 bg-white border-2 border-gray-300 rounded-lg"></button>
                    <button onclick="setTextColor('#FFFF00')" class="w-10 h-10 bg-yellow-400 rounded-lg"></button>
                    <button onclick="setTextColor('#FF0000')" class="w-10 h-10 bg-red-500 rounded-lg"></button>
                    <button onclick="setTextColor('#00FF00')" class="w-10 h-10 bg-green-500 rounded-lg"></button>
                    <button onclick="setTextColor('#00FFFF')" class="w-10 h-10 bg-cyan-400 rounded-lg"></button>
                    <button onclick="setTextColor('#FF00FF')" class="w-10 h-10 bg-pink-500 rounded-lg"></button>
                    <input type="color" id="customColor" value="#FFFFFF" onchange="setTextColor(this.value)"
                        class="w-10 h-10 rounded-lg cursor-pointer">
                </div>
                <p id="selectedColor" class="text-sm text-gray-500 mt-1">ì„ íƒ: #FFFFFF</p>
            </div>

            <button onclick="generateFinalThumbnail()" id="generateBtn" class="w-full btn-primary py-3">
                ğŸ¨ ì¸ë„¤ì¼ ìƒì„± (Gemini Imagen 3)
            </button>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì„ íƒëœ ë°°ê²½ ì´ë¯¸ì§€</label>
            <div id="selectedImagePreview"
                class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 flex items-center justify-center h-48">
                <span class="text-gray-500">ì•„ì´ë””ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
            </div>
        </div>
    </div>
</div>

<!-- 4ë‹¨ê³„: ê²°ê³¼ -->
<div id="resultSection" class="card hidden">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">4ï¸âƒ£ ìƒì„±ëœ ì¸ë„¤ì¼</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <img id="resultImage" src="" alt="Generated Thumbnail" class="w-full rounded-lg shadow-lg">
        </div>
        <div class="space-y-4">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <h4 class="font-medium text-gray-800 dark:text-white mb-2">ğŸ“ ì´ë¯¸ì§€ ì •ë³´</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">í¬ê¸°: 1280 x 720 (16:9)</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">í˜•ì‹: PNG</p>
            </div>
            <div class="flex gap-2">
                <a id="downloadLink" href="" download="thumbnail.png" class="flex-1 btn-primary text-center">
                    ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                </a>
                <button onclick="regenerate()" class="btn-secondary">
                    ğŸ”„ ë‹¤ì‹œ ìƒì„±
                </button>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                <h4 class="font-medium text-blue-800 dark:text-blue-300 mb-2">ğŸ’¡ íŒ</h4>
                <ul class="text-sm text-blue-700 dark:text-blue-400 space-y-1">
                    <li>â€¢ í…ìŠ¤íŠ¸ëŠ” 3-5ë‹¨ì–´ê°€ ìµœì </li>
                    <li>â€¢ ëŒ€ë¹„ê°€ ê°•í•œ ìƒ‰ìƒ ì‚¬ìš©</li>
                    <li>â€¢ ì–¼êµ´ì´ ìˆìœ¼ë©´ í´ë¦­ë¥  UP</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ìƒì„± ì´ë ¥ -->
    <div class="mt-6">
        <h4 class="font-medium text-gray-800 dark:text-white mb-3">ğŸ“œ ìƒì„± ì´ë ¥</h4>
        <div id="historyList" class="grid grid-cols-4 md:grid-cols-6 gap-2"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let thumbnailData = null;
    let selectedPrompt = null;
    let selectedTextColor = '#FFFFFF';
    let generatedHistory = [];
    let targetLang = 'ko'; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸

    // í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', async () => {
        const projectId = getCurrentProject();
        if (projectId) {
            try {
                // í”„ë¡œì íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì–¸ì–´ ì„¤ì •)
                const project = await API.project.get(projectId);
                if (project && project.target_language) {
                    targetLang = project.target_language;
                }

                // ë¶„ì„ ë°ì´í„°ì—ì„œ ì œëª© ê°€ì ¸ì˜¤ê¸°
                const analysis = await API.project.getAnalysis(projectId);
                if (analysis?.video_title) {
                    document.getElementById('videoTitle').value = analysis.video_title;
                }

                // ê¸°ì¡´ ì €ì¥ëœ ì¸ë„¤ì¼ URL ë¡œë“œ
                const settings = await API.project.getSettings(projectId);
                if (settings?.thumbnail_url) {
                    // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('resultImage').src = settings.thumbnail_url;
                    document.getElementById('downloadLink').href = settings.thumbnail_url;
                    document.getElementById('resultSection').classList.remove('hidden');
                    generatedHistory.unshift(settings.thumbnail_url);
                    updateHistory();
                }
            } catch (e) {
                console.log('í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
        }
    });

    // ìŠ¤íƒ€ì¼ ì„ íƒ í•¨ìˆ˜
    function selectThumbnailStyle(styleId) {
        document.getElementById('thumbnailStyle').value = styleId;

        // UI ì—…ë°ì´íŠ¸
        document.querySelectorAll('.style-card-thumb').forEach(card => {
            if (card.dataset.style === styleId) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }
        });

        console.log("Selected thumbnail style:", styleId);
    }

    // 1. ì•„ì´ë””ì–´ ìƒì„±
    async function generateIdeas() {
        const title = document.getElementById('videoTitle').value.trim() || 'ì˜ìƒ';
        const style = document.getElementById('thumbnailStyle').value;
        const color = document.getElementById('colorTone').value;

        // targetLangì€ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© (DOMContentLoadedì—ì„œ ì„¤ì •ë¨)

        const btn = document.getElementById('ideaBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        const langInstruction = targetLang === 'ja' ? 'ì¸ë„¤ì¼ í…ìŠ¤íŠ¸ í›„ë³´(texts)ëŠ” ë°˜ë“œì‹œ "ì¼ë³¸ì–´(Japanese)"ë¡œ ì‘ì„±í•˜ì„¸ìš”.' :
            targetLang === 'en' ? 'ì¸ë„¤ì¼ í…ìŠ¤íŠ¸ í›„ë³´(texts)ëŠ” ë°˜ë“œì‹œ "ì˜ì–´(English)"ë¡œ ì‘ì„±í•˜ì„¸ìš”.' :
                'ì¸ë„¤ì¼ í…ìŠ¤íŠ¸ í›„ë³´(texts)ëŠ” "í•œêµ­ì–´"ë¡œ ì‘ì„±í•˜ì„¸ìš”.';

        const prompt = `ìœ íŠœë¸Œ ì¸ë„¤ì¼ ë””ìì¸ ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í´ë¦­ë¥  ë†’ì€ ì¸ë„¤ì¼ ì•„ì´ë””ì–´ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

[ì˜ìƒ ì£¼ì œ]
${title}

[ìŠ¤íƒ€ì¼]
${style}
${style === 'japanese_viral' ? `
**SPECIAL STYLE INSTRUCTION (Japanese Viral):**
- Layout: Split screen or Text Overlay. Left 60% Text, Right 40% Image.
- Typography: Extremely bold, heavy sans-serif fonts. Colors: White, Red, Yellow. High contrast strokes/outlines.
- Imagery: Close-up, emotional face (elderly/shocked/crying/angry). Dark background.
- Vibe: Viral, provocative, "Shocking Truth", "Reality", "Documentary".
- Text Effects: Red/Yellow background highlights behind text.
` : ''}

[ìƒ‰ìƒ í†¤]
${color}

[ì–¸ì–´ ì„¤ì •]
${langInstruction}

JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:
{
    "ideas": [
        {
            "concept": "ì»¨ì…‰ ì„¤ëª… (1-2ë¬¸ì¥)",
            "layout": "ë ˆì´ì•„ì›ƒ ì„¤ëª…",
            "prompt_en": "Imagen 3ìš© ì˜ì–´ í”„ë¡¬í”„íŠ¸. ë°˜ë“œì‹œ ìƒì„¸í•˜ê²Œ ì‘ì„±. ì˜ˆ: A dramatic cinematic scene of ancient Chinese warrior general in golden armor, dark stormy background, epic lighting, professional photography, 8k quality"
        }
    ],
    "texts": ["ì¸ë„¤ì¼ í…ìŠ¤íŠ¸ í›„ë³´ 1 (3-5ë‹¨ì–´)", "í›„ë³´ 2", "í›„ë³´ 3", "í›„ë³´ 4", "í›„ë³´ 5"]
}

ideasëŠ” 3ê°œ ìƒì„±í•˜ì„¸ìš”. prompt_enì€ Imagen 3ì—ì„œ ì¢‹ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ë„ë¡ ìƒì„¸í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”. JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”.`;

        try {
            const result = await API.gemini.generate(prompt, { temperature: 0.8 });

            if (result.status === 'ok') {
                const jsonMatch = result.text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    thumbnailData = JSON.parse(jsonMatch[0]);
                    renderIdeas();
                    document.getElementById('ideasSection').classList.remove('hidden');
                }
            } else {
                Utils.showToast('ì•„ì´ë””ì–´ ìƒì„± ì‹¤íŒ¨', 'error');
            }
        } catch (error) {
            Utils.showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            console.error(error);
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    // ì•„ì´ë””ì–´ ë Œë”ë§
    function renderIdeas() {
        const container = document.getElementById('ideasList');
        container.innerHTML = thumbnailData.ideas.map((idea, i) => `
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 cursor-pointer hover:ring-2 hover:ring-primary transition" onclick="selectIdea(${i})">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-gray-800 dark:text-white">ì•„ì´ë””ì–´ ${i + 1}</span>
                    <button onclick="event.stopPropagation(); selectIdea(${i})" class="btn-primary text-xs">ì„ íƒ</button>
                </div>
                <p class="text-gray-600 dark:text-gray-400 mb-2">${idea.concept}</p>
                <p class="text-sm text-gray-500">ë ˆì´ì•„ì›ƒ: ${idea.layout}</p>
                <details class="mt-2">
                    <summary class="text-xs text-blue-500 cursor-pointer">í”„ë¡¬í”„íŠ¸ ë³´ê¸°</summary>
                    <code class="block bg-gray-900 text-green-400 p-2 rounded text-xs mt-2 overflow-x-auto">${idea.prompt_en}</code>
                </details>
            </div>
        `).join('');
    }

    // ì•„ì´ë””ì–´ ì„ íƒ
    function selectIdea(index) {
        selectedPrompt = thumbnailData.ideas[index].prompt_en;

        // í…ìŠ¤íŠ¸ ì„¹ì…˜ í‘œì‹œ
        document.getElementById('textSection').classList.remove('hidden');

        // í…ìŠ¤íŠ¸ í›„ë³´ í‘œì‹œ
        const textContainer = document.getElementById('textCandidates');
        textContainer.innerHTML = thumbnailData.texts.map(text => `
            <button onclick="selectText('${text.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 transition text-sm">
                ${text}
            </button>
        `).join('');

        // ì„ íƒëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        document.getElementById('selectedImagePreview').innerHTML = `
            <div class="text-center">
                <div class="text-4xl mb-2">ğŸ–¼ï¸</div>
                <p class="text-sm text-gray-600 dark:text-gray-400">ì•„ì´ë””ì–´ ${index + 1} ì„ íƒë¨</p>
                <p class="text-xs text-gray-500 mt-1">${thumbnailData.ideas[index].concept}</p>
            </div>
        `;

        Utils.showToast(`ì•„ì´ë””ì–´ ${index + 1} ì„ íƒë¨`, 'success');

        // ìŠ¤í¬ë¡¤
        document.getElementById('textSection').scrollIntoView({ behavior: 'smooth' });
    }

    // í…ìŠ¤íŠ¸ ì„ íƒ
    function selectText(text) {
        document.getElementById('thumbnailText').value = text;
    }

    // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì„¤ì •
    function setTextColor(color) {
        selectedTextColor = color;
        document.getElementById('selectedColor').textContent = `ì„ íƒ: ${color}`;
        document.getElementById('customColor').value = color;
    }

    // ìµœì¢… ì¸ë„¤ì¼ ìƒì„±
    async function generateFinalThumbnail() {
        if (!selectedPrompt) {
            Utils.showToast('ë¨¼ì € ì•„ì´ë””ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'warning');
            return;
        }

        const text = document.getElementById('thumbnailText').value.trim();
        const position = document.getElementById('textPosition').value;
        const fontSize = parseInt(document.getElementById('fontSize').value);

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘... (30ì´ˆ ì†Œìš”)');

        try {
            let result;

            if (text) {
                // í…ìŠ¤íŠ¸ í¬í•¨ ì¸ë„¤ì¼ ìƒì„±
                result = await API.image.generateThumbnail(selectedPrompt, text, {
                    textPosition: position,
                    textColor: selectedTextColor,
                    fontSize: fontSize,
                    language: targetLang // ì–¸ì–´ ì„¤ì • ì „ë‹¬
                });
            } else {
                // ì´ë¯¸ì§€ë§Œ ìƒì„±
                result = await API.image.generate(selectedPrompt, '16:9');
            }

            if (result.status === 'ok') {
                // ê²°ê³¼ í‘œì‹œ
                document.getElementById('resultImage').src = result.url;
                document.getElementById('downloadLink').href = result.url;
                document.getElementById('resultSection').classList.remove('hidden');

                // ì´ë ¥ ì¶”ê°€
                generatedHistory.unshift(result.url);
                updateHistory();

                Utils.showToast('ì¸ë„¤ì¼ ìƒì„± ì™„ë£Œ!', 'success');

                // í”„ë¡œì íŠ¸ì— ì €ì¥
                const projectId = getCurrentProject();
                if (projectId) {
                    // ì¸ë„¤ì¼ ì•„ì´ë””ì–´/í…ìŠ¤íŠ¸ ì €ì¥
                    await API.project.saveThumbnails(projectId, thumbnailData.ideas, thumbnailData.texts);
                    // ìƒì„±ëœ ì¸ë„¤ì¼ URL ì €ì¥ (í”„ë¡œì íŠ¸ ì„¤ì •ì—)
                    await API.project.updateSetting(projectId, 'thumbnail_url', result.url);
                    console.log('ì¸ë„¤ì¼ URL ì €ì¥ë¨:', result.url);
                }

                // ìŠ¤í¬ë¡¤
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            } else {
                Utils.showToast(result.error || 'ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨', 'error');
            }
        } catch (error) {
            Utils.showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            console.error(error);
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    // ì´ë ¥ ì—…ë°ì´íŠ¸
    function updateHistory() {
        const container = document.getElementById('historyList');
        container.innerHTML = generatedHistory.slice(0, 12).map((url, i) => `
            <a href="${url}" download="thumbnail_${i}.png" class="block">
                <img src="${url}" alt="History ${i}" class="w-full h-16 object-cover rounded-lg hover:ring-2 hover:ring-primary transition">
            </a>
        `).join('');
    }

    // ë‹¤ì‹œ ìƒì„±
    function regenerate() {
        generateFinalThumbnail();
    }
</script>
{% endblock %}