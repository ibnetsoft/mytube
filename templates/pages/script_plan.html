{% extends "base.html" %}

{% block content %}


<!-- Grid Layout: Left (Analysis + Settings) / Right (Result) -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 section-spacing">

    <!-- LEFT COLUMN (Analysis & Settings) -->
    <div class="lg:col-span-4 space-y-6">

        <!-- 1. Analysis Data (Moved here) -->
        <div id="analysisInfo" class="card hidden w-full">
            <h3 class="card-title">ğŸ“Š ë¶„ì„ ë°ì´í„° ê¸°ë°˜</h3>
            <div id="analysisContent"></div>
        </div>

        <!-- 2. Script Settings (Moved to below Analysis used to be on right) -->
        <div class="card w-full">
            <h3 class="card-title">âš™ï¸ ëŒ€ë³¸ ì„¤ì •</h3>
            <!-- Changed grid to single column for narrower width -->
            <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì˜ìƒ ì£¼ì œ</label>
                    <input type="text" id="topicInput" class="input-field" placeholder="ì˜ˆ: ì´ˆë³´ìë¥¼ ìœ„í•œ íŒŒì´ì¬ ê°•ì˜">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì˜ìƒ ê¸¸ì´</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="durationInput" class="input-field w-32" value="60" min="1" step="1">
                        <span id="durationUnit" class="text-gray-700 dark:text-gray-300">ë¶„</span>
                    </div>
                    <p id="durationHelper" class="text-xs text-gray-500 mt-1">ê¸°ë³¸ê°’: 60ë¶„</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ëŒ€ë³¸ ìŠ¤íƒ€ì¼</label>
                    <select id="scriptStyleSelect" class="input-field">
                        <optgroup label="ğŸ“¹ ê¸°ë³¸ ìŠ¤íƒ€ì¼">
                            <option value="default" selected>ê¸°ë³¸ ì„¤ì • (ìì—°ìŠ¤ëŸ½ê³  ì„ ëª…í•œ ìŠ¤íƒ€ì¼)</option>
                            <option value="news">ë‰´ìŠ¤ ë³´ë„ (News Delivery)</option>
                            <option value="story">ì˜›ë‚  ì´ì•¼ê¸° (Old Story)</option>
                            <option value="senior_story">ì‹œë‹ˆì–´ ì‚¬ì—° (Senior Story)</option>
                            <option value="bgm">ë°°ê²½ìŒì•… ì¤‘ì‹¬ (BGM Focus)</option>
                        </optgroup>
                        <optgroup label="ğŸ¬ ì‹œëŒ€ë³„ ì˜í™” ìŠ¤íƒ€ì¼">
                            <option value="classic_50s">50ë…„ëŒ€ í´ë˜ì‹ì˜í™” (í…Œí¬ë‹ˆì»¬ëŸ¬, ë¶€ë“œëŸ¬ìš´ ì¡°ëª…)</option>
                            <option value="joseon_sageuk">ì¡°ì„ ì‹œëŒ€ ì‚¬ê·¹ (ì „í†µ ê±´ì¶•/ì˜ë³µ, ìì—°ê´‘)</option>
                            <option value="north_korean_drama">ë¶í•œ ë“œë¼ë§ˆ (ë¹ˆí‹°ì§€ ì˜í™”, ê°•ë ¬í•œ ìƒ‰ê°)</option>
                            <option value="silent_20s">20ë…„ëŒ€ ë¬´ì„±ì˜í™” (í‘ë°±, ë†’ì€ ì½˜íŠ¸ë¼ìŠ¤íŠ¸, ë¹ˆí‹°ì§€ ê·¸ë ˆì¸)</option>
                            <option value="camcorder_90s">90ë…„ëŒ€ ìº ì½”ë” (VHS í™”ì§ˆ, ë‚®ì€ í”„ë ˆì„)</option>
                            <option value="modern_drama">í˜„ëŒ€ ë“œë¼ë§ˆ (ìê¸€ìê¸€í•œ í™”ì§ˆ, ìì—°ìŠ¤ëŸ¬ìš´ ìƒ‰ê°)</option>
                        </optgroup>
                        <optgroup label="ğŸ­ ì¥ë¥´ë³„ ìŠ¤íƒ€ì¼">
                            <option value="mystery_thriller">ë¯¸ìŠ¤í„°ë¦¬ ìŠ¤ë¦´ëŸ¬ (ì €ì¡°ë„, ì˜ì‚¬ê¸° í†¤, ìŒì˜ ê·¸ë¦¼ì)</option>
                            <option value="horror_suspense">ê³µí¬-ì„œìŠ¤íœìŠ¤ (ì–´ë‘ìš´ ì¡°ëª…, ìŒì¹¨ ë¶„ìœ„ê¸°)</option>
                            <option value="melodrama">ë©œë¡œë“œë¼ë§ˆ (ë¶€ë“œëŸ¬ìš´ ì½˜íŠ¸ë¼ìŠ¤íŠ¸, ë”°ëœ»í•˜ê³  í™”ì‚¬í•¨)</option>
                            <option value="crime_drama">ë²”ì£„ ë“œë¼ë§ˆ (ì°¨ê°‘ê³  ì–´ë‘ìš´ í™”ì§ˆ, ë‚®ì€ ì±„ë„)</option>
                            <option value="cyberpunk_neon">ì‚¬ì´ë²„í‘í¬ ë„¤ì˜¨ (ë„¤ì˜¨ ìƒ‰ìƒ, ë¹„, ë¯¸ë˜ì  ë¶„ìœ„ê¸°)</option>
                        </optgroup>
                        <optgroup label="ğŸ“º ìºë¦­í„°/ì›¹íˆ° ì‹œë¦¬ì¦ˆ">
                            <option value="wimpy_kid">ìœ”í”¼í‚¤ë“œ (ì´ˆë“±í•™ìƒ ì¼ê¸°ì¥ ìŠ¤íƒ€ì¼)</option>
                        </optgroup>
                        <optgroup label="ğŸ¨ ì¼ëŸ¬ìŠ¤íŠ¸/ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼">
                            <option value="watercolor_analog">ìˆ˜ì±„í™”í’ ì•„ë‚ ë¡œê·¸ ì¼ëŸ¬ìŠ¤íŠ¸ (ê°ì„±ì  ìˆ˜ì±„í™” í…ìŠ¤ì²˜)</option>
                            <option value="digital_webtoon">ë””ì§€í„¸ ì›¹íˆ° (ì„ ëª…í•œ ë¼ì¸, í™”ë ¤í•œ ìƒ‰ê°)</option>
                            <option value="graphite_sketch">í‘ì—° ë“œë¡œì‰ ìŠ¤ì¼€ì¹˜ (ê±°ì¹œ ì—°í•„ì„  ìŠ¤ì¼€ì¹˜)</option>
                            <option value="joseon_2d_anime">ì¡°ì„ ì‹œëŒ€ í’ì†í™” 2D ì• ë‹ˆ (ì¡°ì„  ì›¹íˆ° ìŠ¤íƒ€ì¼)</option>
                            <option value="oriental_ink">ë™ì–‘ ìˆ˜ë¬µí™” ëª¨ë…¸í¬ë¡¬ (ì—¬ë°±ì˜ ë¯¸, ë¨¹ë¬¼ ê·¸ë¦¼)</option>
                            <option value="neonsign_citypop">ë„¤ì˜¨ì‚¬ì¸ ì‹œí‹°íŒ (80ë…„ëŒ€ ë ˆíŠ¸ë¡œ í“¨ì²˜, í™”ë ¤í•œ ì•¼ê²½)</option>
                            <option value="buddhist_minimal">ë¶ˆêµ ë¯¸ë‹ˆë©€ë¦¬ì¦˜ (í•œêµ­ ì‚¬ì°°, ë¶ˆìƒ, í¬í† ë¦¬ì–¼ë¦¬ì¦˜)</option>
                            <option value="renaissance_sacred">ë¥´ë„¤ìƒìŠ¤ ì„±í™” (ì„±ê²½ ì¸ë¬¼ ì„±í™”í’, í˜„ëŒ€ì¸ ì‹¤ì‚¬í’)</option>
                            <option value="cute_animal_char">ê·€ì—¬ìš´ ë™ë¬¼ ìºë¦­í„° (ì˜ì¸í™”ëœ ë™ë¬¼ ì›¹íˆ° ì¼ëŸ¬ìŠ¤íŠ¸)</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ì¶”ê°€ ìš”ì²­ì‚¬í•­</label>
                <textarea id="additionalNotes" class="input-field" rows="2"
                    placeholder="íŠ¹ë³„íˆ í¬í•¨í•˜ê³  ì‹¶ì€ ë‚´ìš©ì´ë‚˜ ìŠ¤íƒ€ì¼ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
            </div>

            <!-- ìƒì„± ë²„íŠ¼ -->
            <div class="flex flex-col gap-2 mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                <button onclick="saveScriptSettings(this)"
                    class="btn-secondary w-full py-2 text-xs flex items-center justify-center gap-2">
                    <span>ğŸ’¾</span>
                    <span>ì„¸íŒ…ì €ì¥</span>
                </button>
                <button onclick="generateStructure()" id="generateBtn"
                    class="btn-primary w-full py-3 text-sm font-semibold shadow-sm hover:shadow-md transition-all rounded-lg flex items-center justify-center gap-2">
                    <span>ğŸ¤–</span>
                    <span>ëŒ€ë³¸ êµ¬ì¡° ìƒì„±</span>
                </button>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN (Script Structure Result) -->
    <div class="lg:col-span-8">
        <!-- ê²°ê³¼ ì˜ì—­ (Initially Hidden) -->
        <div id="resultSection" class="hidden">
            <div class="card h-full">
                <div class="flex items-center justify-between mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
                    <h3 class="card-title mb-0">ğŸ“ ìƒì„±ëœ ëŒ€ë³¸ êµ¬ì¡°</h3>
                    <!-- Buttons Group (Moved 'Generate Script' here) -->
                    <div class="btn-group flex gap-2">
                        <button onclick="copyStructure()"
                            class="btn-secondary text-xs px-3 py-1.5 flex items-center gap-1">
                            <span>ğŸ“‹</span> ë³µì‚¬
                        </button>
                        <button onclick="regenerate()"
                            class="btn-secondary text-xs px-3 py-1.5 flex items-center gap-1">
                            <span>ğŸ”„</span> ë‹¤ì‹œ ìƒì„±
                        </button>
                        <!-- Moved Main Action Button Here -->
                        <button onclick="goToScriptGen()"
                            class="btn-primary text-xs px-4 py-1.5 font-bold shadow-sm hover:shadow-md transition-all rounded flex items-center gap-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                            <span>âœï¸</span>
                            <span>ì „ì²´ ëŒ€ë³¸ ìƒì„±í•˜ê¸°</span>
                            <span>â†’</span>
                        </button>
                    </div>
                </div>
                <div id="structureContent" class="prose dark:prose-invert max-w-none"></div>
            </div>
        </div>

        <!-- Placeholder when hidden (Optional, to keep layout structure if needed, or just let it be empty) -->
        <div id="resultPlaceholder"
            class="hidden h-full flex items-center justify-center p-10 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl text-gray-400">
            <div class="text-center">
                <span class="text-4xl block mb-2">ğŸ‘ˆ</span>
                <p>ì™¼ìª½ì—ì„œ ì„¤ì •ì„ ì™„ë£Œí•˜ê³ <br>'ëŒ€ë³¸ êµ¬ì¡° ìƒì„±'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStructure = '';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    document.addEventListener('DOMContentLoaded', async () => {
        // í”„ë¡œì íŠ¸ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ -> data reloading
        window.addEventListener('projectChanged', (e) => loadProjectData(e.detail.projectId));

        // [MODIFIED] Check URL for project_id override
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get('project_id');

        let projectId = null;
        if (urlProjectId) {
            projectId = parseInt(urlProjectId);
            setCurrentProject(projectId); // Update global state/localStorage
        } else {
            projectId = getCurrentProject();
        }

        if (projectId) {
            await loadProjectData(projectId);
        }

        // [STRONG OVERRIDE] URLì—ì„œ ì „ë‹¬ëœ topicì´ ìˆë‹¤ë©´ ë¬´ì¡°ê±´ ì…ë ¥ì°½ì— ì ìš© (DB ê°’ë³´ë‹¤ ìš°ì„ )
        const urlTopic = urlParams.get('topic');
        if (urlTopic) {
            console.log("[Force Topic] URL Parameter found:", urlTopic);
            document.getElementById('topicInput').value = decodeURIComponent(urlTopic);
            // ë§Œì•½ APIë¡œ í”„ë¡œì íŠ¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ë”ë¼ë„, ì‚¬ìš©ìê°€ ë°©ê¸ˆ ê²€ìƒ‰í•œ í‚¤ì›Œë“œê°€ ë” ì¤‘ìš”í•˜ë¯€ë¡œ ë®ì–´ì”€
        }

        // [NEW] Check App Mode
        try {
            const res = await fetch('/api/settings');
            const settings = await res.json();
            window.APP_MODE = settings.app_mode || 'longform';

            if (window.APP_MODE === 'shorts') {
                document.getElementById('durationUnit').innerText = 'ì´ˆ';
                document.getElementById('durationInput').value = 60;
                document.getElementById('durationHelper').innerText = 'ê¸°ë³¸ê°’: 60ì´ˆ (ì‡¼ì¸  ê¶Œì¥)';
                document.getElementById('durationInput').max = 60;

                // Add badge
                const title = document.querySelector('.card-title');
                if (title) {
                    const badge = document.createElement('span');
                    badge.className = "ml-2 text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full";
                    badge.innerText = "Shorts";
                    title.appendChild(badge);
                }
            }
        } catch (e) { console.error(e); }

        // ìë™ ìƒì„± ìš”ì²­ í™•ì¸
        if (urlParams.get('auto') === 'true') {
            // [Fix] Remove 'auto' param immediately to prevent re-run on refresh
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.delete('auto');
            window.history.replaceState({}, document.title, newUrl.toString());

            setTimeout(async () => {
                Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤...', 'info');

                // [Robust] Ensure topic is passed
                let topic = document.getElementById('topicInput').value;
                if (!topic && projectId) {
                    console.warn("[AutoStart] Topic input empty, attempting fetch from DB...");
                    try {
                        // 1. Try Simple Get
                        let p = await API.project.get(projectId);
                        if (p && p.topic) {
                            topic = p.topic;
                            console.log("[AutoStart] Topic recovered from SimpleGet:", topic);
                        } else {
                            // 2. Try Full Get
                            const full = await API.project.getFull(projectId);
                            if (full.project && full.project.topic) {
                                topic = full.project.topic;
                                console.log("[AutoStart] Topic recovered from FullGet:", topic);
                            }
                        }
                    } catch (e) { console.error("Auto-start topic fetch failed:", e); }
                } else {
                    console.log("[AutoStart] Using topic from input:", topic);
                }

                generateStructure(topic);
            }, 500);
        }
    });

    // ìƒíƒœ ë³µêµ¬ ì™„ë£Œ ì‹œ UI ì—…ë°ì´íŠ¸
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data.project) {
            if (data.project.topic) document.getElementById('topicInput').value = data.project.topic;
        }

        if (data.settings) {
            const s = data.settings;
            if (s.duration_seconds !== undefined && s.duration_seconds !== null) {
                const val = (window.APP_MODE === 'shorts') ? s.duration_seconds : Math.floor(s.duration_seconds / 60);
                document.getElementById('durationInput').value = val;
            }
            if (s.script_style) {
                document.getElementById('scriptStyleSelect').value = s.script_style;
            }
        }

        if (data) {
            renderAnalysisSection(data);
        }

        if (data.script_structure) {
            currentStructure = data.script_structure;
            renderStructure(data.script_structure);
        }
    });

    async function loadProjectData(projectId) {
        if (!projectId) return;

        try {
            // [MODIFIED] Fetch Full Data to get both Analysis and Settings (Thumbnail)
            const fullData = await API.project.getFull(projectId);
            console.log("Full Data:", fullData);

            if (fullData) {
                if (fullData.project && fullData.project.topic) {
                    document.getElementById('topicInput').value = fullData.project.topic;
                    console.log("[LoadProjectData] Topic populated:", fullData.project.topic);
                }

                const s = fullData.settings || {};
                if (s.duration_seconds) {
                    const val = (window.APP_MODE === 'shorts') ? s.duration_seconds : Math.floor(s.duration_seconds / 60);
                    document.getElementById('durationInput').value = val;
                }
                if (s.script_style) {
                    document.getElementById('scriptStyleSelect').value = s.script_style;
                }

                renderAnalysisSection(fullData);

                // [NEW] Target Language
                const settings = fullData.settings || {};
                if (fullData.project && fullData.project.target_language) {
                    currentTargetLanguage = fullData.project.target_language;
                } else if (settings.target_language) {
                    currentTargetLanguage = settings.target_language;
                }
            }

            // Load existing structure (Separate fetch as per legacy logic, usually structure is large)
            try {
                const structData = await API.project.getScriptStructure(projectId);
                console.log("[DEBUG] structData from API:", structData);

                // Show result section if we have ANY data (hook, sections, cta, etc.)
                // Even if sections is empty, we want to show the placeholder message
                if (structData && (structData.sections || structData.hook)) {
                    currentStructure = structData;
                    renderStructure(structData);
                    document.getElementById('resultSection').classList.remove('hidden');
                    Utils.storage.set('scriptStructure', structData);
                } else {
                    console.log("[DEBUG] No structure found or empty response");
                }
            } catch (e) {
                console.error("Failed to load script structure:", e);
            }

        } catch (e) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            Utils.showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
        }
    }

    function renderAnalysisSection(fullData) {
        const analysis = fullData.analysis || {};
        const settings = fullData.settings || {};

        const hasAnalysis = analysis.video_title;
        const hasThumbnail = settings.thumbnail_url;

        // Note: We check if there's ANYTHING to show. 
        // If analysis is missing but we have thumbnail, we still show the section.
        if (hasAnalysis || hasThumbnail) {
            document.getElementById('analysisInfo').classList.remove('hidden');

            // If topic input is empty, maybe fill it from analysis? 
            // Logic moved to loadProjectData to be safer (prefer project.topic)
            if (analysis.video_title && !document.getElementById('topicInput').value) {
                // document.getElementById('topicInput').value = analysis.video_title; 
                // Kept commented out as per previous logic to strictly use project.topic
            }

            let html = '<div class="flex flex-col md:flex-row gap-6">';

            // Left: Analysis Data (Source)
            if (hasAnalysis) {
                html += `
                    <div class="flex-1 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700">
                        <h4 class="text-xs font-bold text-gray-500 mb-2">ğŸ“º ì›ë³¸ ì˜ìƒ ë¶„ì„</h4>
                        <div class="flex gap-4 items-center">
                            <img src="${analysis.thumbnail_url}" class="w-24 h-16 object-cover rounded bg-black">
                            <div class="min-w-0">
                                <p class="font-medium text-sm text-gray-800 dark:text-white truncate" title="${analysis.video_title}">${analysis.video_title}</p>
                                <p class="text-xs text-gray-500">${analysis.channel_title}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Optional: Show empty state for analysis if needed, but usually we just skip.
                // For balance, if we have thumbnail but no analysis (rare), we could leave left side empty?
                // Let's just render what we have.
            }

            // Right: Generated Thumbnail (My Project)
            if (hasThumbnail) {
                html += `
                    <div class="flex-1 bg-blue-50 dark:bg-blue-900/10 p-3 rounded-lg border border-blue-100 dark:border-blue-900/30">
                        <h4 class="text-xs font-bold text-blue-600 dark:text-blue-400 mb-2">ğŸ¨ ë‚´ ì¸ë„¤ì¼ (ìƒì„±ë¨)</h4>
                        <div class="flex gap-4 items-center">
                            <img src="${settings.thumbnail_url}" class="w-24 h-16 object-cover rounded bg-black cursor-pointer hover:opacity-90" onclick="window.open('${settings.thumbnail_url}', '_blank')">
                            <div class="min-w-0">
                                <p class="font-medium text-sm text-gray-800 dark:text-white truncate">ë©”ì¸ ì¸ë„¤ì¼</p>
                                <p class="text-xs text-gray-500">í´ë¦­í•˜ì—¬ í¬ê²Œ ë³´ê¸°</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Placeholder
                html += `
                    <div class="flex-1 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700 dashed-border flex items-center justify-center text-gray-400 text-xs">
                        <span>ì¸ë„¤ì¼ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤</span>
                    </div>
                `;
            }

            html += '</div>';
            document.getElementById('analysisContent').innerHTML = html;
        }
    }


    // [NEW] ì „ì—­ ë³€ìˆ˜ë¡œ íƒ€ê²Ÿ ì–¸ì–´ ê´€ë¦¬
    let currentTargetLanguage = 'ko';

    async function saveScriptSettings(btn) {
        const projectId = getCurrentProject();
        if (!projectId) return;

        const originalText = btn.innerHTML;
        Utils.setLoading(btn, true, 'ì €ì¥ ì¤‘...');

        try {
            const topic = document.getElementById('topicInput').value.trim();
            const durationVal = parseInt(document.getElementById('durationInput').value) || 60;
            let durationSeconds = (window.APP_MODE === 'shorts') ? durationVal : durationVal * 60;
            const scriptStyle = document.getElementById('scriptStyleSelect').value;

            // 1. Update project topic (projects table)
            await API.project.update(projectId, { topic: topic });

            // 2. Update settings (project_settings table)
            const result = await API.project.saveSettings(projectId, {
                duration_seconds: durationSeconds,
                script_style: scriptStyle
            });

            if (result.status === 'ok') {
                Utils.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
        } finally {
            Utils.setLoading(btn, false);
            btn.innerHTML = originalText;
        }
    }

    async function generateStructure(passedTopic = null) {
        let topic = passedTopic || document.getElementById('topicInput').value.trim();

        // Update UI if passedTopic was used
        if (passedTopic) {
            document.getElementById('topicInput').value = passedTopic;
        }

        // [Safety Check] If topic is empty (e.g. auto start race condition), try fetching from DB directly
        if (!topic && getCurrentProject()) {
            try {
                const p = await API.project.get(getCurrentProject());
                if (p && p.topic) {
                    topic = p.topic;
                    document.getElementById('topicInput').value = topic;
                }
            } catch (e) { console.error("Topic fetch failed", e); }
        }

        if (!topic) {
            Utils.showToast('ì˜ìƒ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        // ë¶„ ë‹¨ìœ„ ì…ë ¥ -> ì´ˆ ë‹¨ìœ„ ë³€í™˜ (Longform) / ì´ˆ ë‹¨ìœ„ ìœ ì§€ (Shorts)
        const durationVal = parseInt(document.getElementById('durationInput').value) || 60;
        let duration = durationVal * 60; // Default Longform (min -> sec)

        if (window.APP_MODE === 'shorts') {
            duration = durationVal; // Shorts (sec -> sec)
        }
        const tone = "professional"; // Simplified or removed if not needed, as style prompt covers it.
        const scriptStyle = document.getElementById('scriptStyleSelect').value;
        const notes = document.getElementById('additionalNotes').value;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        try {
            const projectId = getCurrentProject();

            const response = await fetch('/api/gemini/generate-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    project_id: projectId,
                    topic,
                    duration,
                    tone,
                    notes: notes || '',
                    target_language: currentTargetLanguage,
                    script_style: scriptStyle
                })
            });

            const text = await response.text();
            console.log("Raw Response:", text);
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                console.error("JSON Parse Error:", e);
                Utils.showToast('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (JSON íŒŒì‹± ì‹¤íŒ¨): ' + text.substring(0, 50), 'error');
                Utils.setLoading(btn, false);
                return;
            }

            if (result.status === 'ok') {
                const structureData = result.structure;
                // [NEW] ê¸°íš ë‹¨ê³„ì—ì„œ ì„ íƒí•œ ìŠ¤íƒ€ì¼ì„ êµ¬ì¡° ë°ì´í„°ì— í¬í•¨í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬
                structureData.script_style = scriptStyle;

                currentStructure = structureData;
                renderStructure(structureData);
                document.getElementById('resultSection').classList.remove('hidden');
                // Hide placeholder
                const placeholder = document.getElementById('resultPlaceholder');
                if (placeholder) placeholder.classList.add('hidden');

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì¦‰ì‹œ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ ì´ë™ìš©)
                // project_id ëª…ì‹œì  ì¶”ê°€
                const projectId = getCurrentProject();
                if (projectId) structureData.project_id = projectId;

                Utils.storage.set('scriptStructure', structureData);

                // DB ì €ì¥
                if (projectId) {
                    try {
                        // 1. í”„ë¡œì íŠ¸ ì£¼ì œ & ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                        await API.project.update(projectId, { topic: topic, script_style: scriptStyle });

                        // 2. êµ¬ì¡° ì €ì¥
                        await API.project.saveScriptStructure(projectId, {
                            hook: structureData.hook,
                            sections: structureData.sections,
                            cta: structureData.cta,
                            style: structureData.style,
                            duration: duration // Use the user-intended duration (already in seconds)
                        });
                        Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        API.project.update(projectId, { status: 'planned' });
                        // [NEW] Update Stepper
                        if (window.updateStepStatus) window.updateStepStatus('plan', true);
                    } catch (e) { console.error('DB ì €ì¥ ì‹¤íŒ¨:', e); }
                }
            } else {
                Utils.showToast('ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('ìƒì„± ì˜¤ë¥˜:', error);
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderStructure(data) {
        const container = document.getElementById('structureContent');
        if (!data || !data.sections || data.sections.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 text-gray-400">
                    <div class="text-4xl mb-3">ğŸ“­</div>
                    <p>ìƒì„±ëœ ëŒ€ë³¸ êµ¬ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm mt-1">ìš°ì¸¡ ìƒë‹¨ì˜ [ğŸ”„ ë‹¤ì‹œ ìƒì„±] ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>
                </div>
            `;
            return;
        }

        let html = `<div class="space-y-6">`;

        // 1. Hook
        html += `
            <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900/50">
                <h4 class="font-bold text-red-600 dark:text-red-400 mb-2">ğŸª í›„í‚¹ (Hook)</h4>
                <p class="text-gray-800 dark:text-gray-200 text-lg font-medium">"${data.hook || 'ë‚´ìš© ì—†ìŒ'}"</p>
            </div>
        `;

        // 2. Sections
        if (data.sections && data.sections.length > 0) {
            html += `<div class="space-y-4">`;
            data.sections.forEach((section, index) => {
                html += `
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded text-xs font-bold">Scene ${index + 1}</span>
                            <h5 class="font-bold text-gray-800 dark:text-white">${section.title}</h5>
                        </div>
                        <ul class="list-disc list-inside space-y-1 ml-1">
                            ${(section.key_points || []).map(point => `
                                <li class="text-gray-700 dark:text-gray-300 text-sm">${point}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            html += `</div>`;
        }

        // 3. CTA
        html += `
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-900/50">
                <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">ğŸ“¢ CTA (í–‰ë™ ìœ ë„)</h4>
                <p class="text-gray-800 dark:text-gray-200">"${data.cta}"</p>
            </div>
        `;

        // 4. Info (Style, Duration)
        html += `
            <div class="flex gap-4 text-sm text-gray-500 dark:text-gray-400 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <span>ğŸ¨ ìŠ¤íƒ€ì¼: ${data.style || '-'}</span>
                <span>â±ï¸ ì˜ˆìƒ ê¸¸ì´: ${data.duration || 0}ì´ˆ</span>
            </div>
        `;

        html += `</div>`;
        container.innerHTML = html;
    }

    function copyStructure() {
        if (!currentStructure) {
            Utils.showToast('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        const text = formatStructureToString(currentStructure);
        Utils.copyToClipboard(text);
        Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function formatStructureToString(data) {
        let text = '';

        // Hook
        if (data.hook) text += `ğŸª í›„í‚¹ (Hook)\n"${data.hook}"\n\n`;

        // Sections
        if (data.sections && data.sections.length > 0) {
            data.sections.forEach((section, index) => {
                text += `Scene ${index + 1}: ${section.title}\n`;
                if (section.key_points) {
                    section.key_points.forEach(point => {
                        text += `- ${point}\n`;
                    });
                }
                text += '\n';
            });
        }

        // CTA
        if (data.cta) text += `ğŸ“¢ CTA (í–‰ë™ ìœ ë„)\n"${data.cta}"\n\n`;

        // Style & Duration
        if (data.style) text += `ğŸ¨ ìŠ¤íƒ€ì¼: ${data.style}\n`;
        if (data.duration) text += `â±ï¸ ì˜ˆìƒ ê¸¸ì´: ${data.duration}ì´ˆ\n`;

        return text;
    }

    function regenerate() {
        generateStructure();
    }

    function goToScriptGen() {
        const projectId = getCurrentProject();
        if (projectId) {
            window.location.href = `/script-gen?project_id=${projectId}&auto_start=true`;
        } else {
            // í”„ë¡œì íŠ¸ IDê°€ ì—†ì„ ê²½ìš° ê·¸ëƒ¥ ì´ë™ (í˜¹ì€ ì—ëŸ¬ ì²˜ë¦¬)
            window.location.href = '/script-gen';
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}