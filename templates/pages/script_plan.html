{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ“‹</span>
        <div>
            <h1>ëŒ€ë³¸ ê¸°íš</h1>
            <p>ë¶„ì„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€ë³¸ êµ¬ì¡°ë¥¼ ì„¤ê³„í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- ë¶„ì„ ë°ì´í„° í‘œì‹œ -->
<div id="analysisInfo" class="card mb-6 hidden">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“Š ë¶„ì„ ë°ì´í„° ê¸°ë°˜</h3>
    <div id="analysisContent"></div>
</div>

<!-- ëŒ€ë³¸ ì„¤ì • -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ ëŒ€ë³¸ ì„¤ì •</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒ ì£¼ì œ</label>
            <input type="text" id="topicInput" class="input-field" placeholder="ì˜ˆ: ì´ˆë³´ìë¥¼ ìœ„í•œ íŒŒì´ì¬ ê°•ì˜">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒ ê¸¸ì´</label>
            <div class="flex items-center gap-2">
                <input type="number" id="durationInput" class="input-field w-32" value="60" min="1" step="1">
                <span class="text-gray-700 dark:text-gray-300">ë¶„</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">ê¸°ë³¸ê°’: 60ë¶„ (ëŒ€ë³¸ ê¸¸ì´ ê¸°ì¤€)</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í†¤ì•¤ë§¤ë„ˆ</label>
            <select id="toneSelect" class="input-field">
                <option value="friendly">ì¹œê·¼í•œ</option>
                <option value="professional">ì „ë¬¸ì ì¸</option>
                <option value="humorous">ìœ ë¨¸ëŸ¬ìŠ¤í•œ</option>
                <option value="educational">êµìœ¡ì ì¸</option>
            </select>
        </div>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì¶”ê°€ ìš”ì²­ì‚¬í•­</label>
        <textarea id="additionalNotes" class="input-field" rows="3"
            placeholder="íŠ¹ë³„íˆ í¬í•¨í•˜ê³  ì‹¶ì€ ë‚´ìš©ì´ë‚˜ ìŠ¤íƒ€ì¼ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
    </div>
</div>

<!-- ìŠ¤íƒ€ì¼ ì„¤ì • (ì¼ê´€ì„± ìœ ì§€) -->
<div class="card mb-6 border-l-4 border-purple-500">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ¨ ìŠ¤íƒ€ì¼ ì„¤ì • (ì¼ê´€ì„± ìœ ì§€)</h3>
    <p class="text-xs text-gray-500 mb-4">ì˜ìƒ ì „ì²´ì— ì ìš©ë  ìŠ¤íƒ€ì¼ì„ ì§€ì •í•˜ì„¸ìš”. ì´ë¯¸ì§€, ìë§‰ ë“±ì´ ì´ ì„¤ì •ì„ ë”°ë¦…ë‹ˆë‹¤.</p>

    <div class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸</label>
            <input type="text" id="imageStyleInput" class="input-field"
                placeholder="ì˜ˆ: 3D Pixar style, cute character, bright lighting">
            <p class="text-xs text-gray-400 mt-1">ëª¨ë“  ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ì— ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ìë§‰ í°íŠ¸</label>
                <select id="subtitleFontSelect" class="input-field">
                    <option value="Malgun-Gothic-Bold">ë§‘ì€ ê³ ë”• (ê¸°ë³¸)</option>
                    <option value="CookieRun Regular">ì¿ í‚¤ëŸ° (ê·€ì—¬ì›€)</option>
                    <option value="GmarketSansBold">Gë§ˆì¼“ ì‚°ìŠ¤ (ê¹”ë”í•¨)</option>
                    <option value="NanumMyeongjo">ë‚˜ëˆ”ëª…ì¡° (ê°ì„±)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ìë§‰ ìƒ‰ìƒ</label>
                <select id="subtitleColorSelect" class="input-field">
                    <option value="white">í°ìƒ‰ (ê¸°ë³¸)</option>
                    <option value="yellow">ë…¸ë‘ (ê°•ì¡°)</option>
                    <option value="#FFD700">ê³¨ë“œ</option>
                    <option value="#00FF00">ë¼ì„</option>
                    <option value="#FF00FF">í•‘íŠ¸</option>
                    <option value="black">ê²€ì •</option>
                </select>
            </div>
        </div>

        <div class="flex justify-end">
            <button onclick="saveStyleSettings()" class="btn-secondary text-sm px-4 py-2">
                ğŸ’¾ ìŠ¤íƒ€ì¼ ì €ì¥
            </button>
        </div>
    </div>
</div>

<!-- ìƒì„± ë²„íŠ¼ -->
<button onclick="generateStructure()" id="generateBtn"
    class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg mb-6">
    <span>ğŸ¤–</span>
    <span>ëŒ€ë³¸ êµ¬ì¡° ìƒì„±í•˜ê¸°</span>
</button>

<!-- ê²°ê³¼ ì˜ì—­ -->
<div id="resultSection" class="hidden">
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800 dark:text-white">ğŸ“ ìƒì„±ëœ ëŒ€ë³¸ êµ¬ì¡°</h3>
            <div class="flex gap-2">
                <button onclick="copyStructure()" class="btn-secondary text-sm">ğŸ“‹ ë³µì‚¬</button>
                <button onclick="regenerate()" class="btn-secondary text-sm">ğŸ”„ ë‹¤ì‹œ ìƒì„±</button>
            </div>
        </div>
        <div id="structureContent" class="prose dark:prose-invert max-w-none"></div>

        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <button onclick="goToScriptGen()"
                class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg">
                <span>âœï¸</span>
                <span>ì „ì²´ ëŒ€ë³¸ ìƒì„±í•˜ê¸°</span>
                <span>â†’</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStructure = '';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    document.addEventListener('DOMContentLoaded', async () => {
        // í”„ë¡œì íŠ¸ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ -> data reloading
        window.addEventListener('projectChanged', (e) => loadProjectData(e.detail.projectId));

        // ì´ˆê¸° ë¡œë“œ
        const projectId = getCurrentProject();
        if (projectId) {
            await loadProjectData(projectId);
        }

        // ìë™ ìƒì„± ìš”ì²­ í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auto') === 'true') {
            // ë°ì´í„° ë¡œë“œê°€ ì™„ë£Œëœ í›„ ì‹¤í–‰ë˜ì–´ì•¼ í•¨ (ìœ„ await loadProjectDataë¡œ ë³´ì¥)
            // ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ì£¼ì–´ UIê°€ ì•ˆì •ëœ í›„ ì‹¤í–‰
            setTimeout(() => {
                Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤...', 'info');
                generateStructure();
            }, 500);
        }
    });

    // ìƒíƒœ ë³µêµ¬ ì™„ë£Œ ì‹œ UI ì—…ë°ì´íŠ¸
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data.analysis && data.project) {
            // ë¶„ì„ ë°ì´í„° ë Œë”ë§
            const analysis = data.analysis;
            document.getElementById('analysisInfo').classList.remove('hidden');
            if (analysis.video_title) document.getElementById('topicInput').value = analysis.video_title;
            document.getElementById('analysisContent').innerHTML = `
                <div class="flex gap-4 items-center">
                    <img src="${analysis.thumbnail_url}" class="w-24 rounded">
                    <div>
                        <p class="font-medium text-gray-800 dark:text-white">${analysis.video_title}</p>
                        <p class="text-sm text-gray-500">${analysis.channel_title}</p>
                    </div>
                </div>
            `;
        }

        if (data.script_structure) {
            currentStructure = data.script_structure;
            renderStructure(data.script_structure);
        }
    });

    async function loadProjectData(projectId) {
        if (!projectId) return;

        try {
            const data = await API.project.getAnalysis(projectId);
            if (data && data.video_title) { // DB column mapping might be snake_case, need to check API return
                // The API returns the row, so columns like video_title, channel_title, thumbnail_url
                document.getElementById('analysisInfo').classList.remove('hidden');
                document.getElementById('topicInput').value = data.video_title;
                document.getElementById('analysisContent').innerHTML = `
                    <div class="flex gap-4 items-center">
                        <img src="${data.thumbnail_url}" class="w-24 rounded">
                        <div>
                            <p class="font-medium text-gray-800 dark:text-white">${data.video_title}</p>
                            <p class="text-sm text-gray-500">${data.channel_title}</p>
                        </div>
                    </div>
                `;
                Utils.showToast('ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
            }

            // Load existing structure if any
            try {
                const structData = await API.project.getScriptStructure(projectId);
                if (structData && structData.sections) {
                    // ì €ì¥ëœ êµ¬ì¡°ê°€ ìˆìœ¼ë©´ ë Œë”ë§
                    console.log("Loaded saved structure:", structData);
                    currentStructure = structData;
                    renderStructure(structData);
                    document.getElementById('resultSection').classList.remove('hidden');
                    Utils.storage.set('scriptStructure', structData); // LocalStorage ë™ê¸°í™”
                }
            } catch (e) {
                console.error("Failed to load script structure:", e);
            }

            // Load Style Settings & Language
            try {
                const fullData = await API.project.getFull(projectId);
                if (fullData) {
                    // [NEW] íƒ€ê²Ÿ ì–¸ì–´ ì„¤ì • ë¡œë“œ
                    if (fullData.project && fullData.project.target_language) {
                        currentTargetLanguage = fullData.project.target_language;
                        console.log("Target Language Loaded:", currentTargetLanguage);
                    } else if (fullData.settings && fullData.settings.target_language) {
                        currentTargetLanguage = fullData.settings.target_language;
                    }

                    if (fullData.settings) {
                        const s = fullData.settings;
                        if (s.image_style_prompt) document.getElementById('imageStyleInput').value = s.image_style_prompt;
                        if (s.subtitle_font) document.getElementById('subtitleFontSelect').value = s.subtitle_font;
                        if (s.subtitle_color) document.getElementById('subtitleColorSelect').value = s.subtitle_color;
                    }
                }
            } catch (e) { console.error('ìŠ¤íƒ€ì¼/ì–¸ì–´ ë¡œë“œ ì‹¤íŒ¨:', e); }

        } catch (e) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    async function saveStyleSettings() {
        const projectId = getCurrentProject();
        if (!projectId) return;

        const imageStyle = document.getElementById('imageStyleInput').value;
        const font = document.getElementById('subtitleFontSelect').value;
        const color = document.getElementById('subtitleColorSelect').value;

        const btn = document.querySelector('button[onclick="saveStyleSettings()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'ì €ì¥ ì¤‘...';
        btn.disabled = true;

        try {
            await API.project.update(projectId, {
                image_style_prompt: imageStyle,
                subtitle_font: font,
                subtitle_color: color
            });
            Utils.showToast('ìŠ¤íƒ€ì¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  ë‹¨ê³„ì— ì ìš©ë©ë‹ˆë‹¤.', 'success');
        } catch (e) {
            console.error(e);
            Utils.showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // [NEW] ì „ì—­ ë³€ìˆ˜ë¡œ íƒ€ê²Ÿ ì–¸ì–´ ê´€ë¦¬
    let currentTargetLanguage = 'ko';

    async function generateStructure() {
        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) {
            Utils.showToast('ì˜ìƒ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        // ë¶„ ë‹¨ìœ„ ì…ë ¥ -> ì´ˆ ë‹¨ìœ„ ë³€í™˜ (AI í”„ë¡¬í”„íŠ¸ê°€ ì´ˆ ë‹¨ìœ„ ì˜ˆìƒ)
        // ìš”ì²­ì‚¬í•­: 60ë¶„ ê¸°ë³¸.
        const durationMin = parseInt(document.getElementById('durationInput').value) || 60;
        const duration = durationMin * 60;
        const tone = document.getElementById('toneSelect').value;
        const notes = document.getElementById('additionalNotes').value;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        try {
            // ìƒˆ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ (ì¤‘ë³µ ë°©ì§€ ì ìš©ë¨)
            // [MODIFIED] target_language ì¶”ê°€ ì „ì†¡
            const response = await fetch('/api/gemini/generate-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic,
                    duration,
                    tone,
                    notes: notes || '',
                    target_language: currentTargetLanguage
                })
            });

            const text = await response.text();
            console.log("Raw Response:", text);
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                console.error("JSON Parse Error:", e);
                Utils.showToast('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (JSON íŒŒì‹± ì‹¤íŒ¨): ' + text.substring(0, 50), 'error');
                Utils.setLoading(btn, false);
                return;
            }

            if (result.status === 'ok') {
                const structureData = result.structure;

                currentStructure = structureData;
                renderStructure(structureData);
                document.getElementById('resultSection').classList.remove('hidden');

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì¦‰ì‹œ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ ì´ë™ìš©)
                // project_id ëª…ì‹œì  ì¶”ê°€
                const projectId = getCurrentProject();
                if (projectId) structureData.project_id = projectId;

                Utils.storage.set('scriptStructure', structureData);

                // DB ì €ì¥
                if (projectId) {
                    try {
                        // 1. í”„ë¡œì íŠ¸ ì£¼ì œ ì—…ë°ì´íŠ¸ (ì¤‘ìš”: ì´ ë¶€ë¶„ì´ ë¹ ì ¸ì„œ í† í”½ ë¶ˆì¼ì¹˜ ë°œìƒ)
                        await API.project.update(projectId, { topic: topic });

                        // 2. êµ¬ì¡° ì €ì¥
                        await API.project.saveScriptStructure(projectId, {
                            hook: structureData.hook,
                            sections: structureData.sections,
                            cta: structureData.cta,
                            style: structureData.style,
                            duration: parseInt(structureData.estimated_duration) || 10
                        });
                        Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        API.project.update(projectId, { status: 'planned' });
                    } catch (e) { console.error('DB ì €ì¥ ì‹¤íŒ¨:', e); }
                }
            } else {
                Utils.showToast('ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('ìƒì„± ì˜¤ë¥˜:', error);
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderStructure(data) {
        const container = document.getElementById('structureContent');
        if (!data) return;

        let html = `<div class="space-y-6">`;

        // 1. Hook
        html += `
            <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900/50">
                <h4 class="font-bold text-red-600 dark:text-red-400 mb-2">ğŸª í›„í‚¹ (Hook)</h4>
                <p class="text-gray-800 dark:text-gray-200 text-lg font-medium">"${data.hook}"</p>
            </div>
        `;

        // 2. Sections
        if (data.sections && data.sections.length > 0) {
            html += `<div class="space-y-4">`;
            data.sections.forEach((section, index) => {
                html += `
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded text-xs font-bold">Scene ${index + 1}</span>
                            <h5 class="font-bold text-gray-800 dark:text-white">${section.title}</h5>
                        </div>
                        <ul class="list-disc list-inside space-y-1 ml-1">
                            ${(section.key_points || []).map(point => `
                                <li class="text-gray-700 dark:text-gray-300 text-sm">${point}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            html += `</div>`;
        }

        // 3. CTA
        html += `
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-900/50">
                <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">ğŸ“¢ CTA (í–‰ë™ ìœ ë„)</h4>
                <p class="text-gray-800 dark:text-gray-200">"${data.cta}"</p>
            </div>
        `;

        // 4. Info (Style, Duration)
        html += `
            <div class="flex gap-4 text-sm text-gray-500 dark:text-gray-400 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <span>ğŸ¨ ìŠ¤íƒ€ì¼: ${data.style || '-'}</span>
                <span>â±ï¸ ì˜ˆìƒ ê¸¸ì´: ${data.duration || 0}ì´ˆ</span>
            </div>
        `;

        html += `</div>`;
        container.innerHTML = html;
    }

    function copyStructure() {
        Utils.copyToClipboard(currentStructure);
        Utils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function regenerate() {
        generateStructure();
    }

    function goToScriptGen() {
        window.location.href = '/script-gen';
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}