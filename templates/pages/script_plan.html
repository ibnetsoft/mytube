{% extends "base.html" %}

{% block content %}


<!-- Grid Layout: Left (Analysis + Settings) / Right (Result) -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 section-spacing">

    <!-- LEFT COLUMN (Analysis & Settings) -->
    <div class="lg:col-span-4 space-y-6">

        <!-- 1. Script Settings -->
        <div class="card w-full">
            <h3 class="card-title">âš™ï¸ {{ t('plan_settings_title') }}</h3>
            <!-- Changed grid to single column for narrower width -->
            <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{
                        t('plan_topic_label') }}</label>
                    <input type="text" id="topicInput" class="input-field"
                        placeholder="{{ t('plan_topic_placeholder') }}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{
                        t('plan_duration_label') }}</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="durationInput" class="input-field w-32" value="60" min="1" step="1">
                        <span id="durationUnit" class="text-gray-700 dark:text-gray-300">{{ t('plan_duration_unit_min')
                            }}</span>
                    </div>
                    <p id="durationHelper" class="text-xs text-gray-500 mt-1">{{ t('plan_duration_helper_min') }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{
                        t('plan_style_label') }}</label>
                    <select id="scriptStyleSelect" class="input-field">
                        <optgroup label="ğŸ“¹ ê¸°ë³¸ ìŠ¤íƒ€ì¼">
                            <option value="default" selected>ê¸°ë³¸ ì„¤ì • (ìì—°ìŠ¤ëŸ½ê³  ì„ ëª…í•œ ìŠ¤íƒ€ì¼)</option>
                            <option value="news">ë‰´ìŠ¤ ë³´ë„ (News Delivery)</option>
                            <option value="story">ì˜›ë‚  ì´ì•¼ê¸° (Old Story)</option>
                            <option value="senior_story">ì‹œë‹ˆì–´ ì‚¬ì—° (Senior Story)</option>
                            <option value="bgm">ë°°ê²½ìŒì•… ì¤‘ì‹¬ (BGM Focus)</option>
                        </optgroup>
                        <optgroup label="ğŸ¬ ì‹œëŒ€ë³„ ì˜í™” ìŠ¤íƒ€ì¼">
                            <option value="classic_50s">50ë…„ëŒ€ í´ë˜ì‹ì˜í™” (í…Œí¬ë‹ˆì»¬ëŸ¬, ë¶€ë“œëŸ¬ìš´ ì¡°ëª…)</option>
                            <option value="joseon_sageuk">ì¡°ì„ ì‹œëŒ€ ì‚¬ê·¹ (ì „í†µ ê±´ì¶•/ì˜ë³µ, ìì—°ê´‘)</option>
                            <option value="north_korean_drama">ë¶í•œ ë“œë¼ë§ˆ (ë¹ˆí‹°ì§€ ì˜í™”, ê°•ë ¬í•œ ìƒ‰ê°)</option>
                            <option value="silent_20s">20ë…„ëŒ€ ë¬´ì„±ì˜í™” (í‘ë°±, ë†’ì€ ì½˜íŠ¸ë¼ìŠ¤íŠ¸, ë¹ˆí‹°ì§€ ê·¸ë ˆì¸)</option>
                            <option value="camcorder_90s">90ë…„ëŒ€ ìº ì½”ë” (VHS í™”ì§ˆ, ë‚®ì€ í”„ë ˆì„)</option>
                            <option value="modern_drama">í˜„ëŒ€ ë“œë¼ë§ˆ (ìê¸€ìê¸€í•œ í™”ì§ˆ, ìì—°ìŠ¤ëŸ¬ìš´ ìƒ‰ê°)</option>
                        </optgroup>
                        <optgroup label="ğŸ­ ì¥ë¥´ë³„ ìŠ¤íƒ€ì¼">
                            <option value="mystery_thriller">ë¯¸ìŠ¤í„°ë¦¬ ìŠ¤ë¦´ëŸ¬ (ì €ì¡°ë„, ì˜ì‚¬ê¸° í†¤, ìŒì˜ ê·¸ë¦¼ì)</option>
                            <option value="horror_suspense">ê³µí¬-ì„œìŠ¤íœìŠ¤ (ì–´ë‘ìš´ ì¡°ëª…, ìŒì¹¨ ë¶„ìœ„ê¸°)</option>
                            <option value="melodrama">ë©œë¡œë“œë¼ë§ˆ (ë¶€ë“œëŸ¬ìš´ ì½˜íŠ¸ë¼ìŠ¤íŠ¸, ë”°ëœ»í•˜ê³  í™”ì‚¬í•¨)</option>
                            <option value="crime_drama">ë²”ì£„ ë“œë¼ë§ˆ (ì°¨ê°‘ê³  ì–´ë‘ìš´ í™”ì§ˆ, ë‚®ì€ ì±„ë„)</option>
                            <option value="cyberpunk_neon">ì‚¬ì´ë²„í‘í¬ ë„¤ì˜¨ (ë„¤ì˜¨ ìƒ‰ìƒ, ë¹„, ë¯¸ë˜ì  ë¶„ìœ„ê¸°)</option>
                        </optgroup>
                        <optgroup label="ğŸ“º ìºë¦­í„°/ì›¹íˆ° ì‹œë¦¬ì¦ˆ">
                            <option value="wimpy_kid">ìœ”í”¼í‚¤ë“œ (ì´ˆë“±í•™ìƒ ì¼ê¸°ì¥ ìŠ¤íƒ€ì¼)</option>
                        </optgroup>
                        <optgroup label="ğŸ¨ ì¼ëŸ¬ìŠ¤íŠ¸/ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼">
                            <option value="watercolor_analog">ìˆ˜ì±„í™”í’ ì•„ë‚ ë¡œê·¸ ì¼ëŸ¬ìŠ¤íŠ¸ (ê°ì„±ì  ìˆ˜ì±„í™” í…ìŠ¤ì²˜)</option>
                            <option value="digital_webtoon">ë””ì§€í„¸ ì›¹íˆ° (ì„ ëª…í•œ ë¼ì¸, í™”ë ¤í•œ ìƒ‰ê°)</option>
                            <option value="graphite_sketch">í‘ì—° ë“œë¡œì‰ ìŠ¤ì¼€ì¹˜ (ê±°ì¹œ ì—°í•„ì„  ìŠ¤ì¼€ì¹˜)</option>
                            <option value="joseon_2d_anime">ì¡°ì„ ì‹œëŒ€ í’ì†í™” 2D ì• ë‹ˆ (ì¡°ì„  ì›¹íˆ° ìŠ¤íƒ€ì¼)</option>
                            <option value="oriental_ink">ë™ì–‘ ìˆ˜ë¬µí™” ëª¨ë…¸í¬ë¡¬ (ì—¬ë°±ì˜ ë¯¸, ë¨¹ë¬¼ ê·¸ë¦¼)</option>
                            <option value="neonsign_citypop">ë„¤ì˜¨ì‚¬ì¸ ì‹œí‹°íŒ (80ë…„ëŒ€ ë ˆíŠ¸ë¡œ í“¨ì²˜, í™”ë ¤í•œ ì•¼ê²½)</option>
                            <option value="buddhist_minimal">ë¶ˆêµ ë¯¸ë‹ˆë©€ë¦¬ì¦˜ (í•œêµ­ ì‚¬ì°°, ë¶ˆìƒ, í¬í† ë¦¬ì–¼ë¦¬ì¦˜)</option>
                            <option value="renaissance_sacred">ë¥´ë„¤ìƒìŠ¤ ì„±í™” (ì„±ê²½ ì¸ë¬¼ ì„±í™”í’, í˜„ëŒ€ì¸ ì‹¤ì‚¬í’)</option>
                            <option value="cute_animal_char">ê·€ì—¬ìš´ ë™ë¬¼ ìºë¦­í„° (ì˜ì¸í™”ëœ ë™ë¬¼ ì›¹íˆ° ì¼ëŸ¬ìŠ¤íŠ¸)</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{ t('plan_notes_label')
                    }}</label>
                <textarea id="additionalNotes" class="input-field" rows="2"
                    placeholder="{{ t('plan_notes_placeholder') }}"></textarea>
            </div>

            <!-- ìƒì„± ë²„íŠ¼ -->
            <div class="flex flex-col gap-2 mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                <button onclick="saveScriptSettings(this)"
                    class="btn-secondary w-full py-2 text-xs flex items-center justify-center gap-2">
                    <span>ğŸ’¾</span>
                    <span>{{ t('btn_save_settings') }}</span>
                </button>
                <button onclick="generateStructure()" id="generateBtn"
                    class="btn-primary w-full py-3 text-sm font-semibold shadow-sm hover:shadow-md transition-all rounded-lg flex items-center justify-center gap-2">
                    <span>ğŸ¤–</span>
                    <span>{{ t('btn_gen_structure') }}</span>
                </button>
            </div>
        </div>

        <!-- [NEW] Title Recommendation Card -->
        <div class="card w-full">
            <h3 class="card-title">ğŸ’¡ {{ t('plan_recommend_title') }} <span
                    class="text-xs font-normal text-gray-500 ml-2">({{ t('cur_project_label') }})</span>
            </h3>

            <!-- ìë™ ìƒì„±ì„ ìœ„í•´ ì…ë ¥ í•„ë“œëŠ” ìˆ¨ê¹€ ì²˜ë¦¬í•˜ê±°ë‚˜ ì œê±° -->
            <input type="hidden" id="titleKeywordInput" />

            <!-- ì¶”ì²œ ì œëª© í‘œì‹œ ì˜ì—­ (ë‹¨ì¼ ì œëª©ìš©ìœ¼ë¡œ ê°„ì†Œí™”) -->
            <!-- ì¶”ì²œ ì œëª© í‘œì‹œ ì˜ì—­ (ë‹¨ì¼ ì œëª©ìš©ìœ¼ë¡œ ê°„ì†Œí™”) -->
            <div id="recommendedTitlesList" class="hidden mb-4">
                <!-- JS: Rendered single best title here -->
            </div>

            <!-- [NEW] ìˆ˜ë™ ìƒì„± ë²„íŠ¼ (ìë™ ìƒì„±ì´ ì•ˆ ë˜ì—ˆì„ ë•Œ í‘œì‹œ) -->
            <div id="manualTitleGenBtn" class="text-center py-4">
                <button onclick="generateRecommendedTitles()"
                    class="btn-secondary text-sm px-4 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-300">
                    {{ t('btn_auto_gen_title') }}
                </button>
            </div>

            <p class="text-[10px] text-gray-500 dark:text-gray-400 mt-2 text-center">* ì˜ìƒ ì£¼ì œì™€ í”„ë¡œì íŠ¸ ì œëª©ìœ¼ë¡œ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤.</p>
        </div>

        <!-- 2. Analysis Data -->
        <div id="analysisInfo" class="card hidden w-full">
            <h3 class="card-title">ğŸ“Š {{ t('plan_analysis_title') }}</h3>
            <div id="analysisContent"></div>
        </div>
    </div>

    <!-- RIGHT COLUMN (Script Structure Result) -->
    <div class="lg:col-span-8">
        <!-- ê²°ê³¼ ì˜ì—­ (Initially Hidden) -->
        <div id="resultSection" class="hidden">
            <div class="card h-full">
                <div class="flex items-center justify-between mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
                    <h3 class="card-title mb-0">ğŸ“ {{ t('plan_result_title') }}</h3>
                    <!-- Buttons Group (Moved 'Generate Script' here) -->
                    <div class="btn-group flex gap-2">
                        <button onclick="copyStructure()"
                            class="btn-secondary text-xs px-3 py-1.5 flex items-center gap-1">
                            <span>ğŸ“‹</span> {{ t('btn_copy') }}
                        </button>
                        <button onclick="regenerate()"
                            class="btn-secondary text-xs px-3 py-1.5 flex items-center gap-1">
                            <span>ğŸ”„</span> {{ t('btn_regenerate') }}
                        </button>
                        <!-- Moved Main Action Button Here -->
                        <button onclick="goToScriptGen()"
                            class="btn-primary text-xs px-4 py-1.5 font-bold shadow-sm hover:shadow-md transition-all rounded flex items-center gap-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                            <span>âœï¸</span>
                            <span>{{ t('btn_gen_full_script') }}</span>
                            <span>â†’</span>
                        </button>
                    </div>
                </div>
                <div id="structureContent" class="prose dark:prose-invert max-w-none"></div>
            </div>
        </div>

        <!-- Placeholder when hidden -->
        <div id="resultPlaceholder"
            class="h-full flex items-center justify-center p-10 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl text-gray-400">
            <div class="text-center">
                <span class="text-4xl block mb-2">ğŸ‘ˆ</span>
                <p>{{ t('plan_placeholder_desc') | safe }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStructure = '';

    // i18n for JS
    const i18n = {
        unit_min: "{{ t('plan_duration_unit_min') }}",
        unit_sec: "{{ t('plan_duration_unit_sec') }}",
        helper_min: "{{ t('plan_duration_helper_min') }}",
        helper_sec: "{{ t('plan_duration_helper_sec') }}",
        loading_title_gen: "{{ t('loading_title_gen') }}",
        empty_desc: "{{ t('plan_empty_desc') }}",
        empty_helper: "{{ t('plan_empty_helper') }}",
        hook_label: "{{ t('plan_hook_label') }}",
        cta_label: "{{ t('plan_cta_label') }}",
        style_label: "{{ t('plan_info_style') }}",
        duration_label: "{{ t('plan_info_duration') }}",
        regenerate: "{{ t('btn_regenerate') }}"
    };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    document.addEventListener('DOMContentLoaded', async () => {
        // í”„ë¡œì íŠ¸ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ -> data reloading
        window.addEventListener('projectChanged', (e) => loadProjectData(e.detail.projectId));

        // [MODIFIED] Check URL for project_id override
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get('project_id');

        let projectId = null;
        if (urlProjectId) {
            projectId = parseInt(urlProjectId);
            setCurrentProject(projectId); // Update global state/localStorage
        } else {
            projectId = getCurrentProject();
        }

        if (projectId) {
            await loadProjectData(projectId);
        }

        // [STRONG OVERRIDE] URLì—ì„œ ì „ë‹¬ëœ topicì´ ìˆë‹¤ë©´ ë¬´ì¡°ê±´ ì…ë ¥ì°½ì— ì ìš© (DB ê°’ë³´ë‹¤ ìš°ì„ )
        const urlTopic = urlParams.get('topic');
        if (urlTopic) {
            console.log("[Force Topic] URL Parameter found:", urlTopic);
            const val = decodeURIComponent(urlTopic);
            document.getElementById('topicInput').value = val;
            const kwInput = document.getElementById('titleKeywordInput');
            if (kwInput) kwInput.value = val;
            // ë§Œì•½ APIë¡œ í”„ë¡œì íŠ¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ë”ë¼ë„, ì‚¬ìš©ìê°€ ë°©ê¸ˆ ê²€ìƒ‰í•œ í‚¤ì›Œë“œê°€ ë” ì¤‘ìš”í•˜ë¯€ë¡œ ë®ì–´ì”€
        } else {
            // URL íŒŒë¼ë¯¸í„°ê°€ ì—†ë”ë¼ë„, ì ì‹œ í›„ topicInputì— ê°’ì´ ë“¤ì–´ì˜¤ë©´ ë™ê¸°í™” ì‹œë„
            setTimeout(() => {
                const topicVal = document.getElementById('topicInput').value;
                const kwInput = document.getElementById('titleKeywordInput');
                if (topicVal && kwInput && !kwInput.value) {
                    kwInput.value = topicVal;
                }
            }, 1000);
        }

        // [NEW] Check App Mode
        try {
            const res = await fetch('/api/settings');
            const settings = await res.json();
            window.APP_MODE = settings.app_mode || 'longform';

            if (window.APP_MODE === 'shorts') {
                document.getElementById('durationUnit').innerText = i18n.unit_sec;
                document.getElementById('durationInput').value = 60;
                document.getElementById('durationHelper').innerText = i18n.helper_sec;
                document.getElementById('durationInput').max = 60;

                // Add badge
                const title = document.querySelector('.card-title');
                if (title) {
                    const badge = document.createElement('span');
                    badge.className = "ml-2 text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full";
                    badge.innerText = "Shorts";
                    title.appendChild(badge);
                }
            }
        } catch (e) { console.error(e); }


    });

    // ìƒíƒœ ë³µêµ¬ ì™„ë£Œ ì‹œ UI ì—…ë°ì´íŠ¸
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data.project) {
            if (data.project.topic) {
                const topic = data.project.topic;
                document.getElementById('topicInput').value = topic;
                const kwInput = document.getElementById('titleKeywordInput');
                if (kwInput && !kwInput.value) kwInput.value = topic;
            }
        }

        if (data.settings) {
            const s = data.settings;
            if (s.duration_seconds !== undefined && s.duration_seconds !== null) {
                const val = (window.APP_MODE === 'shorts') ? s.duration_seconds : Math.floor(s.duration_seconds / 60);
                document.getElementById('durationInput').value = val;
            }
            if (s.script_style) {
                document.getElementById('scriptStyleSelect').value = s.script_style;
            }
        }

        if (data) {
            renderAnalysisSection(data);
        }

        if (data.script_structure) {
            currentStructure = data.script_structure;
            renderStructure(data.script_structure);
            document.getElementById('resultSection').classList.remove('hidden');
            const placeholder = document.getElementById('resultPlaceholder');
            if (placeholder) placeholder.classList.add('hidden');
        } else {
            document.getElementById('resultSection').classList.add('hidden');
            const placeholder = document.getElementById('resultPlaceholder');
            if (placeholder) placeholder.classList.remove('hidden');
        }

        // [NEW] ì¶”ì²œ ì œëª© ë³µêµ¬ ë˜ëŠ” ìë™ ìƒì„±
        if (data.metadata && data.metadata.titles && data.metadata.titles.length > 0) {
            renderRecommendedTitles(data.metadata.titles);
            const listContainer = document.getElementById('recommendedTitlesList');
            if (listContainer) listContainer.classList.remove('hidden');
        } else {
            // í”„ë¡œì íŠ¸ ì£¼ì œê°€ ìˆìœ¼ë©´ ìë™ ì¶”ì²œ ì‹¤í–‰
            const currentTopic = (data.project && data.project.topic) ? data.project.topic : document.getElementById('topicInput').value.trim();
            if (currentTopic) {
                console.log("No titles found, auto-generating recommended title...");
                setTimeout(() => generateRecommendedTitles(), 500);
            }
        }
    });

    async function loadProjectData(projectId) {
        if (!projectId) return;

        try {
            // [MODIFIED] Fetch Full Data to get both Analysis and Settings (Thumbnail)
            const fullData = await API.project.getFull(projectId);
            console.log("Full Data:", fullData);

            if (fullData) {
                if (fullData.project && fullData.project.topic) {
                    const topic = fullData.project.topic;
                    document.getElementById('topicInput').value = topic;
                    const kwInput = document.getElementById('titleKeywordInput');
                    if (kwInput && (!kwInput.value || kwInput.value === '')) {
                        kwInput.value = topic;
                    }
                    console.log("[LoadProjectData] Topic populated:", topic);
                } else if (fullData.analysis && fullData.analysis.video_title) {
                    const kwInput = document.getElementById('titleKeywordInput');
                    if (kwInput && !kwInput.value) kwInput.value = fullData.analysis.video_title;
                }

                const s = fullData.settings || {};
                if (s.duration_seconds) {
                    const val = (window.APP_MODE === 'shorts') ? s.duration_seconds : Math.floor(s.duration_seconds / 60);
                    document.getElementById('durationInput').value = val;
                }
                if (s.script_style) {
                    document.getElementById('scriptStyleSelect').value = s.script_style;
                }

                renderAnalysisSection(fullData);

                // [NEW] Target Language
                const settings = fullData.settings || {};
                if (fullData.project && fullData.project.target_language) {
                    currentTargetLanguage = fullData.project.target_language;
                } else if (settings.target_language) {
                    currentTargetLanguage = settings.target_language;
                }
            }

            // Load existing structure
            try {
                const structData = await API.project.getScriptStructure(projectId);
                console.log("[DEBUG] structData from API:", structData);

                if (structData && (structData.sections || structData.hook)) {
                    currentStructure = structData;
                    renderStructure(structData);
                    document.getElementById('resultSection').classList.remove('hidden');
                    const placeholder = document.getElementById('resultPlaceholder');
                    if (placeholder) placeholder.classList.add('hidden');
                    Utils.storage.set('scriptStructure', structData);
                } else {
                    document.getElementById('resultSection').classList.add('hidden');
                    const placeholder = document.getElementById('resultPlaceholder');
                    if (placeholder) placeholder.classList.remove('hidden');
                }
            } catch (e) {
                console.error("Failed to load script structure:", e);
            }

            // [NEW] ì¶”ì²œ ì œëª© ë¶ˆëŸ¬ì˜¤ê¸° ë¡œì§ ì¶”ê°€
            try {
                // Check if already rendered by projectStateRestored
                const listContainer = document.getElementById('recommendedTitlesList');
                if (listContainer && listContainer.innerHTML.trim() === '') {
                    const metaRes = await fetch(`/api/projects/${projectId}/metadata`);
                    if (metaRes.ok) {
                        const metaData = await metaRes.json();
                        if (metaData && metaData.titles && metaData.titles.length > 0) {
                            renderRecommendedTitles(metaData.titles);
                            // The new renderRecommendedTitles handles showing the container
                        }
                    }
                }
            } catch (e) { console.error("Failed to load saved titles:", e); }

        } catch (e) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            Utils.showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
        }
    }

    function renderAnalysisSection(fullData) {
        const analysis = fullData.analysis || {};
        const settings = fullData.settings || {};

        if (!analysis.video_id && !settings.thumbnail_url) return;

        const infoDiv = document.getElementById('analysisInfo');
        infoDiv.classList.remove('hidden');

        let analysisResult = {};
        try {
            if (typeof analysis.analysis_result === 'string') {
                analysisResult = JSON.parse(analysis.analysis_result);
            } else {
                analysisResult = analysis.analysis_result || {};
            }
        } catch (e) { console.error("Analysis Parse Error", e); }

        let html = `
            <div class="space-y-4">
                <!-- ì›ë³¸ ì˜ìƒ ì •ë³´ -->
                <div class="flex gap-4 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-100 dark:border-gray-700">
                    <img src="${analysis.thumbnail_url}" class="w-28 h-16 object-cover rounded shadow-sm">
                    <div class="min-w-0">
                        <p class="font-bold text-sm text-gray-800 dark:text-white line-clamp-1">${analysis.video_title || 'ì›ë³¸ ì˜ìƒ'}</p>
                        <p class="text-xs text-gray-500 mt-0.5">${analysis.channel_title || ''}</p>
                        <div class="flex gap-3 mt-1.5">
                            <span class="text-[10px] text-indigo-500 font-medium">ğŸ‘ï¸ ${Utils.formatNumber(analysis.view_count || 0)}</span>
                            <span class="text-[10px] text-red-500 font-medium">ğŸ”¥ ìŠ¤ì½”ì–´: ${analysis.viral_score || 0}</span>
                        </div>
                    </div>
                </div>

                <!-- AI ì‹¬ì¸µ ë¶„ì„ ê²°ê³¼ -->
                <div class="space-y-3">
                    ${analysisResult.summary ? `
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/10 rounded-lg border border-blue-100 dark:border-blue-800">
                            <h5 class="text-xs font-bold text-blue-600 dark:text-blue-400 mb-1 flex items-center gap-1">
                                <span>ğŸ“</span> AI ë¶„ì„ ìš”ì•½
                            </h5>
                            <p class="text-xs text-gray-700 dark:text-gray-300 leading-relaxed">${analysisResult.summary}</p>
                        </div>
                    ` : ''}

                    ${analysisResult.success_factors && analysisResult.success_factors.length > 0 ? `
                        <div>
                            <h5 class="text-xs font-bold text-gray-800 dark:text-white mb-2 flex items-center gap-1">
                                <span>ğŸ†</span> ì„±ê³µ ìš”ì¸ (Success Factors)
                            </h5>
                            <ul class="space-y-1.5">
                                ${analysisResult.success_factors.map(f => `
                                    <li class="flex items-start gap-2 text-[11px] text-gray-600 dark:text-gray-400">
                                        <span class="text-blue-500 mt-0.5">â€¢</span>
                                        <span>${f}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${analysisResult.viewer_needs && analysisResult.viewer_needs.length > 0 ? `
                        <div class="pt-2">
                            <h5 class="text-xs font-bold text-gray-800 dark:text-white mb-2 flex items-center gap-1">
                                <span>ğŸ’¡</span> ì‹œì²­ì ë‹ˆì¦ˆ & ì¸ì‚¬ì´íŠ¸
                            </h5>
                            <ul class="space-y-1.5">
                                ${analysisResult.viewer_needs.map(n => `
                                    <li class="flex items-start gap-2 text-[11px] text-gray-600 dark:text-gray-400">
                                        <span class="text-amber-500 mt-0.5">âœ¦</span>
                                        <span>${n}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${analysisResult.script_analysis ? `
                        <div class="pt-2 border-t border-gray-100 dark:border-gray-700 mt-2">
                            <h5 class="text-xs font-bold text-indigo-600 dark:text-indigo-400 mb-2 flex items-center gap-1">
                                <span>ğŸ—ï¸</span> ì›ë³¸ êµ¬ì¡° ë¶„ì„
                            </h5>
                            <p class="text-[11px] text-gray-600 dark:text-gray-400 leading-normal italic">
                                ${analysisResult.script_analysis.structure || 'êµ¬ì¡° ë¶„ì„ë¨'}
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        document.getElementById('analysisContent').innerHTML = html;
    }


    // [NEW] ì „ì—­ ë³€ìˆ˜ë¡œ íƒ€ê²Ÿ ì–¸ì–´ ê´€ë¦¬
    let currentTargetLanguage = 'ko';

    async function saveScriptSettings(btn) {
        const projectId = getCurrentProject();
        if (!projectId) return;

        const originalText = btn.innerHTML;
        Utils.setLoading(btn, true, 'ì €ì¥ ì¤‘...');

        try {
            const topic = document.getElementById('topicInput').value.trim();
            const durationVal = parseInt(document.getElementById('durationInput').value) || 60;
            let durationSeconds = (window.APP_MODE === 'shorts') ? durationVal : durationVal * 60;
            const scriptStyle = document.getElementById('scriptStyleSelect').value;

            // 1. Update project topic (projects table)
            await API.project.update(projectId, { topic: topic });

            // 2. Update settings (project_settings table)
            const result = await API.project.saveSettings(projectId, {
                duration_seconds: durationSeconds,
                script_style: scriptStyle
            });

            if (result.status === 'ok') {
                Utils.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
        } finally {
            Utils.setLoading(btn, false);
            btn.innerHTML = originalText;
        }
    }

    async function generateStructure(passedTopic = null) {
        let topic = passedTopic || document.getElementById('topicInput').value.trim();

        // Update UI if passedTopic was used
        if (passedTopic) {
            document.getElementById('topicInput').value = passedTopic;
        }

        // [Safety Check] If topic is empty (e.g. auto start race condition), try fetching from DB directly
        if (!topic && getCurrentProject()) {
            try {
                const p = await API.project.get(getCurrentProject());
                if (p && p.topic) {
                    topic = p.topic;
                    document.getElementById('topicInput').value = topic;
                }
            } catch (e) { console.error("Topic fetch failed", e); }
        }

        if (!topic) {
            Utils.showToast('ì˜ìƒ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        // ë¶„ ë‹¨ìœ„ ì…ë ¥ -> ì´ˆ ë‹¨ìœ„ ë³€í™˜ (Longform) / ì´ˆ ë‹¨ìœ„ ìœ ì§€ (Shorts)
        const durationVal = parseInt(document.getElementById('durationInput').value) || 60;
        let duration = durationVal * 60; // Default Longform (min -> sec)

        if (window.APP_MODE === 'shorts') {
            duration = durationVal; // Shorts (sec -> sec)
        }
        const tone = "professional"; // Simplified or removed if not needed, as style prompt covers it.
        const scriptStyle = document.getElementById('scriptStyleSelect').value;
        const notes = document.getElementById('additionalNotes').value;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        try {
            const projectId = getCurrentProject();

            const response = await fetch('/api/gemini/generate-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    project_id: projectId,
                    topic,
                    duration,
                    tone,
                    notes: notes || '',
                    target_language: currentTargetLanguage,
                    script_style: scriptStyle
                })
            });

            const text = await response.text();
            console.log("Raw Response:", text);
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                console.error("JSON Parse Error:", e);
                Utils.showToast('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (JSON íŒŒì‹± ì‹¤íŒ¨): ' + text.substring(0, 50), 'error');
                Utils.setLoading(btn, false);
                return;
            }

            if (result.status === 'ok') {
                const structureData = result.structure;
                // [NEW] ê¸°íš ë‹¨ê³„ì—ì„œ ì„ íƒí•œ ìŠ¤íƒ€ì¼ì„ êµ¬ì¡° ë°ì´í„°ì— í¬í•¨í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬
                structureData.script_style = scriptStyle;

                currentStructure = structureData;
                renderStructure(structureData);
                document.getElementById('resultSection').classList.remove('hidden');
                // Hide placeholder
                const placeholder = document.getElementById('resultPlaceholder');
                if (placeholder) placeholder.classList.add('hidden');

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì¦‰ì‹œ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ ì´ë™ìš©)
                // project_id ëª…ì‹œì  ì¶”ê°€
                const projectId = getCurrentProject();
                if (projectId) structureData.project_id = projectId;

                Utils.storage.set('scriptStructure', structureData);

                // DB ì €ì¥
                if (projectId) {
                    try {
                        // 1. í”„ë¡œì íŠ¸ ì£¼ì œ & ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                        await API.project.update(projectId, { topic: topic, script_style: scriptStyle });

                        // 2. êµ¬ì¡° ì €ì¥
                        await API.project.saveScriptStructure(projectId, {
                            hook: structureData.hook,
                            sections: structureData.sections,
                            cta: structureData.cta,
                            style: structureData.style,
                            duration: duration // Use the user-intended duration (already in seconds)
                        });
                        Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        API.project.update(projectId, { status: 'planned' });
                        // [NEW] Update Stepper
                        if (window.updateStepStatus) window.updateStepStatus('plan', true);
                    } catch (e) { console.error('DB ì €ì¥ ì‹¤íŒ¨:', e); }
                }
            } else {
                Utils.showToast('ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('ìƒì„± ì˜¤ë¥˜:', error);
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderStructure(data) {
        const container = document.getElementById('structureContent');
        if (!data || !data.sections || data.sections.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 text-gray-400">
                    <div class="text-4xl mb-3">ğŸ“­</div>
                    <p>${i18n.empty_desc}</p>
                    <p class="text-sm mt-1">${i18n.empty_helper.replace('[ğŸ”„ ë‹¤ì‹œ ìƒì„±]', `[ğŸ”„ ${i18n.regenerate}]`)}</p>
                </div>
            `;
            return;
        }

        let html = `<div class="space-y-6">`;

        html += `
            <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900/50">
                <h4 class="font-bold text-red-600 dark:text-red-400 mb-2">${i18n.hook_label}</h4>
                <p class="text-gray-800 dark:text-gray-200 text-lg font-medium">"${data.hook || 'ë‚´ìš© ì—†ìŒ'}"</p>
            </div>
        `;

        // 2. Sections
        if (data.sections && data.sections.length > 0) {
            html += `<div class="space-y-4">`;
            data.sections.forEach((section, index) => {
                html += `
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded text-xs font-bold">Scene ${index + 1}</span>
                            <h5 class="font-bold text-gray-800 dark:text-white">${section.title}</h5>
                        </div>
                        <ul class="list-disc list-inside space-y-1 ml-1">
                            ${(section.key_points || []).map(point => `
                                <li class="text-gray-700 dark:text-gray-300 text-sm">${point}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            html += `</div>`;
        }

        // 3. CTA
        html += `
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-900/50">
                <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">${i18n.cta_label}</h4>
                <p class="text-gray-800 dark:text-gray-200">"${data.cta}"</p>
            </div>
        `;

        // 4. Info (Style, Duration)
        html += `
            <div class="flex gap-4 text-sm text-gray-500 dark:text-gray-400 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <span>${i18n.style_label}: ${data.style || '-'}</span>
                <span>${i18n.duration_label}: ${data.duration || 0}s</span>
            </div>
        `;

        html += `</div>`;
        container.innerHTML = html;
    }

    function copyStructure() {
        if (!currentStructure) {
            Utils.showToast('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        const text = formatStructureToString(currentStructure);
        Utils.copyToClipboard(text);
        Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function formatStructureToString(data) {
        let text = '';

        // Hook
        if (data.hook) text += `${i18n.hook_label}\n"${data.hook}"\n\n`;

        // Sections
        if (data.sections && data.sections.length > 0) {
            data.sections.forEach((section, index) => {
                text += `Scene ${index + 1}: ${section.title}\n`;
                if (section.key_points) {
                    section.key_points.forEach(point => {
                        text += `- ${point}\n`;
                    });
                }
                text += '\n';
            });
        }

        // CTA
        if (data.cta) text += `${i18n.cta_label}\n"${data.cta}"\n\n`;

        // Style & Duration
        if (data.style) text += `${i18n.style_label}: ${data.style}\n`;
        if (data.duration) text += `${i18n.duration_label}: ${data.duration}s\n`;

        return text;
    }

    // [NEW] Title Recommendation Logic
    // currentTargetLanguage used from global scope

    async function generateRecommendedTitles() {
        const keywordInput = document.getElementById('titleKeywordInput');
        let keyword = keywordInput ? keywordInput.value.trim() : "";
        const currentTopic = document.getElementById('topicInput').value.trim();

        // í‚¤ì›Œë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ì˜ìƒ ì£¼ì œ(topicInput)ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
        if (!keyword) {
            keyword = currentTopic;
            if (keyword && keywordInput) keywordInput.value = keyword; // UI ë°˜ì˜
        }

        if (!keyword) {
            // ì£¼ì œë„ ì—†ìœ¼ë©´ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì¡°ìš©íˆ ì¢…ë£Œ (ìë™ ìƒì„± ì‹œ í† ìŠ¤íŠ¸ ë“± ë°©í•´ ë°©ì§€)
            console.warn('No keyword or topic for title recommendation');
            return;
        }

        const btn = document.getElementById('btnRecTitle'); // ë²„íŠ¼ì´ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²´í¬
        const listContainer = document.getElementById('recommendedTitlesList');

        if (btn) Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');
        listContainer.classList.add('hidden');
        listContainer.innerHTML = `
            <div class="flex flex-col items-center gap-2 py-4">
                <div class="loader-sm"></div>
                <p class="text-xs text-gray-500">${i18n.loading_title_gen}</p>
            </div>
        `;
        listContainer.classList.remove('hidden');

        try {
            const res = await fetch('/api/script/recommend-titles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    keyword: keyword,
                    topic: currentTopic, // ì£¼ì œë„ í•¨ê»˜ ë³´ëƒ„
                    language: currentTargetLanguage || 'ko'
                })
            });
            const data = await res.json();

            if (data.titles && data.titles.length > 0) {
                renderRecommendedTitles(data.titles);
                // listContainer.classList.remove('hidden'); // This is now handled by renderRecommendedTitles

                // [NEW] ìƒì„±ëœ ì œëª©ë“¤ì„ í”„ë¡œì íŠ¸ ë©”íƒ€ë°ì´í„°ì— ì¦‰ì‹œ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
                try {
                    const projectId = getCurrentProject();
                    if (projectId) {
                        // ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì„¤ëª…, íƒœê·¸ ë“± ë³´ì¡´ ëª©ì )
                        let description = "";
                        let tags = [];
                        let hashtags = [];

                        try {
                            const oldMetaRes = await fetch(`/api/projects/${projectId}/metadata`);
                            if (oldMetaRes.ok) {
                                const oldMeta = await oldMetaRes.json();
                                if (oldMeta) {
                                    description = oldMeta.description || "";
                                    tags = oldMeta.tags || [];
                                    hashtags = oldMeta.hashtags || [];
                                }
                            }
                        } catch (e) { console.error("Error fetching old metadata", e); }

                        await fetch(`/api/projects/${projectId}/metadata`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                titles: data.titles,
                                description: description,
                                tags: tags,
                                hashtags: hashtags
                            })
                        });
                        console.log("Titles saved to metadata safely.");
                    }
                } catch (saveErr) {
                    console.error("Failed to save recommended titles:", saveErr);
                }
            } else {
                Utils.showToast('ì¶”ì²œ ì œëª©ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderRecommendedTitles(titles) {
        const container = document.getElementById('recommendedTitlesList');
        if (!container) return;

        // 5ê°œ ì¤‘ ì²« ë²ˆì§¸ ì œëª©ì„ ê°€ì¥ ì¢‹ì€ ì œëª©ìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ í•˜ë‚˜ë§Œ í‘œì‹œ
        const bestTitle = titles[0];

        container.innerHTML = `
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl mb-2 text-center">
                <p class="text-xs text-blue-500 mb-1 font-bold">âœ¨ AI ìµœì  ì¶”ì²œ ì œëª©</p>
                <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-2">"${bestTitle}"</h4>
                <div class="flex justify-center gap-2">
                    <span class="text-xs px-2 py-1 bg-green-100 text-green-600 rounded-full font-medium">ìë™ ì ìš©ë¨</span>
                    <button onclick="generateRecommendedTitles()" class="text-xs text-blue-500 hover:underline">ë‹¤ì‹œ ë½‘ê¸°</button>
                </div>
            </div>
        `;
        container.classList.remove('hidden');

        // [NEW] Hide Manual Button if exists
        const btnManual = document.getElementById('manualTitleGenBtn');
        if (btnManual) btnManual.classList.add('hidden');

        // ìƒì„±ëœ ì¦‰ì‹œ ì´ ì œëª©ì„ í”„ë¡œì íŠ¸ì— ì ìš© (ìœ ì €ê°€ ì„ íƒí•œ ê²ƒì²˜ëŸ¼)
        applyTitle(bestTitle);
    }

    async function applyTitle(title) {
        // 1. Update Project Title (via Metadata API or Patch)
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        try {
            // Update Project Details (Title update)
            // Using PATCH /api/projects/{id}
            await fetch(`/api/projects/${projectId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_title: title })
            });

            // 2. Update UI Inputs
            document.getElementById('topicInput').value = title; // ëŒ€ë³¸ êµ¬ì¡° > ì˜ìƒ ì£¼ì œ

            // 3. Highlight
            Utils.showToast(`ì œëª© ì ìš© ì™„ë£Œ`, 'success');

            // ì‹œê°ì  í”¼ë“œë°± (topic input ê¹œë¹¡ì„)
            const topicInput = document.getElementById('topicInput');
            topicInput.classList.add('ring-2', 'ring-indigo-500', 'transition-all', 'duration-300');
            setTimeout(() => topicInput.classList.remove('ring-2', 'ring-indigo-500'), 1000);

        } catch (e) {
            console.error("Title Update Failed:", e);
            Utils.showToast('ì œëª© ì ìš© ì‹¤íŒ¨', 'error');
        }
    }


    function regenerate() {
        generateStructure();
    }

    function goToScriptGen() {
        const projectId = getCurrentProject();
        if (projectId) {
            window.location.href = `/script-gen?project_id=${projectId}&auto_start=true`;
        } else {
            // í”„ë¡œì íŠ¸ IDê°€ ì—†ì„ ê²½ìš° ê·¸ëƒ¥ ì´ë™ (í˜¹ì€ ì—ëŸ¬ ì²˜ë¦¬)
            window.location.href = '/script-gen';
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}