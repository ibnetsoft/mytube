{% extends "base.html" %}

{% block content %}


<!-- ë¶„ì„ ë°ì´í„° í‘œì‹œ -->
<div id="analysisInfo" class="card container-content section-spacing hidden">
    <h3 class="card-title">ğŸ“Š ë¶„ì„ ë°ì´í„° ê¸°ë°˜</h3>
    <div id="analysisContent"></div>
</div>

<!-- ëŒ€ë³¸ ì„¤ì • -->
<div class="card container-content section-spacing">
    <h3 class="card-title">âš™ï¸ ëŒ€ë³¸ ì„¤ì •</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒ ì£¼ì œ</label>
            <input type="text" id="topicInput" class="input-field" placeholder="ì˜ˆ: ì´ˆë³´ìë¥¼ ìœ„í•œ íŒŒì´ì¬ ê°•ì˜">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒ ê¸¸ì´</label>
            <div class="flex items-center gap-2">
                <input type="number" id="durationInput" class="input-field w-32" value="60" min="1" step="1">
                <span class="text-gray-700 dark:text-gray-300">ë¶„</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">ê¸°ë³¸ê°’: 60ë¶„ (ëŒ€ë³¸ ê¸¸ì´ ê¸°ì¤€)</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ëŒ€ë³¸ ìŠ¤íƒ€ì¼</label>
            <select id="scriptStyleSelect" class="input-field">
                <option value="story" selected>ì˜›ë‚  ì´ì•¼ê¸° (Old Story)</option>
                <option value="news">ë‰´ìŠ¤ ë³´ë„ (News Delivery)</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">ê¸°ë³¸ê°’: ì˜›ë‚  ì´ì•¼ê¸°</p>
        </div>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì¶”ê°€ ìš”ì²­ì‚¬í•­</label>
        <textarea id="additionalNotes" class="input-field" rows="3"
            placeholder="íŠ¹ë³„íˆ í¬í•¨í•˜ê³  ì‹¶ì€ ë‚´ìš©ì´ë‚˜ ìŠ¤íƒ€ì¼ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
    </div>
</div>


<!-- ìƒì„± ë²„íŠ¼ -->
<div class="btn-group btn-group-center section-spacing">
    <button onclick="generateStructure()" id="generateBtn" class="btn-primary btn-primary-lg"
        style="max-width: 400px; width: 100%;">
        <span>ğŸ¤–</span>
        <span>ëŒ€ë³¸ êµ¬ì¡° ìƒì„±í•˜ê¸°</span>
    </button>
</div>

<!-- ê²°ê³¼ ì˜ì—­ -->
<div id="resultSection" class="hidden">
    <div class="card container-lg section-spacing">
        <div class="flex items-center justify-between mb-4">
            <h3 class="card-title mb-0">ğŸ“ ìƒì„±ëœ ëŒ€ë³¸ êµ¬ì¡°</h3>
            <div class="btn-group">
                <button onclick="copyStructure()" class="btn-secondary">ğŸ“‹ ë³µì‚¬</button>
                <button onclick="regenerate()" class="btn-secondary">ğŸ”„ ë‹¤ì‹œ ìƒì„±</button>
            </div>
        </div>
        <div id="structureContent" class="prose dark:prose-invert max-w-none"></div>

        <div class="btn-group btn-group-center mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <button onclick="goToScriptGen()" class="btn-primary btn-primary-lg" style="max-width: 400px; width: 100%;">
                <span>âœï¸</span>
                <span>ì „ì²´ ëŒ€ë³¸ ìƒì„±í•˜ê¸°</span>
                <span>â†’</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStructure = '';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    document.addEventListener('DOMContentLoaded', async () => {
        // í”„ë¡œì íŠ¸ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ -> data reloading
        window.addEventListener('projectChanged', (e) => loadProjectData(e.detail.projectId));

        // ì´ˆê¸° ë¡œë“œ
        const projectId = getCurrentProject();
        if (projectId) {
            await loadProjectData(projectId);
        }

        // ìë™ ìƒì„± ìš”ì²­ í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auto') === 'true') {
            // ë°ì´í„° ë¡œë“œê°€ ì™„ë£Œëœ í›„ ì‹¤í–‰ë˜ì–´ì•¼ í•¨ (ìœ„ await loadProjectDataë¡œ ë³´ì¥)
            // ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ì£¼ì–´ UIê°€ ì•ˆì •ëœ í›„ ì‹¤í–‰
            setTimeout(() => {
                Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤...', 'info');
                generateStructure();
            }, 500);
        }
    });

    // ìƒíƒœ ë³µêµ¬ ì™„ë£Œ ì‹œ UI ì—…ë°ì´íŠ¸
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data) {
            renderAnalysisSection(data);
        }

        if (data.script_structure) {
            currentStructure = data.script_structure;
            renderStructure(data.script_structure);
        }
    });

    async function loadProjectData(projectId) {
        if (!projectId) return;

        try {
            // [MODIFIED] Fetch Full Data to get both Analysis and Settings (Thumbnail)
            const fullData = await API.project.getFull(projectId);
            console.log("Full Data:", fullData);

            if (fullData) {
                // 1. Set Topic
                if (fullData.project && fullData.project.topic) {
                    document.getElementById('topicInput').value = fullData.project.topic;
                }

                // 2. Render Analysis Info + Generated Thumbnail
                renderAnalysisSection(fullData);

                // [NEW] Target Language
                const settings = fullData.settings || {};
                if (fullData.project && fullData.project.target_language) {
                    currentTargetLanguage = fullData.project.target_language;
                } else if (settings.target_language) {
                    currentTargetLanguage = settings.target_language;
                }
            }

            // Load existing structure (Separate fetch as per legacy logic, usually structure is large)
            try {
                const structData = await API.project.getScriptStructure(projectId);
                if (structData && structData.sections) {
                    console.log("Loaded saved structure:", structData);
                    currentStructure = structData;
                    renderStructure(structData);
                    document.getElementById('resultSection').classList.remove('hidden');
                    Utils.storage.set('scriptStructure', structData);
                }
            } catch (e) {
                console.error("Failed to load script structure:", e);
            }

        } catch (e) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            Utils.showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
        }
    }

    function renderAnalysisSection(fullData) {
        const analysis = fullData.analysis || {};
        const settings = fullData.settings || {};

        const hasAnalysis = analysis.video_title;
        const hasThumbnail = settings.thumbnail_url;

        // Note: We check if there's ANYTHING to show. 
        // If analysis is missing but we have thumbnail, we still show the section.
        if (hasAnalysis || hasThumbnail) {
            document.getElementById('analysisInfo').classList.remove('hidden');

            // If topic input is empty, maybe fill it from analysis? 
            // Logic moved to loadProjectData to be safer (prefer project.topic)
            if (analysis.video_title && !document.getElementById('topicInput').value) {
                // document.getElementById('topicInput').value = analysis.video_title; 
                // Kept commented out as per previous logic to strictly use project.topic
            }

            let html = '<div class="flex flex-col md:flex-row gap-6">';

            // Left: Analysis Data (Source)
            if (hasAnalysis) {
                html += `
                    <div class="flex-1 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700">
                        <h4 class="text-xs font-bold text-gray-500 mb-2">ğŸ“º ì›ë³¸ ì˜ìƒ ë¶„ì„</h4>
                        <div class="flex gap-4 items-center">
                            <img src="${analysis.thumbnail_url}" class="w-24 h-16 object-cover rounded bg-black">
                            <div class="min-w-0">
                                <p class="font-medium text-sm text-gray-800 dark:text-white truncate" title="${analysis.video_title}">${analysis.video_title}</p>
                                <p class="text-xs text-gray-500">${analysis.channel_title}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Optional: Show empty state for analysis if needed, but usually we just skip.
                // For balance, if we have thumbnail but no analysis (rare), we could leave left side empty?
                // Let's just render what we have.
            }

            // Right: Generated Thumbnail (My Project)
            if (hasThumbnail) {
                html += `
                    <div class="flex-1 bg-blue-50 dark:bg-blue-900/10 p-3 rounded-lg border border-blue-100 dark:border-blue-900/30">
                        <h4 class="text-xs font-bold text-blue-600 dark:text-blue-400 mb-2">ğŸ¨ ë‚´ ì¸ë„¤ì¼ (ìƒì„±ë¨)</h4>
                        <div class="flex gap-4 items-center">
                            <img src="${settings.thumbnail_url}" class="w-24 h-16 object-cover rounded bg-black cursor-pointer hover:opacity-90" onclick="window.open('${settings.thumbnail_url}', '_blank')">
                            <div class="min-w-0">
                                <p class="font-medium text-sm text-gray-800 dark:text-white truncate">ë©”ì¸ ì¸ë„¤ì¼</p>
                                <p class="text-xs text-gray-500">í´ë¦­í•˜ì—¬ í¬ê²Œ ë³´ê¸°</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Placeholder
                html += `
                    <div class="flex-1 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700 dashed-border flex items-center justify-center text-gray-400 text-xs">
                        <span>ì¸ë„¤ì¼ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤</span>
                    </div>
                `;
            }

            html += '</div>';
            document.getElementById('analysisContent').innerHTML = html;
        }
    }


    // [NEW] ì „ì—­ ë³€ìˆ˜ë¡œ íƒ€ê²Ÿ ì–¸ì–´ ê´€ë¦¬
    let currentTargetLanguage = 'ko';

    async function generateStructure() {
        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) {
            Utils.showToast('ì˜ìƒ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        // ë¶„ ë‹¨ìœ„ ì…ë ¥ -> ì´ˆ ë‹¨ìœ„ ë³€í™˜ (AI í”„ë¡¬í”„íŠ¸ê°€ ì´ˆ ë‹¨ìœ„ ì˜ˆìƒ)
        // ìš”ì²­ì‚¬í•­: 60ë¶„ ê¸°ë³¸.
        const durationMin = parseInt(document.getElementById('durationInput').value) || 60;
        const duration = durationMin * 60;
        const tone = "professional"; // Simplified or removed if not needed, as style prompt covers it.
        const scriptStyle = document.getElementById('scriptStyleSelect').value;
        const notes = document.getElementById('additionalNotes').value;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        try {
            const projectId = getCurrentProject();

            const response = await fetch('/api/gemini/generate-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    project_id: projectId,
                    topic,
                    duration,
                    tone,
                    notes: notes || '',
                    target_language: currentTargetLanguage,
                    script_style: scriptStyle
                })
            });

            const text = await response.text();
            console.log("Raw Response:", text);
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                console.error("JSON Parse Error:", e);
                Utils.showToast('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (JSON íŒŒì‹± ì‹¤íŒ¨): ' + text.substring(0, 50), 'error');
                Utils.setLoading(btn, false);
                return;
            }

            if (result.status === 'ok') {
                const structureData = result.structure;

                currentStructure = structureData;
                renderStructure(structureData);
                document.getElementById('resultSection').classList.remove('hidden');

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì¦‰ì‹œ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ ì´ë™ìš©)
                // project_id ëª…ì‹œì  ì¶”ê°€
                const projectId = getCurrentProject();
                if (projectId) structureData.project_id = projectId;

                Utils.storage.set('scriptStructure', structureData);

                // DB ì €ì¥
                if (projectId) {
                    try {
                        // 1. í”„ë¡œì íŠ¸ ì£¼ì œ ì—…ë°ì´íŠ¸ (ì¤‘ìš”: ì´ ë¶€ë¶„ì´ ë¹ ì ¸ì„œ í† í”½ ë¶ˆì¼ì¹˜ ë°œìƒ)
                        await API.project.update(projectId, { topic: topic });

                        // 2. êµ¬ì¡° ì €ì¥
                        await API.project.saveScriptStructure(projectId, {
                            hook: structureData.hook,
                            sections: structureData.sections,
                            cta: structureData.cta,
                            style: structureData.style,
                            duration: duration // Use the user-intended duration (already in seconds)
                        });
                        Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        API.project.update(projectId, { status: 'planned' });
                    } catch (e) { console.error('DB ì €ì¥ ì‹¤íŒ¨:', e); }
                }
            } else {
                Utils.showToast('ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('ìƒì„± ì˜¤ë¥˜:', error);
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderStructure(data) {
        const container = document.getElementById('structureContent');
        if (!data) return;

        let html = `<div class="space-y-6">`;

        // 1. Hook
        html += `
            <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900/50">
                <h4 class="font-bold text-red-600 dark:text-red-400 mb-2">ğŸª í›„í‚¹ (Hook)</h4>
                <p class="text-gray-800 dark:text-gray-200 text-lg font-medium">"${data.hook}"</p>
            </div>
        `;

        // 2. Sections
        if (data.sections && data.sections.length > 0) {
            html += `<div class="space-y-4">`;
            data.sections.forEach((section, index) => {
                html += `
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded text-xs font-bold">Scene ${index + 1}</span>
                            <h5 class="font-bold text-gray-800 dark:text-white">${section.title}</h5>
                        </div>
                        <ul class="list-disc list-inside space-y-1 ml-1">
                            ${(section.key_points || []).map(point => `
                                <li class="text-gray-700 dark:text-gray-300 text-sm">${point}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            html += `</div>`;
        }

        // 3. CTA
        html += `
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-900/50">
                <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">ğŸ“¢ CTA (í–‰ë™ ìœ ë„)</h4>
                <p class="text-gray-800 dark:text-gray-200">"${data.cta}"</p>
            </div>
        `;

        // 4. Info (Style, Duration)
        html += `
            <div class="flex gap-4 text-sm text-gray-500 dark:text-gray-400 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <span>ğŸ¨ ìŠ¤íƒ€ì¼: ${data.style || '-'}</span>
                <span>â±ï¸ ì˜ˆìƒ ê¸¸ì´: ${data.duration || 0}ì´ˆ</span>
            </div>
        `;

        html += `</div>`;
        container.innerHTML = html;
    }

    function copyStructure() {
        if (!currentStructure) {
            Utils.showToast('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        const text = formatStructureToString(currentStructure);
        Utils.copyToClipboard(text);
        Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function formatStructureToString(data) {
        let text = '';

        // Hook
        if (data.hook) text += `ğŸª í›„í‚¹ (Hook)\n"${data.hook}"\n\n`;

        // Sections
        if (data.sections && data.sections.length > 0) {
            data.sections.forEach((section, index) => {
                text += `Scene ${index + 1}: ${section.title}\n`;
                if (section.key_points) {
                    section.key_points.forEach(point => {
                        text += `- ${point}\n`;
                    });
                }
                text += '\n';
            });
        }

        // CTA
        if (data.cta) text += `ğŸ“¢ CTA (í–‰ë™ ìœ ë„)\n"${data.cta}"\n\n`;

        // Style & Duration
        if (data.style) text += `ğŸ¨ ìŠ¤íƒ€ì¼: ${data.style}\n`;
        if (data.duration) text += `â±ï¸ ì˜ˆìƒ ê¸¸ì´: ${data.duration}ì´ˆ\n`;

        return text;
    }

    function regenerate() {
        generateStructure();
    }

    function goToScriptGen() {
        window.location.href = '/script-gen';
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}