{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ“‹</span>
        <div>
            <h1>ëŒ€ë³¸ ê¸°íš</h1>
            <p>ë¶„ì„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€ë³¸ êµ¬ì¡°ë¥¼ ì„¤ê³„í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- ë¶„ì„ ë°ì´í„° í‘œì‹œ -->
<div id="analysisInfo" class="card mb-6 hidden">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“Š ë¶„ì„ ë°ì´í„° ê¸°ë°˜</h3>
    <div id="analysisContent"></div>
</div>

<!-- ëŒ€ë³¸ ì„¤ì • -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ ëŒ€ë³¸ ì„¤ì •</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒ ì£¼ì œ</label>
            <input type="text" id="topicInput" class="input-field" placeholder="ì˜ˆ: ì´ˆë³´ìë¥¼ ìœ„í•œ íŒŒì´ì¬ ê°•ì˜">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒ ê¸¸ì´</label>
            <div class="flex flex-wrap gap-2">
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="scriptDuration" value="20" class="form-radio text-blue-600">
                    <span class="text-sm">20s</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="scriptDuration" value="30" class="form-radio text-blue-600" checked>
                    <span class="text-sm">30s</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="scriptDuration" value="40" class="form-radio text-blue-600">
                    <span class="text-sm">40s</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="scriptDuration" value="50" class="form-radio text-blue-600">
                    <span class="text-sm">50s</span>
                </label>
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="radio" name="scriptDuration" value="60" class="form-radio text-blue-600">
                    <span class="text-sm">60s</span>
                </label>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í†¤ì•¤ë§¤ë„ˆ</label>
            <select id="toneSelect" class="input-field">
                <option value="friendly">ì¹œê·¼í•œ</option>
                <option value="professional">ì „ë¬¸ì ì¸</option>
                <option value="humorous">ìœ ë¨¸ëŸ¬ìŠ¤í•œ</option>
                <option value="educational">êµìœ¡ì ì¸</option>
            </select>
        </div>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì¶”ê°€ ìš”ì²­ì‚¬í•­</label>
        <textarea id="additionalNotes" class="input-field" rows="3"
            placeholder="íŠ¹ë³„íˆ í¬í•¨í•˜ê³  ì‹¶ì€ ë‚´ìš©ì´ë‚˜ ìŠ¤íƒ€ì¼ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
    </div>
</div>

<!-- ìƒì„± ë²„íŠ¼ -->
<button onclick="generateStructure()" id="generateBtn"
    class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg mb-6">
    <span>ğŸ¤–</span>
    <span>ëŒ€ë³¸ êµ¬ì¡° ìƒì„±í•˜ê¸°</span>
</button>

<!-- ê²°ê³¼ ì˜ì—­ -->
<div id="resultSection" class="hidden">
    <div class="card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-800 dark:text-white">ğŸ“ ìƒì„±ëœ ëŒ€ë³¸ êµ¬ì¡°</h3>
            <div class="flex gap-2">
                <button onclick="copyStructure()" class="btn-secondary text-sm">ğŸ“‹ ë³µì‚¬</button>
                <button onclick="regenerate()" class="btn-secondary text-sm">ğŸ”„ ë‹¤ì‹œ ìƒì„±</button>
            </div>
        </div>
        <div id="structureContent" class="prose dark:prose-invert max-w-none"></div>

        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <button onclick="goToScriptGen()"
                class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg">
                <span>âœï¸</span>
                <span>ì „ì²´ ëŒ€ë³¸ ìƒì„±í•˜ê¸°</span>
                <span>â†’</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStructure = '';

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶„ì„ ë°ì´í„° í™•ì¸
    document.addEventListener('DOMContentLoaded', async () => {
        // í”„ë¡œì íŠ¸ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ -> data reloading
        window.addEventListener('projectChanged', (e) => loadProjectData(e.detail.projectId));

        // ì´ˆê¸° ë¡œë“œ
        const projectId = getCurrentProject();
        if (projectId) {
            await loadProjectData(projectId);
        }
    });

    // ìƒíƒœ ë³µêµ¬ ì™„ë£Œ ì‹œ UI ì—…ë°ì´íŠ¸
    window.addEventListener('projectStateRestored', (e) => {
        const data = e.detail;
        if (data.analysis && data.project) {
            // ë¶„ì„ ë°ì´í„° ë Œë”ë§
            const analysis = data.analysis;
            document.getElementById('analysisInfo').classList.remove('hidden');
            if (analysis.video_title) document.getElementById('topicInput').value = analysis.video_title;
            document.getElementById('analysisContent').innerHTML = `
                <div class="flex gap-4 items-center">
                    <img src="${analysis.thumbnail_url}" class="w-24 rounded">
                    <div>
                        <p class="font-medium text-gray-800 dark:text-white">${analysis.video_title}</p>
                        <p class="text-sm text-gray-500">${analysis.channel_title}</p>
                    </div>
                </div>
            `;
        }

        if (data.script_structure) {
            currentStructure = data.script_structure;
            renderStructure(data.script_structure);
        }
    });

    async function loadProjectData(projectId) {
        if (!projectId) return;

        try {
            const data = await API.project.getAnalysis(projectId);
            if (data && data.video_title) { // DB column mapping might be snake_case, need to check API return
                // The API returns the row, so columns like video_title, channel_title, thumbnail_url
                document.getElementById('analysisInfo').classList.remove('hidden');
                document.getElementById('topicInput').value = data.video_title;
                document.getElementById('analysisContent').innerHTML = `
                    <div class="flex gap-4 items-center">
                        <img src="${data.thumbnail_url}" class="w-24 rounded">
                        <div>
                            <p class="font-medium text-gray-800 dark:text-white">${data.video_title}</p>
                            <p class="text-sm text-gray-500">${data.channel_title}</p>
                        </div>
                    </div>
                `;
                Utils.showToast('ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
            }

            // Load existing structure if any
            try {
                const structData = await API.project.getScriptStructure(projectId);
                if (structData && structData.sections) {
                    // Check if there is a saved structure
                    // We might want to show it? For now let's just allow regenerating
                    // Or maybe show saved structure?
                    // Let's implement showing saved structure later or if user asks
                }
            } catch (e) { }

        } catch (e) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    async function generateStructure() {
        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) {
            Utils.showToast('ì˜ìƒ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const duration = document.querySelector('input[name="scriptDuration"]:checked').value;
        const tone = document.getElementById('toneSelect').value;
        const notes = document.getElementById('additionalNotes').value;

        const btn = document.getElementById('generateBtn');
        Utils.setLoading(btn, true, 'ìƒì„± ì¤‘...');

        try {
            // ìƒˆ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ (ì¤‘ë³µ ë°©ì§€ ì ìš©ë¨)
            const response = await fetch('/api/gemini/generate-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic,
                    duration,
                    tone,
                    notes: notes || ''
                })
            });

            const text = await response.text();
            console.log("Raw Response:", text);
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                console.error("JSON Parse Error:", e);
                Utils.showToast('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (JSON íŒŒì‹± ì‹¤íŒ¨): ' + text.substring(0, 50), 'error');
                Utils.setLoading(btn, false);
                return;
            }

            if (result.status === 'ok') {
                const structureData = result.structure;

                currentStructure = structureData;
                renderStructure(structureData);
                document.getElementById('resultSection').classList.remove('hidden');

                // DB ì €ì¥
                const projectId = getCurrentProject();
                if (projectId) {
                    try {
                        await API.project.saveScriptStructure(projectId, {
                            hook: structureData.hook,
                            sections: structureData.sections,
                            cta: structureData.cta,
                            style: structureData.style,
                            duration: parseInt(structureData.estimated_duration) || 10
                        });
                        Utils.showToast('ëŒ€ë³¸ êµ¬ì¡°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        API.project.update(projectId, { status: 'planned' });
                    } catch (e) { console.error('DB ì €ì¥ ì‹¤íŒ¨:', e); }
                }
            } else {
                Utils.showToast('ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('ìƒì„± ì˜¤ë¥˜:', error);
            Utils.showToast('ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        } finally {
            Utils.setLoading(btn, false);
        }
    }

    function renderStructure(data) {
        const container = document.getElementById('structureContent');
        if (!data) return;

        let html = `<div class="space-y-6">`;

        // 1. Hook
        html += `
            <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900/50">
                <h4 class="font-bold text-red-600 dark:text-red-400 mb-2">ğŸª í›„í‚¹ (Hook)</h4>
                <p class="text-gray-800 dark:text-gray-200 text-lg font-medium">"${data.hook}"</p>
            </div>
        `;

        // 2. Sections
        if (data.sections && data.sections.length > 0) {
            html += `<div class="space-y-4">`;
            data.sections.forEach((section, index) => {
                html += `
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded text-xs font-bold">Scene ${index + 1}</span>
                            <h5 class="font-bold text-gray-800 dark:text-white">${section.title}</h5>
                        </div>
                        <ul class="list-disc list-inside space-y-1 ml-1">
                            ${(section.key_points || []).map(point => `
                                <li class="text-gray-700 dark:text-gray-300 text-sm">${point}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            html += `</div>`;
        }

        // 3. CTA
        html += `
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-900/50">
                <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-2">ğŸ“¢ CTA (í–‰ë™ ìœ ë„)</h4>
                <p class="text-gray-800 dark:text-gray-200">"${data.cta}"</p>
            </div>
        `;

        // 4. Info (Style, Duration)
        html += `
            <div class="flex gap-4 text-sm text-gray-500 dark:text-gray-400 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <span>ğŸ¨ ìŠ¤íƒ€ì¼: ${data.style || '-'}</span>
                <span>â±ï¸ ì˜ˆìƒ ê¸¸ì´: ${data.duration || 0}ì´ˆ</span>
            </div>
        `;

        html += `</div>`;
        container.innerHTML = html;
    }

    function copyStructure() {
        Utils.copyToClipboard(currentStructure);
        Utils.showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    function regenerate() {
        generateStructure();
    }

    function goToScriptGen() {
        window.location.href = '/script-gen';
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}