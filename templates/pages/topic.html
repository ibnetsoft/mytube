{% extends "base.html" %}

{% block content %}
<!-- í˜ì´ì§€ í—¤ë” -->


<!-- íŠ¸ë Œë“œ í‚¤ì›Œë“œ ë²„ë¸” ì°¨íŠ¸ -->
<div
    class="card mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 border-none shadow-lg overflow-hidden relative">
    <div class="relative z-10">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-xl text-gray-800 dark:text-white flex items-center gap-3">
                <div class="flex items-center gap-2">
                    <span>ğŸ”¥ ì‹¤ì‹œê°„ íŠ¸ë Œë“œ í‚¤ì›Œë“œ</span>
                    <span
                        class="text-xs font-normal bg-red-100 text-red-600 px-2 py-0.5 rounded-full animate-pulse">LIVE</span>
                </div>
                <!-- [NEW] ìˆ˜ë™ ë¡œë”© ë²„íŠ¼ -->
                <button onclick="loadTrendKeywords()"
                    class="btn-secondary py-1.5 px-4 text-xs flex items-center gap-2 bg-white dark:bg-gray-800 hover:shadow-md transition-all active:scale-95">
                    <span>ğŸ”„</span>
                    <span>í‚¤ì›Œë“œ ìƒˆë¡œê³ ì¹¨</span>
                </button>
            </h3>

            <!-- í•„í„° ê·¸ë£¹ (ì–¸ì–´ / ê¸°ê°„ / ì—°ë ¹) -->
            <div class="flex flex-wrap items-center gap-3">
                <!-- ê¸°ê°„ ì„ íƒ -->
                <select id="trend-period"
                    class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
                    <option value="now">ì‹¤ì‹œê°„</option>
                    <option value="week">ì£¼ê°„ (7ì¼)</option>
                    <option value="month">ì›”ê°„ (30ì¼)</option>
                </select>

                <!-- ì—°ë ¹ ì„ íƒ -->
                <select id="trend-age"
                    class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
                    <option value="all">ì „ì²´ ì—°ë ¹</option>
                    <option value="10s">10ëŒ€</option>
                    <option value="20s">20ëŒ€</option>
                    <option value="30s">30ëŒ€</option>
                    <option value="40s">40ëŒ€</option>
                    <option value="50s" selected>50ëŒ€ ì´ìƒ</option>
                </select>

                <!-- ì–¸ì–´ ì„ íƒ -->
                <div class="flex bg-white dark:bg-gray-800 rounded-lg p-1 shadow-sm">
                    <button onclick="changeTrendLanguage('ko')" id="btn-ko"
                        class="lang-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-indigo-500 text-white shadow-md">í•œêµ­ì–´</button>
                    <button onclick="changeTrendLanguage('ja')" id="btn-ja"
                        class="lang-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-indigo-500 transition-all">æ—¥æœ¬èª</button>
                    <button onclick="changeTrendLanguage('en')" id="btn-en"
                        class="lang-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-indigo-500 transition-all">Eng</button>
                    <button onclick="changeTrendLanguage('es')" id="btn-es"
                        class="lang-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-indigo-500 transition-all">Esp</button>
                </div>
            </div>
        </div>

        <!-- ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ -->
        <div id="bubbleChart" class="w-full h-[800px] flex items-center justify-center relative">
            <!-- [NEW] Placeholder / Loading State Combined -->
            <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 gap-4"
                id="bubbleLoading">
                <div id="bubbleSpinner" class="hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                </div>
                <div id="bubblePlaceholder" class="flex flex-col items-center gap-3">
                    <div class="text-6xl opacity-50">ğŸŒ</div>
                    <p class="text-sm">ìƒë‹¨ 'ìƒˆë¡œê³ ì¹¨' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¤ì‹œê°„ í‚¤ì›Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</p>
                    <button onclick="loadTrendKeywords()" class="btn-primary py-2 px-6 rounded-full scale-110">ì§€ê¸ˆ
                        ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
            </div>
        </div>

        <p class="text-center text-xs text-gray-500 mt-2">* ê²€ìƒ‰ëŸ‰ ê¸°ë°˜ AI ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤. ì›ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤.</p>
    </div>
</div>

<style>
    .bubble {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    /* Removed .bubble:hover transform to prevent conflict with D3 */
    .bubble:hover {
        z-index: 20;
    }

    .bubble text {
        pointer-events: none;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .loader-lg {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1000;
    }
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>


<!-- ê²€ìƒ‰ ì„¹ì…˜ -->
<div class="card mb-6">
    <div class="flex gap-4 mb-4">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ìš”ë¦¬, ì—¬í–‰, í…Œí¬)" class="input-field flex-1"
            onkeypress="if(event.key==='Enter') searchVideos()">
        <select id="searchOrder" class="input-field w-40">
            <option value="relevance">ê´€ë ¨ì„±</option>
            <option value="viewCount">ì¡°íšŒìˆ˜</option>
            <option value="date">ìµœì‹ ìˆœ</option>
            <option value="rating">í‰ì </option>
        </select>
        <select id="searchPeriod" class="input-field w-40">
            <option value="">ì „ì²´ ê¸°ê°„</option>
            <option value="week">ìµœê·¼ 1ì£¼</option>
            <option value="month">ìµœê·¼ 1ë‹¬</option>
            <option value="year">ìµœê·¼ 1ë…„</option>
        </select>
        <select id="searchLanguage" class="input-field w-40">
            <option value="">ëª¨ë“  ì–¸ì–´</option>
            <option value="ko">í•œêµ­ì–´</option>
            <option value="en">English</option>
            <option value="ja">Japanese</option>
            <option value="es">Spanish</option>
        </select>
        <button onclick="searchVideos()" class="btn-primary flex items-center gap-2">
            <span>ğŸ”</span>
            <span>ê²€ìƒ‰</span>
        </button>
    </div>

    <!-- ì¶”ì²œ ì£¼ì œ -->
    <div class="flex flex-wrap gap-2">
        <span class="text-sm text-gray-500 mr-2">ì¶”ì²œ ì£¼ì œ:</span>
        <button onclick="setSearchTopic('ì¼ìƒ ë¸Œì´ë¡œê·¸')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ì¼ìƒ
            ë¸Œì´ë¡œê·¸</button>
        <button onclick="setSearchTopic('ë¨¹ë°©')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ë¨¹ë°©</button>
        <button onclick="setSearchTopic('IT í…Œí¬')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">IT
            í…Œí¬</button>
        <button onclick="setSearchTopic('ì¬í…Œí¬')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ì¬í…Œí¬</button>
        <button onclick="setSearchTopic('ìš´ë™ í—¬ìŠ¤')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ìš´ë™
            í—¬ìŠ¤</button>
        <button onclick="setSearchTopic('ê²Œì„')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ê²Œì„</button>
        <button onclick="setSearchTopic('ìê¸°ê³„ë°œ')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ìê¸°ê³„ë°œ</button>
    </div>
</div>

<!-- ë¡œë”© í‘œì‹œ -->
<div id="loadingSection" class="hidden">
    <div class="card text-center py-12">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-500">ê²€ìƒ‰ ì¤‘...</p>
    </div>
</div>

<!-- ê²€ìƒ‰ ê²°ê³¼ -->
<div id="resultsSection" class="hidden">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-800 dark:text-white">
            ê²€ìƒ‰ ê²°ê³¼ <span id="resultCount" class="text-gray-500 font-normal"></span>
        </h2>
        <div class="flex gap-2">
            <button onclick="sortVideos('viral')" class="btn-secondary text-sm">ğŸ”¥ ì„±ê³¼ë„ìˆœ</button>
            <button onclick="sortVideos('views')" class="btn-secondary text-sm">ğŸ‘ï¸ ì¡°íšŒìˆ˜ìˆœ</button>
            <button onclick="saveSelectedToArchive()" class="btn-primary text-sm bg-green-600 hover:bg-green-700">ğŸ“‚ ì„ íƒ
                ë³´ê´€</button>
            <button onclick="openBatchAnalysisModal()"
                class="btn-primary text-sm bg-blue-600 hover:bg-blue-700 flex items-center gap-1">
                <span>âš¡</span> ë¶„ì„ ë° ìƒì„±
            </button>
        </div>
    </div>

    <div
        class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="p-4">
                        <div class="flex items-center">
                            <input id="checkbox-all" type="checkbox" onclick="toggleAllCheckboxes(this)"
                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        </div>
                    </th>
                    <th scope="col" class="px-2 py-3">ì¸ë„¤ì¼</th>
                    <th scope="col" class="px-2 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600"
                        onclick="sortVideos('channel')">ì±„ë„ëª…</th>
                    <th scope="col" class="px-2 py-3 w-[30%]">ì œëª©</th>
                    <th scope="col" class="px-2 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600"
                        onclick="sortVideos('date')">ì—…ë¡œë“œ</th>
                    <th scope="col" class="px-2 py-3 text-right">êµ¬ë…ììˆ˜</th>
                    <th scope="col" class="px-2 py-3 text-right cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600"
                        onclick="sortVideos('views')">ì¡°íšŒìˆ˜</th>
                    <th scope="col" class="px-2 py-3 text-center">ê¸°ì—¬ë„</th>
                    <th scope="col"
                        class="px-2 py-3 text-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600"
                        onclick="sortVideos('performance')">ì„±ê³¼ë„</th>
                    <th scope="col" class="px-2 py-3 text-right">ì¢‹ì•„ìš”</th>
                    <th scope="col" class="px-2 py-3 text-center">ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="videoTableBody">
                <!-- Rows rendered here -->
            </tbody>
        </table>
    </div>
</div>

<!-- ë¹ˆ ìƒíƒœ -->
<div id="emptySection" class="card text-center py-12">
    <div class="text-5xl mb-4">ğŸ¬</div>
    <h3 class="text-xl font-semibold text-gray-700 dark:text-white mb-2">ì˜ìƒì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3>
    <p class="text-gray-500">ì¸ê¸° ìˆëŠ” ì£¼ì œë¥¼ ì°¾ì•„ ì½˜í…ì¸  ì•„ì´ë””ì–´ë¥¼ ì–»ìœ¼ì„¸ìš”</p>
</div>

<!-- [REMOVED] Analysis Modal replaced by direct navigation to Script Plan -->
<div id="loadingOverlay" class="modal-overlay hidden">
    <div
        class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl flex flex-col items-center gap-4 max-w-sm w-full mx-4">
        <div class="loader-lg"></div>
        <div class="text-center">
            <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-1">AI ì‹¬ì¸µ ë¶„ì„ ì¤‘...</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">ì˜ìƒì˜ ì¸ê¸° ë¹„ê²°ê³¼ ì‹œì²­ì ë‹ˆì¦ˆë¥¼ íŒŒì•…í•˜ì—¬<br />ìµœì ì˜ ê¸°íšì•ˆì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        <div id="loadingVideoTitle" class="text-xs text-indigo-500 font-medium truncate w-full text-center"></div>
    </div>
</div>

<!-- [NEW] Batch Analysis Modal -->
<div id="batchAnalysisModal" class="modal-overlay hidden">
    <div class="modal-content max-w-md">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <span>ğŸ“Š</span>
                <span>ì¼ê´„ ë¶„ì„ ë° ìƒì„±</span>
            </h3>
            <button onclick="closeBatchModal()"
                class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                <span class="text-2xl">&times;</span>
            </button>
        </div>
        <div class="p-6">
            <p class="text-gray-600 dark:text-white mb-4">ì„ íƒí•œ <span id="batchCount"
                    class="font-bold text-blue-600">0</span>ê°œì˜ ì˜ìƒì— ëŒ€í•´<br />ì„±ê³µ ìš”ì¸ì„ ë¶„ì„í•˜ê³  ìƒˆë¡œìš´ ê¸°íšì„ ìƒì„±í•©ë‹ˆë‹¤.</p>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-white mb-2">
                    ğŸ“ ì €ì¥í•  í´ë”ëª… (í”„ë¡œì íŠ¸ëª…)
                </label>
                <input type="text" id="batchFolderName"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                    placeholder="ì˜ˆ: ë¨¹ë°©_ì•„ì´ë””ì–´_ëª¨ìŒ">
            </div>

            <button id="btnStartBatch" onclick="startBatchAnalysis()"
                class="w-full btn-primary py-3 flex items-center justify-center gap-2">
                <span>ğŸš€</span>
                <span>ë¶„ì„ ì‹œì‘ ë° íŒŒì¼ ìƒì„±</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentVideos = [];
    let currentVideoForAnalysis = null;
    let currentAnalysisResult = null; // [NEW] State persistence

    // ì£¼ì œ ì„¤ì •
    function setSearchTopic(topic) {
        document.getElementById('searchInput').value = topic;
        searchVideos();
    }

    // ê¸°ê°„ í•„í„° ê³„ì‚°
    function getPublishedAfter(filter) {
        const now = new Date();
        switch (filter) {
            case 'week': return new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString();
            case 'month': return new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString();
            case 'year': return new Date(now - 365 * 24 * 60 * 60 * 1000).toISOString();
            default: return null;
        }
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    async function searchVideos() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            Utils.showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const order = document.getElementById('searchOrder').value;
        const period = document.getElementById('searchPeriod').value;
        const language = document.getElementById('searchLanguage').value;

        document.getElementById('emptySection').classList.add('hidden');
        document.getElementById('resultsSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.remove('hidden');

        try {
            // 1. ê²€ìƒ‰
            // [NEW] Check App Mode for Duration Filter
            let appMode = 'longform';
            try {
                const stored = localStorage.getItem('app_mode') || localStorage.getItem('currentAppMode');
                if (stored) appMode = stored;
                console.log(`[Search] App Mode: ${appMode}`);
            } catch (e) { }

            const options = {
                maxResults: 24,
                order: order,
                publishedAfter: getPublishedAfter(period),
                relevance_language: language
            };

            // Server-side optimized filter for Shorts
            if (appMode === 'shorts') {
                options.videoDuration = 'short';
            }

            const searchResult = await API.youtube.search(query, options);

            if (!searchResult.items || searchResult.items.length === 0) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('emptySection').classList.remove('hidden');
                Utils.showToast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
                return;
            }

            // 2. ë¹„ë””ì˜¤ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const videoIds = searchResult.items.map(item => item.id.videoId).join(',');
            const detailResult = await fetch(`/api/youtube/videos/${videoIds}`);
            const detailData = await detailResult.json();

            // 3. ì±„ë„ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (êµ¬ë…ì ìˆ˜ ë“±)
            const channelIds = [...new Set(detailData.items.map(v => v.snippet.channelId))];
            let channelsMap = {};
            if (channelIds.length > 0) {
                try {
                    const channelResult = await API.youtube.getChannel(channelIds.join(','));
                    if (channelResult.items) {
                        channelResult.items.forEach(c => {
                            channelsMap[c.id] = c;
                        });
                    }
                } catch (e) {
                    console.error("ì±„ë„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", e);
                }
            }

            // Duration Parser Helper
            const parseDuration = (pt) => {
                const match = pt.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
                if (!match) return 0;
                const h = (parseInt(match[1]) || 0);
                const m = (parseInt(match[2]) || 0);
                const s = (parseInt(match[3]) || 0);
                return h * 3600 + m * 60 + s;
            };

            // 4. ë°ì´í„° ë³‘í•© ë° ìŠ¤ì½”ì–´ ê³„ì‚° (+ Duration Filter)
            currentVideos = detailData.items
                .filter(video => {
                    // [NEW] Client-side Duration Filter
                    const durationSec = parseDuration(video.contentDetails.duration);
                    if (appMode === 'shorts') {
                        return durationSec < 180; // Shorts: < 3 min
                    } else {
                        return durationSec >= 60; // Longform: Exclude Shorts (< 1 min)
                    }
                })
                .map(video => {
                    const channel = channelsMap[video.snippet.channelId] || {};
                    const subs = parseInt(channel.statistics?.subscriberCount || 0);
                    const channelViews = parseInt(channel.statistics?.viewCount || 0);
                    const channelVideoCount = parseInt(channel.statistics?.videoCount || 0);

                    // ì±„ë„ í‰ê·  ì¡°íšŒìˆ˜ (ë‹¨ìˆœ ê³„ì‚°)
                    const channelAvgViews = channelVideoCount > 0 ? channelViews / channelVideoCount : 0;

                    const views = parseInt(video.statistics.viewCount || 0);

                    // ì±„ë„ ê¸°ì—¬ë„: í‰ì†Œë³´ë‹¤ ì–¼ë§ˆë‚˜ ë” ì˜ ë‚˜ì™”ë‚˜?
                    const contribution = channelAvgViews > 0 ? (views / channelAvgViews) * 100 : 0;

                    // ì„±ê³¼ë„ ë°°ìœ¨: êµ¬ë…ì ëŒ€ë¹„ ì¡°íšŒìˆ˜
                    const performance = subs > 0 ? (views / subs) : 0;

                    return {
                        ...video,
                        channelData: channel,
                        stats: {
                            subs,
                            contribution: contribution.toFixed(2),
                            performance: performance.toFixed(2)
                        },
                        viralScore: Utils.calculateViralScore(video)
                    };
                });

            // 5. ë Œë”ë§
            if (currentVideos.length === 0) {
                Utils.showToast(`${appMode === 'shorts' ? 'ì‡¼ì¸ ' : 'ë¡±í¼'} ì¡°ê±´ì— ë§ëŠ” ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.`, 'info');
            }
            renderVideos();

            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultCount').textContent = `(${currentVideos.length}ê°œ)`;

            savePageState(); // [NEW] Save State

        } catch (error) {
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            document.getElementById('loadingSection').classList.add('hidden');
            Utils.showToast('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // ë¹„ë””ì˜¤ ë Œë”ë§ (ë¦¬ìŠ¤íŠ¸/í…Œì´ë¸” í˜•íƒœ)
    function renderVideos() {
        const tbody = document.getElementById('videoTableBody');
        tbody.innerHTML = currentVideos.map((video, index) => {
            const stats = video.stats || {};
            // ì„±ê³¼ë„ ë°°ìœ¨ ìƒ‰ìƒ
            const perfClass = stats.performance >= 5 ? 'text-red-500 font-bold' : (stats.performance >= 1 ? 'text-indigo-500' : 'text-gray-500');

            // ê¸°ì—¬ë„ ìƒ‰ìƒ
            const contribClass = stats.contribution >= 500 ? 'text-red-500 font-bold' : (stats.contribution >= 150 ? 'text-indigo-500' : 'text-gray-500');

            // Small thumbnail for table
            const thumbUrl = video.snippet.thumbnails.default?.url || video.snippet.thumbnails.medium?.url;

            return `
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                    <td class="w-4 p-4">
                        <div class="flex items-center">
                            <input id="checkbox-table-${index}" type="checkbox" data-video-id="${video.id}" class="video-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        </div>
                    </td>
                    <th scope="row" class="px-2 py-3 font-medium text-gray-900 dark:text-white whitespace-nowrap">
                         <!-- [Modified] ì¸ë„¤ì¼ í¬ê¸° 1.5ë°° í™•ëŒ€ (w-16 -> w-24, h-9 -> h-[54px]) -->
                         <div class="relative group w-24 h-[54px] overflow-hidden rounded shadow-sm">
                            <img class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300" src="${thumbUrl}" alt="Thumbnail">
                         </div>
                    </th>
                    <td class="px-2 py-3 text-gray-600 dark:text-gray-300 font-medium">
                        ${video.snippet.channelTitle}
                    </td>
                    <td class="px-2 py-3">
                        <a href="https://youtube.com/watch?v=${video.id}" target="_blank" class="text-gray-900 dark:text-white hover:text-indigo-600 dark:hover:text-indigo-400 font-medium line-clamp-2" title="${video.snippet.title}">
                            ${video.snippet.title}
                        </a>
                    </td>
                    <td class="px-2 py-3 text-gray-500 whitespace-nowrap">
                        ${video.snippet.publishedAt.split('T')[0]}
                    </td>
                    <td class="px-2 py-3 text-right">
                        ${Utils.formatNumber(stats.subs)}
                    </td>
                    <td class="px-2 py-3 text-right font-medium text-gray-900 dark:text-white">
                         ${Utils.formatNumber(video.statistics.viewCount)}
                    </td>
                    <td class="px-2 py-3 text-center ${contribClass}">
                        ${Utils.formatNumber(stats.contribution)}%
                    </td>
                    <td class="px-2 py-3 text-center ${perfClass}">
                        x${stats.performance}
                    </td>
                     <td class="px-2 py-3 text-right">
                        ğŸ‘ ${Utils.formatNumber(video.statistics.likeCount)}
                    </td>
                    <td class="px-2 py-3 text-center">
                        <div class="flex items-center justify-center gap-1">
                             <button onclick="openAnalysisModal('${video.id}')" class="p-1.5 text-blue-500 hover:bg-blue-50 dark:hover:bg-gray-700 rounded transition" title="ë¶„ì„">
                                ğŸ¤–
                            </button>
                             <button onclick="downloadThumbnail('${video.id}', '${video.snippet.thumbnails.high?.url}')" class="p-1.5 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" title="ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ">
                                â¬‡ï¸
                            </button>
                            <!-- Archive Actions -->
                             <button onclick="archiveVideo('${video.id}')" class="p-1.5 text-green-500 hover:bg-green-50 dark:hover:bg-gray-700 rounded transition" title="ì˜ìƒ ë³´ê´€">
                                ğŸ¬
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function sortVideos(type) {
        if (type === 'viral' || type === 'performance') {
            currentVideos.sort((a, b) => (parseFloat(b.stats.performance) || 0) - (parseFloat(a.stats.performance) || 0));
        } else if (type === 'views') {
            currentVideos.sort((a, b) => parseInt(b.statistics.viewCount) - parseInt(a.statistics.viewCount));
        } else if (type === 'date') {
            currentVideos.sort((a, b) => new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt));
        } else if (type === 'channel') {
            currentVideos.sort((a, b) => a.snippet.channelTitle.localeCompare(b.snippet.channelTitle));
        }
        renderVideos();
    }

    // [New] Checkbox helper
    function toggleAllCheckboxes(source) {
        const checkboxes = document.getElementsByClassName('video-checkbox');
        for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
    }

    // [New] Download helper
    function downloadThumbnail(videoId, url) {
        if (!url) {
            Utils.showToast("ì¸ë„¤ì¼ URLì´ ì—†ìŠµë‹ˆë‹¤.", "error");
            return;
        }
        const a = document.createElement('a');
        a.href = url;
        a.download = `thumbnail_${videoId}.jpg`;
        a.target = '_blank'; // YouTube URLs behave better with target blank usually
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // [New] Archive placeholder
    function archiveVideo(videoId) {
        Utils.showToast("ì˜ìƒ ë³´ê´€í•¨ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (Demo)", "success");
    }

    function saveSelectedToArchive() {
        const checkboxes = document.getElementsByClassName('video-checkbox');
        let count = 0;
        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) count++;
        }
        if (count === 0) {
            Utils.showToast("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤", "warning");
            return;
        }
        Utils.showToast(`${count}ê°œì˜ ì˜ìƒì„ ë³´ê´€í•¨ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤ (Demo)`, "success");
    }

    // ë¶„ì„ ì¤€ë¹„ ë° ì‹¤í–‰ (ì´ì œ íŒì—… ì—†ì´ ë°”ë¡œ ì‹¤í–‰ í›„ ì´ë™)
    async function openAnalysisModal(videoId) {
        const video = currentVideos.find(v => v.id === videoId);
        if (!video) return;

        currentVideoForAnalysis = video;

        // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
        const overlay = document.getElementById('loadingOverlay');
        const titleEl = document.getElementById('loadingVideoTitle');
        if (overlay) {
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }
        if (titleEl) titleEl.textContent = video.snippet.title;

        try {
            // 1. ìë§‰ ì¶”ì¶œ ì‹œë„
            let transcriptText = "";
            try {
                const transcriptRes = await fetch(`/api/youtube/transcript/${video.id}`);
                const transcriptData = await transcriptRes.json();
                if (transcriptData.status === 'ok') {
                    transcriptText = transcriptData.transcript;
                }
            } catch (e) { console.warn('ìë§‰ ì¶”ì¶œ ì‹¤íŒ¨:', e); }

            if (transcriptText) {
                currentVideoForAnalysis.transcript = transcriptText;
            }

            // 2. AI ë¶„ì„ ì‹¤í–‰
            const result = await API.gemini.analyzeComments(currentVideoForAnalysis);

            if (result.status === 'ok' && result.analysis) {
                currentAnalysisResult = result.analysis;

                // 3. ìë™ìœ¼ë¡œ ëŒ€ë³¸ ê¸°íš í˜ì´ì§€ë¡œ ì´ë™ (ë¶„ì„ ê²°ê³¼ ì €ì¥ í¬í•¨)
                await goToScriptPlan();
            } else {
                throw new Error(result.error || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        } catch (error) {
            console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
            Utils.showToast('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            if (overlay) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }
    }

    // [REMOVED] Replaced by auto-navigation logic in openAnalysisModal
    async function startAnalysis() { /* ... */ }
    function renderAnalysisResult(analysis, commentCount, hasTranscript) { /* ... */ }

    // ëŒ€ë³¸ ê¸°íšìœ¼ë¡œ ì´ë™ (í”„ë¡œì íŠ¸ ì €ì¥)
    async function goToScriptPlan() {
        if (!currentVideoForAnalysis || !currentAnalysisResult) {
            Utils.showToast('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        let projectId = getCurrentProject();

        // í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
        if (!projectId) {
            const title = currentVideoForAnalysis.snippet.title.substring(0, 30);
            const language = document.getElementById('searchLanguage').value || 'ko';

            // [MODIFIED] Use Keyword for Topic, Fallback to Video Title
            const keyword = document.getElementById('searchInput').value.trim();
            const result = await API.project.create(
                `${title}...`,
                keyword || currentVideoForAnalysis.snippet.title,
                language
            );
            if (result.project_id) {
                projectId = result.project_id;
                setCurrentProject(projectId);
                loadProjects(); // ì‚¬ì´ë“œë°” ê°±ì‹ 
            } else {
                Utils.showToast('í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }
        }

        // ë¶„ì„ ê²°ê³¼ë¥¼ DBì— ì €ì¥
        try {
            await API.project.saveAnalysis(projectId, currentVideoForAnalysis, currentAnalysisResult);
            Utils.showToast('ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

            // [MODIFIED] Check App Mode for Redirection and Pass Project ID
            const searchKeyword = document.getElementById('searchInput').value.trim();
            let redirectUrl = `/script-plan?project_id=${projectId}&auto=true&topic=${encodeURIComponent(searchKeyword)}`;
            if (window.APP_MODE === 'shorts') {
                redirectUrl += '&mode=shorts';
            }
            window.location.href = redirectUrl;
        } catch (e) {
            console.error('ì €ì¥ ì‹¤íŒ¨:', e);
            Utils.showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // --- Trend Keywords Logic (D3.js) ---
    let currentLang = 'ko'; // Default language

    async function loadTrendKeywords(lang) {
        if (lang) currentLang = lang;

        // UI Update (Language Tabs)
        updateTrendLangUI(currentLang);

        // Get Filter Values
        const period = document.getElementById('trend-period').value;
        const age = document.getElementById('trend-age').value;

        // Show Loading State
        const container = document.getElementById('bubbleChart');
        const loading = document.getElementById('bubbleLoading');
        const spinner = document.getElementById('bubbleSpinner');
        const placeholder = document.getElementById('bubblePlaceholder');

        if (!container || !loading) return;

        // Reset and Show Loading
        loading.classList.remove('hidden');
        spinner.classList.remove('hidden');
        placeholder.classList.add('hidden');
        loading.style.display = 'flex';

        console.log('Loading trend keywords...', { currentLang, period, age });

        try {
            const response = await fetch(`/api/trends/keywords?language=${currentLang}&period=${period}&age=${age}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();

            // Hide Loading Info
            spinner.classList.add('hidden');
            loading.style.display = 'none';

            if (data.status === 'ok' && data.keywords && data.keywords.length > 0) {
                // [NEW] Persist data to sessionStorage
                const persistData = {
                    lang: currentLang,
                    period: period,
                    age: age,
                    keywords: data.keywords,
                    timestamp: Date.now()
                };
                localStorage.setItem('trendKeywords', JSON.stringify(persistData));

                renderBubbleChart(data.keywords);
            } else {
                container.innerHTML = '<div class="text-gray-500 text-center py-20">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        } catch (e) {
            console.error('Trend keywords loading error:', e);
            spinner.classList.add('hidden');
            placeholder.classList.remove('hidden');
            Utils.showToast('ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    function changeTrendLanguage(lang) {
        currentLang = lang;
        updateTrendLangUI(lang);
        // We no longer auto-load when language tab is clicked to follow user request
        // But maybe users still want to switch lang and reload? 
        // User said "click the button to load", so I'll keep it manual.
        Utils.showToast(`${lang === 'ko' ? 'í•œêµ­ì–´' : lang === 'ja' ? 'ì¼ë³¸ì–´' : 'ì˜ì–´'} í•„í„°ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`, 'info');
    }

    function updateTrendLangUI(lang) {
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('bg-indigo-500', 'text-white', 'shadow-md');
            btn.classList.add('text-gray-500');
        });
        const activeBtn = document.getElementById(`btn-${lang}`);
        if (activeBtn) {
            activeBtn.classList.add('bg-indigo-500', 'text-white', 'shadow-md');
            activeBtn.classList.remove('text-gray-500');
        }
    }

    function restoreTrendKeywords() {
        const raw = localStorage.getItem('trendKeywords');
        if (!raw) return false;

        try {
            const data = JSON.parse(raw);
            currentLang = data.lang;

            // Update Filters
            document.getElementById('trend-period').value = data.period;
            document.getElementById('trend-age').value = data.age;
            updateTrendLangUI(data.lang);

            // Hide Loading/Placeholder and Render
            const loading = document.getElementById('bubbleLoading');
            if (loading) loading.style.display = 'none';

            renderBubbleChart(data.keywords);
            return true;
        } catch (e) {
            console.error("Trend restore failed:", e);
            return false;
        }
    }

    // [MODIFIED] Auto Batch Analysis (No Modal)
    async function startBatchAnalysis() {
        // 1. Get Selected Videos
        const checkboxes = document.getElementsByClassName('video-checkbox');
        const selectedVideos = [];
        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                const vidId = checkboxes[i].dataset.videoId;
                const vidData = currentVideos.find(v => v.id === vidId);
                if (vidData) {
                    selectedVideos.push({
                        id: vidData.id,
                        title: vidData.snippet.title,
                        channelTitle: vidData.snippet.channelTitle,
                        viewCount: vidData.statistics.viewCount,
                        likeCount: vidData.statistics.likeCount,
                        publishedAt: vidData.snippet.publishedAt
                    });
                }
            }
        }

        if (selectedVideos.length === 0) {
            Utils.showToast("ì„ íƒëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.", "warning");
            return;
        }

        // 2. Get Folder Name from Search Input
        let folderName = document.getElementById('searchInput').value.trim();
        if (!folderName) {
            folderName = "Untitled_Analysis_" + new Date().toISOString().slice(0, 10);
        }

        // 3. Confirm Action (Optional, but good UX to confirm before long process)
        if (!confirm(`${selectedVideos.length}ê°œì˜ ì˜ìƒì„ '${folderName}' í´ë”ë¡œ ë¶„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        // UI Loading (Change Button State)
        // Note: The button ID might need to be passed or found if we changed the caller
        // We will assume the caller button has ID 'btnAnalyzeAction' (I should add this ID to HTML)
        // OR generic loading toast
        Utils.showToast("ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)", "info");

        try {
            const res = await fetch('/api/topic/analyze-batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    folder_name: folderName,
                    videos: selectedVideos
                })
            });

            const data = await res.json();
            if (data.status === 'ok') {
                // Success
                Utils.showToast(`ë¶„ì„ ì™„ë£Œ! ${data.count}ê°œ ì˜ìƒ`, "success");

                // Show Repository Link
                Utils.showToast('ì €ì¥ì†Œì— ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                setTimeout(() => {
                    if (confirm('ì €ì¥ì†Œë¡œ ì´ë™í•˜ì—¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        window.location.href = '/repository';
                    }
                }, 500);

            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (e) {
            console.error(e);
            Utils.showToast(`ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, "error");
        }
    }

    // Modal Helper Removed (No longer needed)
    function openBatchAnalysisModal() {
        startBatchAnalysis();
    }

    function closeBatchModal() {
        // Empty
    }


    /* Old functions commented out or replaced above */
    // function startBatchAnalysis()... [REPLACED]

    function renderBubbleChart(data) {
        const container = document.getElementById('bubbleChart');
        const width = container.clientWidth;
        const height = 800;

        // Clear ALL previous SVGs immediately before rendering a new one
        // This solves race conditions where multiple fetches might return and stack charts
        d3.select("#bubbleChart").selectAll("svg").remove();

        // 1. Color palette
        const colorScale = d3.scaleLinear()
            .domain([0, 100])
            .range(["#E0E7FF", "#4F46E5"]);

        // 2. Prepare Data (calculate Radius)
        // Adjust exponent for visual variance (User request: make variance clear)
        // Use Power 2.5 for variance
        const radiusScale = d3.scalePow().exponent(0.5) // Sqrt scale is properly area-proportional, but we want exaggerated
            .domain([0, 100])
            .range([15, 60]); // Min 15px, Max 60px size

        const nodes = data.map(d => ({
            ...d,
            r: radiusScale(d.volume) * (d.volume > 80 ? 1.2 : 1), // Boost high volume
            x: Math.random() * width,
            y: Math.random() * height
        }));

        const svg = d3.select("#bubbleChart")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [0, 0, width, height])
            .attr("style", "max-width: 100%; height: auto;");

        // 3. Force Simulation (Wide Spread)
        const simulation = d3.forceSimulation(nodes)
            .force("x", d3.forceX(width / 2).strength(0.05)) // Weak horizontal pull -> Spread wide
            .force("y", d3.forceY(height / 2).strength(0.1)) // Stronger vertical pull -> Keep in band
            .force("collide", d3.forceCollide(d => d.r * 1.5).strength(0.8)) // Prevent overlap (adjusted for rectangle)
            .force("charge", d3.forceManyBody().strength(-10)); // Slight repulsion

        // 4. Render Elements
        const node = svg.append("g")
            .selectAll("g")
            .data(nodes)
            .join("g")
            .attr("class", "bubble")
            .call(drag(simulation)) // Optional: dragging
            .on("click", (event, d) => {
                document.getElementById('searchInput').value = d.data ? d.data.keyword : d.keyword;
                searchVideos();
            })
            .on("mouseover", function (event, d) {
                // 1. Bring to front
                d3.select(this).raise();

                // 2. Scale up rect and change color
                d3.select(this).select("rect")
                    .transition().duration(200)
                    .attr("width", d.r * 4.4)        // Scale up (Horizontal)
                    .attr("height", d.r * 2.2)      // Scale up
                    .attr("x", -d.r * 2.2)           // Recenter
                    .attr("y", -d.r * 1.1)
                    .attr("fill", "#60A5FA"); // Sky Blue (Tailwind blue-400)

                // 3. Scale up text
                d3.select(this).select("text")
                    .transition().duration(200)
                    .style("font-size", (Math.min(d.r / 1.5, 16) * 1.2) + "px")
                    .style("fill", "#fff");
            })
            .on("mouseout", function (event, d) {
                // Restore logic
                d3.select(this).select("rect")
                    .transition().duration(200)
                    .attr("width", d.r * 4)
                    .attr("height", d.r * 2)
                    .attr("x", -d.r * 2)
                    .attr("y", -d.r)
                    .attr("fill", d => colorScale(d.volume));

                d3.select(this).select("text")
                    .transition().duration(200)
                    .style("font-size", Math.min(d.r / 1.5, 16) + "px")
                    .style("fill", d.volume > 60 ? "#fff" : "#333");
            });

        // Use Rect instead of Circle
        const rects = node.append("rect")
            .attr("width", 0)
            .attr("height", 0)
            .attr("x", 0)
            .attr("y", 0)
            .attr("rx", 15) // Rounded corners (Soft Square)
            .attr("ry", 15)
            .attr("fill", d => colorScale(d.volume))
            .attr("fill-opacity", 0.9)
            .attr("stroke", "#fff")
            .attr("stroke-width", 2);

        // Transition rect size
        rects.transition().duration(800).ease(d3.easeBackOut)
            .attr("width", d => d.r * 4)
            .attr("height", d => d.r * 2)
            .attr("x", d => -d.r * 2) // Center properly
            .attr("y", d => -d.r);

        const labels = node.append("text")
            .style("text-anchor", "middle")
            .style("pointer-events", "none")
            // .attr("dy", "0.3em") // Removed in favor of tspan positioning
            .style("fill", d => d.volume > 60 ? "#fff" : "#333");

        // Main Keyword
        labels.append("tspan")
            .attr("x", 0)
            .attr("dy", d => d.translation ? "-0.2em" : "0.3em") // Adjust vertical center based on content
            .style("font-size", d => Math.min(d.r / 1.5, 16) + "px")
            .style("font-weight", "bold")
            .text(d => d.keyword.substring(0, d.r / 2.5)); // Truncate longer text

        // Translation (if distinct)
        labels.append("tspan")
            .attr("x", 0)
            .attr("dy", "1.2em")
            .style("font-size", d => Math.min(d.r / 2.5, 12) + "px") // Smaller font
            .style("font-weight", "normal")
            .style("opacity", 0.9)
            .text(d => (d.translation && d.translation !== d.keyword) ? d.translation : "");

        // 5. Simulation Tick
        simulation.on("tick", () => {
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // Helper: Dragging
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Restore search results and analysis modal
        restorePageState();

        // 2. Restore trend keywords or show placeholder
        if (!restoreTrendKeywords()) {
            console.log("No stored trends found. Waiting for user action.");
        }
    });

    // ESC í‚¤ëŠ” ì´ì œ í•„ìš” ì—†ìŒ (ëª¨ë‹¬ ì œê±°ë¨)

    // [NEW] Page State Management (SessionStorage)
    function savePageState() {
        const state = {
            query: document.getElementById('searchInput').value,
            order: document.getElementById('searchOrder').value,
            period: document.getElementById('searchPeriod').value,
            language: document.getElementById('searchLanguage').value,
            videos: currentVideos,
            videoForAnalysis: currentVideoForAnalysis,
            analysisResult: currentAnalysisResult,
            timestamp: Date.now()
        };
        localStorage.setItem('topicPageState', JSON.stringify(state));
    }

    function restorePageState() {
        try {
            const raw = localStorage.getItem('topicPageState');
            if (!raw) return false;
            const state = JSON.parse(raw);

            // 1. Restore Inputs
            if (state.query) document.getElementById('searchInput').value = state.query;
            if (state.order) document.getElementById('searchOrder').value = state.order;
            if (state.period) document.getElementById('searchPeriod').value = state.period;
            if (state.language) document.getElementById('searchLanguage').value = state.language;

            // 2. Restore Results
            if (state.videos && state.videos.length > 0) {
                currentVideos = state.videos;
                renderVideos();
                document.getElementById('emptySection').classList.add('hidden');
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('resultCount').textContent = `(${currentVideos.length}ê°œ)`;
            }

            // 3. Restore Analysis Modal (Legacy check removed as we now use direct navigation)
            return true;
        } catch (e) {
            console.error("State restore failed:", e);
            return false;
        }
    }

    // Modal Close Logic (REMOVED)
    // window.closeModal = ...


    // [NEW] Project State Sync
    window.addEventListener('projectStateRestored', (e) => {
        // [MODIFIED] Only clear if there's no state to restore (e.g. new project)
        // If we have stored state, restorePageState will handle it.
        const hasRestored = restorePageState();

        if (!hasRestored) {
            clearTopicPage();
        }

        // ë§Œì•½ í”„ë¡œì íŠ¸ì— ì €ì¥ëœ ì£¼ì œê°€ ìˆë‹¤ë©´ ê²€ìƒ‰ì°½ì— ë°˜ì˜ (ê²€ìƒ‰ì–´ ì…ë ¥ì€ í”„ë¡œì íŠ¸ ë°ì´í„° ìš°ì„ )
        const data = e.detail;
        if (data && data.project && data.project.topic) {
            document.getElementById('searchInput').value = data.project.topic;
            // ì£¼ì œê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ìƒíƒœ ë‹¤ì‹œ ì €ì¥
            savePageState();
        }
    });

    function clearTopicPage() {
        // Inputs
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.value = '';

        // Results
        currentVideos = [];
        const tbody = document.getElementById('videoTableBody');
        if (tbody) tbody.innerHTML = '';

        const resultsSection = document.getElementById('resultsSection');
        if (resultsSection) resultsSection.classList.add('hidden');

        const emptySection = document.getElementById('emptySection');
        if (emptySection) emptySection.classList.remove('hidden');

        const loadingSection = document.getElementById('loadingSection');
        if (loadingSection) loadingSection.classList.add('hidden');

        const resultCount = document.getElementById('resultCount');
        if (resultCount) resultCount.textContent = '';

        // State vars
        currentVideoForAnalysis = null;
        currentAnalysisResult = null;
    }

</script>
{% endblock %}