{% extends "base.html" %}

{% block content %}
<!-- í˜ì´ì§€ í—¤ë” -->
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ”</span>
        <div>
            <h1>ì£¼ì œ ì°¾ê¸°</h1>
            <p>ìœ íŠœë¸Œì—ì„œ ì¸ê¸° ìˆëŠ” ì£¼ì œë¥¼ ê²€ìƒ‰í•˜ê³  ë¶„ì„í•˜ì„¸ìš”</p>
        </div>
    </div>
    <!-- í‹ˆìƒˆ ì£¼ì œ -->
    <div class="flex flex-wrap gap-1 mt-3 text-xs">
        <button onclick="setSearchTopic('ì‚¼êµ­ì§€')" class="topic-btn">ğŸ“– ì‚¼êµ­ì§€</button>
        <button onclick="setSearchTopic('ì˜›ë‚ ì´ì•¼ê¸°')" class="topic-btn">ğŸ“– ì˜›ë‚ ì´ì•¼ê¸°</button>
        <button onclick="setSearchTopic('ê³¼í•™')" class="topic-btn">ğŸ”¬ ê³¼í•™</button>
        <button onclick="setSearchTopic('ì—­ì‚¬')" class="topic-btn">ğŸ“œ ì—­ì‚¬</button>
        <button onclick="setSearchTopic('í˜¸ëŸ¬')" class="topic-btn">ğŸ‘» í˜¸ëŸ¬</button>
        <button onclick="setSearchTopic('ì‚¬íšŒíŠ¸ë Œë“œ')" class="topic-btn">ğŸ“Š ì‚¬íšŒíŠ¸ë Œë“œ</button>
        <button onclick="setSearchTopic('ë¶í•œ')" class="topic-btn">ğŸ‡°ğŸ‡µ ë¶í•œ</button>
        <button onclick="setSearchTopic('ìš°ì£¼')" class="topic-btn">ğŸš€ ìš°ì£¼</button>
        <button onclick="setSearchTopic('ìê¸°ê³„ë°œ')" class="topic-btn">ğŸ’ª ìê¸°ê³„ë°œ</button>
        <button onclick="setSearchTopic('ì¬í…Œí¬')" class="topic-btn">ğŸ’° ì¬í…Œí¬</button>
        <button onclick="setSearchTopic('ì‹¬ë¦¬í•™')" class="topic-btn">ğŸ§  ì‹¬ë¦¬í•™</button>
        <button onclick="setSearchTopic('ë¯¸ìŠ¤í„°ë¦¬')" class="topic-btn">ğŸ” ë¯¸ìŠ¤í„°ë¦¬</button>
        <button onclick="setSearchTopic('ê±´ê°•')" class="topic-btn">ğŸ¥ ê±´ê°•</button>
        <button onclick="setSearchTopic('ë™ë¬¼')" class="topic-btn">ğŸ¦ ë™ë¬¼</button>
        <button onclick="setSearchTopic('ì„¸ê³„ì—¬í–‰')" class="topic-btn">âœˆï¸ ì„¸ê³„ì—¬í–‰</button>
        <button onclick="setSearchTopic('ì² í•™')" class="topic-btn">ğŸ’­ ì² í•™</button>
        <button onclick="setSearchTopic('ê²Œì„')" class="topic-btn">ğŸ® ê²Œì„</button>
        <button onclick="setSearchTopic('ì˜í™”')" class="topic-btn">ğŸ¬ ì˜í™”</button>
        <button onclick="setSearchTopic('ìŒì‹')" class="topic-btn">ğŸœ ìŒì‹</button>
        <button onclick="setSearchTopic('ìš´ë™')" class="topic-btn">ğŸ‹ï¸ ìš´ë™</button>
        <button onclick="setSearchTopic('ì—°ì• ')" class="topic-btn">ğŸ’• ì—°ì• </button>
        <button onclick="setSearchTopic('ìœ¡ì•„')" class="topic-btn">ğŸ‘¶ ìœ¡ì•„</button>
        <button onclick="setSearchTopic('ITí…Œí¬')" class="topic-btn">ğŸ’» ITí…Œí¬</button>
        <button onclick="setSearchTopic('AI')" class="topic-btn">ğŸ¤– AI</button>
        <button onclick="setSearchTopic('ë¶€ë™ì‚°')" class="topic-btn">ğŸ  ë¶€ë™ì‚°</button>
        <button onclick="setSearchTopic('ì°½ì—…')" class="topic-btn">ğŸ¢ ì°½ì—…</button>
        <button onclick="setSearchTopic('ë²”ì£„ì‹¤í™”')" class="topic-btn">ğŸš” ë²”ì£„ì‹¤í™”</button>
        <button onclick="setSearchTopic('ë°€ë¦¬í„°ë¦¬')" class="topic-btn">ğŸ–ï¸ ë°€ë¦¬í„°ë¦¬</button>
        <button onclick="setSearchTopic('ì¢…êµ')" class="topic-btn">ğŸ™ ì¢…êµ</button>
        <button onclick="setSearchTopic('ìŒì•…')" class="topic-btn">ğŸµ ìŒì•…</button>
        <button onclick="setSearchTopic('ë¯¸ìˆ ')" class="topic-btn">ğŸ¨ ë¯¸ìˆ </button>
        <button onclick="setSearchTopic('íŒ¨ì…˜')" class="topic-btn">ğŸ‘— íŒ¨ì…˜</button>
        <button onclick="setSearchTopic('ìë™ì°¨')" class="topic-btn">ğŸš— ìë™ì°¨</button>
        <button onclick="setSearchTopic('ìŠ¤í¬ì¸ ')" class="topic-btn">âš½ ìŠ¤í¬ì¸ </button>
        <button onclick="setSearchTopic('ìš”ë¦¬')" class="topic-btn">ğŸ‘¨â€ğŸ³ ìš”ë¦¬</button>
        <button onclick="setSearchTopic('ì¸í…Œë¦¬ì–´')" class="topic-btn">ğŸ›‹ï¸ ì¸í…Œë¦¬ì–´</button>
        <button onclick="setSearchTopic('í™˜ê²½')" class="topic-btn">ğŸŒ í™˜ê²½</button>
        <button onclick="setSearchTopic('ë²•ë¥ ')" class="topic-btn">âš–ï¸ ë²•ë¥ </button>
        <button onclick="setSearchTopic('ì–¸ì–´')" class="topic-btn">ğŸ—£ï¸ ì–¸ì–´</button>
        <button onclick="setSearchTopic('ì›¹íˆ°')" class="topic-btn">ğŸ“š ì›¹íˆ°</button>
    </div>
</div>

<!-- ê²€ìƒ‰ ì„¹ì…˜ -->
<div class="card mb-6">
    <div class="flex gap-4 mb-4">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ìš”ë¦¬, ì—¬í–‰, í…Œí¬)"
            class="input-field flex-1" onkeypress="if(event.key==='Enter') searchVideos()">
        <select id="searchOrder" class="input-field w-40">
            <option value="relevance">ê´€ë ¨ì„±</option>
            <option value="viewCount">ì¡°íšŒìˆ˜</option>
            <option value="date">ìµœì‹ ìˆœ</option>
            <option value="rating">í‰ì </option>
        </select>
        <select id="searchPeriod" class="input-field w-40">
            <option value="">ì „ì²´ ê¸°ê°„</option>
            <option value="week">ìµœê·¼ 1ì£¼</option>
            <option value="month">ìµœê·¼ 1ë‹¬</option>
            <option value="year">ìµœê·¼ 1ë…„</option>
        </select>
        <button onclick="searchVideos()" class="btn-primary flex items-center gap-2">
            <span>ğŸ”</span>
            <span>ê²€ìƒ‰</span>
        </button>
    </div>

    <!-- ì¶”ì²œ ì£¼ì œ -->
    <div class="flex flex-wrap gap-2">
        <span class="text-sm text-gray-500 mr-2">ì¶”ì²œ ì£¼ì œ:</span>
        <button onclick="setSearchTopic('ì¼ìƒ ë¸Œì´ë¡œê·¸')" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ì¼ìƒ ë¸Œì´ë¡œê·¸</button>
        <button onclick="setSearchTopic('ë¨¹ë°©')" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ë¨¹ë°©</button>
        <button onclick="setSearchTopic('IT í…Œí¬')" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">IT í…Œí¬</button>
        <button onclick="setSearchTopic('ì¬í…Œí¬')" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ì¬í…Œí¬</button>
        <button onclick="setSearchTopic('ìš´ë™ í—¬ìŠ¤')" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ìš´ë™ í—¬ìŠ¤</button>
        <button onclick="setSearchTopic('ê²Œì„')" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ê²Œì„</button>
        <button onclick="setSearchTopic('ìê¸°ê³„ë°œ')" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ìê¸°ê³„ë°œ</button>
    </div>
</div>

<!-- ë¡œë”© í‘œì‹œ -->
<div id="loadingSection" class="hidden">
    <div class="card text-center py-12">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-500">ê²€ìƒ‰ ì¤‘...</p>
    </div>
</div>

<!-- ê²€ìƒ‰ ê²°ê³¼ -->
<div id="resultsSection" class="hidden">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-800 dark:text-white">
            ê²€ìƒ‰ ê²°ê³¼ <span id="resultCount" class="text-gray-500 font-normal"></span>
        </h2>
        <div class="flex gap-2">
            <button onclick="sortVideos('viral')" class="btn-secondary text-sm">ğŸ”¥ ë°”ì´ëŸ´ìˆœ</button>
            <button onclick="sortVideos('views')" class="btn-secondary text-sm">ğŸ‘ï¸ ì¡°íšŒìˆ˜ìˆœ</button>
        </div>
    </div>

    <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- ë¹„ë””ì˜¤ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
    </div>
</div>

<!-- ë¹ˆ ìƒíƒœ -->
<div id="emptySection" class="card text-center py-12">
    <div class="text-5xl mb-4">ğŸ¬</div>
    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3>
    <p class="text-gray-500">ì¸ê¸° ìˆëŠ” ì£¼ì œë¥¼ ì°¾ì•„ ì½˜í…ì¸  ì•„ì´ë””ì–´ë¥¼ ì–»ìœ¼ì„¸ìš”</p>
</div>

<!-- ë¶„ì„ ëª¨ë‹¬ -->
<div id="analysisModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <span>ğŸ¤–</span>
                <span>AI ëŒ“ê¸€ ë¶„ì„</span>
            </h3>
            <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                <span class="text-2xl">&times;</span>
            </button>
        </div>
        <div id="modalContent" class="p-6 overflow-y-auto max-h-[70vh]">
            <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentVideos = [];
    let currentVideoForAnalysis = null;

    // ì£¼ì œ ì„¤ì •
    function setSearchTopic(topic) {
        document.getElementById('searchInput').value = topic;
        searchVideos();
    }

    // ê¸°ê°„ í•„í„° ê³„ì‚°
    function getPublishedAfter(filter) {
        const now = new Date();
        switch(filter) {
            case 'week': return new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString();
            case 'month': return new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString();
            case 'year': return new Date(now - 365 * 24 * 60 * 60 * 1000).toISOString();
            default: return null;
        }
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    async function searchVideos() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            Utils.showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const order = document.getElementById('searchOrder').value;
        const period = document.getElementById('searchPeriod').value;

        document.getElementById('emptySection').classList.add('hidden');
        document.getElementById('resultsSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.remove('hidden');

        try {
            // 1. ê²€ìƒ‰
            const searchResult = await API.youtube.search(query, {
                maxResults: 12,
                order: order,
                publishedAfter: getPublishedAfter(period)
            });

            if (!searchResult.items || searchResult.items.length === 0) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('emptySection').classList.remove('hidden');
                Utils.showToast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
                return;
            }

            // 2. ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const videoIds = searchResult.items.map(item => item.id.videoId).join(',');
            const detailResult = await fetch(`/api/youtube/videos/${videoIds}`);
            const detailData = await detailResult.json();

            // 3. ë°ì´í„° ë³‘í•© ë° ë°”ì´ëŸ´ ìŠ¤ì½”ì–´ ê³„ì‚°
            currentVideos = detailData.items.map(video => ({
                ...video,
                viralScore: Utils.calculateViralScore(video)
            }));

            // 4. ë Œë”ë§
            renderVideos();

            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultCount').textContent = `(${currentVideos.length}ê°œ)`;

        } catch (error) {
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            document.getElementById('loadingSection').classList.add('hidden');
            Utils.showToast('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // ë¹„ë””ì˜¤ ë Œë”ë§
    function renderVideos() {
        const grid = document.getElementById('videoGrid');
        grid.innerHTML = currentVideos.map(video => {
            const score = video.viralScore;
            const scoreClass = score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low';

            return `
                <div class="video-card">
                    <div class="video-thumbnail">
                        <img src="${video.snippet.thumbnails.high?.url || video.snippet.thumbnails.default.url}"
                            alt="${video.snippet.title}">
                        <span class="viral-score ${scoreClass}">${score}ì </span>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-800 dark:text-white mb-2 line-clamp-2">
                            ${video.snippet.title}
                        </h3>
                        <p class="text-sm text-gray-500 mb-3">${video.snippet.channelTitle}</p>
                        <div class="flex items-center gap-4 text-sm text-gray-500 mb-4">
                            <span>ğŸ‘ï¸ ${Utils.formatNumber(video.statistics.viewCount)}</span>
                            <span>ğŸ‘ ${Utils.formatNumber(video.statistics.likeCount)}</span>
                            <span>ğŸ’¬ ${Utils.formatNumber(video.statistics.commentCount)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="analyzeVideo('${video.id}')"
                                class="flex-1 btn-primary text-sm py-2">
                                ğŸ¤– ë¶„ì„
                            </button>
                            <a href="https://youtube.com/watch?v=${video.id}" target="_blank"
                                class="btn-secondary text-sm py-2 px-3">
                                â–¶ï¸
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ì •ë ¬
    function sortVideos(type) {
        if (type === 'viral') {
            currentVideos.sort((a, b) => b.viralScore - a.viralScore);
        } else if (type === 'views') {
            currentVideos.sort((a, b) => parseInt(b.statistics.viewCount) - parseInt(a.statistics.viewCount));
        }
        renderVideos();
    }

    // ë¶„ì„ ì‹¤í–‰
    async function analyzeVideo(videoId) {
        const video = currentVideos.find(v => v.id === videoId);
        if (!video) return;

        currentVideoForAnalysis = video;

        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
            <div class="text-center py-8">
                <div class="loader mx-auto mb-4"></div>
                <p class="text-gray-500">ëŒ“ê¸€ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                <p class="text-sm text-gray-400 mt-2">${video.snippet.title}</p>
            </div>
        `;
        document.getElementById('analysisModal').classList.remove('hidden');
        document.getElementById('analysisModal').classList.add('flex');

        try {
            const result = await API.gemini.analyzeComments(videoId, video.snippet.title);

            if (result.status === 'ok' && result.analysis) {
                currentAnalysisResult = result.analysis;
                renderAnalysisResult(result.analysis, result.comment_count);
            } else {
                modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">âŒ</div>
                        <p class="text-red-500">${result.error || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
            modalContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">âŒ</div>
                    <p class="text-red-500">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                </div>
            `;
        }
    }

    // ë¶„ì„ ê²°ê³¼ ë Œë”ë§
    function renderAnalysisResult(analysis, commentCount) {
        const modalContent = document.getElementById('modalContent');
        const video = currentVideoForAnalysis;

        modalContent.innerHTML = `
            <!-- ì˜ìƒ ì •ë³´ -->
            <div class="flex gap-4 mb-6">
                <img src="${video.snippet.thumbnails.medium.url}" class="w-32 rounded-lg">
                <div>
                    <h4 class="font-bold text-gray-800 dark:text-white">${video.snippet.title}</h4>
                    <p class="text-sm text-gray-500">${video.snippet.channelTitle}</p>
                    <p class="text-sm text-gray-400 mt-1">ë¶„ì„ëœ ëŒ“ê¸€: ${commentCount}ê°œ</p>
                </div>
            </div>

            <!-- ê°ì • ë¶„ì„ -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ“Š ê°ì • ë¶„ì„</h5>
                <div class="flex gap-4">
                    <div class="flex-1 bg-green-100 dark:bg-green-900/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-green-600">${analysis.sentiment?.positive || 0}%</div>
                        <div class="text-sm text-green-700 dark:text-green-400">ê¸ì •</div>
                    </div>
                    <div class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-gray-600 dark:text-gray-300">${analysis.sentiment?.neutral || 0}%</div>
                        <div class="text-sm text-gray-500">ì¤‘ë¦½</div>
                    </div>
                    <div class="flex-1 bg-red-100 dark:bg-red-900/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-red-600">${analysis.sentiment?.negative || 0}%</div>
                        <div class="text-sm text-red-700 dark:text-red-400">ë¶€ì •</div>
                    </div>
                </div>
            </div>

            <!-- ì£¼ìš” í† í”½ -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ·ï¸ ì£¼ìš” í† í”½</h5>
                <div class="flex flex-wrap gap-2">
                    ${(analysis.main_topics || []).map(topic => `
                        <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-sm">${topic}</span>
                    `).join('')}
                </div>
            </div>

            <!-- ì‹œì²­ì ë‹ˆì¦ˆ -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ’¡ ì‹œì²­ì ë‹ˆì¦ˆ</h5>
                <ul class="space-y-2">
                    ${(analysis.viewer_needs || []).map(need => `
                        <li class="flex items-start gap-2 text-gray-700 dark:text-gray-300">
                            <span class="text-yellow-500">âœ¦</span>
                            <span>${need}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <!-- ì½˜í…ì¸  ì œì•ˆ -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ¯ ì½˜í…ì¸  ì œì•ˆ</h5>
                <ul class="space-y-2">
                    ${(analysis.content_suggestions || []).map(suggestion => `
                        <li class="flex items-start gap-2 text-gray-700 dark:text-gray-300">
                            <span class="text-green-500">â†’</span>
                            <span>${suggestion}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <!-- ìš”ì•½ -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-2">ğŸ“ ìš”ì•½</h5>
                <p class="text-gray-700 dark:text-gray-300">${analysis.summary || ''}</p>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <button onclick="goToScriptPlan()" class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg">
                <span>ğŸš€</span>
                <span>ì´ ë¶„ì„ ê¸°ë°˜ìœ¼ë¡œ ëŒ€ë³¸ ë§Œë“¤ê¸°</span>
                <span>â†’</span>
            </button>
        `;
    }

    // ëŒ€ë³¸ ê¸°íšìœ¼ë¡œ ì´ë™ (í”„ë¡œì íŠ¸ ì €ì¥)
    async function goToScriptPlan() {
        if (!currentVideoForAnalysis || !currentAnalysisResult) {
            Utils.showToast('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        let projectId = getCurrentProject();

        // í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
        if (!projectId) {
            const title = currentVideoForAnalysis.snippet.title.substring(0, 30);
            const result = await API.project.create(`${title}...`, currentVideoForAnalysis.snippet.title);
            if (result.project_id) {
                projectId = result.project_id;
                setCurrentProject(projectId);
                loadProjects(); // ì‚¬ì´ë“œë°” ê°±ì‹ 
            } else {
                Utils.showToast('í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }
        }

        // ë¶„ì„ ê²°ê³¼ë¥¼ DBì— ì €ì¥
        try {
            await API.project.saveAnalysis(projectId, currentVideoForAnalysis, currentAnalysisResult);
            Utils.showToast('ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            window.location.href = '/script-plan';
        } catch (e) {
            Utils.showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    let currentAnalysisResult = null;

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
        document.getElementById('analysisModal').classList.add('hidden');
        document.getElementById('analysisModal').classList.remove('flex');
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
</script>
{% endblock %}
