{% extends "base.html" %}

{% block content %}
<!-- í˜ì´ì§€ í—¤ë” -->
<div class="page-header">

    <!-- í‹ˆìƒˆ ì£¼ì œ -->
    <div class="flex flex-wrap gap-1 text-xs">
        <button onclick="setSearchTopic('ì‚¼êµ­ì§€')" class="topic-btn">ğŸ“– ì‚¼êµ­ì§€</button>
        <button onclick="setSearchTopic('ì˜›ë‚ ì´ì•¼ê¸°')" class="topic-btn">ğŸ“– ì˜›ë‚ ì´ì•¼ê¸°</button>
        <button onclick="setSearchTopic('ê³¼í•™')" class="topic-btn">ğŸ”¬ ê³¼í•™</button>
        <button onclick="setSearchTopic('ì—­ì‚¬')" class="topic-btn">ğŸ“œ ì—­ì‚¬</button>
        <button onclick="setSearchTopic('í˜¸ëŸ¬')" class="topic-btn">ğŸ‘» í˜¸ëŸ¬</button>
        <button onclick="setSearchTopic('ì‚¬íšŒíŠ¸ë Œë“œ')" class="topic-btn">ğŸ“Š ì‚¬íšŒíŠ¸ë Œë“œ</button>
        <button onclick="setSearchTopic('ë¶í•œ')" class="topic-btn">ğŸ‡°ğŸ‡µ ë¶í•œ</button>
        <button onclick="setSearchTopic('ìš°ì£¼')" class="topic-btn">ğŸš€ ìš°ì£¼</button>
        <button onclick="setSearchTopic('ìê¸°ê³„ë°œ')" class="topic-btn">ğŸ’ª ìê¸°ê³„ë°œ</button>
        <button onclick="setSearchTopic('ì¬í…Œí¬')" class="topic-btn">ğŸ’° ì¬í…Œí¬</button>
        <button onclick="setSearchTopic('ì‹¬ë¦¬í•™')" class="topic-btn">ğŸ§  ì‹¬ë¦¬í•™</button>
        <button onclick="setSearchTopic('ë¯¸ìŠ¤í„°ë¦¬')" class="topic-btn">ğŸ” ë¯¸ìŠ¤í„°ë¦¬</button>
        <button onclick="setSearchTopic('ê±´ê°•')" class="topic-btn">ğŸ¥ ê±´ê°•</button>
        <button onclick="setSearchTopic('ë™ë¬¼')" class="topic-btn">ğŸ¦ ë™ë¬¼</button>
        <button onclick="setSearchTopic('ì„¸ê³„ì—¬í–‰')" class="topic-btn">âœˆï¸ ì„¸ê³„ì—¬í–‰</button>
        <button onclick="setSearchTopic('ì² í•™')" class="topic-btn">ğŸ’­ ì² í•™</button>
        <button onclick="setSearchTopic('ê²Œì„')" class="topic-btn">ğŸ® ê²Œì„</button>
        <button onclick="setSearchTopic('ì˜í™”')" class="topic-btn">ğŸ¬ ì˜í™”</button>
        <button onclick="setSearchTopic('ìŒì‹')" class="topic-btn">ğŸœ ìŒì‹</button>
        <button onclick="setSearchTopic('ìš´ë™')" class="topic-btn">ğŸ‹ï¸ ìš´ë™</button>
        <button onclick="setSearchTopic('ì—°ì• ')" class="topic-btn">ğŸ’• ì—°ì• </button>
        <button onclick="setSearchTopic('ìœ¡ì•„')" class="topic-btn">ğŸ‘¶ ìœ¡ì•„</button>
        <button onclick="setSearchTopic('ITí…Œí¬')" class="topic-btn">ğŸ’» ITí…Œí¬</button>
        <button onclick="setSearchTopic('AI')" class="topic-btn">ğŸ¤– AI</button>
        <button onclick="setSearchTopic('ë¶€ë™ì‚°')" class="topic-btn">ğŸ  ë¶€ë™ì‚°</button>
        <button onclick="setSearchTopic('ì°½ì—…')" class="topic-btn">ğŸ¢ ì°½ì—…</button>
        <button onclick="setSearchTopic('ë²”ì£„ì‹¤í™”')" class="topic-btn">ğŸš” ë²”ì£„ì‹¤í™”</button>
        <button onclick="setSearchTopic('ë°€ë¦¬í„°ë¦¬')" class="topic-btn">ğŸ–ï¸ ë°€ë¦¬í„°ë¦¬</button>
        <button onclick="setSearchTopic('ì¢…êµ')" class="topic-btn">ğŸ™ ì¢…êµ</button>
        <button onclick="setSearchTopic('ìŒì•…')" class="topic-btn">ğŸµ ìŒì•…</button>
        <button onclick="setSearchTopic('ë¯¸ìˆ ')" class="topic-btn">ğŸ¨ ë¯¸ìˆ </button>
        <button onclick="setSearchTopic('íŒ¨ì…˜')" class="topic-btn">ğŸ‘— íŒ¨ì…˜</button>
        <button onclick="setSearchTopic('ìë™ì°¨')" class="topic-btn">ğŸš— ìë™ì°¨</button>
        <button onclick="setSearchTopic('ìŠ¤í¬ì¸ ')" class="topic-btn">âš½ ìŠ¤í¬ì¸ </button>
        <button onclick="setSearchTopic('ìš”ë¦¬')" class="topic-btn">ğŸ‘¨â€ğŸ³ ìš”ë¦¬</button>
        <button onclick="setSearchTopic('ì¸í…Œë¦¬ì–´')" class="topic-btn">ğŸ›‹ï¸ ì¸í…Œë¦¬ì–´</button>
        <button onclick="setSearchTopic('í™˜ê²½')" class="topic-btn">ğŸŒ í™˜ê²½</button>
        <button onclick="setSearchTopic('ë²•ë¥ ')" class="topic-btn">âš–ï¸ ë²•ë¥ </button>
        <button onclick="setSearchTopic('ì–¸ì–´')" class="topic-btn">ğŸ—£ï¸ ì–¸ì–´</button>
        <button onclick="setSearchTopic('ì›¹íˆ°')" class="topic-btn">ğŸ“š ì›¹íˆ°</button>
    </div>
</div>

<!-- íŠ¸ë Œë“œ í‚¤ì›Œë“œ ë²„ë¸” ì°¨íŠ¸ -->
<div
    class="card mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 border-none shadow-lg overflow-hidden relative">
    <div class="absolute top-0 right-0 p-4 opacity-10">
        <span class="text-9xl">â˜ï¸</span>
    </div>

    <div class="relative z-10">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-xl text-gray-800 dark:text-white flex items-center gap-2">
                <span>ğŸ”¥ ì‹¤ì‹œê°„ íŠ¸ë Œë“œ í‚¤ì›Œë“œ</span>
                <span
                    class="text-xs font-normal bg-red-100 text-red-600 px-2 py-0.5 rounded-full animate-pulse">LIVE</span>
            </h3>

            <!-- í•„í„° ê·¸ë£¹ (ì–¸ì–´ / ê¸°ê°„ / ì—°ë ¹) -->
            <div class="flex flex-wrap items-center gap-3">
                <!-- ê¸°ê°„ ì„ íƒ -->
                <select id="trend-period" onchange="loadTrendKeywords()"
                    class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
                    <option value="now">ì‹¤ì‹œê°„</option>
                    <option value="week">ì£¼ê°„ (7ì¼)</option>
                    <option value="month">ì›”ê°„ (30ì¼)</option>
                </select>

                <!-- ì—°ë ¹ ì„ íƒ -->
                <select id="trend-age" onchange="loadTrendKeywords()"
                    class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
                    <option value="all">ì „ì²´ ì—°ë ¹</option>
                    <option value="10s">10ëŒ€</option>
                    <option value="20s">20ëŒ€</option>
                    <option value="30s">30ëŒ€</option>
                    <option value="40s">40ëŒ€</option>
                    <option value="50s">50ëŒ€ ì´ìƒ</option>
                </select>

                <!-- ì–¸ì–´ ì„ íƒ -->
                <div class="flex bg-white dark:bg-gray-800 rounded-lg p-1 shadow-sm">
                    <button onclick="loadTrendKeywords('ko')" id="btn-ko"
                        class="lang-btn px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-indigo-500 text-white shadow-md">í•œêµ­ì–´</button>
                    <button onclick="loadTrendKeywords('ja')" id="btn-ja"
                        class="lang-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-indigo-500 transition-all">æ—¥æœ¬èª</button>
                    <button onclick="loadTrendKeywords('en')" id="btn-en"
                        class="lang-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-indigo-500 transition-all">Eng</button>
                    <button onclick="loadTrendKeywords('es')" id="btn-es"
                        class="lang-btn px-3 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-indigo-500 transition-all">Esp</button>
                </div>
            </div>
        </div>

        <!-- ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ -->
        <div id="bubbleChart" class="w-full h-[600px] flex items-center justify-center relative">
            <div class="absolute inset-0 flex items-center justify-center text-gray-400 pointer-events-none"
                id="bubbleLoading">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
            </div>
        </div>

        <p class="text-center text-xs text-gray-500 mt-2">* ê²€ìƒ‰ëŸ‰ ê¸°ë°˜ AI ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤. ì›ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤.</p>
    </div>
</div>

<style>
    .bubble {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    /* Removed .bubble:hover transform to prevent conflict with D3 */
    .bubble:hover {
        z-index: 20;
    }

    .bubble text {
        pointer-events: none;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>


<!-- ê²€ìƒ‰ ì„¹ì…˜ -->
<div class="card mb-6">
    <div class="flex gap-4 mb-4">
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ìš”ë¦¬, ì—¬í–‰, í…Œí¬)" class="input-field flex-1"
            onkeypress="if(event.key==='Enter') searchVideos()">
        <select id="searchOrder" class="input-field w-40">
            <option value="relevance">ê´€ë ¨ì„±</option>
            <option value="viewCount">ì¡°íšŒìˆ˜</option>
            <option value="date">ìµœì‹ ìˆœ</option>
            <option value="rating">í‰ì </option>
        </select>
        <select id="searchPeriod" class="input-field w-40">
            <option value="">ì „ì²´ ê¸°ê°„</option>
            <option value="week">ìµœê·¼ 1ì£¼</option>
            <option value="month">ìµœê·¼ 1ë‹¬</option>
            <option value="year">ìµœê·¼ 1ë…„</option>
        </select>
        <select id="searchLanguage" class="input-field w-40">
            <option value="">ëª¨ë“  ì–¸ì–´</option>
            <option value="ko">í•œêµ­ì–´</option>
            <option value="en">English</option>
            <option value="ja">Japanese</option>
            <option value="es">Spanish</option>
        </select>
        <button onclick="searchVideos()" class="btn-primary flex items-center gap-2">
            <span>ğŸ”</span>
            <span>ê²€ìƒ‰</span>
        </button>
    </div>

    <!-- ì¶”ì²œ ì£¼ì œ -->
    <div class="flex flex-wrap gap-2">
        <span class="text-sm text-gray-500 mr-2">ì¶”ì²œ ì£¼ì œ:</span>
        <button onclick="setSearchTopic('ì¼ìƒ ë¸Œì´ë¡œê·¸')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ì¼ìƒ
            ë¸Œì´ë¡œê·¸</button>
        <button onclick="setSearchTopic('ë¨¹ë°©')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ë¨¹ë°©</button>
        <button onclick="setSearchTopic('IT í…Œí¬')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">IT
            í…Œí¬</button>
        <button onclick="setSearchTopic('ì¬í…Œí¬')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ì¬í…Œí¬</button>
        <button onclick="setSearchTopic('ìš´ë™ í—¬ìŠ¤')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ìš´ë™
            í—¬ìŠ¤</button>
        <button onclick="setSearchTopic('ê²Œì„')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ê²Œì„</button>
        <button onclick="setSearchTopic('ìê¸°ê³„ë°œ')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition">ìê¸°ê³„ë°œ</button>
    </div>
</div>

<!-- ë¡œë”© í‘œì‹œ -->
<div id="loadingSection" class="hidden">
    <div class="card text-center py-12">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-500">ê²€ìƒ‰ ì¤‘...</p>
    </div>
</div>

<!-- ê²€ìƒ‰ ê²°ê³¼ -->
<div id="resultsSection" class="hidden">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-800 dark:text-white">
            ê²€ìƒ‰ ê²°ê³¼ <span id="resultCount" class="text-gray-500 font-normal"></span>
        </h2>
        <div class="flex gap-2">
            <button onclick="sortVideos('viral')" class="btn-secondary text-sm">ğŸ”¥ ë°”ì´ëŸ´ìˆœ</button>
            <button onclick="sortVideos('views')" class="btn-secondary text-sm">ğŸ‘ï¸ ì¡°íšŒìˆ˜ìˆœ</button>
        </div>
    </div>

    <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- ë¹„ë””ì˜¤ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
    </div>
</div>

<!-- ë¹ˆ ìƒíƒœ -->
<div id="emptySection" class="card text-center py-12">
    <div class="text-5xl mb-4">ğŸ¬</div>
    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">ì˜ìƒì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3>
    <p class="text-gray-500">ì¸ê¸° ìˆëŠ” ì£¼ì œë¥¼ ì°¾ì•„ ì½˜í…ì¸  ì•„ì´ë””ì–´ë¥¼ ì–»ìœ¼ì„¸ìš”</p>
</div>

<!-- ë¶„ì„ ëª¨ë‹¬ -->
<div id="analysisModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                <span>ğŸ¤–</span>
                <span>AI ëŒ“ê¸€ ë¶„ì„</span>
            </h3>
            <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                <span class="text-2xl">&times;</span>
            </button>
        </div>
        <div id="modalContent" class="p-6 overflow-y-auto max-h-[70vh]">
            <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentVideos = [];
    let currentVideoForAnalysis = null;

    // ì£¼ì œ ì„¤ì •
    function setSearchTopic(topic) {
        document.getElementById('searchInput').value = topic;
        searchVideos();
    }

    // ê¸°ê°„ í•„í„° ê³„ì‚°
    function getPublishedAfter(filter) {
        const now = new Date();
        switch (filter) {
            case 'week': return new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString();
            case 'month': return new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString();
            case 'year': return new Date(now - 365 * 24 * 60 * 60 * 1000).toISOString();
            default: return null;
        }
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    async function searchVideos() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            Utils.showToast('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning');
            return;
        }

        const order = document.getElementById('searchOrder').value;
        const period = document.getElementById('searchPeriod').value;
        const language = document.getElementById('searchLanguage').value;

        document.getElementById('emptySection').classList.add('hidden');
        document.getElementById('resultsSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.remove('hidden');

        try {
            // 1. ê²€ìƒ‰
            const searchResult = await API.youtube.search(query, {
                maxResults: 24,
                order: order,
                publishedAfter: getPublishedAfter(period),
                relevance_language: language
            });

            if (!searchResult.items || searchResult.items.length === 0) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('emptySection').classList.remove('hidden');
                Utils.showToast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
                return;
            }

            // 2. ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const videoIds = searchResult.items.map(item => item.id.videoId).join(',');
            const detailResult = await fetch(`/api/youtube/videos/${videoIds}`);
            const detailData = await detailResult.json();

            // 3. ë°ì´í„° ë³‘í•© ë° ë°”ì´ëŸ´ ìŠ¤ì½”ì–´ ê³„ì‚°
            currentVideos = detailData.items.map(video => ({
                ...video,
                viralScore: Utils.calculateViralScore(video)
            }));

            // 4. ë Œë”ë§
            renderVideos();

            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultCount').textContent = `(${currentVideos.length}ê°œ)`;

        } catch (error) {
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            document.getElementById('loadingSection').classList.add('hidden');
            Utils.showToast('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // ë¹„ë””ì˜¤ ë Œë”ë§
    function renderVideos() {
        const grid = document.getElementById('videoGrid');
        grid.innerHTML = currentVideos.map(video => {
            const score = video.viralScore;
            const scoreClass = score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low';

            return `
                <div class="video-card">
                    <div class="video-thumbnail">
                        <img src="${video.snippet.thumbnails.high?.url || video.snippet.thumbnails.default.url}"
                            alt="${video.snippet.title}">
                        <span class="viral-score ${scoreClass}">${score}ì </span>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-800 dark:text-white mb-2 line-clamp-2">
                            ${video.snippet.title}
                        </h3>
                        <p class="text-sm text-gray-500 mb-3">${video.snippet.channelTitle}</p>
                        <div class="flex items-center gap-4 text-sm text-gray-500 mb-4">
                            <span>ğŸ‘ï¸ ${Utils.formatNumber(video.statistics.viewCount)}</span>
                            <span>ğŸ‘ ${Utils.formatNumber(video.statistics.likeCount)}</span>
                            <span>ğŸ’¬ ${Utils.formatNumber(video.statistics.commentCount)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openAnalysisModal('${video.id}')"
                                class="flex-1 btn-primary text-sm py-2">
                                ğŸ¤– ë¶„ì„
                            </button>
                            <a href="https://youtube.com/watch?v=${video.id}" target="_blank"
                                class="btn-secondary text-sm py-2 px-3">
                                â–¶ï¸
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function sortVideos(type) {
        if (type === 'viral') {
            currentVideos.sort((a, b) => b.viralScore - a.viralScore);
        } else if (type === 'views') {
            currentVideos.sort((a, b) => parseInt(b.statistics.viewCount) - parseInt(a.statistics.viewCount));
        }
        renderVideos();
    }

    // ë¶„ì„ ì¤€ë¹„ ëª¨ë‹¬ ì—´ê¸°
    function openAnalysisModal(videoId) {
        const video = currentVideos.find(v => v.id === videoId);
        if (!video) return;

        currentVideoForAnalysis = video;

        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
            <div class="p-2">
                <div class="flex gap-4 mb-6">
                    <img src="${video.snippet.thumbnails.medium.url}" class="w-24 rounded-lg">
                    <div>
                        <h4 class="font-bold text-gray-800 dark:text-white line-clamp-2">${video.snippet.title}</h4>
                        <p class="text-sm text-gray-500">${video.snippet.channelTitle}</p>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        ğŸ“œ ìŠ¤í¬ë¦½íŠ¸(ëŒ€ë³¸) ì§ì ‘ ì…ë ¥ (ì„ íƒì‚¬í•­)
                    </label>
                    <textarea id="manualScriptInput" 
                        class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-600 dark:text-white text-sm"
                        placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#13;&#10;ë¹„ì›Œë‘ë©´ ìë™ìœ¼ë¡œ ìœ íŠœë¸Œ ìë§‰ì„ ì¶”ì¶œí•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤."></textarea>
                    <p class="text-xs text-gray-500 mt-1">â€» ìë§‰ì´ ì—†ëŠ” ì˜ìƒì¼ ê²½ìš°, ì§ì ‘ ëŒ€ë³¸ì„ ì…ë ¥í•˜ë©´ ì‹¬ì¸µ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                </div>

                <button onclick="startAnalysis()" class="w-full btn-primary py-3 flex items-center justify-center gap-2">
                    <span>âœ¨</span>
                    <span>ë¶„ì„ ì‹œì‘í•˜ê¸°</span>
                </button>
            </div>
        `;
        document.getElementById('analysisModal').classList.remove('hidden');
        document.getElementById('analysisModal').classList.add('flex');
    }

    // ë¶„ì„ ì‹¤í–‰
    async function startAnalysis() {
        const video = currentVideoForAnalysis;
        const manualScript = document.getElementById('manualScriptInput').value.trim();

        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
            <div class="text-center py-8">
                <div class="loader mx-auto mb-4"></div>
                <p class="text-gray-500">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                <p class="text-sm text-gray-400 mt-2">${video.snippet.title}</p>
            </div>
        `;

        try {
            // 1. ìë§‰(ìŠ¤í¬ë¦½íŠ¸) ì¤€ë¹„
            let transcriptText = manualScript; // 1ìˆœìœ„: ì‚¬ìš©ì ì…ë ¥

            // ì…ë ¥ì´ ì—†ìœ¼ë©´ ìë™ ì¶”ì¶œ ì‹œë„
            if (!transcriptText) {
                try {
                    const transcriptRes = await fetch(`/api/youtube/transcript/${video.id}`);
                    const transcriptData = await transcriptRes.json();
                    if (transcriptData.status === 'ok') {
                        transcriptText = transcriptData.transcript;
                    }
                } catch (e) {
                    console.warn('ìë§‰ ì¶”ì¶œ ì‹¤íŒ¨:', e);
                }
            }

            // ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©í•  ìŠ¤í¬ë¦½íŠ¸ ì €ì¥
            if (transcriptText) {
                currentVideoForAnalysis.transcript = transcriptText;
            }

            // 2. ì¢…í•© ë¶„ì„ ìš”ì²­ (ëŒ“ê¸€ + ìŠ¤í¬ë¦½íŠ¸)
            const result = await API.gemini.analyzeComments(currentVideoForAnalysis);

            if (result.status === 'ok' && result.analysis) {
                currentAnalysisResult = result.analysis;
                renderAnalysisResult(result.analysis, result.comment_count, !!transcriptText);
            } else {
                modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">âŒ</div>
                        <p class="text-red-500">${result.error || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
            modalContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">âŒ</div>
                    <p class="text-red-500">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                </div>
            `;
        }
    }

    // ë¶„ì„ ê²°ê³¼ ë Œë”ë§
    function renderAnalysisResult(analysis, commentCount, hasTranscript) {
        const modalContent = document.getElementById('modalContent');
        const video = currentVideoForAnalysis;

        // ìŠ¤í¬ë¦½íŠ¸ ë¶„ì„ ì„¹ì…˜ HTML ìƒì„±
        let scriptAnalysisHtml = '';
        if (analysis.script_analysis) {
            const sa = analysis.script_analysis;
            scriptAnalysisHtml = `
            <!-- ìŠ¤í¬ë¦½íŠ¸ ë¶„ì„ (New) -->
            <div class="mb-6 bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg border border-indigo-100 dark:border-indigo-800">
                <h5 class="font-bold text-indigo-800 dark:text-indigo-300 mb-3 flex items-center gap-2">
                    <span>ğŸ“</span> ìŠ¤í¬ë¦½íŠ¸ ì‹¬ì¸µ ë¶„ì„
                </h5>
                <div class="space-y-3 text-sm">
                    <div>
                        <span class="font-semibold text-gray-700 dark:text-gray-300">ğŸ—ï¸ êµ¬ì¡°:</span>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">${sa.structure || 'ë¶„ì„ ë¶ˆê°€'}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700 dark:text-gray-300">ğŸª í›„í‚¹ ìš”ì†Œ:</span>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">${sa.hooks || 'ë¶„ì„ ë¶ˆê°€'}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700 dark:text-gray-300">âš¡ í˜ì´ì‹± & í†¤:</span>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">${sa.pacing || 'ë¶„ì„ ë¶ˆê°€'}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700 dark:text-gray-300">ğŸ”‘ í•µì‹¬ ë©”ì‹œì§€:</span>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">${sa.key_message || 'ë¶„ì„ ë¶ˆê°€'}</p>
                    </div>
                </div>
            </div>
            `;
        } else if (hasTranscript) {
            scriptAnalysisHtml = `
            <div class="mb-6 p-4 bg-gray-50 rounded-lg text-center text-gray-500 text-sm">
                ìë§‰ì€ ì¶”ì¶œí–ˆìœ¼ë‚˜ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>`;
        } else {
            scriptAnalysisHtml = `
            <div class="mb-6 p-4 bg-gray-50 rounded-lg text-center text-gray-500 text-sm">
                ì˜ìƒì— ìë§‰ì´ ì—†ì–´ ìŠ¤í¬ë¦½íŠ¸ ë¶„ì„ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.
            </div>`;
        }

        modalContent.innerHTML = `
            <!-- ì˜ìƒ ì •ë³´ -->
            <div class="flex gap-4 mb-6">
                <img src="${video.snippet.thumbnails.medium.url}" class="w-32 rounded-lg">
                <div>
                    <h4 class="font-bold text-gray-800 dark:text-white">${video.snippet.title}</h4>
                    <p class="text-sm text-gray-500">${video.snippet.channelTitle}</p>
                    <p class="text-sm text-gray-400 mt-1">ë¶„ì„ëœ ëŒ“ê¸€: ${commentCount}ê°œ ${hasTranscript ? '+ ìë§‰ í¬í•¨' : ''}</p>
                </div>
            </div>

            <!-- ê°ì • ë¶„ì„ -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ“Š ê°ì • ë¶„ì„</h5>
                <div class="flex gap-4">
                    <div class="flex-1 bg-green-100 dark:bg-green-900/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-green-600">${analysis.sentiment?.positive || 0}%</div>
                        <div class="text-sm text-green-700 dark:text-green-400">ê¸ì •</div>
                    </div>
                    <div class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-gray-600 dark:text-gray-300">${analysis.sentiment?.neutral || 0}%</div>
                        <div class="text-sm text-gray-500">ì¤‘ë¦½</div>
                    </div>
                    <div class="flex-1 bg-red-100 dark:bg-red-900/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-red-600">${analysis.sentiment?.negative || 0}%</div>
                        <div class="text-sm text-red-700 dark:text-red-400">ë¶€ì •</div>
                    </div>
                </div>
            </div>
            
            ${scriptAnalysisHtml}

            <!-- ì£¼ìš” í† í”½ -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ·ï¸ ì£¼ìš” í† í”½</h5>
                <div class="flex flex-wrap gap-2">
                    ${(analysis.main_topics || []).map(topic => `
                        <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-sm">${topic}</span>
                    `).join('')}
                </div>
            </div>

            <!-- ì‹œì²­ì ë‹ˆì¦ˆ -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ’¡ ì‹œì²­ì ë‹ˆì¦ˆ</h5>
                <ul class="space-y-2">
                    ${(analysis.viewer_needs || []).map(need => `
                        <li class="flex items-start gap-2 text-gray-700 dark:text-gray-300">
                            <span class="text-yellow-500">âœ¦</span>
                            <span>${need}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <!-- ì„±ê³µ ìš”ì¸ (New) -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ† ì¸ê¸° ë¹„ê²° (Success Factors)</h5>
                <ul class="space-y-2">
                    ${(analysis.success_factors || []).map(factor => `
                        <li class="flex items-start gap-2 text-gray-700 dark:text-gray-300">
                            <span class="text-red-500">â˜…</span>
                            <span class="font-medium">${factor}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <!-- ì½˜í…ì¸  ì œì•ˆ -->
            <div class="mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-3">ğŸ¯ ì½˜í…ì¸  ì œì•ˆ</h5>
                <ul class="space-y-2">
                    ${(analysis.content_suggestions || []).map(suggestion => `
                        <li class="flex items-start gap-2 text-gray-700 dark:text-gray-300">
                            <span class="text-green-500">â†’</span>
                            <span>${suggestion}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <!-- ìš”ì•½ -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                <h5 class="font-bold text-gray-800 dark:text-white mb-2">ğŸ“ ìš”ì•½</h5>
                <p class="text-gray-700 dark:text-gray-300">${analysis.summary || ''}</p>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <button onclick="goToScriptPlan()" class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg">
                <span>ğŸš€</span>
                <span>ëŒ€ë³¸ ê¸°íší•˜ê¸°</span>
                <span>â†’</span>
            </button>
        `;
    }

    // ëŒ€ë³¸ ê¸°íšìœ¼ë¡œ ì´ë™ (í”„ë¡œì íŠ¸ ì €ì¥)
    async function goToScriptPlan() {
        if (!currentVideoForAnalysis || !currentAnalysisResult) {
            Utils.showToast('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        let projectId = getCurrentProject();

        // í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
        if (!projectId) {
            const title = currentVideoForAnalysis.snippet.title.substring(0, 30);
            const language = document.getElementById('searchLanguage').value || 'ko';

            // create API calls automatically handle the object if changed to accept object
            // But checking api.js wrapper might be needed. Alternatively pass as args if wrapper signature allows.
            // Assuming API.project.create(name, topic, target_language) or object.
            // Let's assume we need to update api.js or call fetch directly? 
            // Looking at previous main.py change: ProjectCreate model.

            // NOTE: I need to verify how API.project.create is implemented. 
            // If it's a wrapper, I might need to update it.
            // For now, let's assume I can pass an object or extra arg.
            // Actually, let's pass a config object if supported or try to update API wrapper first.
            // Wait, I can't see api.js. I'll stick to a direct fetch or update api.js if I see it.
            // Let's check api.js location first? Usually in /static/js/api.js.
            // I'll take a safe bet and update the call assuming I'll fix the wrapper or it's flexible.

            const result = await API.project.create(
                `${title}...`,
                currentVideoForAnalysis.snippet.title,
                language
            );
            if (result.project_id) {
                projectId = result.project_id;
                setCurrentProject(projectId);
                loadProjects(); // ì‚¬ì´ë“œë°” ê°±ì‹ 
            } else {
                Utils.showToast('í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }
        }

        // ë¶„ì„ ê²°ê³¼ë¥¼ DBì— ì €ì¥
        try {
            await API.project.saveAnalysis(projectId, currentVideoForAnalysis, currentAnalysisResult);
            Utils.showToast('ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            window.location.href = '/script-plan?auto=true';
        } catch (e) {
            console.error('ì €ì¥ ì‹¤íŒ¨:', e);
            Utils.showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // --- Trend Keywords Logic (D3.js) ---
    let currentLang = 'ko'; // Default language

    async function loadTrendKeywords(lang) {
        if (lang) currentLang = lang;

        // UI Update (Language Tabs)
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('bg-indigo-500', 'text-white', 'shadow-md');
            btn.classList.add('text-gray-500');
        });
        const activeBtn = document.getElementById(`btn-${currentLang}`);
        if (activeBtn) {
            activeBtn.classList.add('bg-indigo-500', 'text-white', 'shadow-md');
            activeBtn.classList.remove('text-gray-500');
        }

        // Get Filter Values
        const period = document.getElementById('trend-period').value;
        const age = document.getElementById('trend-age').value;

        // Show Loading
        const container = document.getElementById('bubbleChart');
        const loading = document.getElementById('bubbleLoading');
        loading.style.display = 'flex';
        // Clear ALL previous SVG charts to prevent duplicates -> MOVED to renderBubbleChart
        // d3.select("#bubbleChart").selectAll("svg").remove();

        try {
            // Fetch with filters
            const response = await fetch(`/api/trends/keywords?language=${currentLang}&period=${period}&age=${age}`);
            const data = await response.json();

            loading.style.display = 'none';

            if (data.status === 'ok' && data.keywords.length > 0) {
                renderBubbleChart(data.keywords);
            } else {
                container.innerHTML += `<div class="text-gray-500 absolute">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
            }
        } catch (e) {
            console.error(e);
            loading.style.display = 'none';
        }
    }

    function renderBubbleChart(data) {
        const container = document.getElementById('bubbleChart');
        const width = container.clientWidth;
        const height = 600;

        // Clear ALL previous SVGs immediately before rendering a new one
        // This solves race conditions where multiple fetches might return and stack charts
        d3.select("#bubbleChart").selectAll("svg").remove();

        // 1. Color palette
        const colorScale = d3.scaleLinear()
            .domain([0, 100])
            .range(["#E0E7FF", "#4F46E5"]);

        // 2. Prepare Data (calculate Radius)
        // Adjust exponent for visual variance (User request: make variance clear)
        // Use Power 2.5 for variance
        const radiusScale = d3.scalePow().exponent(0.5) // Sqrt scale is properly area-proportional, but we want exaggerated
            .domain([0, 100])
            .range([15, 60]); // Min 15px, Max 60px size

        const nodes = data.map(d => ({
            ...d,
            r: radiusScale(d.volume) * (d.volume > 80 ? 1.2 : 1), // Boost high volume
            x: Math.random() * width,
            y: Math.random() * height
        }));

        const svg = d3.select("#bubbleChart")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [0, 0, width, height])
            .attr("style", "max-width: 100%; height: auto;");

        // 3. Force Simulation (Wide Spread)
        const simulation = d3.forceSimulation(nodes)
            .force("x", d3.forceX(width / 2).strength(0.05)) // Weak horizontal pull -> Spread wide
            .force("y", d3.forceY(height / 2).strength(0.1)) // Stronger vertical pull -> Keep in band
            .force("collide", d3.forceCollide(d => d.r + 4).strength(0.8)) // Prevent overlap
            .force("charge", d3.forceManyBody().strength(-10)); // Slight repulsion

        // 4. Render Elements
        const node = svg.append("g")
            .selectAll("g")
            .data(nodes)
            .join("g")
            .attr("class", "bubble")
            .call(drag(simulation)) // Optional: dragging
            .on("click", (event, d) => {
                document.getElementById('searchInput').value = d.data ? d.data.keyword : d.keyword;
                searchVideos();
            })
            .on("mouseover", function (event, d) {
                // 1. Bring to front
                d3.select(this).raise();

                // 2. Scale up rect and change color
                d3.select(this).select("rect")
                    .transition().duration(200)
                    .attr("width", d.r * 2.4)        // Scale up
                    .attr("height", d.r * 2.4)
                    .attr("x", -d.r * 1.2)           // Recenter
                    .attr("y", -d.r * 1.2)
                    .attr("fill", "#60A5FA"); // Sky Blue (Tailwind blue-400)

                // 3. Scale up text
                d3.select(this).select("text")
                    .transition().duration(200)
                    .style("font-size", (Math.min(d.r / 1.5, 16) * 1.2) + "px")
                    .style("fill", "#fff");
            })
            .on("mouseout", function (event, d) {
                // Restore logic
                d3.select(this).select("rect")
                    .transition().duration(200)
                    .attr("width", d.r * 2)
                    .attr("height", d.r * 2)
                    .attr("x", -d.r)
                    .attr("y", -d.r)
                    .attr("fill", d => colorScale(d.volume));

                d3.select(this).select("text")
                    .transition().duration(200)
                    .style("font-size", Math.min(d.r / 1.5, 16) + "px")
                    .style("fill", d.volume > 60 ? "#fff" : "#333");
            });

        // Use Rect instead of Circle
        const rects = node.append("rect")
            .attr("width", 0)
            .attr("height", 0)
            .attr("x", 0)
            .attr("y", 0)
            .attr("rx", 15) // Rounded corners (Soft Square)
            .attr("ry", 15)
            .attr("fill", d => colorScale(d.volume))
            .attr("fill-opacity", 0.9)
            .attr("stroke", "#fff")
            .attr("stroke-width", 2);

        // Transition rect size
        rects.transition().duration(800).ease(d3.easeBackOut)
            .attr("width", d => d.r * 2)
            .attr("height", d => d.r * 2)
            .attr("x", d => -d.r) // Center properly
            .attr("y", d => -d.r);

        const labels = node.append("text")
            .style("text-anchor", "middle")
            .style("pointer-events", "none")
            // .attr("dy", "0.3em") // Removed in favor of tspan positioning
            .style("fill", d => d.volume > 60 ? "#fff" : "#333");

        // Main Keyword
        labels.append("tspan")
            .attr("x", 0)
            .attr("dy", d => d.translation ? "-0.2em" : "0.3em") // Adjust vertical center based on content
            .style("font-size", d => Math.min(d.r / 1.5, 16) + "px")
            .style("font-weight", "bold")
            .text(d => d.keyword.substring(0, d.r / 2.5)); // Truncate longer text

        // Translation (if distinct)
        labels.append("tspan")
            .attr("x", 0)
            .attr("dy", "1.2em")
            .style("font-size", d => Math.min(d.r / 2.5, 12) + "px") // Smaller font
            .style("font-weight", "normal")
            .style("opacity", 0.9)
            .text(d => (d.translation && d.translation !== d.keyword) ? d.translation : "");

        // 5. Simulation Tick
        simulation.on("tick", () => {
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // Helper: Dragging
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }
    }

    // Auto load on mount
    document.addEventListener('DOMContentLoaded', () => {
        // ê¸°ì¡´ DOMContentLoaded ë¡œì§ì´ ìˆë‹¤ë©´ ê·¸ ì•ˆì— ë„£ì–´ì•¼ í•¨. 
        // ì—¬ê¸°ì„œëŠ” ë³„ë„ë¡œ ì¶”ê°€í•´ë„ ë¬´ë°©í•¨ (ë…ë¦½ ê¸°ëŠ¥)
        loadTrendKeywords('ko');
    });

    let currentAnalysisResult = null;

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
        document.getElementById('analysisModal').classList.add('hidden');
        document.getElementById('analysisModal').classList.remove('flex');
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
</script>
{% endblock %}