{% extends "base.html" %}

{% block content %}


<!-- í”„ë¡œì íŠ¸ ìš”ì•½ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“‹ í”„ë¡œì íŠ¸ ìš”ì•½</h3>
    <div id="projectSummary" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <div class="text-2xl mb-1">ğŸ“</div>
            <div id="scriptStatus" class="text-sm text-gray-600 dark:text-gray-400">ëŒ€ë³¸ ì—†ìŒ</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <div class="text-2xl mb-1">ğŸ–¼ï¸</div>
            <div id="imageStatus" class="text-sm text-gray-600 dark:text-gray-400">ì´ë¯¸ì§€ ì—†ìŒ</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <div class="text-2xl mb-1">ğŸ”Š</div>
            <div id="audioStatus" class="text-sm text-gray-600 dark:text-gray-400">ìŒì„± ì—†ìŒ</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <div class="text-2xl mb-1">ğŸ¬</div>
            <div id="videoStatus" class="text-sm text-gray-600 dark:text-gray-400">ì¤€ë¹„ ì¤‘</div>
        </div>
    </div>
</div>

<!-- ì˜ìƒ ìƒì„± (Python ë°±ì—”ë“œ) -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ¬ ìë™ ì˜ìƒ ìƒì„±</h3>
    <p class="text-gray-600 dark:text-gray-400 mb-4">
        ì´ë¯¸ì§€ì™€ ìŒì„± íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìŠ¬ë¼ì´ë“œì‡¼ ì˜ìƒì„ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì´ë¯¸ì§€ë‹¹ í‘œì‹œ ì‹œê°„</label>
            <select id="imageDuration" class="input-field">
                <option value="3">3ì´ˆ</option>
                <option value="5" selected>5ì´ˆ</option>
                <option value="7">7ì´ˆ</option>
                <option value="10">10ì´ˆ</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í•´ìƒë„ (ë©”ëª¨ë¦¬ ìµœì í™”)</label>
            <select id="resolution" class="input-field">
                <option value="720p" selected>720p (1280x720) - ê¶Œì¥</option>
                <option value="1080p">1080p (1920x1080) - ê³ í™”ì§ˆ (ëŠë¦¼)</option>
            </select>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Left: Existing Video -->
        <div id="existingVideoContainer" class="hidden">
            <h4 class="font-bold mb-2 text-gray-700 dark:text-gray-300">ğŸ“º ê¸°ì¡´ ì˜ìƒ</h4>
            <div id="existingVideoContent"></div>
        </div>
        <!-- Right: New Video -->
        <div id="newVideoContainer" class="hidden">
            <h4 class="font-bold mb-2 text-blue-600 dark:text-blue-400">âœ¨ ìƒˆ ì˜ìƒ</h4>
            <div id="newVideoContent">
                <!-- Placeholder -->
                <div id="newVideoPlaceholder"
                    class="hidden h-full min-h-[200px] bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center text-gray-400">
                    <span>ì˜ìƒ ìƒì„± ëŒ€ê¸° ì¤‘...</span>
                </div>
            </div>
        </div>
    </div>

    <button onclick="createVideo()" id="renderBtn"
        class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg">
        <span>ğŸ¬</span>
        <span>ì˜ìƒ ìƒì„±í•˜ê¸°</span>
    </button>
</div>



<!-- ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ -->
<div class="card">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ’¾ í”„ë¡œì íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</h3>
    <div class="flex flex-wrap gap-3">
        <button onclick="downloadScript()" class="btn-secondary">ğŸ“ ëŒ€ë³¸ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadPrompts()" class="btn-secondary">ğŸ–¼ï¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadAll()" class="btn-primary">ğŸ“¦ ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isPolling = false;

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async () => {
        const projectId = getCurrentProject();
        if (!projectId) {
            // í”„ë¡œì íŠ¸ ë¯¸ì„ íƒ ì‹œ ê²½ê³  í‘œì‹œ
            document.getElementById('renderBtn').disabled = true;
            document.getElementById('renderBtn').innerHTML = '<span>ğŸš«</span><span>í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span>';
            document.getElementById('renderBtn').classList.add('bg-gray-400', 'cursor-not-allowed');
            document.getElementById('renderBtn').classList.remove('btn-primary');

            const summary = document.getElementById('projectSummary');
            summary.innerHTML = '<div class="col-span-4 text-center p-4 text-gray-500">ì¢Œì¸¡ ë©”ë‰´ "ë‚´ í”„ë¡œì íŠ¸"ì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
            return;
        }

        try {
            const data = await API.project.getFull(projectId);
            updateProjectSummary(data);

            // ì´ë¯¸ ì˜ìƒì´ ìˆë‹¤ë©´ ì¢Œì¸¡(ê¸°ì¡´ ì˜ìƒ)ì— í‘œì‹œ
            if (data.settings?.video_path || data.project?.video_path) {
                const videoPath = data.settings?.video_path || data.project?.video_path;
                document.getElementById('existingVideoContainer').classList.remove('hidden');
                renderComplete(videoPath, 'existingVideoContent');
            }

            // [NEW] ë§Œì•½ í˜„ì¬ ë Œë”ë§ ì¤‘ì¸ ìƒíƒœë¼ë©´ UI ë³µêµ¬ ë° í´ë§ ì‹œì‘
            if (data.project?.status === 'rendering') {
                Utils.showToast('ì´ì „ ë Œë”ë§ ì‘ì—…ì„ ì´ì–´ì„œ í™•ì¸í•©ë‹ˆë‹¤.', 'info');
                startRenderingUI();
                pollRenderStatus(projectId);
            }
        } catch (e) {
            console.error("Failed to load project status:", e);
        }
    });

    function updateProjectSummary(data) {
        console.log("Project Data Loaded:", data); // Debug Log

        // 1. ëŒ€ë³¸ ìƒíƒœ
        const scriptEl = document.getElementById('scriptStatus');
        const hasScriptRow = !!data.script;
        const hasFullScript = data.script && data.script.full_script;
        const hasTtsScript = data.tts && data.tts.audio_path; // TTS implies script existence

        if (hasFullScript) {
            scriptEl.innerHTML = '<span class="text-green-600 font-bold">âœ… ì™„ë£Œ</span>';
        } else if (hasScriptRow) {
            // Row exists but no content?
            scriptEl.innerHTML = '<span class="text-yellow-600 font-bold">âš ï¸ ë‚´ìš© ì—†ìŒ</span>';
        } else if (data.settings?.script) {
            scriptEl.innerHTML = '<span class="text-green-600 font-bold">âœ… ì™„ë£Œ (Settings)</span>';
        } else if (hasTtsScript) {
            scriptEl.innerHTML = '<span class="text-green-600 font-bold">âœ… ì™„ë£Œ (TTS)</span>';
        } else {
            scriptEl.innerHTML = '<span class="text-red-500">ëŒ€ë³¸ ì—†ìŒ</span>';
        }

        // 2. ì´ë¯¸ì§€ ìƒíƒœ
        const imageEl = document.getElementById('imageStatus');
        const images = data.image_prompts || [];
        const hasImages = images.length > 0 && images.some(img => img.image_url);
        const hasPrompts = images.length > 0;

        if (hasImages) {
            imageEl.innerHTML = `<span class="text-green-600 font-bold">âœ… ì™„ë£Œ (${images.length}ì¥)</span>`;
        } else if (hasPrompts) {
            // Prompts exist but no images -> Sidebar says Green, we say Yellow
            imageEl.innerHTML = '<span class="text-yellow-600 font-bold">âš ï¸ ìƒì„± í•„ìš” (í”„ë¡¬í”„íŠ¸ë§Œ ìˆìŒ)</span>';
        } else {
            imageEl.innerHTML = '<span class="text-red-500">ì´ë¯¸ì§€ ì—†ìŒ</span>';
        }

        // 3. ìŒì„± ìƒíƒœ
        const audioEl = document.getElementById('audioStatus');
        if (data.tts && data.tts.audio_path) {
            audioEl.innerHTML = '<span class="text-green-600 font-bold">âœ… ì™„ë£Œ</span>';
        } else {
            audioEl.innerHTML = '<span class="text-red-500">ìŒì„± ì—†ìŒ</span>';
        }

        // 4. ì˜ìƒ ìƒíƒœ
        const videoEl = document.getElementById('videoStatus');
        const hasVideoPath = data.settings?.video_path || data.project?.video_path;
        const isRenderedStatus = data.project?.status === 'rendered' || data.project?.status === 'completed';

        if (hasVideoPath) {
            videoEl.innerHTML = '<span class="text-green-600 font-bold">âœ… ìƒì„±ë¨</span>';
        } else if (isRenderedStatus) {
            // DB says rendered, but file missing
            videoEl.innerHTML = '<span class="text-red-500 font-bold">âŒ íŒŒì¼ ìœ ì‹¤ë¨</span>';
        } else {
            videoEl.innerHTML = '<span class="text-gray-500">ì¤€ë¹„ ì¤‘</span>';
        }
    }

    function renderComplete(videoPath, targetId = 'resultContainer') {
        const container = document.getElementById(targetId);
        if (!container) return;

        const timestamp = new Date().getTime();
        // videoPathê°€ ì´ë¯¸ '/output/...' í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ íŒŒì¼ëª…ë§Œ ì¶”ì¶œí•˜ì—¬ '/output/' ë¶™ì„
        let videoUrl = videoPath;
        if (!videoUrl.startsWith('/output') && !videoUrl.startsWith('http')) {
            videoUrl = `/output/${videoPath.split(/[/\\]/).pop()}`;
        }
        videoUrl += `?t=${timestamp}`;

        container.innerHTML = `
            <div class="relative bg-black rounded-lg overflow-hidden shadow-lg aspect-video">
                <video src="${videoUrl}" controls class="w-full h-full object-contain"></video>
            </div>
            <div class="mt-4 flex justify-end">
                <a href="${videoUrl}" download class="btn-secondary flex items-center gap-2 text-sm">
                    <span>ğŸ’¾</span> ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
        `;

        // ìƒíƒœ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        const statusEl = document.getElementById('videoStatus');
        if (statusEl) statusEl.innerHTML = '<span class="text-green-600 font-bold">âœ… ìƒì„±ë¨</span>';
    }

    async function createVideo() {
        const projectId = getCurrentProject();

        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
            return;
        }

        if (isPolling) return; // ì¤‘ë³µ ë°©ì§€

        // UI Update: ìš°ì¸¡ ì»¨í…Œì´ë„ˆ í™œì„±í™” ë° "ìƒì„± ì¤‘" í‘œì‹œ
        document.getElementById('newVideoContainer').classList.remove('hidden');
        document.getElementById('newVideoContent').innerHTML = `
            <div class="h-64 bg-gray-100 dark:bg-gray-800 rounded-lg flex flex-col items-center justify-center text-gray-500 animate-pulse">
                <span class="text-4xl mb-2">ğŸ¬</span>
                <span>ì˜ìƒì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
            </div>
        `;

        const btn = document.getElementById('renderBtn');
        Utils.setLoading(btn, true, 'ì˜ìƒ ìƒì„± ìš”ì²­ ì¤‘...');

        try {
            const resolution = document.getElementById('resolution').value;
            const result = await API.project.render(projectId, {
                useSubtitles: true,
                resolution: resolution
            });

            if (result.status === 'processing') {
                Utils.showToast('ì˜ìƒ ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤...', 'info');
                startRenderingUI();
                isPolling = true;
                pollRenderStatus(projectId);
            } else {
                Utils.showToast('ì˜ìƒ ìƒì„± ì‹¤íŒ¨: ' + (result.message || result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                Utils.setLoading(btn, false);
            }
        } catch (e) {
            console.error('Video creation error:', e);
            Utils.showToast('ì˜ìƒ ìƒì„± ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            Utils.setLoading(btn, false);
            isPolling = false;
        }
    }

    function startRenderingUI() {
        const btn = document.getElementById('renderBtn');
        if (!btn) return;

        // UI Update: ìš°ì¸¡ ì»¨í…Œì´ë„ˆ í™œì„±í™”
        document.getElementById('newVideoContainer').classList.remove('hidden');
        document.getElementById('newVideoContent').innerHTML = `
            <div class="h-64 bg-gray-100 dark:bg-gray-800 rounded-lg flex flex-col items-center justify-center text-gray-500 animate-pulse">
                <span class="text-4xl mb-2">ğŸ¬</span>
                <span>ì˜ìƒì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
            </div>
        `;

        // Timer & Progress UI ì´ˆê¸°í™”
        let elapsedSeconds = 0;
        window.renderTimerInterval = setInterval(() => {
            elapsedSeconds++;
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const timerEl = document.getElementById('renderTimer');
            if (timerEl) timerEl.innerText = timeStr;
        }, 1000);

        // Polling UI (ë²„íŠ¼ ëŒ€ì‹  ë³„ë„ UI í‘œì‹œ)
        btn.disabled = true;
        btn.innerHTML = `
            <div class="flex flex-col items-center w-full gap-2">
                <div class="flex items-center gap-2">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    <span>ì˜ìƒ ìƒì„± ì¤‘...</span>
                    <span id="renderTimer" class="font-mono bg-black/20 px-2 py-0.5 rounded">00:00</span>
                    <span id="renderProgressText" class="font-bold text-yellow-300 ml-2">0%</span>
                </div>
                <!-- Progress Bar -->
                <div id="renderProgressBar" class="w-full bg-black/20 rounded-full h-2.5 overflow-hidden">
                    <div class="bg-white/90 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        `;

        // Add Global Style for Progress Animation
        if (!document.getElementById('progressStyle')) {
            const style = document.createElement('style');
            style.id = 'progressStyle';
            style.innerHTML = `
                @keyframes progress-indeterminate {
                    0% { margin-left: -50%; width: 50%; }
                    50% { margin-left: 25%; width: 50%; }
                    100% { margin-left: 100%; width: 50%; }
                }
                .animate-progress-indeterminate {
                    animation: progress-indeterminate 2s infinite ease-in-out;
                }
            `;
            document.head.appendChild(style);
        }
    }

    async function pollRenderStatus(projectId) {
        if (!isPolling) {
            isPolling = true; // ê°•ì œ í™œì„±í™” (í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€ì‘)
        }

        try {
            // 1. ì‹¤ì‹œê°„ ì§„í–‰ë¥  ì¡°íšŒ (New)
            try {
                const progRes = await fetch(`/api/project/${projectId}/render/status`);
                if (progRes.ok) {
                    const progData = await progRes.json();
                    if (progData && progData.progress !== undefined) {
                        const percent = progData.progress;

                        // UI ì—…ë°ì´íŠ¸
                        const bar = document.querySelector('#renderProgressBar div');
                        const text = document.querySelector('#renderProgressText');

                        if (bar) {
                            bar.style.width = `${percent}%`;
                            bar.classList.remove('animate-progress-indeterminate'); // ì• ë‹ˆë©”ì´ì…˜ ì œê±°
                            bar.classList.add('transition-all', 'duration-300'); // ë¶€ë“œëŸ¬ìš´ ì „í™˜
                        }
                        if (text) {
                            text.innerText = `${percent}%`;
                        }
                    }
                }
            } catch (e) {
                console.warn("Progress poll failed", e);
            }

            // 2. DB ìƒíƒœ ì¡°íšŒ (ì™„ë£Œ ì—¬ë¶€ í™•ì¸)
            const data = await API.project.getFull(projectId);
            const videoPath = data.settings?.video_path || data.project?.video_path;
            const status = data.project?.status; // Check DB status

            if (videoPath) {
                isPolling = false;
                if (window.renderTimerInterval) clearInterval(window.renderTimerInterval);

                // ì™„ë£Œ ì‹œ ìš°ì¸¡(ìƒˆ ì˜ìƒ) ì»¨í…Œì´ë„ˆì— ë Œë”ë§
                renderComplete(videoPath, 'newVideoContent');

                // ë²„íŠ¼ ë³µì›
                const btn = document.getElementById('renderBtn');
                btn.innerHTML = `<span>ğŸ¬</span><span>ì˜ìƒ ìƒì„±í•˜ê¸°</span>`;
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');

                Utils.showToast('ì˜ìƒ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                return;
            }

            // ì‹¤íŒ¨ ìƒíƒœ ê°ì§€
            if (status === 'failed') {
                isPolling = false;
                if (window.renderTimerInterval) clearInterval(window.renderTimerInterval);
                const btn = document.getElementById('renderBtn');
                Utils.setLoading(btn, false);
                Utils.showToast('ì˜ìƒ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ë¡œê·¸ í™•ì¸ í•„ìš”)', 'error');
                btn.innerHTML = `<span>âš ï¸</span><span>ìƒì„± ì‹¤íŒ¨ (ë‹¤ì‹œ ì‹œë„)</span>`;
                document.getElementById('videoStatus').innerHTML = '<span class="text-red-500">âŒ ì‹¤íŒ¨</span>';

                // ìš°ì¸¡ ì»¨í…Œì´ë„ˆì— ì—ëŸ¬ í‘œì‹œ
                document.getElementById('newVideoContent').innerHTML = `
                    <div class="h-64 bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center text-red-500">
                        <span class="text-3xl mb-2">âš ï¸</span>
                        <span>ì˜ìƒ ìƒì„± ì‹¤íŒ¨</span>
                    </div>
                `;
                return;
            }

        } catch (e) {
            console.error("Polling error:", e);
        }

        // ì¬ê·€ í˜¸ì¶œ (1ì´ˆ ê°„ê²©ìœ¼ë¡œ ë‹¨ì¶•í•˜ì—¬ ë¶€ë“œëŸ½ê²Œ)
        if (isPolling) {
            setTimeout(() => pollRenderStatus(projectId), 1000);
        } else {
            if (window.renderTimerInterval) clearInterval(window.renderTimerInterval);
        }
    }

    function resetRenderBtn() {
        isPolling = false;
        if (window.renderTimerInterval) clearInterval(window.renderTimerInterval);
        const btn = document.getElementById('renderBtn');
        if (btn) {
            Utils.setLoading(btn, false); // Ensure utils state is cleared
            btn.disabled = false;
            btn.innerHTML = `<span>ğŸ¬</span><span>ì˜ìƒ ìƒì„±í•˜ê¸° (ì¬ìƒì„±)</span>`;
            btn.classList.remove('opacity-75', 'cursor-not-allowed', 'bg-gray-400');
            btn.classList.add('btn-primary'); // Ensure primary class is active
        }
    }


    function downloadScript() {
        const script = Utils.storage.get('fullScript');
        if (script?.script) {
            Utils.downloadFile(script.script, `${script.topic || 'ëŒ€ë³¸'}.txt`);
        } else {
            Utils.showToast('ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
        }
    }

    function downloadPrompts() {
        const prompts = Utils.storage.get('imagePrompts');
        if (prompts?.length > 0) {
            const text = prompts.map((p, i) => `[ì¥ë©´ ${i + 1}] ${p.scene}\n${p.prompt} ${p.style_tags || ''}`).join('\n\n');
            Utils.downloadFile(text, 'ì´ë¯¸ì§€_í”„ë¡¬í”„íŠ¸.txt');
        } else {
            Utils.showToast('ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
        }
    }

    function downloadAll() {
        const script = Utils.storage.get('fullScript');
        const structure = Utils.storage.get('scriptStructure');
        const prompts = Utils.storage.get('imagePrompts');

        let content = '=== í”¼ì¹´ë””ë¦¬ìŠ¤íŠœë””ì˜¤ í”„ë¡œì íŠ¸ ===\n\n';

        if (structure) {
            content += '## ëŒ€ë³¸ êµ¬ì¡°\n' + structure.structure + '\n\n';
        }
        if (script) {
            content += '## ëŒ€ë³¸\n' + script.script + '\n\n';
        }
        if (prompts) {
            content += '## ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸\n';
            prompts.forEach((p, i) => {
                content += `[ì¥ë©´ ${i + 1}] ${p.scene}\n${p.prompt} ${p.style_tags || ''}\n\n`;
            });
        }

        Utils.downloadFile(content, 'í”„ë¡œì íŠ¸_ì „ì²´.txt');
    }
</script>
{% endblock %}