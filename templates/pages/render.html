{% extends "base.html" %}

{% block content %}
<div class="flex flex-col gap-3 p-2">
    <!-- 1. Top Control Bar -->
    <div
        class="flex items-center gap-3 p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 shrink-0 flex-wrap">

        <!-- Resolution & Settings -->
        <div class="flex items-center gap-2 border-r border-gray-200 dark:border-gray-600 pr-3">
            <span class="text-xs font-bold text-gray-700 dark:text-gray-300">{{ t('label_resolution') }}</span>
            <select id="resolution"
                class="text-xs border-gray-300 dark:border-gray-600 rounded py-1 bg-gray-50 dark:bg-gray-700 dark:text-white">
                <option value="720p">{{ t('opt_720p') }}</option>
                <option value="1080p">{{ t('opt_1080p') }}</option>
            </select>
            <label class="flex items-center gap-1 cursor-pointer">
                <input type="checkbox" id="useSubtitles" class="w-3 h-3 text-blue-600 rounded" checked>
                <span class="text-xs text-gray-600 dark:text-gray-300 select-none">{{ t('label_include_subs') }}</span>
            </label>
        </div>

        <!-- Render Button -->
        <button onclick="createVideo()" id="renderBtn"
            class="btn-primary py-1.5 px-6 text-sm font-bold flex items-center gap-2 shadow-sm hover:shadow-md transition-all ml-auto">
            <span>üé¨ {{ t('btn_start_render') }}</span>
        </button>
    </div>

    <!-- 2. Main Workspace (Grid) -->
    <div class="grid grid-cols-12 gap-3">

        <!-- Left Panel: Status & Logs (Col-4) -->
        <div class="col-span-12 md:col-span-4 flex flex-col gap-3">
            <!-- Project Status Summary -->
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 shrink-0">
                <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Project Status</h4>
                <div class="grid grid-cols-2 gap-2">
                    <div id="scriptStatus" class="status-item">üìù {{ t('status_script') }}</div>
                    <div id="imageStatus" class="status-item">üñºÔ∏è {{ t('status_image') }}</div>
                    <div id="audioStatus" class="status-item">üîä {{ t('status_audio') }}</div>
                    <div id="videoStatus" class="status-item">üé¨ {{ t('status_video') }}</div>
                </div>
            </div>

            <!-- Intro Video Section (Compact) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-3 shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-gray-500 uppercase">{{ t('intro_video_title') }}</h4>
                    <button onclick="document.getElementById('introFileInput').click()"
                        class="text-[10px] bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded hover:bg-gray-200">
                        üìÅ {{ t('btn_upload') }}
                    </button>
                    <input type="file" id="introFileInput" accept="video/*" class="hidden">
                </div>
                <!-- Preview area -->
                <div id="introPreview" class="hidden relative aspect-video bg-black rounded overflow-hidden group">
                    <video id="introVideoPlayer" class="w-full h-full object-cover"></video>
                    <button onclick="deleteIntroVideo()"
                        class="absolute top-1 right-1 bg-red-600 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity text-[10px]">üóëÔ∏è</button>
                </div>
                <div id="introEmpty"
                    class="text-center p-2 text-xs text-gray-400 border border-dashed rounded bg-gray-50 dark:bg-gray-900/50">
                    {{ t('no_intro') }}
                </div>
            </div>

            <!-- Render Log / Console -->
            <div
                class="bg-gray-900 rounded-lg border border-gray-800 p-3 overflow-hidden flex flex-col font-mono text-xs text-green-400 h-[300px]">
                <div class="flex justify-between border-b border-gray-800 pb-1 mb-2">
                    <span>>_ {{ t('render_log_title') }}</span>
                    <span id="renderTimer" class="text-yellow-400">00:00</span>
                </div>
                <div id="renderLogContent"
                    class="flex-1 overflow-y-auto custom-scrollbar opacity-80 whitespace-pre-wrap">
                    {{ t('ready_to_render') }}
                </div>
                <!-- Progress Bar overlaid in log -->
                <div class="mt-2 h-1 bg-gray-800 rounded overflow-hidden">
                    <div id="renderProgressBar" class="h-full bg-green-500 transition-all duration-300"
                        style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Preview & Downloads (Col-8) -->
        <div
            class="col-span-12 md:col-span-8 flex flex-col bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm relative min-h-[500px]">

            <!-- Video Player Area -->
            <div class="flex-1 bg-black relative flex items-center justify-center group rounded-t-lg overflow-hidden">
                <!-- Removed max-h-full to allow natural height but constrain max to viewport-ish logic via CSS if needed. 
                     Keeping max-h-[80vh] is safer. -->
                <video id="mainVideoPlayer" controls class="max-w-full max-h-[80vh] w-auto h-auto shadow-2xl"></video>

                <!-- Placeholder / Loading State -->
                <div id="videoPlaceholder"
                    class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 text-gray-400 z-0">
                    <span class="text-6xl mb-4 animate-pulse">üé¨</span>
                    <p>{{ t('placeholder_video_desc') }}</p>
                </div>
            </div>

            <!-- Action Footer -->
            <div
                class="p-3 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-600 flex justify-between items-center shrink-0 rounded-b-lg">
                <div class="flex gap-2">
                    <button onclick="downloadScript()" class="text-xs btn-secondary px-2">üìù {{ t('status_script')
                        }}</button>
                    <button onclick="downloadPrompts()" class="text-xs btn-secondary px-2">üñºÔ∏è {{ t('nav_image')
                        }}</button>
                </div>
                <div class="flex gap-2">
                    <a id="downloadVideoBtn" href="#"
                        class="btn-primary py-1.5 px-4 text-sm font-bold opacity-50 pointer-events-none transition-opacity">
                        üíæ {{ t('btn_download_video') }}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .status-item {
        @apply flex items-center justify-center py-2 px-1 rounded bg-gray-50 dark:bg-gray-700 text-xs font-medium text-gray-500 border border-gray-100 dark:border-gray-600;
    }

    .status-item.done {
        @apply bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800;
    }
</style>

<script>
    let isPolling = false;

    document.addEventListener('DOMContentLoaded', async () => {
        const projectId = getCurrentProject();
        if (!projectId) return Utils.showToast("{{ t('toast_select_project_first') }}", 'warning');

        try {
            const data = await API.project.getFull(projectId);
            updateStatusUI(data);

            // [NEW] Aspect Ratio Check
            const ratio = data.settings?.aspect_ratio || '16:9';
            if (ratio === '9:16') {
                // Adjust Intro Preview
                const introBox = document.getElementById('introPreview');
                introBox.classList.remove('aspect-video');
                introBox.style.aspectRatio = '9/16';
                introBox.classList.add('max-w-[150px]', 'mx-auto');

                // Adjust Main Player
                const player = document.getElementById('mainVideoPlayer');
                // Force 9:16 and constrain width to mimic mobile view
                player.style.setProperty('aspect-ratio', '9/16', 'important');
                player.classList.add('max-w-[360px]', 'mx-auto');

                // Adjust Wrapper to not be full width black logic if possible, or just let player center
                const wrapper = player.parentElement;
                // wrapper is flex items-center justify-center, so mx-auto on player works.
            }

            // Check for existing video
            const vPath = data.settings?.video_path || data.project?.video_path;
            if (vPath) showVideoResult(vPath);

            // Existing Intro
            if (data.intro_video_path || data.project?.intro_video_path) {
                showIntroPreview(data.intro_video_path || data.project?.intro_video_path);
            }

            // Check if rendering
            if (data.project?.status === 'rendering') {
                startRenderingUI();
                pollRenderStatus(projectId);
            }
        } catch (e) { console.error(e); }

        // Intro Upload Binding directly
        document.getElementById('introFileInput').addEventListener('change', uploadIntro);
    });

    function updateStatusUI(data) {
        // Simple status checker
        const setStatus = (id, valid) => {
            const el = document.getElementById(id);
            if (valid) el.classList.add('done');
            else el.classList.remove('done');
        };

        setStatus('scriptStatus', data.script && data.script.full_script);
        setStatus('imageStatus', data.image_prompts && data.image_prompts.length > 0);
        setStatus('audioStatus', data.tts && data.tts.audio_path);
        setStatus('videoStatus', data.settings?.video_path);
    }

    async function createVideo() {
        const projectId = getCurrentProject();
        if (isPolling) return;

        const resolution = document.getElementById('resolution').value;
        const sub = document.getElementById('useSubtitles').checked;
        const btn = document.getElementById('renderBtn');

        Utils.setLoading(btn, true, "{{ t('status_loading') }}");

        try {
            const res = await API.project.render(projectId, { resolution, useSubtitles: sub });
            if (res.status === 'processing') {
                startRenderingUI();
                pollRenderStatus(projectId);
            } else {
                Utils.showToast("{{ t('status_fail') }}: " + (res.message || 'Error'), 'error');
                Utils.setLoading(btn, false);
            }
        } catch (e) {
            Utils.showToast("{{ t('status_error') }}", 'error');
            Utils.setLoading(btn, false);
        }
    }

    function startRenderingUI() {
        isPolling = true;
        document.getElementById('renderBtn').disabled = true;
        document.getElementById('renderBtn').innerHTML = `<span class="animate-spin">‚è≥</span> {{ t('status_loading') }}`;

        const log = document.getElementById('renderLogContent');
        log.innerHTML += `\n[${new Date().toLocaleTimeString()}] Rendering Started...`;

        // Start Timer
        let sec = 0;
        window.renderTimer = setInterval(() => {
            sec++;
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            document.getElementById('renderTimer').innerText = `${m}:${s}`;
        }, 1000);
    }

    async function pollRenderStatus(projectId) {
        if (!isPolling) return;

        try {
            const statusRes = await fetch(`/api/project/${projectId}/render/status`);
            const prog = await statusRes.json();

            if (prog && prog.progress !== undefined) {
                document.getElementById('renderProgressBar').style.width = prog.progress + '%';
                // Update log occasionally or if message changes? 
                // For now just console simulated log
                // const log = document.getElementById('renderLogContent');
                // log.scrollTop = log.scrollHeight; 
            }

            const data = await API.project.getFull(projectId);
            if (data.settings?.video_path) {
                // Done
                finishRendering(data.settings.video_path);
                return;
            }
            if (data.project?.status === 'failed') {
                failRendering();
                return;
            }
        } catch (e) { }

        setTimeout(() => pollRenderStatus(projectId), 1000);
    }

    function finishRendering(path) {
        isPolling = false;
        clearInterval(window.renderTimer);
        document.getElementById('renderProgressBar').style.width = '100%';
        document.getElementById('renderLogContent').innerHTML += `\n[DONE] Video Created Successfully!`;

        const btn = document.getElementById('renderBtn');
        btn.disabled = false;
        btn.innerHTML = `<span>üé¨ {{ t('btn_regen_video') }}</span>`;

        showVideoResult(path);
        Utils.showToast("{{ t('toast_render_finished') }}", 'success');

        // Update Video Status Indicator
        document.getElementById('videoStatus').classList.add('done');

        // [NEW] Update Stepper
        if (window.updateStepStatus) window.updateStepStatus('render', true);
    }

    function failRendering() {
        isPolling = false;
        clearInterval(window.renderTimer);
        document.getElementById('renderProgressBar').style.backgroundColor = 'red';
        document.getElementById('renderLogContent').innerHTML += `\n[ERROR] Rendering Failed. Call support.`;
        const btn = document.getElementById('renderBtn');
        btn.disabled = false;
        btn.innerHTML = `<span>‚ö†Ô∏è {{ t('btn_retry_video') }}</span>`;
        Utils.showToast("{{ t('toast_render_failed') }}", 'error');
    }

    function showVideoResult(path) {
        let url = path;
        if (!url.startsWith('/output') && !url.startsWith('http')) {
            url = `/output/${path.split(/[/\\]/).pop()}`;
        }
        url += `?t=${Date.now()}`;

        const player = document.getElementById('mainVideoPlayer');
        player.src = url;
        player.load();

        document.getElementById('videoPlaceholder').style.display = 'none';
        player.classList.remove('hidden');

        const dlBtn = document.getElementById('downloadVideoBtn');
        dlBtn.href = url;
        dlBtn.download = `video_${Date.now()}.mp4`;
        dlBtn.classList.remove('opacity-50', 'pointer-events-none');
    }

    // Intro Video Logic
    async function uploadIntro(e) {
        const file = e.target.files[0];
        if (!file) return;
        const projectId = getCurrentProject();

        const formData = new FormData();
        formData.append('file', file);

        Utils.showToast("{{ t('status_uploading') }}", 'info');
        try {
            const res = await fetch(`/api/video/upload-intro/${projectId}`, { method: 'POST', body: formData });
            const data = await res.json();
            if (data.status === 'success') {
                showIntroPreview(data.intro_path);
                Utils.showToast("{{ t('toast_intro_applied') }}", 'success');
            } else Utils.showToast(data.error, 'error');
        } catch (err) { Utils.showToast("{{ t('toast_upload_fail') }}", 'error'); }
        e.target.value = '';
    }

    function showIntroPreview(path) {
        document.getElementById('introEmpty').classList.add('hidden');
        document.getElementById('introPreview').classList.remove('hidden');
        const player = document.getElementById('introVideoPlayer');
        player.src = '/' + path; // naive path fix, might need adjustment
        player.load();
    }

    async function deleteIntroVideo() {
        if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
        const projectId = getCurrentProject();
        await fetch(`/api/video/delete-intro/${projectId}`, { method: 'DELETE' });
        document.getElementById('introPreview').classList.add('hidden');
        document.getElementById('introEmpty').classList.remove('hidden');
        Utils.showToast("{{ t('toast_deleted') }}", 'success');
    }

    function downloadScript() { /* ... existing logic ... */ }
    function downloadPrompts() { /* ... existing logic ... */ }
</script>
{% endblock %}