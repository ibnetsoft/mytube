{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ¬</span>
        <div>
            <h1>ì˜ìƒ ë Œë”ë§</h1>
            <p>ì´ë¯¸ì§€ì™€ ìŒì„±ì„ í•©ì„±í•˜ì—¬ ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤</p>
        </div>
    </div>
</div>

<!-- í”„ë¡œì íŠ¸ ìš”ì•½ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ“‹ í”„ë¡œì íŠ¸ ìš”ì•½</h3>
    <div id="projectSummary" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <div class="text-2xl mb-1">ğŸ“</div>
            <div id="scriptStatus" class="text-sm text-gray-600 dark:text-gray-400">ëŒ€ë³¸ ì—†ìŒ</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <div class="text-2xl mb-1">ğŸ–¼ï¸</div>
            <div id="imageStatus" class="text-sm text-gray-600 dark:text-gray-400">ì´ë¯¸ì§€ ì—†ìŒ</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <div class="text-2xl mb-1">ğŸ”Š</div>
            <div id="audioStatus" class="text-sm text-gray-600 dark:text-gray-400">ìŒì„± ì—†ìŒ</div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
            <div class="text-2xl mb-1">ğŸ¬</div>
            <div id="videoStatus" class="text-sm text-gray-600 dark:text-gray-400">ì¤€ë¹„ ì¤‘</div>
        </div>
    </div>
</div>

<!-- ì˜ìƒ ìƒì„± (Python ë°±ì—”ë“œ) -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ¬ ìë™ ì˜ìƒ ìƒì„±</h3>
    <p class="text-gray-600 dark:text-gray-400 mb-4">
        ì´ë¯¸ì§€ì™€ ìŒì„± íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìŠ¬ë¼ì´ë“œì‡¼ ì˜ìƒì„ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ì´ë¯¸ì§€ë‹¹ í‘œì‹œ ì‹œê°„</label>
            <select id="imageDuration" class="input-field">
                <option value="3">3ì´ˆ</option>
                <option value="5" selected>5ì´ˆ</option>
                <option value="7">7ì´ˆ</option>
                <option value="10">10ì´ˆ</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">í•´ìƒë„ (ìˆí¼ 9:16)</label>
            <select id="resolution" class="input-field">
                <option value="720p">720p (720x1280)</option>
                <option value="1080p" selected>1080p (1080x1920)</option>
            </select>
        </div>
    </div>

    <div class="alert alert-info mb-4">
        <strong>ì°¸ê³ :</strong> í˜„ì¬ ë²„ì „ì€ ë¡œì»¬ì—ì„œ MoviePyë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤.
        ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ ì¤€ë¹„í•œ í›„ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
    </div>

    <button onclick="createVideo()" id="renderBtn"
        class="w-full btn-primary py-4 flex items-center justify-center gap-3 text-lg">
        <span>ğŸ¬</span>
        <span>ì˜ìƒ ìƒì„±í•˜ê¸°</span>
    </button>
</div>

<!-- ì™¸ë¶€ ë„êµ¬ ì•ˆë‚´ -->
<div class="card mb-6">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ› ï¸ ì¶”ì²œ í¸ì§‘ ë„êµ¬</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">ë¬´ë£Œ ë„êµ¬</h4>
            <div class="space-y-2">
                <a href="https://www.capcut.com" target="_blank"
                    class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                    <span>ğŸ¬</span> CapCut (ë¬´ë£Œ, ì´ˆë³´ì ì¶”ì²œ)
                </a>
                <a href="https://www.davinciresolve.com" target="_blank"
                    class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                    <span>ğŸ¬</span> DaVinci Resolve (ë¬´ë£Œ, ì „ë¬¸ê°€ê¸‰)
                </a>
            </div>
        </div>
        <div>
            <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">AI ì˜ìƒ ìƒì„±</h4>
            <div class="space-y-2">
                <a href="https://www.synthesia.io" target="_blank"
                    class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                    <span>ğŸ¤–</span> Synthesia (AI ì•„ë°”íƒ€)
                </a>
                <a href="https://www.heygen.com" target="_blank"
                    class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                    <span>ğŸ¤–</span> HeyGen (AI ì•„ë°”íƒ€)
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ -->
<div class="card">
    <h3 class="font-bold text-gray-800 dark:text-white mb-4">ğŸ’¾ í”„ë¡œì íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</h3>
    <div class="flex flex-wrap gap-3">
        <button onclick="downloadScript()" class="btn-secondary">ğŸ“ ëŒ€ë³¸ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadPrompts()" class="btn-secondary">ğŸ–¼ï¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadAll()" class="btn-primary">ğŸ“¦ ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        updateProjectStatus();
    });

    // ìƒíƒœ ë³µêµ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    window.addEventListener('projectStateRestored', (e) => {
        // base.htmlì—ì„œ ì´ë¯¸ Utils.storageë¥¼ ì—…ë°ì´íŠ¸í–ˆìœ¼ë¯€ë¡œ
        // UIë§Œ ë‹¤ì‹œ ê·¸ë¦¬ë©´ ë¨
        updateProjectStatus();
    });

    function updateProjectStatus() {
        const script = Utils.storage.get('fullScript');
        const images = Utils.storage.get('imagePrompts');
        const audio = Utils.storage.get('ttsAudio');

        if (script) {
            document.getElementById('scriptStatus').innerHTML = '<span class="text-green-600">âœ… ì¤€ë¹„ë¨</span>';
        }
        if (images?.length > 0) {
            document.getElementById('imageStatus').innerHTML = `<span class="text-green-600">âœ… ${images.length}ê°œ</span>`;
        }
        if (audio) {
            document.getElementById('audioStatus').innerHTML = '<span class="text-green-600">âœ… ì¤€ë¹„ë¨</span>';
        }
    }

    async function createVideo() {
        const projectId = getCurrentProject();
        if (!projectId) {
            Utils.showToast('í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        // ìƒíƒœ í™•ì¸
        const images = Utils.storage.get('imagePrompts');
        const audio = Utils.storage.get('ttsAudio');

        if (!images || images.length === 0) {
            Utils.showToast('ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }
        if (!audio) {
            Utils.showToast('TTS ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }

        const btn = document.getElementById('renderBtn');
        Utils.setLoading(btn, true, 'ì˜ìƒ ìƒì„± ìš”ì²­ ì¤‘...');

        try {
            const result = await API.project.render(projectId, true); // ìë§‰ í¬í•¨

            if (result.status === 'processing') {
                Utils.showToast('ì˜ìƒ ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'info');

                // í´ë§ ì‹œì‘ UI
                document.getElementById('renderBtn').disabled = true;
                document.getElementById('renderBtn').innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        <span>ì˜ìƒ ìƒì„± ì¤‘... (ì•½ 1ë¶„ ì†Œìš”)</span>
                    </div>
                `;

                pollRenderStatus(projectId);
            } else {
                Utils.showToast('ì˜ìƒ ìƒì„± ìš”ì²­ ì‹¤íŒ¨', 'error');
                Utils.setLoading(btn, false);
            }
        } catch (e) {
            console.error(e);
            Utils.showToast('ì˜ìƒ ìƒì„± ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            Utils.setLoading(btn, false);
        }
    }

    async function pollRenderStatus(projectId) {
        let attempts = 0;
        const maxAttempts = 60; // 5ì´ˆ * 60 = 5ë¶„ ëŒ€ê¸°

        const interval = setInterval(async () => {
            attempts++;
            try {
                // í”„ë¡œì íŠ¸ ì„¤ì • í™•ì¸ (video_path ì—…ë°ì´íŠ¸ ì—¬ë¶€)
                const data = await API.project.getFull(projectId);

                // settingsê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„
                const videoPath = data.settings?.video_path || data.project?.video_path; // DB êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¦„, settings í…Œì´ë¸” í™•ì¸ í•„ìš”í•˜ì§€ë§Œ getFullì—ì„œ settings ë°˜í™˜í•¨

                if (videoPath) {
                    clearInterval(interval);
                    renderComplete(videoPath);
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    Utils.showToast('ì˜ìƒ ìƒì„±ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'warning');
                    resetRenderBtn();
                }
            } catch (e) {
                console.error("Polling error:", e);
            }
        }, 5000);
    }

    function renderComplete(videoPath) {
        document.getElementById('projectSummary').insertAdjacentHTML('afterend', `
            <div class="card bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 mb-6">
                <h3 class="font-bold text-green-800 dark:text-green-300 mb-4">âœ… ì˜ìƒ ìƒì„± ì™„ë£Œ!</h3>
                <video controls class="w-full rounded-lg shadow-lg" src="${videoPath}"></video>
                <div class="mt-4 text-center">
                    <a href="${videoPath}" download class="btn-primary inline-flex items-center gap-2">
                        ğŸ’¾ ì˜ìƒ ë‹¤ìš´ë¡œë“œ
                    </a>
                </div>
            </div>
        `);

        // ê¸°ì¡´ ìš”ì•½ ì—…ë°ì´íŠ¸
        document.getElementById('videoStatus').innerHTML = '<span class="text-green-600">âœ… ìƒì„±ë¨</span>';

        resetRenderBtn();
        Utils.showToast('ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    }

    function resetRenderBtn() {
        const btn = document.getElementById('renderBtn');
        btn.disabled = false;
        btn.innerHTML = `
            <span>ğŸ¬</span>
            <span>ì˜ìƒ ìƒì„±í•˜ê¸° (ì¬ìƒì„±)</span>
        `;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
    }

    function downloadScript() {
        const script = Utils.storage.get('fullScript');
        if (script?.script) {
            Utils.downloadFile(script.script, `${script.topic || 'ëŒ€ë³¸'}.txt`);
        } else {
            Utils.showToast('ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
        }
    }

    function downloadPrompts() {
        const prompts = Utils.storage.get('imagePrompts');
        if (prompts?.length > 0) {
            const text = prompts.map((p, i) => `[ì¥ë©´ ${i + 1}] ${p.scene}\n${p.prompt} ${p.style_tags || ''}`).join('\n\n');
            Utils.downloadFile(text, 'ì´ë¯¸ì§€_í”„ë¡¬í”„íŠ¸.txt');
        } else {
            Utils.showToast('ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
        }
    }

    function downloadAll() {
        const script = Utils.storage.get('fullScript');
        const structure = Utils.storage.get('scriptStructure');
        const prompts = Utils.storage.get('imagePrompts');

        let content = '=== wingsAIStudio í”„ë¡œì íŠ¸ ===\n\n';

        if (structure) {
            content += '## ëŒ€ë³¸ êµ¬ì¡°\n' + structure.structure + '\n\n';
        }
        if (script) {
            content += '## ëŒ€ë³¸\n' + script.script + '\n\n';
        }
        if (prompts) {
            content += '## ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸\n';
            prompts.forEach((p, i) => {
                content += `[ì¥ë©´ ${i + 1}] ${p.scene}\n${p.prompt} ${p.style_tags || ''}\n\n`;
            });
        }

        Utils.downloadFile(content, 'í”„ë¡œì íŠ¸_ì „ì²´.txt');
    }
</script>
{% endblock %}